---
# Weekly workflow that generates a type checking report using OpenHands CLI
# The agent analyzes the codebase for missing type hints and creates a GitHub issue
name: Weekly Type Checking Report

on:
    schedule:
        # Run weekly on Monday at 9:00 AM UTC
        - cron: 0 9 * * 1
    workflow_dispatch:
        inputs:
            create_issue:
                description: Create a GitHub issue with the report
                required: false
                default: true
                type: boolean

permissions:
    contents: read
    issues: write

jobs:
    type-checking-report:
        name: Generate Type Checking Report
        runs-on: blacksmith-2vcpu-ubuntu-2404
        if: github.repository == 'OpenHands/OpenHands-CLI'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.12'

            - name: Install uv
              uses: astral-sh/setup-uv@v7

            - name: Install dependencies
              run: |
                  uv sync --group dev

            - name: Run pyright type checker
              id: pyright
              continue-on-error: true
              run: |
                  echo "Running pyright type checker..."
                  uv run pyright --outputjson > pyright_output.json 2>&1 || true
                  echo "Pyright completed"

            - name: Generate type checking report with OpenHands
              id: generate_report
              env:
                  LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
                  LLM_BASE_URL: https://llm-proxy.app.all-hands.dev
                  LLM_MODEL: litellm_proxy/claude-opus-4-5-20251101
              run: |
                  # Create the analysis prompt
                  cat > /tmp/type_check_prompt.md << 'PROMPT_EOF'
                  # Type Checking Analysis Task

                  Please analyze this Python codebase for type checking issues and generate a comprehensive report.

                  ## Instructions

                  1. First, read the pyright output from `pyright_output.json` in the current directory
                  2. Analyze the codebase in `openhands_cli/` directory for:
                     - Missing type hints on function parameters and return types
                     - Missing type hints on class attributes
                     - Any `Any` types that could be more specific
                     - Potential type safety issues that could lead to runtime bugs
                     - Areas where better typing could improve code quality

                  3. Generate a markdown report with the following sections:
                     - **Executive Summary**: Brief overview of findings
                     - **Critical Issues**: Type errors that could cause runtime bugs
                     - **Missing Type Hints**: Functions/methods lacking proper type annotations
                     - **Improvement Opportunities**: Areas where typing could be enhanced
                     - **Recommendations**: Prioritized list of suggested fixes
                     - **Statistics**: Count of issues by category

                  4. Save the report to `type_checking_report.md` in the current directory

                  Focus on actionable items that would improve code quality and prevent runtime bugs.
                  PROMPT_EOF

                  # Run OpenHands CLI in headless mode
                  uv run openhands --headless --always-approve --override-with-envs \
                    --file /tmp/type_check_prompt.md || echo "OpenHands analysis completed"

                  # Check if report was generated
                  if [ -f "type_checking_report.md" ]; then
                    echo "report_generated=true" >> $GITHUB_OUTPUT
                    echo "Report generated successfully"
                  else
                    echo "report_generated=false" >> $GITHUB_OUTPUT
                    echo "Report was not generated, creating fallback report from pyright output"

                    # Create a fallback report from pyright output
                    cat > type_checking_report.md << 'FALLBACK_EOF'
                  # Type Checking Report

                  ## Summary

                  This report was auto-generated from pyright static analysis.

                  ## Pyright Analysis Results

                  FALLBACK_EOF

                    if [ -f "pyright_output.json" ]; then
                      echo '```json' >> type_checking_report.md
                      cat pyright_output.json >> type_checking_report.md
                      echo '```' >> type_checking_report.md
                    else
                      echo "No pyright output available." >> type_checking_report.md
                    fi
                  fi

            - name: Upload report artifact
              uses: actions/upload-artifact@v4
              with:
                  name: type-checking-report
                  path: type_checking_report.md
                  if-no-files-found: warn

            - name: Create GitHub Issue
              if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.create_issue) }}
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # Get current date for the issue title
                  REPORT_DATE=$(date +"%Y-%m-%d")

                  # Read the report content
                  if [ -f "type_checking_report.md" ]; then
                    REPORT_CONTENT=$(cat type_checking_report.md)
                  else
                    REPORT_CONTENT="No report was generated. Please check the workflow logs."
                  fi

                  # Create the issue body
                  cat > /tmp/issue_body.md << EOF
                  ## Bi-weekly Type Checking Report - ${REPORT_DATE}

                  This is an automated report generated by the bi-weekly type checking workflow.

                  ${REPORT_CONTENT}

                  ---

                  **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

                  **Next Steps:**
                  - Review the findings above
                  - Create specific issues for critical items
                  - Consider using GitHub Resolver to address low-hanging fruit
                  EOF

                  # Create the issue using GitHub CLI (without labels to avoid errors if they don't exist)
                  gh issue create \
                    --title "ðŸ” Type Checking Report - ${REPORT_DATE}" \
                    --body-file /tmp/issue_body.md
