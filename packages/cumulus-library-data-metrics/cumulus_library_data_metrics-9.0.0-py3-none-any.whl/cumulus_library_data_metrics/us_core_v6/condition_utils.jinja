{% import 'utils.jinja' as utils %}

{% macro extract_category(src) -%}
    {{ utils.extract_codes_flat(
        src,
        'category',
        system='http://terminology.hl7.org/CodeSystem/condition-category',
        is_array=true,
    ) }}
{%- endmacro %}

{% macro extract_encounter_diagnosis_slice(src) -%}
(
    WITH
    tmp_categories AS {{ extract_category(src) }},
    tmp_ids AS (
        SELECT DISTINCT id
        FROM tmp_categories
        WHERE tmp_categories.code = 'encounter-diagnosis'
    )
    SELECT src.*
    FROM {{ src }} AS src
    INNER JOIN tmp_ids
    ON tmp_ids.id = src.id
)
{%- endmacro %}

{% macro extract_problem_or_health_concern_slice(src) -%}
(
    WITH
    tmp_categories AS {{ extract_category(src) }},
    tmp_ids AS (
        SELECT DISTINCT id
        FROM tmp_categories
        WHERE tmp_categories.code in ('problem-list-item', 'health-concern')
    )
    SELECT src.*
    FROM {{ src }} AS src
    INNER JOIN tmp_ids
    ON tmp_ids.id = src.id
)
{%- endmacro %}
