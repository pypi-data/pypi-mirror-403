name: Auto CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    env:
      BLPAPI_ROOT: /home/bbg
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
        os: [ubuntu-latest, windows-latest]

    steps:
    - uses: actions/checkout@v5
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install uv (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> "$GITHUB_PATH"
    - name: Install uv (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        iwr https://astral.sh/uv/install.ps1 -UseBasicParsing | iex
        "$env:USERPROFILE\.local\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    - name: Sync dependencies with uv
      run: |
        uv --version
        uv sync --locked --extra dev --extra test --extra docs
    - name: Lint with Ruff
      run: |
        uv run ruff check --output-format=github xbbg
    - name: Test with pytest
      run: |
        uv run pytest --doctest-modules --cov -v xbbg
    - name: Coverage report
      run: |
        uv run codecov --token=ff17768d-30bd-4917-98f2-a011606597ea
