# .github/workflows/auto-publish.yml
name: Auto Publish to PyPI

on:
  push:
    branches: [ main ]  # æˆ–ä½ ä½¿ç”¨çš„ä¸»åˆ†æ”¯
permissions:
  contents: write
  actions: write

jobs:
  analyze-commits:
    runs-on: ubuntu-latest
    outputs:
      version-type: ${{ steps.analyze.outputs.version-type }}
      should-release: ${{ steps.analyze.outputs.should-release }}
      new-tag: ${{ steps.analyze.outputs.new-tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Analyze commits and calculate version
        id: analyze
        run: |
          # è·å–æœ€æ–°æäº¤ä¿¡æ¯
          LATEST_COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Latest commit: $LATEST_COMMIT_MSG"
          
          # è·å–æœ€æ–°çš„tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"
          
          # è§£æç‰ˆæœ¬å·
          if [[ $LATEST_TAG =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR=${BASH_REMATCH[1]}
            MINOR=${BASH_REMATCH[2]} 
            PATCH=${BASH_REMATCH[3]}
            echo "è§£æç‰ˆæœ¬: v$MAJOR.$MINOR.$PATCH"
          else
            MAJOR=0
            MINOR=0
            PATCH=0
            echo "ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: 0.0.0"
          fi
          
          # åˆ†ææäº¤ä¿¡æ¯å†³å®šç‰ˆæœ¬ç±»å‹
          VERSION_TYPE="skip"
          SHOULD_RELEASE="false"
          
          if [[ $LATEST_COMMIT_MSG =~ (feat:|feature:) ]]; then
            VERSION_TYPE="minor"
            SHOULD_RELEASE="true"
            echo "âœ… æ£€æµ‹åˆ° feat/featureï¼Œè§¦å‘ minor ç‰ˆæœ¬å‘å¸ƒ"
          elif [[ $LATEST_COMMIT_MSG =~ (fix:|bugfix:) ]]; then
            VERSION_TYPE="patch"
            SHOULD_RELEASE="true"
            echo "âœ… æ£€æµ‹åˆ° fix/bugfixï¼Œè§¦å‘ patch ç‰ˆæœ¬å‘å¸ƒ"
          elif [[ $LATEST_COMMIT_MSG =~ (BREAKING\ CHANGE:|major:) ]]; then
            VERSION_TYPE="major"
            SHOULD_RELEASE="true"
            echo "âœ… æ£€æµ‹åˆ° BREAKING CHANGE/majorï¼Œè§¦å‘ major ç‰ˆæœ¬å‘å¸ƒ"
          else
            VERSION_TYPE="skip"
            SHOULD_RELEASE="false"
            echo "âŒ æœªæ£€æµ‹åˆ°è§¦å‘å‘å¸ƒçš„æäº¤ç±»å‹ï¼Œè·³è¿‡å‘å¸ƒ"
          fi
          
          echo "Version type: $VERSION_TYPE"
          echo "Should release: $SHOULD_RELEASE"
          
          # æ ¹æ®åˆ†æç»“æœè®¡ç®—æ–°ç‰ˆæœ¬
          case $VERSION_TYPE in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              echo "ğŸ”„ Major ç‰ˆæœ¬å‡çº§: v$MAJOR.$MINOR.$PATCH"
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              echo "ğŸ”„ Minor ç‰ˆæœ¬å‡çº§: v$MAJOR.$MINOR.$PATCH"
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              echo "ğŸ”„ Patch ç‰ˆæœ¬å‡çº§: v$MAJOR.$MINOR.$PATCH"
              ;;
            *)
              echo "âšª è·³è¿‡ç‰ˆæœ¬å‡çº§ï¼Œä½¿ç”¨ç°æœ‰æ ‡ç­¾: $LATEST_TAG"
              NEW_VERSION=$LATEST_TAG
              ;;
          esac
          
          if [ -z "$NEW_VERSION" ]; then
            NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          fi
          
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"
          
          # è®¾ç½®è¾“å‡º
          echo "version-type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "should-release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
          echo "new-tag=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          echo "âœ… è¾“å‡ºè®¾ç½®å®Œæˆ"
  create-tag:
    needs: analyze-commits
    if: needs.analyze-commits.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Git tag
        run: |
          TAG="${{ needs.analyze-commits.outputs.new-tag }}"
          echo "åˆ›å»ºæ ‡ç­¾: $TAG"
          
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
          git tag $TAG
          git push origin $TAG
          echo "âœ… æ ‡ç­¾ $TAG åˆ›å»ºæˆåŠŸ"
  publish:
    needs: [ analyze-commits, create-tag ]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥è®¡ç®—ç‰ˆæœ¬
          ref: ${{ needs.analyze-commits.outputs.new-tag }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build --verbose

      - name: OIDC Publish
        if: needs.analyze-commits.outputs.should-release == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1