{% load static %}
<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SafePass - Åifre YÃ¶neticisi{% endblock %}</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}?v={{ APP_VERSION }}">
    {% block extra_css %}{% endblock %}
</head>

<body class="{% block body_class %}{% endblock %}">

    {% block content %}{% endblock %}
    <!-- Update Notification Button -->
    <button class="update-btn" id="updateBtn" title="Yeni gÃ¼ncelleme mevcut">
        <span class="update-badge">1</span>
        <span class="bell-icon">ğŸ””</span>
    </button>
    <!-- Developer Info Button -->
    <button class="dev-info-btn" id="devInfoBtn" title="GeliÅŸtirici Bilgileri">
        â¤ï¸
    </button>
    <!-- Developer Info Modal -->
    <div class="dev-modal" id="devModal">
        <div class="dev-modal-content">
            <button class="dev-modal-close" id="closeModal">&times;</button>
            <div class="dev-modal-header">
                <span class="dev-logo">ğŸ”</span>
                <h2>SafePass</h2>
                <p class="dev-tagline">Ã‡evrimdÄ±ÅŸÄ± Åifre YÃ¶netimi</p>
            </div>
            <div class="dev-modal-body">
                <div class="dev-info-item">
                    <span class="dev-label">GeliÅŸtirici</span>
                    <span class="dev-value">Baran Celal TonyalÄ±</span>
                </div>
                <div class="dev-info-item">
                    <span class="dev-label">Versiyon</span>
                    <span class="dev-value" id="appVersion">{{ APP_VERSION }}</span>
                </div>
                <div class="dev-info-item">
                    <span class="dev-label">Pypl</span>
                    <a href="https://pypi.org/project/safepass-cli/" target="_blank" class="dev-link">
                        pypi.org/project/safepass-cli
                    </a>
                </div>
                <div class="dev-info-item">
                    <span class="dev-label">GitHub</span>
                    <a href="https://github.com/Barancll/safepass-cli" target="_blank" class="dev-link">
                        github.com/Barancll/safepass-cli
                    </a>
                </div>
                <div class="dev-info-item">
                    <span class="dev-label">LinkedIn</span>
                    <a href="https://www.linkedin.com/in/baran-celal-tonyali/" target="_blank" class="dev-link">
                        linkedin.com/in/baran-celal-tonyali
                    </a>
                </div>
                <div class="dev-info-item">
                    <span class="dev-label">Website</span>
                    <a href="https://barancelaltonyali.com/" target="_blank" class="dev-link">
                        barancelaltonyali.com
                    </a>
                </div>
            </div>
            <div class="dev-modal-footer">
                Made with <span class="heart-pulse">â¤ï¸</span> in Turkey
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{% static 'js/app.js' %}"></script>
    <script>
        // Update Notification Button Logic
        document.addEventListener('DOMContentLoaded', function () {
            // Developer Info Modal
            const devBtn = document.getElementById('devInfoBtn');
            const devModal = document.getElementById('devModal');
            const closeBtn = document.getElementById('closeModal');
            if (devBtn && devModal) {
                devBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    devModal.style.display = 'flex';
                    setTimeout(() => devModal.classList.add('show'), 10);
                });
                if (closeBtn) {
                    closeBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        devModal.classList.remove('show');
                        setTimeout(() => devModal.style.display = 'none', 300);
                    });
                }
                devModal.addEventListener('click', function (e) {
                    if (e.target === devModal) {
                        devModal.classList.remove('show');
                        setTimeout(() => devModal.style.display = 'none', 300);
                    }
                });
            }
        });

        // Timeout wrapper fonksiyonu - PyPI gibi dÄ±ÅŸ servislere istek atarken kullan
        function fetchWithTimeout(url, options = {}, timeout = 5000) {
            return Promise.race([
                fetch(url, options),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Request timeout')), timeout)
                )
            ]);
        }

        // Update Button Logic
        const updateBtn = document.getElementById('updateBtn');
        const currentVersion = '{{ APP_VERSION }}';

        // Test iÃ§in butonu her zaman tÄ±klanabilir yap
        updateBtn.onclick = function () {
            alert('ğŸ”„ GÃ¼ncelleme kontrolÃ¼ yapÄ±lÄ±yor...\n\nBu test modunda. GerÃ§ek gÃ¼ncelleme iÃ§in PyPI\'dan veri Ã§ekilecek.');
        };

        // Versiyon kontrolÃ¼ iÃ§in PyPI'dan en son sÃ¼rÃ¼mÃ¼ Ã§ek (5 saniye timeout ile)
        fetchWithTimeout('https://pypi.org/pypi/safepass-cli/json', {}, 5000)
            .then(resp => resp.json())
            .then(data => {
                const latest = data.info.version;

                // GerÃ§ek onclick handler - her durumda Ã§alÄ±ÅŸÄ±r
                updateBtn.onclick = function () {
                    let msg = `ğŸš€ SafePass GÃ¼ncelleme Bilgisi\n\n`;
                    msg += `ğŸ“¦ PyPI SÃ¼rÃ¼mÃ¼: ${latest}\n`;
                    msg += `ğŸ“¦ Mevcut SÃ¼rÃ¼m: ${currentVersion}\n\n`;

                    if (latest !== currentVersion) {
                        msg += `âœ¨ YENÄ° GÃœNCELLEME MEVCUT!\n\n`;
                        msg += `âš¡ GÃ¼ncelleme AdÄ±mlarÄ±:\n`;
                        msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                        msg += `1ï¸âƒ£ Terminal'i aÃ§Ä±n\n\n`;
                        msg += `2ï¸âƒ£ Åu komutu Ã§alÄ±ÅŸtÄ±rÄ±n:\n`;
                        msg += `   $ safepass update\n\n`;
                        msg += `3ï¸âƒ£ GÃ¼ncelleme tamamlandÄ±ktan sonra\n`;
                        msg += `   uygulamayÄ± kapatÄ±p yeniden baÅŸlatÄ±n\n`;
                        msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
                        msg += `ğŸ“ DetaylÄ± bilgi iÃ§in:\n`;
                        msg += `https://pypi.org/project/safepass-cli/${latest}/`;
                    } else {
                        msg += `âœ… UygulamanÄ±z gÃ¼ncel!\n\n`;
                        msg += `En son sÃ¼rÃ¼mÃ¼ kullanÄ±yorsunuz.`;
                    }

                    alert(msg);
                };

                // Sadece yeni sÃ¼rÃ¼m varsa butonu gÃ¶ster
                if (latest !== currentVersion) {
                    updateBtn.classList.add('visible');
                    updateBtn.title = `Yeni sÃ¼rÃ¼m mevcut: ${latest}`;
                }
            })
            .catch(err => {
                // PyPI'a eriÅŸilemezse veya timeout olursa bildirim gÃ¶sterme
                console.log('Update check failed (timeout or network error):', err);
                updateBtn.onclick = function () {
                    alert('âš ï¸ GÃ¼ncelleme kontrolÃ¼ yapÄ±lamadÄ±.\n\nÄ°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin veya daha sonra tekrar deneyin.');
                };
            });
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>