import{GLTFLoader as u}from"./glTFLoader-dcV3nFjy.js";import{c0 as c,O as g,p as T,x as f,bR as m,bQ as q}from"./index-C7ioxznG.js";import"./index-BmJkaHuF.js";import"./bone-D3wPsQsS.js";import"./skeleton-Dp5NNatR.js";import"./rawTexture-B_Rn1rXF.js";import"./assetContainer-WmWzRef8.js";import"./objectModelMapping-CY2JGqxk.js";class h{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:c.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t,s){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...h._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this._loader=s,this.onErrorObservable=new g,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(a=>this._options[a]!==e[a]).length)return;const s={...this._options,...e},r=this._options;this._options=s,s.renderSize!==r.renderSize||s.renderTargetTextureType!==r.renderTargetTextureType||s.generateMipmaps!==r.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=s.samples,this._opaqueRenderTarget.lodGenerationScale=s.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=s.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),T.SetImmediate(()=>{if(e.material){const t=this._loader._getOrCreateMaterialAdapter(e.material);t.transmissionWeight>0?(t.refractionBackgroundTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)}})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),s=this._opaqueMeshesCache.indexOf(e),r=e.material?this._loader._getOrCreateMaterialAdapter(e.material):null;(r?r.transmissionWeight>0:!1)?(r&&(r.refractionBackgroundTexture=this._opaqueRenderTarget),s!==-1?(this._opaqueMeshesCache.splice(s,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)):t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):s===-1&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){var e;return((e=this._opaqueRenderTarget)==null?void 0:e.getInternalTexture())!==null}_setupRenderTargets(){var t;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new f("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=((t=this._options.clearColor)==null?void 0:t.clone())??this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0,this._opaqueRenderTarget.disableImageProcessing=!0;let e;this._opaqueRenderTarget.onBeforeBindObservable.add(s=>{e=this._scene.environmentIntensity,this._scene.environmentIntensity=1,this._options.clearColor?s.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(s.clearColor,this._scene.getEngine().useExactSrgbConversions)}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=e});for(const s of this._transparentMeshesCache)if(s.material){const r=this._loader._getOrCreateMaterialAdapter(s.material);r.transmissionWeight>0&&(r.refractionBackgroundTexture=this._opaqueRenderTarget)}}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const o="KHR_materials_transmission";class C{constructor(e){this.name=o,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(o),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return u.LoadExtensionAsync(e,t,this.name,async(r,a)=>{const i=new Array;return i.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),i.push(this._loadTransparentPropertiesAsync(r,t,s,a)),await Promise.all(i).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,s,r){var l,_;const a=this._loader._getOrCreateMaterialAdapter(s),i=r.transmissionFactor!==void 0?r.transmissionFactor:0;if(i===0||!a)return Promise.resolve();if(a.configureTransmission(),a.transmissionWeight=i,i>0&&!this._loader.parent.dontUseTransmissionHelper){const n=s.getScene();n._transmissionHelper?(l=n._transmissionHelper)!=null&&l._isRenderTargetValid()||(_=n._transmissionHelper)==null||_._setupRenderTargets():new h({},s.getScene(),this._loader)}let p=Promise.resolve(null);return r.transmissionTexture&&(r.transmissionTexture.nonColorData=!0,p=this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,r.transmissionTexture,n=>{n.name=`${s.name} (Transmission)`,a.transmissionWeightTexture=n})),p.then(()=>{})}}m(o);q(o,!0,d=>new C(d));export{C as KHR_materials_transmission};
