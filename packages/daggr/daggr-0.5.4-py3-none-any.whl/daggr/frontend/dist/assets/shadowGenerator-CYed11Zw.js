const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/shadowMap.fragment-8LuQ8iMw.js","assets/index-C7ioxznG.js","assets/index-BmJkaHuF.js","assets/index-BJecwV5W.css","assets/packingFunctions-CazEkDR0.js","assets/clipPlaneFragment-Dj_n1rvQ.js","assets/shadowMap.vertex-DUZn4a12.js","assets/bonesDeclaration-CPFcQo5E.js","assets/instancesVertex-C9_ob8I4.js","assets/morphTargetsVertexDeclaration-DFgrcEZ0.js","assets/helperFunctions-CFR2hQoc.js","assets/sceneUboDeclaration-DbExGHC1.js","assets/meshUboDeclaration-DfeiWLXB.js","assets/clipPlaneVertex-BFcaiwOj.js","assets/morphTargetsVertex-CMN--LFF.js","assets/bonesVertex-pqgqQc-t.js","assets/bakedVertexAnimation-mwPok164.js","assets/depthBoxBlur.fragment-BbXmQlZb.js","assets/shadowMapFragmentSoftTransparentShadow-Cc0GqBJ6.js","assets/shadowMap.fragment-BKJsGNRI.js","assets/packingFunctions-BxWTQVav.js","assets/clipPlaneFragment-De5ww3cH.js","assets/shadowMap.vertex-k9as-zUz.js","assets/bakedVertexAnimation-BEH8Oe3p.js","assets/morphTargetsVertex-BRGjlcgZ.js","assets/helperFunctions-B2fIE0QR.js","assets/sceneVertexDeclaration-BNmC-N-r.js","assets/sceneUboDeclaration-Cl2yaWm5.js","assets/meshUboDeclaration-DRZ9rSBM.js","assets/clipPlaneVertex-CtJF83UU.js","assets/depthBoxBlur.fragment-nwkVuMr1.js","assets/shadowMapFragmentSoftTransparentShadow-BhASXxWV.js"])))=>i.map(i=>d[i]);
import{_ as L}from"./index-BmJkaHuF.js";import{e as v,T as M,a8 as R,S as K,_ as C,a9 as Y,s as z,f as Q,O as b,V as O,o as F,x as D,g as U,aa as y,a as k,a0 as j,ab as H,c as V,Z,Y as q,X as $,H as g,a2 as J,K as G,W as ee,N as te,$ as se,ac as ie,a6 as W,i as re}from"./index-C7ioxznG.js";class P extends v{get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e}set kernel(e){this._effectWrapper.kernel=e}get kernel(){return this._effectWrapper.kernel}set packedFloat(e){this._effectWrapper.packedFloat=e}get packedFloat(){return this._effectWrapper.packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,s,a=null,r=M.BILINEAR_SAMPLINGMODE,h,o,d=0,f="",l=!1,p=5){const _=typeof s=="number"?l:!!s.blockCompilation,E={uniforms:R.Uniforms,samplers:R.Samplers,size:typeof s=="number"?s:void 0,camera:a,samplingMode:r,engine:h,reusable:o,textureType:d,vertexUrl:R.VertexUrl,indexParameters:{varyingCount:0,depCount:0},textureFormat:p,defines:f,...s,blockCompilation:!0};super(e,R.FragmentUrl,{effectWrapper:typeof s=="number"||!s.effectWrapper?new R(e,h,void 0,void 0,E):void 0,...E}),this._effectWrapper.options.blockCompilation=_,this.direction=t,this.onApplyObservable.add(()=>{this._effectWrapper.textureWidth=this._outputTexture?this._outputTexture.width:this.width,this._effectWrapper.textureHeight=this._outputTexture?this._outputTexture.height:this.height}),this.kernel=i}updateEffect(e=null,t=null,i=null,s,a,r){this._effectWrapper._updateParameters(a,r)}static _Parse(e,t,i,s){return K.Parse(()=>new P(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1),e,i,s)}}C([Y()],P.prototype,"direction",null);C([z()],P.prototype,"kernel",null);C([z()],P.prototype,"packedFloat",null);Q("BABYLON.BlurPostProcess",P);class n{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===n.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(e===n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(e===n.FILTER_PCF||e===n.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((e===n.FILTER_PCF||e===n.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get usePoissonSampling(){return this.filter===n.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(n.FILTER_POISSONSAMPLING);!e&&this.filter!==n.FILTER_POISSONSAMPLING||(this.filter=e?t:n.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===n.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(n.FILTER_EXPONENTIALSHADOWMAP);!e&&this.filter!==n.FILTER_EXPONENTIALSHADOWMAP||(this.filter=e?t:n.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===n.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(n.FILTER_BLUREXPONENTIALSHADOWMAP);!e&&this.filter!==n.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=e?t:n.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===n.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(n.FILTER_CLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==n.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:n.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:n.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===n.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(n.FILTER_PCF);!e&&this.filter!==n.FILTER_PCF||(this.filter=e?t:n.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===n.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(n.FILTER_PCSS);!e&&this.filter!==n.FILTER_PCSS||(this.filter=e?t:n.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return e>=1?this._darkness=1:e<=0?this._darkness=0:this._darkness=e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return n.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.indexOf(e)===-1&&this._shadowMap.renderList.push(e),t)for(const i of e.getChildMeshes())this._shadowMap.renderList.indexOf(i)===-1&&this._shadowMap.renderList.push(i);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const i=this._shadowMap.renderList.indexOf(e);if(i!==-1&&this._shadowMap.renderList.splice(i,1),t)for(const s of e.getChildren())this.removeShadowCaster(s);return this}getLight(){return this._light}get shaderLanguage(){return this._shaderLanguage}_getCamera(){return this._camera??this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,i,s,a,r=!1){this.onBeforeShadowMapRenderObservable=new b,this.onAfterShadowMapRenderObservable=new b,this.onBeforeShadowMapRenderMeshObservable=new b,this.onAfterShadowMapRenderMeshObservable=new b,this.doNotSerialize=!1,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=n.FILTER_NONE,this._filteringQuality=n.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this._shaderLanguage=0,this.forceBackFacesOnly=!1,this._lightDirection=O.Zero(),this._viewMatrix=F.Zero(),this._projectionMatrix=F.Zero(),this._transformMatrix=F.Zero(),this._cachedPosition=new O(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new O(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=F.Identity(),this._shadersLoaded=!1,this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=s??null,this._useRedTextureType=!!a,this._initShaderSourceAsync(r);let h=t._shadowGenerators;h||(h=t._shadowGenerators=new Map),h.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),n._SceneComponentInitialization(this._scene);const o=this._scene.getEngine().getCaps();i?o.textureFloatRender&&o.textureFloatLinearFiltering?this._textureType=1:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?this._textureType=2:o.textureFloatRender&&o.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){var t;const e=this._scene.getEngine();(t=this._shadowMap)==null||t.dispose(),e._features.supportDepthStencilTexture?(this._shadowMap=new D(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForShadowGenerator-${this._light.name}`)):this._shadowMap=new D(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),this._shadowMap===null)return;this._shadowMap.wrapU=M.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=M.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(M.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(s,a,r,h)=>this._renderForShadowMap(s,a,r,h),this._shadowMap.customIsReadyFunction=(s,a,r)=>{if(!r||!s.subMeshes)return!0;let h=!0;for(const o of s.subMeshes){const d=o.getRenderingMesh(),l=this._scene.getEngine(),p=o.getMaterial();if(!p||o.verticesCount===0||this.customAllowRendering&&!this.customAllowRendering(o))continue;const _=d._getInstancesRenderList(o._id,!!o.getReplacementMesh());if(_.mustReturn)continue;const E=l.getCaps().instancedArrays&&(_.visibleInstances[o._id]!==null&&_.visibleInstances[o._id]!==void 0||d.hasThinInstances),S=p.needAlphaBlendingForMesh(d);h=this.isReady(o,E,S)&&h}return h};const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{var s;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._enableGPUDebugMarkers&&(e.restoreDefaultFramebuffer(),(s=e._debugPushGroup)==null||s.call(e,`Shadow map generation for pass id ${e.currentRenderPassId}`))}),this._shadowMap.onBeforeRenderObservable.add(s=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=s,this._filter===n.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),W.eyeAtCamera=!1,this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{var a,r;if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),W.eyeAtCamera=!0,this._scene.updateTransformMatrix(),this._filter===n.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap){(a=e._debugPopGroup)==null||a.call(e);return}const s=this.getShadowMapForRendering();s&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,s.renderTarget,!0),e.unBindFramebuffer(s.renderTarget,!0)),e._enableGPUDebugMarkers&&((r=e._debugPopGroup)==null||r.call(e))});const t=new U(0,0,0,0),i=new U(1,1,1,1);this._shadowMap.onClearObservable.add(s=>{this._filter===n.FILTER_PCF?s.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?s.clear(t,!0,!0,!1):s.clear(i,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(s=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=s.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let s=y.MIN_RENDERINGGROUPS;s<y.MAX_RENDERINGGROUPS;s++)this._shadowMap.setRenderingAutoClearDepthStencil(s,!1)}async _initShaderSourceAsync(e=!1){this._scene.getEngine().isWebGPU&&!e&&!n.ForceGLSL?(this._shaderLanguage=1,await Promise.all([L(()=>import("./shadowMap.fragment-8LuQ8iMw.js"),__vite__mapDeps([0,1,2,3,4,5])),L(()=>import("./shadowMap.vertex-DUZn4a12.js"),__vite__mapDeps([6,1,2,3,7,8,9,10,11,12,13,14,15,16])),L(()=>import("./depthBoxBlur.fragment-BbXmQlZb.js"),__vite__mapDeps([17,1,2,3])),L(()=>import("./shadowMapFragmentSoftTransparentShadow-Cc0GqBJ6.js"),__vite__mapDeps([18,1,2,3]))])):await Promise.all([L(()=>import("./shadowMap.fragment-BKJsGNRI.js"),__vite__mapDeps([19,1,2,3,20,21])),L(()=>import("./shadowMap.vertex-k9as-zUz.js"),__vite__mapDeps([22,1,2,3,23,24,25,26,27,28,29])),L(()=>import("./depthBoxBlur.fragment-nwkVuMr1.js"),__vite__mapDeps([30,1,2,3])),L(()=>import("./shadowMapFragmentSoftTransparentShadow-BhASXxWV.js"),__vite__mapDeps([31,1,2,3]))]),this._shadersLoaded=!0}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new D(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=M.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=M.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(M.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new P(this._light.name+"KernelBlurX",new k(1,0),this.blurKernel,1,null,M.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(i=>{i.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new P(this._light.name+"KernelBlurY",new k(0,1),this.blurKernel,1,null,M.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new v(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,M.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(i=>{i.setFloat2("screenSize",t,t),i.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,i,s){let a;if(s.length)for(a=0;a<s.length;a++)this._renderSubMeshForShadowMap(s.data[a]);for(a=0;a<e.length;a++)this._renderSubMeshForShadowMap(e.data[a]);for(a=0;a<t.length;a++)this._renderSubMeshForShadowMap(t.data[a]);if(this._transparencyShadow)for(a=0;a<i.length;a++)this._renderSubMeshForShadowMap(i.data[a],!0);else for(a=0;a<i.length;a++)i.data[a].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){var E;const i=e.getRenderingMesh(),s=e.getEffectiveMesh(),a=this._scene,r=a.getEngine(),h=e.getMaterial();if(s._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!h||e.verticesCount===0||e._renderId===a.getRenderId())return;const o=a.useRightHandedSystem,d=s._getWorldMatrixDeterminant()<0;let f=h._getEffectiveOrientation(i);(d&&!o||!d&&o)&&(f=f===0?1:0);const l=f===0;r.setState(h.backFaceCulling,void 0,void 0,l,h.cullBackFaces);const p=i._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(p.mustReturn)return;const _=r.getCaps().instancedArrays&&(p.visibleInstances[e._id]!==null&&p.visibleInstances[e._id]!==void 0||i.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(e)))if(this.isReady(e,_,t)){e._renderId=a.getRenderId();const S=h.shadowDepthWrapper,A=(S==null?void 0:S.getEffect(e,this,r.currentRenderPassId))??e._getDrawWrapper(),u=j.GetEffect(A);r.enableEffect(A),_||i._bind(e,u,h.fillMode),this.getTransformMatrix(),u.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===H.LIGHTTYPEID_DIRECTIONALLIGHT?u.setVector3("lightDataSM",this._cachedDirection):u.setVector3("lightDataSM",this._cachedPosition.subtractToRef(this._scene.floatingOriginOffset,V.Vector3[0]));const B=this._getCamera();if(u.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(B),this.getLight().getDepthMinZ(B)+this.getLight().getDepthMaxZ(B)),t&&this.enableSoftTransparentShadow&&u.setFloat2("softTransparentShadowSM",s.visibility*h.alpha,(E=this._opacityTexture)!=null&&E.getAlphaFromRGB?1:0),S)e._setMainDrawWrapperOverride(A),S.standalone?S.baseMaterial.bindForSubMesh(s.getWorldMatrix(),i,e):h.bindForSubMesh(s.getWorldMatrix(),i,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(u.setTexture("diffuseSampler",this._opacityTexture),u.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),i.useBones&&i.computeBonesUsingShaders&&i.skeleton){const c=i.skeleton;if(c.isUsingTextureForMatrices){const x=c.getTransformMatrixTexture(i);if(!x)return;u.setTexture("boneSampler",x),u.setFloat("boneTextureWidth",4*(c.bones.length+1))}else u.setMatrices("mBones",c.getTransformMatrices(i))}Z(i,u),i.morphTargetManager&&i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(u);const T=e.getMesh().bakedVertexAnimationManager;T&&T.isEnabled&&T.bind(u,_),q(u,h,a)}!this._useUBO&&!S&&this._bindCustomEffectForRenderSubMeshForShadowMap(e,u,s),$(u,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const I=s.getWorldMatrix();_&&(s.getMeshUniformBuffer().bindToEffect(u,"Mesh"),s.transferToEffect(I)),this.forceBackFacesOnly&&r.setState(!0,0,!1,!0,h.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(i),this.onBeforeShadowMapRenderObservable.notifyObservers(u),i._processRendering(s,e,u,h.fillMode,p,_,(T,c)=>{s!==i&&!T?(i.getMeshUniformBuffer().bindToEffect(u,"Mesh"),i.transferToEffect(c)):(s.getMeshUniformBuffer().bindToEffect(u,"Mesh"),s.transferToEffect(T?c:I))}),this.forceBackFacesOnly&&r.setState(!0,0,!1,!1,h.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(u),this.onAfterShadowMapRenderMeshObservable.notifyObservers(i)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===n.FILTER_NONE||this.filter===n.FILTER_PCSS?this._shadowMap.updateSamplingMode(M.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(M.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const i={useInstances:!1,...t},s=this.getShadowMap();if(!s){e&&e(this);return}const a=s.renderList;if(!a){e&&e(this);return}const r=[];for(const d of a)r.push(...d.subMeshes);if(r.length===0){e&&e(this);return}let h=0;const o=()=>{var d;if(!(!this._scene||!this._scene.getEngine())){for(;this.isReady(r[h],i.useInstances,((d=r[h].getMaterial())==null?void 0:d.needAlphaBlendingForMesh(r[h].getMesh()))??!1);)if(h++,h>=r.length){e&&e(this);return}setTimeout(o,16)}};o()}async forceCompilationAsync(e){return await new Promise(t=>{this.forceCompilation(()=>{t()},e)})}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,s){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const a=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&a.isVerticesDataPresent(g.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===H.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&s?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){if(!this._shadersLoaded)return!1;const s=e.getMaterial(),a=s==null?void 0:s.shadowDepthWrapper;if(this._opacityTexture=null,!s)return!1;const r=[];if(this._prepareShadowDefines(e,t,r,i),a){if(!a.isReadyForSubMesh(e,r,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const h=e._getDrawWrapper(void 0,!0);let o=h.effect,d=h.defines;const f=[g.PositionKind],l=e.getMesh();let p=!1,_=!1,E=!1;const S=!1;this.normalBias&&l.isVerticesDataPresent(g.NormalKind)&&(f.push(g.NormalKind),r.push("#define NORMAL"),p=!0,l.nonUniformScaling&&r.push("#define NONUNIFORMSCALING"));const A=s.needAlphaTestingForMesh(l);if((A||s.needAlphaBlendingForMesh(l))&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=s.opacityTexture:this._opacityTexture=s.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;const c=s.alphaCutOff??n.DEFAULT_ALPHA_CUTOFF;r.push("#define ALPHATEXTURE"),A&&r.push(`#define ALPHATESTVALUE ${c}${c%1===0?".":""}`),l.isVerticesDataPresent(g.UVKind)&&(f.push(g.UVKind),r.push("#define UV1"),_=!0),l.isVerticesDataPresent(g.UV2Kind)&&this._opacityTexture.coordinatesIndex===1&&(f.push(g.UV2Kind),r.push("#define UV2"),E=!0)}const u=new J;if(l.useBones&&l.computeBonesUsingShaders&&l.skeleton){f.push(g.MatricesIndicesKind),f.push(g.MatricesWeightsKind),l.numBoneInfluencers>4&&(f.push(g.MatricesIndicesExtraKind),f.push(g.MatricesWeightsExtraKind));const c=l.skeleton;r.push("#define NUM_BONE_INFLUENCERS "+l.numBoneInfluencers),l.numBoneInfluencers>0&&u.addCPUSkinningFallback(0,l),c.isUsingTextureForMatrices?r.push("#define BONETEXTURE"):r.push("#define BonesPerMesh "+(c.bones.length+1))}else r.push("#define NUM_BONE_INFLUENCERS 0");const B=l.morphTargetManager?G(l.morphTargetManager,r,f,l,!0,p,!1,_,E,S):0;if(ee(s,this._scene,r),t&&(r.push("#define INSTANCES"),te(f),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const c of this.customShaderOptions.defines)r.indexOf(c)===-1&&r.push(c);const I=l.bakedVertexAnimationManager;I&&I.isEnabled&&(r.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&f.push("bakedVertexAnimationSettingsInstanced"));const T=r.join(`
`);if(d!==T){d=T;let c="shadowMap";const x=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],w=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"],X=["Scene","Mesh"];if(se(x),this.customShaderOptions){if(c=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const m of this.customShaderOptions.attributes)f.indexOf(m)===-1&&f.push(m);if(this.customShaderOptions.uniforms)for(const m of this.customShaderOptions.uniforms)x.indexOf(m)===-1&&x.push(m);if(this.customShaderOptions.samplers)for(const m of this.customShaderOptions.samplers)w.indexOf(m)===-1&&w.push(m)}const N=this._scene.getEngine();o=N.createEffect(c,{attributes:f,uniformsNames:x,uniformBuffersNames:X,samplers:w,defines:T,fallbacks:u,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:B},shaderLanguage:this._shaderLanguage},N),h.setEffect(o,d)}if(!o.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){const i=this._scene,s=this._light;!i.shadowsEnabled||!s.shadowEnabled||(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===n.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===n.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===n.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===n.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),s.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const i=this._light,s=this._scene;if(!s.shadowsEnabled||!i.shadowEnabled)return;const a=this._getCamera(),r=this.getShadowMap();if(!r)return;if(!i.needCube()){const o=s.floatingOriginOffset,d=this.getTransformMatrix(),f=s.floatingOriginMode?ie(o,this._viewMatrix,this._projectionMatrix,V.Matrix[0]):d;t.setMatrix("lightMatrix"+e,f)}const h=this.getShadowMapForRendering();this._filter===n.FILTER_PCF?(t.setDepthStencilTexture("shadowTexture"+e,h),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),r.getSize().width,1/r.getSize().width,this.frustumEdgeFalloff,e)):this._filter===n.FILTER_PCSS?(t.setDepthStencilTexture("shadowTexture"+e,h),t.setTexture("depthTexture"+e,h),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/r.getSize().width,this._contactHardeningLightSizeUVRatio*r.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowTexture"+e,h),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/r.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(a),this.getLight().getDepthMinZ(a)+this.getLight().getDepthMaxZ(a),e)}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),O.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(O.Dot(this._lightDirection,O.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),F.LookAtLHToRef(t,t.add(this._lightDirection),O.Up(),this._viewMatrix);const i=this.getShadowMap();if(i){const s=i.renderList;s&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,s)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const i of t)this._shadowMap.renderList.push(i)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();t.done!==!0;t=e.next()){const[i,s]=t.value;s===this&&this._light._shadowGenerators.delete(i)}this._light._shadowGenerators.size===0&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){var i;const e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.cameraId=(i=this._camera)==null?void 0:i.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(let s=0;s<t.renderList.length;s++){const a=t.renderList[s];e.renderList.push(a.id)}return e}static Parse(e,t,i){const s=t.getLightById(e.lightId),a=e.cameraId!==void 0?t.getCameraById(e.cameraId):null,r=i?i(e.mapSize,s,a):new n(e.mapSize,s,void 0,a),h=r.getShadowMap();if(e.renderList.length&&h){const o=new Set(e.renderList);let d=h.renderList;d||(d=h.renderList=[]);const f=t.meshes;for(const l of f)o.has(l.id)&&d.push(l)}return e.id!==void 0&&(r.id=e.id),r.forceBackFacesOnly=!!e.forceBackFacesOnly,e.darkness!==void 0&&r.setDarkness(e.darkness),e.transparencyShadow&&r.setTransparencyShadow(!0),e.frustumEdgeFalloff!==void 0&&(r.frustumEdgeFalloff=e.frustumEdgeFalloff),e.bias!==void 0&&(r.bias=e.bias),e.normalBias!==void 0&&(r.normalBias=e.normalBias),e.usePercentageCloserFiltering?r.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?r.useContactHardeningShadow=!0:e.usePoissonSampling?r.usePoissonSampling=!0:e.useExponentialShadowMap?r.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?r.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?r.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?r.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?r.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(r.useBlurExponentialShadowMap=!0),e.contactHardeningLightSizeUVRatio!==void 0&&(r.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),e.filteringQuality!==void 0&&(r.filteringQuality=e.filteringQuality),e.depthScale&&(r.depthScale=e.depthScale),e.blurScale&&(r.blurScale=e.blurScale),e.blurBoxOffset&&(r.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(r.useKernelBlur=e.useKernelBlur),e.blurKernel&&(r.blurKernel=e.blurKernel),r}}n.CLASSNAME="ShadowGenerator";n.ForceGLSL=!1;n.FILTER_NONE=0;n.FILTER_EXPONENTIALSHADOWMAP=1;n.FILTER_POISSONSAMPLING=2;n.FILTER_BLUREXPONENTIALSHADOWMAP=3;n.FILTER_CLOSEEXPONENTIALSHADOWMAP=4;n.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5;n.FILTER_PCF=6;n.FILTER_PCSS=7;n.QUALITY_HIGH=0;n.QUALITY_MEDIUM=1;n.QUALITY_LOW=2;n.DEFAULT_ALPHA_CUTOFF=.5;n._SceneComponentInitialization=ne=>{throw re("ShadowGeneratorSceneComponent")};export{n as ShadowGenerator};
