import{GLTFLoader as S,ArrayItem as L}from"./glTFLoader-dcV3nFjy.js";import{v as O,bR as C,bQ as I}from"./index-C7ioxznG.js";import"./index-BmJkaHuF.js";import"./bone-D3wPsQsS.js";import"./skeleton-Dp5NNatR.js";import"./rawTexture-B_Rn1rXF.js";import"./assetContainer-WmWzRef8.js";import"./objectModelMapping-CY2JGqxk.js";const r="KHR_materials_variants";class s{constructor(t){this.name=r,this._loader=t,this.enabled=this._loader.isExtensionUsed(r)&&!this._loader.parent.skipMaterials}dispose(){this._loader=null}static GetAvailableVariants(t){const a=this._GetExtensionMetadata(t);return a?Object.keys(a.variants):[]}getAvailableVariants(t){return s.GetAvailableVariants(t)}static SelectVariant(t,a){const e=this._GetExtensionMetadata(t);if(!e)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${r} extension`);const o=h=>{const f=e.variants[h];if(f)for(const m of f)m.mesh.material=m.material};if(a instanceof Array)for(const h of a)o(h);else o(a);e.lastSelected=a}selectVariant(t,a){s.SelectVariant(t,a)}static Reset(t){const a=this._GetExtensionMetadata(t);if(!a)throw new Error(`Cannot reset on a glTF mesh that does not have the ${r} extension`);for(const e of a.original)e.mesh.material=e.material;a.lastSelected=null}reset(t){s.Reset(t)}static GetLastSelectedVariant(t){const a=this._GetExtensionMetadata(t);if(!a)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${r} extension`);return a.lastSelected}getLastSelectedVariant(t){return s.GetLastSelectedVariant(t)}static _GetExtensionMetadata(t){var a,e;return((e=(a=t==null?void 0:t._internalMetadata)==null?void 0:a.gltf)==null?void 0:e[r])||null}onLoading(){const t=this._loader.gltf.extensions;if(t&&t[this.name]){const a=t[this.name];this._variants=a.variants}}onReady(){var a;const t=this._loader.rootBabylonMesh;if(t){const e=this._loader.parent.extensionOptions[r];e!=null&&e.defaultVariant&&s.SelectVariant(t,e.defaultVariant),(a=e==null?void 0:e.onLoaded)==null||a.call(e,{get variants(){return s.GetAvailableVariants(t)},get selectedVariant(){const o=s.GetLastSelectedVariant(t);return o?Array.isArray(o)?o[0]:o:s.GetAvailableVariants(t)[0]},set selectedVariant(o){s.SelectVariant(t,o)}})}}_loadMeshPrimitiveAsync(t,a,e,o,h,f){return S.LoadExtensionAsync(t,h,this.name,async(m,V)=>{const x=new Array;return x.push(this._loader._loadMeshPrimitiveAsync(t,a,e,o,h,l=>{if(f(l),l instanceof O){const $=S._GetDrawMode(t,h.mode),c=this._loader.rootBabylonMesh,E=c?c._internalMetadata=c._internalMetadata||{}:{},w=E.gltf=E.gltf||{},g=w[r]=w[r]||{lastSelected:null,original:[],variants:{}};g.original.push({mesh:l,material:l.material});for(let u=0;u<V.mappings.length;++u){const M=V.mappings[u],F=L.Get(`${m}/mappings/${u}/material`,this._loader.gltf.materials,M.material);x.push(this._loader._loadMaterialAsync(`#/materials/${M.material}`,F,l,$,T=>{for(let v=0;v<M.variants.length;++v){const y=M.variants[v],p=L.Get(`/extensions/${r}/variants/${y}`,this._variants,y);g.variants[p.name]=g.variants[p.name]||[],g.variants[p.name].push({mesh:l,material:T}),l.onClonedObservable.add(k=>{const G=k;let d=null,i=G;do{if(i=i.parent,!i)return;d=s._GetExtensionMetadata(i)}while(d===null);if(c&&d===s._GetExtensionMetadata(c)){i._internalMetadata={};for(const n in c._internalMetadata)i._internalMetadata[n]=c._internalMetadata[n];i._internalMetadata.gltf=[];for(const n in c._internalMetadata.gltf)i._internalMetadata.gltf[n]=c._internalMetadata.gltf[n];i._internalMetadata.gltf[r]={lastSelected:null,original:[],variants:{}};for(const n of d.original)i._internalMetadata.gltf[r].original.push({mesh:n.mesh,material:n.material});for(const n in d.variants)if(Object.prototype.hasOwnProperty.call(d.variants,n)){i._internalMetadata.gltf[r].variants[n]=[];for(const A of d.variants[n])i._internalMetadata.gltf[r].variants[n].push({mesh:A.mesh,material:A.material})}d=i._internalMetadata.gltf[r]}for(const n of d.original)n.mesh===l&&(n.mesh=G);for(const n of d.variants[p.name])n.mesh===l&&(n.mesh=G)})}}))}}})),await Promise.all(x).then(([l])=>l)})}}C(r);I(r,!0,_=>new s(_));export{s as KHR_materials_variants};
