const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/rgbdDecode.fragment-BjZ7EBvF.js","assets/index-C7ioxznG.js","assets/index-BmJkaHuF.js","assets/index-BJecwV5W.css","assets/helperFunctions-CFR2hQoc.js","assets/rgbdDecode.fragment-C2rCpgB9.js","assets/helperFunctions-B2fIE0QR.js"])))=>i.map(i=>d[i]);
import{_ as F}from"./index-BmJkaHuF.js";import{L as G,q as z,V as m,l as C,B as O,p as V,m as k,e as H}from"./index-C7ioxznG.js";import"./dumpTools-Bvk_m6Ji.js";const v="image/png",E=2,S=[134,22,135,150,246,214,150,54];function q(e){const n=new DataView(e.buffer,e.byteOffset,e.byteLength);let a=0;for(let o=0;o<S.length;o++)if(n.getUint8(a++)!==S[o])return G.Error("Not a babylon environment map"),null;let t="",i=0;for(;i=n.getUint8(a++);)t+=String.fromCharCode(i);let r=JSON.parse(t);return r=R(r),r.binaryDataPosition=a,r.specular&&(r.specular.lodGenerationScale=r.specular.lodGenerationScale||.8),r}function R(e){if(e.version>E)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${E}".`);return e.version===2||(e={...e,version:2,imageType:v}),e}function P(e,n){n=R(n);const a=n.specular;let t=Math.log2(n.width);if(t=Math.round(t)+1,a.mipmaps.length!==6*t)throw new Error(`Unsupported specular mipmaps number "${a.mipmaps.length}"`);const i=new Array(t);for(let r=0;r<t;r++){i[r]=new Array(6);for(let o=0;o<6;o++){const s=a.mipmaps[r*6+o];i[r][o]=new Uint8Array(e.buffer,e.byteOffset+n.binaryDataPosition+s.position,s.length)}}return i}function Y(e,n){var i;n=R(n);const a=new Array(6),t=(i=n.irradiance)==null?void 0:i.irradianceTexture;if(t){if(t.faces.length!==6)throw new Error(`Incorrect irradiance texture faces number "${t.faces.length}"`);for(let r=0;r<6;r++){const o=t.faces[r];a[r]=new Uint8Array(e.buffer,e.byteOffset+n.binaryDataPosition+o.position,o.length)}}return a}function J(e,n,a){var s,f,c;a=R(a);const t=a.specular;if(!t)return Promise.resolve([]);e._lodGenerationScale=t.lodGenerationScale;const i=[],r=P(n,a);i.push(D(e,r,a.imageType));const o=(s=a.irradiance)==null?void 0:s.irradianceTexture;if(o){const g=Y(n,a);let u=null;(c=(f=a.irradiance)==null?void 0:f.irradianceTexture)!=null&&c.dominantDirection&&(u=m.FromArray(a.irradiance.irradianceTexture.dominantDirection)),i.push($(e,g,o.size,a.imageType,u))}return Promise.all(i)}async function U(e,n,a,t,i,r,o,s,f,c,g){return await new Promise((u,I)=>{if(a){const _=n.createTexture(null,!0,!0,null,1,null,l=>{I(l)},e);t==null||t.onEffectCreatedObservable.addOnce(l=>{l.executeWhenCompiled(()=>{t.externalTextureSamplerBinding=!0,t.onApply=p=>{p._bindTexture("textureSampler",_),p.setFloat2("scale",1,n._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},n.scenes.length&&(n.scenes[0].postProcessManager.directRender([t],c,!0,r,o),n.restoreDefaultFramebuffer(),_.dispose(),URL.revokeObjectURL(i),u())})})}else{if(n._uploadImageToTexture(g,e,r,o),s){const _=f[o];_&&n._uploadImageToTexture(_._texture,e,r,0)}u()}})}async function D(e,n,a=v){const t=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,t.updateTextureSamplingMode(3,e),await B(e,n,!0,a),e.isReady=!0}async function $(e,n,a,t=v,i=null){const r=e.getEngine(),o=new C(r,5),s=new O(r,o);e._irradianceTexture=s,s._dominantDirection=i,o.isCube=!0,o.format=5,o.type=0,o.generateMipMaps=!0,o._cachedAnisotropicFilteringLevel=null,o.generateMipMaps=!0,o.width=a,o.height=a,r.updateTextureSamplingMode(3,o),await B(o,[n],!1,t),r.generateMipMapsForCubemap(o),o.isReady=!0}async function B(e,n,a,t=v){if(!V.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const i=k(e.width)+1,r=e.getEngine();let o=!1,s=!1,f=null,c=null,g=null;const u=r.getCaps();u.textureLOD?r._features.supportRenderAndCopyToLodForFloatTextures?u.textureHalfFloatRender&&u.textureHalfFloatLinearFiltering?(o=!0,e.type=2):u.textureFloatRender&&u.textureFloatLinearFiltering&&(o=!0,e.type=1):o=!1:(o=!1,s=a);let I=0;if(o)r.isWebGPU?(I=1,await F(()=>import("./rgbdDecode.fragment-BjZ7EBvF.js"),__vite__mapDeps([0,1,2,3,4]))):await F(()=>import("./rgbdDecode.fragment-C2rCpgB9.js"),__vite__mapDeps([5,1,2,3,6])),f=new H("rgbdDecode","rgbdDecode",null,null,1,null,3,r,!1,void 0,e.type,void 0,null,!1,void 0,I),e._isRGBD=!1,e.invertY=!1,c=r.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,s){g={};const p=e._lodGenerationScale,h=e._lodGenerationOffset;for(let d=0;d<3;d++){const b=1-d/2,y=h,L=(i-1)*p+h,M=y+(L-y)*b,A=Math.round(Math.min(Math.max(M,0),L)),x=new C(r,2);x.isCube=!0,x.invertY=!0,x.generateMipMaps=!1,r.updateTextureSamplingMode(2,x);const T=new O(null);switch(T._isCube=!0,T._texture=x,g[A]=T,d){case 0:e._lodTextureLow=T;break;case 1:e._lodTextureMid=T;break;case 2:e._lodTextureHigh=T;break}}}const _=[];for(let l=0;l<n.length;l++)for(let p=0;p<6;p++){const h=n[l][p],d=new Blob([h],{type:t}),w=URL.createObjectURL(d);let b;if(r._features.forceBitmapOverHTMLImageElement)b=r.createImageBitmap(d,{premultiplyAlpha:"none"}).then(async y=>await U(y,r,o,f,w,p,l,s,g,c,e));else{const y=new Image;y.src=w,b=new Promise((L,M)=>{y.onload=()=>{U(y,r,o,f,w,p,l,s,g,c,e).then(()=>L()).catch(A=>{M(A)})},y.onerror=A=>{M(A)}})}_.push(b)}if(await Promise.all(_),n.length<i){let l;const p=Math.pow(2,i-1-n.length),h=p*p*4;switch(e.type){case 0:{l=new Uint8Array(h);break}case 2:{l=new Uint16Array(h);break}case 1:{l=new Float32Array(h);break}}for(let d=n.length;d<i;d++)for(let w=0;w<6;w++)r._uploadArrayBufferViewToTexture((c==null?void 0:c.texture)||e,l,w,d)}if(c){const l=e._irradianceTexture;e._irradianceTexture=null,r._releaseTexture(e),c._swapAndDie(e),e._irradianceTexture=l}f&&f.dispose(),s&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function K(e,n){n=R(n);const a=n.irradiance;if(!a)return;const t=new z;m.FromArrayToRef(a.x,0,t.x),m.FromArrayToRef(a.y,0,t.y),m.FromArrayToRef(a.z,0,t.z),m.FromArrayToRef(a.xx,0,t.xx),m.FromArrayToRef(a.yy,0,t.yy),m.FromArrayToRef(a.zz,0,t.zz),m.FromArrayToRef(a.yz,0,t.yz),m.FromArrayToRef(a.zx,0,t.zx),m.FromArrayToRef(a.xy,0,t.xy),e._sphericalPolynomial=t}function Q(e,n,a,t,i){const r=e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),o=D(r,n).then(()=>e);return e.onRebuildCallback=s=>({proxy:o,isReady:!0,isAsync:!0}),e._source=13,e._bufferViewArrayArray=n,e._lodGenerationScale=t,e._lodGenerationOffset=i,e._sphericalPolynomial=a,D(e,n).then(()=>(e.isReady=!0,e))}export{q as G,K as U,Q as _,J as a};
