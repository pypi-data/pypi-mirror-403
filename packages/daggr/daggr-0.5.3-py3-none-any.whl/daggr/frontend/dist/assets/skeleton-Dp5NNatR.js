import{B as c}from"./bone-D3wPsQsS.js";import{o as f,O as p,d as A,bD as _,L as x,aI as b,c as M,bA as B,V as R}from"./index-C7ioxznG.js";import{R as T}from"./rawTexture-B_Rn1rXF.js";class u{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,i,n){this.name=e,this.id=i,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=f.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new p,this.metadata=null,this.bones=[],this._scene=n||A.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const t=this._scene.getEngine().getCaps();this._canUseTextureForBones=t.textureFloat&&t.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){if(this.needInitialSkinMatrix){if(!e)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return e._bonesTransformMatrices||this.prepare(!0),e._bonesTransformMatrices}return(!this._transformMatrices||this._isDirty)&&this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let i=`Name: ${this.name}, nBones: ${this.bones.length}`;if(i+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){i+=", Ranges: {";let n=!0;for(const t in this._ranges)n&&(i+=", ",n=!1),i+=t;i+="}"}return i}getBoneIndexByName(e){for(let i=0,n=this.bones.length;i<n;i++)if(this.bones[i].name===e)return i;return-1}createAnimationRange(e,i,n){if(!this._ranges[e]){this._ranges[e]=new _(e,i,n);for(let t=0,s=this.bones.length;t<s;t++)this.bones[t].animations[0]&&this.bones[t].animations[0].createRange(e,i,n)}}deleteAnimationRange(e,i=!0){for(let n=0,t=this.bones.length;n<t;n++)this.bones[n].animations[0]&&this.bones[n].animations[0].deleteRange(e,i);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let i;for(i in this._ranges)e.push(this._ranges[i]);return e}copyAnimationRange(e,i,n=!1){if(this._ranges[i]||!e.getAnimationRange(i))return!1;let t=!0;const s=this._getHighestAnimationFrame()+1,o={},h=e.bones;let a,r;for(r=0,a=h.length;r<a;r++)o[h[r].name]=h[r];this.bones.length!==h.length&&(x.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${h.length}`),t=!1);const l=n&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(r=0,a=this.bones.length;r<a;r++){const g=this.bones[r].name,d=o[g];d?t=t&&this.bones[r].copyAnimationRange(d,i,s,n,l):(x.Warn("copyAnimationRange: not same rig, missing source bone "+g),t=!1)}const m=e.getAnimationRange(i);return m&&(this._ranges[i]=new _(i,m.from+s,m.to+s)),t}returnToRest(){for(const e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let i=0,n=this.bones.length;i<n;i++)if(this.bones[i].animations[0]){const t=this.bones[i].animations[0].getHighestFrame();e<t&&(e=t)}return e}beginAnimation(e,i,n,t){const s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,i,n,t):null}static MakeAnimationAdditive(e,i=0,n){const t=e.getAnimationRange(n);if(!t)return null;const s=e._scene.getAllAnimatablesByTarget(e);let o=null;for(let a=0;a<s.length;a++){const r=s[a];if(r.fromFrame===(t==null?void 0:t.from)&&r.toFrame===(t==null?void 0:t.to)){o=r;break}}const h=e.getAnimatables();for(let a=0;a<h.length;a++){const l=h[a].animations;if(l)for(let m=0;m<l.length;m++)b.MakeAnimationAdditive(l[m],i,n)}return o&&(o.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const i=this._meshesWithPoseMatrix.indexOf(e);i>-1&&this._meshesWithPoseMatrix.splice(i,1)}_computeTransformMatrices(e,i){this.onBeforeComputeObservable.notifyObservers(this);for(let n=0;n<this.bones.length;n++){const t=this.bones[n];t._childUpdateId++;const s=t.getParent();if(s?t.getLocalMatrix().multiplyToRef(s.getFinalMatrix(),t.getFinalMatrix()):i?t.getLocalMatrix().multiplyToRef(i,t.getFinalMatrix()):t.getFinalMatrix().copyFrom(t.getLocalMatrix()),t._index!==-1){const o=t._index===null?n:t._index;t.getAbsoluteInverseBindMatrix().multiplyToArray(t.getFinalMatrix(),e,o*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(e=!1){if(!e){const i=this.getScene().getRenderId();if(this._currentRenderId===i)return;this._currentRenderId=i}if(this._numBonesWithLinkedTransformNode>0){for(const i of this.bones)if(i._linkedTransformNode){const n=i._linkedTransformNode;i.position=n.position,n.rotationQuaternion?i.rotationQuaternion=n.rotationQuaternion:i.rotation=n.rotation,i.scaling=n.scaling}}if(this.needInitialSkinMatrix)for(const i of this._meshesWithPoseMatrix){const n=i.getPoseMatrix();let t=this._isDirty;if((!i._bonesTransformMatrices||i._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(i._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),t=!0),!!t){if(this._synchronizedWithMesh!==i){this._synchronizedWithMesh=i;for(const s of this.bones)s.getParent()||(s.getBindMatrix().multiplyToRef(n,M.Matrix[1]),s._updateAbsoluteBindMatrices(M.Matrix[1]));if(this.isUsingTextureForMatrices){const s=(this.bones.length+1)*4;(!i._transformMatrixTexture||i._transformMatrixTexture.getSize().width!==s)&&(i._transformMatrixTexture&&i._transformMatrixTexture.dispose(),i._transformMatrixTexture=T.CreateRGBATexture(i._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(i._bonesTransformMatrices,n),this.isUsingTextureForMatrices&&i._transformMatrixTexture&&i._transformMatrixTexture.update(i._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=T.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,i){const n=new u(e,i||e,this._scene);n.needInitialSkinMatrix=this.needInitialSkinMatrix,n.metadata=this.metadata;for(let t=0;t<this.bones.length;t++){const s=this.bones[t];let o=null;const h=s.getParent();if(h){const r=this.bones.indexOf(h);o=n.bones[r]}const a=new c(s.name,n,o,s.getBindMatrix().clone(),s.getRestMatrix().clone());a._index=s._index,s._linkedTransformNode&&a.linkTransformNode(s._linkedTransformNode),B.DeepCopy(s.animations,a.animations)}if(this._ranges){n._ranges={};for(const t in this._ranges){const s=this._ranges[t];s&&(n._ranges[t]=s.clone())}}return this._isDirty=!0,n.prepare(!0),n}enableBlending(e=.01){for(const i of this.bones)for(const n of i.animations)n.enableBlending=!0,n.blendingSpeed=e}dispose(){if(this._meshesWithPoseMatrix.length=0,this.metadata=null,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var i;const e={};e.name=this.name,e.id=this.id,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix,this.metadata&&(e.metadata=this.metadata);for(let n=0;n<this.bones.length;n++){const t=this.bones[n],s=t.getParent(),o={parentBoneIndex:s?this.bones.indexOf(s):-1,index:t.getIndex(),name:t.name,id:t.id,matrix:t.getBindMatrix().asArray(),rest:t.getRestMatrix().asArray(),linkedTransformNodeId:(i=t.getTransformNode())==null?void 0:i.id};e.bones.push(o),t.length&&(o.length=t.length),t.metadata&&(o.metadata=t.metadata),t.animations&&t.animations.length>0&&(o.animation=t.animations[0].serialize()),e.ranges=[];for(const h in this._ranges){const a=this._ranges[h];if(!a)continue;const r={};r.name=h,r.from=a.from,r.to=a.to,e.ranges.push(r)}}return e}static Parse(e,i){const n=new u(e.name,e.id,i);e.dimensionsAtRest&&(n.dimensionsAtRest=R.FromArray(e.dimensionsAtRest)),n.needInitialSkinMatrix=e.needInitialSkinMatrix,e.metadata&&(n.metadata=e.metadata);let t;for(t=0;t<e.bones.length;t++){const s=e.bones[t],o=e.bones[t].index;let h=null;s.parentBoneIndex>-1&&(h=n.bones[s.parentBoneIndex]);const a=s.rest?f.FromArray(s.rest):null,r=new c(s.name,n,h,f.FromArray(s.matrix),a,null,o);s.id!==void 0&&s.id!==null&&(r.id=s.id),s.length&&(r.length=s.length),s.metadata&&(r.metadata=s.metadata),s.animation&&r.animations.push(b.Parse(s.animation)),s.linkedTransformNodeId!==void 0&&s.linkedTransformNodeId!==null&&(n._hasWaitingData=!0,r._waitingTransformNodeId=s.linkedTransformNodeId)}if(e.ranges)for(t=0;t<e.ranges.length;t++){const s=e.ranges[t];n.createAnimationRange(s.name,s.from,s.to)}return n}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=[],i=new Array(this.bones.length);for(let n=0;n<this.bones.length;n++)this._sortBones(n,e,i);this.bones=e}_sortBones(e,i,n){if(n[e])return;n[e]=!0;const t=this.bones[e];if(!t)return;t._index===void 0&&(t._index=e);const s=t.getParent();s&&this._sortBones(this.bones.indexOf(s),i,n),i.push(t)}setCurrentPoseAsRest(){for(const e of this.bones)e.setCurrentPoseAsRest()}}export{u as S};
