import{at as B,p as v,L as I,H as N,bz as A,o as R,c as O,bA as P,v as y,f as V,d as D,ab as C,C as L,bB as w}from"./index-C7ioxznG.js";y._instancedMeshFactory=(u,e)=>{const t=new T(u,e);if(e.instancedBuffers){t.instancedBuffers={};for(const s in e.instancedBuffers)t.instancedBuffers[s]=e.instancedBuffers[s]}return t};class T extends B{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const s of t.getAnimationRanges())s!=null&&this.createAnimationRange(s.name,s.from,s.to);if(this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),!t.skeleton&&!t.morphTargetManager&&t.hasBoundingInfo){const s=t.getBoundingInfo();this.buildBoundingInfo(s.minimum,s.maximum)}else this.refreshBoundingInfo(!0,!0);this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){var t;((t=this._sourceMesh)==null?void 0:t.receiveShadows)!==e&&v.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){var t;((t=this._sourceMesh)==null?void 0:t.material)!==e&&v.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){var t;((t=this._sourceMesh)==null?void 0:t.visibility)!==e&&v.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){var t;((t=this._sourceMesh)==null?void 0:t.skeleton)!==e&&v.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||I.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}get geometry(){return this._sourceMesh._geometry}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,s){return this._sourceMesh.getVerticesData(e,t,s)}copyVerticesData(e,t){this._sourceMesh.copyVerticesData(e,t)}getVertexBuffer(e,t){return this._sourceMesh.getVertexBuffer(e,t)}setVerticesData(e,t,s,n){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,s,n),this.sourceMesh}updateVerticesData(e,t,s,n){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,s,n),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let s;typeof e=="object"?s=e:s={applySkeleton:e,applyMorph:t};const n=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getData(s,null,N.PositionKind),n),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||I.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD!==this._sourceMesh&&this._currentLOD.billboardMode!==A.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new R);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,O.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(O.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(!t||t.length===0)this._currentLOD=this.sourceMesh;else{const s=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,s.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,s,n){const r=(n||this._sourceMesh).createInstance(e);if(P.DeepCopy(this,r,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo","geometry"],[]),t&&(r.parent=t),!s)for(let d=0;d<this.getScene().meshes.length;d++){const c=this.getScene().meshes[d];c.parent===this&&c.clone(c.name,r)}return r.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(r),r}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,s){const n=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);n&&s&&s(this,n);for(const r of this.getChildTransformNodes(!0))r.instantiateHierarchy(n,t,s);return n}}y.prototype.registerInstancedBuffer=function(u,e){var t,s;if((s=(t=this._userInstancedBuffersStorage)==null?void 0:t.vertexBuffers[u])==null||s.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const n of this.instances)n.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[u]=null,this._userInstancedBuffersStorage.strides[u]=e,this._userInstancedBuffersStorage.sizes[u]=e*32,this._userInstancedBuffersStorage.data[u]=new Float32Array(this._userInstancedBuffersStorage.sizes[u]),this._userInstancedBuffersStorage.vertexBuffers[u]=new N(this.getEngine(),this._userInstancedBuffersStorage.data[u],u,!0,!1,e,!0);for(const n of this.instances)n.instancedBuffers[u]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};y.prototype._processInstancedBuffers=function(u,e){const t=u?u.length:0;for(const s in this.instancedBuffers){let n=this._userInstancedBuffersStorage.sizes[s];const r=this._userInstancedBuffersStorage.strides[s],d=(t+1)*r;for(;n<d;)n*=2;this._userInstancedBuffersStorage.data[s].length!=n&&(this._userInstancedBuffersStorage.data[s]=new Float32Array(n),this._userInstancedBuffersStorage.sizes[s]=n,this._userInstancedBuffersStorage.vertexBuffers[s]&&(this._userInstancedBuffersStorage.vertexBuffers[s].dispose(),this._userInstancedBuffersStorage.vertexBuffers[s]=null));const c=this._userInstancedBuffersStorage.data[s];let o=0;if(e){const a=this.instancedBuffers[s];a.toArray?a.toArray(c,o):a.copyToArray?a.copyToArray(c,o):c[o]=a,o+=r}for(let a=0;a<t;a++){const g=u[a].instancedBuffers[s];g.toArray?g.toArray(c,o):g.copyToArray?g.copyToArray(c,o):c[o]=g,o+=r}this._userInstancedBuffersStorage.vertexBuffers[s]?this._userInstancedBuffersStorage.vertexBuffers[s].updateDirectly(c,0):(this._userInstancedBuffersStorage.vertexBuffers[s]=new N(this.getEngine(),this._userInstancedBuffersStorage.data[s],s,!0,!1,r,!0),this._invalidateInstanceVertexArrayObject())}};y.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(const u in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[u]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};y.prototype._disposeInstanceSpecificData=function(){var u;for(const e in this._instanceDataStorage.renderPasses)(u=this._instanceDataStorage.renderPasses[e].instancesBuffer)==null||u.dispose();for(this._instanceDataStorage.renderPasses={};this.instances.length;)this.instances[0].dispose();for(const e in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[e]&&this._userInstancedBuffersStorage.vertexBuffers[e].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};V("BABYLON.InstancedMesh",T);class k{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.sounds=null,this.effectLayers=[],this.layers=[],this.reflectionProbes=[],this.spriteManagers=[]}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes);for(const t of this.skeletons)e=e.concat(t.bones);return e}}class q extends k{}class G{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){const e=this.rootNodes;for(const n of e)n.dispose();e.length=0;const t=this.skeletons;for(const n of t)n.dispose();t.length=0;const s=this.animationGroups;for(const n of s)n.dispose();s.length=0}}class F extends k{constructor(e){super(),this._wasAddedToScene=!1,e=e||D.LastCreatedScene,e&&(this.scene=e,this.proceduralTextures=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(const t of this.geometries)t._rebuild();for(const t of this.meshes)t._rebuild();for(const t of this.particleSystems)t.rebuild();for(const t of this.textures)t._rebuild();for(const t of this.spriteManagers)t.rebuild()}))}_topologicalSort(e){const t=new Map;for(const c of e)t.set(c.uniqueId,c);const s={dependsOn:new Map,dependedBy:new Map};for(const c of e){const o=c.uniqueId;s.dependsOn.set(o,new Set),s.dependedBy.set(o,new Set)}for(const c of e){const o=c.uniqueId,a=s.dependsOn.get(o);if(c instanceof T){const g=c.sourceMesh;t.has(g.uniqueId)&&(a.add(g.uniqueId),s.dependedBy.get(g.uniqueId).add(o))}const p=s.dependedBy.get(o);for(const g of c.getDescendants()){const M=g.uniqueId;t.has(M)&&(p.add(M),s.dependsOn.get(M).add(o))}}const n=[],r=[];for(const c of e){const o=c.uniqueId;s.dependsOn.get(o).size===0&&(r.push(c),t.delete(o))}const d=r;for(;d.length>0;){const c=d.shift();n.push(c);const o=s.dependedBy.get(c.uniqueId);for(const a of Array.from(o.values())){const p=s.dependsOn.get(a);p.delete(c.uniqueId),p.size===0&&t.get(a)&&(d.push(t.get(a)),t.delete(a))}}return t.size>0&&(I.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(c=>{I.Error(c.name)})),n}_addNodeAndDescendantsToList(e,t,s,n){if(!(!s||n&&!n(s)||t.has(s.uniqueId))){e.push(s),t.add(s.uniqueId);for(const r of s.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,r,n)}}_isNodeInContainer(e){return e instanceof B&&this.meshes.indexOf(e)!==-1||e instanceof A&&this.transformNodes.indexOf(e)!==-1||e instanceof C&&this.lights.indexOf(e)!==-1||e instanceof L&&this.cameras.indexOf(e)!==-1}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return I.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return I.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return I.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return I.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,s){this._isValidHierarchy()||v.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const n={},r={},d=new G,c=[],o=[],a={doNotInstantiate:!0,...s},p=(i,h)=>{if(n[i.uniqueId]=h.uniqueId,r[h.uniqueId]=h,e&&(h.name=e(i.name)),h instanceof y){const f=h;if(f.morphTargetManager){const l=i.morphTargetManager;f.morphTargetManager=l.clone();for(let m=0;m<l.numTargets;m++){const S=l.getTarget(m),_=f.morphTargetManager.getTarget(m);n[S.uniqueId]=_.uniqueId,r[_.uniqueId]=_}}}},g=[],M=new Set;for(const i of this.transformNodes)i.parent===null&&this._addNodeAndDescendantsToList(g,M,i,a.predicate);for(const i of this.meshes)i.parent===null&&this._addNodeAndDescendantsToList(g,M,i,a.predicate);const x=this._topologicalSort(g),b=(i,h)=>{if(p(i,h),i.parent){const f=n[i.parent.uniqueId],l=r[f];l?h.parent=l:h.parent=i.parent}if(h.position&&i.position&&h.position.copyFrom(i.position),h.rotationQuaternion&&i.rotationQuaternion&&h.rotationQuaternion.copyFrom(i.rotationQuaternion),h.rotation&&i.rotation&&h.rotation.copyFrom(i.rotation),h.scaling&&i.scaling&&h.scaling.copyFrom(i.scaling),h.material){const f=h;if(f.material)if(t){const l=i.material;if(o.indexOf(l)===-1){let m=l.clone(e?e(l.name):"Clone of "+l.name);if(o.push(l),n[l.uniqueId]=m.uniqueId,r[m.uniqueId]=m,l.getClassName()==="MultiMaterial"){const S=l;for(const _ of S.subMaterials)_&&(m=_.clone(e?e(_.name):"Clone of "+_.name),o.push(_),n[_.uniqueId]=m.uniqueId,r[m.uniqueId]=m);S.subMaterials=S.subMaterials.map(_=>_&&r[n[_.uniqueId]])}}f.getClassName()!=="InstancedMesh"&&(f.material=r[n[l.uniqueId]])}else f.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(f.material)===-1&&this.scene.addMultiMaterial(f.material):this.scene.materials.indexOf(f.material)===-1&&this.scene.addMaterial(f.material)}h.parent===null&&d.rootNodes.push(h)};for(const i of x)if(i.getClassName()==="InstancedMesh"){const h=i,f=h.sourceMesh,l=n[f.uniqueId],S=(typeof l=="number"?r[l]:f).createInstance(h.name);b(h,S)}else{let h=!0;i.getClassName()==="TransformNode"||i.getClassName()==="Node"||i.skeleton||!i.getTotalVertices||i.getTotalVertices()===0?h=!1:a.doNotInstantiate&&(typeof a.doNotInstantiate=="function"?h=!a.doNotInstantiate(i):h=!a.doNotInstantiate);const f=h?i.createInstance(`instance of ${i.name}`):i.clone(`Clone of ${i.name}`,null,!0);if(!f)throw new Error(`Could not clone or instantiate node on Asset Container ${i.name}`);b(i,f)}for(const i of this.skeletons){if(a.predicate&&!a.predicate(i))continue;const h=i.clone(e?e(i.name):"Clone of "+i.name);for(const f of this.meshes)if(f.skeleton===i&&!f.isAnInstance){const l=r[n[f.uniqueId]];if(!l||l.isAnInstance||(l.skeleton=h,c.indexOf(h)!==-1))continue;c.push(h);for(const m of h.bones)m._linkedTransformNode&&(m._linkedTransformNode=r[n[m._linkedTransformNode.uniqueId]])}d.skeletons.push(h)}for(const i of this.animationGroups){if(a.predicate&&!a.predicate(i))continue;const h=i.clone(e?e(i.name):"Clone of "+i.name,f=>r[n[f.uniqueId]]||f);d.animationGroups.push(h)}return d}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||v.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){const t=[];for(const s of this.cameras)e&&!e(s)||(this.scene.addCamera(s),t.push(s));for(const s of this.lights)e&&!e(s)||(this.scene.addLight(s),t.push(s));for(const s of this.meshes)e&&!e(s)||(this.scene.addMesh(s),t.push(s));for(const s of this.skeletons)e&&!e(s)||this.scene.addSkeleton(s);for(const s of this.animations)e&&!e(s)||this.scene.addAnimation(s);for(const s of this.animationGroups)e&&!e(s)||this.scene.addAnimationGroup(s);for(const s of this.multiMaterials)e&&!e(s)||this.scene.addMultiMaterial(s);for(const s of this.materials)e&&!e(s)||this.scene.addMaterial(s);for(const s of this.morphTargetManagers)e&&!e(s)||this.scene.addMorphTargetManager(s);for(const s of this.geometries)e&&!e(s)||this.scene.addGeometry(s);for(const s of this.transformNodes)e&&!e(s)||(this.scene.addTransformNode(s),t.push(s));for(const s of this.actionManagers)e&&!e(s)||this.scene.addActionManager(s);for(const s of this.textures)e&&!e(s)||this.scene.addTexture(s);for(const s of this.reflectionProbes)e&&!e(s)||this.scene.addReflectionProbe(s);for(const s of this.spriteManagers)e&&!e(s)||(this.scene.spriteManagers||(this.scene.spriteManagers=[]),this.scene.spriteManagers.push(s));if(t.length){const s=new Set(this.scene.meshes);for(const n of this.scene.lights)s.add(n);for(const n of this.scene.cameras)s.add(n);for(const n of this.scene.transformNodes)s.add(n);for(const n of this.skeletons)for(const r of n.bones)s.add(r);for(const n of t)n.parent&&!s.has(n.parent)&&(n.setParent?n.setParent(null):n.parent=null)}}removeAllFromScene(){this._isValidHierarchy()||v.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){for(const t of this.cameras)e&&!e(t)||this.scene.removeCamera(t);for(const t of this.lights)e&&!e(t)||this.scene.removeLight(t);for(const t of this.meshes)e&&!e(t)||this.scene.removeMesh(t,!0);for(const t of this.skeletons)e&&!e(t)||this.scene.removeSkeleton(t);for(const t of this.animations)e&&!e(t)||this.scene.removeAnimation(t);for(const t of this.animationGroups)e&&!e(t)||this.scene.removeAnimationGroup(t);for(const t of this.multiMaterials)e&&!e(t)||this.scene.removeMultiMaterial(t);for(const t of this.materials)e&&!e(t)||this.scene.removeMaterial(t);for(const t of this.morphTargetManagers)e&&!e(t)||this.scene.removeMorphTargetManager(t);for(const t of this.geometries)e&&!e(t)||this.scene.removeGeometry(t);for(const t of this.transformNodes)e&&!e(t)||this.scene.removeTransformNode(t);for(const t of this.actionManagers)e&&!e(t)||this.scene.removeActionManager(t);for(const t of this.textures)e&&!e(t)||this.scene.removeTexture(t);for(const t of this.reflectionProbes)e&&!e(t)||this.scene.removeReflectionProbe(t);for(const t of this.spriteManagers)if(!(e&&!e(t))&&this.scene.spriteManagers){const s=this.scene.spriteManagers.indexOf(t);s!==-1&&this.scene.spriteManagers.splice(s,1)}}dispose(){const e=this.cameras.slice(0);for(const i of e)i.dispose();this.cameras.length=0;const t=this.lights.slice(0);for(const i of t)i.dispose();this.lights.length=0;const s=this.meshes.slice(0);for(const i of s)i.dispose();this.meshes.length=0;const n=this.skeletons.slice(0);for(const i of n)i.dispose();this.skeletons.length=0;const r=this.animationGroups.slice(0);for(const i of r)i.dispose();this.animationGroups.length=0;const d=this.multiMaterials.slice(0);for(const i of d)i.dispose();this.multiMaterials.length=0;const c=this.materials.slice(0);for(const i of c)i.dispose();this.materials.length=0;const o=this.geometries.slice(0);for(const i of o)i.dispose();this.geometries.length=0;const a=this.transformNodes.slice(0);for(const i of a)i.dispose();this.transformNodes.length=0;const p=this.actionManagers.slice(0);for(const i of p)i.dispose();this.actionManagers.length=0;const g=this.textures.slice(0);for(const i of g)i.dispose();this.textures.length=0;const M=this.reflectionProbes.slice(0);for(const i of M)i.dispose();this.reflectionProbes.length=0;const x=this.morphTargetManagers.slice(0);for(const i of x)i.dispose();this.morphTargetManagers.length=0;const b=this.spriteManagers.slice(0);for(const i of b)i.dispose();this.spriteManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const i of this.scene._serializableComponents)i.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,s){if(!(!e||!t))for(const n of e){let r=!0;if(s){for(const d of s)if(n===d){r=!1;break}}r&&(t.push(n),n._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new q);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="_environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new y("assetContainerRootMesh",this.scene);for(const t of this.meshes)t.parent||e.addChild(t);return this.meshes.unshift(e),e}mergeAnimationsTo(e=D.LastCreatedScene,t,s=null){if(!e)return I.Error("No scene available to merge animations to"),[];const n=s||(o=>{let a=null;const p=o.animations.length?o.animations[0].targetProperty:"",g=o.name.split(".").join("").split("_primitive")[0];switch(p){case"position":case"rotationQuaternion":a=e.getTransformNodeByName(o.name)||e.getTransformNodeByName(g);break;case"influence":a=e.getMorphTargetByName(o.name)||e.getMorphTargetByName(g);break;default:a=e.getNodeByName(o.name)||e.getNodeByName(g)}return a}),r=this.getNodes();for(const o of r){const a=n(o);if(a!==null){for(const p of o.animations){const g=a.animations.filter(M=>M.targetProperty===p.targetProperty);for(const M of g){const x=a.animations.indexOf(M,0);x>-1&&a.animations.splice(x,1)}}a.animations=a.animations.concat(o.animations)}}const d=[],c=this.animationGroups.slice();for(const o of c){d.push(o.clone(o.name,n));for(const a of o.animatables)a.stop()}for(const o of t){const a=n(o.target);a&&(e.beginAnimation(a,o.fromFrame,o.toFrame,o.loopAnimation,o.speedRatio,o.onAnimationEnd?o.onAnimationEnd:void 0,void 0,!0,void 0,o.onAnimationLoop?o.onAnimationLoop:void 0),e.stopAnimation(o.target))}return d}populateRootNodes(){this.rootNodes.length=0;for(const e of this.meshes)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(const e of this.transformNodes)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(const e of this.lights)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(const e of this.cameras)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}addAllAssetsToContainer(e){if(!e)return;const t=[],s=new Set;for(t.push(e);t.length>0;){const n=t.pop();if(n instanceof y?(n.geometry&&this.geometries.indexOf(n.geometry)===-1&&this.geometries.push(n.geometry),this.meshes.push(n)):n instanceof T?this.meshes.push(n):n instanceof A?this.transformNodes.push(n):n instanceof C?this.lights.push(n):n instanceof L&&this.cameras.push(n),n instanceof B){if(n.material&&this.materials.indexOf(n.material)===-1){this.materials.push(n.material);for(const r of n.material.getActiveTextures())this.textures.indexOf(r)===-1&&this.textures.push(r)}n.skeleton&&this.skeletons.indexOf(n.skeleton)===-1&&this.skeletons.push(n.skeleton),n.morphTargetManager&&this.morphTargetManagers.indexOf(n.morphTargetManager)===-1&&this.morphTargetManagers.push(n.morphTargetManager)}for(const r of n.getChildren())s.has(r)||t.push(r);s.add(n)}this.populateRootNodes()}_getByTags(e,t,s){if(t===void 0)return e;const n=[];for(const r in e){const d=e[r];w&&w.MatchesQuery(d,t)&&(!s||s(d))&&n.push(d)}return n}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialsByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}}export{F as A};
