import{O as R,V as m,d as w,ae as c,L as C,a1 as v,i as F,f as L,k as b,j as _,o as U,aL as W,p as P,bR as z,bQ as q}from"./index-C7ioxznG.js";import{_ as $,a as g}from"./spatialWebAudio-BiZWmVK-.js";import{_WebAudioSoundSource as p}from"./webAudioSoundSource-DwUuphFz.js";import{_WebAudioStaticSound as y}from"./webAudioStaticSound-Counvxcp.js";import{_WebAudioStreamingSound as j}from"./webAudioStreamingSound-DARmwvH_.js";import{ArrayItem as T,GLTFLoader as S}from"./glTFLoader-dcV3nFjy.js";import"./audioEngine-uesWbcoE.js";import"./index-BmJkaHuF.js";import"./webAudioBaseSubGraph-2o5xwuHA.js";import"./abstractSoundSource-D25XFPoj.js";import"./abstractSoundInstance-DlMiMFDu.js";import"./bone-D3wPsQsS.js";import"./skeleton-Dp5NNatR.js";import"./rawTexture-B_Rn1rXF.js";import"./assetContainer-WmWzRef8.js";import"./objectModelMapping-CY2JGqxk.js";class E{constructor(t,e,i){this.frame=t,this.action=e,this.onlyOnce=i,this.isDone=!1}_clone(){return new E(this.frame,this.action,this.onlyOnce)}}const x={duration:0,shape:"linear"},D={duration:0,startOffset:0,waitTime:0},I={waitTime:0};function M(a){return a*Math.PI/180}function N(a){return a*180/Math.PI}class A{get name(){return this._soundV2.name}set name(t){this._soundV2.name=t}get autoplay(){return this._soundV2 instanceof p?!0:this._optionsV2.autoplay}set autoplay(t){this._optionsV2.autoplay=t}get loop(){return this._soundV2 instanceof p?!0:this._soundV2.loop}set loop(t){this._soundV2 instanceof p||this._soundV2&&(this._soundV2.loop=t)}get isPlaying(){var t;return this._soundV2 instanceof p?!0:((t=this._soundV2)==null?void 0:t.state)===3||!this.isReady()&&this._optionsV2.autoplay}get isPaused(){return this._soundV2 instanceof p?!1:this._soundV2.state===5}get maxDistance(){return this._optionsV2.spatialMaxDistance||100}set maxDistance(t){this._optionsV2.spatialMaxDistance=t,!this.useCustomAttenuation&&this._soundV2&&(this._initSpatial(),this._soundV2.spatial.maxDistance=t)}get distanceModel(){return this._optionsV2.spatialDistanceModel||"linear"}set distanceModel(t){this._optionsV2.spatialDistanceModel=t,this._soundV2&&(this._initSpatial(),this._soundV2.spatial.distanceModel=t)}get currentTime(){return this._soundV2 instanceof p?this._soundV2.engine.currentTime:this._soundV2.currentTime}get spatialSound(){var t;return((t=this._soundV2)==null?void 0:t._isSpatial)??!1}set spatialSound(t){this._soundV2&&(t?this._initSpatial():this._soundV2._isSpatial=!1)}get _onReady(){return this._onReadyObservable||(this._onReadyObservable=new R),this._onReadyObservable}constructor(t,e,i,o=null,s){if(this.useCustomAttenuation=!1,this.soundTrackId=-1,this.refDistance=1,this.rolloffFactor=1,this.metadata=null,this.onEndedObservable=new R,this._localDirection=new m(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._isOutputConnected=!1,this._url=null,this._onReadyObservable=null,this._onReadyToPlay=()=>{this._scene.mainSoundTrack.addSound(this),this._isReadyToPlay=!0,this._readyToPlayCallback(),this._onReadyObservable&&this._onReadyObservable.notifyObservers(),this._optionsV2.autoplay&&this.play()},this._onended=()=>{this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)},i=i||w.LastCreatedScene,!i)return;this._scene=i,A._SceneComponentInitialization(i),this._readyToPlayCallback=o||(()=>{}),this._customAttenuationFunction=(h,V,O,Q,X)=>V<O?h*(1-V/O):0,s=s||{};const n={analyzerEnabled:!1,autoplay:!1,duration:s.length||0,loop:s.loop||!1,loopEnd:0,loopStart:0,outBus:null,outBusAutoDefault:!1,playbackRate:s.playbackRate||1,pitch:0,skipCodecCheck:s.skipCodecCheck||!1,spatialDistanceModel:s.distanceModel,spatialEnabled:s.spatialSound,spatialMaxDistance:s.maxDistance,spatialMinDistance:s.refDistance,spatialRolloffFactor:s.rolloffFactor,stereoEnabled:!1,startOffset:s.offset||0,volume:s.volume??1};this._volume=s.volume??1,$(n)&&(n.spatialAutoUpdate=!1,n.spatialConeInnerAngle=g.coneInnerAngle,n.spatialConeOuterAngle=g.coneOuterAngle,n.spatialConeOuterVolume=g.coneOuterVolume,n.spatialMinUpdateTime=0,n.spatialOrientation=g.orientation.clone(),n.spatialPanningModel=this._scene.headphone?"HRTF":"equalpower",n.spatialPosition=g.position.clone(),n.spatialRotation=g.rotation.clone(),n.spatialRotationQuaternion=g.rotationQuaternion.clone(),n.spatialMaxDistance===void 0&&(n.spatialMaxDistance=100)),this._optionsV2={...n},this._optionsV2.autoplay=s.autoplay||!1,this.useCustomAttenuation=s.useCustomAttenuation??!1,this.useCustomAttenuation&&(n.spatialMaxDistance=Number.MAX_VALUE,n.volume=0);let r=(s==null?void 0:s.streaming)||!1;if(!c.audioEngine)return;const d=c.audioEngine._v2,u=()=>{if(r){const h={preloadCount:0,...n},V=new j(t,d,h);return V._initAsync(e,n).then(()=>{V.preloadInstancesAsync(1).then(this._onReadyToPlay)}),V}else{const h=new y(t,d,n);return h._initAsync(e,n).then(this._onReadyToPlay),h}};if(!e)this._soundV2=new y(t,d,n);else if(typeof e=="string")this._url=e,this._soundV2=u();else if(e instanceof ArrayBuffer)r=!1,this._soundV2=u();else if(e instanceof HTMLMediaElement)r=!0,this._soundV2=u();else if(e instanceof MediaStream){const h=new MediaStreamAudioSourceNode(d._audioContext,{mediaStream:e});this._soundV2=new p(t,h,d,n),this._soundV2._initAsync(n).then(this._onReadyToPlay)}else e instanceof AudioBuffer?(r=!1,this._soundV2=u()):Array.isArray(e)&&(this._soundV2=u());if(!this._soundV2){C.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.");return}this._soundV2 instanceof p||this._soundV2.onEndedObservable.add(this._onended)}dispose(){this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._soundV2.dispose()}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}setAudioBuffer(t){this._isReadyToPlay||this._soundV2 instanceof y&&this._soundV2._initAsync(t,this._optionsV2).then(this._onReadyToPlay)}updateOptions(t){if(t){if(this.loop=t.loop??this.loop,this.maxDistance=t.maxDistance??this.maxDistance,this.useCustomAttenuation=t.useCustomAttenuation??this.useCustomAttenuation,this.rolloffFactor=t.rolloffFactor??this.rolloffFactor,this.refDistance=t.refDistance??this.refDistance,this.distanceModel=t.distanceModel??this.distanceModel,t.playbackRate!==void 0&&this.setPlaybackRate(t.playbackRate),t.spatialSound!==void 0&&(this.spatialSound=t.spatialSound),t.volume!==void 0&&this.setVolume(t.volume),this._soundV2 instanceof y){let e=!1;t.offset!==void 0&&(this._optionsV2.startOffset=t.offset,e=!0),t.length!==void 0&&(this._soundV2.duration=t.length,e=!0),e&&this.isPaused&&this.stop()}this._updateSpatialParameters()}}_updateSpatialParameters(){if(!this.spatialSound)return;const t=this._soundV2.spatial;this.useCustomAttenuation?(t.distanceModel="linear",t.minDistance=1,t.maxDistance=Number.MAX_VALUE,t.rolloffFactor=1,t.panningModel="equalpower"):(t.distanceModel=this.distanceModel,t.minDistance=this.refDistance,t.maxDistance=this.maxDistance,t.rolloffFactor=this.rolloffFactor,t.panningModel=this._optionsV2.spatialPanningModel||"equalpower")}switchPanningModelToHRTF(){this.spatialSound&&(this._initSpatial(),this._soundV2.spatial.panningModel="HRTF")}switchPanningModelToEqualPower(){this.spatialSound&&(this._initSpatial(),this._soundV2.spatial.panningModel="equalpower")}connectToSoundTrackAudioNode(t){const e=this._soundV2._outNode;e&&(this._isOutputConnected&&e.disconnect(),e.connect(t),this._isOutputConnected=!0)}setDirectionalCone(t,e,i){if(e<t){C.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._optionsV2.spatialConeInnerAngle=M(t),this._optionsV2.spatialConeOuterAngle=M(e),this._optionsV2.spatialConeOuterVolume=i,this._initSpatial(),this._soundV2.spatial.coneInnerAngle=this._optionsV2.spatialConeInnerAngle,this._soundV2.spatial.coneOuterAngle=this._optionsV2.spatialConeOuterAngle,this._soundV2.spatial.coneOuterVolume=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._optionsV2.startOffset,this._optionsV2.duration))}get directionalConeInnerAngle(){return N(typeof this._optionsV2.spatialConeInnerAngle=="number"?this._optionsV2.spatialConeInnerAngle:g.coneInnerAngle)}set directionalConeInnerAngle(t){if(t=M(t),t!=this._optionsV2.spatialConeInnerAngle){if(this.directionalConeOuterAngle<t){C.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._optionsV2.spatialConeInnerAngle=t,this.spatialSound&&(this._initSpatial(),this._soundV2.spatial.coneInnerAngle=t)}}get directionalConeOuterAngle(){return N(typeof this._optionsV2.spatialConeOuterAngle=="number"?this._optionsV2.spatialConeOuterAngle:g.coneOuterAngle)}set directionalConeOuterAngle(t){if(t=M(t),t!=this._optionsV2.spatialConeOuterAngle){if(t<this.directionalConeInnerAngle){C.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._optionsV2.spatialConeOuterAngle=t,this.spatialSound&&(this._initSpatial(),this._soundV2.spatial.coneOuterAngle=t)}}setPosition(t){this._optionsV2.spatialPosition&&t.equals(this._optionsV2.spatialPosition)||(this._optionsV2.spatialPosition||(this._optionsV2.spatialPosition=m.Zero()),this._optionsV2.spatialPosition.copyFrom(t),this.spatialSound&&!isNaN(t.x)&&!isNaN(t.y)&&!isNaN(t.z)&&(this._initSpatial(),this._soundV2.spatial.position=t))}setLocalDirectionToMesh(t){this._localDirection=t,this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this.spatialSound)return;const t=this._connectedTransformNode.getWorldMatrix(),e=m.TransformNormal(this._localDirection,t);e.normalize(),this._initSpatial(),this._soundV2.spatial.orientation=e}_initSpatial(){this._soundV2._isSpatial=!0,this._optionsV2.spatialDistanceModel===void 0&&(this._optionsV2.spatialDistanceModel="linear",this._soundV2.spatial.distanceModel="linear"),this._optionsV2.spatialMaxDistance===void 0&&(this._optionsV2.spatialMaxDistance=100,this._soundV2.spatial.maxDistance=100)}updateDistanceFromListener(){if(this._soundV2._outNode&&this._connectedTransformNode&&this.useCustomAttenuation&&this._scene.activeCamera){const t=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundV2.volume=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(t){this._customAttenuationFunction=t}play(t,e,i){const o=c.audioEngine;if(o==null||o.unlock(),!(this._soundV2 instanceof p)&&this._isReadyToPlay&&this._scene.audioEnabled){this._soundV2.state===5&&(t!==void 0||e!==void 0||i!==void 0)&&this._soundV2.stop();try{D.duration=i||0,D.startOffset=e!==void 0?e||this._optionsV2.startOffset:this._optionsV2.startOffset,D.waitTime=t||0,o!=null&&o.unlocked?this._soundV2.play(D):setTimeout(()=>{this._soundV2.play(D)},500)}catch(s){C.Error("Error while trying to play audio: "+this.name+", "+s.message)}}}stop(t){this._soundV2&&(this._soundV2 instanceof p||(I.waitTime=t||0,this._soundV2.stop(I)))}pause(){this._soundV2&&(this._soundV2 instanceof p||this._soundV2.pause())}setVolume(t,e){if(!this.isReady()){this._onReady.addOnce(()=>{this.setVolume(t,e)});return}x.duration=e||0,this._soundV2.setVolume(t,x),this._volume=t}setPlaybackRate(t){this._soundV2 instanceof y&&(this._soundV2.playbackRate=t)}getPlaybackRate(){return this._soundV2 instanceof y?this._soundV2.playbackRate:1}getVolume(){return this._volume}attachToMesh(t){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=t,this.spatialSound||(this.spatialSound=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._optionsV2.startOffset,this._optionsV2.duration))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=e=>this._onRegisterAfterWorldMatrixUpdate(e),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(t){if(!t.getBoundingInfo)this.setPosition(t.absolutePosition);else{const i=t.getBoundingInfo();this.setPosition(i.boundingSphere.centerWorld)}this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(!(this._soundV2 instanceof y))return null;const t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},e=new A(this.name+"_cloned",this._soundV2.buffer,this._scene,null,t);return e._optionsV2=this._optionsV2,this.useCustomAttenuation&&e.setAttenuationFunction(this._customAttenuationFunction),e}getAudioBuffer(){return this._soundV2 instanceof y?this._soundV2.buffer._audioBuffer:null}getSoundSource(){return null}getSoundGain(){return this._soundV2._outNode}serialize(){const t={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this.getPlaybackRate(),panningModel:this._soundV2.spatial.panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this.spatialSound&&(this._connectedTransformNode&&(t.connectedMeshId=this._connectedTransformNode.id),t.position=this._soundV2.spatial.position.asArray(),t.refDistance=this.refDistance,t.distanceModel=this.distanceModel,t.isDirectional=this._isDirectional,t.localDirectionToMesh=this._localDirection.asArray(),t.coneInnerAngle=this.directionalConeInnerAngle,t.coneOuterAngle=this.directionalConeOuterAngle,t.coneOuterGain=this._soundV2.spatial.coneOuterVolume),t}static Parse(t,e,i,o){const s=t.name;let n;t.url?n=i+t.url:n=i+s;const r={autoplay:t.autoplay,loop:t.loop,volume:t.volume,spatialSound:t.spatialSound,maxDistance:t.maxDistance,rolloffFactor:t.rolloffFactor,refDistance:t.refDistance,distanceModel:t.distanceModel,playbackRate:t.playbackRate};let l;if(!o)l=new A(s,n,e,()=>{e.removePendingData(l)},r),e.addPendingData(l);else{const d=()=>{v(()=>o._isReadyToPlay,()=>{const u=o.getAudioBuffer();u&&l.setAudioBuffer(u),l._isReadyToPlay=!0,l.autoplay&&l.play(0,o._optionsV2.startOffset,o._optionsV2.duration)},void 0,300)};l=new A(s,new ArrayBuffer(0),e,null,r),d()}if(t.position){const d=m.FromArray(t.position);l.setPosition(d)}if(t.isDirectional&&(l.setDirectionalCone(t.coneInnerAngle||360,t.coneOuterAngle||360,t.coneOuterGain||0),t.localDirectionToMesh)){const d=m.FromArray(t.localDirectionToMesh);l.setLocalDirectionToMesh(d)}if(t.connectedMeshId){const d=e.getMeshById(t.connectedMeshId);d&&l.attachToMesh(d)}return t.metadata&&(l.metadata=t.metadata),l}}A._SceneComponentInitialization=a=>{throw F("AudioSceneComponent")};L("BABYLON.Sound",A);class G{constructor(t,e,i){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],e.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=t,this._weights=i;let o=0;for(const n of i)o+=n;const s=o>0?1/o:0;for(let n=0;n<this._weights.length;n++)this._weights[n]*=s;this._sounds=e;for(const n of this._sounds)n.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(t){if(t!==this._coneInnerAngle){if(this._coneOuterAngle<t){C.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t;for(const e of this._sounds)e.directionalConeInnerAngle=t}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(t){if(t!==this._coneOuterAngle){if(t<this._coneInnerAngle){C.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=t;for(const e of this._sounds)e.directionalConeOuterAngle=t}}get volume(){return this._volume}set volume(t){if(t!==this._volume)for(const e of this._sounds)e.setVolume(t)}_onended(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPlaying&&(this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause())}stop(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()}play(t){if(!this.isPaused){this.stop();const i=Math.random();let o=0;for(let s=0;s<this._weights.length;s++)if(o+=this._weights[s],i<=o){this._currentIndex=s;break}}const e=this._sounds[this._currentIndex??0];e.isReady()?e.play(0,this.isPaused?void 0:t):e.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}class B{constructor(t,e={}){this.id=-1,this._isInitialized=!1,t=t||w.LastCreatedScene,t&&(this._scene=t,this.soundCollection=[],this._options=e,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){var t;(t=c.audioEngine)!=null&&t.canUseWebAudio&&c.audioEngine.audioContext&&(this._outputAudioNode=c.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(c.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(c.audioEngine&&c.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(t){var e;this._isInitialized||this._initializeSoundTrackAudioGraph(),(e=c.audioEngine)!=null&&e.canUseWebAudio&&this._outputAudioNode&&t.connectToSoundTrackAudioNode(this._outputAudioNode),t.soundTrackId!==void 0&&(t.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(t):this._scene.soundTracks&&this._scene.soundTracks[t.soundTrackId].removeSound(t)),this.soundCollection.push(t),t.soundTrackId=this.id}removeSound(t){const e=this.soundCollection.indexOf(t);e!==-1&&this.soundCollection.splice(e,1)}setVolume(t){var e;(e=c.audioEngine)!=null&&e.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=t)}switchPanningModelToHRTF(){var t;if((t=c.audioEngine)!=null&&t.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){var t;if((t=c.audioEngine)!=null&&t.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower()}connectToAnalyser(t){var e;this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=t,(e=c.audioEngine)!=null&&e.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,c.audioEngine.masterGain))}}Object.defineProperty(b.prototype,"mainSoundTrack",{get:function(){let a=this._getComponent(_.NAME_AUDIO);return a||(a=new f(this),this._addComponent(a)),this._mainSoundTrack||(this._mainSoundTrack=new B(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0});b.prototype.getSoundByName=function(a){let t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)if(this.mainSoundTrack.soundCollection[t].name===a)return this.mainSoundTrack.soundCollection[t];if(this.soundTracks){for(let e=0;e<this.soundTracks.length;e++)for(t=0;t<this.soundTracks[e].soundCollection.length;t++)if(this.soundTracks[e].soundCollection[t].name===a)return this.soundTracks[e].soundCollection[t]}return null};Object.defineProperty(b.prototype,"audioEnabled",{get:function(){let a=this._getComponent(_.NAME_AUDIO);return a||(a=new f(this),this._addComponent(a)),a.audioEnabled},set:function(a){let t=this._getComponent(_.NAME_AUDIO);t||(t=new f(this),this._addComponent(t)),a?t.enableAudio():t.disableAudio()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"headphone",{get:function(){let a=this._getComponent(_.NAME_AUDIO);return a||(a=new f(this),this._addComponent(a)),a.headphone},set:function(a){let t=this._getComponent(_.NAME_AUDIO);t||(t=new f(this),this._addComponent(t)),a?t.switchAudioModeForHeadphones():t.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"audioListenerPositionProvider",{get:function(){let a=this._getComponent(_.NAME_AUDIO);return a||(a=new f(this),this._addComponent(a)),a.audioListenerPositionProvider},set:function(a){let t=this._getComponent(_.NAME_AUDIO);if(t||(t=new f(this),this._addComponent(t)),a&&typeof a!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");t.audioListenerPositionProvider=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"audioListenerRotationProvider",{get:function(){let a=this._getComponent(_.NAME_AUDIO);return a||(a=new f(this),this._addComponent(a)),a.audioListenerRotationProvider},set:function(a){let t=this._getComponent(_.NAME_AUDIO);if(t||(t=new f(this),this._addComponent(t)),a&&typeof a!="function")throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");t.audioListenerRotationProvider=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"audioPositioningRefreshRate",{get:function(){let a=this._getComponent(_.NAME_AUDIO);return a||(a=new f(this),this._addComponent(a)),a.audioPositioningRefreshRate},set:function(a){let t=this._getComponent(_.NAME_AUDIO);t||(t=new f(this),this._addComponent(t)),t.audioPositioningRefreshRate=a},enumerable:!0,configurable:!0});class f{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(t){this.name=_.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new m,this._cachedCameraPosition=new m,this._lastCheck=0,this._invertMatrixTemp=new U,this._cameraDirectionTemp=new m,t=t||w.LastCreatedScene,t&&(this.scene=t,t.soundTracks=[],t.sounds=[])}register(){this.scene._afterRenderStage.registerStep(_.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(t){if(t.sounds=[],this.scene.soundTracks)for(let e=0;e<this.scene.soundTracks.length;e++){const i=this.scene.soundTracks[e];for(let o=0;o<i.soundCollection.length;o++)t.sounds.push(i.soundCollection[o].serialize())}}addFromContainer(t){if(t.sounds)for(const e of t.sounds)e.play(),e.autoplay=!0,this.scene.mainSoundTrack.addSound(e)}removeFromContainer(t,e=!1){if(t.sounds)for(const i of t.sounds)i.stop(),i.autoplay=!1,this.scene.mainSoundTrack.removeSound(i),e&&i.dispose()}dispose(){const t=this.scene;if(t._mainSoundTrack&&t.mainSoundTrack.dispose(),t.soundTracks)for(let e=0;e<t.soundTracks.length;e++)t.soundTracks[e].dispose()}disableAudio(){const t=this.scene;this._audioEnabled=!1,c.audioEngine&&c.audioEngine.audioContext&&c.audioEngine.audioContext.suspend();let e;for(e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].pause();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let i=0;i<t.soundTracks[e].soundCollection.length;i++)t.soundTracks[e].soundCollection[i].pause()}enableAudio(){const t=this.scene;this._audioEnabled=!0,c.audioEngine&&c.audioEngine.audioContext&&c.audioEngine.audioContext.resume();let e;for(e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].isPaused&&t.mainSoundTrack.soundCollection[e].play();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let i=0;i<t.soundTracks[e].soundCollection.length;i++)t.soundTracks[e].soundCollection[i].isPaused&&t.soundTracks[e].soundCollection[i].play()}switchAudioModeForHeadphones(){const t=this.scene;if(this._headphone=!0,t.mainSoundTrack.switchPanningModelToHRTF(),t.soundTracks)for(let e=0;e<t.soundTracks.length;e++)t.soundTracks[e].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const t=this.scene;if(this._headphone=!1,t.mainSoundTrack.switchPanningModelToEqualPower(),t.soundTracks)for(let e=0;e<t.soundTracks.length;e++)t.soundTracks[e].switchPanningModelToEqualPower()}_afterRender(){const t=W.Now;if(this._lastCheck&&t-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=t;const e=this.scene;if(!this._audioEnabled||!e._mainSoundTrack||!e.soundTracks||e._mainSoundTrack.soundCollection.length===0&&e.soundTracks.length===1)return;const i=c.audioEngine;if(i&&i.audioContext){let o=e.activeCamera;if(e.activeCameras&&e.activeCameras.length>0&&(o=e.activeCameras[0]),this.audioListenerPositionProvider){const n=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(n.x||0,n.y||0,n.z||0)}else o?this._cachedCameraPosition.equals(o.globalPosition)||(this._cachedCameraPosition.copyFrom(o.globalPosition),i.audioContext.listener.setPosition(o.globalPosition.x,o.globalPosition.y,o.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const n=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(n.x||0,n.y||0,n.z||0,0,1,0)}else o?(o.rigCameras&&o.rigCameras.length>0&&(o=o.rigCameras[0]),o.getViewMatrix().invertToRef(this._invertMatrixTemp),m.TransformNormalToRef(f._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);let s;for(s=0;s<e.mainSoundTrack.soundCollection.length;s++){const n=e.mainSoundTrack.soundCollection[s];n.useCustomAttenuation&&n.updateDistanceFromListener()}if(e.soundTracks)for(s=0;s<e.soundTracks.length;s++)for(let n=0;n<e.soundTracks[s].soundCollection.length;n++){const r=e.soundTracks[s].soundCollection[n];r.useCustomAttenuation&&r.updateDistanceFromListener()}}}}f._CameraDirection=new m(0,0,-1);A._SceneComponentInitialization=a=>{let t=a._getComponent(_.NAME_AUDIO);t||(t=new f(a),a._addComponent(t))};const k="MSFT_audio_emitter";class H{constructor(t){this.name=k,this._loader=t,this.enabled=this._loader.isExtensionUsed(k)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const t=this._loader.gltf.extensions;if(t&&t[this.name]){const e=t[this.name];this._clips=e.clips,this._emitters=e.emitters,T.Assign(this._clips),T.Assign(this._emitters)}}loadSceneAsync(t,e){return S.LoadExtensionAsync(t,e,this.name,async(i,o)=>{const s=new Array;s.push(this._loader.loadSceneAsync(t,e));for(const n of o.emitters){const r=T.Get(`${i}/emitters`,this._emitters,n);if(r.refDistance!=null||r.maxDistance!=null||r.rolloffFactor!=null||r.distanceModel!=null||r.innerAngle!=null||r.outerAngle!=null)throw new Error(`${i}: Direction or Distance properties are not allowed on emitters attached to a scene`);s.push(this._loadEmitterAsync(`${i}/emitters/${r.index}`,r))}await Promise.all(s)})}loadNodeAsync(t,e,i){return S.LoadExtensionAsync(t,e,this.name,async(o,s)=>{const n=new Array,r=await this._loader.loadNodeAsync(o,e,l=>{for(const d of s.emitters){const u=T.Get(`${o}/emitters`,this._emitters,d);n.push(this._loadEmitterAsync(`${o}/emitters/${u.index}`,u).then(()=>{for(const h of u._babylonSounds)h.attachToMesh(l),(u.innerAngle!=null||u.outerAngle!=null)&&(h.setLocalDirectionToMesh(m.Forward()),h.setDirectionalCone(2*P.ToDegrees(u.innerAngle==null?Math.PI:u.innerAngle),2*P.ToDegrees(u.outerAngle==null?Math.PI:u.outerAngle),0))}))}i(l)});return await Promise.all(n),r})}loadAnimationAsync(t,e){return S.LoadExtensionAsync(t,e,this.name,async(i,o)=>{const s=await this._loader.loadAnimationAsync(t,e),n=new Array;T.Assign(o.events);for(const r of o.events)n.push(this._loadAnimationEventAsync(`${i}/events/${r.index}`,t,e,r,s));return await Promise.all(n),s})}_loadClipAsync(t,e){if(e._objectURL)return e._objectURL;let i;if(e.uri)i=this._loader.loadUriAsync(t,e,e.uri);else{const o=T.Get(`${t}/bufferView`,this._loader.gltf.bufferViews,e.bufferView);i=this._loader.loadBufferViewAsync(`/bufferViews/${o.index}`,o)}return e._objectURL=i.then(o=>URL.createObjectURL(new Blob([o],{type:e.mimeType}))),e._objectURL}_loadEmitterAsync(t,e){if(e._babylonSounds=e._babylonSounds||[],!e._babylonData){const i=new Array,o=e.name||`emitter${e.index}`,s={loop:!1,autoplay:!1,volume:e.volume==null?1:e.volume};for(let r=0;r<e.clips.length;r++){const l=`/extensions/${this.name}/clips`,d=T.Get(l,this._clips,e.clips[r].clip);i.push(this._loadClipAsync(`${l}/${e.clips[r].clip}`,d).then(u=>{const h=e._babylonSounds[r]=new A(o,u,this._loader.babylonScene,null,s);h.refDistance=e.refDistance||1,h.maxDistance=e.maxDistance||256,h.rolloffFactor=e.rolloffFactor||1,h.distanceModel=e.distanceModel||"exponential"}))}const n=Promise.all(i).then(()=>{const r=e.clips.map(d=>d.weight||1),l=new G(e.loop||!1,e._babylonSounds,r);e.innerAngle&&(l.directionalConeInnerAngle=2*P.ToDegrees(e.innerAngle)),e.outerAngle&&(l.directionalConeOuterAngle=2*P.ToDegrees(e.outerAngle)),e.volume&&(l.volume=e.volume),e._babylonData.sound=l});e._babylonData={loaded:n}}return e._babylonData.loaded}_getEventAction(t,e,i,o,s){switch(i){case"play":return n=>{const r=(s||0)+(n-o);e.play(r)};case"stop":return()=>{e.stop()};case"pause":return()=>{e.pause()};default:throw new Error(`${t}: Unsupported action ${i}`)}}_loadAnimationEventAsync(t,e,i,o,s){if(s.targetedAnimations.length==0)return Promise.resolve();const n=s.targetedAnimations[0],r=o.emitter,l=T.Get(`/extensions/${this.name}/emitters`,this._emitters,r);return this._loadEmitterAsync(t,l).then(()=>{const d=l._babylonData.sound;if(d){const u=new E(o.time,this._getEventAction(t,d,o.action,o.time,o.startOffset));n.animation.addEvent(u),s.onAnimationGroupEndObservable.add(()=>{d.stop()}),s.onAnimationGroupPauseObservable.add(()=>{d.pause()})}})}}z(k);q(k,!0,a=>new H(a));export{H as MSFT_audio_emitter};
