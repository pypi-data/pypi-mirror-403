[build-system]
requires = ["setuptools>=61", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "mbo_utilities"
version = "2.5.2"
description = "Various utilities for the Miller Brain Observatory"
readme = "README.md"
license = "BSD-3-Clause"
requires-python = ">=3.12.7,<3.13"
keywords = ["Microscopy", "ScanImage", "multiROI", "Tiff"]
dependencies = [
	"numpy>=2.2.5,<3.0",
	"pandas",
	"scipy",
	"tifffile>=2025.3.30",
	"scikit-image",
	"zarr>=3.1.3",
	"dask>=2025.3.0",
	"imageio[ffmpeg]",
	"ffmpeg-python",
	"matplotlib>=3.10.1",
	"seaborn>=0.13.2",
	"opencv-python-headless",
	"h5py",
	"tqdm",
	"jupyterlab>=4.2.6",
	# "jupyterlab",
	"ipykernel",
	"ipywidgets>=8.0.0,<9",
	"icecream>=2.1.4",
	"glfw ; sys_platform != 'linux'",
	"pygfx>=0.15.2",
	"jupyter_rfb>=0.5.1",
	"llvmlite>=0.43.0",
	"mkl_fft>=2.0.0",
	"mbo-fastplotlib>=0.7.3",
	"rendercanvas>=2.4.2,<2.5",
	"imgui-bundle>=1.92.5",
	"pyqt6>=6.7",
	"pyqt6-sip",
	"qtpy",
	"wgpu>=0.28.1,<0.29",
]

[project.scripts]
mbo = "mbo_utilities.cli:main"
pollen = "pollen.pollen_calibration_mbo:main"
docs = "scripts.build_docs:main"
transfer = "mbo_utilities.transfer:main"

[project.urls]
Homepage = "https://github.com/millerbrainobservatory/mbo_utilities"
Documentation = "https://millerbrainobservatory.github.io/mbo_utilities/index.html"
Repository = "https://github.com/millerbrainobservatory/mbo_utilities"
Issues = "https://github.com/MillerBrainObservatory/mbo_utilities/issues"

[project.optional-dependencies]
# Suite2p alone will not include torch
suite2p = [
    "numba>=0.60.0",
    "lbm_suite2p_python>=2.5.3",
    "suite2p_mbo>=2.0.1",
]
# Suite3D - requires CUPY
suite3d = [
    "mbo-suite3d>=0.0.7",
    "cupy-cuda12x",
]
# Rastermap for activity sorting
rastermap = [
    "rastermap",
]
# Napari interactive viewer with plugins
napari = [
    "napari",
    "napari-ome-zarr",
    "napari-animation",
]
# PyTorch for neural network operations
torch = [
    "torch",
    "torchvision",
]
# All processing pipelines
processing = [
    "mbo_utilities[suite2p,suite3d,rastermap,torch]",
]
# Documentation build
docs = [
    "sphinx>=6.1.3",
    "docutils>=0.19",
    "nbsphinx",
    "numpydoc",
    "ipykernel",
    "sphinx-autodoc2",
    "sphinx_tippy",
    "sphinx_gallery",
    "sphinx-togglebutton",
    "sphinx-copybutton",
    "sphinx_book_theme",
    "sphinx_design",
    "sphinxcontrib-images",
    "sphinxcontrib-video",
    "sphinxcontrib-bibtex",
    "jupytext",
    "myst_nb",
    "pygfx>=0.14.0",
]
# Everything
all = ["mbo_utilities[processing,docs]"]

[[tool.uv.index]]
name = "pytorch-cu126"
url = "https://download.pytorch.org/whl/cu126"
explicit = true

[tool.uv.sources]
torch = [
  { index = "pytorch-cu126", marker = "sys_platform == 'linux' or sys_platform == 'win32'" },
]
torchvision = [
  { index = "pytorch-cu126", marker = "sys_platform == 'linux' or sys_platform == 'win32'" },
]

[tool.ruff]
line-length = 88
src = ["mbo_utilities", "pollen"]
extend-exclude = [
    "*.ipynb",
    "docs",
    "demos",
    "scripts",
    "dev",
    "processing",
    "benchmarks",
    "gists",
    "slurm",
]

[tool.ruff.lint]
pydocstyle = { convention = "numpy" }
select = ["ALL"]
ignore = [
# Complexity rules - not useful for scientific code
    "EM101",  # Exception must not use string literal
    "EM102",  # Exception must not use f-string literal
    "TRY003", # Long exception messages
    "I001",
    "C901",   # Too complex
    "PLR0912", # Too many branches
    "PLR0913", # Too many arguments
    "PLR0915", # Too many statements
# Annotation rules - optional
    "ANN",    # All missing type annotation rules (ANN001, ANN201, etc.)
    "D401",   # First line should be in imperative mood (remove to opt in)
    "COM812", # Missing trailing comma (conflicts with ruff format)
    "ISC001", # Import sorting (conflicts with ruff format)
    "FIX002", # Fixable issue
    "DOC201", # TODO enable in follow-up PR; no doc for return type.
    "FBT",    # TODO: enable in follow-up PR; require bool options to be keyword-only.
]

[tool.ruff.lint.per-file-ignores]
"docs/*.py" = ["D"]

[tool.setuptools]
package-dir = {"" = "."}

[tool.setuptools.packages.find]
where = ["."]
include = ["mbo_utilities*", "pollen*"]
exclude = ["dev*", "gists*", "demos*", "assets*", "docs*", "tests*"]

[tool.setuptools.package-data]
mbo_utilities = ["assets/**/*"]

[tool.setuptools.exclude-package-data]
"*" = ["data/*"]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "if TYPE_CHECKING:",
    "@overload",
    "except ImportError",
    "\\.\\.\\.",
    "raise NotImplementedError()"
]

[dependency-groups]
dev = [
    "graphviz>=0.21",
    "pillow>=12.1.0",
    "pyautogui>=0.9.54",
    "pygetwindow>=0.0.9",
    "pytest>=8.4.2",
]
