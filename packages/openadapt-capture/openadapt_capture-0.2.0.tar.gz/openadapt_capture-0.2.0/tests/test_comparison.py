"""Tests for video vs image frame comparison utilities."""

import numpy as np
import pytest
from PIL import Image

from openadapt_capture.comparison import (
    ComparisonReport,
    FrameComparison,
    compare_frames,
    compute_psnr,
)


class TestComputePSNR:
    """Tests for PSNR computation."""

    def test_identical_images_infinite_psnr(self):
        """Test that identical images have infinite PSNR."""
        img = np.random.randint(0, 256, (100, 100, 3), dtype=np.uint8)
        psnr = compute_psnr(img, img.copy())
        assert psnr == float("inf")

    def test_different_images_finite_psnr(self):
        """Test that different images have finite PSNR."""
        img1 = np.zeros((100, 100, 3), dtype=np.uint8)
        img2 = np.full((100, 100, 3), 10, dtype=np.uint8)
        psnr = compute_psnr(img1, img2)
        assert psnr > 0
        assert psnr < float("inf")

    def test_very_different_images_low_psnr(self):
        """Test that very different images have low PSNR."""
        img1 = np.zeros((100, 100, 3), dtype=np.uint8)
        img2 = np.full((100, 100, 3), 255, dtype=np.uint8)
        psnr = compute_psnr(img1, img2)
        # Black vs white should have very low PSNR
        assert psnr < 10


class TestCompareFrames:
    """Tests for frame comparison."""

    def test_identical_frames(self):
        """Test comparison of identical frames."""
        img = Image.new("RGB", (100, 100), color="red")
        result = compare_frames(img, img.copy(), timestamp=1.0)

        assert result.timestamp == 1.0
        assert result.mean_diff == 0.0
        assert result.max_diff == 0.0
        assert result.psnr == float("inf")

    def test_slightly_different_frames(self):
        """Test comparison of slightly different frames."""
        img1 = Image.new("RGB", (100, 100), color=(100, 100, 100))
        img2 = Image.new("RGB", (100, 100), color=(101, 101, 101))

        result = compare_frames(img1, img2, timestamp=2.0)

        assert result.timestamp == 2.0
        assert result.mean_diff == pytest.approx(1.0, abs=0.1)
        assert result.max_diff == pytest.approx(1.0, abs=0.1)
        assert result.psnr > 40  # Very similar, high PSNR

    def test_very_different_frames(self):
        """Test comparison of very different frames."""
        img1 = Image.new("RGB", (100, 100), color="black")
        img2 = Image.new("RGB", (100, 100), color="white")

        result = compare_frames(img1, img2, timestamp=3.0)

        assert result.mean_diff == 255.0  # Maximum difference
        assert result.max_diff == 255.0
        assert result.psnr < 10  # Very different, low PSNR

    def test_compute_diff_image(self):
        """Test that diff image is generated when requested."""
        img1 = Image.new("RGB", (100, 100), color="red")
        img2 = Image.new("RGB", (100, 100), color="blue")

        result = compare_frames(img1, img2, timestamp=1.0, compute_diff_image=True)

        assert result.diff_image is not None
        assert isinstance(result.diff_image, Image.Image)
        assert result.diff_image.size == img1.size

    def test_no_diff_image_by_default(self):
        """Test that diff image is not generated by default."""
        img1 = Image.new("RGB", (100, 100), color="red")
        img2 = Image.new("RGB", (100, 100), color="blue")

        result = compare_frames(img1, img2, timestamp=1.0, compute_diff_image=False)

        assert result.diff_image is None

    def test_different_sizes_resized(self):
        """Test that different sized images are handled."""
        img1 = Image.new("RGB", (100, 100), color="red")
        img2 = Image.new("RGB", (200, 200), color="red")

        # Should not raise, extracted image is resized to match original
        result = compare_frames(img1, img2, timestamp=1.0)
        assert result.mean_diff == 0.0


class TestComparisonReport:
    """Tests for ComparisonReport."""

    def test_empty_report(self):
        """Test empty report statistics."""
        report = ComparisonReport()

        assert report.mean_diff_overall == 0.0
        assert report.max_diff_overall == 0.0
        assert report.mean_psnr == 0.0
        assert report.is_lossless is True  # Empty is lossless by default

    def test_single_comparison(self):
        """Test report with single comparison."""
        report = ComparisonReport(
            comparisons=[
                FrameComparison(
                    timestamp=1.0,
                    mean_diff=0.5,
                    max_diff=2.0,
                    psnr=50.0,
                )
            ]
        )

        assert report.mean_diff_overall == 0.5
        assert report.max_diff_overall == 2.0
        assert report.mean_psnr == 50.0
        assert report.is_lossless is True  # < 1.0 mean diff

    def test_multiple_comparisons(self):
        """Test report with multiple comparisons."""
        report = ComparisonReport(
            comparisons=[
                FrameComparison(timestamp=1.0, mean_diff=0.5, max_diff=2.0, psnr=50.0),
                FrameComparison(timestamp=2.0, mean_diff=1.5, max_diff=5.0, psnr=40.0),
                FrameComparison(timestamp=3.0, mean_diff=1.0, max_diff=3.0, psnr=45.0),
            ]
        )

        assert report.mean_diff_overall == pytest.approx(1.0, abs=0.01)
        assert report.max_diff_overall == 5.0
        assert report.mean_psnr == pytest.approx(45.0, abs=0.01)
        assert report.is_lossless is False  # >= 1.0 mean diff

    def test_summary(self):
        """Test summary generation."""
        report = ComparisonReport(
            comparisons=[
                FrameComparison(timestamp=1.0, mean_diff=0.5, max_diff=2.0, psnr=50.0),
            ]
        )

        summary = report.summary()

        assert summary["num_frames"] == 1
        assert summary["mean_diff"] == 0.5
        assert summary["max_diff"] == 2.0
        assert summary["mean_psnr"] == 50.0
        assert summary["is_lossless"] is True


class TestCompareVideoToImages:
    """Tests for full video-to-image comparison."""

    def test_compare_video_to_images_nonexistent_video(self, tmp_path):
        """Test that nonexistent video raises error."""
        from openadapt_capture.comparison import compare_video_to_images

        img = Image.new("RGB", (100, 100), color="red")
        images = [(1.0, img)]

        with pytest.raises(Exception):  # FileNotFoundError or av error
            compare_video_to_images(tmp_path / "nonexistent.mp4", images)


class TestPlotComparison:
    """Tests for comparison plotting."""

    def test_plot_empty_report(self):
        """Test plotting empty report returns None."""
        pytest.importorskip("matplotlib", exc_type=ImportError)
        from openadapt_capture.comparison import plot_comparison

        report = ComparisonReport()
        result = plot_comparison(report)
        assert result is None

    def test_plot_returns_image(self):
        """Test that plot returns a PIL Image."""
        pytest.importorskip("matplotlib", exc_type=ImportError)
        from openadapt_capture.comparison import plot_comparison

        report = ComparisonReport(
            comparisons=[
                FrameComparison(timestamp=1.0, mean_diff=0.5, max_diff=2.0, psnr=50.0),
                FrameComparison(timestamp=2.0, mean_diff=0.6, max_diff=2.5, psnr=48.0),
            ]
        )

        result = plot_comparison(report)
        assert isinstance(result, Image.Image)

    def test_plot_saves_to_file(self, tmp_path):
        """Test that plot can save to file."""
        pytest.importorskip("matplotlib", exc_type=ImportError)
        from openadapt_capture.comparison import plot_comparison

        report = ComparisonReport(
            comparisons=[
                FrameComparison(timestamp=1.0, mean_diff=0.5, max_diff=2.0, psnr=50.0),
            ]
        )

        output_path = tmp_path / "comparison_plot.png"
        result = plot_comparison(report, output_path=output_path)

        assert result is None
        assert output_path.exists()
