{% extends "base.html" %}

{% block content %}
<div class="space-y-6" x-data="{ activeHost: '{{ common_hosts[0] if common_hosts else '' }}' }">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm">
        <a href="/compare" class="text-midnight-400 hover:text-white transition-colors">Compare</a>
        <svg class="w-4 h-4 text-midnight-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-midnight-300">Results</span>
    </nav>

    <!-- Header -->
    <div class="glass-card glow-border rounded-2xl p-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div class="space-y-2">
                <h1 class="text-2xl font-bold text-white flex items-center gap-3">
                    <svg class="w-6 h-6 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Comparison Results
                </h1>
                <div class="flex items-center gap-4 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="w-5 h-5 rounded-full bg-ocean-500/20 text-ocean-400 flex items-center justify-center text-xs font-bold">A</span>
                        <span class="text-midnight-400">{{ job_a.name or job_a.id[:8] + '...' }}</span>
                        <span class="text-midnight-600 font-mono text-xs" data-utc="{{ job_a.created_at.strftime('%Y-%m-%dT%H:%M:%S') }}">({{ job_a.created_at.strftime('%m/%d %H:%M') }})</span>
                    </div>
                    <svg class="w-4 h-4 text-midnight-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                    <div class="flex items-center gap-2">
                        <span class="w-5 h-5 rounded-full bg-volt-500/20 text-volt-400 flex items-center justify-center text-xs font-bold">B</span>
                        <span class="text-midnight-400">{{ job_b.name or job_b.id[:8] + '...' }}</span>
                        <span class="text-midnight-600 font-mono text-xs" data-utc="{{ job_b.created_at.strftime('%Y-%m-%dT%H:%M:%S') }}">({{ job_b.created_at.strftime('%m/%d %H:%M') }})</span>
                    </div>
                </div>
            </div>
            <a href="/compare" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-midnight-700/50 text-midnight-300 hover:text-white hover:bg-midnight-700 transition-all">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                New Comparison
            </a>
        </div>
    </div>

    {% if not common_hosts %}
    <div class="glass-card rounded-xl p-8 text-center">
        <svg class="w-16 h-16 mx-auto text-crimson-500/50 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3 class="text-xl font-semibold text-midnight-300 mb-2">No Common Hosts</h3>
        <p class="text-midnight-500">These jobs don't have any hosts in common to compare.</p>
    </div>
    {% else %}

    <!-- Global Buffer Pool Overview -->
    <div class="glass-card rounded-2xl overflow-hidden">
        <div class="px-6 py-4 border-b border-midnight-700/50 flex items-center gap-3">
            <svg class="w-5 h-5 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
            </svg>
            <h2 class="text-lg font-semibold text-white">Buffer Pool Overview</h2>
            <span class="text-xs text-midnight-500">All hosts at a glance</span>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-midnight-700/50 bg-midnight-800/30">
                        <th class="px-4 py-3 text-left text-xs font-semibold text-midnight-400 uppercase tracking-wider">Host</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-midnight-400 uppercase tracking-wider">Pool Size</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-midnight-400 uppercase tracking-wider" colspan="2">
                            Used
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-midnight-400 uppercase tracking-wider" colspan="2">
                            Hit Ratio
                        </th>
                    </tr>
                    <tr class="border-b border-midnight-700/30 bg-midnight-800/20 text-[10px]">
                        <th></th>
                        <th></th>
                        <th class="px-2 py-1.5 text-center text-midnight-500 font-medium">Job A</th>
                        <th class="px-2 py-1.5 text-center text-midnight-500 font-medium">Job B</th>
                        <th class="px-2 py-1.5 text-center text-midnight-500 font-medium">Job A</th>
                        <th class="px-2 py-1.5 text-center text-midnight-500 font-medium">Job B</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-midnight-800/50">
                    {% for host_id in common_hosts %}
                    {% set bp = comparisons[host_id].buffer_pool %}
                    {% set hr = bp.hit_ratio if bp else none %}
                    {% set pool_size = bp.pool_size_gb if bp else none %}
                    {% set used = bp.used_gb if bp else none %}
                    {% set used_pct = bp.used_percent if bp else none %}
                    <tr class="hover:bg-midnight-800/30 transition-colors
                        {% if hr and hr.direction == 'regression' %}bg-crimson-500/5{% endif %}">
                        <td class="px-4 py-3">
                            <button @click="activeHost = '{{ host_id }}'" 
                                    class="text-ocean-400 hover:text-ocean-300 font-medium text-left">
                                {{ host_labels.get(host_id, host_id) }}
                            </button>
                        </td>
                        <!-- Pool Size with change indicator -->
                        <td class="px-4 py-3 text-right">
                            {% if pool_size %}
                                {% if pool_size.delta != 0 %}
                                <div class="flex items-center justify-end gap-2">
                                    <span class="font-mono text-midnight-500 text-xs">{{ pool_size.value_a }}</span>
                                    <svg class="w-3 h-3 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                                    </svg>
                                    <span class="font-mono text-white">{{ pool_size.value_b }} GB</span>
                                    <span class="text-xs px-1.5 py-0.5 rounded {% if pool_size.delta > 0 %}bg-volt-500/20 text-volt-400{% else %}bg-crimson-500/20 text-crimson-400{% endif %}">
                                        {{ '+' if pool_size.delta > 0 else '' }}{{ pool_size.delta }}
                                    </span>
                                </div>
                                {% else %}
                                <span class="font-mono text-midnight-300">{{ pool_size.value_b }} GB</span>
                                {% endif %}
                            {% else %}‚Äî{% endif %}
                        </td>
                        <!-- Used Job A -->
                        <td class="px-2 py-3 text-center">
                            {% if used %}
                            <span class="font-mono text-midnight-400">{{ used.value_a }} GB</span>
                            <span class="text-midnight-600 text-xs ml-0.5">({{ used_pct.value_a if used_pct else '?' }}%)</span>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <!-- Used Job B with arrow -->
                        <td class="px-2 py-3 text-center">
                            {% if used %}
                            <span class="font-mono text-white">{{ used.value_b }} GB</span>
                            <span class="text-midnight-500 text-xs ml-0.5">({{ used_pct.value_b if used_pct else '?' }}%)</span>
                            {% if used.delta > 0.1 %}
                            <span class="text-amber-400 ml-1 text-xs">‚Üë</span>
                            {% elif used.delta < -0.1 %}
                            <span class="text-volt-400 ml-1 text-xs">‚Üì</span>
                            {% endif %}
                            {% else %}‚Äî{% endif %}
                        </td>
                        <!-- Hit Ratio Job A -->
                        <td class="px-2 py-3 text-center font-mono text-midnight-400">
                            {% if hr %}{{ hr.value_a }}%{% else %}‚Äî{% endif %}
                        </td>
                        <!-- Hit Ratio Job B with arrow -->
                        <td class="px-2 py-3 text-center font-mono font-medium
                            {% if hr %}
                                {% if hr.value_b >= 99 %}text-volt-400{% elif hr.value_b >= 95 %}text-amber-400{% else %}text-crimson-400{% endif %}
                            {% else %}text-midnight-500{% endif %}">
                            {% if hr %}
                            {{ hr.value_b }}%
                            {% if hr.delta > 0.05 %}
                            <span class="text-volt-400 ml-1">‚Üë</span>
                            {% elif hr.delta < -0.05 %}
                            <span class="text-crimson-400 ml-1">‚Üì</span>
                            {% endif %}
                            {% else %}‚Äî{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Regression Summary -->
    <div class="glass-card rounded-2xl p-6" x-data="{ showSuppressed: false }">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                <svg class="w-5 h-5 text-crimson-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                Regression Summary
                {% if visible_regressions %}
                <span class="text-xs px-2 py-0.5 rounded-full bg-crimson-500/20 text-crimson-400">{{ visible_regressions|length }}</span>
                {% endif %}
            </h2>
            {% if suppressed_regressions %}
            <label class="flex items-center gap-2 text-sm text-midnight-400 cursor-pointer hover:text-midnight-300 transition-colors">
                <input type="checkbox" x-model="showSuppressed" class="rounded border-midnight-600 bg-midnight-800 text-ocean-500 focus:ring-ocean-500 focus:ring-offset-midnight-900">
                <span>Show suppressed issues ({{ suppressed_regressions|length }})</span>
            </label>
            {% endif %}
        </div>
        
        {% if visible_regressions %}
        <!-- Visible Regressions -->
        <div class="space-y-2">
            {% for reg in visible_regressions %}
            <div class="flex items-center gap-3 p-3 rounded-lg {% if reg.severity == 'critical' %}bg-crimson-500/10 border border-crimson-500/20{% else %}bg-amber-500/10 border border-amber-500/20{% endif %}">
                <span class="text-xl">{% if reg.severity == 'critical' %}üî¥{% else %}üü°{% endif %}</span>
                <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="font-medium {% if reg.severity == 'critical' %}text-crimson-300{% else %}text-amber-300{% endif %}">{{ reg.message }}</span>
                        <span class="text-xs px-2 py-0.5 rounded-full bg-midnight-700 text-midnight-400">{{ reg.host_label }}</span>
                        {% if reg.suppression_reason and 'Downgraded' in reg.suppression_reason %}
                        <span class="text-xs px-2 py-0.5 rounded-full bg-midnight-700/50 text-midnight-500" title="{{ reg.suppression_reason }}">‚Üì downgraded</span>
                        {% endif %}
                    </div>
                    <div class="text-xs text-midnight-500 mt-0.5">
                        Metric: <span class="font-mono">{{ reg.metric }}</span>
                    </div>
                </div>
                <button @click="activeHost = '{{ reg.host_id }}'" 
                        class="text-xs px-3 py-1.5 rounded-lg bg-midnight-700/50 text-midnight-400 hover:text-white hover:bg-midnight-700 transition-all whitespace-nowrap">
                    View Details ‚Üí
                </button>
            </div>
            {% endfor %}
        </div>
        
        <!-- Suppressed Regressions (hidden by default) -->
        {% if suppressed_regressions %}
        <div x-show="showSuppressed" x-cloak class="mt-4 pt-4 border-t border-midnight-700/50">
            <div class="text-xs text-midnight-500 uppercase tracking-wider mb-2 flex items-center gap-2">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                </svg>
                Suppressed Issues
            </div>
            <div class="space-y-2">
                {% for reg in suppressed_regressions %}
                <div class="flex items-center gap-3 p-2 rounded-lg bg-midnight-800/30 border border-midnight-700/30 opacity-60">
                    <span class="text-base text-midnight-500">{% if reg.original_severity == 'critical' %}üî¥{% else %}üü°{% endif %}</span>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="text-sm text-midnight-500">{{ reg.message }}</span>
                            <span class="text-xs px-1.5 py-0.5 rounded bg-midnight-700/50 text-midnight-600">{{ reg.host_label }}</span>
                        </div>
                        <div class="text-xs text-midnight-600 mt-0.5 flex items-center gap-2">
                            <span class="font-mono">{{ reg.metric }}</span>
                            <span class="text-midnight-700">‚Ä¢</span>
                            <span class="italic" title="{{ reg.suppression_reason }}">{{ reg.suppression_reason }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% elif not suppressed_regressions %}
        <!-- No regressions at all -->
        <div class="flex items-center gap-3 p-4 rounded-lg bg-volt-500/10 border border-volt-500/20">
            <span class="text-2xl">‚úÖ</span>
            <div>
                <div class="font-medium text-volt-300">No Regressions Detected</div>
                <div class="text-xs text-midnight-500 mt-0.5">All metrics look stable between these two jobs</div>
            </div>
        </div>
        {% else %}
        <!-- All regressions suppressed -->
        <div class="flex items-center gap-3 p-4 rounded-lg bg-volt-500/10 border border-volt-500/20">
            <span class="text-2xl">‚úÖ</span>
            <div>
                <div class="font-medium text-volt-300">No Significant Regressions</div>
                <div class="text-xs text-midnight-500 mt-0.5">{{ suppressed_regressions|length }} low-signal issue(s) suppressed</div>
            </div>
        </div>
        
        <!-- Show suppressed even when no visible -->
        <div x-show="showSuppressed" x-cloak class="mt-4 pt-4 border-t border-midnight-700/50">
            <div class="text-xs text-midnight-500 uppercase tracking-wider mb-2">Suppressed Issues</div>
            <div class="space-y-2">
                {% for reg in suppressed_regressions %}
                <div class="flex items-center gap-3 p-2 rounded-lg bg-midnight-800/30 border border-midnight-700/30 opacity-60">
                    <span class="text-base text-midnight-500">{% if reg.original_severity == 'critical' %}üî¥{% else %}üü°{% endif %}</span>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="text-sm text-midnight-500">{{ reg.message }}</span>
                            <span class="text-xs px-1.5 py-0.5 rounded bg-midnight-700/50 text-midnight-600">{{ reg.host_label }}</span>
                        </div>
                        <div class="text-xs text-midnight-600 mt-0.5">
                            <span class="font-mono">{{ reg.metric }}</span> ‚Ä¢ <span class="italic">{{ reg.suppression_reason }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Host Tabs -->
    <div class="glass-card rounded-2xl overflow-hidden">
        <div class="border-b border-midnight-700/50 bg-midnight-800/30">
            <nav class="flex overflow-x-auto">
                {% for host_id in common_hosts %}
                <button @click="activeHost = '{{ host_id }}'"
                        :class="activeHost === '{{ host_id }}' ? 'border-ocean-500 text-ocean-400 bg-midnight-800/50' : 'border-transparent text-midnight-400 hover:text-white hover:bg-midnight-800/30'"
                        class="flex items-center gap-2 px-6 py-4 text-sm font-medium border-b-2 transition-colors whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2" />
                    </svg>
                    {{ host_labels.get(host_id, host_id) }}
                </button>
                {% endfor %}
            </nav>
        </div>

        <!-- Host Comparison Content -->
        {% for host_id in common_hosts %}
        <div x-show="activeHost === '{{ host_id }}'" x-cloak class="p-6 space-y-8">
            
            <!-- Global Status Diff -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Global Status (Numeric Diff)
                </h3>
                {% set status_diff = comparisons[host_id].global_status %}
                {% if status_diff %}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-midnight-700/50">
                                <th class="px-4 py-3 text-left text-xs font-semibold text-midnight-400 uppercase">Metric</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-midnight-400 uppercase" title="{{ job_a.id }}">Job A{% if job_a.name %}: {{ job_a.name }}{% endif %}</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-midnight-400 uppercase" title="{{ job_b.id }}">Job B{% if job_b.name %}: {{ job_b.name }}{% endif %}</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-midnight-400 uppercase">Delta</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-midnight-800/50">
                            {% for row in status_diff %}
                            <tr class="hover:bg-midnight-800/30">
                                <td class="px-4 py-3 font-mono text-midnight-300">{{ row.metric }}</td>
                                <td class="px-4 py-3 text-right font-mono text-midnight-400">{{ "{:,}".format(row.value_a) }}</td>
                                <td class="px-4 py-3 text-right font-mono text-midnight-400">{{ "{:,}".format(row.value_b) }}</td>
                                <td class="px-4 py-3 text-right font-mono font-medium
                                    {% if row.direction == 'increase' %}text-crimson-400{% elif row.direction == 'decrease' %}text-volt-400{% else %}text-midnight-500{% endif %}">
                                    {% if row.delta > 0 %}+{% endif %}{{ "{:,}".format(row.delta) }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-midnight-500 text-sm">No global status data available for comparison.</p>
                {% endif %}
            </div>

            <!-- Processlist Summary Diff -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-volt-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                    Processlist Summary
                </h3>
                {% set pl_diff = comparisons[host_id].processlist %}
                {% if pl_diff %}
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {% for key, data in pl_diff.items() %}
                    <div class="bg-midnight-800/30 rounded-xl p-4">
                        <div class="text-xs text-midnight-500 uppercase mb-1">
                            {% if key == 'total' %}Total Queries
                            {% elif key == 'long_running' %}Time > 10s
                            {% elif key == 'with_state' %}With State
                            {% elif key == 'distinct_users' %}Distinct Users
                            {% endif %}
                        </div>
                        <div class="flex items-baseline gap-2">
                            <span class="text-2xl font-bold text-white">{{ data.value_b }}</span>
                            <span class="text-sm font-mono
                                {% if data.direction == 'increase' %}text-crimson-400{% elif data.direction == 'decrease' %}text-volt-400{% else %}text-midnight-500{% endif %}">
                                {% if data.delta > 0 %}+{% endif %}{{ data.delta }}
                            </span>
                        </div>
                        <div class="text-xs text-midnight-600 mt-1">Job A{% if job_a.name %} ({{ job_a.name }}){% endif %}: {{ data.value_a }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-midnight-500 text-sm">No processlist data available for comparison.</p>
                {% endif %}
            </div>

            <!-- Buffer Pool Comparison -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                    </svg>
                    Buffer Pool
                </h3>
                {% set bp_diff = comparisons[host_id].buffer_pool %}
                {% if bp_diff %}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-midnight-700/50">
                                <th class="px-4 py-3 text-left text-xs font-semibold text-midnight-400 uppercase">Metric</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-midnight-400 uppercase">Job A</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-midnight-400 uppercase">Job B</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-midnight-400 uppercase">Change</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-midnight-800/50">
                            {% if bp_diff.pool_size_gb %}
                            <tr class="hover:bg-midnight-800/30">
                                <td class="px-4 py-3 text-midnight-300">Pool Size</td>
                                <td class="px-4 py-3 text-right font-mono text-midnight-400">{{ bp_diff.pool_size_gb.value_a }} GB</td>
                                <td class="px-4 py-3 text-right font-mono text-white">{{ bp_diff.pool_size_gb.value_b }} GB</td>
                                <td class="px-4 py-3 text-right font-mono text-midnight-500">
                                    {% if bp_diff.pool_size_gb.delta != 0 %}{{ '+' if bp_diff.pool_size_gb.delta > 0 else '' }}{{ bp_diff.pool_size_gb.delta }} GB{% else %}‚Äî{% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% if bp_diff.used_percent %}
                            <tr class="hover:bg-midnight-800/30">
                                <td class="px-4 py-3 text-midnight-300">Utilization</td>
                                <td class="px-4 py-3 text-right font-mono text-midnight-400">{{ bp_diff.used_percent.value_a }}%</td>
                                <td class="px-4 py-3 text-right font-mono text-white">{{ bp_diff.used_percent.value_b }}%</td>
                                <td class="px-4 py-3 text-right font-mono text-midnight-500">
                                    {% if bp_diff.used_percent.delta != 0 %}{{ '+' if bp_diff.used_percent.delta > 0 else '' }}{{ bp_diff.used_percent.delta }}%{% else %}‚Äî{% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% if bp_diff.hit_ratio %}
                            <tr class="hover:bg-midnight-800/30 {% if bp_diff.hit_ratio.direction == 'regression' %}bg-crimson-500/5{% elif bp_diff.hit_ratio.direction == 'improvement' %}bg-volt-500/5{% endif %}">
                                <td class="px-4 py-3 text-midnight-300 font-medium">
                                    Hit Ratio
                                    <span class="text-xs text-midnight-500 ml-1">(higher = better)</span>
                                </td>
                                <td class="px-4 py-3 text-right font-mono text-midnight-400">{{ bp_diff.hit_ratio.value_a }}%</td>
                                <td class="px-4 py-3 text-right font-mono font-medium
                                    {% if bp_diff.hit_ratio.value_b >= 99 %}text-volt-400{% elif bp_diff.hit_ratio.value_b >= 95 %}text-amber-400{% else %}text-crimson-400{% endif %}">
                                    {{ bp_diff.hit_ratio.value_b }}%
                                </td>
                                <td class="px-4 py-3 text-right font-mono font-medium
                                    {% if bp_diff.hit_ratio.direction == 'regression' %}text-crimson-400{% elif bp_diff.hit_ratio.direction == 'improvement' %}text-volt-400{% else %}text-midnight-500{% endif %}">
                                    {% if bp_diff.hit_ratio.delta != 0 %}
                                        {{ '+' if bp_diff.hit_ratio.delta > 0 else '' }}{{ bp_diff.hit_ratio.delta }}%
                                        {% if bp_diff.hit_ratio.direction == 'regression' %}‚Üì{% elif bp_diff.hit_ratio.direction == 'improvement' %}‚Üë{% endif %}
                                    {% else %}‚Äî{% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% if bp_diff.dirty_percent %}
                            <tr class="hover:bg-midnight-800/30">
                                <td class="px-4 py-3 text-midnight-300">
                                    Dirty Pages
                                    <span class="text-xs text-midnight-500 ml-1">(lower = better)</span>
                                </td>
                                <td class="px-4 py-3 text-right font-mono text-midnight-400">{{ bp_diff.dirty_percent.value_a }}%</td>
                                <td class="px-4 py-3 text-right font-mono text-white">{{ bp_diff.dirty_percent.value_b }}%</td>
                                <td class="px-4 py-3 text-right font-mono
                                    {% if bp_diff.dirty_percent.direction == 'regression' %}text-crimson-400{% elif bp_diff.dirty_percent.direction == 'improvement' %}text-volt-400{% else %}text-midnight-500{% endif %}">
                                    {% if bp_diff.dirty_percent.delta != 0 %}{{ '+' if bp_diff.dirty_percent.delta > 0 else '' }}{{ bp_diff.dirty_percent.delta }}%{% else %}‚Äî{% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% if bp_diff.health %}
                            <tr class="hover:bg-midnight-800/30 {% if bp_diff.health.changed %}bg-amber-500/5{% endif %}">
                                <td class="px-4 py-3 text-midnight-300">Health Status</td>
                                <td class="px-4 py-3 text-right">
                                    <span class="px-2 py-0.5 rounded text-xs font-medium
                                        {% if bp_diff.health.value_a == 'healthy' %}bg-volt-500/20 text-volt-400
                                        {% elif bp_diff.health.value_a == 'warning' %}bg-amber-500/20 text-amber-400
                                        {% elif bp_diff.health.value_a == 'critical' %}bg-crimson-500/20 text-crimson-400
                                        {% else %}bg-midnight-700 text-midnight-400{% endif %}">
                                        {{ bp_diff.health.value_a | capitalize }}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <span class="px-2 py-0.5 rounded text-xs font-medium
                                        {% if bp_diff.health.value_b == 'healthy' %}bg-volt-500/20 text-volt-400
                                        {% elif bp_diff.health.value_b == 'warning' %}bg-amber-500/20 text-amber-400
                                        {% elif bp_diff.health.value_b == 'critical' %}bg-crimson-500/20 text-crimson-400
                                        {% else %}bg-midnight-700 text-midnight-400{% endif %}">
                                        {{ bp_diff.health.value_b | capitalize }}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-right text-xs">
                                    {% if bp_diff.health.changed %}
                                    <span class="text-amber-400">Changed</span>
                                    {% else %}
                                    <span class="text-midnight-500">‚Äî</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-midnight-500 text-sm">No buffer pool data available for comparison.</p>
                {% endif %}
            </div>

            <!-- Config Diff -->
            <div class="space-y-4" x-data="{ showOnlyChanged: true }">
                {% set config_diff = comparisons[host_id].config %}
                {% set changed_count = config_diff|selectattr('changed')|list|length if config_diff else 0 %}
                <div class="flex items-center justify-between flex-wrap gap-2">
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <svg class="w-5 h-5 text-crimson-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Config Variables
                        {% if config_diff %}
                        {% if changed_count > 0 %}
                        <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-crimson-500/20 text-crimson-400">{{ changed_count }} changed</span>
                        {% else %}
                        <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-volt-500/20 text-volt-400">No changes</span>
                        {% endif %}
                        {% endif %}
                    </h3>
                    {% if config_diff and changed_count > 0 %}
                    <div class="flex items-center gap-2">
                        <button @click="showOnlyChanged = true" 
                                :class="showOnlyChanged ? 'bg-crimson-500/20 text-crimson-300 border-crimson-500/50' : 'bg-midnight-700/50 text-midnight-400 border-midnight-600 hover:text-white'"
                                class="px-3 py-1.5 text-xs font-medium rounded-lg border transition-all">
                            Changed Only ({{ changed_count }})
                        </button>
                        <button @click="showOnlyChanged = false"
                                :class="!showOnlyChanged ? 'bg-ocean-500/20 text-ocean-300 border-ocean-500/50' : 'bg-midnight-700/50 text-midnight-400 border-midnight-600 hover:text-white'"
                                class="px-3 py-1.5 text-xs font-medium rounded-lg border transition-all">
                            Show All ({{ config_diff|length }})
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% if config_diff %}
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-midnight-900">
                            <tr class="border-b border-midnight-700/50">
                                <th class="px-4 py-3 text-left text-xs font-semibold text-midnight-400 uppercase">Variable</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-midnight-400 uppercase" title="{{ job_a.id }}">Job A{% if job_a.name %}: {{ job_a.name }}{% endif %}</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-midnight-400 uppercase" title="{{ job_b.id }}">Job B{% if job_b.name %}: {{ job_b.name }}{% endif %}</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-midnight-800/50">
                            {% for row in config_diff %}
                            <tr class="{% if row.changed %}bg-crimson-500/5{% endif %} hover:bg-midnight-800/30"
                                x-show="!showOnlyChanged || {{ 'true' if row.changed else 'false' }}">
                                <td class="px-4 py-2 font-mono text-midnight-300 {% if row.changed %}text-crimson-300{% endif %}">
                                    {% if row.changed %}<span class="text-crimson-400 mr-1">‚óè</span>{% endif %}
                                    {{ row.variable }}
                                </td>
                                <td class="px-4 py-2 font-mono text-xs text-midnight-400 max-w-[200px] truncate" title="{{ row.value_a }}">{{ row.value_a }}</td>
                                <td class="px-4 py-2 font-mono text-xs {% if row.changed %}text-crimson-300{% else %}text-midnight-400{% endif %} max-w-[200px] truncate" title="{{ row.value_b }}">{{ row.value_b }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-midnight-500 text-sm">No config data available for comparison.</p>
                {% endif %}
            </div>

            <!-- InnoDB Text Diff -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                    </svg>
                    InnoDB Status (Text Diff)
                </h3>
                {% set innodb_diff = comparisons[host_id].innodb %}
                {% if innodb_diff %}
                <div class="code-block rounded-xl p-4 max-h-96 overflow-auto font-mono text-xs">
                    {% for line in innodb_diff %}
                    <div class="{% if line.type == 'added' %}bg-volt-500/10 text-volt-400{% elif line.type == 'removed' %}bg-crimson-500/10 text-crimson-400{% elif line.type == 'header' %}text-ocean-400 font-bold{% else %}text-midnight-500{% endif %} px-2 py-0.5 whitespace-pre">{% if line.type == 'added' %}+{% elif line.type == 'removed' %}-{% else %} {% endif %}{{ line.line }}</div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-midnight-500 text-sm">No InnoDB status data available for comparison.</p>
                {% endif %}
            </div>

        </div>
        {% endfor %}
    </div>

    <!-- Legend -->
    <div class="glass-card rounded-xl p-4">
        <div class="flex flex-wrap items-center justify-center gap-6 text-xs">
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-volt-500"></span>
                <span class="text-midnight-400">Decrease (improvement)</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-crimson-500"></span>
                <span class="text-midnight-400">Increase (regression)</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-midnight-600"></span>
                <span class="text-midnight-400">No change</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

