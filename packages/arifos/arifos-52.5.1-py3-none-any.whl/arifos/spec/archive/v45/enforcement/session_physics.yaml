# ═══════════════════════════════════════════════════════════════════════════
# arifOS v45.0 - Session Physics Specification (L2 GOVERNANCE)
# ═══════════════════════════════════════════════════════════════════════════
#
# SOURCE: spec/v45/session_physics.json (Track B Authority)
# PURPOSE: TEARFRAME thresholds - Budget, burst, streak governance
# LICENSE: Apache-2.0
# VERSION: v45.0
# CANON: L1_THEORY/canon/03_runtime/03_SESSION_PHYSICS_v45.md
#
# SESSION PHYSICS: Physics > Semantics - Hard limits on session behavior
# These thresholds override semantic judgment when violated.
#
# ═══════════════════════════════════════════════════════════════════════════

meta:
  version: "v45.0"
  arifos_version: "v45.0"
  authority: "Track B (tunable thresholds) governed by Track A canon"
  locked: true
  status: "AUTHORITATIVE"
  source: "spec/v45/session_physics.json"
  canonical_source: "L1_THEORY/canon/03_runtime/03_SESSION_PHYSICS_v45.md"
  spec_type: "session_physics"
  description: "TEARFRAME thresholds for session-level governance (budget, burst, streak)"
  note: "Physics floors override semantic floors. Hard limits on AI behavior regardless of content quality."

# =============================================================================
# TEARFRAME: 9 SESSION ATTRIBUTES
# =============================================================================

tearframe_attributes:
  # ---------------------------------------------------------------------------
  # T: TURN RATE (Interaction velocity)
  # ---------------------------------------------------------------------------
  turn_rate:
    id: 1
    symbol: "T"
    display: "Turn Rate"
    unit: "turns/minute"
    description: "Interaction velocity - how fast user is asking questions"

    thresholds:
      normal: [0, 10]  # 0-10 turns/min = calm conversation
      elevated: [10, 30]  # 10-30 turns/min = fast but acceptable
      burst: [30, 1000]  # >30 turns/min = burst detected → 888_HOLD

    enforcement:
      if_burst: "888_HOLD (burst detected, escalate to human)"
      reason: "Rapid-fire queries may indicate automation or distress"

    floor_mapping:
      - "F3 (Burst Detection)"

    formula: "turns_in_window / window_duration_minutes"
    window_size: 60  # seconds

  # ---------------------------------------------------------------------------
  # E: ENTROPY (Variance in thinking time)
  # ---------------------------------------------------------------------------
  entropy:
    id: 2
    symbol: "E"
    display: "Entropy (Time Variance)"
    unit: "dimensionless (0-1)"
    description: "Variance in inter-turn time (ΔT variance)"

    thresholds:
      low_variance: [0, 0.05]  # <0.05 = robotic/scripted → SABAR
      natural: [0.05, 0.8]  # 0.05-0.8 = human-like variation
      chaos: [0.8, 1.0]  # >0.8 = erratic (acceptable but watch)

    enforcement:
      if_low_variance: "SABAR (possible automation, verify human presence)"
      if_chaos: "WARN (erratic behavior, monitor)"

    floor_mapping:
      - "F3 (Burst Detection - robotic patterns)"

    formula: "variance(delta_t_between_turns)"
    note: "Low variance (robotic) triggers SABAR. High variance (chaos) is acceptable but logged."

  # ---------------------------------------------------------------------------
  # A: ALLOCATED BUDGET (Computational resources)
  # ---------------------------------------------------------------------------
  allocated_budget:
    id: 3
    symbol: "A"
    display: "Allocated Budget"
    unit: "tokens or $ cost"
    description: "Computational budget allocated for this session"

    thresholds:
      warn: 0.80  # 80% of budget → WARN
      hard: 1.00  # 100% of budget → VOID

    enforcement:
      at_warn: "PARTIAL (80% budget used, approaching limit)"
      at_hard: "VOID (budget exhausted, session cannot continue)"

    floor_mapping:
      - "F1 (Amanah - resource integrity)"

    formula: "tokens_used / tokens_allocated"
    note: "Budget is HARD floor. Exceeding 100% triggers instant VOID."

  # ---------------------------------------------------------------------------
  # R: RUNTIME (Session duration)
  # ---------------------------------------------------------------------------
  runtime:
    id: 4
    symbol: "R"
    display: "Runtime"
    unit: "seconds"
    description: "Total session duration since VOID(000) initialization"

    thresholds:
      short: [0, 300]  # 0-5 min
      normal: [300, 3600]  # 5-60 min
      long: [3600, 7200]  # 1-2 hours
      extended: [7200, 999999]  # >2 hours → WARN (fatigue risk)

    enforcement:
      if_extended: "WARN (long session, consider break for human)"

    floor_mapping:
      - "F6 (κᵣ - care for user wellbeing)"

    formula: "current_time - session_start_time"

  # ---------------------------------------------------------------------------
  # F: FAILURE STREAK (Consecutive VOID/SABAR verdicts)
  # ---------------------------------------------------------------------------
  failure_streak:
    id: 5
    symbol: "F"
    display: "Failure Streak"
    unit: "count"
    description: "Consecutive VOID or SABAR verdicts without SEAL"

    thresholds:
      max: 3  # 3 consecutive failures → 888_HOLD

    enforcement:
      at_max: "888_HOLD (3 consecutive failures, escalate to human judgment)"
      reason: "System cannot satisfy user safely - human intervention required"

    floor_mapping:
      - "F7 (Ω₀ - humility, acknowledging limitations)"

    formula: "count(consecutive VOID or SABAR verdicts)"
    reset_on: "SEAL verdict"
    note: "Prevents endless retry loops. 3 failures → escalate."

  # ---------------------------------------------------------------------------
  # R: RETRY COUNT (Total retries in session)
  # ---------------------------------------------------------------------------
  retry_count:
    id: 6
    symbol: "R"
    display: "Retry Count"
    unit: "count"
    description: "Total number of retries/regenerations requested"

    thresholds:
      normal: [0, 5]
      elevated: [5, 10]
      excessive: [10, 999]  # >10 retries → WARN

    enforcement:
      if_excessive: "WARN (many retries, user may be frustrated)"

    floor_mapping:
      - "F6 (κᵣ - care for user frustration)"

    note: "High retry count indicates user dissatisfaction. Monitor closely."

  # ---------------------------------------------------------------------------
  # A: ALIGNMENT SCORE (Semantic floor average)
  # ---------------------------------------------------------------------------
  alignment_score:
    id: 7
    symbol: "A"
    display: "Alignment Score"
    unit: "0.0-1.0"
    description: "Running average of semantic floor compliance (F1-F9)"

    thresholds:
      poor: [0.0, 0.5]  # <0.5 = poor alignment
      marginal: [0.5, 0.8]  # 0.5-0.8 = marginal
      good: [0.8, 1.0]  # >0.8 = good alignment

    enforcement:
      if_poor: "SABAR (poor alignment, review session context)"

    floor_mapping:
      - "All semantic floors (F1-F9)"

    formula: "average(all_floor_scores_in_session)"

  # ---------------------------------------------------------------------------
  # M: MEMORY PRESSURE (Memory band utilization)
  # ---------------------------------------------------------------------------
  memory_pressure:
    id: 8
    symbol: "M"
    display: "Memory Pressure"
    unit: "0.0-1.0"
    description: "Utilization of memory bands (LEDGER, ACTIVE, PHOENIX)"

    thresholds:
      low: [0.0, 0.5]
      moderate: [0.5, 0.8]
      high: [0.8, 1.0]  # >0.8 = high pressure → WARN

    enforcement:
      if_high: "WARN (memory bands near capacity, consider archiving)"

    floor_mapping:
      - "F1 (Amanah - resource management)"

    formula: "sum(band_sizes) / total_memory_limit"

  # ---------------------------------------------------------------------------
  # E: ESCALATION FLAG (Human intervention requested)
  # ---------------------------------------------------------------------------
  escalation_flag:
    id: 9
    symbol: "E"
    display: "Escalation Flag"
    unit: "boolean"
    description: "Whether human intervention has been requested (888_HOLD triggered)"

    values: [false, true]

    enforcement:
      if_true: "888_HOLD (awaiting human judgment)"

    floor_mapping:
      - "All floors (meta-governance)"

# =============================================================================
# PHYSICS FLOORS (3 Hard Limits)
# =============================================================================

physics_floors:
  # ---------------------------------------------------------------------------
  # F1_BUDGET: Resource Integrity
  # ---------------------------------------------------------------------------
  F1_budget:
    floor: "F1 (Amanah)"
    type: "physics (hard)"
    attribute: "allocated_budget"

    thresholds:
      warn: 0.80  # 80% → PARTIAL
      hard: 1.00  # 100% → VOID

    enforcement:
      warn_action: "PARTIAL (budget warning at 80%)"
      hard_action: "VOID (budget exhausted at 100%)"
      bypass_semantic: true
      priority: "NUCLEAR"

    reason: "Computational budget is a hard constraint. Cannot generate output beyond allocated resources."

    verdict_mapping:
      "budget >= 1.00": "VOID (budget exhausted)"
      "0.80 <= budget < 1.00": "PARTIAL (budget warning)"
      "budget < 0.80": "Continue (budget OK)"

  # ---------------------------------------------------------------------------
  # F3_BURST: Anti-Automation
  # ---------------------------------------------------------------------------
  F3_burst:
    floor: "F3 (Tri-Witness)"
    type: "physics (hard)"
    attributes:
      - "turn_rate"
      - "entropy"

    thresholds:
      turn_rate_burst: 30  # >30 turns/min
      entropy_robotic: 0.05  # <0.05 variance

    enforcement:
      turn_rate_action: "888_HOLD (burst detected, verify human)"
      entropy_action: "SABAR (robotic pattern, verify human)"
      bypass_semantic: true
      priority: "HIGH"

    reason: "Burst or robotic patterns may indicate automation. Human verification required."

    verdict_mapping:
      "turn_rate > 30": "888_HOLD (burst detected)"
      "entropy < 0.05": "SABAR (robotic pattern)"
      "else": "Continue (normal interaction)"

  # ---------------------------------------------------------------------------
  # F7_STREAK: Humility Floor
  # ---------------------------------------------------------------------------
  F7_streak:
    floor: "F7 (Ω₀ Humility)"
    type: "physics (hard)"
    attribute: "failure_streak"

    thresholds:
      max: 3  # 3 consecutive failures

    enforcement:
      max_action: "888_HOLD (3 consecutive failures, escalate)"
      bypass_semantic: true
      priority: "HIGH"

    reason: "System cannot satisfy user safely after 3 failures. Human intervention required (humility)."

    verdict_mapping:
      "failure_streak >= 3": "888_HOLD (escalate to human)"
      "failure_streak < 3": "Continue (retry acceptable)"

# =============================================================================
# OVERRIDE HIERARCHY
# =============================================================================

override_hierarchy:
  principle: "Physics > Semantics"

  rules:
    - "Physics floor violation overrides semantic SEAL verdict"
    - "Budget exhausted (F1_budget) → VOID even if semantic floors pass"
    - "Burst detected (F3_burst) → 888_HOLD even if content is safe"
    - "Failure streak (F7_streak) → 888_HOLD even if user requests retry"

  examples:
    budget_override:
      scenario: "User asks valid question but budget is at 100%"
      semantic_verdict: "SEAL (all semantic floors pass)"
      physics_verdict: "VOID (F1_budget exhausted)"
      final_verdict: "VOID (physics overrides semantics)"

    burst_override:
      scenario: "User asks 50 questions in 1 minute"
      semantic_verdict: "SEAL (all questions valid)"
      physics_verdict: "888_HOLD (F3_burst detected)"
      final_verdict: "888_HOLD (physics overrides semantics)"

    streak_override:
      scenario: "User's 4th retry after 3 VOID verdicts"
      semantic_verdict: "PARTIAL (marginal compliance)"
      physics_verdict: "888_HOLD (F7_streak >= 3)"
      final_verdict: "888_HOLD (physics overrides semantics)"

# =============================================================================
# SESSION LIFECYCLE
# =============================================================================

session_lifecycle:
  stages:
    000_VOID:
      action: "Initialize session"
      tearframe_reset:
        - "turn_rate = 0"
        - "runtime = 0"
        - "failure_streak = 0"
        - "retry_count = 0"
        - "allocated_budget set by user/system"

    111_888_999:
      action: "Update TEARFRAME at each stage"
      updates:
        - "Increment turn_rate counter"
        - "Update runtime"
        - "Update failure_streak if VOID/SABAR"
        - "Track budget_used"

    999_SEAL:
      action: "Finalize session"
      logging:
        - "Write TEARFRAME snapshot to LEDGER"
        - "Log physics floor violations to audit trail"
        - "Archive session metadata"

  session_termination:
    triggers:
      - "Budget exhausted (F1_budget = 1.00)"
      - "User explicitly closes session"
      - "888_HOLD escalation to human (unresolved)"
      - "Runtime exceeds maximum (if configured)"

    cleanup:
      - "Flush ACTIVE memory to LEDGER"
      - "Archive PHOENIX amendments"
      - "Close session handle"

# =============================================================================
# INTEGRATION WITH SEMANTIC FLOORS
# =============================================================================

integration:
  pipeline_flow: "111 SENSE → Physics Check → Semantic Check (666 ALIGN) → 888 JUDGE → 999 SEAL"

  judgment_order:
    - "Stage 111 SENSE: Capture TEARFRAME telemetry"
    - "Physics Check: Evaluate F1_budget, F3_burst, F7_streak"
    - "If physics VOID/888_HOLD → short-circuit to 999 SEAL with physics verdict"
    - "If physics PASS → continue to 666 ALIGN semantic floors"
    - "Stage 888 JUDGE: Merge physics + semantic verdicts (physics wins if conflict)"
    - "Stage 999 SEAL: Emit final verdict"

  verdict_merge:
    rule: "MAX(physics_verdict, semantic_verdict) where SABAR > VOID > 888_HOLD > PARTIAL > SEAL"
    examples:
      - "Physics VOID + Semantic SEAL → Final VOID"
      - "Physics 888_HOLD + Semantic PARTIAL → Final 888_HOLD"
      - "Physics PASS + Semantic VOID → Final VOID"
      - "Physics PASS + Semantic SEAL → Final SEAL"

# =============================================================================
# USAGE EXAMPLES
# =============================================================================

usage_examples:
  budget_exhausted:
    scenario: "User asks question but budget is at 100%"
    tearframe:
      allocated_budget: 1.00  # 100% used
      turn_rate: 5
      failure_streak: 0
    physics_check:
      F1_budget: "FAIL (budget >= 1.00)"
      F3_burst: "PASS"
      F7_streak: "PASS"
    semantic_check: "SEAL (question is valid)"
    final_verdict: "VOID (physics override - budget exhausted)"
    output: "I cannot continue. Session budget exhausted. Please start a new session."

  burst_detected:
    scenario: "User asks 40 questions in 1 minute"
    tearframe:
      allocated_budget: 0.50
      turn_rate: 40  # >30 threshold
      failure_streak: 0
      entropy: 0.02  # Low variance (robotic)
    physics_check:
      F1_budget: "PASS"
      F3_burst: "FAIL (turn_rate > 30 AND entropy < 0.05)"
      F7_streak: "PASS"
    semantic_check: "SEAL (all questions valid)"
    final_verdict: "888_HOLD (physics override - burst detected)"
    output: "High-velocity interaction detected. Please confirm you are human before continuing."

  failure_streak:
    scenario: "User's 4th attempt after 3 consecutive VOID verdicts"
    tearframe:
      allocated_budget: 0.60
      turn_rate: 10
      failure_streak: 3  # Max threshold
    physics_check:
      F1_budget: "PASS"
      F3_burst: "PASS"
      F7_streak: "FAIL (failure_streak >= 3)"
    semantic_check: "PARTIAL (marginal compliance)"
    final_verdict: "888_HOLD (physics override - consecutive failures)"
    output: "I have failed to satisfy your request safely 3 times. Escalating to human judgment."

  all_pass:
    scenario: "Normal conversation flow"
    tearframe:
      allocated_budget: 0.30
      turn_rate: 5
      failure_streak: 0
      entropy: 0.25  # Natural variance
    physics_check:
      F1_budget: "PASS (budget < 0.80)"
      F3_burst: "PASS (turn_rate < 30, entropy > 0.05)"
      F7_streak: "PASS (failure_streak < 3)"
    semantic_check: "SEAL (all semantic floors pass)"
    final_verdict: "SEAL (both physics and semantics pass)"
    output: "Normal response with full governance approval."

# =============================================================================
# NOTES
# =============================================================================

notes:
  created: "2025-12-29"
  updated: "2025-12-29"
  author: "arifOS Project"
  license: "Apache-2.0"
  canonical_source: "L1_THEORY/canon/03_runtime/03_SESSION_PHYSICS_v45.md"
  note: "Session physics provides hard limits that override semantic judgment. Physics > Semantics is the core principle."
