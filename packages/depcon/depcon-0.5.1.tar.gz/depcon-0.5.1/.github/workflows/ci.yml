name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13", "3.14"]
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"

    - name: Install Python and dependencies
      run: |
        uv python install ${{ matrix.python-version }}
        uv sync --group dev --group test

    - name: Debug environment
      run: |
        uv run python --version
        uv --version
        uv run pip list

    - name: Test package installation
      run: |
        uv run depcon --version
        uv run depcon --help

    - name: Run linting
      run: |
        uv run ruff check src/ tests/ || echo "Ruff linting failed, but continuing..."
        uv run ruff format src/ tests/ || echo "Ruff formatting check failed, but continuing..."

    - name: Run type checking
      run: |
        uv run ty check src/ || echo "Type checking failed, but continuing..."

    - name: Run tests without coverage
      run: |
        uv run pytest -v

  build:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv sync --group dev

    - name: Build package
      run: |
        uv build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  security:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv sync --group dev

    - name: Run security checks
      run: |
        uv pip install safety
        uv run safety check

  integration:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"

    - name: Install depcon
      run: |
        uv sync

    - name: Test basic functionality
      run: |
        uv run depcon --help
        uv run depcon convert --help
        uv run depcon show --help
        uv run depcon validate --help

    - name: Test with example requirements
      run: |
        mkdir -p test-dir && cd test-dir
        echo "requests>=2.25.0" > requirements.txt
        echo "numpy>=1.20.0" >> requirements.txt
        
        uv run depcon convert -r requirements.txt --project-name "test-project" --verbose -o test-pyproject.toml --no-backup
        uv run depcon show -f test-pyproject.toml
        uv run depcon validate -f test-pyproject.toml
        
        cd .. && rm -rf test-dir
