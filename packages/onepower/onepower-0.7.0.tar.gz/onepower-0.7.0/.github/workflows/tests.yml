name: "tests"

on:
  push:
    branches: [main]
    paths-ignore:
      - coverage.svg # Prevent infinite loops when badge changes
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
    paths-ignore:
      - coverage.svg # Prevent infinite loops when badge changes

jobs:
  test:
    if: >
      ${{
        (
          github.event_name == 'pull_request' &&
          github.event.pull_request.user.login != 'dependabot[bot]' &&
          github.event.pull_request.user.login != 'pre-commit-ci[bot]'
        ) ||
        (
          github.event_name == 'push' &&
          !contains(github.event.head_commit.message, 'dependabot') &&
          !contains(github.event.head_commit.message, 'pre-commit.ci')
        )
      }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            python-version: "3.10"
          - os: ubuntu-latest
            python-version: "3.11"
          - os: ubuntu-latest
            python-version: "3.12"
          #- os: ubuntu-latest
          #  python-version: "3.13" # 3.13 not supported due to older scipy (1.13 max) required by dark_emulator!
          #- os: macos-latest
          #  python-version: "3.11"

    permissions:
      contents: write # Needed to commit badge
      pull-requests: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install
        run: |
          pip install git+https://github.com/halomod/halomod.git@main
          pip install -e .[dev]

      # Coverage only on Ubuntu + Python 3.11
      - name: Run Tests (with coverage)
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        run: |
          python -m pytest \
            --cov=onepower \
            --cov-config=.coveragerc \
            --cov-report=term \
            --cov-report= \
            --durations=25

      # Other matrix combos run without coverage
      - name: Run Tests (without coverage)
        if: matrix.os != 'ubuntu-latest' || matrix.python-version != '3.11'
        run: |
          python -m pytest --durations=25

      - name: Generate coverage badge
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11' && success() && github.event_name == 'push'
        uses: tj-actions/coverage-badge-py@v2

      - name: Verify Changed files
        if : matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11' && success() && github.event_name == 'push'
        id: verify
        uses: tj-actions/verify-changed-files@v20
        with:
          files: coverage.svg

      - name: Commit and push badge
        if: steps.verify.outputs.files_changed == 'true' && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11' && success() && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add coverage.svg
          git commit -m "Updated coverage.svg [skip ci]"
          git push
