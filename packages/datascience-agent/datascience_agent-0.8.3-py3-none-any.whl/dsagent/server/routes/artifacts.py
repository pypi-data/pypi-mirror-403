"""Artifacts endpoints.

Artifacts are outputs generated by the agent during execution:
- Visualizations (PNG, SVG, PDF)
- Generated reports (HTML, PDF)
- Exported data (CSV, Excel, Parquet)
- Model files (pickle, joblib)
"""

from __future__ import annotations

from datetime import datetime
from pathlib import Path
from typing import List, Optional

from fastapi import APIRouter, Depends, HTTPException, Query, status
from fastapi.responses import FileResponse
from pydantic import BaseModel, Field

from dsagent.server.deps import (
    get_session_manager,
    verify_api_key,
)
from dsagent.server.models import ErrorResponse
from dsagent.session import SessionManager

router = APIRouter(dependencies=[Depends(verify_api_key)])


# =============================================================================
# Models
# =============================================================================


class ArtifactInfo(BaseModel):
    """Information about an artifact."""

    name: str = Field(..., description="Artifact file name")
    size: int = Field(..., description="File size in bytes")
    modified: datetime = Field(..., description="Last modified time")
    type: str = Field(..., description="Artifact type based on extension")
    url: str = Field(..., description="URL to download the artifact")


class ArtifactListResponse(BaseModel):
    """Response for listing artifacts."""

    artifacts: List[ArtifactInfo] = Field(default_factory=list)
    total: int = Field(0, description="Total number of artifacts")
    session_id: str = Field(..., description="Session ID")


# =============================================================================
# Helper Functions
# =============================================================================


def _get_artifact_type(filename: str) -> str:
    """Determine artifact type from filename."""
    suffix = Path(filename).suffix.lower()
    type_map = {
        # Images
        ".png": "image",
        ".jpg": "image",
        ".jpeg": "image",
        ".svg": "image",
        ".gif": "image",
        # Documents
        ".pdf": "document",
        ".html": "document",
        ".md": "document",
        # Data
        ".csv": "data",
        ".xlsx": "data",
        ".xls": "data",
        ".parquet": "data",
        ".json": "data",
        # Models
        ".pkl": "model",
        ".pickle": "model",
        ".joblib": "model",
        ".h5": "model",
        ".pt": "model",
        ".pth": "model",
        # Code
        ".py": "code",
        ".ipynb": "notebook",
    }
    return type_map.get(suffix, "other")


def _get_media_type(filename: str) -> str:
    """Get media type for file."""
    suffix = Path(filename).suffix.lower()
    media_types = {
        ".csv": "text/csv",
        ".json": "application/json",
        ".xlsx": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        ".xls": "application/vnd.ms-excel",
        ".parquet": "application/octet-stream",
        ".png": "image/png",
        ".jpg": "image/jpeg",
        ".jpeg": "image/jpeg",
        ".gif": "image/gif",
        ".svg": "image/svg+xml",
        ".pdf": "application/pdf",
        ".html": "text/html",
        ".md": "text/markdown",
        ".ipynb": "application/x-ipynb+json",
        ".py": "text/x-python",
        ".txt": "text/plain",
        ".pkl": "application/octet-stream",
        ".pickle": "application/octet-stream",
        ".joblib": "application/octet-stream",
    }
    return media_types.get(suffix, "application/octet-stream")


# =============================================================================
# Endpoints
# =============================================================================


@router.get(
    "/sessions/{session_id}/artifacts",
    response_model=ArtifactListResponse,
    responses={404: {"model": ErrorResponse}},
)
async def list_artifacts(
    session_id: str,
    type_filter: Optional[str] = Query(
        None,
        alias="type",
        description="Filter by type (image, document, data, model, code, notebook)"
    ),
    session_manager: SessionManager = Depends(get_session_manager),
) -> ArtifactListResponse:
    """List artifacts generated by a session.

    Artifacts are outputs created by the agent during code execution,
    such as visualizations, reports, and exported data.

    Args:
        session_id: Session ID
        type_filter: Optional filter by artifact type
        session_manager: Session manager instance

    Returns:
        List of artifacts

    Raises:
        HTTPException: If session not found
    """
    session = session_manager.load_session(session_id)
    if session is None:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Session {session_id} not found",
        )

    if session.artifacts_path is None:
        return ArtifactListResponse(
            artifacts=[],
            total=0,
            session_id=session_id,
        )

    artifacts_path = Path(session.artifacts_path)
    if not artifacts_path.exists():
        return ArtifactListResponse(
            artifacts=[],
            total=0,
            session_id=session_id,
        )

    artifacts = []
    for file_path in artifacts_path.iterdir():
        if not file_path.is_file():
            continue

        artifact_type = _get_artifact_type(file_path.name)

        # Apply type filter
        if type_filter and artifact_type != type_filter:
            continue

        stat = file_path.stat()
        artifacts.append(ArtifactInfo(
            name=file_path.name,
            size=stat.st_size,
            modified=datetime.fromtimestamp(stat.st_mtime),
            type=artifact_type,
            url=f"/api/sessions/{session_id}/artifacts/{file_path.name}",
        ))

    # Sort by modified time (newest first)
    artifacts.sort(key=lambda a: a.modified, reverse=True)

    return ArtifactListResponse(
        artifacts=artifacts,
        total=len(artifacts),
        session_id=session_id,
    )


@router.get(
    "/sessions/{session_id}/artifacts/{filename}",
    responses={404: {"model": ErrorResponse}},
)
async def download_artifact(
    session_id: str,
    filename: str,
    session_manager: SessionManager = Depends(get_session_manager),
) -> FileResponse:
    """Download an artifact.

    Args:
        session_id: Session ID
        filename: Artifact filename
        session_manager: Session manager instance

    Returns:
        Artifact file content

    Raises:
        HTTPException: If session or artifact not found
    """
    session = session_manager.load_session(session_id)
    if session is None:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Session {session_id} not found",
        )

    if session.artifacts_path is None:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Session {session_id} has no artifacts path",
        )

    file_path = Path(session.artifacts_path) / filename
    if not file_path.exists():
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Artifact {filename} not found",
        )

    return FileResponse(
        path=file_path,
        filename=filename,
        media_type=_get_media_type(filename),
    )


@router.delete(
    "/sessions/{session_id}/artifacts/{filename}",
    status_code=status.HTTP_204_NO_CONTENT,
    responses={404: {"model": ErrorResponse}},
)
async def delete_artifact(
    session_id: str,
    filename: str,
    session_manager: SessionManager = Depends(get_session_manager),
) -> None:
    """Delete an artifact.

    Args:
        session_id: Session ID
        filename: Artifact filename
        session_manager: Session manager instance

    Raises:
        HTTPException: If session or artifact not found
    """
    session = session_manager.load_session(session_id)
    if session is None:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Session {session_id} not found",
        )

    if session.artifacts_path is None:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Session {session_id} has no artifacts path",
        )

    file_path = Path(session.artifacts_path) / filename
    if not file_path.exists():
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Artifact {filename} not found",
        )

    try:
        file_path.unlink()
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to delete artifact: {str(e)}",
        )
