"""Nginx reverse proxy configuration generation for MCP Proxy."""

from dataclasses import dataclass, field

# SSL cipher suite - split for line length
_SSL_CIPHERS = (
    "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:"
    "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
)


@dataclass
class NginxConfig:
    """Configuration for nginx reverse proxy."""

    server_name: str
    backend_port: int = 8000
    backend_host: str = "127.0.0.1"
    ssl_certificate: str | None = None
    ssl_certificate_key: str | None = None
    health_path: str = "/mcp/health"
    proxy_read_timeout: int = 300
    proxy_connect_timeout: int = 60
    proxy_send_timeout: int = 300
    extra_locations: dict[str, str] = field(default_factory=dict)


NGINX_TEMPLATE = """\
# MCP Proxy nginx configuration
# Generated by: mcp-proxy nginx generate

upstream mcp_backend {{
    server {backend_host}:{backend_port};
    keepalive 32;
}}

server {{
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name {server_name};

    # SSL configuration
    ssl_certificate {ssl_certificate};
    ssl_certificate_key {ssl_certificate_key};
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers {ssl_ciphers};
    ssl_prefer_server_ciphers off;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;

    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Main location - proxy to MCP backend
    location / {{
        proxy_pass http://mcp_backend;
        proxy_http_version 1.1;

        # Pass through Authorization header (critical for OAuth)
        proxy_set_header Authorization $http_authorization;

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE support for MCP streaming
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;

        # Timeouts for long-running tool calls
        proxy_read_timeout {proxy_read_timeout}s;
        proxy_connect_timeout {proxy_connect_timeout}s;
        proxy_send_timeout {proxy_send_timeout}s;
    }}

    # Health check endpoint (excluded from auth in the proxy)
    location {health_path} {{
        proxy_pass http://mcp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }}
{extra_locations}}}

# Redirect HTTP to HTTPS
server {{
    listen 80;
    listen [::]:80;
    server_name {server_name};
    return 301 https://$server_name$request_uri;
}}
"""


def generate_nginx_config(config: NginxConfig) -> str:
    """Generate nginx configuration from NginxConfig."""
    ssl_cert = (
        config.ssl_certificate
        or "/etc/letsencrypt/live/{}/fullchain.pem".format(config.server_name)
    )
    ssl_key = (
        config.ssl_certificate_key
        or "/etc/letsencrypt/live/{}/privkey.pem".format(config.server_name)
    )

    extra_locations = ""
    for path, upstream in config.extra_locations.items():
        extra_locations += f"""
    location {path} {{
        proxy_pass {upstream};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }}
"""

    return NGINX_TEMPLATE.format(
        server_name=config.server_name,
        backend_host=config.backend_host,
        backend_port=config.backend_port,
        ssl_certificate=ssl_cert,
        ssl_certificate_key=ssl_key,
        ssl_ciphers=_SSL_CIPHERS,
        health_path=config.health_path,
        proxy_read_timeout=config.proxy_read_timeout,
        proxy_connect_timeout=config.proxy_connect_timeout,
        proxy_send_timeout=config.proxy_send_timeout,
        extra_locations=extra_locations,
    )
