# GitHub Actions workflow for testing and continuous integration.
#
# This file performs testing using tox and tox.ini to define and configure the test environments.

name: CI

on:
  push:
    branches:
      - sdc-dev
  pull_request:
    branches:
      - fifi-pointing-discard
      - sdc-dev

jobs:

  check:
    name: Check Style
    runs-on: self-hosted

    steps:
      - name: checkout git
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install dependencies
        run: pip install tox
      - name: Check Style
        run: |
          ref="${{github.base_ref}}"
          ref=${ref:+"origin/$ref"}
          # get changed python files, exclude deletions and renames
          git diff --diff-filter=rd --name-status ${ref:-HEAD~} -- '*.py' \
          | cut -f 2- \
          | xargs -d '\n' -r tox -e check-style -- --force-exclude
    
  unit-tests:
    name: Unit Tests ${{ matrix.pyver }} ${{ matrix.toxenv }}
    runs-on: self-hosted
    strategy:
      matrix:
        toxenv:
          - test-small-xdist
          - test-oldestdeps-small-xdist
        # https://docs.github.com/en/actions/how-tos/write-workflows/choose-what-workflows-do/run-job-variations#expanding-or-adding-matrix-configurations
        include:
          - pyver: 3.14
          - toxenv: test-oldestdeps-small-xdist
            pyver: 3.11

    steps:
      - name: checkout git
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up python      
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.pyver }}
      - name: Install dependencies
        run: pip install tox
      - name: Run tests
        run: tox -e ${{ matrix.toxenv }}