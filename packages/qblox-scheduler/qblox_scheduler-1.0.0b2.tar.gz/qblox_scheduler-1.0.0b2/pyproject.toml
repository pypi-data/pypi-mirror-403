[build-system]
requires = ["setuptools>=66.1"]
build-backend = "setuptools.build_meta"

[project]
name = "qblox-scheduler"
description="""\
  qblox-scheduler is a Python package for writing quantum programs featuring \
  a hybrid gate-pulse control model with explicit timing control.\
"""
maintainers = [
  {name = "qblox", email = "software-engineering@qblox.com"},
]
classifiers = [
  "Development Status :: 4 - Beta",
  "Intended Audience :: Developers",
  "Intended Audience :: Science/Research",
  "License :: OSI Approved :: BSD License",
  "Natural Language :: English",
  "Programming Language :: Python :: 3",
  "Programming Language :: Python :: 3.10",
  "Programming Language :: Python :: 3.11",
  "Programming Language :: Python :: 3.12",
  "Programming Language :: Python :: 3.13",
  "Topic :: Scientific/Engineering",
]
keywords = ["quantum", "quantify", "qblox", "qiskit"]
license = { text = "BSD-3-Clause" }
dynamic = ["version", "readme"]
requires-python = ">=3.10"
dependencies = [
  "columnar",
  "dataclasses-json",
  "fastjsonschema",
  "jinja2>=3.1.2", # pandas requires version 3.1.2 or newer
  "matplotlib",
  "netcdf4<1.7.2; python_version < '3.13'", # netcdf 1.7.2 and 1.7.3 break for python <3.13
  "netcdf4>=1.7.3; python_version >= '3.13'", # netcdf 1.7.1.post2 breaks for python 3.13
  "networkx",
  "numpy",
  "pandas[output_formatting]",
  "pathvalidate",
  "plotly",
  "pydantic-core>=2.22", # Support for complex numbers in pydantic.
  "qblox-instruments>=0.17.0,<2", # Prevent upgrade upon minor release while allowing for installing patch releases
  "quantify-core==0.8.3", # ThresholdedAcquisition bug fix
  "qcodes>=0.32.0", # 0.32.0: introduces InstrumentModule
  "scipy",
  "tqdm>=4.24.0", # 4.24.0: introduces autonotebook
  "typing-extensions; python_version < '3.11'", # Required for type checking in Python 3.9
  "xarray[io]>=0.19.0,<2025.9.1", # breaking change in dataset.update, remove when we're no longer dependent on quantify-core.
  "xxhash",
  "ruamel.yaml>=0.18.0",
  # We are using rich in our tutorials
  "rich[jupyter]",
  "pyqt5-qt5<=5.15.2 ; platform_system == 'Windows'",
  "pydantic>=2.12.0",
  "h5netcdf!=1.7.0, !=1.7.1, !=1.7.2",
]

[project.optional-dependencies]
test = [
  "pytest~=8.3",
  "pytest-mock~=3.14",
  "diff-cover~=9.2",
  "pytest-mpl~=0.17",
]
cli = [  
  "typer>=0.16.0",                      # CLI framework
  "gritql~=0.2",                        # For script migration patterns
  "httpx",                              # Required by gritql
]

docs = [
  "jupyter-sphinx~=0.5.3",
  "jupytext~=1.16",
  "sphinx~=7.4",
  "nbclient!=0.10.3",  # exclude version that breaks our ipython widget that displays compiled instructions.
  "pydata-sphinx-theme~=0.16.1",
  "myst-nb~=1.2",
  "hvplot~=0.11.2",
  "plotly~=6.0.1",
  "scanpydoc~=0.14.0",
  "sphinx-autoapi~=3.6",
  "sphinx-autodoc-typehints<3.1",
  "sphinx-design~=0.6.1",
  "sphinx-jsonschema~=1.19",
  "sphinx-togglebutton~=0.3.2",
  "sphinx-copybutton~=0.5.2",
  "sphinxcontrib-bibtex~=2.6",
  "sphinxcontrib-mermaid~=1.0",
]

dev = [
  "pre-commit~=4.1",
  "pre-commit-hooks~=5.0",              # common hooks for git repos
  "pyright==1.1.405",
  "pytest-cov~=6.0",
  "pytest-xdist~=3.6",                  # run tests in parallel
  "ruff~=0.14.0",                       # linter
  "typos~=1.30",                        # spell checker
  "commitizen~=4.4",                    # commit messages
  "vulture~=2.14",                      # static analyzer
  "mdformat~=1.0",                      # markdown formatter
  "mdformat-gfm",
  "mdformat-pyproject",
  "mdformat-ruff",
  "sphinx-autobuild~=2024.10",
  "pip-licenses~=5.0.0",
  "packaging~=25.0",
  "qblox-scheduler[docs,test]",
]

[project.urls]
"Documentation" = "https://docs.qblox.com"
"Source" = "https://gitlab.com/qblox/packages/software/qblox-scheduler"
"Issue tracker" = "https://gitlab.com/qblox/packages/software/qblox-scheduler/-/issues"
"Changelog" = "https://gitlab.com/qblox/packages/software/qblox-scheduler/-/blob/main/CHANGELOG.md"

[project.scripts]
qblox-scheduler = "migration_helper.migrate:app"


[tool.setuptools]
include-package-data = true
zip-safe = false

[tool.setuptools.packages.find]
where = ["src", "."]
include = ["qblox_scheduler", "qblox_scheduler.*", "migration_helper"]

[tool.setuptools.package-data]
"*" = ["*.json"]

[tool.setuptools.dynamic]
readme = { file = ["README.md"], content-type = "text/markdown" }


[tool.ruff]
extend-exclude = [
  "docs",
]
line-length = 100
target-version = "py310"


[tool.ruff.lint]
select = [
  "F",     # Pyflakes
  "E",     # pycodestyle
  "W",     # pycodestyle
  "D",     # pydocstyle
  "I",     # isort
  "N",     # pep8-naming
  "ANN",   # flake8-annotations
  "S",     # flake8-bandit
  "BLE",   # flake8-blind-except
  "B",     # flake8-bugbear
  "A",     # flake8-builtins
  "C4",    # flake8-comprehensions
  "ICN",   # flake8-import-conventions
  "LOG",   # flake8-logging
  "G",     # flake8-logging-format
  "PIE",   # flake8-pie
  "RSE",   # flake8-raise
  "SLOT",  # flake8-slots
  "SIM",   # flake8-simplify
  "TID",   # flake8-tidy-imports
  "TC",    # flake8-type-checking
  "ARG",   # flake8-unused-arguments
  "FLY",   # flynt
  "C90",   # mccabe
  "NPY",   # NumPy-specific rules
  "PD",    # pandas-vet
  "PERF",  # Perflint
  "PGH",   # pygrep-hooks
  "PL",    # Pylint (PLC, PLE, PLR, PLW)
  "UP",    # pyupgrade
  "FURB",  # refurb
  "RUF",   # Ruff-specific rules
]
ignore = [
  "D105",     # Missing docstring in magic method
  "D107",     # Missing docstring in `__init__` (it should be completely absent in our convention)
  "D203",     # 1 blank line required before class docstring  (conflict with D211)
  "D205",     # blank-line-after-summary (Conflicts when summary is too large)
  "D212",     # Multi-line docstring summary should start at the first line (conflict with D213)
  "D401",     # Docstrings should be in imperative mood
  "ANN002",   # Missing type annotation for *{name}
  "ANN003",   # Missing type annotation for **{name}
  "PLC0415",  # `import` should be at the top-level of a file
  "PLR0912",  # Too many branches (... > 12)
  "PLR0913",  # Too many arguments to function call (.../5)
  "B028",     # No explicit `stacklevel` keyword argument found
  "PIE790",   # Unnecessary `pass` statement
  "PGH003",   # Use specific rule codes when ignoring type issues
  "S101",     # Use of `assert` detected
  "SIM118",   # Use `key in dict` instead of `key in dict.keys()`
  # FIXME: Temporarily ignored to limit commit scope
  "UP007",    # Use X | Y for type annotations
  "UP045",    # Use `X | None` for type annotations
  # NOTE: The following are going to be un-ignored in the code quality report
  "RUF005",   # Consider iterable unpacking instead of concatenation
  "RUF013",   # PEP484 prohibits implicit `Optional`
  "RUF015",   # Prefer next(...) over single element slice
  "RUF043",   # Pattern passed to `match=` contains metacharacters but is neither escaped nor raw
]

[tool.ruff.lint.flake8-comprehensions]
allow-dict-calls-with-keyword-arguments = true

[tool.ruff.lint.flake8-type-checking]
exempt-modules = ["typing", "typing_extensions"]
runtime-evaluated-base-classes = [
  "pydantic.BaseModel",
  "dataclasses_json.DataClassJsonMixin",
  "qblox_scheduler.structure.model.DataStructure",
  "qblox_scheduler.structure.model.SchedulerBaseModel",
  "qblox_scheduler.structure.model.SchedulerSubmodule",
]

[tool.ruff.lint.pep8-naming]
extend-ignore-names = [
  "*path_I*",
  "*path_Q*",
  "A",
  "I",
  "Q",
  "V",
  "amp_A",
  "amp_B",
  "dBm",
  "gain_I",
  "gain_Q",
  "net_zero_A_scale",
  "qC",
  "qT",
  "ram_Z_pulse",
  "reference_magnitude_*",
]

[tool.ruff.lint.per-file-ignores]
# Project specific files
"setup.py" = ["D", "ANN"]
"*/docs/source/conf.py" = ["E402", "F401"]
"__init__.py" = ["D104", "D400", "D415", "F403", "F405"]
"src/qblox_scheduler/_version.py" = ["ANN001", "ANN202"]
"src/qblox_scheduler/structure/compat.py" = ["ANN401"]

# Test don't need to be properly linted
"tests/**/*.py" = [
  "D",        # pydocstyle
  "ANN",      # flake8-annotations
  "PTH",      # flake8-use-pathlib
  "F403",     # from {name} import * used
  "F811",     # Redefinition of unused {name} from {row}
  "S101",     # Use of `assert` detected
  "S307",     # Use of possibly insecure function; consider using `ast.literal_eval`
  "B011",     # Do not `assert False`, raise `AssertionError()`
  "B017",     # Do not assert blind exception
  "ARG001",   # Unused function argument
  "PLR2004",  # Magic value used in comparison, consider replacing `...` with a constant variable
  "RUF018",   # Avoid assignment expressions in `assert` statements
  "NPY002",   # Replace legacy `np.random.normal` call with `np.random.Generator`
]
"profiling/*" = [
  "D",        # pydocstyle
  "ANN",      # flake8-annotations
  "PTH",      # flake8-use-pathlib
  "F403",     # from {name} import * used
  "F811",     # Redefinition of unused {name} from {row}
  "PD901",    # Avoid using the generic variable name `df` for DataFrames
  "S101",     # Use of `assert` detected
  "S307",     # Use of possibly insecure function; consider using `ast.literal_eval`
  "S301",     # `pickle` and modules that wrap it can be unsafe when used to deserialize untrusted data, possible security issue
  "S311",     # Standard pseudo-random generators are not suitable for cryptographic purposes
  "B011",     # Do not `assert False`, raise `AssertionError()`
  "B017",     # Do not assert blind exception
  "ARG001",   # Unused function argument
  "PLR2004",  # Magic value used in comparison, consider replacing `...` with a constant variable
  "RUF018",   # Avoid assignment expressions in `assert` statements
  "NPY002",   # Replace legacy `np.random.normal` call with `np.random.Generator`
]

"src/qblox_scheduler/analysis/*.py" = ["ANN", "D"]

# Type checking and naming conventions for the pydantic files (backends/types) is annoying
"src/qblox_scheduler/backends/types/common.py" = ["ANN001", "ANN202"]
"src/qblox_scheduler/backends/types/qblox.py" = ["ANN001"]

# Files that might still need to be fixed in the future
"src/qblox_scheduler/schedules/_visualization/pulse_scheme.py" = ["D417"]  # TODO: refactor the functions in here

[tool.ruff.lint.isort]
extra-standard-library = ["typing_extensions"]
known-first-party = ["quantify_core", "qblox_scheduler"]
split-on-trailing-comma = true  # TODO: make false later

[tool.ruff.lint.pylint]
allow-magic-value-types = ["str", "int"]

[tool.ruff.lint.mccabe]
max-complexity = 15


# This is not a real tool; the section is used to generate the code quality report with additional rules
[tool.ruff-warnings.lint]
extend-select = [
  "ERA",  # eradicate
  "FIX",  # flake8-fixme
  "SLF",  # flake8-self
  "PTH",  # flake8-use-pathlib
  "RUF",  # Ruff-specific rules (overrides ignores)
]

[tool.vulture]
paths = ["src/qblox_scheduler/"]        # Specify the directories Vulture should scan
exclude = ["setup.py"]  # Exclude directories or files

[tool.pyright]
exclude = [
  "docs",
  "setup.py",
  # All files below are temporarily excluded explicitly and expected to be gradually turned into pyright-compliancy
  "src/qblox_scheduler/analysis/*.py",
  "src/qblox_scheduler/backends/graph_compilation.py",
  "src/qblox_scheduler/operations/acquisition_library.py",
  "src/qblox_scheduler/operations/gate_library.py",
  "src/qblox_scheduler/operations/measurement_factories.py",
  "src/qblox_scheduler/operations/nv_native_library.py",
  "src/qblox_scheduler/operations/pulse_factories.py",
  "src/qblox_scheduler/operations/pulse_library.py",
  "src/qblox_scheduler/schedules/schedule.py",
  "src/qblox_scheduler/schedules/timedomain_schedules.py",
  "src/qblox_scheduler/schedules/trace_schedules.py",
  "src/qblox_scheduler/schedules/verification.py",
  "src/qblox_scheduler/schedules/_visualization/pulse_diagram.py",
  "src/qblox_scheduler/schedules/_visualization/pulse_scheme.py",
  "tests/fixtures/mock_setup.py",
  "tests/scheduler/test_compilation.py",
  "tests/scheduler/test_corrections.py",
  "tests/scheduler/test_gate_library.py",
  "tests/scheduler/test_gettables.py",
  "tests/scheduler/test_json_utils.py",
  "tests/scheduler/test_pulse_library.py",
  "tests/scheduler/test_types.py",
  "tests/scheduler/analysis/*.py",
  "tests/scheduler/backends/test_circuit_to_device.py",
  "tests/scheduler/backends/test_graph_compilation.py",
  "tests/scheduler/backends/test_qblox_backend.py",
  "tests/scheduler/backends/graph_backends/test_qblox_backend.py",
  "tests/scheduler/backends/qblox/test_driver_version_check.py",
  "tests/scheduler/backends/qblox/test_helpers_qblox.py",
  "tests/scheduler/backends/qblox/operation_handling/test_acquisitions.py",
  "tests/scheduler/backends/qblox/operation_handling/test_virtual.py",
  "tests/scheduler/device_under_test/test_composite_square_edge.py",
  "tests/scheduler/device_under_test/test_nv_element.py",
  "tests/scheduler/device_under_test/test_specific_device_element.py",
  "tests/scheduler/helpers/test_schedule.py",
  "tests/scheduler/helpers/test_waveforms.py",
  "tests/scheduler/instrument_coordinator/test_instrument_coordinator.py",
  "tests/scheduler/instrument_coordinator/test_utility.py",
  "tests/scheduler/instrument_coordinator/components/test_qblox.py",
  "tests/scheduler/schedules/compiles_all_backends.py",
  "tests/scheduler/schedules/test_schedule_plotting.py",
  "tests/scheduler/schedules/test_spectroscopy_schedules.py",
  "tests/scheduler/schedules/test_timedomain_schedules.py",
  "tests/scheduler/schedules/visualization/test_pulse_scheme.py",
  "tests/scheduler/structure/test_model.py",
]


[tool.typos]
files.extend-exclude = [
  "*.svg",
  "THIRD_PARTY_LICENSES.md"
]
default.extend-ignore-identifiers-re = [
  "ND",
  "_INTERM_FREQ_",
  "annote",  # Found in refs.bib
  "arange",  # np.arange()
  "ba",
  "interm_freq",
  "ket",
  "op_strat",
  "ser_",
]


[tool.pytest.ini_options]
testpaths = "tests/"
# Exclude the following directories
norecursedirs = [
  "_build",
  "docs",
  ".git",
  ".*cache",
  "*.egg",
  "*site-packages*",
]
markers = [
  "mpl_image_compare",
  "deprecated",
  "regression",
]
filterwarnings = [
    # Raise error on our own FutureWarnings
    "error:.*quantify-(scheduler|core).*:FutureWarning",
    # Raised when operations overlap in time, not important for us.
    "ignore:.*starts before the previous ends.*:RuntimeWarning",
    # using mocker.patch as a context manager is not required, but also doesn't
    # harm anyone.
    "ignore::pytest_mock.PytestMockWarning",
    # warning only interesting for users, not for developers.
    "ignore:Distortion correction portclock.*",
    "ignore:.*has conflicting frequency definitions.*",
    "ignore:.*Schedule contains an operation, for which distortion correction is not implemented.*",
    "ignore:.*quantify_core.*"
]


[tool.coverage.paths]
source = [
  "src",
]

[tool.coverage.run]
branch = true
source = [
  "src/qblox_scheduler",
]
omit = [
  "*tests*",
  "*/usr/local/lib*",
  "/usr/lib/python3/*",
  "*__init__*",
  "**/site-packages/**",
]

[tool.coverage.report]
show_missing = true
exclude_lines = [
  # Don't complain if non-runnable code isn't run:
  "if 0:",
  "if __name__ == .__main__.:",
  "if TYPE_CHECKING:",
]

[tool.mdformat]
number = false      # possible values: {false, true}
wrap = 100          # possible values: {"keep", "no", INTEGER}
end_of_line = "lf"  # possible values: {"lf", "crlf", "keep"}
