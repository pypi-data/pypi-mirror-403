[build-system]
requires = ["hatchling", "hatch-requirements-txt"]
build-backend = "hatchling.build"

[project]
name = "ssh-mitm-core"
dynamic = ["version", "dependencies"]
authors = [
    {name = "SSH-MITM Dev-Team", email = "support@ssh-mitm.at"}
]
maintainers = [
  {name = "Manfred Kaiser", email = "manfred.kaiser@ssh-mitm.at"}
]
description = "SSH-MITM core modules"
readme = "README.md"
license = {file = "LICENSE"}
keywords = [
    "ssh",
    "proxy",
    "mitm",
    "network",
    "security",
    "audit",
]
classifiers = [
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Programming Language :: Python :: 3.14",
    "License :: OSI Approved :: GNU General Public License v3 (GPLv3)",
    "Topic :: System :: Networking",
    "Development Status :: 5 - Production/Stable",
]
requires-python = ">= 3.11"

[project.urls]
Homepage = "https://www.ssh-mitm.at"
Documentation = "https://docs.ssh-mitm.at"
Changelog = "https://github.com/ssh-mitm/ssh-mitm-core/blob/master/CHANGELOG.md"
Source = "https://github.com/ssh-mitm/ssh-mitm-core"
Tracker = "https://github.com/ssh-mitm/ssh-mitm-core/issues"

[project.scripts]
ssh-mitm = "sshmitmcore.cli:main"

[project.entry-points."sshmitm.SubCommand"]
server = "sshmitmcore.commands.server:SSHServerModules"

[project.entry-points."sshmitm.BaseSession"]
base = "sshmitmcore.session:Session"

[project.entry-points."sshmitm.Authenticator"]
remoteauth = "sshmitmcore.authentication:AuthenticatorRemote"

[project.entry-points."sshmitm.BaseServerInterface"]
base = "sshmitmcore.interfaces.server:ServerInterface"

[project.entry-points."sshmitm.BaseSFTPServerInterface"]
base = "sshmitmcore.interfaces.sftp:SFTPProxyServerInterface"

[tool.hatch.version]
path = "sshmitmcore/__init__.py"

[tool.hatch.metadata.hooks.requirements_txt]
files = ["requirements.in"]

[tool.hatch.build]
include = [
    "requirements.in",
    "sshmitmcore/**/*.py",
    "sshmitmcore/data/*.*",
]

[tool.hatch.envs.lint]
detached = false
dependencies = [
    "bandit",
    "black~=25.0",
    "Flake8-pyproject",
    "flake8",
    "mypy",
    "pylint",
    "ruff",
]

[tool.hatch.envs.lint.scripts]
check = [
    "black --check sshmitmcore",
    "bandit -r sshmitmcore",
    "ruff check sshmitmcore",
    "flake8 sshmitmcore",
    "pylint sshmitmcore",
    #"- mypy sshmitm",
]

[tool.hatch.envs.docs]
detached = false

[tool.hatch.envs.docs.scripts]
build = [
    "pip install -r doc/requirements.txt",
    "sphinx-apidoc -T -e -M -d 1 -o doc/api sshmitm",
    "sphinx-build doc build/html",
]

[tool.hatch.envs.appimage]
detached = false

[tool.hatch.envs.appimage.scripts]
build = [
    "appimage/build.sh",
]

[tool.flake8]
ignore = ["E203", "E501", "W503"]

[tool.mypy]
strict = true
install_types = true
non_interactive = true

[tool.pylint]
disable = [
    "duplicate-code",
    "fixme",
    "line-too-long",
    "missing-class-docstring",
    "missing-function-docstring",
    "missing-module-docstring",
    "too-few-public-methods",
    "too-many-branches",
    "too-many-instance-attributes",
    "too-many-locals",
    "too-many-positional-arguments",
    "too-many-return-statements",
    "too-many-statements",
]

[tool.pylint.MASTER]
load-plugins = "pylint.extensions.docparams"

[tool.ruff.lint]
select = ["ALL"]
ignore = [
    "A005",    # Module shadows a Python standard-library module
    "ANN401",  # Dynamically typed expressions (typing.Any) are disallowed
    "COM812",  # Trailing comma missing
    "D",       # Docstring related
    "E501",    # Line too long
    "FA100",   # Missing from __future__ import annotations
    "FBT001",  # Boolean-typed positional argument in function definition
    "FBT002",  # Boolean default positional argument in function definition
    "FBT003",  # Boolean positional value in function call
    "FIX002",  # Line contains TODO, consider resolving the issue
    "LOG015",  # call on root logger
    "N818",    # Exception name `MissingHostException` should be named with an Error suffix
    "PLR0911", # Too many return statements
    "PLR0912", # Too many branches
    "PLR0913", # Too many arguments in function definition
    "PLR2004", # Magic value used in comparison
    "PTH103",  # `os.makedirs()` should be replaced by `Path.mkdir(parents=True)`
    "PTH107",  # `os.remove()` should be replaced by `Path.unlink()`
    "PTH111",  # `os.path.expanduser()` should be replaced by `Path.expanduser()`
    "PTH113",  # `os.path.isfile()` should be replaced by `Path.is_file()`
    "PTH116",  # `os.stat()` should be replaced by `Path.stat()`, `Path.owner()`, or `Path.group()`
    "PTH118",  # `os.path.join()` should be replaced by `Path` with `/` operator
    "PTH119",  # `os.path.basename()` should be replaced by `Path.name`
    "PTH123",  # `open()` should be replaced by `Path.open()`
    "S104",    # Possible binding to all interfaces
    "SLF001",  # Private member accessed: `_indent`
    "T201",    # `print` found
    "TRY301",  # Abstract `raise` to an inner function
    "TRY400",  # Use `logging.exception` instead of `logging.error`
    "UP",      # pyupgrade (UP) relevant errors
]
[tool.ruff.lint.per-file-ignores]
"sshmitm/core/workarounds/monkeypatch.py" = ["ALL"]
"sshmitm/core/workarounds/transport.py" = ["ALL"]


[tool.bumpversion]
current_version = "5.0.1"
parse = "(?P<major>\\d+)\\.(?P<minor>\\d+)\\.(?P<patch>\\d+)"
serialize = ["{major}.{minor}.{patch}"]
search = "{current_version}"
replace = "{new_version}"
regex = false
ignore_missing_version = false
ignore_missing_files = false
tag = false
sign_tags = false
tag_name = "{new_version}"
tag_message = "Bump version: {current_version} → {new_version}"
allow_dirty = false
commit = false
message = "Bump version: {current_version} → {new_version}"
moveable_tags = []
commit_args = ""
setup_hooks = []
pre_commit_hooks = []
post_commit_hooks = []

[[tool.bumpversion.files]]
filename = "snapcraft.yaml"

[[tool.bumpversion.files]]
filename = "sshmitm/__init__.py"

[[tool.bumpversion.files]]
filename = "CHANGELOG.md"
search = "## [Unreleased]"
replace = """## [Unreleased]

## [{new_version}] - {now:%Y-%m-%d}"""

[[tool.bumpversion.files]]
filename = "CHANGELOG.md"
search = "[Unreleased]: https://github.com/ssh-mitm/ssh-mitm/compare/{current_version}...master"
replace = """[Unreleased]: https://github.com/ssh-mitm/ssh-mitm/compare/{new_version}...master
[{new_version}]: https://github.com/ssh-mitm/ssh-mitm/compare/{current_version}...{new_version}"""

[[tool.bumpversion.files]]
filename = "man1/ssh-mitm.1"
search = """SSH-MITM {current_version}" "SSH-MITM Manual"""
replace = """SSH-MITM {new_version}" "SSH-MITM Manual"""

[[tool.bumpversion.files]]
filename = "man1/ssh-mitm-audit.1"
search = """SSH-MITM {current_version}" "SSH-MITM Manual"""
replace = """SSH-MITM {new_version}" "SSH-MITM Manual"""

[[tool.bumpversion.files]]
filename = "man1/ssh-mitm-server.1"
search = """SSH-MITM {current_version}" "SSH-MITM Manual"""
replace = """SSH-MITM {new_version}" "SSH-MITM Manual"""
