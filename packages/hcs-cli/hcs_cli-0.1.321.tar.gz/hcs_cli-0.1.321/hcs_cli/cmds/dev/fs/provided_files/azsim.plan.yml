---
deploymentId: azsim1
var:
  orgId: ${env.ORG_ID}
  region: ${env.REGION}
  provider:
    subscriptionId: WILL_BE_OVERRIDEN_IN_create_infra_azsim_function
    directoryId: ${env.DIRECTORY_ID?}
    applicationId: ${env.APPLICATION_ID?}
    applicationKey: ${env.APPLICATION_KEY?}
    azureHostOverride: https://simhub.steslabs.net
  infra:
    resourceGroup: ${env.INFRA_RESOURCE_GROUP}
    vnet: ${env.INFRA_VNET}
    subnet: ${env.MANAGEMENT_SUBNET}
    subnetAddressSpace: ${env.MANAGEMENT_SUBNET_CIDR}
  desktop:
    resourceGroup: ${env.DESKTOP_RESOURCE_GROUP}
    vnet: ${env.DESKTOP_VNET}
    subnet: ${env.DESKTOP_SUBNET}
    subnetAddressSpace: ${env.DESKTOP_SUBNET_CIDR}
  edge:
    subnet: ${env.MANAGEMENT_SUBNET}
    subnetAddressSpace: ${env.MANAGEMENT_SUBNET_CIDR}
  uag:
    vmSubnet: ${env.TENANT_SUBNET}
    vmSubnetAddressSpace: ${env.TENANT_SUBNET_CIDR}
    managementSubnet: ${env.MANAGEMENT_SUBNET}
    managementSubnetAddressSpace: ${env.MANAGEMENT_SUBNET_CIDR}
    dmzSubnet: ${env.DMZ_SUBNET}
    dmzSubnetAddressSpace: ${env.DMZ_SUBNET_CIDR}
default:
  name: ${deploymentId}
resource:
  myProvider:
    kind: hcs/provider
    conditions:
      create_new: ${var.provider.applicationId}
    data:
      orgId: ${var.orgId}
      providerLabel: azure
      name: ${default.name}
      edgeGatewayNeeded: false
      description: Provider created by hcs plan with simhub credentials
      providerDetails:
        method: ByAppRegistration
        data:
          subscriptionId: ${var.provider.subscriptionId}
          directoryId: ${var.provider.directoryId}
          applicationId: ${var.provider.applicationId}
          applicationKey: ${var.provider.applicationKey}
          region: ${var.region}
          environment: AZURE
          azureHostOverride: ${var.provider.azureHostOverride}
  mySite:
    kind: hcs/site
    data:
      orgId: ${var.orgId}
      name: ${default.name}
      description: Site generated by hcs plan
  myAD:
    kind: hcs/ad
    data:
      orgId: ${var.orgId}
      name: ${default.name}
      description: AD generated by hcs plan
      defaultOU: CN=Computers
      dnsDomainName: ${env.DNS_DOMAIN_NAME}
      netBIOSName: ${env.NET_BIOS_NAME}
      joinAccounts:
        primary:
          username: ${env.PRIMARY_JOIN_USER_NAME}
          password: ${env.PRIMARY_JOIN_PASSWORD}
        auxiliary:
          username: ${env.AUXILIARY_JOIN_USER_NAME}
          password: ${env.AUXILIARY_JOIN_PASSWORD}
      bindAccounts:
        primary:
          username: ${env.PRIMARY_BIND_USER_NAME}
          password: ${env.PRIMARY_BIND_PASSWORD}
        auxiliary:
          username: ${env.AUXILIARY_BIND_USER_NAME}
          password: ${env.AUXILIARY_BIND_PASSWORD}
      primaryDNS:
      secondaryDNS:
  myEdge:
    kind: hcs/edge
    data:
      orgId: ${var.orgId}
      providerInstanceId: ${myProvider.id}
      name: ${default.name}
      description: Edge generated by hcs plan
      siteId: ${mySite.id}
      providerLabel: azure
      infrastructure:
        managementNetwork:
          kind: subnets
          id: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}/subnets/${var.infra.subnet}
          data:
            parent: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}
            name: ${var.edge.subnet}
            cidr: ${var.edge.subnetAddressSpace}
  myUAG:
    after: [myEdge]
    kind: hcs/uag
    data:
      orgId: ${var.orgId}
      name: ${default.name}
      description: UAG generated by hcs plan
      providerInstanceId: ${myProvider.id}
      fqdn: ${env.UAG_FQDN}
      numberOfGateways: 2
      lbLoadDistributionType: SOURCE_IP_AFFINITY
      type: EXTERNAL
      infrastructure:
        managementNetwork:
          kind: subnets
          id: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}/subnets/${var.uag.managementSubnet}
          data:
            parent: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}
            name: ${var.uag.managementSubnet}
            cidr: ${var.uag.managementSubnetAddressSpace}
        dmzNetwork:
          kind: subnets
          id: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}/subnets/${var.uag.dmzSubnet}
          data:
            parent: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}
            name: ${var.uag.dmzSubnet}
            cidr: ${var.uag.dmzSubnetAddressSpace}
        desktopNetwork:
          kind: subnets
          id: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}/subnets/${var.uag.dmzSubnet}
          data:
            parent: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}
            name: ${var.uag.vmSubnet}
            cidr: ${var.uag.vmSubnetAddressSpace}
        vmSkus:
          kind: vmSkus
          id: Standard_A4_v2
          data:
            capabilities:
              MemoryPreservingMaintenanceSupported: true
              vCPUsAvailable: 4
              OSVhdSizeMB: 1047552
              CombinedTempDiskAndCachedReadBytesPerSecond: 83886080
              CombinedTempDiskAndCachedWriteBytesPerSecond: 41943040
              EncryptionAtHostSupported: false
              UncachedDiskBytesPerSecond: 96000000
              CombinedTempDiskAndCachedIOPS: 4000
              RdmaEnabled: false
              MemoryGB: 8
              PremiumIO: false
              CapacityReservationSupported: true
              CpuArchitectureType: x64
              AcceleratedNetworkingEnabled: false
              LowPriorityCapable: true
              HyperVGenerations: ""
              VMDeploymentTypes: PaaS,IaaS
              UncachedDiskIOPS: 6400
              EphemeralOSDiskSupported: false
              MaxDataDiskCount: 8
              MaxResourceVolumeMB: 40960
              vCPUsPerCore: 1
              MaxNetworkInterfaces: 4
              ACUs: 100
              vCPUs: 4
              SupportsV1: true
              SupportsV2: false
            uagAllowed: true
            tier: Standard
            templateRecommended: false
            series: Av2
            name: A4_v2 (4 CPUs, 8GiB Memory)
            templateBlocked: false
            edgeAllowed: false
            family: standardAv2Family
            gpuType: NONE
      sslCertificate:
        data:
          certificate: |
            -----BEGIN CERTIFICATE-----
            MIIC2DCCAcCgAwIBAgIJAMWJXNXU+fD5MA0GCSqGSIb3DQEBCwUAMBoxCzAJBgNV
            BAYTAlVTMQswCQYDVQQIDAJDQTAeFw0yNDA5MTYwNDQ5NDFaFw0yNjA5MTYwNDQ5
            NDFaMBoxCzAJBgNVBAYTAlVTMQswCQYDVQQIDAJDQTCCASIwDQYJKoZIhvcNAQEB
            BQADggEPADCCAQoCggEBANTfGlpoSreVvoOlHOoe/SdZzEUIM4EwDH4BURCOYjin
            QCh/trlgXOKSXOz+p2yrMddKKX7VW0dzg/B+g2rxyjYItnORcHaexUBM/IJC/u8Z
            3gTIu3KmQZabXfWHfdFAm8XOVQHVY/dpnOAb0szjBXYl3c7Gz/6SJeGSrm+Q7HMJ
            M40CgYpYFSde2ULIby6ruGP+Z2xRdBVZsK7QefDywtFOzKJLlvOZBVXHKUAWYVDG
            twBp3zeBVYxeen7jWY2IcYCB/9wJrlChVwU7mKFhzbJr2eehPJnKCLljc5j7jANa
            VRJg9DKAD41dJBScJ25FB93vul5R6CwPDm5R0QfheDkCAwEAAaMhMB8wHQYDVR0O
            BBYEFBI/JhBCdLrbegYpDc9zb2OWWohKMA0GCSqGSIb3DQEBCwUAA4IBAQAfqo6S
            rWMne9vuH4E/9pAZkYvTd5cXUCL3gfItHzhDi7sGXCqgp/sC4HOdALbrfJkzgAmc
            q3JJAOTC3nanbwVYlUo8DDiTcRH8MLnKB6qR2HpcFxbjdTKxFrpIQtcxh8hIU4Gk
            /BnyrYO/uuqAEXX70onP2e8fST8JUqbSGvuJ3enjd+4SARsMRIsKq8p2EQLZRQYC
            nBDcnGtzQ+ZGByhJh5pflg1CqTNV6uDOWOOywtNY4hA6E5dI7SdjeeLxJNbHfbPj
            gd8doB807z2GC5iocHFwboEkHsmC7yR9oHh5hcHYdBvqtJgc+gQsOz7gkLWL7TCL
            lS6gRq3JWJgzpDQS
            -----END CERTIFICATE-----
            -----BEGIN PRIVATE KEY-----
            MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDU3xpaaEq3lb6D
            pRzqHv0nWcxFCDOBMAx+AVEQjmI4p0Aof7a5YFziklzs/qdsqzHXSil+1VtHc4Pw
            foNq8co2CLZzkXB2nsVATPyCQv7vGd4EyLtypkGWm131h33RQJvFzlUB1WP3aZzg
            G9LM4wV2Jd3Oxs/+kiXhkq5vkOxzCTONAoGKWBUnXtlCyG8uq7hj/mdsUXQVWbCu
            0Hnw8sLRTsyiS5bzmQVVxylAFmFQxrcAad83gVWMXnp+41mNiHGAgf/cCa5QoVcF
            O5ihYc2ya9nnoTyZygi5Y3OY+4wDWlUSYPQygA+NXSQUnCduRQfd77peUegsDw5u
            UdEH4Xg5AgMBAAECggEBAMAIF6zxIl4k/v2hSMlHdVY3Ytfvgw8Kumo9Y9TMrXyw
            HGesdrkaXhCiuqOtQnn8ofS2WWKqtDJr2d1tM76ZKrK9/2GYFV1c81KDYNNd/r7R
            lgC42KifpNFpjUR+mxjW8O9rqDIEP68lHjjpwKvGLNodZNAxd9cOHpA0k5nfof5O
            7AlsMqimjfF70nCf6iP7l/sd8TRYVsL3jRUo8Rn7FvqNcdM7p1KwQga4cfR1xGqW
            QJvcdDW8urBtrA2qmjLSBSeMqh5Nzpo/2yaItx1Uka3HRMYZUfFZQmYwE4jSIy57
            UOML3SuSjcXd07fzUvganb0lpredK+Tc7XL20Ilw2QECgYEA9HrXkM6rJI+1yxJk
            v4iNH5T3lZSBkGxgWx1lcoN0Wu0JBxZ56yJdY9UiTHc+67ehD0PC+vqjsWfQSSyW
            fTCIIbLKLJAqbl4ROSwcKf+MJBPbYT4U87SJiqwq1XVzkbj01jODg5NLUySMB3YZ
            5D1hATM+PlDx8VWy8zKqhIG7mdkCgYEA3ub4OLVvWIprgNtbjiJlBZhZy8rpC/ac
            gVr0Nbm6jjKEAsv/a62om5iqVTASjqEHgP2cohuLwLUyVgsqs4HGnPw2Dtb6GMpH
            LJ3OJ0AO1Te6nSROVXMtx130MLjMxSCUGVCqXqijXlyz9GXXMYW16CP8h7mdJFwM
            U8RugMzcdWECgYAt0Cs/FotZoZiGgl7gyXzwkyDGJfsVjkmMKXkOOXX/Z/XOHzcf
            ieQIRjNUMvBWiaWjz6XlFDzCjNqqK7HTqdmIvxFFwopA/l2p4gsxD5M6W4I7ub+B
            X656jwLD12udvhQbY7HcYSi3XtzitQ3rCFl6ORkL4m1ENTQAgNkVVZ5LGQKBgALH
            XFbQpDe1Wgu8MFMASMQeFxh8ShV1GJRgPuUgkJvPM2gZhPChtJVj/NOdCs4uYbqQ
            7s/yifZ4C82YzAp61rAEUOQ0d9+xPdvnh7djjAvKaxAkcLmN+wceO7oTw7G9azs5
            jzYo4gh+HVwxnNIoOZFQSYijnrriTuEIdNw0MZdhAoGASCNPSp6XEX4984ugtxTf
            mAxw6J6ByZtw90TARsnScZKwksk9ZDKbSWlM6TOugfSMBocRW5jsURni0bIcLV0B
            UR6RWezvMNXcqfz7Z3BNfnV0+pphZQzJKuDbw1X7zEajtnTIbzbE6AKMxvNnXKzz
            J1/sLXvki3toEOdVa9pF1NY=
            -----END PRIVATE KEY-----
        type: PEM
  myImageSingleSession:
    kind: hcs/image
    data:
      import:
        orgId: ${var.orgId}
        providerInstanceId: ${myProvider.id}
        streamName: ${default.name}-single
        streamDescription: Single session image generated by hcs plan
        providerLabel: AZURE
        versionSource: 0.0
        versionType: MAJOR
        gpuType: NONE
        sourceStreamType: AZURE_MARKET_PLACE
        os: Windows 10 Enterprise, 22H2
        osType: WINDOWS
        markers:
          - name: default
        assetDetails:
          data:
            generationType: V1
            licenseType: Windows_Client
            offer: windows-10
            publisher: microsoftwindowsdesktop
            sku: win10-22h2-ent
            vmSize: Standard_DS2_v2
            subNet: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.desktop.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.desktop.vnet}/subnets/${var.desktop.subnet}
            vNet: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.desktop.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.desktop.vnet}
          vmInfo:
            username: ${env.IMAGE_USER_NAME}
            password: ${env.IMAGE_PASSWORD}
          options:
            createPublicIp: true
          type: AZURE_VM_IN_RG
      publish:
        orgId: ${var.orgId}
        versionName: 1.0.0
        providerLabel: AZURE
        options:
          horizonAgent:
            agentPackageId:
            installHorizonAgent: true
            features:
              - AvAgentInstall
          #            - DEM
          #            - ClientDriveRedirection
          #            - PerfTracker
          #            - HelpDesk
          #            - RTAV
          #            - PrintRedir
          #            - GEOREDIR
          #            - SmartCard
          #            - USB
          #            - URLRedirection
          #            - SerialPortRedirection
          #            - ScannerRedirection
          #            - SDOSensor
          applicationScan:
            enableAppScan: false
            appScanDetails:
              infrastructureResourceList: []
            publishWithResiliency: false
            osCustomizations: [DisableWindowsUpdate, RemoveAppXPackages]
            validateImage: false
            validationInfraResourceDetails:
              infrastructureResourceList:
                - kind: subnet
                  id: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.desktop.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.desktop.vnet}/subnets/${var.desktop.subnet}
                  data:
                    parent: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.desktop.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.desktop.vnet}
                    cidr: ${var.desktop.subnetAddressSpace}
  myTemplateFloating:
    kind: hcs/pool-template
    data:
      name: ${default.name}-f-template
      description: Floating-session pool template generated by hcs plan
      imageReference:
        streamId: ${myImageSingleSession.id}
        markerId: ${myImageSingleSession.markers[0].id}
      networks:
        - kind: subnets
          id: /subscriptions/8eec33b8-b725-428d-adeb-ed06583aed08/resourceGroups/stes8-westus2/providers/Microsoft.Network/virtualNetworks/stes8-vnet-westus2/subnets/vmw-hcs-09d4a4f3-38dd-4d1f-a3dc-d8ee46e6da05-net-tenant
          data:
            parent: /subscriptions/8eec33b8-b725-428d-adeb-ed06583aed08/resourceGroups/stes8-westus2/providers/Microsoft.Network/virtualNetworks/stes8-vnet-westus2
            name: vmw-hcs-09d4a4f3-38dd-4d1f-a3dc-d8ee46e6da05-net-tenant
            cidr: 172.24.32.0/20
      infrastructure:
        vmSkus:
          - kind: vmSkus
            id: Standard_B2s
            data:
              capabilities:
                MemoryPreservingMaintenanceSupported: true
                vCPUsAvailable: "2"
                OSVhdSizeMB: "1047552"
                CombinedTempDiskAndCachedReadBytesPerSecond: "22528000"
                CombinedTempDiskAndCachedWriteBytesPerSecond: "22528000"
                EncryptionAtHostSupported: true
                UncachedDiskBytesPerSecond: "22500000"
                CombinedTempDiskAndCachedIOPS: "1600"
                RdmaEnabled: false
                MemoryGB: 4
                PremiumIO: true
                CapacityReservationSupported: true
                SupportedEphemeralOSDiskPlacements: ResourceDisk,CacheDisk
                CpuArchitectureType: x64
                AcceleratedNetworkingEnabled: false
                LowPriorityCapable: true
                HyperVGenerations: [V1, V2]
                VMDeploymentTypes: IaaS
                CachedDiskBytes: "32212254720"
                UncachedDiskIOPS: "1280"
                EphemeralOSDiskSupported: true
                MaxDataDiskCount: "4"
                MaxResourceVolumeMB: "8192"
                vCPUsPerCore: "1"
                MaxNetworkInterfaces: "3"
                vCPUs: 2
              uagAllowed: false
              tier: Standard
              templateRecommended: false
              series: BS
              name: Standard_B2s
              templateBlocked: false
              edgeAllowed: false
              azAllowed: false
              family: standardBSFamily
              gpuType: NONE
              supportedZones:
            displayName: DS2_v2 (2 CPUs, 7GiB Memory)
      sessionsPerVm: 1
      powerPolicy:
        enabled: true
        min: 90
        minUnit: PERCENTAGE
        base: TOTAL
        occupancyPresetMode: OPTIMIZED_FOR_PERFORMANCE
        powerOffProtectTimeMins: 30
      sparePolicy:
        description: ERA created spare policy
        limit: 100
        max: 100
        min: 100
        increment: 100
      activeDirectoryId: ${myAD.id}
      uagDeploymentId: ${myUAG.id}
      orgId: ${var.orgId}
      providerInstanceId: ${myProvider.id}
      licenseProvided: true
      vmNamePattern: ${default.name}-f-
      desktopAdminUsername: ${env.VM_USER_NAME}
      templateType: FLOATING
      desktopAdminPassword: ${env.VM_PASSWORD}
  myPoolFloating:
    kind: hcs/pool-group
    data:
      orgId: ${var.orgId}
      name: ${default.name}-f-pg
      type: DESKTOP
      templateType: FLOATING
      connectionAffinity: NEAREST_SITE
      scope: ALL_SITES
      enableSSO: false
      preferredClientType: HORIZON_CLIENT
      protocols:
        - name: BLAST
          defaultProtocol: true
      templates:
        - id: ${myTemplateFloating.id}
  myEntitlementFloating:
    kind: hcs/entitlement
    data:
      orgId: ${var.orgId}
      poolIds: ["${myPoolFloating.id}"]
      resourceDetails:
        - poolId: ${myPoolFloating.id}
      userIds: ["${env.ENTITLEMENT_USER_1}", "${env.ENTITLEMENT_USER_2}"]
