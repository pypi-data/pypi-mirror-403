<!-- Left Sidebar Component -->
<!-- This component is loaded via htmx in all pages -->
<aside class="w-64 bg-gray-800 text-white flex flex-col custom-scrollbar overflow-y-auto">
  <!-- Header -->
  <div class="p-4 border-b border-gray-700">
    <a href="/ui" class="block hover:opacity-80 transition-opacity">
      <h1 class="text-xl font-bold">Task Framework</h1>
      <p class="text-xs text-gray-400 mt-1">Web Interface</p>
    </a>
  </div>

  <!-- Server Selector (Proxy Mode Only) -->
  <div id="server-selector-container" data-mode="proxy" class="p-4 border-b border-gray-700" style="display: none;">
    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
      Target Server
    </label>
    <select id="server-selector"
      class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      <option value="">-- Loading servers... --</option>
    </select>
    <div id="server-selector-error" class="text-red-400 text-xs mt-1" style="display: none;">
      No servers available
    </div>
    <div id="server-selector-info" class="text-gray-400 text-xs mt-1" style="display: none;">
      <!-- Server info displayed here -->
    </div>
  </div>

  <!-- Navigation Menu -->
  <nav class="flex-1 p-4 space-y-2">
    <!-- Server Management Section (Proxy Mode Only) -->
    <div class="mb-6" data-mode="proxy" style="display: none;">
      <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
        Server Management
      </h2>
      <a href="/ui/servers" data-nav-item="servers"
        class="nav-item flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01">
          </path>
        </svg>
        <span>Servers</span>
      </a>
    </div>

    <!-- Settings Section -->
    <div class="mb-6">
      <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
        Configuration
      </h2>
      <a href="/ui/settings" data-nav-item="settings"
        class="nav-item flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
          </path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z">
          </path>
        </svg>
        <span>Settings</span>
      </a>
      <a href="/ui/metrics" data-nav-item="metrics"
        class="nav-item flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white mt-1">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
          </path>
        </svg>
        <span>Metrics</span>
      </a>
      <a href="/ui/system-settings" data-nav-item="system-settings"
        class="nav-item flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white mt-1">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
          </path>
        </svg>
        <span>System Settings</span>
      </a>
    </div>

    <!-- Thread Management Section -->
    <div class="mb-6">
      <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
        Thread Management
      </h2>
      <a href="/ui/threads" data-nav-item="threads"
        class="nav-item flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16">
          </path>
        </svg>
        <span>Threads</span>
      </a>
      <a href="/ui/artifacts" data-nav-item="artifacts"
        class="nav-item flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white mt-1">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
          </path>
        </svg>
        <span>Artifacts</span>
      </a>
      <a href="/ui/webhooks" data-nav-item="webhooks"
        class="nav-item flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white mt-1">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
          </path>
        </svg>
        <span>Webhooks</span>
      </a>
      <a href="/ui/schedules" data-nav-item="schedules"
        class="nav-item flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white mt-1">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        <span>Schedules</span>
      </a>
      <a href="/ui/files" data-nav-item="files"
        class="nav-item flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white mt-1">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
        </svg>
        <span>Files</span>
      </a>
    </div>

    <!-- Task Management Section (Direct Mode Only) -->
    <div class="mb-6" data-mode="direct">
      <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
        Task Management
      </h2>
      <a href="/ui/metadata" data-nav-item="metadata"
        class="nav-item flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
          </path>
        </svg>
        <span>Metadata</span>
      </a>
    </div>

    <!-- Task Definitions Section (Multi-Task Mode) -->
    <div id="tasks-nav-section" class="mb-6" style="display: none;">
      <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
        Task Definitions
      </h2>
      <a href="/ui/tasks" data-nav-item="tasks"
        class="nav-item flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
        </svg>
        <span>Tasks</span>
      </a>
      <a href="/ui/tasks/upload" data-nav-item="tasks-upload"
        class="nav-item flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white mt-1">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
        </svg>
        <span>Upload Task</span>
      </a>
      <a href="/ui/credentials" data-nav-item="credentials"
        class="nav-item flex items-center px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white mt-1">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z">
          </path>
        </svg>
        <span>Vault</span>
      </a>
    </div>
  </nav>

  <!-- Footer - Connection & Health Status -->
  <div class="p-4 border-t border-gray-700 space-y-2">
    <!-- Version Display -->
    <div class="flex items-center text-xs justify-between">
      <span class="text-gray-400">Task Framework</span>
      <span id="server-version" class="text-gray-500">v?.?.?</span>
    </div>
    <!-- Connection Status -->
    <div class="flex items-center text-xs">
      <div id="connection-status" class="flex items-center">
        <span class="w-2 h-2 bg-gray-500 rounded-full mr-2"></span>
        <span class="text-gray-400">Not configured</span>
      </div>
    </div>
    <!-- Health Status -->
    <div class="flex items-center text-xs">
      <div id="health-status" class="flex items-center">
        <svg class="w-3 h-3 mr-2 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd"
            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
            clip-rule="evenodd"></path>
        </svg>
        <span class="text-gray-400">Loading...</span>
      </div>
    </div>
  </div>
</aside>

<script>
  /**
   * Sidebar Component Initialization
   * This script runs when the sidebar is loaded via htmx
   */
  (function () {
    console.log("Sidebar component loaded");

    // Check proxy mode and update UI
    const isProxyMode = localStorage.getItem("tf_proxy_mode") === "true";
    updateModeUI(isProxyMode);

    // Populate server selector if in proxy mode
    if (isProxyMode) {
      populateServerSelector();
    }

    // Check for multi-task mode and show tasks section
    checkMultiTaskMode();

    // Highlight active navigation item based on current URL
    const currentPath = window.location.pathname;
    const navItems = document.querySelectorAll("[data-nav-item]");

    navItems.forEach((item) => {
      const navType = item.getAttribute("data-nav-item");
      item.classList.remove("bg-gray-700", "text-white");
      item.classList.add("text-gray-300");

      // Handle tasks and tasks-upload navigation highlighting
      if (navType === "tasks" && (currentPath === "/ui/tasks" || currentPath.startsWith("/ui/tasks/"))) {
        if (!currentPath.includes("/upload")) {
          item.classList.remove("text-gray-300");
          item.classList.add("bg-gray-700", "text-white");
        }
      } else if (navType === "tasks-upload" && currentPath.includes("/ui/tasks/upload")) {
        item.classList.remove("text-gray-300");
        item.classList.add("bg-gray-700", "text-white");
      } else if (currentPath.includes(`/ui/${navType}`)) {
        item.classList.remove("text-gray-300");
        item.classList.add("bg-gray-700", "text-white");
      }
    });

    // Update connection status
    const apiKey = localStorage.getItem("tf_api_key") || "";
    updateConnectionStatus(apiKey);

    // Update health status
    updateHealthStatus();

    // Refresh health status every 30 seconds
    setInterval(updateHealthStatus, 30000);
  })();

  /**
   * Update UI elements based on proxy mode
   */
  function updateModeUI(isProxy) {
    // Show/hide mode-specific elements
    document.querySelectorAll('[data-mode="proxy"]').forEach(el => {
      el.style.display = isProxy ? "block" : "none";
    });

    document.querySelectorAll('[data-mode="direct"]').forEach(el => {
      el.style.display = isProxy ? "none" : "block";
    });

    console.log("Mode UI updated:", isProxy ? "Proxy Mode" : "Direct Mode");
  }

  /**
   * Update connection status indicator
   */
  function updateConnectionStatus(apiKey) {
    const statusEl = document.getElementById("connection-status");
    if (!statusEl) return;

    if (apiKey) {
      statusEl.innerHTML = `
            <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
            <span class="text-green-400">Configured</span>
        `;
    } else {
      statusEl.innerHTML = `
            <span class="w-2 h-2 bg-gray-500 rounded-full mr-2"></span>
            <span class="text-gray-400">Not configured</span>
        `;
    }
  }

  /**
   * Update health status from API
   */
  async function updateHealthStatus() {
    try {
      const response = await fetch("/health");
      const health = await response.json();

      // Update version display
      const versionEl = document.getElementById("server-version");
      if (versionEl && health.version) {
        versionEl.textContent = `v${health.version}`;
        versionEl.classList.remove("text-gray-500");
        versionEl.classList.add("text-blue-400");
      }

      const healthStatusEl = document.getElementById("health-status");
      if (!healthStatusEl) return;

      const isHealthy = health.status === "ok";

      if (isHealthy) {
        healthStatusEl.innerHTML = `
                <svg class="w-3 h-3 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-green-400">Healthy</span>
            `;
      } else {
        healthStatusEl.innerHTML = `
                <svg class="w-3 h-3 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-red-400">Unhealthy</span>
            `;
      }
    } catch (error) {
      console.error("Error fetching health status:", error);

      const healthStatusEl = document.getElementById("health-status");
      if (!healthStatusEl) return;

      healthStatusEl.innerHTML = `
            <svg class="w-3 h-3 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-red-400">Error</span>
        `;
    }
  }

  /**
   * Populate server selector dropdown from discovery API
   */
  async function populateServerSelector() {
    const selector = document.getElementById("server-selector");
    const errorEl = document.getElementById("server-selector-error");
    const infoEl = document.getElementById("server-selector-info");

    if (!selector) return;

    try {
      console.log("Fetching servers from discovery API...");

      // Fetch servers from public discovery endpoint (no auth required)
      const response = await fetch("/servers");

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      const servers = data.servers || [];

      console.log(`Found ${servers.length} servers`);

      // Clear existing options
      selector.innerHTML = '<option value="">-- Select Server --</option>';

      if (servers.length === 0) {
        errorEl.textContent = "No servers available";
        errorEl.style.display = "block";
        infoEl.style.display = "none";
        return;
      }

      // Hide error, show info
      errorEl.style.display = "none";

      // Get currently selected server from localStorage
      const selectedId = localStorage.getItem("tf_selected_server");
      let hasValidSelection = false;

      // Populate dropdown with servers
      servers.forEach((server) => {
        const option = document.createElement("option");
        option.value = server.id;

        // Add health status icon
        const icon = getHealthIcon(server.status);
        option.textContent = `${icon} ${server.name || server.id}`;

        // Mark as selected if it matches localStorage
        if (server.id === selectedId) {
          option.selected = true;
          hasValidSelection = true;
          showServerInfo(server);
        }

        selector.appendChild(option);
      });

      // Auto-select first healthy server if no valid selection
      if (!hasValidSelection) {
        const healthyServer = servers.find((s) => s.status === "healthy");
        if (healthyServer) {
          selector.value = healthyServer.id;
          localStorage.setItem("tf_selected_server", healthyServer.id);
          showServerInfo(healthyServer);
          console.log("Auto-selected first healthy server:", healthyServer.id);
        }
      }

      // Listen for selection changes
      selector.addEventListener("change", handleServerChange);
    } catch (error) {
      console.error("Failed to fetch servers:", error);
      errorEl.textContent = "Failed to load servers";
      errorEl.style.display = "block";
      infoEl.style.display = "none";
    }
  }

  /**
   * Handle server selection change
   */
  function handleServerChange(event) {
    const serverId = event.target.value;

    if (!serverId) {
      localStorage.removeItem("tf_selected_server");
      document.getElementById("server-selector-info").style.display = "none";
      console.log("Server selection cleared");
      return;
    }

    localStorage.setItem("tf_selected_server", serverId);
    console.log("Selected server:", serverId);

    // Fetch and display server info
    fetchServerInfo(serverId);
  }

  /**
   * Fetch and display server info
   */
  async function fetchServerInfo(serverId) {
    try {
      const response = await fetch("/servers");
      const data = await response.json();
      const servers = data.servers || [];
      const server = servers.find((s) => s.id === serverId);

      if (server) {
        showServerInfo(server);
      }
    } catch (error) {
      console.error("Failed to fetch server info:", error);
    }
  }

  /**
   * Show server info below dropdown
   */
  function showServerInfo(server) {
    const infoEl = document.getElementById("server-selector-info");
    if (!infoEl) return;

    const taskTypes = (server.task_types || []).slice(0, 3).join(", ");
    const moreTypes = server.task_types && server.task_types.length > 3
      ? ` +${server.task_types.length - 3}`
      : "";

    infoEl.innerHTML = `
      <div class="text-xs">
        <div class="text-gray-400">Types: ${taskTypes}${moreTypes}</div>
      </div>
    `;
    infoEl.style.display = "block";
  }

  /**
   * Get health icon for status
   */
  function getHealthIcon(status) {
    const icons = {
      healthy: "ðŸŸ¢",
      unhealthy: "ðŸ”´",
      unknown: "âšª",
      draining: "ðŸŸ¡",
    };
    return icons[status] || "âšª";
  }

  /**
   * Check if server is in multi-task mode and show tasks navigation section
   * Multi-task mode is detected by checking if there are tasks registered via /admin/tasks
   */
  async function checkMultiTaskMode() {
    const tasksNavSection = document.getElementById("tasks-nav-section");
    if (!tasksNavSection) return;

    try {
      // Try to fetch task definitions - if endpoint exists and returns tasks, we're in multi-task mode
      const apiKey = localStorage.getItem("tf_api_key") || localStorage.getItem("apiKey") || "";

      const response = await fetch("/admin/tasks", {
        headers: {
          "X-API-Key": apiKey,
          "Content-Type": "application/json"
        }
      });

      if (response.ok) {
        const tasks = await response.json();

        // Show tasks section if there are any tasks OR if endpoint is available (multi-task mode enabled)
        // The endpoint existing indicates multi-task mode is enabled
        tasksNavSection.style.display = "block";
        console.log("Multi-task mode detected, tasks section enabled. Tasks count:", Array.isArray(tasks) ? tasks.length : 0);
      } else if (response.status === 401 || response.status === 403) {
        // Auth error but endpoint exists - show the section anyway
        // User will get auth errors when they click but at least they can see the option
        tasksNavSection.style.display = "block";
        console.log("Multi-task mode detected (auth required)");
      } else {
        // Endpoint doesn't exist or server error - hide the section
        tasksNavSection.style.display = "none";
        console.log("Single-task mode detected (no /admin/tasks endpoint)");
      }
    } catch (error) {
      // Network error or endpoint doesn't exist
      console.log("Could not detect multi-task mode:", error.message);
      // Default to hiding in case of errors - single task mode is the default
      tasksNavSection.style.display = "none";
    }
  }
</script>