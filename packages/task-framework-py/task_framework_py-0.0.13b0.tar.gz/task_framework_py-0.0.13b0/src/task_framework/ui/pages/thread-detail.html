<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thread Details - Task Framework</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- htmx via CDN -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>

  <!-- Custom styles -->
  <style>
    .nav-item {
      transition: all 0.2s ease-in-out;
    }

    .nav-item:hover {
      transform: translateX(4px);
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #1f2937;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #6b7280;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    /* State badge colors */
    .state-queued {
      background-color: #eab308;
    }

    .state-running {
      background-color: #3b82f6;
    }

    .state-succeeded {
      background-color: #22c55e;
    }

    .state-failed {
      background-color: #ef4444;
    }

    .state-stopped {
      background-color: #6b7280;
    }

    .state-timeout {
      background-color: #f97316;
    }

    .state-expired {
      background-color: #8b5cf6;
    }

    /* Kind badge colors */
    .kind-text {
      background-color: #3b82f6;
    }

    .kind-rich_text {
      background-color: #6366f1;
    }

    .kind-json {
      background-color: #8b5cf6;
    }

    .kind-file {
      background-color: #22c55e;
    }

    .kind-binary {
      background-color: #14b8a6;
    }

    .kind-url {
      background-color: #f59e0b;
    }

    .kind-bundle {
      background-color: #ef4444;
    }

    .kind-metrics {
      background-color: #ec4899;
    }

    .kind-log {
      background-color: #6b7280;
    }
  </style>
</head>

<body class="h-full bg-gray-50">
  <!-- API Utilities (loaded via htmx) -->
  <div hx-get="/ui/components/api-utils.html" hx-trigger="load" hx-swap="outerHTML"></div>

  <div class="flex h-screen overflow-hidden">
    <!-- Left Sidebar (loaded via htmx) -->
    <div hx-get="/ui/components/sidebar.html" hx-trigger="load" hx-swap="outerHTML">
      <!-- Loading placeholder -->
      <aside class="w-64 bg-gray-800 text-white flex items-center justify-center">
        <div class="text-gray-400 text-sm">Loading...</div>
      </aside>
    </div>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto">
      <!-- Top Bar -->
      <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="px-6 py-4">
          <div class="flex items-center text-sm text-gray-600 mb-2">
            <a href="/ui/threads" class="hover:text-blue-600">Threads</a>
            <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            <span id="thread-id-breadcrumb">Loading...</span>
          </div>
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-semibold text-gray-800">
                Thread Details
              </h2>
              <p class="text-sm text-gray-600 mt-1">
                View thread information, inputs, and outputs
              </p>
            </div>
            <div id="thread-actions" class="flex space-x-2">
              <!-- Actions will be dynamically inserted -->
            </div>
          </div>
        </div>
      </div>

      <!-- Thread Content -->
      <div class="p-6">
        <!-- Loading State -->
        <div id="loading-state" class="text-center py-12">
          <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
          <p class="text-gray-600 mt-4">Loading thread details...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden">
          <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
            <svg class="w-12 h-12 text-red-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h3 class="text-lg font-semibold text-red-900 mb-2">
              Error Loading Thread
            </h3>
            <p id="error-message" class="text-red-700 mb-4"></p>
            <a href="/ui/threads" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg inline-block">
              Back to Threads
            </a>
          </div>
        </div>

        <!-- Thread Details -->
        <div id="thread-details" class="hidden space-y-6 fade-in">
          <!-- Overview Card -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-sm font-medium text-gray-500">Name</label>
                <p id="detail-name" class="text-gray-800 font-medium"></p>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-500">Thread ID</label>
                <p id="detail-id" class="text-gray-800 font-mono"></p>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-500">State</label>
                <div id="detail-state"></div>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-500">Created At</label>
                <p id="detail-created" class="text-gray-800"></p>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-500">Started At</label>
                <p id="detail-started" class="text-gray-800"></p>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-500">Finished At</label>
                <p id="detail-finished" class="text-gray-800"></p>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-500">Duration</label>
                <p id="detail-duration" class="text-gray-800"></p>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-500">Run ID</label>
                <p id="detail-run-id" class="text-gray-800 font-mono"></p>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-500">Schedule ID</label>
                <div id="detail-schedule-id" class="text-gray-800 font-mono"></div>
              </div>
              <!-- Task Info (shown in multi-task mode) -->
              <div id="task-info-container" style="display: none;">
                <label class="text-sm font-medium text-gray-500">Task</label>
                <div id="detail-task" class="flex items-center gap-2">
                  <a id="task-link" href="#"
                    class="inline-flex items-center px-2.5 py-1 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    <span id="task-name"></span>
                  </a>
                  <span id="task-version"
                    class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Error Card (shown only if thread failed) -->
          <div id="error-card" class="hidden bg-red-50 border border-red-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-red-900 mb-4">
              Error Details
            </h3>
            <div class="space-y-2">
              <div>
                <label class="text-sm font-medium text-red-700">Error Code</label>
                <p id="detail-error-code" class="text-red-900 font-mono"></p>
              </div>
              <div>
                <label class="text-sm font-medium text-red-700">Error Message</label>
                <p id="detail-error-message" class="text-red-900"></p>
              </div>
            </div>
          </div>

          <!-- Metadata Card -->
          <div id="metadata-card" class="hidden bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Metadata</h3>
            <pre id="detail-metadata" class="bg-gray-50 p-4 rounded text-sm font-mono overflow-x-auto"></pre>
          </div>

          <!-- Inputs Card -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-gray-800">Inputs</h3>
              <span id="inputs-count" class="text-sm text-gray-600"></span>
            </div>
            <div id="inputs-list" class="space-y-3">
              <!-- Inputs will be dynamically inserted -->
            </div>
          </div>

          <!-- Outputs Card -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-gray-800">Outputs</h3>
              <span id="outputs-count" class="text-sm text-gray-600"></span>
            </div>
            <div id="outputs-list" class="space-y-3">
              <!-- Outputs will be dynamically inserted -->
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Artifact Detail Modal -->
  <div id="artifact-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    onclick="hideArtifactModal(event)">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"
      onclick="event.stopPropagation()">
      <!-- Modal Header -->
      <div class="border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 bg-white">
        <h3 id="modal-title" class="text-xl font-semibold text-gray-800">
          Artifact Details
        </h3>
        <button onclick="hideArtifactModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Modal Body -->
      <div id="modal-body" class="px-6 py-6">
        <!-- Content will be inserted by JavaScript -->
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // STORAGE_KEYS is now defined in api-utils.html

    // Global variable to store thread ID
    let threadId = null;

    /**
     * Wait for API utilities to be loaded
     */
    function waitForApiUtils() {
      return new Promise((resolve) => {
        if (typeof apiFetch !== "undefined") {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (typeof apiFetch !== "undefined") {
              clearInterval(checkInterval);
              resolve();
            }
          }, 50);
        }
      });
    }

    /**
     * Initialize the page
     */
    document.addEventListener("DOMContentLoaded", async function () {
      // Wait for API utilities to load
      await waitForApiUtils();

      // Get thread ID from URL
      threadId = window.location.pathname.split("/").pop();
      console.log("Thread detail page initialized for:", threadId);

      // Update connection status
      const apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY) || "";

      // Check if API key is configured
      if (!apiKey) {
        showError(
          "API Key not configured. Please go to Settings to configure your credentials."
        );
        return;
      }

      // Load thread details
      loadThreadDetails();
    });

    /**
     * Load thread details from API
     */
    async function loadThreadDetails() {
      console.log("Loading thread details for:", threadId);

      try {
        const response = await apiFetch(`/threads/${threadId}`);

        console.log("Thread details response status:", response.status);

        const thread = await response.json();
        console.log("Thread loaded:", thread);
        displayThreadDetails(thread);
      } catch (error) {
        console.error("Error loading thread details:", error);
        showError(error.message);
      }
    }

    /**
     * Display thread details
     */
    function displayThreadDetails(thread) {
      // Hide loading, show details
      document.getElementById("loading-state").classList.add("hidden");
      document.getElementById("error-state").classList.add("hidden");
      document.getElementById("thread-details").classList.remove("hidden");

      // Update breadcrumb
      document.getElementById("thread-id-breadcrumb").textContent = thread.id;

      // Overview section
      document.getElementById("detail-name").textContent = thread.name || "-";
      document.getElementById("detail-id").textContent = thread.id;

      const stateClass = `state-${thread.state}`;
      document.getElementById(
        "detail-state"
      ).innerHTML = `<span class="inline-block px-3 py-1 text-sm font-semibold text-white rounded ${stateClass}">${thread.state}</span>`;

      document.getElementById("detail-created").textContent = formatDateTime(
        thread.created_at
      );
      document.getElementById("detail-started").textContent = formatDateTime(
        thread.started_at
      );
      document.getElementById("detail-finished").textContent = formatDateTime(
        thread.finished_at
      );
      document.getElementById("detail-duration").textContent =
        calculateDuration(thread.started_at, thread.finished_at);

      // Run ID and Schedule ID: check top-level fields first, then fallback to metadata
      const runId = thread.run_id || thread.metadata?.run_id || null;
      const scheduleId = thread.schedule_id || thread.metadata?.schedule_id || null;
      document.getElementById("detail-run-id").textContent = runId || "-";

      // Make Schedule ID a clickable link if present
      const scheduleIdContainer = document.getElementById("detail-schedule-id");
      if (scheduleId) {
        scheduleIdContainer.innerHTML = `<a href="/ui/schedules/${encodeURIComponent(scheduleId)}" class="text-blue-600 hover:underline">${scheduleId}</a>`;
      } else {
        scheduleIdContainer.textContent = "-";
      }

      // Task info (from metadata if available)
      const taskId = thread.metadata?.task_id || thread.task_id;
      const taskVersion = thread.metadata?.task_version || thread.task_version;

      if (taskId) {
        document.getElementById("task-info-container").style.display = "block";
        document.getElementById("task-name").textContent = taskId;
        document.getElementById("task-version").textContent = taskVersion ? `v${taskVersion}` : '';

        // Set link to task details
        const taskLink = document.getElementById("task-link");
        if (taskVersion) {
          taskLink.href = `/ui/tasks/${encodeURIComponent(taskId)}/${encodeURIComponent(taskVersion)}`;
        } else {
          taskLink.href = `/ui/tasks?task_id=${encodeURIComponent(taskId)}`;
        }
      }

      // Action buttons
      const actions = [];
      if (thread.state === "running") {
        actions.push(`
                    <button onclick="stopThread()" 
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium">
                        Stop Thread
                    </button>
                `);
      }
      if (["failed", "stopped", "timeout"].includes(thread.state)) {
        actions.push(`
                    <button onclick="retryThread()" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium">
                        Retry Thread
                    </button>
                `);
      }
      // Artifacts link
      actions.push(`
                <a href="/ui/threads/${thread.id}/artifacts" 
                   class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Manage Artifacts
                </a>
            `);
      actions.push(`
                <button onclick="loadThreadDetails()" 
                        class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium">
                    Refresh
                </button>
            `);
      document.getElementById("thread-actions").innerHTML = actions.join("");

      // Error section (if failed)
      if (thread.error) {
        document.getElementById("error-card").classList.remove("hidden");
        document.getElementById("detail-error-code").textContent =
          thread.error.code || "-";
        document.getElementById("detail-error-message").textContent =
          thread.error.message || "-";
      }

      // Metadata section
      if (thread.metadata && Object.keys(thread.metadata).length > 0) {
        document.getElementById("metadata-card").classList.remove("hidden");
        document.getElementById("detail-metadata").textContent =
          JSON.stringify(thread.metadata, null, 2);
      }

      // Inputs section
      const inputs = thread.inputs || [];
      document.getElementById("inputs-count").textContent = `${inputs.length
        } input${inputs.length !== 1 ? "s" : ""}`;
      if (inputs.length > 0) {
        document.getElementById("inputs-list").innerHTML = inputs
          .map((artifact) => createArtifactCard(artifact))
          .join("");
      } else {
        document.getElementById("inputs-list").innerHTML =
          '<p class="text-gray-500 text-sm">No inputs</p>';
      }

      // Outputs section
      const outputs = thread.outputs || [];
      document.getElementById("outputs-count").textContent = `${outputs.length
        } output${outputs.length !== 1 ? "s" : ""}`;
      if (outputs.length > 0) {
        document.getElementById("outputs-list").innerHTML = outputs
          .map((artifact) => createArtifactCard(artifact))
          .join("");
      } else {
        document.getElementById("outputs-list").innerHTML =
          '<p class="text-gray-500 text-sm">No outputs yet</p>';
      }
    }

    /**
     * Create an artifact card HTML
     */
    function createArtifactCard(artifact) {
      const kindClass = `kind-${artifact.kind}`;

      let content = "";
      if (artifact.kind === "text" && artifact.text) {
        const truncated =
          artifact.text.length > 200
            ? artifact.text.substring(0, 200) + "..."
            : artifact.text;
        content = `<p class="text-sm text-gray-700 mt-2 bg-gray-50 p-3 rounded">${escapeHtml(
          truncated
        )}</p>`;
      } else if (artifact.kind === "json" && artifact.value) {
        const jsonStr = JSON.stringify(artifact.value, null, 2);
        const truncated =
          jsonStr.length > 200
            ? jsonStr.substring(0, 200) + "..."
            : jsonStr;
        content = `<pre class="text-sm text-gray-700 mt-2 bg-gray-50 p-3 rounded overflow-x-auto">${escapeHtml(
          truncated
        )}</pre>`;
      } else if (artifact.kind === "file" && artifact.file_ref) {
        content = `<p class="text-sm text-gray-700 mt-2">File: <code class="bg-gray-100 px-2 py-1 rounded">${artifact.file_ref}</code></p>`;
      } else if (artifact.kind === "url" && artifact.url) {
        content = `<p class="text-sm text-gray-700 mt-2"><a href="${artifact.url}" target="_blank" class="text-blue-600 hover:underline break-all">${artifact.url}</a></p>`;
      }

      return `
                <div class="border border-gray-200 rounded-lg p-4 hover:border-gray-300 transition-colors">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <span class="px-2 py-1 text-xs font-semibold text-white rounded ${kindClass}">${artifact.kind
        }</span>
                            <span class="font-medium text-gray-800 truncate">${artifact.ref || artifact.id || "Unnamed"
        }</span>
                            ${artifact.media_type
          ? `<span class="text-xs text-gray-500">${artifact.media_type}</span>`
          : ""
        }
                        </div>
                        <button
                            onclick="viewArtifactDetails('${artifact.id}')"
                            class="ml-2 p-2 text-gray-400 hover:text-blue-600 transition-colors"
                            title="View details"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    ${content}
                    ${artifact.explain
          ? `<p class="text-xs text-gray-500 mt-2 italic">${escapeHtml(
            artifact.explain
          )}</p>`
          : ""
        }
                </div>
            `;
    }

    /**
     * Stop the thread
     */
    async function stopThread() {
      if (!confirm(`Are you sure you want to stop this thread?`)) {
        return;
      }

      try {
        const response = await apiFetch(`/threads/${threadId}:stop`, {
          method: "POST",
        });

        console.log("Thread stopped");

        // Reload thread details
        setTimeout(() => loadThreadDetails(), 1000);
      } catch (error) {
        console.error("Error stopping thread:", error);
        alert(`Failed to stop thread: ${error.message}`);
      }
    }

    /**
     * Retry the thread
     */
    async function retryThread() {
      if (!confirm(`Create a new retry attempt for this thread?`)) {
        return;
      }

      try {
        const response = await apiFetch(`/threads/${threadId}:retry`, {
          method: "POST",
        });

        const newThread = await response.json();
        console.log("Thread retry created:", newThread);

        // Navigate to new thread
        window.location.href = `/ui/threads/${newThread.id}`;
      } catch (error) {
        console.error("Error retrying thread:", error);
        alert(`Failed to retry thread: ${error.message}`);
      }
    }

    /**
     * View artifact details in modal
     */
    async function viewArtifactDetails(artifactId) {
      try {
        const response = await apiFetch(`/artifacts/${artifactId}`);

        const artifact = await response.json();
        displayArtifactInModal(artifact);
      } catch (error) {
        console.error("Error loading artifact details:", error);
        alert(`Failed to load artifact: ${error.message}`);
      }
    }

    /**
     * Display artifact in modal
     */
    function displayArtifactInModal(artifact) {
      document.getElementById("modal-title").textContent =
        `Artifact: ${artifact.ref || artifact.id}`;

      const kindClass = `kind-${artifact.kind}`;

      let content = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-medium text-gray-500">ID</label>
                            <p class="text-gray-800 font-mono text-sm break-all">${artifact.id}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-500">Reference</label>
                            <p class="text-gray-800">${artifact.ref || "N/A"}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-500">Kind</label>
                            <span class="inline-block px-2 py-1 text-xs font-semibold text-white rounded ${kindClass}">${artifact.kind}</span>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-500">Media Type</label>
                            <p class="text-gray-800">${artifact.media_type || "N/A"
        }</p>
                        </div>
                        ${artifact.size
          ? `
                            <div>
                                <label class="text-sm font-medium text-gray-500">Size</label>
                                <p class="text-gray-800">${formatSize(
            artifact.size
          )}</p>
                            </div>
                        `
          : ""
        }
                        ${artifact.sha256
          ? `
                            <div>
                                <label class="text-sm font-medium text-gray-500">SHA256</label>
                                <p class="text-gray-800 font-mono text-xs break-all">${artifact.sha256}</p>
                            </div>
                        `
          : ""
        }
                        ${artifact.created_at
          ? `
                            <div>
                                <label class="text-sm font-medium text-gray-500">Created At</label>
                                <p class="text-gray-800">${formatDateTime(
            artifact.created_at
          )}</p>
                            </div>
                        `
          : ""
        }
                        ${artifact.filename
          ? `
                            <div>
                                <label class="text-sm font-medium text-gray-500">Filename</label>
                                <p class="text-gray-800">${artifact.filename}</p>
                            </div>
                        `
          : ""
        }
                        ${artifact.thread_id
          ? `
                            <div>
                                <label class="text-sm font-medium text-gray-500">Thread ID</label>
                                <p class="text-gray-800 font-mono text-sm">${artifact.thread_id}</p>
                            </div>
                        `
          : ""
        }
                    </div>
                    
                    ${artifact.explain
          ? `
                        <div>
                            <label class="text-sm font-medium text-gray-500">Explanation</label>
                            <p class="text-gray-800">${escapeHtml(
            artifact.explain
          )}</p>
                        </div>
                    `
          : ""
        }
                    
                    <div>
                        <label class="text-sm font-medium text-gray-500 mb-2 block">Content</label>
            `;

      // Add content based on kind
      if (artifact.kind === "text" || artifact.kind === "rich_text") {
        content += `<div class="bg-gray-50 p-4 rounded text-sm whitespace-pre-wrap max-h-96 overflow-y-auto">${escapeHtml(
          artifact.text || "No content"
        )}</div>`;
      } else if (artifact.kind === "json" || artifact.kind === "metrics") {
        content += `<pre class="bg-gray-50 p-4 rounded text-sm overflow-x-auto max-h-96 overflow-y-auto">${JSON.stringify(
          artifact.value,
          null,
          2
        )}</pre>`;
      } else if (artifact.kind === "file" || artifact.kind === "binary") {
        content += `<div class="bg-gray-50 p-4 rounded text-sm">
                    <p>File Reference: <code class="bg-gray-200 px-2 py-1 rounded">${artifact.file_ref}</code></p>
                    <p class="mt-2 text-gray-600">Use the file storage API to download this file.</p>
                </div>`;
      } else if (artifact.kind === "url") {
        content += `<div class="bg-gray-50 p-4 rounded text-sm">
                    <a href="${artifact.url}" target="_blank" class="text-blue-600 hover:underline break-all">${artifact.url}</a>
                </div>`;
      } else {
        content += `<div class="bg-gray-50 p-4 rounded text-sm text-gray-600">No preview available for this artifact type</div>`;
      }

      content += `</div></div>`;

      document.getElementById("modal-body").innerHTML = content;
      document.getElementById("artifact-modal").classList.remove("hidden");
    }

    /**
     * Hide artifact modal
     */
    function hideArtifactModal(event) {
      if (!event || event.target.id === "artifact-modal") {
        document.getElementById("artifact-modal").classList.add("hidden");
      }
    }

    /**
     * Utility functions
     */
    function formatSize(bytes) {
      if (!bytes) return "N/A";
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + " KB";
      if (bytes < 1024 * 1024 * 1024)
        return (bytes / (1024 * 1024)).toFixed(2) + " MB";
      return (bytes / (1024 * 1024 * 1024)).toFixed(2) + " GB";
    }

    function formatDateTime(dateString) {
      if (!dateString) return "-";
      const date = new Date(dateString);
      return date.toLocaleString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
    }

    function calculateDuration(startTime, endTime) {
      if (!startTime || !endTime) return "-";
      const start = new Date(startTime);
      const end = new Date(endTime);
      const durationMs = end - start;

      const seconds = Math.floor(durationMs / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);

      if (hours > 0) {
        return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
      } else if (minutes > 0) {
        return `${minutes}m ${seconds % 60}s`;
      } else {
        return `${seconds}s`;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    function showError(message) {
      document.getElementById("loading-state").classList.add("hidden");
      document.getElementById("error-state").classList.remove("hidden");
      document.getElementById("thread-details").classList.add("hidden");
      document.getElementById("error-message").textContent = message;
    }

    /**
     * Update health status from API
     */
    async function updateHealthStatus() {
      try {
        const response = await fetch("/health");
        const health = await response.json();

        // Update overall health status in footer
        const healthStatusEl = document.getElementById("health-status");
        const isHealthy = health.status === "ok";

        if (isHealthy) {
          healthStatusEl.innerHTML = `
                        <svg class="w-3 h-3 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-green-400">Healthy</span>
                    `;
        } else {
          healthStatusEl.innerHTML = `
                        <svg class="w-3 h-3 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-red-400">Unhealthy</span>
                    `;
        }
      } catch (error) {
        console.error("Error fetching health status:", error);

        // Update health status to error
        const healthStatusEl = document.getElementById("health-status");
        healthStatusEl.innerHTML = `
                    <svg class="w-3 h-3 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-red-400">Error</span>
                `;
      }
    }
  </script>
</body>

</html>