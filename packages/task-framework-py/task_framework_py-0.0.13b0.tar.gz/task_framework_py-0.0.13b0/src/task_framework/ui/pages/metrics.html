<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrics - Task Framework</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- htmx via CDN -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Custom styles -->
    <style>
        .nav-item {
            transition: all 0.2s ease-in-out;
        }
        .nav-item:hover {
            transform: translateX(4px);
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .metric-card {
            transition: all 0.2s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="h-full bg-gray-50">
    <!-- API Utilities (loaded via htmx) -->
    <div
      hx-get="/ui/components/api-utils.html"
      hx-trigger="load"
      hx-swap="outerHTML"
    ></div>

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar component (loaded via htmx) -->
        <div hx-get="/ui/components/sidebar.html" hx-trigger="load" hx-swap="outerHTML">
            <aside class="w-64 bg-gray-800 text-white flex items-center justify-center">
                <div class="text-gray-400 text-sm">Loading...</div>
            </aside>
        </div>
        
        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <!-- Top Bar -->
            <div class="bg-white shadow-sm border-b border-gray-200">
                <div class="px-6 py-4 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-800">System Metrics</h2>
                        <p class="text-sm text-gray-600 mt-1">
                            Prometheus metrics dashboard with real-time monitoring
                        </p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <!-- Auto-refresh toggle -->
                        <label class="flex items-center cursor-pointer">
                            <input 
                                type="checkbox" 
                                id="auto-refresh"
                                checked
                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                            />
                            <span class="ml-2 text-sm text-gray-700">Auto-refresh (30s)</span>
                        </label>
                        <!-- Refresh button -->
                        <button 
                            onclick="loadMetrics()"
                            class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Metrics Content -->
            <div class="p-6">
                <!-- Loading State -->
                <div id="loading-state" class="text-center py-12">
                    <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-600 mt-4">Loading metrics...</p>
                </div>
                
                <!-- Error State -->
                <div id="error-state" class="hidden">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <svg class="w-12 h-12 text-red-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-red-900 mb-2">Error Loading Metrics</h3>
                        <p id="error-message" class="text-red-700 mb-4"></p>
                        <button onclick="loadMetrics()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                            Try Again
                        </button>
                    </div>
                </div>
                
                <!-- Metrics Container -->
                <div id="metrics-container" class="hidden space-y-6 fade-in">
                    <!-- Summary Cards -->
                    <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- Summary cards will be inserted here -->
                    </div>
                    
                    <!-- Metrics Categories -->
                    <div id="metrics-categories" class="space-y-6">
                        <!-- Metric category sections will be inserted here -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- JavaScript -->
    <script>
        // STORAGE_KEYS is now defined in api-utils.html
        
        let refreshInterval = null;
      /**
       * Wait for API utilities to be loaded
       */
      function waitForApiUtils() {
        return new Promise((resolve) => {
          if (typeof apiFetch !== "undefined") {
            resolve();
          } else {
            const checkInterval = setInterval(() => {
              if (typeof apiFetch !== "undefined") {
                clearInterval(checkInterval);
                resolve();
              }
            }, 50);
          }
        });
      }


        
        /**
         * Initialize the page
         */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Metrics page initialized');
            
            // Load metrics
            loadMetrics();
            
            // Setup auto-refresh
            setupAutoRefresh();
            
            // Auto-refresh toggle handler
            document.getElementById('auto-refresh').addEventListener('change', setupAutoRefresh);
        });
        
        /**
         * Setup auto-refresh
         */
        function setupAutoRefresh() {
            // Clear existing interval
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            
            // Setup new interval if enabled
            const autoRefresh = document.getElementById('auto-refresh').checked;
            if (autoRefresh) {
                refreshInterval = setInterval(loadMetrics, 30000); // 30 seconds
            }
        }
        
        /**
         * Load metrics from API
         */
        async function loadMetrics() {
            console.log('Loading metrics...');
            showLoading();
            
            try {
                const response = await fetch('/metrics', {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/plain'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const metricsText = await response.text();
                const parsedMetrics = parsePrometheusMetrics(metricsText);
                displayMetrics(parsedMetrics);
                
            } catch (error) {
                console.error('Error loading metrics:', error);
                showError(error.message);
            }
        }
        
        /**
         * Parse Prometheus metrics format
         */
        function parsePrometheusMetrics(text) {
            const lines = text.trim().split('\n');
            const metrics = {};
            let currentMetric = null;
            let currentHelp = '';
            let currentType = '';
            
            for (const line of lines) {
                // Skip empty lines
                if (!line.trim()) continue;
                
                // Parse HELP comment
                if (line.startsWith('# HELP ')) {
                    const parts = line.substring(7).split(' ');
                    currentMetric = parts[0];
                    currentHelp = parts.slice(1).join(' ');
                }
                // Parse TYPE comment
                else if (line.startsWith('# TYPE ')) {
                    const parts = line.substring(7).split(' ');
                    currentMetric = parts[0];
                    currentType = parts[1];
                    
                    if (!metrics[currentMetric]) {
                        metrics[currentMetric] = {
                            name: currentMetric,
                            help: currentHelp,
                            type: currentType,
                            values: []
                        };
                    }
                }
                // Parse metric value
                else if (!line.startsWith('#')) {
                    const match = line.match(/^([a-zA-Z_:][a-zA-Z0-9_:]*(?:\{[^}]+\})?)\s+(.+)$/);
                    if (match) {
                        const fullName = match[1];
                        const value = parseFloat(match[2]);
                        
                        // Extract base name and labels
                        const labelMatch = fullName.match(/^([a-zA-Z_:][a-zA-Z0-9_:]*)(?:\{([^}]+)\})?$/);
                        if (labelMatch) {
                            const baseName = labelMatch[1];
                            const labelsStr = labelMatch[2];
                            const labels = {};
                            
                            if (labelsStr) {
                                const labelPairs = labelsStr.match(/([a-zA-Z_][a-zA-Z0-9_]*)="([^"]*)"/g);
                                if (labelPairs) {
                                    labelPairs.forEach(pair => {
                                        const [key, val] = pair.split('="');
                                        labels[key] = val.slice(0, -1);
                                    });
                                }
                            }
                            
                            if (metrics[baseName]) {
                                metrics[baseName].values.push({ labels, value });
                            }
                        }
                    }
                }
            }
            
            return metrics;
        }
        
        /**
         * Display parsed metrics
         */
        function displayMetrics(metrics) {
            // Group metrics by category
            const categories = {
                'Python Runtime': [],
                'Process': [],
                'Task Framework - Threads': [],
                'Task Framework - API': [],
                'Task Framework - Artifacts': [],
                'Task Framework - Files': [],
                'Task Framework - Scheduler': [],
                'Task Framework - Webhooks': [],
                'Task Framework - Workers': [],
                'Task Framework - Metadata': []
            };
            
            for (const [name, metric] of Object.entries(metrics)) {
                if (name.startsWith('python_')) {
                    categories['Python Runtime'].push(metric);
                } else if (name.startsWith('process_')) {
                    categories['Process'].push(metric);
                } else if (name.startsWith('task_framework_threads')) {
                    categories['Task Framework - Threads'].push(metric);
                } else if (name.startsWith('task_framework_api')) {
                    categories['Task Framework - API'].push(metric);
                } else if (name.startsWith('task_framework_artifacts')) {
                    categories['Task Framework - Artifacts'].push(metric);
                } else if (name.startsWith('task_framework_file')) {
                    categories['Task Framework - Files'].push(metric);
                } else if (name.startsWith('task_framework_schedule')) {
                    categories['Task Framework - Scheduler'].push(metric);
                } else if (name.startsWith('task_framework_webhook')) {
                    categories['Task Framework - Webhooks'].push(metric);
                } else if (name.startsWith('task_framework_workers')) {
                    categories['Task Framework - Workers'].push(metric);
                } else if (name.startsWith('task_framework_metadata')) {
                    categories['Task Framework - Metadata'].push(metric);
                } else if (name.startsWith('task_framework_library') || name.startsWith('task_framework_task_function')) {
                    categories['Task Framework - Threads'].push(metric);
                }
            }
            
            // Create summary cards
            createSummaryCards(metrics, categories);
            
            // Create category sections
            const container = document.getElementById('metrics-categories');
            container.innerHTML = '';
            
            for (const [category, categoryMetrics] of Object.entries(categories)) {
                if (categoryMetrics.length > 0) {
                    container.innerHTML += createCategorySection(category, categoryMetrics);
                }
            }
            
            showContent();
        }
        
        /**
         * Create summary cards
         */
        function createSummaryCards(metrics, categories) {
            const container = document.getElementById('summary-cards');
            const summaries = [
                {
                    title: 'Total Categories',
                    value: Object.values(categories).filter(c => c.length > 0).length,
                    icon: 'ðŸ“Š',
                    color: 'blue'
                },
                {
                    title: 'Total Metrics',
                    value: Object.keys(metrics).length,
                    icon: 'ðŸ“ˆ',
                    color: 'green'
                },
                {
                    title: 'Active Threads',
                    value: getMetricValue(metrics, 'task_framework_threads_current'),
                    icon: 'ðŸ§µ',
                    color: 'purple'
                },
                {
                    title: 'Active Workers',
                    value: getMetricValue(metrics, 'task_framework_workers_active'),
                    icon: 'ðŸ‘·',
                    color: 'orange'
                }
            ];
            
            container.innerHTML = summaries.map(summary => `
                <div class="bg-white rounded-lg shadow-md p-6 metric-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">${summary.title}</p>
                            <p class="text-3xl font-bold text-gray-900 mt-2">${summary.value}</p>
                        </div>
                        <div class="text-4xl">${summary.icon}</div>
                    </div>
                </div>
            `).join('');
        }
        
        /**
         * Get metric value
         */
        function getMetricValue(metrics, name) {
            if (!metrics[name] || metrics[name].values.length === 0) return 0;
            return metrics[name].values[0].value || 0;
        }
        
        /**
         * Create category section HTML
         */
        function createCategorySection(category, metrics) {
            return `
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">${category}</h3>
                        <p class="text-sm text-gray-600 mt-1">${metrics.length} metric(s)</p>
                    </div>
                    <div class="p-6 space-y-4">
                        ${metrics.map(metric => createMetricCard(metric)).join('')}
                    </div>
                </div>
            `;
        }
        
        /**
         * Create metric card HTML
         */
        function createMetricCard(metric) {
            const typeColors = {
                'counter': 'bg-blue-100 text-blue-800',
                'gauge': 'bg-green-100 text-green-800',
                'histogram': 'bg-purple-100 text-purple-800',
                'summary': 'bg-yellow-100 text-yellow-800'
            };
            
            const typeColor = typeColors[metric.type] || 'bg-gray-100 text-gray-800';
            
            return `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex-1">
                            <div class="flex items-center">
                                <code class="text-sm font-mono text-gray-800">${metric.name}</code>
                                <span class="ml-2 px-2 py-1 text-xs font-semibold rounded ${typeColor}">
                                    ${metric.type}
                                </span>
                            </div>
                            ${metric.help ? `<p class="text-sm text-gray-600 mt-1">${metric.help}</p>` : ''}
                        </div>
                    </div>
                    <div class="mt-3">
                        ${createMetricValues(metric)}
                    </div>
                </div>
            `;
        }
        
        /**
         * Create metric values display
         */
        function createMetricValues(metric) {
            if (metric.values.length === 0) {
                return '<p class="text-sm text-gray-500 italic">No data</p>';
            }
            
            // For histograms, group by bucket
            if (metric.type === 'histogram') {
                return createHistogramDisplay(metric);
            }
            
            // For simple metrics (single value, no labels)
            if (metric.values.length === 1 && Object.keys(metric.values[0].labels).length === 0) {
                return `<div class="text-2xl font-bold text-gray-900">${formatValue(metric.values[0].value)}</div>`;
            }
            
            // For metrics with labels (multiple values)
            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                ${Object.keys(metric.values[0].labels).length > 0 ? '<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Labels</th>' : ''}
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Value</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${metric.values.map(v => `
                                <tr>
                                    ${Object.keys(v.labels).length > 0 ? `<td class="px-3 py-2 text-gray-700">${formatLabels(v.labels)}</td>` : ''}
                                    <td class="px-3 py-2 font-mono text-gray-900">${formatValue(v.value)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        /**
         * Create histogram display
         */
        function createHistogramDisplay(metric) {
            const buckets = metric.values.filter(v => v.labels.le && v.labels.le !== '+Inf');
            const count = metric.values.find(v => !v.labels.le && Object.keys(v.labels).length === 0);
            const sum = metric.values.find(v => !v.labels.le && Object.keys(v.labels).length === 0);
            
            if (buckets.length === 0) {
                return '<p class="text-sm text-gray-500 italic">No histogram data</p>';
            }
            
            const maxValue = Math.max(...buckets.map(b => b.value));
            
            return `
                <div class="space-y-2">
                    ${buckets.map(bucket => {
                        const percentage = maxValue > 0 ? (bucket.value / maxValue) * 100 : 0;
                        return `
                            <div>
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>â‰¤ ${bucket.labels.le}${getUnit(metric.name)}</span>
                                    <span class="font-mono">${formatValue(bucket.value)}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        /**
         * Get unit from metric name
         */
        function getUnit(name) {
            if (name.includes('_seconds')) return 's';
            if (name.includes('_bytes')) return 'B';
            return '';
        }
        
        /**
         * Format labels for display
         */
        function formatLabels(labels) {
            return Object.entries(labels)
                .map(([key, value]) => `<span class="inline-block bg-gray-100 px-2 py-1 rounded text-xs mr-1">${key}: ${value}</span>`)
                .join('');
        }
        
        /**
         * Format value for display
         */
        function formatValue(value) {
            if (value === 0) return '0';
            if (value < 0.01) return value.toExponential(2);
            if (value > 1000000) return (value / 1000000).toFixed(2) + 'M';
            if (value > 1000) return (value / 1000).toFixed(2) + 'K';
            if (Number.isInteger(value)) return value.toString();
            return value.toFixed(2);
        }
        
        /**
         * UI state functions
         */
        function showLoading() {
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('metrics-container').classList.add('hidden');
        }
        
        function showError(message) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('metrics-container').classList.add('hidden');
            document.getElementById('error-message').textContent = message;
        }
        
        function showContent() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('metrics-container').classList.remove('hidden');
        }
    </script>
</body>
</html>

