<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Webhook Details - Task Framework</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- htmx via CDN -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>

  <!-- Custom styles -->
  <style>
    .nav-item {
      transition: all 0.2s ease-in-out;
    }

    .nav-item:hover {
      transform: translateX(4px);
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #1f2937;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #6b7280;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    /* Modal backdrop */
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
    }
  </style>
</head>

<body class="h-full bg-gray-50">
  <!-- API Utilities (loaded via htmx) -->
  <div hx-get="/ui/components/api-utils.html" hx-trigger="load" hx-swap="outerHTML"></div>

  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <div hx-get="/ui/components/sidebar.html" hx-trigger="load" hx-swap="outerHTML">
      <aside class="w-64 bg-gray-800 text-white flex items-center justify-center">
        <div class="text-gray-400 text-sm">Loading...</div>
      </aside>
    </div>

    <!-- Main Content -->
    <div class="flex-1 overflow-auto">
      <!-- Breadcrumb -->
      <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="px-6 py-3">
          <div class="flex items-center text-sm text-gray-600">
            <a href="/ui/webhooks" class="hover:text-blue-600">Webhooks</a>
            <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            <span id="webhook-id-breadcrumb">Loading...</span>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="flex items-center justify-center py-12">
        <div class="text-center">
          <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
          <p class="mt-2 text-sm text-gray-500">Loading webhook...</p>
        </div>
      </div>

      <!-- Error State -->
      <div id="error-state" class="hidden px-6 py-12">
        <div class="max-w-md mx-auto text-center">
          <svg class="mx-auto h-12 w-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 class="mt-2 text-lg font-medium text-gray-900">Error Loading Webhook</h3>
          <p id="error-message" class="mt-1 text-sm text-gray-500"></p>
          <button onclick="loadWebhook()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Retry
          </button>
        </div>
      </div>

      <!-- Webhook Details -->
      <div id="webhook-details" class="hidden">
        <!-- Header -->
        <div class="bg-white border-b border-gray-200 px-6 py-4">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h1 class="text-2xl font-bold text-gray-900">Webhook Details</h1>
              <p id="webhook-url-display" class="mt-1 text-sm text-gray-500"></p>
            </div>
            <div class="flex gap-2">
              <button id="toggle-webhook-btn" onclick="toggleWebhook()"
                class="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">
                <span id="toggle-text">Disable</span>
              </button>
              <button onclick="regenerateSecret()"
                class="px-4 py-2 text-sm text-yellow-600 border border-yellow-600 rounded-lg hover:bg-yellow-50">
                Regenerate Secret
              </button>
              <button onclick="deleteWebhookFromDetails()"
                class="px-4 py-2 text-sm text-red-600 border border-red-600 rounded-lg hover:bg-red-50">
                Delete Webhook
              </button>
            </div>
          </div>
        </div>

        <!-- Webhook Information -->
        <div class="px-6 py-6">
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Configuration</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Webhook ID -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Webhook ID</label>
                <div id="webhook-id" class="text-sm text-gray-900 font-mono"></div>
              </div>

              <!-- Status -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <div id="webhook-status"></div>
              </div>

              <!-- URL -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">URL</label>
                <div id="webhook-url" class="text-sm text-gray-900 break-all"></div>
              </div>

              <!-- Secret -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Secret</label>
                <div class="flex items-center gap-2">
                  <input type="password" id="webhook-secret" readonly
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm font-mono" />
                  <button onclick="toggleSecretVisibility()"
                    class="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50"
                    title="Toggle visibility">
                    <svg id="secret-show-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    <svg id="secret-hide-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor"
                      viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                    </svg>
                  </button>
                  <button onclick="copySecret()"
                    class="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50"
                    title="Copy to clipboard">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Timeout -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Timeout</label>
                <div id="webhook-timeout" class="text-sm text-gray-900"></div>
              </div>

              <!-- Created By -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Created By</label>
                <div id="webhook-created-by" class="text-sm text-gray-900"></div>
              </div>

              <!-- Created At -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Created At</label>
                <div id="webhook-created-at" class="text-sm text-gray-900"></div>
              </div>

              <!-- Updated At -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Updated At</label>
                <div id="webhook-updated-at" class="text-sm text-gray-900"></div>
              </div>

              <!-- Events -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Event Filters</label>
                <div id="webhook-events" class="text-sm text-gray-900"></div>
              </div>

              <!-- Scope -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Scope</label>
                <div id="webhook-scope" class="text-sm text-gray-900"></div>
              </div>

              <!-- Data Filters -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Data Filters</label>
                <div id="webhook-data-filters" class="text-sm text-gray-900"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Delivery History -->
        <div class="px-6 pb-6">
          <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-900">Delivery History</h2>
            </div>

            <!-- Include deliveries table component -->
            <div id="deliveries-component" hx-get="/ui/components/deliveries-table.html" hx-trigger="load"
              hx-swap="innerHTML"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop" onclick="closeDeleteModal()">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6" onclick="event.stopPropagation()">
        <div class="text-center">
          <svg class="mx-auto h-12 w-12 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <h3 class="mt-4 text-lg font-medium text-gray-900">Delete Webhook</h3>
          <p class="mt-2 text-sm text-gray-500">
            Are you sure you want to delete this webhook? This action cannot be undone and all delivery history will be
            lost.
          </p>
        </div>
        <div class="mt-6 flex gap-3">
          <button onclick="closeDeleteModal()"
            class="flex-1 px-4 py-2 text-sm text-gray-600 hover:text-gray-900 border border-gray-300 rounded-lg hover:bg-gray-50">
            Cancel
          </button>
          <button onclick="confirmDelete()"
            class="flex-1 px-4 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700">
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // STORAGE_KEYS is now defined in api-utils.html

    // State
    let webhookId = null;
    let webhookData = null;
    let deliveriesInitialized = false;

    /**
     * Wait for API utilities to be loaded
     */
    function waitForApiUtils() {
      return new Promise((resolve) => {
        if (typeof apiFetch !== "undefined") {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (typeof apiFetch !== "undefined") {
              clearInterval(checkInterval);
              resolve();
            }
          }, 50);
        }
      });
    }

    /**
     * Initialize page
     */
    document.addEventListener("DOMContentLoaded", async function () {
      await waitForApiUtils();

      // Extract webhook ID from URL
      const pathParts = window.location.pathname.split("/");
      webhookId = pathParts[pathParts.length - 1];

      if (!webhookId) {
        showError("No webhook ID provided");
        return;
      }

      loadWebhook();

      // Wait for htmx to load deliveries component, then initialize it
      document.addEventListener("htmx:afterSettle", function (event) {
        if (event.detail.target.id === "deliveries-component") {
          // Only initialize if webhook has loaded and deliveries not yet initialized
          if (webhookData && !deliveriesInitialized && typeof initDeliveriesTable === "function") {
            deliveriesInitialized = true;
            initDeliveriesTable(webhookId);
          }
        }
      });
    });

    /**
     * Load webhook from API
     */
    async function loadWebhook() {
      const apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
      const appId = localStorage.getItem(STORAGE_KEYS.APP_ID);
      const userId = localStorage.getItem(STORAGE_KEYS.USER_ID);

      if (!apiKey) {
        showError("API Key not configured");
        return;
      }

      // Show loading state
      showLoading();

      try {
        const response = await apiFetch(`/webhooks/${webhookId}`);

        webhookData = await response.json();
        displayWebhook(webhookData);
      } catch (error) {
        console.error("Error loading webhook:", error);
        showError(error.message);
      }
    }

    /**
     * Display webhook details
     */
    function displayWebhook(webhook) {
      // Show webhook details
      document.getElementById("loading-state").classList.add("hidden");
      document.getElementById("error-state").classList.add("hidden");
      document.getElementById("webhook-details").classList.remove("hidden");

      // Initialize deliveries table now that webhook is loaded
      // This handles the case where htmx:afterSettle already fired
      if (!deliveriesInitialized && typeof initDeliveriesTable === "function") {
        deliveriesInitialized = true;
        initDeliveriesTable(webhookId);
      }

      // Update breadcrumb
      document.getElementById("webhook-id-breadcrumb").textContent = webhook.id;

      // Populate fields
      document.getElementById("webhook-id").textContent = webhook.id;
      document.getElementById("webhook-url").textContent = webhook.url;
      document.getElementById("webhook-url-display").textContent = webhook.url;
      document.getElementById("webhook-secret").value = webhook.secret;
      document.getElementById("webhook-timeout").textContent = `${webhook.timeout_seconds} seconds`;
      document.getElementById("webhook-created-by").textContent = webhook.created_by || "N/A";
      document.getElementById("webhook-created-at").textContent = new Date(webhook.created_at).toLocaleString();
      document.getElementById("webhook-updated-at").textContent = new Date(webhook.updated_at).toLocaleString();

      // Status
      const statusBadge = webhook.enabled
        ? `<span class="px-2 py-1 text-xs font-semibold text-white bg-green-600 rounded">Enabled</span>`
        : `<span class="px-2 py-1 text-xs font-semibold text-white bg-gray-600 rounded">Disabled</span>`;
      document.getElementById("webhook-status").innerHTML = statusBadge;

      // Toggle button
      document.getElementById("toggle-text").textContent = webhook.enabled ? "Disable" : "Enable";

      // Events
      let eventsDisplay = "All events";
      if (webhook.events) {
        if (webhook.events.include) {
          eventsDisplay = `<div class="text-sm font-medium mb-1">Include:</div><ul class="list-disc list-inside text-sm text-gray-700">${webhook.events.include.map(e => `<li>${escapeHtml(e)}</li>`).join("")}</ul>`;
        } else if (webhook.events.exclude) {
          eventsDisplay = `<div class="text-sm font-medium mb-1">Exclude:</div><ul class="list-disc list-inside text-sm text-gray-700">${webhook.events.exclude.map(e => `<li>${escapeHtml(e)}</li>`).join("")}</ul>`;
        }
      }
      document.getElementById("webhook-events").innerHTML = eventsDisplay;

      // Scope
      let scopeDisplay = "Global (all threads)";
      if (webhook.scope) {
        const parts = [];
        if (webhook.scope.thread_id) parts.push(`<div><strong>Thread:</strong> ${webhook.scope.thread_id}</div>`);
        if (webhook.scope.user_id) parts.push(`<div><strong>User:</strong> ${webhook.scope.user_id}</div>`);
        if (webhook.scope.app_id) parts.push(`<div><strong>App:</strong> ${webhook.scope.app_id}</div>`);
        if (webhook.scope.tenant_id) parts.push(`<div><strong>Tenant:</strong> ${webhook.scope.tenant_id}</div>`);
        if (webhook.scope.schedule_id) parts.push(`<div><strong>Schedule:</strong> ${webhook.scope.schedule_id}</div>`);
        scopeDisplay = parts.length > 0 ? parts.join("") : "Global (all threads)";
      }
      document.getElementById("webhook-scope").innerHTML = scopeDisplay;

      // Data Filters
      let dataFiltersDisplay = "Default";
      if (webhook.data_filters) {
        const filters = [];
        if (webhook.data_filters.detail) filters.push(`<div><strong>Detail Level:</strong> ${webhook.data_filters.detail}</div>`);
        if (webhook.data_filters.include_download_urls) filters.push(`<div>✓ Include download URLs</div>`);
        if (webhook.data_filters.include_logs) filters.push(`<div>✓ Include logs</div>`);
        if (webhook.data_filters.include_metrics) filters.push(`<div>✓ Include metrics</div>`);
        if (webhook.data_filters.artifact_selectors && webhook.data_filters.artifact_selectors.length > 0) {
          filters.push(`<div><strong>Artifact Selectors:</strong> ${webhook.data_filters.artifact_selectors.map(s => s.ref).join(", ")}</div>`);
        }
        dataFiltersDisplay = filters.length > 0 ? filters.join("") : "Default";
      }
      document.getElementById("webhook-data-filters").innerHTML = dataFiltersDisplay;
    }

    /**
     * Toggle webhook enabled/disabled
     */
    async function toggleWebhook() {
      const apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
      const appId = localStorage.getItem(STORAGE_KEYS.APP_ID);
      const userId = localStorage.getItem(STORAGE_KEYS.USER_ID);

      const newStatus = !webhookData.enabled;

      try {
        const response = await apiFetch(`/webhooks/${webhookId}`, {
          method: "PATCH",
          body: JSON.stringify({ enabled: newStatus }),
        });

        webhookData = await response.json();
        displayWebhook(webhookData);
      } catch (error) {
        console.error("Error toggling webhook:", error);
        alert("Failed to toggle webhook: " + error.message);
      }
    }

    /**
     * Regenerate webhook secret
     */
    async function regenerateSecret() {
      if (!confirm("Are you sure you want to regenerate the secret? The old secret will no longer work.")) {
        return;
      }

      const apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
      const appId = localStorage.getItem(STORAGE_KEYS.APP_ID);
      const userId = localStorage.getItem(STORAGE_KEYS.USER_ID);

      try {
        const response = await apiFetch(`/webhooks/${webhookId}:regenerate-secret`, {
          method: "POST",
        });

        webhookData = await response.json();
        displayWebhook(webhookData);
        alert("Secret regenerated successfully!");
      } catch (error) {
        console.error("Error regenerating secret:", error);
        alert("Failed to regenerate secret: " + error.message);
      }
    }

    /**
     * Toggle secret visibility
     */
    function toggleSecretVisibility() {
      const secretInput = document.getElementById("webhook-secret");
      const showIcon = document.getElementById("secret-show-icon");
      const hideIcon = document.getElementById("secret-hide-icon");

      if (secretInput.type === "password") {
        secretInput.type = "text";
        showIcon.classList.add("hidden");
        hideIcon.classList.remove("hidden");
      } else {
        secretInput.type = "password";
        showIcon.classList.remove("hidden");
        hideIcon.classList.add("hidden");
      }
    }

    /**
     * Copy secret to clipboard
     */
    async function copySecret() {
      const secretInput = document.getElementById("webhook-secret");
      try {
        await navigator.clipboard.writeText(secretInput.value);
        alert("Secret copied to clipboard!");
      } catch (error) {
        console.error("Failed to copy secret:", error);
        alert("Failed to copy secret");
      }
    }

    /**
     * Delete webhook from details page
     */
    function deleteWebhookFromDetails() {
      document.getElementById("delete-modal").classList.remove("hidden");
    }

    /**
     * Confirm delete
     */
    async function confirmDelete() {
      const apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
      const appId = localStorage.getItem(STORAGE_KEYS.APP_ID);
      const userId = localStorage.getItem(STORAGE_KEYS.USER_ID);

      try {
        const response = await apiFetch(`/webhooks/${webhookId}`, {
          method: "DELETE",
        });

        // Redirect to webhooks list
        window.location.href = "/ui/webhooks";
      } catch (error) {
        console.error("Error deleting webhook:", error);
        alert("Failed to delete webhook: " + error.message);
      }
    }

    /**
     * Close delete modal
     */
    function closeDeleteModal() {
      document.getElementById("delete-modal").classList.add("hidden");
    }

    /**
     * Show loading state
     */
    function showLoading() {
      document.getElementById("loading-state").classList.remove("hidden");
      document.getElementById("error-state").classList.add("hidden");
      document.getElementById("webhook-details").classList.add("hidden");
    }

    /**
     * Show error state
     */
    function showError(message) {
      document.getElementById("loading-state").classList.add("hidden");
      document.getElementById("error-state").classList.remove("hidden");
      document.getElementById("webhook-details").classList.add("hidden");
      document.getElementById("error-message").textContent = message;
    }

    /**
     * Escape HTML to prevent XSS
     */
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>

</html>