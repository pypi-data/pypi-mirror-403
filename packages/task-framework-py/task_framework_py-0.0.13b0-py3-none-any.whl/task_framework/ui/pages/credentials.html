<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vault - Task Framework</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- htmx via CDN -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>

  <!-- Custom styles -->
  <style>
    .nav-item {
      transition: all 0.2s ease-in-out;
    }

    .nav-item:hover {
      transform: translateX(4px);
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #1f2937;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 3px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</head>

<body class="h-full bg-gray-50">
  <div class="flex h-screen overflow-hidden">
    <!-- Left Sidebar -->
    <div hx-get="/ui/components/sidebar.html" hx-trigger="load" hx-swap="outerHTML">
      <aside class="w-64 bg-gray-800 text-white flex items-center justify-center">
        <div class="text-gray-400 text-sm">Loading...</div>
      </aside>
    </div>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto">
      <!-- Top Bar -->
      <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="px-6 py-4 flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-semibold text-gray-800">Vault</h2>
            <p class="text-sm text-gray-600 mt-1">
              Manage encrypted key:value pairs for task configuration
            </p>
          </div>
          <a href="/ui/credentials/create"
            class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Add Credential
          </a>
        </div>
      </div>

      <!-- Credentials Content -->
      <div class="p-6">
        <div class="max-w-6xl mx-auto fade-in">
          <!-- Alert Messages -->
          <div id="alert-success" class="hidden mb-6 bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="flex items-center">
              <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span id="alert-success-message" class="text-green-800 font-medium">Operation successful!</span>
            </div>
          </div>

          <div id="alert-error" class="hidden mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center">
              <svg class="w-5 h-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span id="alert-error-message" class="text-red-800 font-medium">An error occurred</span>
            </div>
          </div>

          <!-- Credentials Table Card -->
          <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Card Header -->
            <div class="border-b border-gray-200 px-6 py-4">
              <h3 class="text-lg font-semibold text-gray-800">Vault Entries</h3>
              <p class="text-sm text-gray-600 mt-1">
                All values are encrypted at rest. Click the eye icon to reveal values.
              </p>
            </div>

            <!-- Credentials List -->
            <div id="credentials-list">
              <div class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="ml-3 text-gray-600">Loading credentials...</span>
              </div>
            </div>
          </div>

          <!-- Help Section -->
          <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start">
              <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div>
                <h4 class="text-sm font-semibold text-blue-900 mb-1">About Credentials</h4>
                <p class="text-sm text-blue-800">
                  Credentials are server-level secrets used by tasks. Create credentials here, then
                  configure tasks to use them via the Task Configuration page. Secret values are
                  encrypted at rest and never exposed in API responses or logs.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
      <div class="mt-3 text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
          <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mt-4">Delete Credential</h3>
        <p class="text-sm text-gray-500 mt-2">
          Are you sure you want to delete <strong id="delete-credential-name"></strong>?
          This action cannot be undone.
        </p>
        <div class="mt-5 flex justify-center space-x-3">
          <button onclick="closeDeleteModal()"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">
            Cancel
          </button>
          <button id="confirm-delete-btn"
            class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg">
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEYS = {
      API_KEY: "tf_api_key",
      APP_ID: "tf_app_id",
      USER_ID: "tf_user_id",
    };

    let credentialToDelete = null;

    /**
     * Load credentials from API
     */
    async function loadCredentials() {
      const apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
      if (!apiKey) {
        showError("Please configure your API key in Settings first.");
        document.getElementById("credentials-list").innerHTML = `
            <div class="text-center py-12">
              <p class="text-gray-500 mb-4">API key not configured</p>
              <a href="/ui/settings" class="text-blue-600 hover:text-blue-800">Go to Settings</a>
            </div>
          `;
        return;
      }

      try {
        const response = await fetch("/admin/credentials", {
          headers: { "X-API-Key": apiKey }
        });

        if (!response.ok) {
          if (response.status === 401) {
            showError("Admin API key required. Your API key may not have admin privileges.");
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
          return;
        }

        const data = await response.json();
        renderCredentials(data.credentials);
      } catch (error) {
        console.error("Failed to load credentials:", error);
        showError("Failed to load credentials: " + error.message);
      }
    }

    /**
     * Render credentials table
     */
    function renderCredentials(credentials) {
      const container = document.getElementById("credentials-list");

      if (!credentials || credentials.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
              </svg>
              <h3 class="mt-2 text-sm font-medium text-gray-900">No credentials</h3>
              <p class="mt-1 text-sm text-gray-500">Get started by creating a new credential.</p>
              <div class="mt-6">
                <a href="/ui/credentials/create" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                  </svg>
                  Add Credential
                </a>
              </div>
            </div>
          `;
        return;
      }

      let html = `
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tags</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
        `;

      for (const cred of credentials) {
        const createdDate = new Date(cred.created_at).toLocaleDateString();
        const isExpired = cred.expires_at && new Date(cred.expires_at) < new Date();
        const tagsHtml = cred.tags && cred.tags.length > 0
          ? cred.tags.map(t => `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">${t}</span>`).join(" ")
          : '<span class="text-gray-400 text-sm">-</span>';

        html += `
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <svg class="h-5 w-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                  </svg>
                  <span class="font-medium text-gray-900">${cred.name}</span>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center space-x-2">
                  <span id="value-${cred.name}" class="text-sm text-gray-600 font-mono">${cred.value_preview || '••••••••'}</span>
                  <button onclick="toggleReveal('${cred.name}')" class="text-gray-400 hover:text-gray-600" title="Toggle reveal">
                    <svg id="eye-${cred.name}" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                  </button>
                </div>
              </td>
              <td class="px-6 py-4">
                <span class="text-sm text-gray-600">${cred.description || "-"}</span>
              </td>
              <td class="px-6 py-4">${tagsHtml}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                ${isExpired
            ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Expired</span>'
            : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>'
          }
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <a href="/ui/credentials/${cred.name}/edit" class="text-blue-600 hover:text-blue-900 mr-4">Edit</a>
                <button onclick="confirmDelete('${cred.name}')" class="text-red-600 hover:text-red-900">Delete</button>
              </td>
            </tr>
          `;
      }

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    /**
     * Show delete confirmation modal
     */
    function confirmDelete(credentialName) {
      credentialToDelete = credentialName;
      document.getElementById("delete-credential-name").textContent = credentialName;
      document.getElementById("delete-modal").classList.remove("hidden");
    }

    /**
     * Close delete modal
     */
    function closeDeleteModal() {
      credentialToDelete = null;
      document.getElementById("delete-modal").classList.add("hidden");
    }

    /**
     * Delete credential
     */
    async function deleteCredential() {
      if (!credentialToDelete) return;

      const apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
      try {
        const response = await fetch(`/admin/credentials/${credentialToDelete}`, {
          method: "DELETE",
          headers: { "X-API-Key": apiKey }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        showSuccess(`Credential "${credentialToDelete}" deleted successfully`);
        closeDeleteModal();
        loadCredentials();
      } catch (error) {
        showError("Failed to delete credential: " + error.message);
        closeDeleteModal();
      }
    }

    /**
     * Show success message
     */
    function showSuccess(message) {
      const alertEl = document.getElementById("alert-success");
      document.getElementById("alert-success-message").textContent = message;
      alertEl.classList.remove("hidden");
      setTimeout(() => alertEl.classList.add("hidden"), 5000);
    }

    /**
     * Show error message
     */
    function showError(message) {
      const alertEl = document.getElementById("alert-error");
      document.getElementById("alert-error-message").textContent = message;
      alertEl.classList.remove("hidden");
      setTimeout(() => alertEl.classList.add("hidden"), 8000);
    }

    // Track revealed state
    const revealedValues = {};

    /**
     * Toggle reveal of credential value
     */
    async function toggleReveal(name) {
      const valueEl = document.getElementById(`value-${name}`);
      const eyeEl = document.getElementById(`eye-${name}`);

      if (revealedValues[name]) {
        // Hide the value
        valueEl.textContent = revealedValues[name].preview;
        delete revealedValues[name];
        eyeEl.innerHTML = `
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          `;
      } else {
        // Reveal the value
        const apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
        try {
          const response = await fetch(`/admin/credentials/${name}/reveal`, {
            headers: { "X-API-Key": apiKey }
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          revealedValues[name] = { preview: valueEl.textContent };
          valueEl.textContent = data.value;
          eyeEl.innerHTML = `
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
            `;
        } catch (error) {
          showError("Failed to reveal value: " + error.message);
        }
      }
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", function () {
      loadCredentials();
      document.getElementById("confirm-delete-btn").addEventListener("click", deleteCredential);
    });

    // Configure htmx headers
    document.body.addEventListener("htmx:configRequest", function (event) {
      const apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY) || "";
      if (apiKey) event.detail.headers["X-API-Key"] = apiKey;
    });
  </script>
</body>

</html>