stages:
  - lint
  - test
  - build

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - .venv/

.python-base:
  before_script:
    - python3 -m venv .venv
    - source .venv/bin/activate
    - pip install --upgrade pip
    - pip install -e ".[dev]"

# Linting & Formatting
lint:
  stage: lint
  image: python:3.12
  extends: .python-base
  script:
    - ruff check cbadvanced tests
    - ruff format --check cbadvanced tests
  allow_failure: false

# Type Checking
typecheck:
  stage: lint
  image: python:3.12
  extends: .python-base
  script:
    - mypy cbadvanced
  allow_failure: true

# Tests for each Python version
.test-template:
  stage: test
  extends: .python-base
  script:
    - pytest tests/ -v --tb=short --junitxml=pytest-report.xml
  artifacts:
    when: always
    reports:
      junit: pytest-report.xml
    paths:
      - pytest-report.xml
    expire_in: 1 week

test:python3.10:
  extends: .test-template
  image: python:3.10

test:python3.11:
  extends: .test-template
  image: python:3.11

test:python3.12:
  extends: .test-template
  image: python:3.12

test:python3.13:
  extends: .test-template
  image: python:3.13
  allow_failure: true  # Python 3.13 is newer, allow failures

# Test with coverage (main test job)
test:coverage:
  stage: test
  image: python:3.12
  extends: .python-base
  script:
    - pip install pytest-cov
    - pytest tests/ -v --cov=cbadvanced --cov-report=xml --cov-report=term-missing --junitxml=pytest-report.xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    when: always
    reports:
      junit: pytest-report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
      - pytest-report.xml
    expire_in: 1 week

# Build package
build:
  stage: build
  image: python:3.12
  extends: .python-base
  script:
    - pip install build
    - python3 -m build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - main
    - master
    - tags

# Publish to PyPI (manual trigger on tags)
# Requires CI/CD variables: PYPI_API_TOKEN (or TWINE_USERNAME + TWINE_PASSWORD)
# Set in GitLab: Settings > CI/CD > Variables
publish:pypi:
  stage: build
  image: python:3.12
  extends: .python-base
  variables:
    TWINE_USERNAME: __token__
    TWINE_PASSWORD: $PYPI_API_TOKEN
  script:
    - pip install build twine
    - python3 -m build
    - twine upload dist/*
  rules:
    - if: $CI_COMMIT_TAG
      when: manual
  needs:
    - build
