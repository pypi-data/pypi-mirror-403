set -e  
set -o pipefail

echo "=========================================="
echo " GENERATING PYTHON API DOCUMENTATION..."
echo "=========================================="

# Function to handle errors
error_exit() {
    echo "ERROR: $1"
    exit 1
}

# Generate the python API documentation
sphinx-apidoc -f -o ./source --separate ../src/pyvale/ ../src/pyvale/data/* ../src/pyvale/examples/* || error_exit "sphinx-apidoc failed"

# Remove autogenerated TOC file
rm -f source/modules.rst || error_exit "Failed to remove modules.rst"

# Generate the C++ API documentation
( cd ./source && doxygen Doxyfile ) || error_exit "doxygen generation failed"

echo "Updating generated RST files..."

# Change title for dataset file
# sed -i '0,/pyvale.dataset/s/pyvale.dataset/pyvale.dataset/' source/pyvale.dataset.rst || error_exit "Failed to update dataset title"
# sed -i '0,/dataset.dataset/s/dataset.dataset/pyvale.dataset/' source/pyvale.dataset.dataset.rst || error_exit "Failed to update dataset title"

# Modules to process
modules=("dic" "blender" "mooseherder" "sensorsim" "verif" "dataset")

for mod in "${modules[@]}"; do
    rst="source/pyvale.${mod}.rst"

    # Remove redundant headers
    sed -i '/^pyvale package$/,+1d; /^Submodules$/,+1d' "$rst" || error_exit "Failed removing headers in $rst"

    # Add caption
    sed -i '/^\.\. toctree::/a \   :caption: Python Source Files' "$rst" || error_exit "Failed adding caption in $rst"

    # Remove "package" word
    sed -i 's/package//g' "$rst" || error_exit "Failed removing 'package' in $rst"

    # Remove 'Module contents' section
    sed -i '/^Module contents$/,/^ *:undoc-members:/d' "$rst" || error_exit "Failed trimming module contents in $rst"

    # Change toctree level from 4 to 1
    sed -i 's/4/1/g' "$rst" || error_exit "Failed updating toctree level in $rst"

    sed -i "0,/\\b${mod}\.\([a-zA-Z0-9_]\+\)/s//\1.py/" source/pyvale.${mod}.*.rst || error_exit "Failed replacing '${mod}.*' with '*.py' in $rst"

done

# Tweak module titles across all rst files
sed -i 's/^pyvale\.\(.*\) module$/\1/' source/pyvale.*.rst || error_exit "Failed fixing module titles"

# Remove unneeded file
rm -f ./source/pyvale.dic.dic2dcpp.rst || error_exit "Failed to remove dic2dcpp.rst"

echo "PYTHON API DOCUMENTATION GENERATED SUCCESSFULLY!"

