name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-types:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - name: Install Python via uv
        run: uv python install 3.12
      - name: Install deps & run checks
        run: |
          uv sync --dev
          make check

  docker-matrix-tests:
    runs-on: ubuntu-latest
    needs: lint-and-types
    strategy:
      matrix:
        python_base: ["python:3.12-slim", "python:3.13-slim", "python:3.14-slim"]
        iperf_version: ["3.18", "3.19.1", "3.20"]
    steps:
      - uses: actions/checkout@v4
      - name: Build docker test image
        run: |
          PY_BASE="${{ matrix.python_base }}"
          SANITIZED_PY_BASE="${PY_BASE//:/-}"
          TAG="py-iperf3-test:${SANITIZED_PY_BASE}-${{ matrix.iperf_version }}"
          docker build \
            --build-arg PYTHON_BASE="${PY_BASE}" \
            --build-arg IPERF3_VERSION=${{ matrix.iperf_version }} \
            -t "${TAG}" .
      - name: Run tests in container
        run: |
          PY_BASE="${{ matrix.python_base }}"
          SANITIZED_PY_BASE="${PY_BASE//:/-}"
          TAG="py-iperf3-test:${SANITIZED_PY_BASE}-${{ matrix.iperf_version }}"
          docker run --rm -v "${{ github.workspace }}:/app" "${TAG}" \
            bash -c "pytest -vvv --cov=src --cov-report=term-missing"
