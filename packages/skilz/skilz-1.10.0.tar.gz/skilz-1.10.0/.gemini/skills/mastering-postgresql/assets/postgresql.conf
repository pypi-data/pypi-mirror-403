# PostgreSQL Configuration for Search and Vector Workloads
# Optimized for development/small production (8GB RAM, SSD storage)
# Adjust values based on your specific hardware

#------------------------------------------------------------------------------
# CONNECTIONS
#------------------------------------------------------------------------------
listen_addresses = '*'
max_connections = 100
# Increase for high-concurrency apps, but consider connection pooling

#------------------------------------------------------------------------------
# MEMORY
#------------------------------------------------------------------------------
# Shared buffers: 25% of RAM for dedicated database server
shared_buffers = 2GB

# Work memory: per-operation memory for sorts, hash tables
# Higher values help complex queries but multiply by max_connections
work_mem = 64MB

# Maintenance: memory for VACUUM, CREATE INDEX, etc.
# Critical for vector index builds - set high temporarily for large builds
maintenance_work_mem = 1GB

# Effective cache size: estimate of OS disk cache available
# Set to ~75% of total RAM
effective_cache_size = 6GB

#------------------------------------------------------------------------------
# PARALLELISM
#------------------------------------------------------------------------------
max_worker_processes = 8
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_parallel_maintenance_workers = 4
# Increase maintenance workers for faster vector index builds

#------------------------------------------------------------------------------
# QUERY PLANNER
#------------------------------------------------------------------------------
# SSD settings (use 4.0 for HDD)
random_page_cost = 1.1
effective_io_concurrency = 200
# HDD settings:
# random_page_cost = 4.0
# effective_io_concurrency = 2

# Statistics target for complex query planning
default_statistics_target = 100

#------------------------------------------------------------------------------
# WRITE AHEAD LOG (WAL)
#------------------------------------------------------------------------------
wal_buffers = 64MB
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min

# For heavy write workloads:
# max_wal_size = 4GB
# min_wal_size = 1GB

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------
# Log slow queries (adjust threshold as needed)
log_min_duration_statement = 100
# -1 = disabled, 0 = all queries, N = queries over N ms

# Query logging (enable for debugging, disable for production)
log_statement = 'none'
# Options: none, ddl, mod, all

# Log format
log_line_prefix = '%t [%p]: db=%d,user=%u,app=%a '
log_timezone = 'UTC'

#------------------------------------------------------------------------------
# AUTOVACUUM
#------------------------------------------------------------------------------
autovacuum = on
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 1000
# Aggressive settings for high-churn tables

#------------------------------------------------------------------------------
# FULL-TEXT SEARCH
#------------------------------------------------------------------------------
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# CLIENT DEFAULTS
#------------------------------------------------------------------------------
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'

#------------------------------------------------------------------------------
# EXTENSIONS (requires restart)
#------------------------------------------------------------------------------
# Uncomment to enable pg_stat_statements for query monitoring
# shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements settings
# pg_stat_statements.max = 10000
# pg_stat_statements.track = all

#------------------------------------------------------------------------------
# VECTOR WORKLOAD NOTES
#------------------------------------------------------------------------------
# For large HNSW index builds:
# 1. Temporarily increase maintenance_work_mem to 4-8GB
# 2. Increase max_parallel_maintenance_workers to 7
# 3. Monitor with: SELECT * FROM pg_stat_progress_create_index;
#
# For query tuning:
# SET hnsw.ef_search = 100;  -- Higher = better recall, slower
# SET ivfflat.probes = 10;   -- Higher = better recall, slower
