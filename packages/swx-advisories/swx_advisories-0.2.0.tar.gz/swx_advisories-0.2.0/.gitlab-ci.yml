stages:
  - test
  - build
  - publish

# Run tests on all pushes and merge requests
test:
  stage: test
  script:
    - python3 -m pip install -e .[dev]
    - python3 -m pytest tests/ -v --tb=short
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Build package on tags
build:
  stage: build
  script:
    - python3 -m pip install build
    - python3 -m build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# Publish to PyPI on version tags
publish-pypi:
  stage: publish
  script:
    - python3 -m pip install twine
    - python3 -m twine upload dist/*
  dependencies:
    - build
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  variables:
    TWINE_USERNAME: __token__
    TWINE_PASSWORD: $PYPI_TOKEN
