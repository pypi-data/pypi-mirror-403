workflow:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/
      when: always
    - when: never

image: python:3.12-slim

stages:
  - build
  - test

build-wheel:
  stage: build
  before_script:
    - apt-get update && apt-get install -y curl build-essential
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - . "$HOME/.cargo/env"
    - pip install maturin
  script:
    - maturin build --release
  artifacts:
    paths:
      - target/wheels/
    expire_in: 1 week

test:
  stage: test
  needs:
    - job: build-wheel
      artifacts: true
  script:
    - pip install target/wheels/*.whl
    - python3 -m unittest discover -s tests -p 'test_*.py'
