openapi: '3.0.0'
servers:
  - url: 'https://www.lcdp.ovh/api/v1'
  - url: 'https://www.lecomptoirdespharmacies.fr/api/v1'
  - url: 'http://www.lcdp.localhost/api/v1'
  - url: 'http://localhost:7072/api/v1'
info:
  description: 'This is the REST API of LCDP shipment'
  version: '1.0.0'
  title: 'lcdp-monolith-service'
  termsOfService: 'https://www.lecomptoirdespharmacies.fr/mentions-legales'
  contact:
    email: 'contact@lecomptoirdespharmacies.fr'
  license:
    name: 'Apache 2.0'
    url: 'http://www.apache.org/licenses/LICENSE-2.0.html'
tags:
  - name: ManageShipment
    description: Manage shipment
paths:
  /shipments:
    post:
      tags:
        - 'ManageShipment'
      summary: 'Create shipment'
      operationId: 'createShipment'
      requestBody:
        description: 'Object to use in order to create shipment'
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShipmentCreationParameters'
            example:
              senderId: 123
              recipientId: 256
              parcelQuantity: 2
              customReference: 'AZE-f456456'
              desiredPickupDate: '2020-04-30'
      security:
        - bearerAuth: []
        - apiKeyAuth: []
      x-restrict:
        roles:
          - ADMINISTRATOR
      responses:
        200:
          description: 'successful operation'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Shipment'
        400:
          description: 'Bad Request'
        403:
          description: 'Access denied'
        417:
          description: 'Failed due to shipment service provider rejection'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShipmentError'

  /shipments/parcels/{parcelId}:
    delete:
      tags:
        - 'ManageShipment'
      summary: 'CancelShipmentParcel'
      operationId: 'cancelShipmentParcel'
      security:
        - bearerAuth: []
        - apiKeyAuth: []
      x-restrict:
        roles:
          - ADMINISTRATOR
      parameters:
        - $ref: '#/components/parameters/ParcelIdParameter'
      responses:
        200:
          description: 'successful operation'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelParcelResponse'
        400:
          description: 'Bad Request'
          content:
            application/json:
              schema:
                $ref: 'common.yaml#/components/schemas/RestError'
        403:
          description: 'Access denied'
        503:
          description: 'Service unavailable'

  /order-carriages:
    get:
      tags:
        - 'searchOrderCarriage'
      summary: 'Get carriages for order'
      description: ''
      operationId: 'getOrderCarriages'
      security:
        - bearerAuth: []
        - apiKeyAuth: []
      x-restrict:
        roles:
          - ADMINISTRATOR
          - SELLER_BUYER
          - LABORATORY
      parameters:
        - in: query
          name: ref[eq]
          description: Filter on orderCarriageReference to include in the search (can be given multiple time which result in a OR condition)
          schema:
            type: array
            items:
              type: string
        - in: query
          name: orderBy
          description: "Order carriages using specific sorting. Note : If sorting filter end with 'asc' or 'desc' it allow to select ascending or descending."
          schema:
            type: string
            enum:
              [
                'REFERENCE:ASC',
                'REFERENCE:DESC',
                'CREATED_AT:ASC',
                'CREATED_AT:DESC',
              ]
            default: CREATED_AT:desc
        - in: query
          name: p
          description: 'Page number to search for (start at 0)'
          schema:
            type: integer
            minimum: 0
        - in: query
          name: pp
          description: Number of orders per page
          schema:
            type: integer
            maximum: 50
            minimum: 0
      responses:
        200:
          description: 'successful operation'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedOrderCarriages'
        400:
          description: 'Bad Request'
          content:
            application/json:
              schema:
                $ref: 'common.yaml#/components/schemas/RestError'
        403:
          description: 'Access denied'
        404:
          description: 'Order not found'

  /order-carriages/{orderCarriageReference}:
    get:
      tags:
        - 'searchOrderCarriage'
      summary: 'Get carriage for order identified by orderCarriageReference'
      description: ''
      operationId: 'getOrderCarriage'
      security:
        - bearerAuth: []
        - apiKeyAuth: []
      x-restrict:
        roles:
          - ADMINISTRATOR
          - SELLER_BUYER
          - LABORATORY
      parameters:
        - in: path
          name: orderCarriageReference
          required: true
          description: The ref of the order to get carriage on.
          schema:
            type: string
      responses:
        200:
          description: 'successful operation'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderCarriage'
        400:
          description: 'Bad Request'
          content:
            application/json:
              schema:
                $ref: 'common.yaml#/components/schemas/RestError'
        403:
          description: 'Access denied'
        404:
          description: 'Order not found'
    post:
      tags:
        - 'ManageOrderCarriage'
      summary: 'Create shipment for order identified by orderCarriageReference'
      description: |
        # Preconditions :
        - 'paused' property is false
        - count('order.shipments') < 'order.maxShipment'
        - You are the SELLER
      operationId: 'createOrderCarriageShipment'
      security:
        - bearerAuth: []
        - apiKeyAuth: []
      x-restrict:
        roles:
          - ADMINISTRATOR
          - SELLER_BUYER
          - LABORATORY
        capabilities:
          - PHARMDESTOCK_READ
          - LABORATORY_READ
      parameters:
        - in: path
          name: orderCarriageReference
          required: true
          description: The ref of the order to create shipment on.
          schema:
            type: string
      requestBody:
        description: 'Parameters for shipment creation'
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderCarriageShipmentCreationParameters'
      responses:
        201:
          description: 'successful operation'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Shipment'
        400:
          description: 'Bad Request'
          content:
            application/json:
              schema:
                $ref: 'common.yaml#/components/schemas/RestError'
        403:
          description: 'Access denied'
        404:
          description: 'Order not found'
        412:
          description: 'Precondition failed if maximum of two shipment already created on this order'

components:
  parameters:
    ParcelIdParameter:
      in: path
      name: parcelId
      required: true
      description: The id of the parcel concerned by the request
      schema:
        type: integer
        format: int64

  schemas:
    PaginatedOrderCarriages:
      allOf:
        - $ref: 'common.yaml#/components/schemas/PaginatedObject'
        - type: object
          properties:
            records:
              type: array
              items:
                $ref: '#/components/schemas/OrderCarriage'
          required:
            - records

    # We are using a custom ShipmentError as 'message' is not static and come from shipment service provider
    ShipmentError:
      type: object
      properties:
        code:
          type: string
          enum:
            - PICKUP_UNAVAILABLE
        message:
          type: string
          description: Error detail built from shipment service provider
      required:
        - type
        - message

    ShipmentCreationParameters:
      type: object
      required:
        - senderId
        - recipientId
        - parcelQuantity
        - customReference
      properties:
        senderId:
          description: Sender Id equal
          type: integer
          format: int64
        recipientId:
          description: Recipient Id equal
          type: integer
          format: int64
        parcelQuantity:
          description: Number of parcels to generate
          type: integer
          minimum: 1
          maximum: 100
        customReference:
          description: Custom reference for this shipment
          type: string
        desiredPickupDate:
          description: Desired pick up date
          type: string
          format: date-time

    Shipment:
      type: object
      description: |
        A shipment is a transport request for X parcels.
      properties:
        reservationNumber:
          type: string
          description: 'Unique reservation number for this shipment'
        labels:
          $ref: '#/components/schemas/ShipmentLabels'
        pickupDate:
          type: string
          format: date-time
          description: 'Pickup date for this shipment'
        parcels:
          type: array
          items:
            $ref: '#/components/schemas/ShipmentParcel'
        createdAt:
          type: string
          format: date-time

    ShipmentParcel:
      type: object
      description: |
        An shipment parcel is one parcel of a transport request.
        Actions availables on this action have some preconditions :
        * Follow Parcel :
          - 'skybill' property is not null
      properties:
        id:
          type: integer
          format: int64
          description: 'Unique identifier for the parcel'
        status:
          $ref: '#/components/schemas/ShipmentParcelStatus'
        deliveryStatus:
          $ref: '#/components/schemas/DeliveryStatus'
        skybill:
          $ref: '#/components/schemas/SkybillLink'

    ShipmentParcelStatus:
      type: string
      enum: ['WAITING_FOR_SENDING', 'DELIVERY_ON_GOING', 'DELIVERED', 'EXPIRED']
      description: 'Delivery status for a shipment parcel'

    DeliveryStatus:
      type: object
      properties:
        code:
          type: string
          description: 'Unique identifier of this status'
        details:
          type: string
          description: 'Details about delivery status (in French)'

    SkybillLink:
      description: Allow to track a parcel
      allOf:
        - $ref: 'common.yaml#/components/schemas/HttpLink'
        - type: object
          properties:
            id:
              type: string
              description: 'Unique identifier for this skybill'

    ShipmentLabels:
      type: object
      properties:
        pdf:
          description: URI to PDF file
          type: string
          format: uri
        zpl:
          description: URI to ZPL file
          type: string
          format: uri

    CancelParcelResponse:
      type: object
      properties:
        errorCode:
          type: integer
        errorMessage:
          type: string
        statusCode:
          type: integer

    OrderCarriageShipmentCreationParameters:
      type: object
      properties:
        parcelQuantity:
          type: integer
          minimum: 1
          maximum: 100
          description: 'Quantity of parcels in this shipment'

    OrderCarriage:
      type: object
      properties:
        reference:
          type: string
          description: 'Reference of the order carriage. Should be the same than order reference.'
        order:
          $ref: '#/components/schemas/OrderLink'
        shipments:
          type: array
          items:
            $ref: '#/components/schemas/Shipment'

    OrderLink:
      allOf:
        - $ref: 'common.yaml#/components/schemas/HttpLink'
        - type: object
          properties:
            reference:
              type: string
              description: 'Unique identifier for this order'

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    apiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
