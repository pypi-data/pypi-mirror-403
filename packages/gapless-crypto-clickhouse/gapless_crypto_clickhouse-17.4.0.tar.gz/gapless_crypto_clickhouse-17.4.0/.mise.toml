# ADR-0051: mise toolchain implementation
# Follows gapless-deribit-clickhouse exemplar pattern
min_version = "2024.9.5"

[env]
# Automatic venv activation - mise will use uv to create it
_.python.venv = { path = ".venv", create = true }
# Load credentials from .env (local development)
_.file = '.env'

# Dual-mode: "auto" (default), "local" for backtesting, "cloud" for production
# ADR-0044: Local ClickHouse as Alternative Deployment Mode
GCCH_MODE = "auto"

# Database configuration
CLICKHOUSE_DATABASE = "default"

# Local ClickHouse (when GCCH_MODE=local or localhost detected)
CLICKHOUSE_LOCAL_HOST = "localhost"
CLICKHOUSE_LOCAL_PORT = "8123"

# ClickHouse Server Configuration (local development)
# ADR-0044, ADR-0045: Local ClickHouse E2E validation
CLICKHOUSE_DATA_DIR = "{{config_root}}/tmp/clickhouse/data"
CLICKHOUSE_LOG_DIR = "{{config_root}}/tmp/clickhouse/logs"
CLICKHOUSE_PID_FILE = "{{config_root}}/tmp/clickhouse/clickhouse.pid"

[tools]
# Flexible Python: accept any 3.11+ (matches pyproject.toml requires-python)
python = "3"
uv = "latest"
clickhouse = "latest"  # mise-managed (replaces Homebrew)
node = "latest"        # For semantic-release

# =============================================================================
# Core Development Tasks
# =============================================================================

[tasks.install]
description = "Install dependencies with uv"
alias = "i"
run = "uv sync --all-extras"

[tasks.venv-recreate]
description = "Recreate virtual environment from scratch"
run = """
rm -rf .venv
uv venv .venv
uv sync --all-extras
"""

[tasks.test]
description = "Run all tests"
run = "uv run pytest tests/ -v"

[tasks.test-unit]
description = "Run unit tests only (no external dependencies)"
depends = ["lint"]
run = "uv run pytest tests/ -v -m 'not slow and not e2e and not integration'"

[tasks.lint]
description = "Run ruff linting"
run = "uv run ruff check src/"

[tasks.format]
description = "Format code"
run = "uv run ruff format src/ tests/"

[tasks.type-check]
description = "Run mypy type checking"
run = "uv run mypy src/"

[tasks.lint-all]
description = "Run all linting (ruff + mypy)"
depends = ["lint", "type-check"]
run = "echo '✓ All linting passed'"

# =============================================================================
# ClickHouse Server Management Tasks
# ADR-0044, ADR-0045: Local ClickHouse E2E Validation
# =============================================================================

[tasks._ch-dirs]
description = "Create ClickHouse data directories"
hide = true
run = 'mkdir -p "$CLICKHOUSE_DATA_DIR" "$CLICKHOUSE_LOG_DIR"'

[tasks.ch-start]
description = "Start local ClickHouse server"
depends = ["_ch-dirs"]
run = """
if [ -f "$CLICKHOUSE_PID_FILE" ] && kill -0 $(cat "$CLICKHOUSE_PID_FILE") 2>/dev/null; then
  echo "✓ ClickHouse already running (PID $(cat $CLICKHOUSE_PID_FILE))"
else
  clickhouse server --daemon \\
    --pid-file="$CLICKHOUSE_PID_FILE" \\
    --path="$CLICKHOUSE_DATA_DIR" \\
    -- --logger.log="$CLICKHOUSE_LOG_DIR/clickhouse-server.log" \\
       --logger.errorlog="$CLICKHOUSE_LOG_DIR/clickhouse-server.err.log"
  sleep 2
  curl -s http://localhost:8123/ping && echo "✓ ClickHouse started"
fi
"""

[tasks.ch-stop]
description = "Stop local ClickHouse server"
run = """
if [ -f "$CLICKHOUSE_PID_FILE" ]; then
  kill $(cat "$CLICKHOUSE_PID_FILE") 2>/dev/null && echo "✓ ClickHouse stopped"
  rm -f "$CLICKHOUSE_PID_FILE"
else
  echo "ClickHouse not running"
fi
"""

[tasks.ch-status]
description = "Check ClickHouse server status"
run = 'curl -s http://localhost:8123/ping && echo "✓ ClickHouse running" || echo "❌ ClickHouse not running"'

[tasks.ch-logs]
description = "Tail ClickHouse server logs"
run = "tail -f $CLICKHOUSE_LOG_DIR/clickhouse-server.log"

[tasks.ch-client]
description = "Open ClickHouse client connected to local server"
run = "clickhouse client --host localhost --port 9000"

# =============================================================================
# Hidden Helper Tasks
# =============================================================================

[tasks._check-local-server]
description = "Verify local ClickHouse is running"
hide = true
run = """
curl -s http://localhost:8123/ping > /dev/null 2>&1 || {
  echo "❌ Local ClickHouse not running. Start with: mise run ch-start"
  exit 1
}
echo "✓ Local ClickHouse running"
"""

[tasks._check-credentials]
description = "Verify ClickHouse Cloud credentials are set"
hide = true
run = """
if [ -z "$CLICKHOUSE_HOST" ]; then
  echo "❌ CLICKHOUSE_HOST not set. Configure .env or set environment variables"
  exit 1
fi
echo "✓ Cloud credentials configured"
"""

[tasks._check-binance-cdn]
description = "Verify Binance CDN is reachable"
hide = true
run = """
curl -sf "https://data.binance.vision/data/spot/monthly/klines/BTCUSDT/1h/BTCUSDT-1h-2024-01.zip" -o /dev/null && \\
  echo "✓ Binance CDN reachable" || \\
  { echo "❌ Binance CDN unreachable"; exit 1; }
"""

[tasks._check-binance-api]
description = "Verify Binance REST API is reachable"
hide = true
run = """
curl -sf "https://api.binance.com/api/v3/ping" > /dev/null && \\
  echo "✓ Binance REST API reachable" || \\
  { echo "❌ Binance REST API unreachable"; exit 1; }
"""

# =============================================================================
# Database Schema Tasks
# =============================================================================

[tasks.db-init]
description = "Deploy schema to ClickHouse (local or cloud based on GCCH_MODE)"
depends = ["_check-local-server"]
run = """
clickhouse client --host localhost --port 9000 --multiquery < src/gapless_crypto_clickhouse/clickhouse/schema.sql
echo "✓ Schema deployed"
"""

[tasks.local-init]
description = "Initialize local ClickHouse with schema"
env = { GCCH_MODE = "local" }
depends = ["_check-local-server"]
depends_post = ["local-validate"]
run = """
clickhouse client --host localhost --port 9000 --multiquery < src/gapless_crypto_clickhouse/clickhouse/schema.sql
echo "✓ Local schema deployed"
"""

[tasks.local-validate]
description = "Validate local ClickHouse schema"
env = { GCCH_MODE = "local" }
run = """
uv run python -c "
from gapless_crypto_clickhouse.clickhouse import ClickHouseConnection
with ClickHouseConnection() as conn:
    tables = conn.client.command('SHOW TABLES')
    if 'ohlcv' in tables:
        print('✓ Schema validated: ohlcv table exists')
    else:
        print('❌ Schema validation failed: ohlcv table missing')
        exit(1)
"
"""

[tasks.cloud-validate]
description = "Validate cloud ClickHouse schema"
env = { GCCH_MODE = "cloud" }
depends = ["_check-credentials"]
run = """
uv run python -c "
from gapless_crypto_clickhouse.clickhouse import ClickHouseConnection
with ClickHouseConnection() as conn:
    tables = conn.client.command('SHOW TABLES')
    if 'ohlcv' in tables:
        print('✓ Cloud schema validated: ohlcv table exists')
    else:
        print('❌ Cloud schema validation failed: ohlcv table missing')
        exit(1)
"
"""

# =============================================================================
# Data Seeding Tasks
# =============================================================================

[tasks.seed-local]
description = "Seed local ClickHouse with sample BTCUSDT data"
env = { GCCH_MODE = "local" }
depends = ["_check-local-server", "_check-binance-cdn", "local-init"]
run = """
uv run python -c "
from gapless_crypto_clickhouse import query_ohlcv
import logging
logging.basicConfig(level=logging.INFO)

print('Seeding local ClickHouse with BTCUSDT 1h data (2024-01)...')
df = query_ohlcv(
    symbol='BTCUSDT',
    timeframe='1h',
    start_date='2024-01-01',
    end_date='2024-01-31',
    auto_ingest=True
)
print(f'✓ Local seeded with {len(df):,} rows')
"
"""

[tasks.seed-cloud]
description = "Seed cloud ClickHouse with sample BTCUSDT data (Doppler-wrapped)"
depends = ["_check-binance-cdn"]
run = """
echo "Seeding cloud ClickHouse with Doppler credentials..."

# Direct Python execution bypasses mise _.file='.env' override
doppler run --project aws-credentials --config prd -- uv run python -c "
from gapless_crypto_clickhouse import query_ohlcv
import logging
logging.basicConfig(level=logging.INFO)

print('Seeding cloud ClickHouse with BTCUSDT 1h data (2024-01)...')
df = query_ohlcv(
    symbol='BTCUSDT',
    timeframe='1h',
    start_date='2024-01-01',
    end_date='2024-01-31',
    auto_ingest=True
)
print(f'✓ Cloud seeded with {len(df):,} rows')
"
"""

# =============================================================================
# Data Validation Tasks
# =============================================================================

[tasks._check-local-data]
description = "Verify local ClickHouse has data"
hide = true
env = { GCCH_MODE = "local" }
depends = ["_check-local-server"]
run = """
uv run python -c "
from gapless_crypto_clickhouse.clickhouse import ClickHouseConnection
with ClickHouseConnection() as conn:
    count = conn.client.command('SELECT count() FROM ohlcv')
    if count < 100:
        print(f'⚠️  Local: insufficient data ({count} rows)')
        print('   Run: mise run seed-local')
        exit(1)
    print(f'✓ Local ClickHouse: {count:,} rows')
"
"""

[tasks._check-cloud-data]
description = "Verify cloud ClickHouse has data"
hide = true
env = { GCCH_MODE = "cloud" }
depends = ["_check-credentials"]
run = """
uv run python -c "
from gapless_crypto_clickhouse.clickhouse import ClickHouseConnection
with ClickHouseConnection() as conn:
    count = conn.client.command('SELECT count() FROM ohlcv')
    if count < 100:
        print(f'❌ Cloud: insufficient data ({count} rows)')
        exit(1)
    print(f'✓ Cloud ClickHouse: {count:,} rows')
"
"""

# =============================================================================
# E2E Validation Tasks
# =============================================================================

[tasks.validate-local]
description = "Full validation of local ClickHouse"
env = { GCCH_MODE = "local" }
depends = ["_check-binance-cdn", "_check-local-server", "local-validate", "_check-local-data"]
run = """
echo ""
echo "═══════════════════════════════════════════════════════════"
echo "  ✓ Local Validation Passed"
echo "═══════════════════════════════════════════════════════════"
echo "  • Binance CDN: reachable"
echo "  • Local ClickHouse: running"
echo "  • Schema: ohlcv table exists"
echo "  • Data: sufficient rows"
echo "═══════════════════════════════════════════════════════════"
"""

[tasks.validate-cloud]
description = "Full validation of cloud ClickHouse"
env = { GCCH_MODE = "cloud" }
depends = ["_check-binance-cdn", "_check-credentials", "cloud-validate", "_check-cloud-data"]
run = """
echo ""
echo "═══════════════════════════════════════════════════════════"
echo "  ✓ Cloud Validation Passed"
echo "═══════════════════════════════════════════════════════════"
echo "  • Binance CDN: reachable"
echo "  • Cloud credentials: configured"
echo "  • Schema: ohlcv table exists"
echo "  • Data: sufficient rows"
echo "═══════════════════════════════════════════════════════════"
"""

[tasks.validate-full]
description = "Full validation: Local + Cloud (both environments)"
depends = ["_check-binance-cdn", "_check-binance-api", "validate-local", "validate-cloud"]
run = """
echo ""
echo "═══════════════════════════════════════════════════════════"
echo "  ✓ FULL DUAL-MODE VALIDATION PASSED"
echo "═══════════════════════════════════════════════════════════"
echo "  • Binance CDN: reachable"
echo "  • Binance REST API: reachable"
echo "  • Local ClickHouse: schema ✓ | data ✓"
echo "  • Cloud ClickHouse: schema ✓ | data ✓"
echo "═══════════════════════════════════════════════════════════"
"""

[tasks.validate-production]
description = "Production validation (Doppler-wrapped cloud access)"
run = """
echo "Running production validation with Doppler credentials..."

# Direct Python execution bypasses mise _.file='.env' override
doppler run --project aws-credentials --config prd -- uv run python -c "
from gapless_crypto_clickhouse.clickhouse import ClickHouseConnection
import os

# Verify Doppler credentials are injected
host = os.environ.get('CLICKHOUSE_HOST', '')
if not host or 'clickhouse.cloud' not in host:
    print(f'❌ Invalid CLICKHOUSE_HOST: {host}')
    print('   Ensure Doppler credentials are configured')
    exit(1)

print(f'✓ Doppler credentials: {host}')

with ClickHouseConnection() as conn:
    # Validate schema
    tables = conn.client.command('SHOW TABLES')
    if 'ohlcv' not in tables:
        print('❌ Schema validation failed: ohlcv table missing')
        exit(1)
    print('✓ Schema validated: ohlcv table exists')

    # Validate data
    count = conn.client.command('SELECT count() FROM ohlcv')
    print(f'✓ Cloud ClickHouse: {count:,} rows')

print('')
print('═══════════════════════════════════════════════════════════')
print('  ✓ Production Validation Passed')
print('═══════════════════════════════════════════════════════════')
"
"""

# =============================================================================
# E2E Test Tasks (colon-prefixed namespacing per mise-tasks skill)
# =============================================================================

[tasks."test:e2e:local"]
description = "Run E2E tests against local ClickHouse"
env = { GCCH_MODE = "local" }
depends = ["_check-binance-cdn", "_check-local-server", "_check-local-data"]
run = "uv run pytest tests/ -v -m integration"

[tasks."test:e2e:cloud"]
description = "Run E2E tests against cloud ClickHouse"
env = { GCCH_MODE = "cloud" }
depends = ["_check-binance-cdn", "_check-credentials", "_check-cloud-data"]
run = "uv run pytest tests/ -v -m integration"

# =============================================================================
# Data Quality Validation Tasks (ADR-0048: ClickHouse-native validation)
# =============================================================================

[tasks."validate:ohlc-constraints"]
description = "Validate OHLC constraints (high >= open/close/low, volume >= 0)"
env = { GCCH_MODE = "local" }
depends = ["_check-local-server"]
run = """
uv run python -c "
from gapless_crypto_clickhouse.clickhouse import ClickHouseConnection

with ClickHouseConnection() as conn:
    # Check OHLC constraint violations
    violations = conn.client.command('''
        SELECT COUNT(*) FROM ohlcv FINAL
        WHERE high < open OR high < close OR high < low
           OR low > open OR low > close
           OR volume < 0
    ''')

    if violations > 0:
        # Get sample violations for debugging
        samples = conn.client.query('''
            SELECT symbol, timeframe, timestamp, open, high, low, close, volume
            FROM ohlcv FINAL
            WHERE high < open OR high < close OR high < low
               OR low > open OR low > close
               OR volume < 0
            LIMIT 5
        ''')
        print(f'❌ OHLC constraint violations: {violations}')
        print('Sample violations:')
        for row in samples.result_rows:
            print(f'  {row}')
        exit(1)

    total = conn.client.command('SELECT COUNT(*) FROM ohlcv FINAL')
    print(f'✓ OHLC constraints valid ({total:,} rows, 0 violations)')
"
"""

[tasks."validate:gap-detection"]
description = "Detect gaps in OHLCV data for BTCUSDT 1h"
env = { GCCH_MODE = "local" }
depends = ["_check-local-server", "_check-local-data"]
run = """
uv run python -c "
from gapless_crypto_clickhouse.clickhouse import ClickHouseConnection
from gapless_crypto_clickhouse.clickhouse_query import OHLCVQuery

with ClickHouseConnection() as conn:
    query = OHLCVQuery(conn)

    # Get date range
    result = conn.client.query('''
        SELECT MIN(timestamp), MAX(timestamp)
        FROM ohlcv FINAL
        WHERE symbol = 'BTCUSDT' AND timeframe = '1h'
    ''')
    min_ts, max_ts = result.result_rows[0]

    if min_ts is None:
        print('⚠️  No BTCUSDT 1h data found')
        exit(0)

    # Detect gaps using OHLCVQuery
    gaps = query.detect_gaps(
        symbol='BTCUSDT',
        timeframe='1h',
        start=min_ts.strftime('%Y-%m-%d'),
        end=max_ts.strftime('%Y-%m-%d'),
        instrument_type='spot'
    )

    if len(gaps) > 0:
        print(f'⚠️  Detected {len(gaps)} gaps in BTCUSDT 1h data:')
        for _, gap in gaps.head(5).iterrows():
            print(f'  {gap[\"gap_start\"]} to {gap[\"gap_end\"]}')
        if len(gaps) > 5:
            print(f'  ... and {len(gaps) - 5} more')
    else:
        print(f'✓ Zero gaps detected (BTCUSDT 1h: {min_ts} to {max_ts})')
"
"""

[tasks."validate:dedup-monitoring"]
description = "Monitor deduplication status (FINAL vs non-FINAL row counts)"
env = { GCCH_MODE = "local" }
depends = ["_check-local-server", "_check-local-data"]
run = """
uv run python -c "
from gapless_crypto_clickhouse.clickhouse import ClickHouseConnection

with ClickHouseConnection() as conn:
    # Count with FINAL (deduplicated)
    final_count = conn.client.command('SELECT COUNT(*) FROM ohlcv FINAL')

    # Count without FINAL (includes pending merges)
    raw_count = conn.client.command('SELECT COUNT(*) FROM ohlcv')

    # Calculate duplication ratio
    if final_count > 0:
        dup_ratio = (raw_count - final_count) / final_count * 100
    else:
        dup_ratio = 0

    # Alert if duplication exceeds 5%
    if dup_ratio > 5:
        print(f'⚠️  High duplication detected: {dup_ratio:.1f}%')
        print(f'   Raw: {raw_count:,} | Deduplicated: {final_count:,}')
        print('   Consider running OPTIMIZE TABLE ohlcv FINAL')
    else:
        print(f'✓ Deduplication healthy: {dup_ratio:.2f}% pending merge')
        print(f'  Raw: {raw_count:,} | Deduplicated: {final_count:,}')
"
"""

[tasks."validate:performance"]
description = "Benchmark query latency and insert throughput"
env = { GCCH_MODE = "local" }
depends = ["_check-local-server", "_check-local-data"]
run = """
uv run python -c "
import time
from gapless_crypto_clickhouse.clickhouse import ClickHouseConnection

with ClickHouseConnection() as conn:
    print('Running performance benchmarks...')
    print('')

    # Benchmark 1: Simple SELECT with FINAL
    start = time.perf_counter()
    conn.client.query('''
        SELECT * FROM ohlcv FINAL
        WHERE symbol = 'BTCUSDT' AND timeframe = '1h'
        LIMIT 1000
    ''')
    simple_ms = (time.perf_counter() - start) * 1000

    # Benchmark 2: Aggregation query
    start = time.perf_counter()
    conn.client.query('''
        SELECT symbol, timeframe, COUNT(*), AVG(close), SUM(volume)
        FROM ohlcv FINAL
        WHERE symbol = 'BTCUSDT'
        GROUP BY symbol, timeframe
    ''')
    agg_ms = (time.perf_counter() - start) * 1000

    # Benchmark 3: Date range query
    start = time.perf_counter()
    conn.client.query('''
        SELECT * FROM ohlcv FINAL
        WHERE symbol = 'BTCUSDT' AND timeframe = '1h'
          AND timestamp >= now() - INTERVAL 30 DAY
        ORDER BY timestamp
    ''')
    range_ms = (time.perf_counter() - start) * 1000

    # Report results
    print('Query Latency Benchmarks:')
    print(f'  Simple SELECT (1K rows): {simple_ms:.1f}ms')
    print(f'  Aggregation query:       {agg_ms:.1f}ms')
    print(f'  Date range (30 days):    {range_ms:.1f}ms')
    print('')

    # Alert if any query exceeds 100ms threshold
    if max(simple_ms, agg_ms, range_ms) > 100:
        print(f'⚠️  Some queries exceed 100ms threshold')
    else:
        print(f'✓ All queries under 100ms threshold')
"
"""

# =============================================================================
# Development Workflow Tasks
# =============================================================================

[tasks.dev]
description = "Start development environment (local ClickHouse)"
depends = ["ch-start", "local-init"]
run = "echo '✓ Development environment ready (local ClickHouse)'"

[tasks.ci]
description = "Full CI pipeline (lint + unit tests)"
depends = ["lint", "test-unit"]
run = "echo '✓ CI pipeline passed'"

[tasks.pre-release]
description = "Pre-release validation (lint + tests)"
depends = ["lint-all", "test-unit", "validate-local"]
run = "echo '✓ Ready for release'"

# =============================================================================
# Connection Info Tasks
# =============================================================================

[tasks.db-connect-info]
description = "Print connection settings for any GUI tool"
run = """
echo "=== ClickHouse Connection Settings ==="
echo ""
echo "LOCAL (development):"
echo "  Host:     localhost"
echo "  Port:     8123 (HTTP) / 9000 (Native)"
echo "  Database: default"
echo "  User:     default"
echo "  Password: (empty)"
echo "  SSL:      No"
echo ""
echo "CLOUD (production):"
echo "  Host:     (from CLICKHOUSE_HOST env var)"
echo "  Port:     8443 (HTTPS)"
echo "  Database: default"
echo "  User:     (from CLICKHOUSE_USER env var)"
echo "  Password: (from CLICKHOUSE_PASSWORD env var)"
echo "  SSL:      Yes"
"""
