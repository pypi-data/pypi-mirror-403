     ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
     │ OCR Vector DB 리팩토링 계획                                                                                         │
     │                                                                                                                     │
     │ 개요                                                                                                                │
     │                                                                                                                     │
     │ docs/ARCHITECTURE.md 기반으로 현재 flat monolithic 구조(app/)를 7-패키지 아키텍처로 리팩토링합니다.                 │
     │                                                                                                                     │
     │ 핵심 결정사항:                                                                                                      │
     │ - 순수 도메인 엔티티 사용 (LangChain Document 의존성 storage 레이어로 격리)                                         │
     │ - 도메인 모델 우선 구현 (shared → domain → ingestion 순)                                                            │
     │ - 병렬 구조 유지 (새 패키지와 기존 app/ 공존, 단계적 전환)                                                          │
     │                                                                                                                     │
     │ ---                                                                                                                 │
     │ 목표 패키지 구조                                                                                                    │
     │                                                                                                                     │
     │ project_root/                                                                                                       │
     │ ├── domain/           # 순수 도메인 엔티티 (인프라 의존성 금지)                                                     │
     │ ├── ingestion/        # 파일 파싱, 세그멘테이션                                                                     │
     │ ├── embedding/        # 벡터 생성, doc_id 계산                                                                      │
     │ ├── retrieval/        # 검색 파이프라인, 컨텍스트 조립                                                              │
     │ ├── storage/          # DB 작업, 리포지토리                                                                         │
     │ ├── api/              # CLI, REST 엔드포인트                                                                        │
     │ ├── shared/           # 공통 유틸리티, 예외                                                                         │
     │ └── app/              # (기존 코드 - 점진적 제거)                                                                   │
     │                                                                                                                     │
     │ 의존성 방향: api → ingestion/embedding/retrieval → storage → domain → shared                                        │
     │                                                                                                                     │
     │ ---                                                                                                                 │
     │ Phase 1: Foundation Layer (shared/ + domain/)                                                                       │
     │                                                                                                                     │
     │ 1.1 shared/ 패키지 생성                                                                                             │
     │                                                                                                                     │
     │ | 대상 파일            | 소스              | 변경사항                               |                               │
     │ |----------------------|-------------------|----------------------------------------|                               │
     │ | shared/__init__.py   | 새로 생성         | 패키지 초기화                          |                               │
     │ | shared/config.py     | app/config.py     | EmbeddingConfig 분리 (domain으로 이동) |                               │
     │ | shared/text_utils.py | app/text_utils.py | 그대로 이동                            |                               │
     │ | shared/hashing.py    | app/utils.py      | HashingService, Slugifier 추출         |                               │
     │ | shared/exceptions.py | 새로 생성         | SharedError 베이스 클래스              |                               │
     │                                                                                                                     │
     │ 1.2 domain/ 패키지 생성                                                                                             │
     │                                                                                                                     │
     │ | 대상 파일               | 내용                                          |                                         │
     │ |-------------------------|-----------------------------------------------|                                         │
     │ | domain/__init__.py      | 엔티티 export                                 |                                         │
     │ | domain/entities.py      | Document, Concept, Fragment, Embedding 클래스 |                                         │
     │ | domain/value_objects.py | View(Enum), ContentHash, Language             |                                         │
     │ | domain/exceptions.py    | OrphanEntityError, FragmentTooShortError 등   |                                         │
     │                                                                                                                     │
     │ 핵심 엔티티 정의:                                                                                                   │
     │                                                                                                                     │
     │ # domain/entities.py                                                                                                │
     │ @dataclass                                                                                                          │
     │ class Document:                                                                                                     │
     │     id: str                                                                                                         │
     │     source_path: str                                                                                                │
     │     created_at: datetime                                                                                            │
     │                                                                                                                     │
     │ @dataclass                                                                                                          │
     │ class Concept:                                                                                                      │
     │     id: str                                                                                                         │
     │     document_id: str                                                                                                │
     │     order: int                                                                                                      │
     │                                                                                                                     │
     │     def validate(self) -> None:                                                                                     │
     │         if not self.document_id:                                                                                    │
     │             raise OrphanEntityError("HIER-002 위반")                                                                │
     │                                                                                                                     │
     │ @dataclass                                                                                                          │
     │ class Fragment:                                                                                                     │
     │     id: str                                                                                                         │
     │     concept_id: str  # parent_id                                                                                    │
     │     content: str                                                                                                    │
     │     view: View                                                                                                      │
     │     language: Optional[str]                                                                                         │
     │     order: int                                                                                                      │
     │                                                                                                                     │
     │     def validate(self) -> None:                                                                                     │
     │         if not self.concept_id:                                                                                     │
     │             raise OrphanEntityError("HIER-003 위반")                                                                │
     │                                                                                                                     │
     │ @dataclass                                                                                                          │
     │ class Embedding:                                                                                                    │
     │     doc_id: str  # hash(parent_id + view + lang + content)                                                          │
     │     fragment_id: str                                                                                                │
     │     vector: List[float]                                                                                             │
     │                                                                                                                     │
     │ 검증 기준:                                                                                                          │
     │ - domain/에 SQLAlchemy, LangChain, psycopg import 없음                                                              │
     │ - domain/에 shared/ 외 다른 프로젝트 패키지 import 없음                                                             │
     │ - 모든 엔티티에 validate() 메서드로 불변성 검증                                                                     │
     │                                                                                                                     │
     │ ---                                                                                                                 │
     │ Phase 2: Ingestion Layer                                                                                            │
     │                                                                                                                     │
     │ 2.1 ingestion/parsers/ 생성                                                                                         │
     │                                                                                                                     │
     │ | 대상 파일                     | 소스                   | 변경사항               |                                 │
     │ |-------------------------------|------------------------|------------------------|                                 │
     │ | ingestion/parsers/base.py     | app/parsers.py:13-18   | BaseSegmentParser 추출 |                                 │
     │ | ingestion/parsers/ocr.py      | app/parsers.py:22-38   | OcrParser 추출         |                                 │
     │ | ingestion/parsers/markdown.py | app/parsers.py:41-131  | MarkdownParser 추출    |                                 │
     │ | ingestion/parsers/pdf.py      | app/parsers.py:133-169 | PdfExtractor 추출      |                                 │
     │                                                                                                                     │
     │ 2.2 ingestion/segmentation.py                                                                                       │
     │                                                                                                                     │
     │ | 소스                   | 변경사항             |                                                                   │
     │ |------------------------|----------------------|                                                                   │
     │ | app/parsers.py:171-261 | SegmentUnitizer 이동 |                                                                   │
     │                                                                                                                     │
     │ 2.3 ingestion/concept_builder.py (새로 생성)                                                                        │
     │                                                                                                                     │
     │ 책임:                                                                                                               │
     │ - UnitizedSegment → domain.Concept + domain.Fragment 변환                                                           │
     │ - parent_id 생성 시점 확정 (FRAG-IMMUT-001)                                                                         │
     │ - 고아 엔티티 방지 (HIER-003)                                                                                       │
     │                                                                                                                     │
     │ class ConceptBuilder:                                                                                               │
     │     def build(self, unitized: List[UnitizedSegment], document: Document) -> List[Concept]:                          │
     │         # UnitizedSegment를 Concept으로 변환                                                                        │
     │         # 각 Concept 내 Fragment 생성 및 parent_id 할당                                                             │
     │         pass                                                                                                        │
     │                                                                                                                     │
     │ 검증 기준:                                                                                                          │
     │ - ingestion/에 embedding/, retrieval/, storage/, api/ import 없음                                                   │
     │ - 생성된 모든 Fragment에 유효한 concept_id (parent_id) 존재                                                         │
     │ - 기존 파싱 테스트 통과                                                                                             │
     │                                                                                                                     │
     │ ---                                                                                                                 │
     │ Phase 3: Embedding Layer                                                                                            │
     │                                                                                                                     │
     │ 3.1 embedding/provider.py                                                                                           │
     │                                                                                                                     │
     │ | 소스                            | 변경사항                                        |                               │
     │ |---------------------------------|-------------------------------------------------|                               │
     │ | app/embeddings_provider.py:8-53 | EmbeddingProviderFactory, GeminiEmbeddings 추출 |                               │
     │                                                                                                                     │
     │ 3.2 embedding/doc_id.py                                                                                             │
     │                                                                                                                     │
     │ | 소스                             | 변경사항                           |                                           │
     │ |----------------------------------|------------------------------------|                                           │
     │ | app/embeddings_provider.py:83-86 | compute_doc_id 추출                |                                           │
     │ | app/utils.py:9-30                | HashingService.compute_doc_id 통합 |                                           │
     │                                                                                                                     │
     │ 핵심 로직 (EMBED-ID-002):                                                                                           │
     │ def compute_doc_id(fragment: Fragment) -> str:                                                                      │
     │     payload = f"{fragment.concept_id}|{fragment.view.value}|{fragment.language or ''}|{fragment.content}"           │
     │     return f"doc:{hashlib.md5(payload.encode()).hexdigest()}"                                                       │
     │                                                                                                                     │
     │ 3.3 embedding/validators.py (새로 생성)                                                                             │
     │                                                                                                                     │
     │ 책임:                                                                                                               │
     │ - FRAG-LEN-001: Fragment < 10자 임베딩 금지                                                                         │
     │ - EMBED-BAN-001~006: 금지된 콘텐츠 필터링                                                                           │
     │                                                                                                                     │
     │ class EmbeddingValidator:                                                                                           │
     │     MIN_LENGTH = 10                                                                                                 │
     │                                                                                                                     │
     │     def is_eligible(self, fragment: Fragment) -> bool:                                                              │
     │         if len(fragment.content) < self.MIN_LENGTH:                                                                 │
     │             return False                                                                                            │
     │         if self._is_boilerplate(fragment.content):                                                                  │
     │             return False                                                                                            │
     │         return True                                                                                                 │
     │                                                                                                                     │
     │ 3.4 embedding/pipeline.py                                                                                           │
     │                                                                                                                     │
     │ | 소스                   | 변경사항                |                                                                │
     │ |------------------------|-------------------------|                                                                │
     │ | app/pipeline.py (일부) | 임베딩 관련 로직만 추출 |                                                                │
     │                                                                                                                     │
     │ 검증 기준:                                                                                                          │
     │ - embedding/에 ingestion/, retrieval/, api/ import 없음                                                             │
     │ - 모든 임베딩 ID가 결정적 (동일 콘텐츠 → 동일 ID)                                                                   │
     │ - 10자 미만 Fragment 임베딩되지 않음                                                                                │
     │                                                                                                                     │
     │ ---                                                                                                                 │
     │ Phase 4: Storage Layer                                                                                              │
     │                                                                                                                     │
     │ 4.1 storage/repositories/                                                                                           │
     │                                                                                                                     │
     │ | 대상 파일                              | 책임                      |                                              │
     │ |----------------------------------------|---------------------------|                                              │
     │ | storage/repositories/base.py           | Repository 인터페이스     |                                              │
     │ | storage/repositories/document_repo.py  | Document CRUD             |                                              │
     │ | storage/repositories/concept_repo.py   | Concept CRUD              |                                              │
     │ | storage/repositories/fragment_repo.py  | Fragment CRUD + 고아 검증 |                                              │
     │ | storage/repositories/embedding_repo.py | Embedding CRUD            |                                              │
     │                                                                                                                     │
     │ 4.2 storage/schema.py                                                                                               │
     │                                                                                                                     │
     │ | 소스                  | 변경사항             |                                                                    │
     │ |-----------------------|----------------------|                                                                    │
     │ | app/storage.py:15-208 | DbSchemaManager 이동 |                                                                    │
     │                                                                                                                     │
     │ 4.3 storage/cascade.py (새로 생성)                                                                                  │
     │                                                                                                                     │
     │ 책임:                                                                                                               │
     │ - CASCADE-001: Document 삭제 → 모든 Concept 삭제                                                                    │
     │ - CASCADE-002: Concept 삭제 → 모든 Fragment 삭제                                                                    │
     │ - CASCADE-003: Fragment 삭제 → 모든 Embedding 삭제                                                                  │
     │                                                                                                                     │
     │ 4.4 storage/adapters/langchain_adapter.py (새로 생성)                                                               │
     │                                                                                                                     │
     │ 책임:                                                                                                               │
                                                                        │
     │ - PGVector store 연동                                                                                               │
     │                                                                                                                     │
     │ class LangChainAdapter:                                                                                             │
     │     def to_langchain_document(self, fragment: Fragment) -> LangChainDocument:                                       │
     │         return LangChainDocument(                                                                                   │
     │             page_content=fragment.content,                                                                          │
     │             metadata={                                                                                              │
     │                 "parent_id": fragment.concept_id,                                                                   │
     │                 "view": fragment.view.value,                                                                        │
     │                 "lang": fragment.language,                                                                          │
     │                 ...                                                                                                 │
     │             }                                                                                                       │
     │         )                                                                                                           │
     │                                                                                                                     │
     │ 검증 기준:                                                                                                          │
     │ - storage/에 ingestion/, embedding/, retrieval/, api/ import 없음                                                   │
     │ - CASCADE 삭제 후 고아 엔티티 없음                                                                                  │
                                                                │
     │                                                                                                                     │
     │ ---                                                                                                                 │
     │ Phase 5: Retrieval Layer                                                                                            │
     │                                                                                                                     │
     │ 5.1 retrieval/search.py                                                                                             │
     │                                                                                                                     │
     │ | 소스                                  | 변경사항                 |                                                │
     │ |---------------------------------------|--------------------------|                                                │
     │ | app/test/retriever_multi_view_demo.py | 검색 로직 추출 및 정형화 |                                                │
     │                                                                                                                     │
     │ 5.2 retrieval/context_builder.py                                                                                    │
     │                                                                                                                     │
     │ | 소스           | 변경사항                   |                                                                     │
     │ |----------------|----------------------------|                                                                     │
     │ | app/parents.py | ParentDocumentBuilder 이동 |                                                                     │
     │                                                                                                                     │
     │ 5.3 retrieval/result_grouper.py (새로 생성)                                                                         │
     │                                                                                                                     │
     │ 책임:                                                                                                               │
     │ - SEARCH-RES-003: Concept 단위 결과 그룹화                                                                          │
     │ - SEARCH-RES-001: 검색 결과에 컨텍스트 포함                                                                         │
     │                                                                                                                     │
     │ 검증 기준:                                                                                                          │
     │ - retrieval/에 ingestion/, api/ import 없음                                                                         │
     │ - 검색 결과에 항상 Parent 컨텍스트 포함                                                                             │
     │ - Concept 단위 그룹화 정상 작동                                                                                     │
     │                                                                                                                     │
     │ ---                                                                                                                 │
     │ Phase 6: API Layer                                                                                                  │
     │                                                                                                                     │
     │ 6.1 api/cli/                                                                                                        │
     │                                                                                                                     │
     │ | 대상 파일         | 소스                | 변경사항                      |                                         │
     │ |-------------------|---------------------|-------------------------------|                                         │
     │ | api/cli/ingest.py | app/tools/ingest.py | 새 패키지 사용하도록 리팩토링 |                                         │
     │ | api/cli/search.py | 새로 생성           | 검색 CLI                      |                                         │
     │                                                                                                                     │
     │ 6.2 api/orchestrator.py (새로 생성)                                                                                 │
     │                                                                                                                     │
     │ 책임:                                                                                                               │
     │ - 전체 파이프라인 조정 (ingestion → embedding → storage)                                                            │
     │ - 트랜잭션 경계 관리                                                                                                │
     │ - 에러 핸들링                                                                                                       │
     │                                                                                                                     │
     │ 검증 기준:                                                                                                          │
     │ - api/에 비즈니스 로직 직접 구현 없음                                                                               │
     │ - CLI 명령어 정상 작동                                                                                              │
     │                                                                                                                     │
     │ ---                                                                                                                 │
     │ Phase 7: 통합 및 정리                                                                                               │
     │                                                                                                                     │
     │ 7.1 호환성 레이어 (임시)                                                                                            │
     │                                                                                                                     │
     │ # app/__init__.py - 기존 코드 호환성 유지                                                                           │
     │ from domain.entities import Document, Concept, Fragment                                                             │
     │ from ingestion import parsers                                                                                       │
     │ # deprecation warning 추가                                                                                          │
     │                                                                                                                     │
     │ 7.2 테스트 마이그레이션                                                                                             │
     │                                                                                                                     │
     │ - 모든 테스트를 새 패키지 구조로 업데이트                                                                           │
     │ - 도메인 불변성 테스트 추가                                                                                         │
     │                                                                                                                     │
     │ 7.3 레거시 코드 제거                                                                                                │
     │                                                                                                                     │
     │ 새 패키지로 완전 전환 후 app/ 디렉토리 삭제                                                                         │
     │                                                                                                                     │
     │ ---                                                                                                                 │
     │ 수정 대상 핵심 파일                                                                                                 │
     │                                                                                                                     │
     │ | 현재 파일                  | 목적지                                         | 우선순위 |                          │
     │ |----------------------------|------------------------------------------------|----------|                          │
     │ | app/models.py              | domain/entities.py, domain/value_objects.py    | P1       |                          │
     │ | app/config.py              | shared/config.py                               | P1       |                          │
     │ | app/text_utils.py          | shared/text_utils.py                           | P1       |                          │
     │ | app/utils.py               | shared/hashing.py, embedding/doc_id.py         | P1       |                          │
     │ | app/parsers.py             | ingestion/parsers/*, ingestion/segmentation.py | P2       |                          │
     │ | app/embeddings_provider.py | embedding/provider.py, embedding/doc_id.py     | P3       |                          │
     │ | app/pipeline.py            | embedding/pipeline.py, api/orchestrator.py     | P3/P6    |                          │
     │ | app/storage.py             | storage/repositories/*, storage/schema.py      | P4       |                          │
     │ | app/parents.py             | retrieval/context_builder.py                   | P5       |                          │
     │ | app/tools/ingest.py        | api/cli/ingest.py                              | P6       |                          │
     │                                                                                                                     │
     │ ---                                                                                                                 │
     │ 도메인 규칙 적용 체크리스트                                                                                         │
     │                                                                                                                     │
     │ | 규칙 ID             | 설명                                             | 적용 위치                              | │
     │ |---------------------|--------------------------------------------------|----------------------------------------| │
     │ | HIER-003            | 모든 Fragment는 유효한 parent_id 필수            | domain/entities.py Fragment.validate() | │
     │ | FRAG-LEN-001        | 10자 미만 Fragment 임베딩 금지                   | embedding/validators.py                | │
     │ | EMBED-ID-002        | doc_id = hash(parent_id + view + lang + content) | embedding/doc_id.py                    | │
     │ | SEARCH-RES-001      | 검색 결과에 컨텍스트 포함                        | retrieval/result_grouper.py            | │
     │ | CASCADE-001~004     | 계층 삭제 시 연쇄 삭제                           | storage/cascade.py                     | │
     │ | PKG-DOM-BAN-001~004 | domain/ 인프라 import 금지                       | 모든 domain/ 파일                      | │
     │                                                                                                                     │
     │ ---                                                                                                                 │
     │ 실행 순서                                                                                                           │
     │                                                                                                                     │
     │ 1. Phase 1 - shared/ + domain/ 생성 (기반 레이어)                                                                   │
     │ 2. Phase 2 - ingestion/ 생성 (파싱 레이어)                                                                          │
     │ 3. Phase 3 - embedding/ 생성 (벡터 레이어)                                                                          │
     │ 4. Phase 4 - storage/ 생성 (저장 레이어)                                                                            │
     │ 5. Phase 5 - retrieval/ 생성 (검색 레이어)                                                                          │
     │ 6. Phase 6 - api/ 생성 (진입점 레이어)                                                                              │
     │ 7. Phase 7 - 통합, 테스트, app/ 제거  