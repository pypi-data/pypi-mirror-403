# Start of tutor-contrib-k8s patches
{% if K8S_LMS_HPA_ENABLE %}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: lms-hpa
  namespace: {{ K8S_NAMESPACE }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: lms
  minReplicas: {{ K8S_LMS_REPLICAS }}
  maxReplicas: {{ K8S_LMS_MAX_REPLICAS }}
  metrics:
    {% if K8S_LMS_HPA_CPU_ENABLE %}
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ K8S_LMS_HPA_CPU_AVERAGE_UTILIZATION }}
    {% endif %}
    {% if K8S_LMS_HPA_MEMORY_ENABLE %}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ K8S_LMS_HPA_MEMORY_AVERAGE_UTILIZATION }}
    {% endif %}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: {{ K8S_LMS_HPA_SCALE_UP_STABILIZATION_WINDOW_SECONDS }}
      selectPolicy: Max
      policies:
        - type: Percent
          value: {{ K8S_LMS_HPA_SCALE_UP_PERCENT }}
          periodSeconds: {{ K8S_LMS_HPA_SCALE_UP_PERIOD_SECONDS }}
        - type: Pods
          value: {{ K8S_LMS_HPA_SCALE_UP_PODS }}
          periodSeconds: {{ K8S_LMS_HPA_SCALE_UP_PERIOD_SECONDS }}
    scaleDown:
      stabilizationWindowSeconds: {{ K8S_LMS_HPA_SCALE_DOWN_STABILIZATION_WINDOW_SECONDS }}
      selectPolicy: Min
      policies:
        - type: Percent
          value: {{ K8S_LMS_HPA_SCALE_DOWN_PERCENT }}
          periodSeconds: {{ K8S_LMS_HPA_SCALE_DOWN_PERIOD_SECONDS }}
        - type: Pods
          value: {{ K8S_LMS_HPA_SCALE_DOWN_PODS }}
          periodSeconds: {{ K8S_LMS_HPA_SCALE_DOWN_PERIOD_SECONDS }}
{% endif %}

{% if K8S_LMS_WORKER_HPA_ENABLE %}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: lms-worker-hpa
  namespace: {{ K8S_NAMESPACE }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: lms-worker
  minReplicas: {{ K8S_LMS_WORKER_REPLICAS }}
  maxReplicas: {{ K8S_LMS_WORKER_MAX_REPLICAS }}
  metrics:
    {% if K8S_LMS_WORKER_HPA_CPU_ENABLE %}
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ K8S_LMS_WORKER_HPA_CPU_AVERAGE_UTILIZATION }}
    {% endif %}
    {% if K8S_LMS_WORKER_HPA_MEMORY_ENABLE %}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ K8S_LMS_WORKER_HPA_MEMORY_AVERAGE_UTILIZATION }}
    {% endif %}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: {{ K8S_LMS_WORKER_HPA_SCALE_UP_STABILIZATION_WINDOW_SECONDS }}
      selectPolicy: Max
      policies:
        - type: Percent
          value: {{ K8S_LMS_WORKER_HPA_SCALE_UP_PERCENT }}
          periodSeconds: {{ K8S_LMS_WORKER_HPA_SCALE_UP_PERIOD_SECONDS }}
        - type: Pods
          value: {{ K8S_LMS_WORKER_HPA_SCALE_UP_PODS }}
          periodSeconds: {{ K8S_LMS_WORKER_HPA_SCALE_UP_PERIOD_SECONDS }}
    scaleDown:
      stabilizationWindowSeconds: {{ K8S_LMS_WORKER_HPA_SCALE_DOWN_STABILIZATION_WINDOW_SECONDS }}
      selectPolicy: Min
      policies:
        - type: Percent
          value: {{ K8S_LMS_WORKER_HPA_SCALE_DOWN_PERCENT }}
          periodSeconds: {{ K8S_LMS_WORKER_HPA_SCALE_DOWN_PERIOD_SECONDS }}
        - type: Pods
          value: {{ K8S_LMS_WORKER_HPA_SCALE_DOWN_PODS }}
          periodSeconds: {{ K8S_LMS_WORKER_HPA_SCALE_DOWN_PERIOD_SECONDS }}
{% endif %}

{% if K8S_CMS_HPA_ENABLE %}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: cms-hpa
  namespace: {{ K8S_NAMESPACE }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: cms
  minReplicas: {{ K8S_CMS_REPLICAS }}
  maxReplicas: {{ K8S_CMS_MAX_REPLICAS }}
  metrics:
    {% if K8S_CMS_HPA_CPU_ENABLE %}
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ K8S_CMS_HPA_CPU_AVERAGE_UTILIZATION }}
    {% endif %}
    {% if K8S_CMS_HPA_MEMORY_ENABLE %}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ K8S_CMS_HPA_MEMORY_AVERAGE_UTILIZATION }}
    {% endif %}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: {{ K8S_CMS_HPA_SCALE_UP_STABILIZATION_WINDOW_SECONDS }}
      selectPolicy: Max
      policies:
        - type: Percent
          value: {{ K8S_CMS_HPA_SCALE_UP_PERCENT }}
          periodSeconds: {{ K8S_CMS_HPA_SCALE_UP_PERIOD_SECONDS }}
        - type: Pods
          value: {{ K8S_CMS_HPA_SCALE_UP_PODS }}
          periodSeconds: {{ K8S_CMS_HPA_SCALE_UP_PERIOD_SECONDS }}
    scaleDown:
      stabilizationWindowSeconds: {{ K8S_CMS_HPA_SCALE_DOWN_STABILIZATION_WINDOW_SECONDS }}
      selectPolicy: Min
      policies:
        - type: Percent
          value: {{ K8S_CMS_HPA_SCALE_DOWN_PERCENT }}
          periodSeconds: {{ K8S_CMS_HPA_SCALE_DOWN_PERIOD_SECONDS }}
        - type: Pods
          value: {{ K8S_CMS_HPA_SCALE_DOWN_PODS }}
          periodSeconds: {{ K8S_CMS_HPA_SCALE_DOWN_PERIOD_SECONDS }}
{% endif %}

{% if K8S_CMS_WORKER_HPA_ENABLE %}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: cms-worker-hpa
  namespace: {{ K8S_NAMESPACE }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: cms-worker
  minReplicas: {{ K8S_CMS_WORKER_REPLICAS }}
  maxReplicas: {{ K8S_CMS_WORKER_MAX_REPLICAS }}
  metrics:
    {% if K8S_CMS_WORKER_HPA_CPU_ENABLE %}
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ K8S_CMS_WORKER_HPA_CPU_AVERAGE_UTILIZATION }}
    {% endif %}
    {% if K8S_CMS_WORKER_HPA_MEMORY_ENABLE %}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ K8S_CMS_WORKER_HPA_MEMORY_AVERAGE_UTILIZATION }}
    {% endif %}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: {{ K8S_CMS_WORKER_HPA_SCALE_UP_STABILIZATION_WINDOW_SECONDS }}
      selectPolicy: Max
      policies:
        - type: Percent
          value: {{ K8S_CMS_WORKER_HPA_SCALE_UP_PERCENT }}
          periodSeconds: {{ K8S_CMS_WORKER_HPA_SCALE_UP_PERIOD_SECONDS }}
        - type: Pods
          value: {{ K8S_CMS_WORKER_HPA_SCALE_UP_PODS }}
          periodSeconds: {{ K8S_CMS_WORKER_HPA_SCALE_UP_PERIOD_SECONDS }}
    scaleDown:
      stabilizationWindowSeconds: {{ K8S_CMS_WORKER_HPA_SCALE_DOWN_STABILIZATION_WINDOW_SECONDS }}
      selectPolicy: Min
      policies:
        - type: Percent
          value: {{ K8S_CMS_WORKER_HPA_SCALE_DOWN_PERCENT }}
          periodSeconds: {{ K8S_CMS_WORKER_HPA_SCALE_DOWN_PERIOD_SECONDS }}
        - type: Pods
          value: {{ K8S_CMS_WORKER_HPA_SCALE_DOWN_PODS }}
          periodSeconds: {{ K8S_CMS_WORKER_HPA_SCALE_DOWN_PERIOD_SECONDS }}
{% endif %}

{% if K8S_MFE_HPA_ENABLE %}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: mfe-hpa
  namespace: {{ K8S_NAMESPACE }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: mfe
  minReplicas: {{ K8S_MFE_REPLICAS }}
  maxReplicas: {{ K8S_MFE_MAX_REPLICAS }}
  metrics:
    {% if K8S_MFE_HPA_CPU_ENABLE %}
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ K8S_MFE_HPA_CPU_AVERAGE_UTILIZATION }}
    {% endif %}
    {% if K8S_MFE_HPA_MEMORY_ENABLE %}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ K8S_MFE_HPA_MEMORY_AVERAGE_UTILIZATION }}
    {% endif %}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: {{ K8S_MFE_HPA_SCALE_UP_STABILIZATION_WINDOW_SECONDS }}
      selectPolicy: Max
      policies:
        - type: Percent
          value: {{ K8S_MFE_HPA_SCALE_UP_PERCENT }}
          periodSeconds: {{ K8S_MFE_HPA_SCALE_UP_PERIOD_SECONDS }}
        - type: Pods
          value: {{ K8S_MFE_HPA_SCALE_UP_PODS }}
          periodSeconds: {{ K8S_MFE_HPA_SCALE_UP_PERIOD_SECONDS }}
    scaleDown:
      stabilizationWindowSeconds: {{ K8S_MFE_HPA_SCALE_DOWN_STABILIZATION_WINDOW_SECONDS }}
      selectPolicy: Min
      policies:
        - type: Percent
          value: {{ K8S_MFE_HPA_SCALE_DOWN_PERCENT }}
          periodSeconds: {{ K8S_MFE_HPA_SCALE_DOWN_PERIOD_SECONDS }}
        - type: Pods
          value: {{ K8S_MFE_HPA_SCALE_DOWN_PODS }}
          periodSeconds: {{ K8S_MFE_HPA_SCALE_DOWN_PERIOD_SECONDS }}
{% endif %}

{% if K8S_CADDY_HPA_ENABLE %}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: caddy-hpa
  namespace: {{ K8S_NAMESPACE }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: caddy
  minReplicas: {{ K8S_CADDY_REPLICAS }}
  maxReplicas: {{ K8S_CADDY_MAX_REPLICAS }}
  metrics:
    {% if K8S_CADDY_HPA_CPU_ENABLE %}
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ K8S_CADDY_HPA_CPU_AVERAGE_UTILIZATION }}
    {% endif %}
    {% if K8S_CADDY_HPA_MEMORY_ENABLE %}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ K8S_CADDY_HPA_MEMORY_AVERAGE_UTILIZATION }}
    {% endif %}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: {{ K8S_CADDY_HPA_SCALE_UP_STABILIZATION_WINDOW_SECONDS }}
      selectPolicy: Max
      policies:
        - type: Percent
          value: {{ K8S_CADDY_HPA_SCALE_UP_PERCENT }}
          periodSeconds: {{ K8S_CADDY_HPA_SCALE_UP_PERIOD_SECONDS }}
        - type: Pods
          value: {{ K8S_CADDY_HPA_SCALE_UP_PODS }}
          periodSeconds: {{ K8S_CADDY_HPA_SCALE_UP_PERIOD_SECONDS }}
    scaleDown:
      stabilizationWindowSeconds: {{ K8S_CADDY_HPA_SCALE_DOWN_STABILIZATION_WINDOW_SECONDS }}
      selectPolicy: Min
      policies:
        - type: Percent
          value: {{ K8S_CADDY_HPA_SCALE_DOWN_PERCENT }}
          periodSeconds: {{ K8S_CADDY_HPA_SCALE_DOWN_PERIOD_SECONDS }}
        - type: Pods
          value: {{ K8S_CADDY_HPA_SCALE_DOWN_PODS }}
          periodSeconds: {{ K8S_CADDY_HPA_SCALE_DOWN_PERIOD_SECONDS }}
{% endif %}

{% if K8S_CADDY_PDB_ENABLE %}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: caddy-pdb
  namespace: {{ K8S_NAMESPACE }}
spec:
  minAvailable: {{ K8S_CADDY_MIN_AVAILABLE_REPLICAS }}
  selector:
    matchLabels:
      app.kubernetes.io/name: caddy
{% endif %}

{% if K8S_LMS_PDB_ENABLE %}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: lms-pdb
  namespace: {{ K8S_NAMESPACE }}
spec:
  minAvailable: {{ K8S_LMS_MIN_AVAILABLE_REPLICAS }}
  selector:
    matchLabels:
      app.kubernetes.io/name: lms
{% endif %}

{% if K8S_LMS_WORKER_PDB_ENABLE %}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: lms-worker-pdb
  namespace: {{ K8S_NAMESPACE }}
spec:
  minAvailable: {{ K8S_LMS_WORKER_MIN_AVAILABLE_REPLICAS }}
  selector:
    matchLabels:
      app.kubernetes.io/name: lms-worker
{% endif %}

{% if K8S_CMS_PDB_ENABLE %}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: cms-pdb
  namespace: {{ K8S_NAMESPACE }}
spec:
  minAvailable: {{ K8S_CMS_MIN_AVAILABLE_REPLICAS }}
  selector:
    matchLabels:
      app.kubernetes.io/name: cms
{% endif %}

{% if K8S_CMS_WORKER_PDB_ENABLE %}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: cms-worker-pdb
  namespace: {{ K8S_NAMESPACE }}
spec:
  minAvailable: {{ K8S_CMS_WORKER_MIN_AVAILABLE_REPLICAS }}
  selector:
    matchLabels:
      app.kubernetes.io/name: cms-worker
{% endif %}

{% if K8S_MFE_PDB_ENABLE %}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: mfe-pdb
  namespace: {{ K8S_NAMESPACE }}
spec:
  minAvailable: {{ K8S_MFE_MIN_AVAILABLE_REPLICAS }}
  selector:
    matchLabels:
      app.kubernetes.io/name: mfe
{% endif %}

{% if K8S_CADDY_VPA_ENABLE %}
---
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: caddy-vpa
  namespace: {{ K8S_NAMESPACE }}
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: caddy
  updatePolicy:
    updateMode: {{ K8S_VPA_UPDATE_MODE }}
  resourcePolicy:
    containerPolicies:
      - containerName: "*"
        controlledResources:
{% for resource in K8S_VPA_CONTROLLED_RESOURCES %}
          - {{ resource }}
{% endfor %}
        minAllowed:
          cpu: {{ K8S_CADDY_VPA_MIN_ALLOWED_CPU }}
          memory: {{ K8S_CADDY_VPA_MIN_ALLOWED_MEMORY }}
        maxAllowed:
          cpu: {{ K8S_CADDY_VPA_MAX_ALLOWED_CPU }}
          memory: {{ K8S_CADDY_VPA_MAX_ALLOWED_MEMORY }}
{% endif %}

{% if K8S_LMS_VPA_ENABLE %}
---
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: lms-vpa
  namespace: {{ K8S_NAMESPACE }}
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: lms
  updatePolicy:
    updateMode: {{ K8S_VPA_UPDATE_MODE }}
  resourcePolicy:
    containerPolicies:
      - containerName: "*"
        controlledResources:
{% for resource in K8S_VPA_CONTROLLED_RESOURCES %}
          - {{ resource }}
{% endfor %}
        minAllowed:
          cpu: {{ K8S_LMS_VPA_MIN_ALLOWED_CPU }}
          memory: {{ K8S_LMS_VPA_MIN_ALLOWED_MEMORY }}
        maxAllowed:
          cpu: {{ K8S_LMS_VPA_MAX_ALLOWED_CPU }}
          memory: {{ K8S_LMS_VPA_MAX_ALLOWED_MEMORY }}
{% endif %}

{% if K8S_LMS_WORKER_VPA_ENABLE %}
---
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: lms-worker-vpa
  namespace: {{ K8S_NAMESPACE }}
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: lms-worker
  updatePolicy:
    updateMode: {{ K8S_VPA_UPDATE_MODE }}
  resourcePolicy:
    containerPolicies:
      - containerName: "*"
        controlledResources:
{% for resource in K8S_VPA_CONTROLLED_RESOURCES %}
          - {{ resource }}
{% endfor %}
        minAllowed:
          cpu: {{ K8S_LMS_WORKER_VPA_MIN_ALLOWED_CPU }}
          memory: {{ K8S_LMS_WORKER_VPA_MIN_ALLOWED_MEMORY }}
        maxAllowed:
          cpu: {{ K8S_LMS_WORKER_VPA_MAX_ALLOWED_CPU }}
          memory: {{ K8S_LMS_WORKER_VPA_MAX_ALLOWED_MEMORY }}
{% endif %}

{% if K8S_CMS_VPA_ENABLE %}
---
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: cms-vpa
  namespace: {{ K8S_NAMESPACE }}
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: cms
  updatePolicy:
    updateMode: {{ K8S_VPA_UPDATE_MODE }}
  resourcePolicy:
    containerPolicies:
      - containerName: "*"
        controlledResources:
{% for resource in K8S_VPA_CONTROLLED_RESOURCES %}
          - {{ resource }}
{% endfor %}
        minAllowed:
          cpu: {{ K8S_CMS_VPA_MIN_ALLOWED_CPU }}
          memory: {{ K8S_CMS_VPA_MIN_ALLOWED_MEMORY }}
        maxAllowed:
          cpu: {{ K8S_CMS_VPA_MAX_ALLOWED_CPU }}
          memory: {{ K8S_CMS_VPA_MAX_ALLOWED_MEMORY }}
{% endif %}

{% if K8S_CMS_WORKER_VPA_ENABLE %}
---
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: cms-worker-vpa
  namespace: {{ K8S_NAMESPACE }}
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: cms-worker
  updatePolicy:
    updateMode: {{ K8S_VPA_UPDATE_MODE }}
  resourcePolicy:
    containerPolicies:
      - containerName: "*"
        controlledResources:
{% for resource in K8S_VPA_CONTROLLED_RESOURCES %}
          - {{ resource }}
{% endfor %}
        minAllowed:
          cpu: {{ K8S_CMS_WORKER_VPA_MIN_ALLOWED_CPU }}
          memory: {{ K8S_CMS_WORKER_VPA_MIN_ALLOWED_MEMORY }}
        maxAllowed:
          cpu: {{ K8S_CMS_WORKER_VPA_MAX_ALLOWED_CPU }}
          memory: {{ K8S_CMS_WORKER_VPA_MAX_ALLOWED_MEMORY }}
{% endif %}

{% if K8S_MFE_VPA_ENABLE %}
---
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: mfe-vpa
  namespace: {{ K8S_NAMESPACE }}
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: mfe
  updatePolicy:
    updateMode: {{ K8S_VPA_UPDATE_MODE }}
  resourcePolicy:
    containerPolicies:
      - containerName: "*"
        controlledResources:
{% for resource in K8S_VPA_CONTROLLED_RESOURCES %}
          - {{ resource }}
{% endfor %}
        minAllowed:
          cpu: {{ K8S_MFE_VPA_MIN_ALLOWED_CPU }}
          memory: {{ K8S_MFE_VPA_MIN_ALLOWED_MEMORY }}
        maxAllowed:
          cpu: {{ K8S_MFE_VPA_MAX_ALLOWED_CPU }}
          memory: {{ K8S_MFE_VPA_MAX_ALLOWED_MEMORY }}
{% endif %}

# End of tutor-contrib-k8s patches
