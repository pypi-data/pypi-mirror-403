name: Publish

on:
  release:
    types: [published]

jobs:
  pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for trusted publishing
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Build package
        run: uv build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  mcp-registry:
    name: Publish to MCP Registry
    needs: pypi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build mcp-publisher
        run: |
          git clone --depth 1 https://github.com/modelcontextprotocol/registry.git /tmp/mcp-registry
          cd /tmp/mcp-registry && make publisher

      - name: Publish to MCP Registry
        env:
          MCP_REGISTRY_TOKEN: ${{ secrets.MCP_REGISTRY_TOKEN }}
        run: |
          /tmp/mcp-registry/bin/mcp-publisher publish --token "$MCP_REGISTRY_TOKEN"

  homebrew:
    name: Update Homebrew Tap
    needs: pypi
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.ref_name }}
    steps:
      - name: Strip v prefix from version
        id: version
        run: echo "version=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Wait for PyPI to be available
        run: |
          for i in {1..30}; do
            if curl -sI "https://pypi.org/pypi/hot-memory-mcp/${{ steps.version.outputs.version }}/json" | grep -q "200 OK"; then
              echo "Package available on PyPI"
              break
            fi
            echo "Waiting for PyPI... ($i/30)"
            sleep 10
          done

      - name: Get SHA256 from PyPI
        id: sha
        run: |
          SHA=$(curl -sL "https://pypi.org/pypi/hot-memory-mcp/${{ steps.version.outputs.version }}/json" | jq -r '.urls[] | select(.packagetype=="sdist") | .digests.sha256')
          echo "sha256=$SHA" >> $GITHUB_OUTPUT

      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: michael-denyer/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        env:
          PKG_VERSION: ${{ steps.version.outputs.version }}
          PKG_SHA256: ${{ steps.sha.outputs.sha256 }}
        run: |
          cd homebrew-tap
          sed -i "s|url \"https://files.pythonhosted.org/packages/source/h/hot-memory-mcp/hot_memory_mcp-.*\.tar\.gz\"|url \"https://files.pythonhosted.org/packages/source/h/hot-memory-mcp/hot_memory_mcp-${PKG_VERSION}.tar.gz\"|" Formula/hot-memory-mcp.rb
          sed -i "s|sha256 \".*\"|sha256 \"${PKG_SHA256}\"|" Formula/hot-memory-mcp.rb

      - name: Commit and push
        env:
          PKG_VERSION: ${{ steps.version.outputs.version }}
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/hot-memory-mcp.rb
          git commit -m "chore: bump hot-memory-mcp to v${PKG_VERSION}"
          git push
