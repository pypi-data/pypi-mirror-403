name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual triggering for testing

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    # Run full test suite before publishing
    - name: Install dev dependencies and run tests
      run: |
        pip install -e ".[dev]"
        pytest tests/ -v --cov=genai_otel --cov-report=term
        echo "âœ“ All tests passed"

    # Code quality checks
    - name: Format and lint checks
      run: |
        black --check genai_otel tests --exclude='__version__\.py'
        isort --check-only --skip-glob='*/__version__.py' genai_otel tests
        echo "âœ“ Code quality checks passed"

    - name: Build package
      run: python -m build

    - name: Check package with twine
      run: twine check dist/*

    # Test installation before publishing
    - name: Test package installation
      run: |
        python -m venv test_env
        source test_env/bin/activate
        pip install dist/*.whl

        # Test imports
        python -c 'import genai_otel; print(f"Successfully imported genai_otel version: {genai_otel.__version__}")'
        python -c 'from genai_otel.config import OTelConfig; from genai_otel.cost_calculator import CostCalculator; print("All core components imported successfully")'

        # Test CLI
        genai-instrument --help
        echo "âœ“ CLI tool works"

        deactivate
        rm -rf test_env

    - name: Publish to Test PyPI
      if: github.event_name == 'release'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        echo "Publishing to Test PyPI..."
        python -m twine upload --verbose --repository testpypi dist/* --skip-existing || echo "Package may already exist on Test PyPI"
        echo "âœ“ Published to Test PyPI"

    - name: Wait and verify Test PyPI upload
      if: github.event_name == 'release'
      run: |
        echo "Waiting 30 seconds for Test PyPI to process..."
        sleep 30

        # Extract version from dist filename
        VERSION=$(ls dist/*.whl | head -1 | grep -oP '\d+\.\d+\.\d+[^\-]*' | head -1)
        echo "Package version: $VERSION"

        # Try to install from Test PyPI to verify upload
        python -m pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ genai-otel-instrument==$VERSION --no-cache-dir || echo "Could not verify Test PyPI installation (may need more time to propagate)"

    - name: Publish to PyPI
      if: github.event_name == 'release'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "Publishing to PyPI..."
        python -m twine upload --verbose dist/*
        echo "âœ“ Published to PyPI"

    - name: Create release summary
      if: github.event_name == 'release'
      run: |
        echo "## ðŸŽ‰ Release Published Successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Package Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: $(ls dist/*.whl | head -1 | grep -oP '\d+\.\d+\.\d+[^\-]*' | head -1)" >> $GITHUB_STEP_SUMMARY
        echo "- **TestPyPI**: https://test.pypi.org/project/genai-otel-instrument/" >> $GITHUB_STEP_SUMMARY
        echo "- **PyPI**: https://pypi.org/project/genai-otel-instrument/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Installation" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo 'pip install genai-otel-instrument' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
