import{m as R,C as j,x as V}from"./assets/deep-equal-BTW2ZN6S.js";import{G as A,M as Z,D as x}from"./assets/globe-view-Day_n1iB.js";import{f as p}from"./assets/webgl-developer-tools-utTNOsNf.js";import{a as b}from"./assets/assert-cyW4mg7q.js";import"./assets/project-BTjD2Imj.js";import"./assets/pick-layers-pass-C-3k0wbN.js";import"./assets/widget-BjgEeHAL.js";import"./assets/globe-viewport-tqhQW7C4.js";import"./assets/image-loader-hHJsndO6.js";const _="mapbox",m=512,N=Math.PI/180;function k({map:t,gl:e,deck:r}){if(t.__deck)return t.__deck;const n=r?.props._customRender,o=r?.props.onLoad,s={...r?.props,_customRender:()=>{t.triggerRepaint(),n?.("")}};s.parameters={...w(t,!0),...s.parameters},s.views||(s.views=f(t));let i;return(!r||r.props.gl===e)&&(Object.assign(s,{gl:e,width:null,height:null,touchAction:"unset",viewState:y(t)}),r?.isInitialized?S(r,t):s.onLoad=()=>{o?.(),S(i,t)}),r?(i=r,r.setProps(s),r.userData.isExternal=!0):(i=new x(s),t.on("remove",()=>{F(t)})),i.userData.mapboxLayers=new Set,t.__deck=i,t.on("render",()=>{i.isInitialized&&$(i,t)}),i}function S(t,e){const r=()=>{t.isInitialized?q(t,e):e.off("move",r)};e.on("move",r)}function F(t){t.__deck?.finalize(),t.__deck=null}function w(t,e){const r=e?{depthWriteEnabled:!0,depthCompare:"less-equal",depthBias:0,blend:!0,blendColorSrcFactor:"src-alpha",blendColorDstFactor:"one-minus-src-alpha",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one-minus-src-alpha",blendColorOperation:"add",blendAlphaOperation:"add"}:{};return D(t)==="globe"&&(r.cullMode="back"),r}function B(t,e){t.userData.mapboxLayers.add(e),O(t)}function X(t,e){t.userData.mapboxLayers.delete(e),O(t)}function T(t,e){O(t)}function Y(t,e,r,n){let{currentViewport:o}=t.userData,s=!1;o||(o=C(t,e,n),t.userData.currentViewport=o,s=!0),t.isInitialized&&t._drawLayers("mapbox-repaint",{viewports:[o],layerFilter:i=>(!t.props.layerFilter||t.props.layerFilter(i))&&(r.id===i.layer.id||i.layer.props.operation.includes("terrain")),clearStack:s,clearCanvas:!1})}function W(t,e,r,n){let{currentViewport:o}=t.userData,s=!1;o||(o=C(t,e,n),t.userData.currentViewport=o,s=!0),t.isInitialized&&t._drawLayers("mapbox-repaint",{viewports:[o],layerFilter:i=>{if(t.props.layerFilter&&!t.props.layerFilter(i))return!1;const a=i.layer;return a.props.beforeId===r.beforeId&&a.props.slot===r.slot},clearStack:s,clearCanvas:!1})}function D(t){const e=t.getProjection?.(),r=e?.type||e?.name;if(r==="globe")return"globe";if(r&&r!=="mercator")throw new Error("Unsupported projection");return"mercator"}function f(t){return D(t)==="globe"?new A({id:_}):new Z({id:_})}function y(t){const{lng:e,lat:r}=t.getCenter(),n={longitude:(e+540)%360-180,latitude:r,zoom:t.getZoom(),bearing:t.getBearing(),pitch:t.getPitch(),padding:t.getPadding(),repeat:t.getRenderWorldCopies()};return t.getTerrain?.()&&U(t,n),n}function U(t,e){if(t.getFreeCameraOptions){const{position:r}=t.getFreeCameraOptions();if(!r||r.z===void 0)return;const n=t.transform.height,{longitude:o,latitude:s,pitch:i}=e,a=r.x*m,l=(1-r.y)*m,d=r.z*m,c=R([o,s]),h=a-c[0],u=l-c[1],v=Math.sqrt(h*h+u*u),g=i*N,I=1.5*n,P=g<.001?I*Math.cos(g)/d:I*Math.sin(g)/v;e.zoom=Math.log2(P);const G=I*Math.cos(g)/P,z=d-G;e.position=[0,0,z/j(s)]}else typeof t.transform.elevation=="number"&&(e.position=[0,0,t.transform.elevation])}function C(t,e,r){const n=y(e),{views:o}=t.props,s=o&&p(o).find(l=>l.id===_)||f(e);r&&(s.props.nearZMultiplier=.2);const i=r?.nearZ??e.transform._nearZ,a=r?.farZ??e.transform._farZ;return Number.isFinite(i)&&(n.nearZ=i/e.transform.height,n.farZ=a/e.transform.height),s.makeViewport({width:t.width,height:t.height,viewState:n})}function $(t,e){const{mapboxLayers:r,isExternal:n}=t.userData;if(n){const o=Array.from(r,c=>c.id),i=p(t.props.layers,Boolean).some(c=>c&&!o.includes(c.id));let a=t.getViewports();const l=a.findIndex(c=>c.id===_),d=a.length>1||l<0;(i||d)&&(l>=0&&(a=a.slice(),a[l]=C(t,e)),t._drawLayers("mapbox-repaint",{viewports:a,layerFilter:c=>(!t.props.layerFilter||t.props.layerFilter(c))&&(c.viewport.id!==_||!o.includes(c.layer.id)),clearCanvas:!1}))}t.userData.currentViewport=null}function q(t,e){t.setProps({viewState:y(e)}),t.needsRedraw({clearRedrawFlags:!0})}function O(t){if(t.userData.isExternal)return;const e=[];t.userData.mapboxLayers.forEach(r=>{const n=r.props.type,o=new n(r.props);e.push(o)}),t.setProps({layers:e})}class H{constructor(e){if(!e.id)throw new Error("Layer must have an unique id");this.id=e.id,this.type="custom",this.renderingMode=e.renderingMode||"3d",this.slot=e.slot,this.map=null,this.deck=null,this.props=e}onAdd(e,r){this.map=e,this.deck=k({map:e,gl:r,deck:this.props.deck}),B(this.deck,this)}onRemove(){this.deck&&X(this.deck,this)}setProps(e){Object.assign(this.props,e,{id:this.id}),this.deck&&T(this.deck)}render(e,r){Y(this.deck,this.map,this,r)}}const E="__UNDEFINED__";function J(t,e,r,n){if(!t||!e||!t.style||!t.style._loaded)return;const o=p(n,Boolean);if(r!==n){const a=p(r,Boolean),l=new Set(a.map(d=>d.id));for(const d of o)l.delete(d.id);for(const d of l)t.getLayer(d)&&t.removeLayer(d)}for(const a of o){const l=t.getLayer(a.id);l?(l.implementation||l).setProps(a.props):t.addLayer(new H({id:a.id,deck:e,slot:a.props.slot}),a.props.beforeId)}const s=t.style._order,i={};for(const a of o){let{beforeId:l}=a.props;(!l||!s.includes(l))&&(l=E),i[l]=i[l]||[],i[l].push(a.id)}for(const a in i){const l=i[a];let d=a===E?s.length:s.indexOf(a),c=a===E?void 0:a;for(let h=l.length-1;h>=0;h--){const u=l[h],v=s.indexOf(u);v!==d-1&&(t.moveLayer(u,c),v>d&&d++),d--,c=u}}}class K{constructor(e){b(e.id,"id is required"),this.id=e.id,this.type="custom",this.renderingMode=e.renderingMode||"3d",this.slot=e.slot,this.beforeId=e.beforeId,this.map=null,this.deck=null}onAdd(e,r){this.map=e,this.deck=k({map:e,gl:r})}render(e,r){!this.deck||!this.map||W(this.deck,this.map,this,r)}}const L="__UNDEFINED__";function M(t){return t.props.beforeId?`deck-layer-group-before:${t.props.beforeId}`:t.props.slot?`deck-layer-group-slot:${t.props.slot}`:"deck-layer-group-last"}function Q(t,e,r){if(!t||!t.style||!t.style._loaded)return;const n=p(r,Boolean);if(e!==r){const i=p(e,Boolean),a=new Set(i.map(d=>M(d))),l=new Set(n.map(d=>M(d)));for(const d of a)l.has(d)||t.getLayer(d)&&t.removeLayer(d)}const o={};for(const i of n){const a=M(i),l=t.getLayer(a);if(l){const d=l.implementation||l;o[a]=d}else{const d=new K({id:a,slot:i.props.slot,beforeId:i.props.beforeId});o[a]=d,t.addLayer(d,i.props.beforeId)}}const s=t.style._order;for(const[i,a]of Object.entries(o)){const l=a.beforeId||L,d=l===L?s.length:s.indexOf(l);if(s.indexOf(i)!==d-1){const h=l===L?void 0:l;t.moveLayer(i,h)}}}class de{constructor(e){this._handleStyleChange=()=>{if(this._resolveLayers(this._map,this._deck,this._props.layers,this._props.layers),!this._map)return;D(this._map)&&!this._props.views&&this._deck?.setProps({views:f(this._map)})},this._updateContainerSize=()=>{if(this._map&&this._container){const{clientWidth:n,clientHeight:o}=this._map.getContainer();Object.assign(this._container.style,{width:`${n}px`,height:`${o}px`})}},this._updateViewState=()=>{const n=this._deck,o=this._map;n&&o&&(n.setProps({views:this._props.views||f(o),viewState:y(o)}),n.isInitialized&&n.redraw())},this._handleMouseEvent=n=>{const o=this._deck;if(!o||!o.isInitialized)return;const s={type:n.type,offsetCenter:n.point,srcEvent:n},i=this._lastMouseDownPoint;switch(!n.point&&i&&(s.deltaX=n.originalEvent.clientX-i.clientX,s.deltaY=n.originalEvent.clientY-i.clientY,s.offsetCenter={x:i.x+s.deltaX,y:i.y+s.deltaY}),s.type){case"mousedown":o._onPointerDown(s),this._lastMouseDownPoint={...n.point,clientX:n.originalEvent.clientX,clientY:n.originalEvent.clientY};break;case"dragstart":s.type="panstart",o._onEvent(s);break;case"drag":s.type="panmove",o._onEvent(s);break;case"dragend":s.type="panend",o._onEvent(s);break;case"click":s.tapCount=1,o._onEvent(s);break;case"dblclick":s.type="click",s.tapCount=2,o._onEvent(s);break;case"mousemove":s.type="pointermove",o._onPointerMove(s);break;case"mouseout":s.type="pointerleave",o._onPointerMove(s);break;default:return}};const{interleaved:r=!1}=e;this._interleaved=r,this._renderLayersInGroups=e._renderLayersInGroups||!1,this._props=this.filterProps(e)}filterProps(e){const{interleaved:r=!1,useDevicePixels:n,...o}=e;return!r&&n!==void 0&&(o.useDevicePixels=n),o}setProps(e){this._interleaved&&e.layers&&this._resolveLayers(this._map,this._deck,this._props.layers,e.layers),Object.assign(this._props,this.filterProps(e)),this._deck&&this._map&&this._deck.setProps({...this._props,parameters:{...w(this._map,this._interleaved),...this._props.parameters}})}onAdd(e){return this._map=e,this._interleaved?this._onAddInterleaved(e):this._onAddOverlaid(e)}_onAddOverlaid(e){const r=document.createElement("div");return Object.assign(r.style,{position:"absolute",left:0,top:0,textAlign:"initial",pointerEvents:"none"}),this._container=r,this._deck=new x({...this._props,parent:r,parameters:{...w(e,!1),...this._props.parameters},views:this._props.views||f(e),viewState:y(e)}),e.on("resize",this._updateContainerSize),e.on("render",this._updateViewState),e.on("mousedown",this._handleMouseEvent),e.on("dragstart",this._handleMouseEvent),e.on("drag",this._handleMouseEvent),e.on("dragend",this._handleMouseEvent),e.on("mousemove",this._handleMouseEvent),e.on("mouseout",this._handleMouseEvent),e.on("click",this._handleMouseEvent),e.on("dblclick",this._handleMouseEvent),this._updateContainerSize(),r}_onAddInterleaved(e){const r=e.painter.context.gl;return r instanceof WebGLRenderingContext&&V.warn("Incompatible basemap library. See: https://deck.gl/docs/api-reference/mapbox/overview#compatibility")(),this._deck=k({map:e,gl:r,deck:new x({...this._props,gl:r,parameters:{...w(e,!0),...this._props.parameters}})}),e.on("styledata",this._handleStyleChange),this._resolveLayers(e,this._deck,[],this._props.layers),document.createElement("div")}_resolveLayers(e,r,n,o){this._renderLayersInGroups?Q(e,n,o):J(e,r,n,o)}onRemove(){const e=this._map;e&&(this._interleaved?this._onRemoveInterleaved(e):this._onRemoveOverlaid(e)),this._deck=void 0,this._map=void 0,this._container=void 0}_onRemoveOverlaid(e){e.off("resize",this._updateContainerSize),e.off("render",this._updateViewState),e.off("mousedown",this._handleMouseEvent),e.off("dragstart",this._handleMouseEvent),e.off("drag",this._handleMouseEvent),e.off("dragend",this._handleMouseEvent),e.off("mousemove",this._handleMouseEvent),e.off("mouseout",this._handleMouseEvent),e.off("click",this._handleMouseEvent),e.off("dblclick",this._handleMouseEvent),this._deck?.finalize()}_onRemoveInterleaved(e){e.off("styledata",this._handleStyleChange),this._resolveLayers(e,this._deck,this._props.layers,[]),F(e)}getDefaultPosition(){return"top-left"}pickObject(e){return b(this._deck),this._deck.pickObject(e)}pickMultipleObjects(e){return b(this._deck),this._deck.pickMultipleObjects(e)}pickObjects(e){return b(this._deck),this._deck.pickObjects(e)}finalize(){this._map&&this._map.removeControl(this)}getCanvas(){return this._map?this._interleaved?this._map.getCanvas():this._deck.getCanvas():null}}export{de as MapboxOverlay};
//# sourceMappingURL=mapbox.js.map
