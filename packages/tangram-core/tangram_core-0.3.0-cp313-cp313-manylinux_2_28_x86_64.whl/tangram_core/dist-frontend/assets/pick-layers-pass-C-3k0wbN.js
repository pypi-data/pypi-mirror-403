import{x as k}from"./deep-equal-BTW2ZN6S.js";class x{constructor(e,r={id:"pass"}){const{id:t}=r;this.id=t,this.device=e,this.props={...r}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class S extends x{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){const[r,t]=this.device.canvasContext.getDrawingBufferSize(),o=e.clearCanvas??!0,n=e.clearColor??(o?[0,0,0,0]:!1),s=o?1:!1,a=o?0:!1,l=e.colorMask??15,i={viewport:[0,0,r,t]};e.colorMask&&(i.colorMask=l),e.scissorRect&&(i.scissorRect=e.scissorRect);const c=this.device.beginRenderPass({framebuffer:e.target,parameters:i,clearColor:n,clearDepth:s,clearStencil:a});try{return this._drawLayers(c,e)}finally{c.end(),this.device.submit()}}_drawLayers(e,r){const{target:t,shaderModuleProps:o,viewports:n,views:s,onViewportActive:a,clearStack:l=!0}=r;r.pass=r.pass||"unknown",l&&(this._lastRenderIndex=-1);const i=[];for(const c of n){const g=s&&s[c.id];a?.(c);const u=this._getDrawLayerParams(c,r),w=c.subViewports||[c];for(const f of w){const p=this._drawLayersInViewport(e,{target:t,shaderModuleProps:o,viewport:f,view:g,pass:r.pass,layers:r.layers},u);i.push(p)}}return i}_getDrawLayerParams(e,{layers:r,pass:t,isPicking:o=!1,layerFilter:n,cullRect:s,effects:a,shaderModuleProps:l},i=!1){const c=[],g=b(this._lastRenderIndex+1),u={layer:r[0],viewport:e,isPicking:o,renderPass:t,cullRect:s},w={};for(let f=0;f<r.length;f++){const p=r[f],h=this._shouldDrawLayer(p,u,n,w),y={shouldDrawLayer:h};h&&!i&&(y.shouldDrawLayer=!0,y.layerRenderIndex=g(p,h),y.shaderModuleProps=this._getShaderModuleProps(p,a,t,l),y.layerParameters={...p.context.deck?.props.parameters,...this.getLayerParameters(p,f,e)}),c[f]=y}return c}_drawLayersInViewport(e,{layers:r,shaderModuleProps:t,pass:o,target:n,viewport:s,view:a},l){const i=_(this.device,{shaderModuleProps:t,target:n,viewport:s});if(a){const{clear:g,clearColor:u,clearDepth:w,clearStencil:f}=a.props;if(g){let p=[0,0,0,0],h=1,y=0;Array.isArray(u)?p=[...u.slice(0,3),u[3]||255].map(m=>m/255):u===!1&&(p=!1),w!==void 0&&(h=w),f!==void 0&&(y=f),this.device.beginRenderPass({framebuffer:n,parameters:{viewport:i,scissorRect:i},clearColor:p,clearDepth:h,clearStencil:y}).end()}}const c={totalCount:r.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:i});for(let g=0;g<r.length;g++){const u=r[g],w=l[g],{shouldDrawLayer:f}=w;if(f&&u.props.pickable&&c.pickableCount++,u.isComposite&&c.compositeCount++,u.isDrawable&&w.shouldDrawLayer){const{layerRenderIndex:p,shaderModuleProps:h,layerParameters:y}=w;c.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,p),h.project&&(h.project.viewport=s),u.context.renderPass=e;try{u._drawLayer({renderPass:e,shaderModuleProps:h,uniforms:{layerIndex:p},parameters:y})}catch(P){u.raiseError(P,`drawing ${u} to ${o}`)}}}return c}shouldDrawLayer(e){return!0}getShaderModuleProps(e,r,t){return null}getLayerParameters(e,r,t){return e.props.parameters}_shouldDrawLayer(e,r,t,o){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;r.layer=e;let s=e.parent;for(;s;){if(!s.props.visible||!s.filterSubLayer(r))return!1;r.layer=s,s=s.parent}if(t){const a=r.layer.id;if(a in o||(o[a]=t(r)),!o[a])return!1}return e.activateViewport(r.viewport),!0}_getShaderModuleProps(e,r,t,o){const n=this.device.canvasContext.cssToDeviceRatio(),s=e.internalState?.propsInTransition||e.props,a={layer:s,picking:{isActive:!1},project:{viewport:e.context.viewport,devicePixelRatio:n,modelMatrix:s.modelMatrix,coordinateSystem:s.coordinateSystem,coordinateOrigin:s.coordinateOrigin,autoWrapLongitude:e.wrapLongitude}};if(r)for(const l of r)v(a,l.getShaderModuleProps?.(e,a));return v(a,this.getShaderModuleProps(e,r,a),o)}}function b(d=0,e={}){const r={},t=(o,n)=>{const s=o.props._offset,a=o.id,l=o.parent&&o.parent.id;let i;if(l&&!(l in e)&&t(o.parent,!1),l in r){const c=r[l]=r[l]||b(e[l],e);i=c(o,n),r[a]=c}else Number.isFinite(s)?(i=s+(e[l]||0),r[a]=null):i=d;return n&&i>=d&&(d=i+1),e[a]=i,i};return t}function _(d,{shaderModuleProps:e,target:r,viewport:t}){const o=e?.project?.devicePixelRatio??d.canvasContext.cssToDeviceRatio(),[,n]=d.canvasContext.getDrawingBufferSize(),s=r?r.height:n,a=t;return[a.x*o,s-(a.y+a.height)*o,a.width*o,a.height*o]}function v(d,...e){for(const r of e)if(r)for(const t in r)d[t]?Object.assign(d[t],r[t]):d[t]=r[t];return d}const C={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant",blendAlphaDstFactor:"zero"};class I extends S{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:r,views:t,viewports:o,onViewportActive:n,pickingFBO:s,deviceRect:{x:a,y:l,width:i,height:c},cullRect:g,effects:u,pass:w="picking",pickZ:f,shaderModuleProps:p}){this.pickZ=f;const h=this._resetColorEncoder(f),y=[a,l,i,c],P=super.render({target:s,layers:e,layerFilter:r,views:t,viewports:o,onViewportActive:n,cullRect:g,effects:u?.filter(L=>L.useInPicking),pass:w,isPicking:!0,shaderModuleProps:p,clearColor:[0,0,0,0],colorMask:15,scissorRect:y});return this._colorEncoderState=null,{decodePickingColor:h&&R.bind(null,h),stats:P}}shouldDrawLayer(e){const{pickable:r,operation:t}=e.props;return r&&t.includes("draw")||t.includes("terrain")||t.includes("mask")}getShaderModuleProps(e,r,t){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(e,r,t){const o={...e.props.parameters},{pickable:n,operation:s}=e.props;return!this._colorEncoderState||s.includes("terrain")?o.blend=!1:n&&s.includes("draw")&&(Object.assign(o,C),o.blend=!0,o.blendColor=M(this._colorEncoderState,e,t)),o}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function M(d,e,r){const{byLayer:t,byAlpha:o}=d;let n,s=t.get(e);return s?(s.viewports.push(r),n=s.a):(n=t.size+1,n<=255?(s={a:n,layer:e,viewports:[r]},t.set(e,s),o[n]=s):(k.warn("Too many pickable layers, only picking the first 255")(),n=0)),[0,0,0,n/255]}function R(d,e){const r=d.byAlpha[e[3]];return r&&{pickedLayer:r.layer,pickedViewports:r.viewports,pickedObjectIndex:r.layer.decodePickingColor(e)}}export{S as L,x as P,I as a};
//# sourceMappingURL=pick-layers-pass-C-3k0wbN.js.map
