import{j as e}from"./@radix-Da0HZyg8.js";import{G as x,J as f,aB as N,F as h,H as j,k as m,x as S,_ as D,B as P,y as _,S as C,K as k,aI as E}from"./index-5CE1yoTL.js";import{f as F}from"./@react-router-BEwS6i40.js";import{z as o,u as T,t as I,C as A}from"./@zod-yP6IINRw.js";import{b as V,c as z}from"./@tanstack-BRZ8pkCt.js";import{E as B}from"./Error-BhJ3dxQV.js";import{a as p}from"./@monaco-editor-xs6rrDBC.js";import"./@elkjs-D2DP-mPJ.js";import"./@reactflow-CEST3EX2.js";const q=o.object({device_id:o.string().optional(),user_code:o.string().optional()});function K(){const[s]=F(),{device_id:t,user_code:r}=q.parse({device_id:s.get("device_id")||void 0,user_code:s.get("user_code")||void 0});return{user_code:r,device_id:t}}const Y=o.object({trustDevice:o.boolean()});function G({deviceId:s,queryParams:t}){return["devices",s,t]}async function H({deviceId:s,queryParams:t}){const r=x(f.devices.detail(s)+"?"+N(t)),i=await h(r,{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}});if(!i.ok)throw new j({message:"Error while fetching Device details",status:i.status,statusText:i.statusText});return i.json()}function J(s,t){return V({queryKey:G(s),queryFn:async()=>H(s),...t})}function L({device:s}){return e.jsx(m,{className:"w-full p-5",children:e.jsxs("dl",{className:"flex flex-col gap-5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("dt",{children:"IP Address"}),e.jsx("dd",{children:s.body?.ip_address})]}),s.metadata?.city&&s.metadata?.country&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("dt",{children:"Location"}),e.jsxs("dd",{children:[s.metadata?.city,", ",s.metadata?.country]})]}),e.jsxs("div",{className:"flex min-w-0 items-center justify-between",children:[e.jsx("dt",{children:"Hostname"}),e.jsx("dd",{className:"truncate",children:s.body?.hostname})]})]})})}async function R({deviceId:s,payload:t}){const r=x(f.devices.verify(s)),i=await h(r,{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok){const c=await i.json().then(n=>n.detail).catch(()=>["","Failed to verify device."]);throw new j({status:i.status,statusText:i.statusText,message:c[1]||"Failed to verify device."})}return i.json()}function W(s){return z({mutationFn:async t=>R(t),...s})}function M({deviceId:s,user_code:t,setSuccess:r}){const i=p.useId(),{handleSubmit:c,formState:{isValid:n},control:d}=T({resolver:I(Y),defaultValues:{trustDevice:!1}}),{toast:l}=S(),{mutate:v,isPending:y}=W({onSuccess:()=>{r(!0)},onError:a=>{a instanceof Error&&l({status:"error",emphasis:"subtle",icon:e.jsx(_,{className:"h-5 w-5 shrink-0 fill-error-700"}),description:a.message,rounded:!0})}});function g(a){v({deviceId:s,payload:{user_code:t,trusted_device:a.trustDevice}})}return e.jsxs("form",{onSubmit:c(g),className:"flex flex-col gap-5",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(A,{control:d,name:"trustDevice",render:({field:{onChange:a,value:w}})=>e.jsx(D,{checked:w,onCheckedChange:b=>a(!!b),id:i})}),e.jsxs("label",{htmlFor:i,children:[e.jsx("p",{children:"Trust this device"}),e.jsx("p",{className:"text-theme-text-secondary",children:"We won't ask you again soon on this device."})]})]}),e.jsx(P,{disabled:y||!n,size:"md",className:"flex w-full justify-center",children:"Authorize this device"})]})}function O(){return e.jsxs(m,{className:"flex min-w-[540px] flex-col items-center justify-center space-y-7 px-7 py-9",children:[e.jsx(C,{className:"h-[120px] w-[120px] fill-theme-text-success"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-display-xs font-semibold",children:"You successfully added your device"}),e.jsx("p",{className:"text-theme-text-secondary",children:"You may close this screen and return to your CLI."})]})]})}function re(){const{device_id:s,user_code:t}=K(),[r,i]=p.useState(!1),{data:c,isPending:n,isError:d,error:l}=J({deviceId:s,queryParams:{user_code:t}},{enabled:!!s&&!!t});return!s||!t?e.jsx(k,{children:e.jsx("p",{children:"Invalid device verification link."})}):d?e.jsx(u,{children:e.jsx(B,{isAlertCircle:!0,err:l})}):n?e.jsx(u,{children:e.jsx(E,{})}):r?e.jsx(O,{}):e.jsx(u,{children:e.jsxs("div",{className:"w-full space-y-7",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"mb-0.5 text-display-xs font-semibold",children:"Authorize a new device"}),e.jsx("p",{className:"text-theme-text-secondary",children:"You are logging in from a new device."})]}),e.jsx(L,{device:c}),e.jsx(M,{setSuccess:i,deviceId:s,user_code:t})]})})}function u({children:s}){return e.jsx(m,{className:"flex w-full min-w-[540px] flex-col items-center justify-center gap-5 p-7",children:s})}export{re as default};
