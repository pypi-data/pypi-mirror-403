import{j as e}from"./@radix-Da0HZyg8.js";import{E as U}from"./Error-BhJ3dxQV.js";import{K as ce,at as F,c as ue,a6 as de,b4 as he,b7 as xe,b8 as me,b9 as ge,ba as fe,bc as pe,bb as je,bd as ye,ak as ve,y as W,B as T,ap as K,a1 as we,a9 as be,m as Ne,a2 as Se,a3 as Le,a5 as ke,aI as Ce,aJ as Te,aK as Ee,t as Ie,aL as Me,aM as Pe,aN as Re,I as Ae,aO as De,aP as $e,aQ as ze,aR as qe,aB as H,F as P,H as R,G as A,J as D,ad as J,e as C,ay as Y,aV as Fe,a4 as _e,aS as Be,be as Qe}from"./index-5CE1yoTL.js";import{j as Oe,b as $}from"./@tanstack-BRZ8pkCt.js";import{a as c,W as We}from"./@monaco-editor-xs6rrDBC.js";import{S as Ke}from"./expand-full-BzNS_BcJ.js";import{S as Ve}from"./download-01-DVCWPSnn.js";import{S as Ge}from"./SearchField-iVWx0Oy7.js";import{S as Ue}from"./alert-triangle-C7ryTF32.js";import{S as He}from"./check-DSoixTtU.js";import{a as Je}from"./@react-router-BEwS6i40.js";function z({title:t,subtitle:s}){return e.jsx(ce,{icon:e.jsx(F,{className:"h-[120px] w-[120px] fill-neutral-300"}),children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-2 text-display-xs font-semibold",children:t}),e.jsx("p",{className:"text-lg text-theme-text-secondary",children:s})]})})}const Ye=t=>c.createElement("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...t},c.createElement("path",{d:"M4 14H10M10 14V20M10 14L3 21M20 10H14M14 10V4M14 10L21 3",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}));function Xe(t){if(!Array.isArray(t)||t.length===0)return[];const s=new Map;for(let i=0;i<t.length;i++){const n=t[i],a=(n.total_chunks??1)>1||n.chunk_index!=null?n.id?`id:${n.id}`:`k:${n.timestamp??""}|${n.level??""}|${n.module??""}|${n.filename??""}|${n.lineno??""}`:`single:${i}`,h=s.get(a);h?h.push(n):s.set(a,[n])}const r=[];return s.forEach(i=>{if(i.length===1&&(i[0].total_chunks??1)<=1&&i[0].chunk_index==null){r.push(i[0]);return}const n=i.slice().sort((a,h)=>(a.chunk_index??0)-(h.chunk_index??0)),o={...n[0]};o.message=n.map(a=>a.message??"").join(""),delete o.chunk_index,delete o.total_chunks,r.push(o)}),r}function X(t){return Xe(t).map(r=>{const i=`[${Z[r.level||20]}] [${r.timestamp}] ${r.message}`;return{...r,originalEntry:i}})}const Z={0:"",10:"DEBUG",20:"INFO",30:"WARNING",40:"ERROR",50:"CRITICAL"},Ze=t=>{switch(t){case 10:return"bg-neutral-400";case 20:return"bg-blue-500";case 30:return"bg-warning-500";case 40:return"bg-error-500";case 50:return"bg-error-700";default:return"bg-neutral-400"}},et=t=>he(t).toLocaleString("sv-SE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),tt=We.memo(function({entry:s,textWrapEnabled:r,matchRanges:i,activeMatchIndex:n=-1,className:o}){const{timestamp:a,level:h,message:d,originalEntry:y}=s,p=a?et(a):"",v=Ze(h??void 0),j=()=>{if(!i||i.length===0)return d;const u=[];let f=0;return i.forEach((l,g)=>{l.start>f&&u.push(d.slice(f,l.start));const L=g===n?"bg-warning-200 text-warning-900 inline-block rounded-sm px-1":"bg-warning-100 text-warning-800 inline-block rounded-sm px-1";u.push(e.jsx("span",{className:L,children:d.slice(l.start,l.end)},g)),f=l.end}),f<d.length&&u.push(d.slice(f)),u};return e.jsxs("div",{className:ue("group/copybutton flex w-full items-start space-x-3 border-b border-theme-border-minimal bg-theme-surface-primary px-4 py-1 font-mono text-text-sm font-normal transition-colors hover:bg-theme-surface-tertiary",o),children:[" ",e.jsxs("div",{className:"flex max-h-6 w-12 flex-shrink-0 items-center",children:[e.jsx("div",{className:`h-4 w-[2px] rounded-sm ${v} mr-2`}),e.jsx("span",{className:"text-xs text-theme-text-tertiary",children:Z[h??20]})]}),e.jsx("div",{className:"w-[178px] flex-shrink-0 text-theme-text-secondary",children:p}),e.jsx("div",{className:`flex-1 text-theme-text-primary ${r?"min-w-0 whitespace-pre-wrap break-words":"whitespace-nowrap"}`,children:j()}),e.jsx("div",{className:"flex flex-shrink-0 items-center",children:e.jsx(de,{copyText:y,copyTitle:"Copy log line"})})]})}),st=[{value:10,label:"Debug",icon:e.jsx(ye,{className:"size-3 shrink-0 fill-neutral-400"})},{value:20,label:"Info",icon:e.jsx(ve,{className:"size-3 shrink-0 fill-blue-500"})},{value:30,label:"Warning",icon:e.jsx(Ue,{className:"size-3 shrink-0 fill-warning-500"})},{value:40,label:"Error",icon:e.jsx(W,{className:"size-3 shrink-0 fill-error-500"})},{value:50,label:"Critical",icon:e.jsx(W,{className:"size-3 shrink-0 fill-error-700"})}],ee=c.forwardRef(({...t},s)=>e.jsxs(xe,{...t,children:[e.jsx(me,{ref:s,className:"h-7 w-full truncate border border-[#D0D5DD] bg-theme-surface-primary p-2 text-left text-text-md",children:e.jsx(ge,{className:"data-[placeholder]:text-theme-text-secondary",placeholder:"Select a role..."})}),e.jsx(fe,{className:"",children:e.jsx(pe,{viewportClassName:"max-h-[300px]",children:st.map((r,i)=>e.jsx(je,{className:"rounded-sm p-2",value:r.value.toString(),children:e.jsxs("div",{className:"flex items-center gap-1",children:[r.icon,r.label]})},i))})})]}));ee.displayName="LogLevelSelect";function V({hasLogs:t,sourceSwitcher:s,onSearchChange:r,onReload:i,onCopyAll:n,onDownload:o,searchQuery:a="",currentMatchIndex:h=0,totalMatches:d=0,onPreviousMatch:y,onNextMatch:p,logLevel:v,setLogLevel:j}){return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-end gap-2 bg-theme-surface-secondary",children:[s&&e.jsx("div",{children:s}),t&&e.jsxs("div",{className:"flex w-full flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("form",{onSubmit:u=>{u.preventDefault(),d>0&&p?.()},children:e.jsx(Ge,{className:"border-neutral-300",searchParams:{},inMemoryHandler:r,placeholder:"Search logs..."})}),a&&e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("span",{className:"text-sm whitespace-nowrap text-theme-text-secondary",children:d>0?`${h+1} of ${d}`:"No matches"}),e.jsx(T,{className:"aspect-square items-center justify-center",size:"sm",emphasis:"minimal",onClick:y,disabled:d===0,title:"Previous match",children:e.jsx(K,{className:"h-4 w-4 shrink-0 rotate-90 fill-theme-text-tertiary"})}),e.jsx(T,{className:"flex aspect-square items-center justify-center",size:"sm",emphasis:"minimal",onClick:p,disabled:d===0,title:"Next match",children:e.jsx(K,{className:"h-4 w-4 shrink-0 -rotate-90 fill-theme-text-tertiary"})})]}),e.jsx(ee,{value:v.toString(),onValueChange:u=>j(Number(u))})]}),e.jsx(we,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{icon:e.jsx(be,{className:"h-4 w-4 fill-theme-text-primary"}),tooltip:"Reload logs",onClick:i}),e.jsx(q,{icon:e.jsx(Ne,{className:"h-4 w-4 fill-theme-text-primary"}),tooltip:"Copy all displayed logs",onClick:n}),e.jsx(q,{icon:e.jsx(Ve,{className:"h-4 w-4 fill-theme-text-primary"}),tooltip:"Download logs as file",onClick:o})]})})]})]})})}function q({icon:t,tooltip:s,onClick:r}){return e.jsxs(Se,{delayDuration:200,children:[e.jsx(Le,{children:e.jsx(T,{size:"md",emphasis:"subtle",intent:"secondary",onClick:r,className:"flex aspect-square items-center justify-center bg-theme-surface-primary p-0",children:t})}),e.jsx(ke,{children:s})]})}function nt(t){const[s,r]=c.useState(""),[i,n]=c.useState(0),o=c.useMemo(()=>{const l=s.trim().toLowerCase();if(!l)return[];const g=[];return t.forEach((w,L)=>{const I=w.message.toLowerCase();let k=0,m=0;for(;k<I.length;){const N=I.indexOf(l,k);if(N===-1)break;g.push({logIndex:L,matchIndex:m++,startIndex:N,endIndex:N+l.length}),k=N+l.length}}),g},[t,s]),a=o.length,h=a===0?0:Math.min(i,a-1),d=c.useCallback(l=>{r(l),n(0)},[]),y=c.useCallback(()=>{if(a===0)return-1;const l=(h+1)%a;return n(l),l},[a,h]),p=c.useCallback(()=>{if(a===0)return-1;const l=(h-1+a)%a;return n(l),l},[a,h]),v=c.useMemo(()=>{const l=new Map;return o.forEach(g=>{const w=l.get(g.logIndex)||[];w.push({start:g.startIndex,end:g.endIndex}),l.set(g.logIndex,w)}),l},[o]),j=o[h],u=j?.logIndex??-1,f=j?.matchIndex??-1;return{searchQuery:s,setSearchQuery:d,matches:o,currentMatchIndex:h,totalMatches:a,goToNextMatch:y,goToPreviousMatch:p,matchesByLogIndex:v,activeMatchLogIndex:u,activeMatchWithinLog:f}}function rt(t){const[s,r]=c.useState(20),i=c.useMemo(()=>t.filter(n=>n.level&&n.level>=s),[t,s]);return{selectedLogLevel:s,filteredLogs:i,setSelectedLogLevel:r}}function te({logs:t,reloadLogs:s,fallbackMessage:r,sourceSwitcher:i}){const[n,o]=c.useState(!0),a=c.useRef(null),h=c.useRef(!1),{filteredLogs:d,setSelectedLogLevel:y,selectedLogLevel:p}=rt(t),{searchQuery:v,setSearchQuery:j,matches:u,currentMatchIndex:f,totalMatches:l,goToNextMatch:g,goToPreviousMatch:w,matchesByLogIndex:L,activeMatchLogIndex:I,activeMatchWithinLog:k}=nt(d),m=Oe({overscan:20,count:d.length,getScrollElement:()=>a.current,estimateSize:()=>32}),N=m.getVirtualItems(),ie=t.length>0;c.useEffect(()=>{m.measure()},[n,m]),c.useEffect(()=>{h.current||d.length===0||(h.current=!0,requestAnimationFrame(()=>{m.scrollToIndex(d.length-1,{align:"end"})}))},[d.length,m]),c.useEffect(()=>{u.length>0&&u[0]&&requestAnimationFrame(()=>{m.scrollToIndex(u[0].logIndex,{align:"center"})})},[u,m]);const _=c.useCallback(()=>{const x=g();x>=0&&u[x]&&requestAnimationFrame(()=>{m.scrollToIndex(u[x].logIndex,{align:"center"})})},[g,u,m]),B=c.useCallback(()=>{const x=w();x>=0&&u[x]&&requestAnimationFrame(()=>{m.scrollToIndex(u[x].logIndex,{align:"center"})})},[w,u,m]),Q=()=>{const x=G(t);navigator.clipboard.writeText(x).catch(b=>{console.error("Failed to copy logs:",b)})},O=()=>{const x=G(t),b=new Blob([x],{type:"text/plain"}),M=URL.createObjectURL(b),S=document.createElement("a");S.href=M,S.download=`logs-${new Date().toISOString().split("T")[0]}.txt`,document.body.appendChild(S),S.click(),document.body.removeChild(S),URL.revokeObjectURL(M)},oe=()=>{o(x=>!x)};return ie?e.jsxs("div",{className:"flex flex-1 flex-col space-y-5",children:[e.jsx(V,{hasLogs:!0,sourceSwitcher:i,logLevel:p,setLogLevel:y,onSearchChange:j,onReload:s,onCopyAll:Q,onDownload:O,searchQuery:v,currentMatchIndex:f,totalMatches:l,onPreviousMatch:B,onNextMatch:_}),e.jsxs("div",{className:"flex flex-1 flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex w-full min-w-[600px] space-x-3 bg-theme-surface-tertiary px-4 py-1 font-medium text-theme-text-secondary",children:[e.jsx("div",{className:"flex w-12 flex-shrink-0 items-center",children:e.jsx("span",{className:"text-text-sm font-semibold",children:"Type"})}),e.jsx("div",{className:"w-[178px] flex-shrink-0",children:e.jsx("span",{className:"text-text-sm font-semibold",children:"Time"})}),e.jsx("div",{className:"flex min-w-0 flex-1 items-center justify-between",children:e.jsx("span",{className:"text-text-sm font-semibold",children:"Event"})}),e.jsx("div",{className:"flex flex-shrink-0 items-center",children:e.jsx(T,{onClick:oe,size:"sm",emphasis:"subtle",intent:"secondary",className:"ml-2 h-5 w-5 rounded-sm bg-theme-surface-primary p-0.25",title:n?"Collapse text":"Expand text",children:n?e.jsx(Ye,{className:"h-4 w-4 shrink-0 text-theme-text-tertiary hover:text-theme-text-secondary"}):e.jsx(Ke,{className:"h-4 w-4 shrink-0 fill-theme-text-tertiary hover:fill-theme-text-secondary"})})})]}),e.jsx("div",{ref:a,className:"flex-1 overflow-auto contain-strict",children:e.jsx("div",{style:{height:m.getTotalSize(),width:"100%",position:"relative"},children:e.jsx("div",{style:{position:"absolute",top:0,left:0,width:"fit-content",minWidth:"100%",transform:`translateY(${N[0]?.start??0}px)`},children:N.map(x=>{const b=x.index,M=d[b],S=L.get(b),le=b===I?k:-1;return e.jsx("div",{"data-index":b,ref:m.measureElement,children:e.jsx(tt,{entry:M,textWrapEnabled:n,matchRanges:S,activeMatchIndex:le})},x.key)})})})})]})]}):e.jsxs("div",{className:"flex flex-1 flex-col space-y-5",children:[e.jsx(V,{hasLogs:!1,sourceSwitcher:i,logLevel:p,setLogLevel:y,onSearchChange:j,onReload:s,onCopyAll:Q,onDownload:O,searchQuery:v,currentMatchIndex:f,totalMatches:l,onPreviousMatch:B,onNextMatch:_}),e.jsx("div",{className:"flex-1",children:r})]})}function G(t){return t.map(s=>s.originalEntry).join(`
`)}function se(){return e.jsx("section",{className:"flex h-[calc(100vh_-_270px)] items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsxs("div",{className:"relative mb-2 flex items-center justify-center",children:[e.jsx(Ce,{className:"h-[120px] w-[120px]"}),e.jsx(at,{})]}),e.jsx("h2",{className:"my-3 text-center text-display-xs font-semibold",children:"Loading the Logs"}),e.jsxs("p",{className:"text-center text-text-lg text-theme-text-secondary",children:["It can take up to a few minutes. ",e.jsx("br",{})," Please wait while we fetch logs from the artifact store."]})]})})}function at(){return e.jsx("div",{className:"absolute rounded-rounded bg-primary-25 p-3",children:e.jsx(F,{className:"h-7 w-7 fill-primary-400"})})}function ne({sources:t,selectedSource:s,setSelectedSource:r}){const[i,n]=c.useState(!1);return e.jsxs(Te,{modal:!0,open:i,onOpenChange:n,children:[e.jsx(Ee,{asChild:!0,children:e.jsxs(T,{intent:"secondary",emphasis:"subtle",className:"flex items-center gap-0.5 bg-theme-surface-primary capitalize",size:"md",children:[s,e.jsx(Ie,{width:24,height:24,className:"fill-text-primary shrink-0"})]})}),e.jsx(Me,{className:"px-0",align:"start",children:e.jsxs(Pe,{defaultValue:s,className:"rounded-sharp",children:[e.jsx(Re,{className:"m-0",placeholder:"Search sources...",children:e.jsx(Ae,{className:"w-full",inputSize:"sm"})}),e.jsxs(De,{children:[e.jsx($e,{children:"No source found."}),e.jsx(ze,{className:"max-h-[300px] overflow-y-auto",children:t.map(o=>{const a=o.split("/").pop();return e.jsxs(qe,{keywords:[a??""],className:"group capitalize data-[selected=true]:rounded-sharp",value:o,onSelect:()=>{r(o),n(!1)},children:[o===s?e.jsx(He,{width:16,height:16,className:"shrink-0 fill-theme-text-tertiary group-data-[selected=true]:fill-theme-text-brand"}):e.jsx(F,{width:16,height:16,className:"shrink-0 fill-theme-text-tertiary group-data-[selected=true]:fill-theme-text-brand"}),a]},o)})})]})]})})]})}function it({runId:t,queries:s}){return["runs",t,"logs",s]}async function ot({runId:t,queries:s}){const r=H(s).toString(),i=A(D.runs.logs(t))+(r?`?${r}`:""),n=await P(i,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok){const o=await n.json().then(a=>Array.isArray(a.detail)?a.detail[1]:a.detail).catch(()=>`Error while fetching logs for run ${t}`);throw new R({status:n.status,statusText:n.statusText,message:o})}return n.json()}function lt(t,s){return $({queryKey:it(t),queryFn:()=>ot(t),...s})}function Pt({runId:t}){const{data:s,isError:r,isPending:i}=J({runId:t});if(i)return e.jsx(C,{className:"h-[200px] w-full"});if(r)return e.jsx("p",{children:"Error loading logs"});const o=s.resources?.log_collection?.map(a=>a.body?.source).filter(a=>a!=null&&a!=null)??[];return o.length<1?e.jsx(z,{title:"This pipeline run has no logs",subtitle:"It looks like there are no logs associated with this pipeline run"}):e.jsx(ct,{sources:o,runId:t})}function ct({sources:t,runId:s}){const[r,i]=c.useState(t[0]),n=lt({runId:s,queries:{source:r}}),o=c.useMemo(()=>n.data?X(n.data):[],[n.data]);return n.isPending?e.jsx(se,{}):n.isError?e.jsx(U,{err:n.error}):e.jsx(te,{fallbackMessage:e.jsx(z,{title:"This pipeline run has no logs",subtitle:"It looks like there are no logs associated with this pipeline run"}),sourceSwitcher:t.length>1?e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-text-sm text-theme-text-secondary",children:"Source"}),e.jsx(ne,{sources:t,selectedSource:r,setSelectedSource:i})]}):void 0,logs:o,reloadLogs:()=>n.refetch()})}function ut({stepId:t}){return["steps",t]}async function dt({stepId:t}){const s=A(D.steps.detail(t)),r=await P(s,{method:"GET",headers:{"Content-Type":"application/json"}});if(r.status===404&&Y(),!r.ok)throw new R({message:`Error while fetching step ${t}`,status:r.status,statusText:r.statusText});return r.json()}function re(t,s){return $({queryKey:ut(t),queryFn:()=>dt(t),...s})}function ht(t,s){return["initializing","running"].includes(t)&&s==="failed"}function xt({stepId:t,queries:s}){return["logs",t,s]}async function mt({stepId:t,queries:s}){const r=H(s).toString(),i=A(D.steps.logs(t)+(r?`?${r}`:"")),n=await P(i,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok){const o=await n.json().then(a=>Array.isArray(a.detail)?a.detail[1]:a.detail).catch(()=>`Error while fetching logs for step ${t}`);throw new R({status:n.status,statusText:n.statusText,message:o})}return n.json()}function gt(t,s){return $({queryKey:xt(t),queryFn:()=>mt(t),...s})}function Rt({stepId:t}){const{data:s,isError:r,isPending:i}=re({stepId:t});if(i)return e.jsx(C,{className:"h-[200px] w-full"});if(r)return e.jsx("p",{children:"Error loading logs"});const o=s.resources?.log_collection?.map(a=>a.body?.source).filter(a=>a!=null&&a!==void 0)??[];return o.length<1?e.jsx(z,{title:"This step has no logs",subtitle:"It looks like there are no logs associated with this step"}):e.jsx(ft,{sources:o,stepId:t})}function ft({sources:t,stepId:s}){const r=t.includes("step")?"step":t[0],[i,n]=c.useState(r),o=gt({stepId:s,queries:{source:i}}),a=c.useMemo(()=>o.data?X(o.data):[],[o.data]);return o.isPending?e.jsx(se,{}):o.isError?e.jsx(U,{err:o.error}):e.jsx(te,{fallbackMessage:e.jsx(z,{title:"This step has no logs",subtitle:"It looks like there are no logs associated with this step"}),sourceSwitcher:t.length>1?e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-text-sm text-theme-text-secondary",children:"Source"}),e.jsx(ne,{sources:t,selectedSource:i,setSelectedSource:n})]}):void 0,logs:a,reloadLogs:()=>o.refetch()})}function At({stepId:t}){const{runId:s}=Je(),r=re({stepId:t}),i=J({runId:s});if(r.isPending||i.isPending)return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(C,{className:"size-5 shrink-0 rounded-sm"}),e.jsx(C,{className:"h-5 w-[150px]"}),e.jsx(C,{className:"h-4 w-[80px] rounded-rounded"})]});if(r.error||i.error)return null;const n=r.data.body?.status,o=i.data.body?.status,a=ht(n??"running",o??"running");return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:`rounded-sm p-0.5 ${a?"bg-blue-50":Fe(n)}`,children:e.jsx(_e,{status:a?"unknown":n,className:"h-4 w-4 shrink-0"})}),e.jsx("h2",{className:"text-display-xs font-semibold",children:r.data.name}),e.jsx(Be,{size:"sm",className:"capitalize",color:Qe(a?"unknown":n),children:a?`Unknown - Last reported: ${n}`:n||"None"})]})}function ae(t){return t.type==="step"}function pt(t){return t.type==="triggered_run"}function jt(t){return t.type==="artifact"}function E(t){return!t.id}function Dt(t){return t.filter(ae).filter(s=>!E(s))}function $t(t){return t.filter(jt).filter(s=>!E(s))}function zt(t){return t.filter(pt).filter(s=>!E(s))}function qt(t){return t.filter(E)}function Ft(t){return t.filter(E).filter(ae)}function yt({runId:t}){return["runs",t,"dag"]}async function vt({runId:t}){const s=A(D.runs.dag(t)),r=await P(s,{method:"GET",headers:{"Content-Type":"application/json"}});if(r.status===404&&Y(),!r.ok)throw new R({message:`Error while fetching pipeline run ${t}`,status:r.status,statusText:r.statusText});return r.json()}function _t(t,s){return $({queryKey:yt(t),queryFn:()=>vt(t),...s})}export{z as E,Pt as L,At as S,Rt as a,Dt as b,zt as c,$t as d,qt as e,Ft as f,ht as g,_t as h,ae as i,re as u};
