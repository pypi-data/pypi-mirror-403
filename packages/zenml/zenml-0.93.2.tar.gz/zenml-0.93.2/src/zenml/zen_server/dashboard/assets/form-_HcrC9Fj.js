import{j as e}from"./@radix-Da0HZyg8.js";import{z as u,a as f,C as g,u as R,t as k,F as E}from"./@zod-yP6IINRw.js";import{B as h,p as Q,e as N,b7 as v,b8 as y,b9 as S,ba as C,bc as P,bb as x,$ as V,a8 as q,a0 as z,aT as T,x as _,ac as B,r as L,bm as H,k as M,I as U}from"./index-5CE1yoTL.js";import{c as w}from"./@react-router-BEwS6i40.js";import{g as F}from"./name-Bg7MBXU_.js";import{k as I,e as $}from"./@tanstack-BRZ8pkCt.js";import{a as A}from"./all-pipeline-runs-query-DNuzZZgC.js";import{u as D}from"./update-snapshot-CrGUCICc.js";function K({isPending:s}){const r=w();return e.jsxs("div",{className:"flex items-center justify-end gap-2 p-5",children:[e.jsx(h,{type:"button",onClick:()=>r(-1),intent:"secondary",size:"md",children:"Cancel"}),e.jsxs(h,{type:"submit",size:"md",disabled:s,children:[s&&e.jsx("div",{className:"h-4 w-4 animate-spin rounded-rounded border-2 border-theme-text-negative border-b-theme-text-brand"}),"Create Snapshot"]})]})}function O(){return e.jsx("div",{className:"px-5 py-3",children:e.jsx("h1",{className:"text-display-xs font-semibold",children:"Create Snapshot"})})}const Y=u.object({name:u.string().min(1,"Name is required"),pipeline:u.string().uuid("Invalid pipeline ID"),run:u.string().min(1,"Run is required")});function G({pipeline:s}){const{control:r,resetField:l}=f(),t=I({...Q.pipelineListInfinite({sort_by:"desc:latest_run"}),throwOnError:!0});if(t.isPending)return e.jsx(N,{className:"h-7 w-[300px]"});if(t.isError)return e.jsx("p",{children:"Error fetching pipelines"});const d=t.data?.pages.flatMap(o=>o.items);return e.jsx(g,{control:r,name:"pipeline",render:({field:{onChange:o,ref:i,...a}})=>e.jsxs(v,{disabled:!!s,...a,onValueChange:n=>{l("run"),o(n)},children:[e.jsx(y,{ref:i,className:"border border-theme-border-moderate text-text-md disabled:bg-neutral-100 data-[error=true]:border-error-500",children:e.jsx("div",{className:"truncate",children:e.jsx(S,{placeholder:"Select a pipeline"})})}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs(P,{viewportClassName:"max-h-[300px]",children:[s&&e.jsx(x,{className:"flex items-center gap-1",value:s.id,children:e.jsx(j,{name:s.name})},s.id),!s&&d.map(n=>e.jsx(x,{value:n.id,children:e.jsx(j,{name:n.name})},n.id))]}),t.hasNextPage&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-[1px] fill-theme-border-moderate"}),e.jsx("button",{type:"button",onClick:()=>t.fetchNextPage(),className:"flex w-full rounded-sm bg-theme-surface-primary px-2 py-1 hover:bg-theme-surface-tertiary",children:e.jsxs("div",{className:"flex items-center gap-1",children:[t.isFetchingNextPage&&e.jsx("div",{role:"alert","aria-busy":"true",className:"full h-[20px] w-[20px] animate-spin rounded-rounded border-2 border-theme-text-negative border-b-theme-text-brand"}),"Load more"]})})]})]})})]})})}function j({name:s}){return e.jsxs("div",{className:"flex items-center gap-1 text-text-md",children:[e.jsx(V,{className:"size-4 shrink-0 fill-primary-400"}),e.jsx("div",{className:"truncate",children:s})]})}function J({run:s}){const{watch:r,control:l,setValue:t,getValues:d}=f(),o=r("pipeline"),i=I({...A({params:{pipeline_id:o,sort_by:"desc:created"}})});if(i.isPending)return e.jsx(N,{className:"h-7 w-[300px]"});if(i.isError)return e.jsx("p",{children:"Error fetching runs"});const a=i.data?.pages.flatMap(n=>n.items);return e.jsx(g,{control:l,name:"run",render:({field:{onChange:n,ref:m,...p}})=>e.jsxs(v,{disabled:!!s||!o,...p,onValueChange:c=>{d("name")||t("name",F()),n(c)},children:[e.jsx(y,{ref:m,className:"border border-theme-border-moderate text-text-md disabled:bg-neutral-100 data-[error=true]:border-error-500",children:e.jsx("div",{className:"truncate",children:e.jsx(S,{placeholder:"Select a run"})})}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs(P,{viewportClassName:"max-h-[300px]",children:[s&&e.jsx(x,{value:s.id,children:e.jsx(b,{name:s.name,status:s.body?.status??null,index:s.body?.index})}),!s&&a.map(c=>e.jsx(x,{value:c.id,children:e.jsx(b,{name:c.name,status:c.body?.status??null,index:c.body?.index})},c.id))]}),i.hasNextPage&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-[1px] fill-theme-border-moderate"}),e.jsx("button",{type:"button",onClick:()=>i.fetchNextPage(),className:"flex w-full rounded-sm bg-theme-surface-primary px-2 py-1 hover:bg-theme-surface-tertiary",children:e.jsxs("div",{className:"flex items-center gap-1",children:[i.isFetchingNextPage&&e.jsx("div",{role:"alert","aria-busy":"true",className:"full h-[20px] w-[20px] animate-spin rounded-rounded border-2 border-theme-text-negative border-b-theme-text-brand"}),"Load more"]})})]})]})})]})})}function b({name:s,status:r,index:l}){return e.jsxs("div",{className:"flex items-center gap-1 text-text-md",children:[e.jsx(q,{className:`h-4 w-4 shrink-0 ${z(r)}`}),e.jsx("div",{className:"truncate",children:e.jsx(T,{name:s,index:l})})]})}function W(s){const r=w(),l=$(),{toast:t}=_(),{mutate:d,isPending:o}=D({onSuccess(a){l.invalidateQueries({queryKey:[...B.all,a.id]}),r(L.projects.snapshots.detail.overview(a.id))},onError(a){t({status:"error",description:a instanceof Error?a.message:"Failed to create snapshot",rounded:!0})}});async function i({name:a,run:n}){if(s!==null){d({snapshotId:s,payload:{name:a}});return}let m;try{m=(await H({runId:n})).resources?.snapshot?.id}catch{t({status:"error",emphasis:"subtle",description:"Failed to fetch run",rounded:!0});return}if(!m)return t({status:"error",emphasis:"subtle",description:"Snapshot not found",rounded:!0});d({snapshotId:m,payload:{name:a}})}return{handleCreateSnapshot:i,isPending:o}}function ie({run:s}){const r=R({resolver:k(Y),defaultValues:{name:s?.name?F():"",pipeline:s?.resources?.pipeline?.id||"",run:s?.id||""}}),{handleCreateSnapshot:l,isPending:t}=W(s?.resources?.snapshot?.id||null),d=s?.resources?.pipeline;return e.jsx(M,{children:e.jsx(E,{...r,children:e.jsxs("form",{className:"divide-y divide-theme-border-moderate",onSubmit:r.handleSubmit(l),children:[e.jsx(O,{}),e.jsxs("div",{className:"space-y-5 p-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Select a name for your Snapshot"}),e.jsx("p",{className:"text-text-sm text-theme-text-secondary",children:"You can keep the suggested name or create your own."})]}),e.jsx(U,{className:"w-full",...r.register("name")}),e.jsx("div",{className:"h-[1px] bg-theme-border-moderate"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Pipeline Settings"}),e.jsx("p",{className:"text-text-sm text-theme-text-secondary",children:"Select a pipeline and a pipeline run to create your snapshot"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-text-sm",children:"Pipeline"}),e.jsx(G,{pipeline:d||void 0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-text-sm",children:"Run"}),e.jsx(J,{run:s||void 0})]})]}),e.jsx(K,{isPending:t})]})})})}export{ie as C};
