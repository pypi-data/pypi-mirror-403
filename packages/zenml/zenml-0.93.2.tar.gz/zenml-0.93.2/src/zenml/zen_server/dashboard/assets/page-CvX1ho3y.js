import{j as e,aB as x}from"./@radix-Da0HZyg8.js";import{s as f}from"./index-DBB4a7BM.js";import{s as b}from"./constants-Dj_C1ZPH.js";import{c as j,e as g,b as k}from"./@tanstack-BRZ8pkCt.js";import{F as y,G as S,H as v,J as w,x as N,y as C,r as c,B as P,a as E,ab as T,co as z,aI as B}from"./index-5CE1yoTL.js";import{e as F}from"./components-Br2ezRib.js";import{f as U,C as D,S as A,A as I,a as q}from"./schema-DWsyBQf9.js";import{u as O,t as Q,F as G}from"./@zod-yP6IINRw.js";import{a as m}from"./@monaco-editor-xs6rrDBC.js";import{P as H,a as p,b as R}from"./react-resizable-panels.browser-BzyjP_NZ.js";import{c as J,a as K}from"./@react-router-BEwS6i40.js";import{I as L}from"./Infobox-DQUJxLQz.js";import"./@elkjs-D2DP-mPJ.js";import"./stack-detail-query-D9Y3CiUb.js";import"./@reactflow-CEST3EX2.js";import"./ComponentIcon-B7M5n_Xi.js";import"./bar-chart-square-check-DzUJ9YmH.js";import"./layout-2GM5rzX8.js";import"./transform-pqykL0RU.js";import"./common-BrpKozbR.js";import"./flavor-select-CiCagRUR.js";import"./index-p-TDI5a2.js";import"./configuration-form-BwRgv-aT.js";import"./form-BPcAENG-.js";import"./check-DSoixTtU.js";import"./CodeSnippet-BTWWMvCC.js";import"./file-text-B3rACLpg.js";import"./sharedSchema-g4P6EjKg.js";import"./index.es-BLCCg0nE.js";import"./alert-triangle-C7ryTF32.js";function V(t,s){const r=F(t.metadata?.components),a=s.reduce((i,n)=>(i[n]=null,i),{});return r.forEach(i=>{const n=i.body?.type;n&&n in a&&(a[n]={id:i.id,name:i.name,logoUrl:i.body?.logo_url||""})}),!a.orchestrator||!a.artifact_store?null:{stackName:t.name,components:a}}async function _({stackId:t,payload:s}){const r=S(w.stacks.detail(t)),a=await y(r,{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!a.ok){const i=await a.json().then(n=>Array.isArray(n.detail)?n.detail[1]:n.detail).catch(()=>`Error while updating stack ${t}`);throw new v({status:a.status,statusText:a.statusText,message:i})}return a.json()}function M(t){return j({mutationKey:["stacks","update"],...t,mutationFn:async({payload:s,stackId:r})=>_({payload:s,stackId:r})})}function W(t){const{toast:s}=N(),r=g(),a=J(),i=M({onSuccess:async()=>{r.invalidateQueries({queryKey:f.all}),a(c.stacks.overview)},onError:o=>{s({status:"error",emphasis:"subtle",icon:e.jsx(C,{className:"h-5 w-5 shrink-0 fill-error-700"}),description:o.message,rounded:!0})}});function n(o){const l=Object.entries(o.components).reduce((u,[h,d])=>(d&&(u[h]=[d.id]),u),{});i.mutate({stackId:t,payload:{name:o.stackName,components:l}})}return{updateExistingStack:n,isPending:i.isPending}}function Y(){const[t,s]=m.useState(!1),r=()=>{s(!0)};return t?null:e.jsx("div",{className:"p-5 pb-0",children:e.jsxs(L,{button:e.jsx(P,{onClick:r,intent:"secondary",emphasis:"minimal",size:"sm",className:"flex aspect-square size-6 items-center justify-center bg-transparent hover:bg-black/10 focus:bg-black/10 active:bg-black/20 active:ring-0","aria-label":"Close banner",children:e.jsx(E,{className:"size-5 shrink-0 fill-current"})}),intent:"warning",children:[e.jsx("p",{className:"text-text-sm",children:"You are about to update this stack. This update will:"}),e.jsxs("ul",{className:"list-inside list-disc text-text-sm",children:[e.jsx("li",{children:"Change how historical runs display (they'll show the new configuration, not the original)"}),e.jsx("li",{children:"Potentially break existing schedules runs that rely on existing stack components"}),e.jsx("li",{children:"Potentially break existing Docker images for scheduled pipelines due to missing stack component dependencies"}),e.jsx("li",{children:"Apply immediately to all future pipeline executions"})]})]})})}function $({stackId:t,stack:s,initialFormData:r}){const[a,i]=m.useState(""),{updateExistingStack:n,isPending:o}=W(t),l=O({resolver:Q(U(s.name)),defaultValues:r});return e.jsx(G,{...l,children:e.jsx(x,{value:a,onValueChange:i,className:"flex-1 overflow-hidden",children:e.jsx("form",{onSubmit:l.handleSubmit(n),className:"h-full",children:e.jsxs(H,{direction:"horizontal",className:"h-full !flex-col md:!flex-row",children:[e.jsx(p,{className:"!overflow-y-auto",defaultSize:50,minSize:33,children:e.jsxs("div",{className:"flex h-full flex-1 flex-col",children:[e.jsx(Y,{}),e.jsx(D,{initialComponents:s.metadata?.components})]})}),e.jsx(R,{className:"w-[1px] bg-theme-border-moderate transition-colors duration-200 data-[resize-handle-state=drag]:bg-theme-border-bold data-[resize-handle-state=hover]:bg-theme-border-bold"}),e.jsx(p,{className:"!overflow-y-auto bg-theme-surface-primary",defaultSize:50,minSize:33,children:e.jsx(X,{isUpdating:o})})]})})})})}function X({isUpdating:t}){return e.jsxs("div",{className:"flex h-full flex-col justify-between space-y-5",children:[e.jsxs("div",{className:"space-y-5 p-5",children:[e.jsx(A,{}),e.jsx(I,{})]}),e.jsx(q,{cancelRoute:c.stacks.overview,submitLabel:"Update Stack",isLoading:t})]})}function Z(t){const{setBreadcrumbs:s}=T();m.useEffect(()=>{t&&s([z,{label:t,href:c.stacks.overview,disabled:!0},{label:"Update Stack",href:c.stacks.overview,disabled:!0}])},[s,t])}function ze(){const{stackId:t}=K(),s=k({...f.stackDetail(t),throwOnError:!0});if(Z(s.data?.name),s.isPending)return e.jsx("div",{className:"flex h-full items-center justify-center p-5",children:e.jsx(B,{})});if(s.isError)return e.jsx("div",{className:"flex h-full items-center justify-center p-5",children:e.jsx("p",{className:"text-theme-text-error",children:"Failed to load stack data"})});const r=V(s.data,b);return r?e.jsx($,{stackId:t,stack:s.data,initialFormData:r}):e.jsx("div",{className:"flex h-full items-center justify-center p-5",children:e.jsx("p",{className:"text-theme-text-error",children:"Stack is missing required components"})})}export{ze as default};
