# yaml-language-server: $schema=../../../schemas/model_config_schema.json

# =============================================================================
# Human in the Loop (HITL) Configuration Example
# =============================================================================
# This configuration demonstrates how to use Human in the Loop approval 
# for tool executions. HITL pauses agent execution before tool calls,
# allowing humans to approve, edit, or reject actions.
#
# Key Features:
# - Tool-level configuration via human_in_the_loop field
# - Customizable review prompts
# - Fine-grained control over allowed decisions (approve/edit/reject)
# - Works with all tool types (python, factory, unity_catalog, mcp)
# - Requires a checkpointer to be configured for persistence

# =============================================================================
# VARIABLES
# =============================================================================
# Define reusable variables that can be referenced throughout the config
# using YAML anchors (&variable_name) and aliases (*variable_name)


  # Other variable types supported:
  # - Secrets: { type: secret, scope: my_scope, key: my_key }
  # - Composite: { type: composite, options: [${VAR1}, ${VAR2}, default] }
  # - Primitives: Just use the value directly

variables:
  client_id: &client_id
    options:
      - env: RETAIL_AI_DATABRICKS_CLIENT_ID      # Service principal client ID
      - scope: retail_consumer_goods
        secret: RETAIL_AI_DATABRICKS_CLIENT_ID
  client_secret: &client_secret
    options:
      - env: RETAIL_AI_DATABRICKS_CLIENT_SECRET  # Service principal secret
      - scope: retail_consumer_goods
        secret: RETAIL_AI_DATABRICKS_CLIENT_SECRET

schemas:
  retail_schema: &retail_schema
    catalog_name: nfleming                    
    schema_name: retail_ai                    

resources:
  llms:
    default_llm: &default_llm
      name: databricks-claude-sonnet-4 
      temperature: 0.1
      max_tokens: 8192

  databases:
    lakebase_db: &lakebase_db
      name: retail-consumer-goods
      instance_name: retail-consumer-goods
      client_id: *client_id
      client_secret: *client_secret

# =============================================================================
# TOOLS WITH HUMAN-IN-THE-LOOP CONFIGURATIONS
# =============================================================================

tools:


  # Example: Tool WITH HITL configured
  current_time: &current_time
    name: current_time
    function:
      type: python
      name: dao_ai.tools.current_time_tool
      human_in_the_loop:
        # Optional: Custom review prompt shown to the reviewer
        review_prompt: |
          Please review this time query.
          This demonstrates HITL configuration.
        # LangChain supports 3 decision types:
        # - "approve": Execute with original arguments
        # - "edit": Modify arguments before execution  
        # - "reject": Skip execution with optional feedback
        allowed_decisions:
          - approve
          - edit
          - reject

  say_hello: &say_hello
    name: say_hello
    function:
      type: python
      name: dao_ai.tools.say_hello_tool
      human_in_the_loop:
        # Optional: Custom review prompt shown to the reviewer
        review_prompt: |
          Please review this greeting request.
          This demonstrates HITL configuration.
        # LangChain supports 3 decision types:
        # - "approve": Execute with original arguments
        # - "edit": Modify arguments before execution  
        # - "reject": Skip execution with optional feedback
        allowed_decisions:
          - approve
          - edit
          - reject

# =============================================================================
# AGENTS WITH HITL-ENABLED TOOLS
# =============================================================================

agents:
  # Agent with high-risk tools requiring approval
  admin_agent: &admin_agent
    name: admin_agent
    description: "Administrative agent with HITL-protected operations"
    model: *default_llm
    tools:
      - *current_time      # No approval needed (safe)
      - *say_hello
    prompt: |
      You are an administrative agent with access to sensitive operations.
      
      IMPORTANT: All destructive or external operations require human approval.
      When you want to:
      - Send emails
      - Delete records
      - Execute SQL
      
      The system will pause and ask for human review. Wait for approval.
      
      Safe operations (like current_time) execute immediately without approval.

# =============================================================================
# MEMORY CONFIGURATION (REQUIRED FOR HITL)
# =============================================================================
# HITL requires a checkpointer to persist state between approval steps
# Using Lakebase database for this example (type inferred from database presence)

memory: &memory
  checkpointer: 
    name: hitl_checkpointer
    database: *lakebase_db             # For production, use either Lakebase or PostgreSQL database (type inferred from presence)
  store:
    name: hitl_store
    database: *lakebase_db             # Type inferred from presence   

# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================

app:

  name: human_in_the_loop_dao
  description: "Demonstration of Human in the Loop approvals"
  log_level: TRACE
  
  registered_model:
    schema: *retail_schema
    name: hitl_demo_app
  
  endpoint_name: hitl_demo_app
  
  agents:
    - *admin_agent

  
  orchestration:
    swarm:
      default_agent: *main_agent

    memory: *memory  # CRITICAL: Memory with checkpointer required for HITL
  
  input_example:
    messages:
      - role: user
        content: "Send an email to the team about tomorrow's meeting"
    custom_inputs:
      configurable:
        user_id: demo_user
        thread_id: demo_thread
      session: {}

# =============================================================================
# USAGE NOTES
# =============================================================================
# 
# 1. HITL Workflow:
#    a. Agent decides to call a tool with human_in_the_loop configured
#    b. Execution pauses (interrupt) with review_prompt displayed
#    c. Human reviews and chooses action:
#       - Approve: Execute tool with original arguments
#       - Edit: Modify arguments before execution
#       - Reject: Skip tool execution with optional feedback message
#    d. Agent continues with human's decision
#
# 2. Checkpointer Requirement:
#    HITL requires a checkpointer to save state during interrupts.
#    This example uses Lakebase for simplicity.
#    For production, provide a database configuration (type is inferred from presence):
#      checkpointer:
#        database:
#          host: your-postgres-host
#          port: 5432
#          database: your_db_name
#
# 3. Decision Types:
#    LangChain's HumanInTheLoopMiddleware supports 3 decision types:
#    
#    | Decision Type | Description                                              |
#    |---------------|----------------------------------------------------------|
#    | approve       | Execute tool with original arguments (no modifications)  |
#    | edit          | Modify tool arguments before execution                   |
#    | reject        | Skip tool execution with optional feedback message       |
#    
#    Configure allowed decisions directly in human_in_the_loop:
#      allowed_decisions: [approve, edit, reject]  # Allow all three
#      allowed_decisions: [approve, reject]        # Review-only (no edits)
#      allowed_decisions: [approve]                # Auto-approve only
#
# 4. Best Practices:
#    - Use HITL for: destructive operations, external APIs, costly operations
#    - Skip HITL for: read-only operations, simple utilities, time-sensitive tasks
#    - Write clear review_prompts explaining what needs review
#
# 5. Testing HITL:
#    When testing, the agent will pause at HITL-enabled tools.
#    Use LangGraph's interrupt handling to simulate human decisions.
#
# 6. Production Deployment:
#    HITL works in Model Serving with proper UI integration.
#    The review_prompt and options are returned to the client.
#    Client UI collects human decision and continues the graph.
