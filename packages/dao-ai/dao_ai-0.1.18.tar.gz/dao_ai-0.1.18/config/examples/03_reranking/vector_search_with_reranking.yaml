# yaml-language-server: $schema=../../../schemas/model_config_schema.json

schemas:
  retail_schema: &retail_schema
    catalog_name: retail_consumer_goods        # Unity Catalog name
    schema_name: hardware_store                # Schema within the catalog

resources:
  llms:
    # Primary LLM for general tasks
    default_llm: &default_llm
      name: databricks-claude-sonnet-4             # Databricks serving endpoint name
      temperature: 0.1                              # Low temperature for consistent responses
      max_tokens: 8192                              # Maximum tokens per response

    embedding_model: &embedding_model
      name: databricks-gte-large-en                 # Text embedding model

  vector_stores:
    # Product information vector store for similarity search
    products_vector_store: &products_vector_store
      embedding_model: *embedding_model             # Reference to embedding model above
      endpoint:                                     # Vector search endpoint configuration
        name: one-env-shared-endpoint-0             # Databricks vector search endpoint
        type: STANDARD                              # Endpoint type (STANDARD or OPTIMIZED_STORAGE)
      index:                                        # Vector search index configuration
        schema: *retail_schema                      # Unity Catalog schema for the index
        name: retail_vectorstore                    # Index name
      source_table:                                 # Table containing source data
        schema: *retail_schema
        name: products
      primary_key: product_id                        # Primary key column
      doc_uri: ~                                    # Optional document URI column (null in this case)
      embedding_source_column: description          # Column to create embeddings from
      columns:                                      # Columns to include in vector store
        - product_id
        - sku
        - upc
        - brand_name
        - product_name
        - merchandise_class
        - class_cd
        - description

retrievers:
  # Retriever WITH default reranking
  default_reranked_retriever: &default_reranked_retriever
    vector_store: *products_vector_store
    columns:
      - product_id
      - sku
      - upc
      - brand_name
      - product_name
      - merchandise_class
      - class_cd
      - description
    search_parameters:
      num_results: 50                               # Retrieve more candidates for reranking
      filters: {}
      query_type: ANN
    rerank: true                                    # Enable reranking with default settings

  # Retriever WITH custom reranking (fast model)
  fast_reranked_retriever: &fast_reranked_retriever
    vector_store: *products_vector_store
    columns:
      - product_id
      - sku
      - upc
      - brand_name
      - product_name
      - merchandise_class
      - class_cd
      - description
    search_parameters:
      num_results: 100                              # Cast wide net for reranking
      filters: {}
      query_type: ANN
    rerank:                                         # Custom reranking configuration
      model: ms-marco-TinyBERT-L-2-v2               # Fastest, smallest model (~4MB)
      top_n: 5                                      # Return top 5 after reranking
      # cache_dir: ~/.dao_ai/cache/flashrank        # Cache directory (default shown)

  # Retriever WITH accurate reranking (hybrid + reranking)
  accurate_reranked_retriever: &accurate_reranked_retriever
    vector_store: *products_vector_store
    columns:
      - product_id
      - sku
      - upc
      - brand_name
      - product_name
      - merchandise_class
      - class_cd
      - description
    search_parameters:
      num_results: 50
      filters: {}
      query_type: HYBRID                            # Use hybrid search for better recall
    rerank:
      model: ms-marco-MiniLM-L-12-v2                # Balanced model (default)
      top_n: 10                                     # Return top 10 after reranking
      # cache_dir: ~/.dao_ai/cache/flashrank        # Cache directory (default shown)

tools:
  # Vector search with default reranking
  default_reranked_tool: &default_reranked_tool
    name: reranked_product_search
    function:
      type: factory
      name: dao_ai.tools.create_vector_search_tool
      args:
        retriever: *default_reranked_retriever
        name: reranked_product_search
        description: |
          Search for products with reranking enabled.
          Retrieves 50 candidates and reranks them using FlashRank
          with the default model (ms-marco-MiniLM-L-12-v2).

  # Tool 3: Vector search with fast reranking
  fast_reranked_tool: &fast_reranked_tool
    name: fast_reranked_search
    function:
      type: factory
      name: dao_ai.tools.create_vector_search_tool
      args:
        retriever: *fast_reranked_retriever
        name: fast_reranked_search
        description: |
          Fast product search with lightweight reranking.
          Retrieves 100 candidates, reranks with a fast model,
          and returns the top 5 most relevant results.

  # Tool 4: Vector search with accurate reranking
  accurate_reranked_tool: &accurate_reranked_tool
    name: accurate_product_search
    function:
      type: factory
      name: dao_ai.tools.create_vector_search_tool
      args:
        retriever: *accurate_reranked_retriever
        name: accurate_product_search
        description: |
          High-accuracy product search combining hybrid search and reranking.
          Uses HYBRID query type for better initial recall, then reranks
          using a more accurate model to return the best 10 results.

agents:
  # Agent with default reranking
  reranked_search_agent: &reranked_search_agent
    name: reranked_search
    description: "Product search agent with reranking for improved accuracy"
    model: *default_llm
    tools:
      - *default_reranked_tool
    prompt: |
      You are an enhanced product search assistant with reranking capabilities.
      Use the reranked_product_search tool to find the most relevant products.
      The results are reranked for better accuracy.
    handoff_prompt: |
      Handles product searches with reranking for improved result quality.

  # Agent 3: Uses fast reranking
  fast_search_agent: &fast_search_agent
    name: fast_search
    description: "Product search agent with fast reranking"
    model: *default_llm
    tools:
      - *fast_reranked_tool
    prompt: |
      You are a fast product search assistant. Use the fast_reranked_search tool
      to quickly find the most relevant products from a large candidate set.
    handoff_prompt: |
      Handles product searches with fast reranking for high-volume scenarios.

  # Agent 4: Uses accurate reranking with hybrid search
  accurate_search_agent: &accurate_search_agent
    name: accurate_search
    description: "Product search agent with hybrid search and accurate reranking"
    model: *default_llm
    tools:
      - *accurate_reranked_tool
    prompt: |
      You are a high-accuracy product search assistant. Use the accurate_product_search
      tool which combines hybrid search with reranking for the best possible results.
    handoff_prompt: |
      Handles product searches requiring highest accuracy using hybrid search and reranking.

app:
  name: vector_search_with_reranking_dao
  description: "Demonstrates vector search with FlashRank reranking configurations"
  log_level: TRACE
  registered_model:
    schema: *retail_schema
    name: vector_search_with_reranking_dao
  endpoint_name: vector_search_reranking_agent
  tags:
    demo: reranking
    feature: vector_search
  permissions:
    - principals: [users]
      entitlements:
        - CAN_QUERY
  agents:
    # Include agents with different reranking configurations
    - *reranked_search_agent        # Default reranking
    - *fast_search_agent            # Fast reranking
    - *accurate_search_agent        # Accurate reranking with hybrid
  orchestration:
    supervisor:
      model: *default_llm

# ==============================================================================
# RERANKING BEST PRACTICES AND CONFIGURATION GUIDE
# ==============================================================================
#
# This example demonstrates 3 different reranking configurations:
#
# 1. Default Reranking - reranked_search_agent
#    - Uses rerank: true for automatic configuration
#    - Retrieves 50 candidates, reranks with ms-marco-MiniLM-L-12-v2
#    - Good balance of speed and accuracy
#    - Use when: Need better results than standard search
#
# 2. Fast Reranking - fast_search_agent
#    - Uses lighter model (ms-marco-TinyBERT-L-2-v2)
#    - Retrieves 100 candidates, returns top 5
#    - Faster than default but still improves results
#    - Use when: High volume, need speed with some accuracy boost
#
# 3. Accurate Reranking - accurate_search_agent
#    - Combines HYBRID search with reranking
#    - Best possible result quality
#    - Higher latency (~200-500ms)
#    - Use when: Quality is paramount (customer-facing, critical queries)
#
# Configuration Pattern:
#   retriever:
#     vector_store: *your_vector_store
#     search_parameters:
#       num_results: 50              # Retrieve 2-10x more than needed
#       query_type: ANN              # or HYBRID for better recall
#     rerank:                        # Optional reranking
#       model: ms-marco-MiniLM-L-12-v2  # Choose model
#       top_n: 10                    # Final count after reranking
#       cache_dir: ~/.dao_ai/cache/flashrank  # Cache directory (default)
#
# Performance Tips:
#   - First request downloads model (~50MB) - allow extra time
#   - Subsequent requests are fast (100-500ms)
#   - More candidates = better reranking but slower
#   - Cache directory should be on fast storage
#
# Model Selection (see https://github.com/PrithivirajDamodaran/FlashRank):
#   - ms-marco-TinyBERT-L-2-v2: ~4MB, fastest
#   - ms-marco-MiniLM-L-12-v2: ~34MB, best cross-encoder (default)
#   - rank-T5-flan: ~110MB, best non cross-encoder
#   - ms-marco-MultiBERT-L-12: ~150MB, multilingual (100+ languages)
#   - ce-esci-MiniLM-L12-v2: e-commerce optimized (Amazon ESCI)
#   - miniReranker_arabic_v1: Arabic language
