name: PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate PR title (Conventional Commits)
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
          requireScope: false

      - name: Check for merge conflicts
        uses: olivr/copybara-action@v1.2.3
        with:
          access_token: ${{ secrets.GITHUB_TOKEN }}
          ssh_key: ${{ secrets.SSH_KEY || '' }}
          sot_branch: main
          destination_branch: ${{ github.head_ref }}
        continue-on-error: true

  code-quality:
    name: Code Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Check code formatting
        run: |
          black --check balaganagent/ tests/
        continue-on-error: false

      - name: Lint code
        run: |
          ruff check balaganagent/ tests/
        continue-on-error: false

      - name: Type check
        run: |
          mypy balaganagent/
        continue-on-error: false

  tests:
    name: Test Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          pytest --cov=balaganagent --cov-report=xml --cov-report=term-missing --cov-fail-under=50 -v

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MINIMUM_GREEN: 90
          MINIMUM_ORANGE: 80

  security:
    name: Security Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

      - name: Run safety check
        run: |
          python -m pip install --upgrade pip
          pip install safety
          safety check --json

  file-checks:
    name: File Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check file sizes
        run: |
          find . -type f -size +1M -not -path "./venv/*" -not -path "./.git/*" -not -path "./node_modules/*" | while read file; do
            echo "::warning file=$file::Large file detected (>1MB): $file"
          done

      - name: Check for TODO/FIXME comments in changed files
        if: github.event_name == 'pull_request'
        run: |
          git diff origin/${{ github.base_ref }}...HEAD --name-only | grep "\.py$" | while read file; do
            if [ -f "$file" ]; then
              if grep -n "TODO\|FIXME" "$file"; then
                echo "::warning file=$file::Found TODO/FIXME comments in $file"
              fi
            fi
          done

      - name: Check required files exist
        run: |
          required_files=("README.md" "LICENSE" "pyproject.toml" "SECURITY.md" "CHANGELOG.md")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "::error file=$file::Required file missing: $file"
              exit 1
            fi
          done

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for broken links in Markdown
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
          folder-path: '.'
          file-extension: '.md'

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [pr-validation, code-quality, tests, security, file-checks]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.pr-validation.result }}" != "success" ] || \
             [ "${{ needs.code-quality.result }}" != "success" ] || \
             [ "${{ needs.tests.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ] || \
             [ "${{ needs.file-checks.result }}" != "success" ]; then
            echo "::error::One or more quality checks failed"
            exit 1
          fi
          echo "âœ… All PR quality checks passed!"
