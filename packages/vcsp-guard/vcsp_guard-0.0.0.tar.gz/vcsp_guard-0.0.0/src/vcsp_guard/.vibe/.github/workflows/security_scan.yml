name: Vibe Security Audit

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  schedule:
           # ┌───────────── minuto (0 - 59)
           # │ ┌───────────── hora (0 - 23)
           # │ │ ┌───────────── dia do mês (1 - 31)
           # │ │ │ ┌───────────── mês (1 - 12)
           # │ │ │ │ ┌───────────── dia da semana (0 - 6 ou SUN-SAT)
           # │ │ │ │ │
    - cron: '0 8 * * 1' # Toda segunda-feira às 08:00 UTC
  workflow_dispatch: # Permite rodar manualmente na aba Actions

permissions:
  contents: write

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'uv'

      - name: Instalar uv
        uses: astral-sh/setup-uv@v6
      
      - name: Instalar Ferramentas
        run: uv pip install --system bandit pip-audit ruff pytest matplotlib "semgrep>=1.0.0"
      
      - name: Rodar Testes (Pytest)
        run: pytest
      
      - name: Rodar Scan Completo
        id: scan
        continue-on-error: true
        run: python src/vcsp_guard/scan_project.py
      
      - name: Gerar Gráfico de Tendência  # pragma: allowlist secret
        run: |  # pragma: allowlist secret
          python - <<'PY'
          import os, json, glob, re, matplotlib.pyplot as plt
          from datetime import datetime

          # 1. Encontrar log mais recente
          list_of_files = glob.glob('logs_scan_vcsp/scan_*.txt')
          if not list_of_files: exit(0)
          latest_file = max(list_of_files, key=os.path.getctime)

          # 2. Parsear Log
          stats = {
              'date': datetime.now().strftime('%Y-%m-%d'),
              'secrets': 0,
              'detect_secrets': 0,
              'bandit': 0,
              'audit': 0,
              'ruff': 0,
              'semgrep': 0,
              'cwe': 0,
          }
          with open(latest_file, 'r', encoding='utf-8') as f:
              content = f.read()
              stats['secrets'] = len(re.findall(r'❌ \[SEGREDO\]', content))
              stats['detect_secrets'] = len(re.findall(r'❌ \[DETECT-SECRETS\]|❌ Detect-secrets encontrou', content))
              bandit_match = re.search(r'Total issues: (\d+)', content)
              if bandit_match: stats['bandit'] = int(bandit_match.group(1))
              audit_match = re.search(r'Found (\d+) known vulnerabilit', content)
              if audit_match: stats['audit'] = int(audit_match.group(1))
              ruff_match = re.search(r'Found (\d+) error', content)
              if ruff_match: stats['ruff'] = int(ruff_match.group(1))
              semgrep_match = re.search(r'Found (\d+) infrastructure issues', content)
              if semgrep_match: stats['semgrep'] = int(semgrep_match.group(1))
              # Busca por CWE (Semgrep Top 25)
              # Regex mais robusto para capturar 'Code Finding' mesmo com espaços
              cwe_match = re.search(
                  r"^\s*┌─+\s*┐\s*│\s*(\d+)\s*Code Finding\s*│",
                  content, re.MULTILINE
              )
              if cwe_match:
                  stats['cwe'] = int(cwe_match.group(1))
              elif "Semgrep CWE Top 25 encontrou vulnerabilidades!" in content:
                  stats['cwe'] = 1

          # 3. Atualizar Histórico
          os.makedirs('.vibe/assets', exist_ok=True)
          history_file = '.vibe/stats.json'
          history = []
          if os.path.exists(history_file):
              with open(history_file, 'r') as f: history = json.load(f)
          history.append(stats)
          history = history[-15:] # Manter últimos 15 scans
          with open(history_file, 'w') as f: json.dump(history, f)

          # 4. Gerar Gráfico
          dates = [h['date'] for h in history]
          plt.figure(figsize=(12, 6))
          plt.plot(dates, [h['secrets'] for h in history], label='Secrets', marker='o', color='red')
          plt.plot(dates, [h.get('detect_secrets', 0) for h in history], label='Detect-secrets', marker='o', color='brown')
          plt.plot(dates, [h['bandit'] for h in history], label='Bandit (Logic)', marker='o', color='orange')
          plt.plot(dates, [h['audit'] for h in history], label='Pip-Audit (Deps)', marker='o', color='blue')
          plt.plot(dates, [h['ruff'] for h in history], label='Ruff (Lint)', marker='o', color='green')
          plt.plot(dates, [h.get('semgrep', 0) for h in history], label='Semgrep (IaC)', marker='o', color='purple')
          plt.plot(dates, [h.get('cwe', 0) for h in history], label='CWE (Top 25)', marker='o', color='black', linewidth=2)
          plt.title('Tendência de Vulnerabilidades (VCSP)')
          plt.xlabel('Data')
          plt.ylabel('Quantidade de Falhas')
          plt.legend()
          plt.grid(True, linestyle='--', alpha=0.7)
          plt.savefig('.vibe/assets/bug_trend.png')

          # 5. Atualizar README.md (Cache Busting)
          readme_path = 'README.md'
          if os.path.exists(readme_path):
              with open(readme_path, 'r', encoding='utf-8') as f:
                  readme_content = f.read()
              
              new_content = re.sub(
                  r'(!\[Bug Trend\]\(\.vibe/assets/bug_trend\.png)(?:\?v=\d+)?\)',
                  f'\\1?v={datetime.now().strftime("%Y%m%d%H%M%S")})',
                  readme_content
              )
              
              with open(readme_path, 'w', encoding='utf-8') as f:
                  f.write(new_content)
          PY
      
      - name: Sincronizar com a Branch Atual (Evitar Conflitos)
        env:
          HEAD_REF: ${{ github.head_ref }}
        run: git pull origin "$HEAD_REF" --rebase --autostash
      
      - name: Commit do Gráfico
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "docs: update security trend chart"
          file_pattern: .vibe/stats.json .vibe/assets/bug_trend.png README.md
          branch: ${{ github.ref_name }}
      
      - name: Upload Logs (Artifact)
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: security-logs
          path: logs_scan_vcsp/
      
      - name: Verificar Status do Scan
        if: steps.scan.outcome == 'failure'
        run: |
          echo "⛔ Falhas de segurança encontradas!"
          exit 1
