import{_ as G,r as m,c as S,w as Y,o as Q,a as J,b as i,d as l,e as t,t as _,F as O,i as j,f as P,m as K,p as Z,Q as ee,g as te,a3 as se,x as ae,a9 as q,a8 as H,G as ne,n as oe,aa as ie,a6 as le}from"./_plugin-vue_export-helper-D2l53SUz.js";import{c as re,s as ce,b as ue,w as z}from"./pow-2N9bxgAo.js";const de={class:"remote-auth-inline"},he={key:0,class:"success-section"},ve={class:"success-message"},fe={key:1,class:"error-section"},me={class:"error-message"},ge={key:2,class:"auth-display"},pe={class:"auth-content"},_e={class:"pairing-code-section"},we={class:"slot-machine","aria-hidden":"true"},ye={class:"slot-word"},ke={class:"site-url"},be={key:3,class:"auth-display"},$e={class:"auth-content"},Ae={key:0,class:"pairing-code-section"},Re={class:"slot-machine stopped"},Se={class:"slot-word"},Ce={class:"site-url"},Pe={class:"waiting-indicator"},Te={__name:"RemoteAuthRequest",props:{active:{type:Boolean,default:!1}},emits:["authenticated","cancelled","error","register"],setup(w,{expose:M,emit:x}){const $=w,g=x,v=m(null),y=m(!1),n=m(null),A=m("connecting"),p=m(null),u=m(["","",""]);let a=null,k=null;const W=S(()=>v.value?v.value.replace(/\./g," "):""),b=S(()=>{if(!p.value)return"";const s=(p.value.auth_site_url||`${location.protocol}//${location.host}/auth/`).replace(/^https?:\/\//,"");return s.endsWith("/")?s.slice(0,-1):s}),E=S(()=>A.value==="authenticating"?"Complete on another deviceâ€¦":"Waiting for authenticationâ€¦"),B=S(()=>"Authenticated successfully!");function C(){return z[Math.floor(Math.random()*z.length)]}function V(){u.value=[C(),C(),C()];const c=20,s=[setInterval(()=>{const o=[...u.value];o[0]=C(),u.value=o},140),setInterval(()=>{const o=[...u.value];o[1]=C(),u.value=o},170),setInterval(()=>{const o=[...u.value];o[2]=C(),u.value=o},200)];k=s,setTimeout(()=>{s.forEach(o=>clearInterval(o)),k=null},c*170)}function f(){k&&(Array.isArray(k)?k.forEach(c=>clearInterval(c)):clearInterval(k),k=null)}async function L(){n.value=null,y.value=!1,v.value=null,A.value="connecting",V();try{p.value=await K();const c=p.value?.auth_host,s="/auth/ws/remote-auth/request",o=c&&location.host!==c?`//${c}${s}`:s;a=await Z(o);const R=await a.receive_json();if(R.pow){const h=re(R.pow.challenge),F=await ce(h,R.pow.work);a.send_json({pow:ue(F),action:"login"})}const T=await a.receive_json();if(T.status)throw new Error(T.detail||`Failed to create remote auth request: ${T.status}`);for(v.value=T.pairing_code,f(),A.value="waiting";;){const h=await a.receive_json();if(h.status==="locked")A.value="authenticating";else if(h.status==="paired")A.value="authenticating";else if(h.status==="authenticated"){y.value=!0,g("authenticated",{session_token:h.session_token});break}else{if(h.status==="denied")throw new Error("Access denied");if(h.status==="completed"){h.reset_token&&(y.value=!0,g("register",h.reset_token));break}else if(h.status==="error"||h.detail)throw new Error(h.detail||"Remote authentication failed")}}}catch(c){console.error("Remote authentication error:",c);const s=c.message||"Authentication failed";n.value=s,g("error",s)}finally{a&&(a.close(),a=null)}}function U(){L()}function I(){a&&(a.close(),a=null),g("cancelled")}return Y(()=>$.active,c=>{c&&!v.value&&!n.value&&!y.value&&L()}),Q(()=>{$.active&&L()}),J(()=>{a&&(a.close(),a=null),f()}),M({retry:U,cancel:I}),(c,s)=>(l(),i("div",de,[y.value?(l(),i("div",he,[t("p",ve,"âœ… "+_(B.value),1)])):n.value?(l(),i("div",fe,[t("p",me,_(n.value),1),t("button",{class:"btn-primary",onClick:U,style:{"margin-top":"0.75rem"}},"Try Again")])):A.value==="connecting"?(l(),i("div",ge,[t("div",pe,[t("div",_e,[s[0]||(s[0]=t("p",{class:"pairing-label"},"Enter the code words:",-1)),t("div",we,[(l(!0),i(O,null,j(u.value,(o,R)=>(l(),i("div",{class:"slot-reel",key:R},[t("div",ye,_(o),1)]))),128))]),t("p",ke,_(b.value),1)])]),s[1]||(s[1]=t("div",{class:"waiting-indicator"},[t("div",{class:"spinner-small"}),t("span",null,"Generating codeâ€¦")],-1))])):(l(),i("div",be,[t("div",$e,[v.value?(l(),i("div",Ae,[s[2]||(s[2]=t("p",{class:"pairing-label"},"Enter the code words:",-1)),t("div",Re,[(l(!0),i(O,null,j(W.value.split(" "),(o,R)=>(l(),i("div",{class:"slot-reel",key:R},[t("div",Se,_(o),1)]))),128))]),t("p",Ce,_(b.value),1)])):P("",!0)]),t("div",Pe,[s[3]||(s[3]=t("div",{class:"spinner-small"},null,-1)),t("span",null,_(E.value),1)])]))]))}},Ee=G(Te,[["__scopeId","data-v-1280e25b"]]),We={class:"app-shell"},Le={key:0,class:"global-status",style:{display:"block"}},Ue={class:"view-root"},Ie={key:0,class:"surface surface--tight"},Me={class:"view-header center"},xe={key:0,class:"user-line"},Be=["innerHTML"],Ve={class:"section-block"},Fe={class:"section-body center"},qe={key:0,class:"auth-view"},De=["disabled"],Ne=["disabled"],Oe=["disabled"],je=["disabled"],He={key:1,class:"auth-view"},ze={__name:"RestrictedAuth",props:{mode:{type:String,default:"login",validator:w=>["login","reauth","forbidden"].includes(w)}},emits:["authenticated","forbidden","logout","back","home","auth-error"],setup(w,{expose:M,emit:x}){const $=w,g=x,v=ee({show:!1,message:"",type:"info"}),y=m(!0),n=m(!1),A=m(null),p=m(null),u=m("initial"),a=m("local"),k=m(null);let W=null;const b=S(()=>!!p.value),E=S(()=>y.value?!1:$.mode==="reauth"?!0:u.value!=="forbidden"),B=S(()=>$.mode==="reauth"?"ðŸ” Additional Authentication":u.value==="forbidden"?"ðŸš« Forbidden":`ðŸ” ${A.value?.rp_name||location.origin}`),C=S(()=>$.mode==="reauth"?"Please verify your identity to continue with this action.":u.value==="forbidden"?"You lack the required permissions.":a.value==="remote"?'Confirm from your other device. Or <a href="#" class="inline-link" data-action="local">this device</a>.':E.value&&$.mode!=="reauth"?'Please sign in with your passkey. Or use <a href="#" class="inline-link" data-action="remote">another device</a>.':"Please sign in with your passkey."),V=S(()=>p.value?.ctx.user.display_name||"User");function f(e,r="info",d=3e3){v.show=!0,v.message=e,v.type=r,W&&clearTimeout(W),d>0&&(W=setTimeout(()=>{v.show=!1},d))}async function L(){try{const e=await K();if(A.value=e,e?.rp_name){const r=$.mode==="reauth"?"Verify Identity":b.value?"Forbidden":"Sign In";document.title=`${e.rp_name} Â· ${r}`}}catch(e){console.warn("Unable to load settings",e)}}async function U(){try{p.value=await q("/auth/api/validate",{method:"POST"}),b.value&&$.mode!=="reauth"?(u.value="forbidden",g("forbidden",p.value)):u.value="login"}catch(e){p.value=null,u.value="login",e.status!==401&&e.status!==403&&f(H(e),"error",4e3)}}async function I(){if(!E.value||n.value)return;n.value=!0,f("Starting authenticationâ€¦","info");let e;try{e=await ne.authenticate()}catch(r){n.value=!1;const d=r?.message||"Passkey authentication cancelled",N=d==="Passkey authentication cancelled";f(d,N?"info":"error",4e3),g("auth-error",{message:d,cancelled:N});return}try{await o(e)}catch(r){n.value=!1;const d=r?.message||"Failed to establish session";f(d,"error",4e3),g("auth-error",{message:d,cancelled:!1});return}n.value=!1,g("authenticated",e)}async function c(){if(!n.value){n.value=!0;try{await q("/auth/api/logout",{method:"POST"}),p.value=null,u.value="login",f("Logged out. You can sign in with a different account.","info",3e3)}catch(e){f(H(e),"error",4e3)}finally{n.value=!1}g("logout")}}function s(){const e=window.open("/auth/","passkey_auth_profile");e&&e.focus()}async function o(e){if(!e?.session_token)throw console.error("setSessionCookie called with missing session_token:",e),new Error("Authentication response missing session_token");return await q("/auth/api/set-session",{method:"POST",headers:{Authorization:`Bearer ${e.session_token}`}})}function R(){a.value="remote"}function T(){a.value="local"}async function h(e){f("Authenticated from another device!","success",2e3);try{await o(e)}catch(r){const d=r?.message||"Failed to establish session";f(d,"error",4e3),g("auth-error",{message:d,cancelled:!1});return}g("authenticated",e)}function F(e){f("Registration approved! Redirecting...","success",2e3);const r=le()||"/auth/";window.location.href=`${r}${e}`}function X(e){}function D(e){const r=e.target;if(r.tagName==="A"&&r.classList.contains("inline-link")){e.preventDefault();const d=r.dataset.action;d==="remote"?R():d==="local"&&T()}}return Y(y,e=>{e||oe(()=>ie(k.value))}),Q(async()=>{await L(),await U(),y.value=!1,document.addEventListener("click",D)}),J(()=>{document.removeEventListener("click",D)}),M({showMessage:f,isAuthenticated:b,session:p}),(e,r)=>(l(),i("div",We,[v.show?(l(),i("div",Le,[t("div",{class:te(["status",v.type])},_(v.message),3)])):P("",!0),t("main",Ue,[y.value?P("",!0):(l(),i("div",Ie,[t("header",Me,[t("h1",null,_(B.value),1),b.value?(l(),i("p",xe,"ðŸ‘¤ "+_(V.value),1)):P("",!0),t("p",{class:"view-lede",innerHTML:C.value},null,8,Be)]),t("section",Ve,[t("div",Fe,[a.value==="local"?(l(),i("div",qe,[t("div",{class:"button-row center",ref_key:"buttonRow",ref:k},[se(e.$slots,"actions",{loading:n.value,canAuthenticate:E.value,isAuthenticated:b.value,authenticate:I,logout:c,mode:w.mode},()=>[t("button",{class:"btn-secondary",disabled:n.value,onClick:r[0]||(r[0]=d=>e.$emit("back"))},"Back",8,De),E.value?(l(),i("button",{key:0,class:"btn-primary",disabled:n.value,onClick:I},_(n.value?w.mode==="reauth"?"Verifyingâ€¦":"Signing inâ€¦":w.mode==="reauth"?"Verify":"Login"),9,Ne)):P("",!0),b.value&&w.mode!=="reauth"?(l(),i("button",{key:1,class:"btn-danger",disabled:n.value,onClick:c},"Logout",8,Oe)):P("",!0),b.value&&w.mode!=="reauth"?(l(),i("button",{key:2,class:"btn-primary",disabled:n.value,onClick:s},"Profile",8,je)):P("",!0)])],512)])):a.value==="remote"?(l(),i("div",He,[ae(Ee,{active:a.value==="remote",onAuthenticated:h,onRegister:F,onCancelled:T,onError:X},null,8,["active"])])):P("",!0)])])]))])]))}},Qe=G(ze,[["__scopeId","data-v-3295ed62"]]);export{Qe as R};
