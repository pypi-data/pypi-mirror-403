image: python:3.14

stages:
  - build
  - publish
  - docker
  - cleanup

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  DOCKERHUB_REPO: "tcosolutions/betterscan-worker-cli"

cache:
  paths:
    - .pip-cache/


# 1. BUILD STAGE
build_package:
  stage: build
  before_script:
    - git fetch --tags
  script:
    - python -m build
    - python -m twine upload --verbose dist/*
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
  script:
    - pip install --upgrade pip
    - pip install build
    - python -m build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

# 2. PUBLISH STAGE (PyPI)
publish_to_pypi:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG
      when: always
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
  before_script:
    - pip install twine
  script:
    - export TWINE_USERNAME="__token__"
    - export TWINE_PASSWORD="$PYPI_TOKEN"
    - python -m twine upload --verbose dist/*

# 3. DOCKER STAGE (Secure DinD)
docker_publish:
  stage: docker
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  rules:
    - if: $CI_COMMIT_TAG
      when: always
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
  script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - |
      TAG_NAME=${CI_COMMIT_TAG:-latest}
      docker build -t "$DOCKERHUB_REPO:$TAG_NAME" .
      docker push "$DOCKERHUB_REPO:$TAG_NAME"

# 4. CLEANUP STAGE (Scheduled)
docker_hub_cleanup:
  stage: cleanup
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      TOKEN=$(curl -s -H "Content-Type: application/json" -X POST \
        -d "{\"username\": \"$DOCKERHUB_USERNAME\", \"password\": \"$DOCKERHUB_TOKEN\"}" \
        https://hub.docker.com/v2/users/login/ | jq -r .token)
      THRESHOLD_DATE=$(date -d "@$(($(date +%s) - 2592000))" +%Y-%m-%dT%H:%M:%S)
      TAGS_JSON=$(curl -s -H "Authorization: JWT $TOKEN" "https://hub.docker.com/v2/repositories/$DOCKERHUB_REPO/tags/?page_size=100")
      OLD_TAGS=$(echo $TAGS_JSON | jq -r --arg THRESHOLD "$THRESHOLD_DATE" '
        .results[] | select(.name != "latest") | select(.name | startswith("v") | not) | 
        select(.last_updated < $THRESHOLD) | .name')
      for TAG in $OLD_TAGS; do
        echo "Deleting expired tag: $TAG"
        curl -s -X DELETE -H "Authorization: JWT $TOKEN" "https://hub.docker.com/v2/repositories/$DOCKERHUB_REPO/tags/$TAG/"
      done