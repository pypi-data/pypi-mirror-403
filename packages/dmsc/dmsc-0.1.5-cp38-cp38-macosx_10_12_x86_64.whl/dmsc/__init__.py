#!/usr/bin/env python3

# Copyright Â© 2025-2026 Wenze Wei. All Rights Reserved.
#
# This file is part of DMSC.
# The DMSC project belongs to the Dunimd Team.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""
DMSC (Dunimd Middleware Service) - A high-performance Rust middleware framework with modular architecture.

This Python library provides bindings to the DMSC Rust core, enabling Python applications to leverage
a comprehensive set of middleware services including caching, messaging, service mesh, authentication,
device management, observability, protocol handling, and database integration. The framework follows
a plugin-based architecture where each module provides specialized functionality that can be composed
into unified middleware solutions.

Key Components:
- Core Framework: Application lifecycle management, configuration, logging, and filesystem abstraction
- Python Module Support: Native integration for Python-based service modules
- Infrastructure Services: Caching, queuing, and database connectivity
- Traffic Management: Gateway routing, rate limiting, and circuit breaker patterns
- Service Mesh: Service discovery, load balancing, and traffic routing
- Security: Authentication, authorization, and session management
- Device Management: IoT device control and resource allocation
- Observability: Metrics collection, tracing, and health monitoring
- Protocol Support: Multi-protocol connection handling and frame processing
- Data Validation: Schema validation, sanitization, and error reporting

Example Usage:
    from dmsc import DMSCAppBuilder, DMSCCacheModule, DMSCGateway
    
    app = (DMSCAppBuilder()
        .with_config("config.yaml")
        .with_logging(DMSCLogConfig())
        .build())
    cache = DMSCCacheModule()
    gateway = DMSCGateway()
"""

__version__ = "0.1.5"
__author__ = "Dunimd Team"
__license__ = "Apache-2.0"

# Import the Rust extension module containing all DMSC bindings
# The dmsc extension is generated by PyO3 and provides zero-overhead access to Rust implementations
from .dmsc import (
    # =============================================================================
    # Core classes - Fundamental framework components for application lifecycle,
    # configuration management, logging, hooks, and service context management
    # =============================================================================
    DMSCAppRuntime, DMSCConfig, DMSCConfigManager, DMSCError,
    DMSCFileSystem, DMSCHookBus, DMSCHookEvent, DMSCHookKind, DMSCLogConfig,
    DMSCLogLevel, DMSCLogger, DMSCModulePhase, DMSCServiceContext,
    
    # =============================================================================
    # Lock utilities - Safe lock utilities for concurrent programming
    # Note: DMSCLockResult is a type alias, not a pyclass
    # =============================================================================
    DMSCLockError,
    
    # =============================================================================
    # Python module support - Enables Python-based service modules to integrate
    # with the DMSC framework, supporting both synchronous and asynchronous service patterns
    # =============================================================================
    DMSCPythonModule, DMSCPythonModuleAdapter, DMSCPythonServiceModule, DMSCPythonAsyncServiceModule,
    
    # =============================================================================
    # Health check types - Health monitoring for services and modules
    # =============================================================================
    DMSCHealthStatus, DMSCHealthCheckResult, DMSCHealthCheckConfig, DMSCHealthReport,
    
    # =============================================================================
    # Lifecycle management - Module lifecycle observation
    # =============================================================================
    DMSCLifecycleObserver,
    
    # =============================================================================
    # Cache classes - In-memory caching with configurable backends, eviction policies,
    # statistics tracking, and event notification capabilities
    # =============================================================================
    DMSCCacheModule, DMSCCacheManager, DMSCCacheConfig, DMSCCacheBackendType,
    DMSCCachePolicy, DMSCCacheStats, DMSCCachedValue, DMSCCacheEvent,
    
    # =============================================================================
    # Queue classes - Message queuing with multiple backend support, retry policies,
    # dead letter handling, and queue statistics monitoring
    # =============================================================================
    DMSCQueueModule, DMSCQueueConfig, DMSCQueueManager, DMSCQueueMessage, 
    DMSCQueueStats, DMSCQueueBackendType, DMSCRetryPolicy, DMSCDeadLetterConfig,
    
    # =============================================================================
    # Gateway classes - Traffic management including HTTP routing, rate limiting,
    # circuit breaker patterns, and sliding window algorithms for distributed systems
    # =============================================================================
    DMSCGateway, DMSCGatewayConfig, DMSCRouter, DMSCRoute,
    DMSCRateLimiter, DMSCRateLimitConfig, RateLimitStats,
    DMSCSlidingWindowRateLimiter, DMSCCircuitBreaker, DMSCCircuitBreakerConfig,
    DMSCCircuitBreakerState, CircuitBreakerMetrics,
    DMSCBackendServer, LoadBalancerServerStats,
    
    # =============================================================================
    # Service mesh classes - Service discovery, traffic routing, load balancing,
    # weighted destinations, and traffic splitting for microservices architecture
    # =============================================================================
    DMSCServiceMesh, DMSCServiceMeshConfig, DMSCServiceDiscovery,
    DMSCServiceInstance, DMSCServiceStatus, DMSCServiceMeshStats,
    DMSCTrafficRoute, DMSCMatchCriteria, DMSCRouteAction, DMSCWeightedDestination,
    DMSCTrafficManager, DMSCHealthChecker,
    
    # =============================================================================
    # Auth classes - Authentication and authorization including JWT management,
    # session handling, OAuth integration, role-based and permission-based access control
    # =============================================================================
    DMSCAuthModule, DMSCAuthConfig, DMSCJWTManager, DMSCJWTClaims, DMSCJWTValidationOptions,
    DMSCSessionManager, DMSCSession, DMSCPermissionManager, DMSCPermission, DMSCRole,
    DMSCOAuthManager, DMSCOAuthToken, DMSCOAuthUserInfo, DMSCOAuthProvider,
    DMSCJWTRevocationList, DMSCRevokedTokenInfo,
    
    # =============================================================================
    # Device classes - IoT device management including device control, health monitoring,
    # resource allocation, connection pooling, and network device discovery
    # =============================================================================
    DMSCDeviceControlModule, DMSCDevice, DMSCDeviceType, DMSCDeviceStatus,
    DMSCDeviceCapabilities, DMSCDeviceHealthMetrics, DMSCDeviceController,
    DMSCDeviceConfig, DMSCDeviceControlConfig, DMSCDeviceSchedulingConfig, NetworkDeviceInfo,
    DMSCDiscoveryResult, DMSCResourceRequest,
    DMSCResourceAllocation, DMSCRequestSlaClass, DMSCResourceWeights,
    DMSCAffinityRules,
    DMSCResourcePool, DMSCResourcePoolConfig, DMSCResourcePoolStatistics, DMSCResourcePoolManager,
    DMSCConnectionPoolStatistics,
    DMSCResourceScheduler, DMSCDeviceScheduler, DMSCSchedulingPolicy,
    DMSCAllocationRecord, DMSCAllocationRequest, DMSCAllocationStatistics,
    DMSCDeviceTypeStatistics, DMSCSchedulingRecommendation, DMSCSchedulingRecommendationType,
    
    # =============================================================================
    # Observability classes - Metrics, tracing, and health monitoring for system
    # observability and performance analysis
    # =============================================================================
    DMSCObservabilityModule, DMSCObservabilityConfig,
    DMSCMetricsRegistry, DMSCTracer,
    DMSCMetricType, DMSCMetricConfig, DMSCMetricSample, DMSCMetric,
    DMSCObservabilityData,
    
    # =============================================================================
    # Validation classes - Data validation, schema validation, sanitization,
    # and validation result reporting with configurable severity levels
    # =============================================================================
    DMSCValidationError, DMSCValidationResult, DMSCValidationSeverity,
    DMSCValidatorBuilder, DMSCValidationRunner, DMSCSanitizer,
    DMSCSanitizationConfig, DMSCSchemaValidator, DMSCValidationModule,
    
    # =============================================================================
    # Protocol classes - Multi-protocol support including connection management,
    # frame processing, security levels, and protocol statistics monitoring
    # =============================================================================
    DMSCProtocolManager, DMSCProtocolType, DMSCProtocolConfig,
    DMSCProtocolStatus, DMSCProtocolStats, DMSCConnectionState,
    DMSCConnectionStats, DMSCProtocolHealth,
    DMSCFrame, DMSCFrameHeader, DMSCFrameType,
    DMSCConnectionInfo, DMSCMessageFlags, DMSCSecurityLevel,
    DMSCFrameParser, DMSCFrameBuilder,
    
    # =============================================================================
    # Database classes - Database configuration, connection pooling, row-level
    # access, and result set management across different database backends
    # =============================================================================
    DMSCDatabaseConfig, DMSCDatabasePool, DMSCDBRow, DMSCDBResult, DatabaseType,
    ColumnDefinition, IndexDefinition, ForeignKeyDefinition,
    TableDefinition, LogicalOperator, Criteria, JoinClause,
    ComparisonOperator, SortOrder, Pagination, QueryBuilder, JoinType,
)

# =============================================================================
# Submodules - Functional submodules organized by domain area, providing
# specialized functionality for specific middleware concerns
# =============================================================================
from .dmsc import (
    device, cache, fs, hooks, observability,
    queue, gateway, service_mesh, auth, protocol, database
)

# =============================================================================
# __all__ export list - Public API surface defining all symbols intended for
# external use. These symbols are imported when 'from dmsc import *' is used.
# Organized by functional category for clarity and maintainability.
# =============================================================================
__all__ = [
    # Core classes - Application framework, configuration, logging, and hooks
    'DMSCAppRuntime', 'DMSCConfig', 'DMSCConfigManager', 'DMSCError',
    'DMSCFileSystem', 'DMSCHookBus', 'DMSCHookEvent', 'DMSCHookKind', 'DMSCLogConfig',
    'DMSCLogLevel', 'DMSCLogger', 'DMSCModulePhase', 'DMSCServiceContext',
    
    # Lock utilities - Safe lock utilities for concurrent programming
    'DMSCLockError',
    
    # Python module support - Python service module integration
    'DMSCPythonModule', 'DMSCPythonModuleAdapter', 'DMSCPythonServiceModule', 'DMSCPythonAsyncServiceModule',
    
    # Health check types - Health monitoring for services and modules
    'DMSCHealthStatus', 'DMSCHealthCheckResult', 'DMSCHealthCheckConfig', 'DMSCHealthReport',
    
    # Lifecycle management - Module lifecycle observation
    'DMSCLifecycleObserver',
    
    # Cache classes - Caching infrastructure and management
    'DMSCCacheModule', 'DMSCCacheManager', 'DMSCCacheConfig', 'DMSCCacheBackendType',
    'DMSCCachePolicy', 'DMSCCacheStats', 'DMSCCachedValue', 'DMSCCacheEvent',
    
    # Queue classes - Message queuing infrastructure
    'DMSCQueueModule', 'DMSCQueueConfig', 'DMSCQueueManager', 'DMSCQueueMessage', 
    'DMSCQueueStats', 'DMSCQueueBackendType', 'DMSCRetryPolicy', 'DMSCDeadLetterConfig',
    
    # Gateway classes - Traffic management and resilience patterns
    'DMSCGateway', 'DMSCGatewayConfig', 'DMSCRouter', 'DMSCRoute',
    'DMSCRateLimiter', 'DMSCRateLimitConfig', 'RateLimitStats',
    'DMSCSlidingWindowRateLimiter', 'DMSCCircuitBreaker', 'DMSCCircuitBreakerConfig',
    'DMSCCircuitBreakerState', 'CircuitBreakerMetrics',
    'DMSCBackendServer', 'LoadBalancerServerStats',
    
    # Service mesh classes - Service discovery and traffic routing
    'DMSCServiceMesh', 'DMSCServiceMeshConfig', 'DMSCServiceDiscovery',
    'DMSCServiceInstance', 'DMSCServiceStatus', 'DMSCServiceMeshStats',
    'DMSCTrafficRoute', 'DMSCMatchCriteria', 'DMSCRouteAction', 'DMSCWeightedDestination',
    'DMSCTrafficManager', 'DMSCHealthChecker',
    
    # Auth classes - Authentication, authorization, and session management
    'DMSCAuthModule', 'DMSCAuthConfig', 'DMSCJWTManager', 'DMSCJWTClaims', 'DMSCJWTValidationOptions',
    'DMSCSessionManager', 'DMSCSession', 'DMSCPermissionManager', 'DMSCPermission', 'DMSCRole',
    'DMSCOAuthManager', 'DMSCOAuthToken', 'DMSCOAuthUserInfo', 'DMSCOAuthProvider',
    'DMSCJWTRevocationList', 'DMSCRevokedTokenInfo',
    
    # Device classes - IoT device control and resource management
    'DMSCDeviceControlModule', 'DMSCDevice', 'DMSCDeviceType', 'DMSCDeviceStatus',
    'DMSCDeviceCapabilities', 'DMSCDeviceHealthMetrics', 'DMSCDeviceController',
    'DMSCDeviceConfig', 'DMSCDeviceControlConfig', 'DMSCDeviceSchedulingConfig', 'NetworkDeviceInfo',
    'DMSCDiscoveryResult', 'DMSCResourceRequest',
    'DMSCResourceAllocation', 'DMSCRequestSlaClass', 'DMSCResourceWeights',
    'DMSCAffinityRules',
    'DMSCResourcePool', 'DMSCResourcePoolConfig', 'DMSCResourcePoolStatistics', 'DMSCResourcePoolManager',
    'DMSCConnectionPoolStatistics',
    'DMSCResourceScheduler', 'DMSCDeviceScheduler', 'DMSCSchedulingPolicy',
    'DMSCAllocationRecord', 'DMSCAllocationRequest', 'DMSCAllocationStatistics',
    'DMSCDeviceTypeStatistics', 'DMSCSchedulingRecommendation', 'DMSCSchedulingRecommendationType',
    
    # Observability classes - Metrics, tracing, and health monitoring
    'DMSCObservabilityModule', 'DMSCObservabilityConfig',
    'DMSCMetricsRegistry', 'DMSCTracer',
    'DMSCMetricType', 'DMSCMetricConfig', 'DMSCMetricSample', 'DMSCMetric',
    'DMSCObservabilityData',
    
    # Validation classes - Data validation and sanitization
    'DMSCValidationError', 'DMSCValidationResult', 'DMSCValidationSeverity',
    'DMSCValidatorBuilder', 'DMSCValidationRunner', 'DMSCSanitizer',
    'DMSCSanitizationConfig', 'DMSCSchemaValidator', 'DMSCValidationModule',
    
    # Protocol classes - Protocol management and connection handling
    'DMSCProtocolManager', 'DMSCProtocolType', 'DMSCProtocolConfig',
    'DMSCProtocolStatus', 'DMSCProtocolStats', 'DMSCConnectionState',
    'DMSCConnectionStats', 'DMSCProtocolHealth',
    'DMSCFrame', 'DMSCFrameHeader', 'DMSCFrameType',
    'DMSCConnectionInfo', 'DMSCMessageFlags', 'DMSCSecurityLevel',
    'DMSCFrameParser', 'DMSCFrameBuilder',
    
    # Database classes - Database configuration and connection pooling
    'DMSCDatabaseConfig', 'DMSCDatabasePool', 'DMSCDBRow', 'DMSCDBResult', 'DatabaseType',
    'ColumnDefinition', 'IndexDefinition', 'ForeignKeyDefinition',
    'TableDefinition', 'LogicalOperator', 'Criteria', 'JoinClause',
    'ComparisonOperator', 'SortOrder', 'Pagination', 'QueryBuilder', 'JoinType',
    
    # Submodules - Functional submodule references
    'device', 'cache', 'fs', 'hooks', 'observability',
    'queue', 'gateway', 'service_mesh', 'auth', 'protocol', 'database'
]


class DMSCAppBuilder:
    """
    Fluent API builder for DMSC applications.
    
    This class provides a Python-friendly chainable interface for building
    DMSC applications. All configuration methods return `self` to enable
    fluent-style method chaining.
    
    Example:
        app = (DMSCAppBuilder()
            .with_config("config.yaml")
            .with_logging(DMSCLogConfig())
            .build())
    """
    
    def __init__(self):
        from .dmsc import DMSCAppBuilder as RustBuilder
        self._builder = RustBuilder()
    
    def with_config(self, config_path: str) -> 'DMSCAppBuilder':
        """Add a configuration file path."""
        self._builder.py_with_config(config_path)
        return self
    
    def with_logging(self, log_config) -> 'DMSCAppBuilder':
        """Add logging configuration."""
        self._builder.py_with_logging(log_config)
        return self
    
    def with_observability(self, observability_config) -> 'DMSCAppBuilder':
        """Add observability configuration."""
        self._builder.py_with_observability(observability_config)
        return self
    
    def with_module(self, module) -> 'DMSCAppBuilder':
        """Add a synchronous Python service module."""
        self._builder.py_with_module(module)
        return self
    
    def with_python_module(self, module) -> 'DMSCAppBuilder':
        """Add a Python module adapter."""
        self._builder.py_with_python_module(module)
        return self
    
    def with_async_module(self, module) -> 'DMSCAppBuilder':
        """Add an asynchronous Python service module."""
        self._builder.py_with_async_module(module)
        return self
    
    def with_dms_module(self, module) -> 'DMSCAppBuilder':
        """Add a DMSC module adapter."""
        self._builder.py_with_dms_module(module)
        return self
    
    def with_modules(self, modules: list) -> 'DMSCAppBuilder':
        """Add multiple synchronous Python service modules."""
        self._builder.py_with_modules(modules)
        return self
    
    def with_async_modules(self, modules: list) -> 'DMSCAppBuilder':
        """Add multiple asynchronous Python service modules."""
        self._builder.py_with_async_modules(modules)
        return self
    
    def with_dms_modules(self, modules: list) -> 'DMSCAppBuilder':
        """Add multiple DMSC module adapters."""
        self._builder.py_with_dms_modules(modules)
        return self
    
    def build(self):
        """Build and return the DMSC application runtime."""
        return DMSCAppRuntime(self._builder.py_build())
    
    def run(self, callback=None):
        """Run the application with an optional callback."""
        runtime = self.build()
        runtime.run(callback)


class DMSCAppRuntime:
    """
    DMSC Application Runtime.
    
    This class provides the runtime for executing a DMSC application.
    It wraps the Rust implementation and provides a Python-friendly interface.
    """
    
    def __init__(self, runtime):
        self._runtime = runtime
    
    def run(self, callback=None):
        """Run the application with an optional callback."""
        if callback:
            self._runtime.py_run(callback)
        else:
            self._runtime.py_run(lambda ctx: None)
    
    def get_context(self):
        """Get the service context."""
        return self._runtime.get_context()


__all__.extend(['DMSCAppBuilder', 'DMSCAppRuntime'])
