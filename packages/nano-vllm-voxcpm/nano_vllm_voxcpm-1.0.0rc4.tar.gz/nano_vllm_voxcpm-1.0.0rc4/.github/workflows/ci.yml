name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  lint-cpu:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true
          activate-environment: true

      # The project declares GPU-centric dependencies (e.g. flash-attn). Unit tests
      # include shims so we can run a CPU-only import/test pass in CI.
      - name: Install project (no deps)
        run: uv pip install -e . --no-deps

      - name: Install test deps
        run: uv pip install -U pytest pytest-cov black ruff mypy

      - name: Install CPU torch (best effort)
        run: |
          uv pip install \
            --index-url https://pypi.org/simple \
            --extra-index-url https://download.pytorch.org/whl/cpu \
            "torch!=2.6.*,>=2.5.0" || true

      - name: Syntax check
        # Keep lint on `uv run`, but avoid syncing GPU deps (e.g. flash-attn).
        run: uv run --no-sync python -m compileall nanovllm_voxcpm deployment tests

      - name: Lint (ruff)
        # Keep the initial CI gate focused on real defects (syntax/undefined names).
        run: uv run --no-sync ruff check . --select F,E9

      - name: Format (black)
        run: uv run --no-sync black --check .

      - name: Type check (mypy)
        # CI is CPU-only; many GPU/optional deps don't ship stubs.
        run: uv run --no-sync mypy nanovllm_voxcpm deployment --ignore-missing-imports



  # CUDA user-space (no GPU) test matrix.
  #
  # Notes:
  # - GitHub-hosted runners do not provide GPUs. We run inside a CUDA "devel"
  #   container and use CUDA driver API stubs so CUDA extensions can import.
  # - We install PyTorch CUDA wheels from the PyTorch index, plus flash-attn.
  test-cuda-no-gpu:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # torchcodec must match torch 1:1 (see upstream compatibility table).
          # We keep Python at 3.11 here to minimize wheel-matrix variance.
          #
          # CUDA coverage:
          # - torch 2.5 runs on CUDA 12.4
          # - torch 2.7-2.9 run on CUDA 12.6
          # - torch 2.9-2.10 run on CUDA 13.0
          - python-version: "3.11"
            torch-version: "2.5"
            torchaudio-version: "2.5"
            torchcodec-version: "0.1"
            cuda-image: "12.4.1-devel-ubuntu20.04"
            torch-extra-index: "https://download.pytorch.org/whl/cu124"

          - python-version: "3.11"
            torch-version: "2.7"
            torchaudio-version: "2.7"
            torchcodec-version: "0.5"
            cuda-image: "12.6.3-cudnn-devel-ubuntu22.04"
            torch-extra-index: "https://download.pytorch.org/whl/cu126"

          - python-version: "3.11"
            torch-version: "2.8"
            torchaudio-version: "2.8"
            torchcodec-version: "0.7"
            cuda-image: "12.6.3-cudnn-devel-ubuntu22.04"
            torch-extra-index: "https://download.pytorch.org/whl/cu126"

          - python-version: "3.12"
            torch-version: "2.9"
            torchaudio-version: "2.9"
            torchcodec-version: "0.9"
            cuda-image: "12.6.3-cudnn-devel-ubuntu22.04"
            torch-extra-index: "https://download.pytorch.org/whl/cu126"

          - python-version: "3.12"
            torch-version: "2.9"
            torchaudio-version: "2.9"
            torchcodec-version: "0.9"
            cuda-image: "13.0.2-devel-ubuntu24.04"
            torch-extra-index: "https://download.pytorch.org/whl/cu130"

          - python-version: "3.12"
            torch-version: "2.10"
            torchaudio-version: "2.10"
            torchcodec-version: "0.10"
            cuda-image: "13.0.2-devel-ubuntu24.04"
            torch-extra-index: "https://download.pytorch.org/whl/cu130"

    container:
      image: nvidia/cuda:${{ matrix.cuda-image }}

    env:
      # No GPU is attached; keep CUDA paths importable.
      CUDA_VISIBLE_DEVICES: ""
      LD_LIBRARY_PATH: /usr/local/cuda/lib64/stubs:/usr/local/cuda/lib64
      # Ensure flash-attn install behaves consistently in CI.
      FLASH_ATTENTION_SKIP_CUDA_BUILD: "TRUE"
      FLASH_ATTENTION_FORCE_BUILD: "TRUE"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true
          activate-environment: true

      - name: Install system deps (audio + build)
        run: |
          apt-get update
          # Ubuntu 20.04 images may prompt for tzdata timezone selection.
          DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC apt-get install -y --no-install-recommends \
            tzdata \
            build-essential \
            ca-certificates \
            curl \
            ffmpeg \
            libsndfile1 \
            ninja-build \
            pkg-config
          rm -rf /var/lib/apt/lists/*

      - name: Pin torch stack (uv add)
        # Override torch/torchaudio/torchcodec versions for this matrix entry.
        # This updates pyproject.toml and generates/updates uv.lock within the CI workspace.
        run: |
          uv add --no-sync \
            --index ${{ matrix.torch-extra-index }} \
            --default-index https://pypi.org/simple \
            "torch==${{ matrix.torch-version }}" \
            "torchaudio==${{ matrix.torchaudio-version }}" \
            "torchcodec==${{ matrix.torchcodec-version }}"

      - name: Install flash-attn build deps
        # flash-attn may build from source; ensure common build-time imports exist.
        run: uv pip install -U setuptools wheel psutil

      - name: Sync workspace deps
        # Install all workspace deps based on the (possibly updated) lockfile.
        run: |
          uv sync \
            --all-packages \
            --group dev \
            --index ${{ matrix.torch-extra-index }} \
            --default-index https://pypi.org/simple

      - name: Run tests
        run: uv run --no-sync pytest -q
