(()=>{"use strict";var e=function(e,t,n,a){return new(n||(n=Promise))(function(i,o){function r(e){try{d(a.next(e))}catch(e){o(e)}}function s(e){try{d(a.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,s)}d((a=a.apply(e,t||[])).next())})};class t{constructor(){this.init=()=>e(this,void 0,void 0,function*(){this.available=yield this.connect()}),this.handleMessage=e=>{const[t,n]=JSON.parse(e.data),a=n.json,i=this.pendingRequests.get(t);a.flags.reload&&window.location.reload(),i.resolve(a),this.pendingRequests.delete(n)},this.connect=()=>new Promise(e=>{this.websocket=new WebSocket(window.location+""),this.websocket.addEventListener("message",this.handleMessage),this.websocket.addEventListener("open",()=>{this.messageIdCounter=1,this.pendingRequests=new Map,e(!0)}),this.websocket.addEventListener("error",t=>{e(!1)})}),this.sendMutationRequest=t=>e(this,void 0,void 0,function*(){return new Promise((n,a)=>e(this,void 0,void 0,function*(){this.websocket.readyState!==this.websocket.OPEN&&(yield this.connect());const e={requestType:"falk/mutation",nodeId:t.nodeId,token:t.token,callbackName:t.callbackName,callbackArgs:t.callbackArgs,event:t.eventData.eventData},i=this.messageIdCounter,o=JSON.stringify([i,e]);this.messageIdCounter+=1,this.websocket.send(o),this.pendingRequests.set(i,{resolve:n,reject:a})}))})}}var n=function(e,t,n,a){return new(n||(n=Promise))(function(i,o){function r(e){try{d(a.next(e))}catch(e){o(e)}}function s(e){try{d(a.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,s)}d((a=a.apply(e,t||[])).next())})};class a{constructor(){this.headers={"Content-Type":"application/json","X-Falk-Request-Type":"mutation"},this.setHeader=(e,t)=>{this.headers[e]=t},this.sendMutationRequest=e=>n(this,void 0,void 0,function*(){return new Promise((t,a)=>n(this,void 0,void 0,function*(){const n={requestType:"falk/mutation",nodeId:e.nodeId,token:e.token,callbackName:e.callbackName,callbackArgs:e.callbackArgs,event:e.eventData.eventData},i=yield fetch(window.location+"",{method:"POST",headers:this.headers,body:JSON.stringify(n),redirect:"manual"});i.ok||a(`HTTP error! Status: ${i.status}`);const o=yield i.json();o.flags.reload&&window.location.reload(),t(o)}))}),this.sendMultipartMutationRequest=e=>n(this,void 0,void 0,function*(){return new Promise((t,a)=>n(this,void 0,void 0,function*(){const n=new FormData,i={requestType:"falk/mutation",nodeId:e.nodeId,token:e.token,callbackName:e.callbackName,callbackArgs:e.callbackArgs,event:e.eventData.eventData};n.append("falk/mutation",JSON.stringify(i));for(const{key:t,file:a}of e.eventData.files)n.append(t,a);const o=yield fetch(window.location+"",{method:"POST",headers:{"X-Falk-Request-Type":"mutation","X-Falk-Upload-Token":e.eventData.uploadToken},body:n,redirect:"manual"});o.ok||a(`HTTP error! Status: ${o.status}`);const r=yield o.json();r.flags.reload&&window.location.reload(),t(r)}))})}}const i=e=>{const t={eventData:{type:"",data:void 0,form_data:{}},uploadToken:"",files:[]};if(!e)return t;if(t.eventData.type=e.type,"input"==e.type||"change"==e.type||"submit"==e.type)if(e.currentTarget instanceof HTMLFormElement){const n=new FormData(e.currentTarget);for(const[e,a]of n.entries())"string"!=typeof e||"falk/upload-token"!=e?a instanceof File?a.size>0&&t.files.push({key:e,file:a}):t.eventData.form_data[e]=a:t.uploadToken=a}else{const n=e.currentTarget;if(t.eventData.data=n.value,n.hasAttribute("name")){const e=n.getAttribute("name");e&&(t.eventData.form_data[e]=n.value)}}return t};var o;var r="undefined"==typeof document?void 0:document,s=!!r&&"content"in r.createElement("template"),d=!!r&&r.createRange&&"createContextualFragment"in r.createRange();function l(e){return e=e.trim(),s?function(e){var t=r.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}(e):d?function(e){return o||(o=r.createRange()).selectNode(r.body),o.createContextualFragment(e).childNodes[0]}(e):function(e){var t=r.createElement("body");return t.innerHTML=e,t.childNodes[0]}(e)}function c(e,t){var n,a,i=e.nodeName,o=t.nodeName;return i===o||(n=i.charCodeAt(0),a=o.charCodeAt(0),n<=90&&a>=97?i===o.toUpperCase():a<=90&&n>=97&&o===i.toUpperCase())}function u(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var f={OPTION:function(e,t){var n=e.parentNode;if(n){var a=n.nodeName.toUpperCase();"OPTGROUP"===a&&(a=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==a||n.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),n.selectedIndex=-1)}u(e,t,"selected")},INPUT:function(e,t){u(e,t,"checked"),u(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var a=e.firstChild;if(a){var i=a.nodeValue;if(i==n||!n&&i==e.placeholder)return;a.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n,a,i=-1,o=0,r=e.firstChild;r;)if("OPTGROUP"===(a=r.nodeName&&r.nodeName.toUpperCase()))(r=(n=r).firstChild)||(r=n.nextSibling,n=null);else{if("OPTION"===a){if(r.hasAttribute("selected")){i=o;break}o++}!(r=r.nextSibling)&&n&&(r=n.nextSibling,n=null)}e.selectedIndex=i}}};function h(){}function v(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}var p=function(e){return function(t,n,a){if(a||(a={}),"string"==typeof n)if("#document"===t.nodeName||"HTML"===t.nodeName||"BODY"===t.nodeName){var i=n;(n=r.createElement("html")).innerHTML=i}else n=l(n);else 11===n.nodeType&&(n=n.firstElementChild);var o=a.getNodeKey||v,s=a.onBeforeNodeAdded||h,d=a.onNodeAdded||h,u=a.onBeforeElUpdated||h,p=a.onElUpdated||h,m=a.onBeforeNodeDiscarded||h,b=a.onNodeDiscarded||h,y=a.onBeforeElChildrenUpdated||h,k=a.skipFromChildren||h,g=a.addChild||function(e,t){return e.appendChild(t)},N=!0===a.childrenOnly,T=Object.create(null),E=[];function w(e){E.push(e)}function A(e,t){if(1===e.nodeType)for(var n=e.firstChild;n;){var a=void 0;t&&(a=o(n))?w(a):(b(n),n.firstChild&&A(n,t)),n=n.nextSibling}}function S(e,t,n){!1!==m(e)&&(t&&t.removeChild(e),b(e),A(e,n))}function C(e){if(1===e.nodeType||11===e.nodeType)for(var t=e.firstChild;t;){var n=o(t);n&&(T[n]=t),C(t),t=t.nextSibling}}function I(e){d(e);for(var t=e.firstChild;t;){var n=t.nextSibling,a=o(t);if(a){var i=T[a];i&&c(t,i)?(t.parentNode.replaceChild(i,t),R(i,t)):I(t)}else I(t);t=n}}function R(t,n,a){var i=o(n);if(i&&delete T[i],!a){var d=u(t,n);if(!1===d)return;if(d instanceof HTMLElement&&C(t=d),e(t,n),p(t),!1===y(t,n))return}"TEXTAREA"!==t.nodeName?function(e,t){var n,a,i,d,l,u=k(e,t),h=t.firstChild,v=e.firstChild;e:for(;h;){for(d=h.nextSibling,n=o(h);!u&&v;){if(i=v.nextSibling,h.isSameNode&&h.isSameNode(v)){h=d,v=i;continue e}a=o(v);var p=v.nodeType,m=void 0;if(p===h.nodeType&&(1===p?(n?n!==a&&((l=T[n])?i===l?m=!1:(e.insertBefore(l,v),a?w(a):S(v,e,!0),a=o(v=l)):m=!1):a&&(m=!1),(m=!1!==m&&c(v,h))&&R(v,h)):3!==p&&8!=p||(m=!0,v.nodeValue!==h.nodeValue&&(v.nodeValue=h.nodeValue))),m){h=d,v=i;continue e}a?w(a):S(v,e,!0),v=i}if(n&&(l=T[n])&&c(l,h))u||g(e,l),R(l,h);else{var b=s(h);!1!==b&&(b&&(h=b),h.actualize&&(h=h.actualize(e.ownerDocument||r)),g(e,h),I(h))}h=d,v=i}!function(e,t,n){for(;t;){var a=t.nextSibling;(n=o(t))?w(n):S(t,e,!0),t=a}}(e,v,a);var y=f[e.nodeName];y&&y(e,t)}(t,n):f.TEXTAREA(t,n)}C(t);var D,L,x=t,M=x.nodeType,P=n.nodeType;if(!N)if(1===M)1===P?c(t,n)||(b(t),x=function(e,t){for(var n=e.firstChild;n;){var a=n.nextSibling;t.appendChild(n),n=a}return t}(t,(D=n.nodeName,(L=n.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==L?r.createElementNS(L,D):r.createElement(D)))):x=n;else if(3===M||8===M){if(P===M)return x.nodeValue!==n.nodeValue&&(x.nodeValue=n.nodeValue),x;x=n}if(x===n)b(t);else{if(n.isSameNode&&n.isSameNode(x))return;if(R(x,n,N),E)for(var q=0,O=E.length;q<O;q++){var U=T[E[q]];U&&S(U,U.parentNode,!1)}}return!N&&x!==t&&t.parentNode&&(x.actualize&&(x=x.actualize(t.ownerDocument||r)),t.parentNode.replaceChild(x,t)),x}}(function(e,t){var n,a,i,o,r=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var s=r.length-1;s>=0;s--)a=(n=r[s]).name,i=n.namespaceURI,o=n.value,i?(a=n.localName||a,e.getAttributeNS(i,a)!==o&&("xmlns"===n.prefix&&(a=n.name),e.setAttributeNS(i,a,o))):e.getAttribute(a)!==o&&e.setAttribute(a,o);for(var d=e.attributes,l=d.length-1;l>=0;l--)a=(n=d[l]).name,(i=n.namespaceURI)?(a=n.localName||a,t.hasAttributeNS(i,a)||e.removeAttributeNS(i,a)):t.hasAttribute(a)||e.removeAttribute(a)}});const m=p;var b=function(e,t,n,a){return new(n||(n=Promise))(function(i,o){function r(e){try{d(a.next(e))}catch(e){o(e)}}function s(e){try{d(a.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,s)}d((a=a.apply(e,t||[])).next())})};window.falk=new class{constructor(){this.init=()=>b(this,void 0,void 0,function*(){this.httpTransport=new a,this.websocketTransport=new t;const e=()=>b(this,void 0,void 0,function*(){this.dispatchEvent("beforeinit",document.querySelector("html")),yield this.websocketTransport.init(),this.dispatchRenderEvents(document.body,{initial:!0})});"complete"===document.readyState?yield e():window.addEventListener("load",()=>b(this,void 0,void 0,function*(){yield e()}))}),this.parseDelay=e=>{if("number"==typeof e)return 1e3*e;const t=/^(\d+(?:\.\d+)?)(ms|s|m|h)?$/.exec(e.trim());if(!t)throw new Error("Invalid time format: "+e);const n=parseFloat(t[1]),a=t[2]||"s";if("ms"===a)return n;if("s"===a)return 1e3*n;if("m"===a)return 60*n*1e3;if("h"===a)return 60*n*60*1e3;throw new Error("Unknown unit: "+a)},this.iterNodes=(e,t,n=document.body)=>{n.nodeType===Node.ELEMENT_NODE&&(Array.from(n.children).forEach(n=>{this.iterNodes(e,t,n)}),n.matches(e)&&t(n))},this.dispatchEvent=(e,t)=>{const n=`on${e}`,a=`falk:${e}`,i=t.getAttribute(n),o=new Function("event",i),r=new CustomEvent(a,{bubbles:!0,cancelable:!0});try{o.call(t,r)}catch(e){console.error(e)}t.dispatchEvent(r)},this.dispatchRenderEvents=(e=document.body,t={initial:!1})=>{this.iterNodes("[data-falk-id]",n=>{(t.initial||n!=e)&&this.dispatchEvent("initialrender",n),this.dispatchEvent("render",n)},e)},this.patchNode=(e,t,n,a)=>{const i=e=>!a.forceRendering&&(!!a.skipRendering||e.hasAttribute("data-skip-rerendering"));return m(e,t,{onBeforeNodeAdded:e=>{if(e.nodeType!==Node.ELEMENT_NODE)return e;const t=e.tagName;return!["SCRIPT","LINK","STYLE"].includes(t)&&(i(e),e)},onBeforeNodeDiscarded:e=>{if(e.nodeType!==Node.ELEMENT_NODE)return!0;const t=e.tagName;return!["SCRIPT","LINK","STYLE"].includes(t)&&!i(e)},onBeforeElUpdated:(e,t)=>!i(e)&&(!["SCRIPT","LINK","STYLE"].includes(e.tagName)&&("submit"!=n&&(e instanceof HTMLInputElement&&t instanceof HTMLInputElement||e instanceof HTMLTextAreaElement&&t instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement&&t instanceof HTMLSelectElement)&&(t.value=e.value),!0))})},this.patchNodeAttributes=(e,t)=>m(e,t,{onBeforeElChildrenUpdated:(e,t)=>!1}),this.runCallback=e=>b(this,void 0,void 0,function*(){let t;if(e.optionsString){const t=JSON.parse(decodeURIComponent(e.optionsString));e=Object.assign(e,t)}let n="";if(event&&(n=event.type),e.node)t=[e.node];else if(e.nodeId){const n=document.querySelector(`[data-falk-id=${e.nodeId}]`);if(!n)throw`no node with id ${e.nodeId}`;t=[n]}else e.selector&&(t=Array.from(document.querySelectorAll(e.selector)));for(const a of t){const t=i(e.event),o=a.getAttribute("data-falk-id"),r=a.getAttribute("data-falk-token"),s=e.callbackName||"",d=e.callbackArgs||{};e.event&&e.stopEvent&&(e.event.stopPropagation(),e.event.preventDefault()),setTimeout(()=>b(this,void 0,void 0,function*(){let e;this.dispatchEvent("beforerequest",a),e=t.files.length>0?yield this.httpTransport.sendMultipartMutationRequest({nodeId:o,token:r,callbackName:s,callbackArgs:d,eventData:t}):this.websocketTransport.available?yield this.websocketTransport.sendMutationRequest({nodeId:o,token:r,callbackName:s,callbackArgs:d,eventData:t}):yield this.httpTransport.sendMutationRequest({nodeId:o,token:r,callbackName:s,callbackArgs:d,eventData:t});const i=(new DOMParser).parseFromString(e.body,"text/html");i.head.querySelectorAll("link[rel=stylesheet]").forEach(e=>{let t;const n=e.getAttribute("href");if(n)t=`link[href="${n}"]`;else{t=`link[data-falk-id="${e.getAttribute("data-falk-id")}"]`}document.querySelector(t)||document.head.appendChild(e)});i.head.querySelectorAll("style").forEach(e=>{const t=`style[data-falk-id="${e.getAttribute("data-falk-id")}"]`;document.querySelector(t)||document.head.appendChild(e)});const l=i.body.querySelectorAll("script"),c=new Array;l.forEach(e=>{let t;const n=e.getAttribute("src");if(n)t=`script[src="${n}"]`;else{t=`script[data-falk-id="${e.getAttribute("data-falk-id")}"]`}if(document.querySelector(t))return;const a=document.createElement("script");for(const t of e.attributes)a.setAttribute(t.name,t.value);if(e.src){const e=new Promise(e=>{a.addEventListener("load",()=>{e(null)})});c.push(e)}else a.textContent=e.textContent;document.body.appendChild(a)}),yield Promise.all(c),"HTML"==a.tagName?(this.patchNodeAttributes(a,i.children[0]),document.title=i.title,this.patchNode(document.body,i.body,n,e.flags)):this.patchNode(a,i.body.firstChild,n,e.flags),this.dispatchRenderEvents(a);for(const t of e.callbacks)this.runCallback({selector:t[0],callbackName:t[1],callbackArgs:t[2]})}),this.parseDelay(e.delay||0))}}),this.filterEvents=(e,t)=>n=>{if(n.target.matches(e))return t(n)},this.on=(...e)=>{const t=`falk:${e[0]}`;let n,a;2==e.length?(a=e[1],document.addEventListener(t,a)):3==e.length&&(n=e[1],a=e[2],document.addEventListener(t,this.filterEvents(n,a)))}}},window.falk.init()})();