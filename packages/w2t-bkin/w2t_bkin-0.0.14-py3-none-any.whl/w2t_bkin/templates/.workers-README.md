# W2T-BKIN Worker Configuration

This directory contains configuration for Prefect workers.

## Files

- **`.env`** - Docker image and production settings (manual configuration)
- **`.env.dev`** - Auto-managed development paths (DO NOT EDIT)
- **`README.md`** - This file

## Configuration

### Development Mode (Recommended for Testing)

For local development with `--dev` mode:

```bash
cd /path/to/experiment
w2t-bkin server start --dev
```

**No configuration needed!** The `.env.dev` file is automatically generated and maintained with correct absolute paths for your experiment directory.

### Production Mode (Docker Workers)

Edit `.env` to set the Docker image used for flow execution:

```bash
# Local build (development)
W2T_DOCKER_IMAGE=w2t-bkin:local

# Published release (production)
W2T_DOCKER_IMAGE=ghcr.io/borjaest/w2t-bkin:latest
```

**Important**: This must be the **runner image** (for flow execution), NOT the worker image.

### Volume Mounts

Docker workers automatically mount project directories into containers:

| Host Path (project root)            | Container Path                | Mode | Purpose                   |
| ----------------------------------- | ----------------------------- | ---- | ------------------------- |
| `{project_root}/data`               | `/data`                       | rw   | Raw, interim, and outputs |
| `{project_root}/models`             | `/models`                     | ro   | Pose estimation models    |
| `{project_root}/configuration.toml` | `/configs/configuration.toml` | ro   | Pipeline parameters       |

**Container Paths**:

- Raw data: `/data/raw` (`W2T_RAW_ROOT`)
- Intermediate files: `/data/interim` (`W2T_INTERMEDIATE_ROOT`)
- Final outputs: `/data/processed` (`W2T_OUTPUT_ROOT`)
- Models: `/models` (`W2T_MODELS_ROOT`)

These mounts are configured automatically in the `docker-pool` work pool when you run:

```bash
w2t-bkin server start
```

No manual volume configuration needed!

## Usage

### Start Server (creates work pool with volume mounts)

```bash
cd /path/to/experiment
w2t-bkin server start
```

### Start Worker (in a new terminal)

**Option 1: CLI Worker (Recommended)**

```bash
cd /path/to/experiment
w2t-bkin worker start --pool docker-pool --type docker
```

**Option 2: Containerized Worker**

```bash
docker run --rm --network host \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -e PREFECT_API_URL=http://127.0.0.1:4200/api \
  w2t-bkin-worker:local
```

### Verify Configuration

Check that volume mounts are configured:

```bash
prefect work-pool inspect docker-pool | grep -A 10 volumes
```

Expected output:

```json
"volumes": [
  "/path/to/experiment/data:/data:rw",
  "/path/to/experiment/models:/models:ro",
  "/path/to/experiment/configuration.toml:/configs/configuration.toml:ro"
]
```

## Troubleshooting

### Flow runs fail with "FileNotFoundError"

**Cause**: Work pool doesn't have volume mounts configured.

**Solution**: Delete and recreate the pool:

```bash
prefect work-pool delete docker-pool
w2t-bkin server start
```

### Permission denied when writing to `/output`

**Cause**: Container user (UID 1000) doesn't have write access.

**Solution**: Fix host permissions:

```bash
sudo chown -R 1000:1000 /path/to/experiment/output
# or
chmod -R 777 /path/to/experiment/output
```

### Worker can't pull Docker image

**Cause**: Image not available locally or remotely.

**Solution**: Build locally or pull from registry:

```bash
# Build locally
cd /path/to/w2t-bkin/repo
docker build -f docker/Dockerfile -t w2t-bkin:local .

# Or pull from registry
docker pull ghcr.io/borjaest/w2t-bkin:latest
```

## See Also

- [Docker Volumes and Paths Guide](../../docs/user-guide/docker-volumes-and-paths.md)
- [Docker Quick Start](../../docs/DOCKER_VOLUMES_QUICKSTART.md)
- [Prefect Docker Workers](https://docs.prefect.io/latest/concepts/work-pools/#docker-work-pools)
