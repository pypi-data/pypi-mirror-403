[build-system]
requires = ["flit_core >=3.2,<4"]
build-backend = "flit_core.buildapi"

[project]
name = "w2t-bkin"
version = "0.0.14"
description = "Mouse wiskers body kinematics and behavior"
authors = [{ name = "Larkum Lab" }]
license = { text = "Apache-2.0" }
requires-python = "~=3.10.0"

readme = "README.md"
classifiers = [
    "Programming Language :: Python :: 3",
    "License :: OSI Approved :: Apache Software License",
    "Intended Audience :: Science/Research",
    "Topic :: Scientific/Engineering :: Information Analysis",
]
dependencies = [
    # Lightweight CLI and configuration
    "pydantic~=2.12.0",
    "pydantic-settings~=2.11.0",
    "tomli~=2.3.0",
    "tomli_w~=1.2.0",
    "typer~=0.19.0",
    "rich~=14.2.0",
    # NWB file reading and exploration (includes h5py, numpy as dependencies)
    "pynwb~=3.1.0",
    "hdmf~=4.1.0",
    # Prefect orchestration (server + client)
    "prefect~=3.6.0",
    "prefect-docker~=0.7.0",
    "asyncpg~=0.29.0",
    "scipy~=1.15.0",
    "numpy~=1.26.4",
]

[project.optional-dependencies]
worker = [
    # NWB validation and inspection
    "nwbinspector~=0.6.5",
    # NWB extensions (installed from local submodules, not PyPI)
    "ndx-structured-behavior",
    "ndx-pose",
    "ndx-events",
    # Heavy processing libraries
    # "facemap~=1.0.0",
    # "deeplabcut[tf]~=2.3.0",
    "ffmpeg-python~=0.2.0",
    "pandas~=2.3.0",
    "h5py~=3.15.0",
    "tables~=3.10.0",
    # Diagnostic figure generation
    "matplotlib~=3.8.0",
]
dev = [
    "black~=25.9.0",
    "isort~=7.0.0",
    "pytest~=9.0.0",
    "pytest-cov~=6.0.0",
    "matplotlib~=3.8.0",
    "numpy~=1.26.0",
]


[project.scripts]
w2t-bkin = "w2t_bkin.cli:app"
mat2json = "w2t_bkin.tools.mat2json:main"
pose2ttl = "w2t_bkin.tools.pose2ttl:main"
trials2df = "w2t_bkin.tools.trials2df:main"

[tool.black]
line-length = 180
include = '\.pyi?$'

[tool.isort]
profile = "black"
line_length = 180
known_first_party = ["w2t_bkin"]
force_sort_within_sections = true

[tool.pytest.ini_options]
minversion = "9.0"
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = [
    "-ra",              # Show summary of all test outcomes
    "--strict-markers", # Raise error on unknown markers
    "--strict-config",  # Raise error on config issues
    "--showlocals",     # Show local variables in tracebacks
]
markers = [
    "unit: Fast, isolated unit tests",
    "integration: End-to-end integration tests",
    "slow: Tests that take significant time to run",
    "requires_gpu: Tests requiring GPU hardware",
    "requires_dlc: Tests requiring DeepLabCut",
    "requires_sleap: Tests requiring SLEAP",
]
filterwarnings = [
    "error",
    # Ignore Pydantic V2 migration warnings
    "ignore::pydantic.PydanticDeprecatedSince20",
    # Ignore PyNWB/HDMF warnings
    "ignore::UserWarning:pynwb",
    "ignore::UserWarning:hdmf",
    "ignore::DeprecationWarning:hdmf",
    # Ignore TensorFlow/NumPy warnings
    "ignore::DeprecationWarning:tensorflow",
    "ignore::DeprecationWarning:numpy",
]

[tool.coverage.run]
source = ["src/w2t_bkin"]
omit = ["*/tests/*", "*/test_*.py", "*/__pycache__/*", "*/synthetic/*"]
branch = true
parallel = true

[tool.coverage.report]
precision = 2
show_missing = true
skip_covered = false
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
    "@abstractmethod",
]

[tool.coverage.html]
directory = "htmlcov"
