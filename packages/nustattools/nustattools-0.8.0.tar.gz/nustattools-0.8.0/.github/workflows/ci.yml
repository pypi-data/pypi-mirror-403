name: CI

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main
      - master

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Many color libraries just need this to be set to any value, but at least
  # one distinguishes color depth, where "3" -> "256-bit color".
  FORCE_COLOR: 3

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      test_matrix: ${{ steps.test_versions.outputs.matrix }}
      lint_matrix: ${{ steps.lint_versions.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
          submodules: true
      - uses: actions/setup-python@v6
        with:
          python-version: "3.x"
      - name: Install nox
        run: pip install nox
      - name: Get test Python versions
        id: test_versions
        run: |
          versions=$(nox --list-sessions --json | jq -c '{"python-version": [.[] | select(.name == "tests") | .python]}')
          echo "matrix=$versions" >> $GITHUB_OUTPUT
      - name: Get lint Python versions
        id: lint_versions
        run: |
          versions=$(nox --list-sessions --json | jq -c '{"python-version": [.[] | select(.name == "lint") | .python]}')
          echo "matrix=$versions" >> $GITHUB_OUTPUT

  tests:
    needs: setup
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.test_matrix) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
          submodules: true
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install nox
        run: pip install nox
      - name: Run tests
        run: nox -s tests-${{ matrix.python-version }}

  lint:
    needs: setup
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.lint_matrix) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
          submodules: true
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install nox
        run: pip install nox
      - name: Run lint
        run: nox -s lint
