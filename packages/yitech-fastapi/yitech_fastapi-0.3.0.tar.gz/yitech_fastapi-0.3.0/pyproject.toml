[project]
name = "yitech-fastapi"
version = "0.3.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.12"
dependencies = [
    # 使用本地开发版本的 yitool
    "yitool==0.6.0",
    # 速率限制依赖
    "slowapi==0.1.9",
    "limits==3.11.0",
    # CLI 依赖
    "click",
]

[project.scripts]
yifast = "src.__main__:main"


[dependency-groups]
# 开发依赖
dev = [
    # 测试依赖
    "pytest==9.0.2",
    "pytest-asyncio==1.3.0",
    "httpx==0.28.1",
    # 类型检查依赖
    "mypy==1.19.1",
    # 代码质量依赖
    "ruff==0.6.0",
    # 开发数据库
    "aiosqlite==0.22.1",
    # 监控依赖
    "prometheus-client==0.20.0",
]
# 可选依赖
optional = [
    # 监控依赖
    "prometheus-client==0.20.0",
    # 调试依赖
    "debugpy==1.6.7",
]

# 依赖锁定配置

[tool.ruff]
# 启用更全面的规则集
select = [
    "E",      # 错误
    "F",      # 致命错误
    "W",      # 警告
    "I",      # 导入
    "C",      # 代码风格
    "N",      # 命名
    "B",      # 布尔值陷阱
    "D",      # 文档字符串
    "UP",     # 未使用的导入
    "A",      # 断言
    "T",      # 类型注解
    "SIM",    # 简单性
    "FBT",    # 字符串到布尔值的转换
    "RET",    # 返回语句
    "ARG",    # 参数
    "COM",    # 注释
    "ERA",    # 冗余
    "EXE",    # 可执行文件
    "ISC",    # 不一致的字符串引用
    "NPY",    # NumPy 风格
    "PD",     # pandas 风格
    "PTH",    # 路径处理
    "PYI",    # 类型存根
    "RSE",    # 提升可读性
    "RUF",    # Ruff 特定规则
    "SLOT",   # __slots__
    "T20",    # 打印语句
    "TCH",    # 类型检查
    "TRY",    # 异常处理
    "FIX",    # 修复建议
]

# 忽略不适用于中文文档字符串和FastAPI常见用法的规则
ignore = [
    "D400",  # 第一行应该是动词短语
    "D415",  # 一行的文档字符串应该以句号结尾
    "D100",  # 缺失模块级文档字符串
    "D413",  # 多行文档字符串的第一行应该是简短摘要
    "B008",  # 不要在函数调用中使用可变默认参数
    "W293",  # 空白行包含空格
    "D203",  # 一行的文档字符串不应该有结束引号在新行上
    "D212",  # 多行文档字符串的摘要应该在单独的行上
    "D213",  # 多行文档字符串的摘要不应该在单独的行上
    "D401",  # 第一行应该是简短摘要
    "D403",  # 第一行不应该以 'This function' 或类似的开头
    "D404",  # 第一行不应该以 'A' 或 'An' 开头
    "D406",  # 第一行不应该以 'The' 开头
    "D407",  # 第一行不应该以 'A/an/the' 开头
    "D408",  # 第一行不应该以 'An' 开头
    "D409",  # 第一行不应该以 'The' 开头
    "D410",  # 第一行不应该以 'A' 开头
    "D411",  # 第一行不应该以 'A/' 开头
    "D412",  # 第一行不应该以 'A.' 开头
    "D414",  # 第一行不应该以 'A ' 开头
    "D416",  # 一行的文档字符串不应该以句号结尾
    "D417",  # 多行文档字符串的摘要不应该以句号结尾
    "D418",  # 多行文档字符串的摘要不应该以问号结尾
    "D419",  # 多行文档字符串的摘要不应该以感叹号结尾
    "D107",  # 缺失 __init__ 文档字符串
    "TRY003",  # 避免在异常类外指定长消息
    "RUF002",  # 中文逗号问题
    "RUF003",  # 中文标点符号问题
    "FBT001",  # 布尔类型参数
    "FBT002",  # 布尔默认参数
    "TRY300",  # else 块建议
    "E402",  # 模块级导入不在文件顶部
    "T201",  # print 语句
    "PTH118",  # os.path.join() 应该被 Path 替代
    "PTH120",  # os.path.dirname() 应该被 Path.parent 替代
]

# 配置规则选项
line-length = 120
fixable = ["ALL"]
unfixable = []

# 忽略某些规则
extend-exclude = [".venv", "alembic", "tests"]

# 导入排序配置
[tool.ruff.isort]
known-first-party = ["src"]
known-third-party = ["fastapi", "sqlalchemy", "pydantic", "passlib", "jose", "celery"]

# 自动格式化配置
[tool.ruff.format]
quote-style = "single"
docstring-code-format = true
line-ending = "lf"
skip-magic-trailing-comma = false

# 类型检查配置
[tool.mypy]
python_version = "3.12"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
disallow_incomplete_defs = true
check_untyped_defs = true
disallow_untyped_decorators = true
no_implicit_optional = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
warn_unreachable = true

# 配置排除目录
[[tool.mypy.overrides]]
module = [".venv", "alembic", "tests"]
ignore_errors = true

[[tool.mypy.overrides]]
module = "yitool.yi_config"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "yitool.yi_config.middleware"
ignore_missing_imports = true

[tool.pytest.ini_options]
asyncio_mode = "auto"
markers = [
    "integration: Integration tests",
    "unit: Unit tests",
    "e2e: End-to-end tests"
]
testpaths = ["tests"]
pythonpath = ["."]

[tool.uv.sources]
yitool = { path = "../yitool", editable = true }
