framework: praisonai
topic: "AI Code & Tools {{today}}"

# =============================================================================
# AI CODE BLOG POST GENERATOR - FULLY PARALLEL PIPELINE (MODULAR)
# =============================================================================
# 
# A modular, customizable recipe that:
# 1. Gathers AI coding topics (include: ai-topic-gatherer)
# 2. Filters duplicates
# 3. For each unique topic IN PARALLEL:
#    - Generate research keywords
#    - Deep research the topic
#    - Write code-focused blog post
#    - Publish to WordPress (include: wordpress-publisher)
#
# CUSTOMIZATION:
# Parent recipes can override these variables:
#   - topic: Main search topic (default: "AI Code & Tools {{today}}")
#   - today: Current date (default: "January 2026")
#   - max_workers: Parallel workers (default: 4)
#   - wp_category: WordPress category (default: "News")
#   - wp_author: WordPress author (default: "praison")
#   - keyword_count: Keywords per topic (default: 3)
#   - content_focus: Writing style (default: "code-focused")
# =============================================================================

# Variables with sensible defaults (can be overridden by parent recipe)
variables:
  today: "January 2026"
  max_workers: 4
  wp_category: "News"
  wp_author: "praison"
  keyword_count: 3
  content_focus: "code-focused"

agents:
  # ═══════════════════════════════════════════════════════════════════════════
  # DUPLICATE CHECKER - Filters already-published topics
  # ═══════════════════════════════════════════════════════════════════════════
  duplicate_checker:
    role: Content Deduplication Agent
    goal: Filter topic list to only unique topics not yet published
    backstory: You check for duplicate content and return ALL unique topics as a JSON array.
    tools:
      - check_duplicate

  # ═══════════════════════════════════════════════════════════════════════════
  # KEYWORD GENERATOR - Creates search queries for research
  # ═══════════════════════════════════════════════════════════════════════════
  keyword_generator:
    role: Research Keyword Specialist
    goal: Generate comprehensive search keywords for in-depth topic research
    backstory: |
      You are an expert at generating diverse, specific search queries.
      You create keywords that will find unique, specific information.

  # ═══════════════════════════════════════════════════════════════════════════
  # DEEP RESEARCHER - Gathers comprehensive facts
  # ═══════════════════════════════════════════════════════════════════════════
  deep_researcher:
    role: Investigative Technical Researcher
    goal: Conduct exhaustive research - search extensively, gather ALL facts
    backstory: |
      You are a thorough investigative researcher who leaves no stone unturned.
      tavily_search returns FULL PAGE CONTENT in raw_content field - use it!
    tools:
      - tavily_search

  # ═══════════════════════════════════════════════════════════════════════════
  # CONTENT WRITER - Creates code-focused articles (UNIQUE TO THIS RECIPE)
  # ═══════════════════════════════════════════════════════════════════════════
  content_writer:
    role: Technical AI Content Writer and Developer Advocate
    goal: Write code-focused, practical blog posts with working examples for AI engineers
    backstory: |
      You MUST use correct Gutenberg block format where content is inside HTML tags.
      You write about ONE topic only - never combine multiple topics.
      You use British English (colour, centre, organisation).
      
      CONTENT FOCUS ({{content_focus}}):
      - Every article MUST include code examples
      - Emphasise practical implementation over theory
      - Include installation commands, imports, and usage examples
      
      TITLE RULES (SEO-CRITICAL):
      - Include SPECIFIC names: tool, library, framework, or version
      - NEVER use generic words like "Insights", "Findings", "Overview", "Guide"
      - GOOD: "LangChain 0.2 Agents Tutorial with Python Code Examples"

  # ═══════════════════════════════════════════════════════════════════════════
  # PUBLISHER - Publishes to WordPress
  # ═══════════════════════════════════════════════════════════════════════════
  publisher:
    role: WordPress Publisher
    goal: Validate and publish blog post to WordPress
    backstory: |
      You extract title and content from structured input and publish to WordPress.
      You validate that content is in Gutenberg block format.
    tools:
      - create_wp_post

steps:
  # ─────────────────────────────────────────────────────────────────────────────
  # STEP 1: Gather AI coding topics (MODULAR - uses ai-topic-gatherer)
  # ─────────────────────────────────────────────────────────────────────────────
  - include: ai-topic-gatherer

  # ─────────────────────────────────────────────────────────────────────────────
  # STEP 2: Filter duplicates (checks against existing WordPress posts)
  # ─────────────────────────────────────────────────────────────────────────────
  - name: filter_duplicates
    agent: duplicate_checker
    output_variable: unique_topics
    output_json:
      type: array
      items:
        type: object
        properties:
          title:
            type: string
          url:
            type: string
          content:
            type: string
    action: |
      {{previous_output}}
      
      For EACH topic from the list above:
      1. Call check_duplicate with the topic title
      2. If NOT a duplicate (status is UNIQUE), add to the unique list
      
      Return a JSON array of unique topics with their URLs and content.

  # ─────────────────────────────────────────────────────────────────────────────
  # STEPS 3-6: For EACH unique topic - research, write, publish (PARALLEL)
  # Each iteration has ISOLATED context - no cross-contamination
  # ─────────────────────────────────────────────────────────────────────────────
  - loop:
      over: unique_topics
      parallel: true
      max_workers: 4
    steps:
      # Step 3a: Generate keywords for THIS topic
      - name: generate_keywords
        agent: keyword_generator
        output_json:
          type: object
          properties:
            topic:
              type: string
            keywords:
              type: array
              items:
                type: string
        action: |
          TOPIC: {{item.title}}
          SOURCE: {{item.url}}
          CONTEXT: {{item.content}}
          
          Generate EXACTLY {{keyword_count}} specific search queries to research this topic.
          Include queries for:
          - Official announcements and documentation
          - Technical specifications and features
          - Code examples or implementations

      # Step 3b: Research THIS topic
      - name: deep_research
        agent: deep_researcher
        output_json:
          type: object
          properties:
            topic:
              type: string
            research:
              type: string
        action: |
          TOPIC: {{previous_output.topic}}
          SEARCH KEYWORDS: {{previous_output.keywords}}
          
          Perform EXACTLY {{keyword_count}} searches using the keywords above.
          Read the raw_content field from each result for full article text.
          Extract: dates, statistics, quotes, technical specs, code examples.
          
          Compile ALL findings into comprehensive research.

      # Step 3c: Write the article
      - name: write_article
        agent: content_writer
        output_json:
          type: object
          properties:
            title:
              type: string
            content:
              type: string
        action: |
          RESEARCH CONTENT:
          {{previous_output}}
          
          Write a {{content_focus}} blog post using Gutenberg blocks.
          Include: installation commands, code examples, practical usage.
          
          OUTPUT FORMAT:
          - title: SEO-optimized title (6-10 words, include tool name)
          - content: Full Gutenberg block formatted content

      # Step 3d: Publish to WordPress
      - name: publish_article
        agent: publisher
        action: |
          ARTICLE:
          Title: {{previous_output.title}}
          Content: {{previous_output.content}}
          
          Call create_wp_post with:
          - title: the title above
          - content: the content above
          - status: publish
          - category: {{wp_category}}
          - author: {{wp_author}}
          
          Report the post ID.

# Enable smart context management with aggressive summarization for parallel workflows
context:
  enabled: true
  auto_compact: true
  compact_threshold: 0.6
  strategy: smart
  llm_summarize: true
  smart_tool_summarize: true
  max_tool_output_tokens: 2000
  tool_summarize_limits:
    tavily_search: 1000
    tavily_extract: 1500