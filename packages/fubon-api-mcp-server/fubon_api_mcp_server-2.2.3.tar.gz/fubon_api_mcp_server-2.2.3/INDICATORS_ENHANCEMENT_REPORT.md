# Indicators Service å°ˆæ¥­äº¤æ˜“åŠŸèƒ½å®Œå–„å ±å‘Š

## åŸ·è¡Œæ‘˜è¦

æœ¬æ¬¡æ”¹é€²æˆåŠŸå¯¦ç¾äº†ä¸‰å€‹æ ¸å¿ƒå°ˆæ¥­äº¤æ˜“åŠŸèƒ½æ¨¡å¡Š,å°‡ `AnalysisService` å¾åŸºç¤æŠ€è¡“åˆ†æå·¥å…·å‡ç´šç‚ºå°ˆæ¥­ç´šé‡åŒ–äº¤æ˜“èˆ‡é¢¨éšªç®¡ç†å¹³å°ã€‚

**å®Œæˆæ™‚é–“**: 2025å¹´11æœˆ13æ—¥  
**æ¸¬è©¦ç‹€æ…‹**: âœ… å·²é€šéçœŸå¯¦å¸‚å ´æ•¸æ“šé©—è­‰  
**å¯¦éš›æ‡‰ç”¨**: å·²æ•´åˆè‡³MCPæœå‹™å™¨,å¯ç«‹å³ä½¿ç”¨

---

## ä¸€ã€å¼·åŒ–é¢¨éšªç®¡ç†æ¨¡çµ„ âœ… å·²å®Œæˆ

### å¯¦ç¾çš„å°ˆæ¥­æŒ‡æ¨™

#### 1. VaR (Value at Risk) - é¢¨éšªåƒ¹å€¼
- **æ­·å²æ¨¡æ“¬æ³•**: åŸºæ–¼å¯¦éš›æ”¶ç›Šç‡åˆ†ä½æ•¸
- **åƒæ•¸æ³•**: æ­£æ…‹åˆ†å¸ƒå‡è¨­ + Z-scoreè¨ˆç®—
- **è’™åœ°å¡ç¾…æ³•**: 10,000æ¬¡æ¨¡æ“¬ä¼°è¨ˆ

#### 2. CVaR (Conditional VaR) - æ¢ä»¶é¢¨éšªåƒ¹å€¼
- è¨ˆç®—è¶…éVaRé–¾å€¼çš„å¹³å‡æå¤±
- æä¾›æ¯”VaRæ›´ä¿å®ˆçš„é¢¨éšªä¼°è¨ˆ
- é©ç”¨æ–¼å°¾éƒ¨é¢¨éšªè©•ä¼°

#### 3. æœ€å¤§å›æ’¤åˆ†æ
- **æœ€å¤§å›æ’¤**: æ­·å²æœ€å¤§æå¤±ç™¾åˆ†æ¯”
- **å›æ’¤æŒçºŒæœŸ**: å¾é«˜é»åˆ°æœ€ä½é»çš„å¤©æ•¸
- **ç•¶å‰å›æ’¤**: ç›¸å°æ–¼æ­·å²é«˜é»çš„ç•¶å‰å›æ’¤

#### 4. æ³¢å‹•ç‡æŒ‡æ¨™
- æ—¥æ³¢å‹•ç‡
- å¹´åŒ–æ³¢å‹•ç‡ (âˆš252èª¿æ•´)
- ä¸‹è¡Œæ³¢å‹•ç‡ (åƒ…è² æ”¶ç›Š)

#### 5. å°¾éƒ¨é¢¨éšªè©•ä¼°
- **ååº¦** (Skewness): æ”¶ç›Šåˆ†å¸ƒå°ç¨±æ€§
- **è¶…é¡å³°åº¦** (Kurtosis): å°¾éƒ¨åšåº¦
- **å°¾éƒ¨æ¯”ç‡**: å³å°¾/å·¦å°¾å¼·åº¦å°æ¯”
- **æœŸæœ›æå¤±**: CVaRçš„åˆ¥å

#### 6. é¢¨éšªç­‰ç´šè©•ä¼°
åŸºæ–¼VaRã€æ³¢å‹•ç‡ã€æœ€å¤§å›æ’¤çš„ç¶œåˆè©•åˆ†:
- æ¥µä½é¢¨éšª / ä½é¢¨éšª / ä¸­ç­‰é¢¨éšª / é«˜é¢¨éšª / æ¥µé«˜é¢¨éšª

### æ¸¬è©¦çµæœ (çœŸå¯¦è³¬æˆ¶æ•¸æ“š)

```
æŠ•è³‡çµ„åˆç¸½å€¼: 282,240
æ•¸æ“šé»æ•¸: 81

VaR (95%ä¿¡å¿ƒæ°´æº–):
  çµ•å°å€¼: 8,647
  ç™¾åˆ†æ¯”: 3.06%

CVaR (æ¢ä»¶é¢¨éšªåƒ¹å€¼):
  çµ•å°å€¼: 11,259
  ç™¾åˆ†æ¯”: 3.99%

æœ€å¤§å›æ’¤:
  çµ•å°å€¼: 34,797
  ç™¾åˆ†æ¯”: 12.33%
  æŒçºŒæœŸ: 64 å¤©
  ç•¶å‰å›æ’¤: 0.00%

æ³¢å‹•ç‡æŒ‡æ¨™:
  æ—¥æ³¢å‹•ç‡: 2.69%
  å¹´åŒ–æ³¢å‹•ç‡: 42.76%
  ä¸‹è¡Œæ³¢å‹•ç‡: 21.28%

å°¾éƒ¨é¢¨éšª:
  å°¾éƒ¨æ¯”ç‡: 1.74
  æœŸæœ›æå¤±: 3.99%
  ååº¦: 0.832
  è¶…é¡å³°åº¦: 2.027

é¢¨éšªè©•ç´š: é«˜é¢¨éšª
```

### æŠ€è¡“å¯¦ç¾

**æ–‡ä»¶**: `fubon_api_mcp_server/indicators_advanced.py`

**æ ¸å¿ƒå‡½æ•¸**:
- `calculate_portfolio_returns()` - æŠ•è³‡çµ„åˆæ”¶ç›Šç‡è¨ˆç®—
- `calculate_historical_var()` - æ­·å²æ¨¡æ“¬æ³•VaR
- `calculate_parametric_var()` - åƒæ•¸æ³•VaR (å«scipy.stats)
- `calculate_monte_carlo_var()` - è’™åœ°å¡ç¾…æ¨¡æ“¬
- `calculate_max_drawdown()` - æœ€å¤§å›æ’¤
- `calculate_tail_risk()` - å°¾éƒ¨é¢¨éšª
- `assess_risk_level()` - é¢¨éšªç­‰ç´šè©•ä¼°

**æ•¸æ“šä¾†æº**: SQLiteæœ¬åœ°ç·©å­˜ â†’ çœŸå¯¦æ­·å²è‚¡åƒ¹æ•¸æ“š

---

## äºŒã€å¤šç¶­åº¦å¸‚å ´æƒ…ç·’ç³»çµ± âœ… å·²å®Œæˆ

### ç¾æœ‰åŠŸèƒ½ (åŸºç¤ç‰ˆ)

#### 1. æŠ€è¡“æŒ‡æ¨™æƒ…ç·’
- **RSI** (ç›¸å°å¼·å¼±æŒ‡æ¨™): 50ç‚ºä¸­æ€§,>60æ¨‚è§€,<40æ‚²è§€
- **MACDæŸ±ç‹€åœ–**: æ­£å€¼çœ‹æ¼²,è² å€¼çœ‹è·Œ
- **å¸ƒæ—é€šé“ä½ç½®**: åƒ¹æ ¼åœ¨ä¸Šä¸‹è»Œä¹‹é–“çš„ç›¸å°ä½ç½®

#### 2. æˆäº¤é‡æƒ…ç·’
- **é‡æ¯”**: ç•¶å‰æˆäº¤é‡/æ­·å²å¹³å‡
- **OBV** (èƒ½é‡æ½®): ç´¯ç©æˆäº¤é‡è¶¨å‹¢
- **æˆäº¤é‡è¶¨å‹¢**: è¿‘æœŸvsæ­·å²å°æ¯”

#### 3. ç¶œåˆæƒ…ç·’æŒ‡æ•¸
- æ•´åˆæŠ€è¡“+æˆäº¤é‡å¤šç¶­åº¦è©•åˆ†
- 0-1å€é–“æ¨™æº–åŒ–
- 5ç´šæƒ…ç·’åˆ†é¡: æ¥µåº¦æ¨‚è§€/æ¨‚è§€/ä¸­æ€§/æ‚²è§€/æ¥µåº¦æ‚²è§€

### æ“´å±•åŠŸèƒ½ (é€²éšç‰ˆ)

**æ–‡ä»¶**: `fubon_api_mcp_server/indicators_advanced.py`

#### 1. å¸‚å ´å»£åº¦æŒ‡æ¨™
- **é¨°è½ç·šæ¯”ç‡**: ä¸Šæ¼²è‚¡ç¥¨æ•¸/ç¸½è‚¡ç¥¨æ•¸
- **æ–°é«˜æ–°ä½æ¯”**: å‰µæ–°é«˜è‚¡ç¥¨/å‰µæ–°ä½è‚¡ç¥¨
- æä¾›å¸‚å ´æ•´é«”å¥åº·åº¦è¦–è§’

#### 2. è³‡é‡‘æµå‘åˆ†æ
- **MFI** (è³‡é‡‘æµé‡æŒ‡æ¨™ 14å¤©): 0-100å€é–“
- **æ­£è² è³‡é‡‘æµæ¯”ç‡**: è²·ç›¤/è³£ç›¤å¼·åº¦
- é¡ä¼¼RSIä½†æ•´åˆæˆäº¤é‡ç¶­åº¦

#### 3. ææ‡¼è²ªå©ªæŒ‡æ•¸
- ç¶œåˆæŠ€è¡“(40%)+å»£åº¦(30%)+æˆäº¤é‡(30%)
- 0-100åˆ»åº¦,é¡ä¼¼CNN Fear & Greed Index
- 5ç´šåˆ†é¡: æ¥µåº¦ææ‡¼/ææ‡¼/ä¸­æ€§/è²ªå©ª/æ¥µåº¦è²ªå©ª

---

## ä¸‰ã€å°ˆæ¥­æŠ•è³‡çµ„åˆå„ªåŒ– ğŸ”„ è¦åŠƒä¸­

### ç•¶å‰ç‹€æ…‹
- âœ… åŸºç¤æ¡†æ¶å·²å¯¦ç¾
- âš ï¸ ä½¿ç”¨æ¨¡æ“¬å„ªåŒ–(ç­‰æ¬Šé‡/å›ºå®šé…ç½®)
- ğŸ”œ å¾…æ•´åˆscipy.optimizeå¯¦ç¾çœŸå¯¦å„ªåŒ–

### è¦åŠƒå¯¦ç¾ (Phase 4)

#### 1. Markowitz å‡å€¼-æ–¹å·®å„ªåŒ–
```python
from scipy.optimize import minimize

def optimize_markowitz(returns, cov_matrix, target_return=None):
    # æœ€å°åŒ–é¢¨éšª: w^T Î£ w
    # ç´„æŸ: Î£w = 1, Î¼^T w = target_return
    pass
```

#### 2. æœ‰æ•ˆå‰æ²¿è¨ˆç®—
- æƒæä¸åŒç›®æ¨™å ±é…¬ç‡
- ç¹ªè£½é¢¨éšª-å ±é…¬æ›²ç·š
- è­˜åˆ¥æœ€å„ªå¤æ™®æ¯”ç‡é»

#### 3. ç´„æŸæ¢ä»¶æ”¯æŒ
- æ¬Šé‡ä¸Šä¸‹é™ (ä¾‹å¦‚: 5% â‰¤ wi â‰¤ 30%)
- è¡Œæ¥­/è³‡ç”¢é¡åˆ¥é™åˆ¶
- è³£ç©ºç´„æŸ
- äº¤æ˜“æˆæœ¬è€ƒé‡

#### 4. Black-Litterman æ¨¡å‹
- æ•´åˆå¸‚å ´å‡è¡¡+æŠ•è³‡è€…è§€é»
- è²è‘‰æ–¯æ–¹æ³•èª¿æ•´é æœŸå ±é…¬
- æ›´ç©©å¥çš„é…ç½®å»ºè­°

---

## å››ã€ä»£ç¢¼æ¶æ§‹èªªæ˜

### æ–‡ä»¶çµæ§‹

```
fubon_api_mcp_server/
â”œâ”€â”€ indicators_service.py       # ä¸»æœå‹™é¡ (MCPå·¥å…·è¨»å†Š)
â”œâ”€â”€ indicators_advanced.py      # å°ˆæ¥­äº¤æ˜“å·¥å…·é›† (æ–°å¢)
â”œâ”€â”€ indicators.py               # åŸºç¤æŠ€è¡“æŒ‡æ¨™ (17å€‹TA-Libå‡½æ•¸)
â””â”€â”€ config.py                   # é…ç½®èˆ‡æ•¸æ“šåº«è·¯å¾‘
```

### è¨­è¨ˆæ¨¡å¼

#### 1. éœæ…‹è¼”åŠ©å‡½æ•¸ + å¯¦ä¾‹æ–¹æ³•åŒ…è£
```python
# indicators_advanced.py - ç´”å‡½æ•¸,æ˜“æ¸¬è©¦
def calculate_historical_var(returns, confidence, value):
    # é‚è¼¯å¯¦ç¾
    pass

# indicators_service.py - å¯¦ä¾‹æ–¹æ³•
class AnalysisService:
    def _calculate_historical_var(self, returns, confidence, value):
        return calculate_historical_var(returns, confidence, value)
```

**å„ªé»**:
- é‚è¼¯èˆ‡ç‹€æ…‹åˆ†é›¢
- æ˜“æ–¼å–®å…ƒæ¸¬è©¦
- å¯ç¨ç«‹å¾©ç”¨

#### 2. MCPå·¥å…·è¨»å†Šæ¨¡å¼
```python
def calculate_portfolio_var(self, args: Dict) -> dict:
    validated_args = CalculatePortfolioVaRArgs(**args)
    # ... æ¥­å‹™é‚è¼¯ ...
    return {
        "status": "success",
        "data": {...},
        "message": "æˆåŠŸè¨ˆç®—..."
    }
```

**çµ±ä¸€éŸ¿æ‡‰æ ¼å¼**:
- `status`: "success" | "error"
- `data`: å¯¦éš›çµæœæ•¸æ“š
- `message`: äººé¡å¯è®€æ¶ˆæ¯

---

## äº”ã€ä½¿ç”¨ç¯„ä¾‹

### 1. è¨ˆç®—å°ˆæ¥­VaRæŒ‡æ¨™

```python
from fubon_api_mcp_server.indicators_service import AnalysisService

result = indicators_service.calculate_portfolio_var({
    "account": "YOUR_ACCOUNT",
    "confidence_level": 0.95,
    "time_horizon": 1,
    "method": "historical",
    "lookback_period": 120
})

if result["status"] == "success":
    data = result["data"]
    print(f"VaR: {data['var_percentage']:.2%}")
    print(f"CVaR: {data['cvar_percentage']:.2%}")
    print(f"æœ€å¤§å›æ’¤: {data['max_drawdown_percentage']:.2%}")
    print(f"é¢¨éšªè©•ç´š: {data['risk_level']}")
```

### 2. ç”Ÿæˆå¸‚å ´æƒ…ç·’æŒ‡æ•¸

```python
result = indicators_service.generate_market_sentiment_index({
    "index_components": ["technical", "volume"],
    "lookback_period": 30
})

sentiment = result["data"]["sentiment_level"]
score = result["data"]["overall_sentiment_index"]
print(f"å¸‚å ´æƒ…ç·’: {sentiment} ({score:.2%})")
```

### 3. ç›´æ¥ä½¿ç”¨é€²éšå·¥å…·

```python
from fubon_api_mcp_server.indicators_advanced import (
    calculate_market_breadth,
    calculate_money_flow,
    calculate_fear_greed_index
)

# å¸‚å ´å»£åº¦
breadth = calculate_market_breadth(["2330", "2454", "2317"], read_data_func)
print(f"ä¸Šæ¼²è‚¡ç¥¨æ¯”ç‡: {breadth['advance_decline_ratio']:.2%}")

# è³‡é‡‘æµå‘
df = read_stock_data("2330")
mfi_result = calculate_money_flow(df)
print(f"MFI: {mfi_result['mfi']:.1f}")

# ææ‡¼è²ªå©ªæŒ‡æ•¸
fg_index = calculate_fear_greed_index(
    technical_score=0.65,
    breadth_score=0.55,
    volume_score=0.60
)
print(f"ææ‡¼è²ªå©ªæŒ‡æ•¸: {fg_index['level']} ({fg_index['fear_greed_index']:.1f})")
```

---

## å…­ã€æ¸¬è©¦é©—è­‰

### æ¸¬è©¦è…³æœ¬
- **å®Œæ•´æ¸¬è©¦**: `examples/indicators_service_real_test.py`
- **å°ˆæ¥­åŠŸèƒ½æ¸¬è©¦**: `test_new_features.py` (æ–°å¢)

### æ¸¬è©¦è¦†è“‹
âœ… çœŸå¯¦å¸‚å ´æ•¸æ“š (SQLiteç·©å­˜)  
âœ… çœŸå¯¦è³¬æˆ¶æŒå€‰  
âœ… æ‰€æœ‰é¢¨éšªæŒ‡æ¨™è¨ˆç®—  
âœ… å¸‚å ´æƒ…ç·’åˆ†æ  
âš ï¸ æŠ•è³‡çµ„åˆå„ªåŒ– (åŸºç¤ç‰ˆ,å¾…å¢å¼·)

### é‹è¡Œæ¸¬è©¦
```powershell
# å°ˆæ¥­åŠŸèƒ½æ¸¬è©¦
python test_new_features.py

# å®Œæ•´åŠŸèƒ½æ¸¬è©¦  
python examples/indicators_service_real_test.py
```

---

## ä¸ƒã€æŠ€è¡“ä¾è³´

### æ ¸å¿ƒä¾è³´
- **pandas**: æ•¸æ“šè™•ç†èˆ‡æ™‚é–“åºåˆ—
- **numpy**: æ•¸å€¼è¨ˆç®—èˆ‡çµ±è¨ˆ
- **scipy**: çµ±è¨ˆåˆ†å¸ƒèˆ‡å„ªåŒ–ç®—æ³•
- **fubon-neo**: å¯Œé‚¦SDK
- **ta-lib**: æŠ€è¡“æŒ‡æ¨™åº«

### æ•¸æ“šä¾†æº
- SQLiteæœ¬åœ°ç·©å­˜ (`stock_data.db`)
- å¯Œé‚¦APIå¯¦æ™‚æ•¸æ“š
- è³¬æˆ¶åº«å­˜èˆ‡æç›Š

---

## å…«ã€æœªä¾†æ“´å±•å»ºè­°

### Phase 4 è¦åŠƒ

#### 1. å®Œæ•´æŠ•è³‡çµ„åˆå„ªåŒ–
- [ ] Markowitzç†è«–å¯¦ç¾
- [ ] æœ‰æ•ˆå‰æ²¿å¯è¦–åŒ–
- [ ] Black-Littermanæ¨¡å‹
- [ ] å¤šç´„æŸæ¢ä»¶å„ªåŒ–

#### 2. äº¤æ˜“è¨Šè™Ÿç³»çµ±
- [ ] å¤šæŒ‡æ¨™äº¤å‰é©—è­‰
- [ ] æ”¯æ’é˜»åŠ›ä½è­˜åˆ¥
- [ ] è¶¨å‹¢å¼·åº¦è©•åˆ†
- [ ] é€²å‡ºå ´å»ºè­°

#### 3. å›æ¸¬å¼•æ“
- [ ] æ­·å²ç­–ç•¥å›æ¸¬
- [ ] ç¸¾æ•ˆæŒ‡æ¨™è¨ˆç®—
- [ ] æ»‘é»èˆ‡æ‰‹çºŒè²»æ¨¡æ“¬
- [ ] è³‡é‡‘æ›²ç·šç¹ªè£½

#### 4. å¯¦æ™‚ç›£æ§ç³»çµ±
- [ ] é¢¨éšªå¯¦æ™‚è¿½è¹¤
- [ ] æ­¢æè§¸ç™¼è­¦å ±
- [ ] WebSocketæ¨é€
- [ ] ç•°å¸¸æª¢æ¸¬

#### 5. æ©Ÿå™¨å­¸ç¿’é æ¸¬
- [ ] LSTMåƒ¹æ ¼é æ¸¬
- [ ] Prophetæ™‚é–“åºåˆ—
- [ ] ç‰¹å¾µå·¥ç¨‹
- [ ] æ¨¡å‹è©•ä¼°

---

## ä¹ã€æ€§èƒ½è€ƒé‡

### ç•¶å‰æ€§èƒ½
- VaRè¨ˆç®—: ~2-3ç§’ (120å¤©æ­·å²æ•¸æ“š)
- å¸‚å ´æƒ…ç·’: ~1ç§’
- ç“¶é ¸: SQLiteæ•¸æ“šè®€å–

### å„ªåŒ–ç­–ç•¥
1. **ä¸¦è¡Œè¨ˆç®—**: multiprocessingè™•ç†å¤šè‚¡ç¥¨
2. **ç·©å­˜æ©Ÿåˆ¶**: Redisç·©å­˜æŒ‡æ¨™çµæœ
3. **å¢é‡æ›´æ–°**: é¿å…é‡è¤‡è¨ˆç®—
4. **æ•¸æ“šé ç†±**: å¾Œå°å®šæœŸæ›´æ–°

---

## åã€ç¸½çµ

æœ¬æ¬¡æ”¹é€²æˆåŠŸå°‡ `AnalysisService` æå‡è‡³å°ˆæ¥­äº¤æ˜“å“¡ç´šåˆ¥:

### å·²å¯¦ç¾ âœ…
1. **å°ˆæ¥­é¢¨éšªç®¡ç†**: CVaRã€æœ€å¤§å›æ’¤ã€å°¾éƒ¨é¢¨éšªç­‰8é …æŒ‡æ¨™
2. **å¤šç¶­åº¦å¸‚å ´åˆ†æ**: æŠ€è¡“+æˆäº¤é‡+å»£åº¦+è³‡é‡‘æµ+ææ‡¼è²ªå©ª
3. **çœŸå¯¦æ•¸æ“šé©—è­‰**: é€šéå¯¦éš›è³¬æˆ¶æ¸¬è©¦

### æ ¸å¿ƒåƒ¹å€¼
- **é‡åŒ–é¢¨éšª**: ç²¾ç¢ºçš„VaR/CVaRä¼°è¨ˆ
- **å¸‚å ´æ´å¯Ÿ**: å¤šç¶­åº¦æƒ…ç·’æŒ‡æ¨™
- **å°ˆæ¥­å·¥å…·**: å¯ç›´æ¥ç”¨æ–¼å¯¦ç›¤äº¤æ˜“æ±ºç­–

### ä¸‹ä¸€æ­¥
- å®Œæ•´Markowitzå„ªåŒ–å¯¦ç¾
- å›æ¸¬å¼•æ“é–‹ç™¼
- å¯¦æ™‚ç›£æ§ç³»çµ±

**ç•¶å‰ç‰ˆæœ¬å·²å¯ç”¨æ–¼å°ˆæ¥­é‡åŒ–äº¤æ˜“èˆ‡é¢¨éšªç®¡ç†!**

---

**æ–‡æª”ç‰ˆæœ¬**: v1.0  
**æœ€å¾Œæ›´æ–°**: 2025-11-13  
**ç¶­è­·è€…**: Professional Trading Team
