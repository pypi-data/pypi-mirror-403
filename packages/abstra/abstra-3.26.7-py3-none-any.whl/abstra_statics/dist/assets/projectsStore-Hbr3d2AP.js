import{d as V,r as c,c as p,l as x,i as I}from"./jwt-decode.esm-Dw_OlTCW.js";import{a as T}from"./router-DzczyMew.js";import{M as B}from"./member-Cn62RcK0.js";import{O as S}from"./organization-CyPzXZ9t.js";import{P as k,a as U}from"./project-Dsz7eI6O.js";import"./tables-CkY-LQhC.js";import{F as q}from"./folder-DC5bh9EE.js";import{a as w}from"./ant-design-Cvwf7JMR.js";(function(){try{var r=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},i=new Error().stack;i&&(r._sentryDebugIds=r._sentryDebugIds||{},r._sentryDebugIds[i]="6e4f8f68-658e-49b3-9fb3-adc1351028f9",r._sentryDebugIdIdentifier="sentry-dbid-6e4f8f68-658e-49b3-9fb3-adc1351028f9")}catch{}})();const ue=V("projectsView",()=>{const r=c(null),i=c([]),a=c(null),n=c(null),M=c(!1),b=c(""),j=c(!0),N=c(new Map),s={member:new B,project:new k,folder:new q},C=p(()=>r.value?.members.map(e=>({label:e.email,value:e.id,disabled:e.id===r.value?.currentMember?.id})).sort((e,t)=>e.label.localeCompare(t.label))),_=p(()=>r.value?.folders.map(e=>({label:e.name,value:e.id}))),L=p(()=>{if(!a.value)return!1;const e=a.value.newName!==a.value.currentName,t=a.value.newName.trim().length>0,l=!x.isEqual(a.value.newMemberIds,a.value.currentMemberIds),d=a.value.newMemberIds.length>0;return a.value.mode==="edit"?e&&t||l&&d:t&&d}),A=p(()=>{if(!n.value)return!1;const e=!!n.value.newFolderId,t=n.value.newName.trim().length>0,l=n.value.newName!==n.value.currentName,d=n.value.newFolderId!==n.value.currentFolderId;return n.value.mode==="edit"?l&&t||d:e&&t}),m=async e=>{const t=T.getAuthor()?.claims.email;if(!t)throw new Error("User not authenticated");const l=s.project.list(e),[d,o,h,f,P]=await Promise.all([l,U.list(e),S.get(e),s.member.list(e),s.folder.list(e)]),O=f.find(u=>u.email===t)??null,g=new Map;for(const u of d)u.lastBuild&&g.set(u.id,u.lastBuild);N.value=g,i.value.length===0&&P.length===1&&(i.value=[P[0].id]),r.value={projects:o.sort((u,y)=>u.name.localeCompare(y.name)),organization:h,members:f,folders:P.sort((u,y)=>u.name.localeCompare(y.name)),currentMember:O}},F=e=>r.value?.projects.filter(t=>t.folderId===e&&(!b.value.trim()||t.name.toLowerCase().includes(b.value.toLowerCase()))),E=()=>b.value.trim()?r.value?.folders.filter(e=>F(e.id).length>0)??[]:r.value?.folders??[],D=e=>{i.value.includes(e)?i.value=i.value.filter(t=>t!==e):i.value=[...i.value,e]},v=()=>{a.value=null,n.value=null,M.value=!1};return{fetchedState:r,activeFolderIds:i,draftFolder:a,draftProject:n,isMembersModalOpen:M,searchQuery:b,isDraftProjectValid:A,isDraftFolderValid:L,isDraftFolderUnique:j,memberOptions:C,folderOptions:_,fetchState:m,getFolderProjects:F,listFolders:E,toggleFolder:D,closeModals:v,openMembersModal:()=>{M.value=!0},inviteMember:async(e,t)=>{await s.member.create({organizationId:e,email:t}),await m(e)},removeMember:async(e,t)=>{const l=r.value?.members.find(o=>o.id===t);if(!l){console.error("Member not found for removal");return}if(await w(I.translate("i18n_projectsview_remove_member_confirm",null,l.email))){r.value&&(r.value.members=r.value.members.filter(o=>o.id!==t));try{await s.member.delete({organizationId:e,authorId:l.authorId})}catch(o){console.error("Failed to remove member",o),await m(e)}}},openCreateFolderModal:()=>{r.value&&(a.value={currentName:"",mode:"create",currentMemberIds:[],modalTitle:"Create Folder",newName:"",newMemberIds:[r.value.currentMember?.id].filter(Boolean),buttonLoading:null})},openCreateProjectModal:(e="")=>{n.value={currentName:"",mode:"create",currentFolderId:"",modalTitle:"Create Project",newName:"",newFolderId:e,buttonLoading:null}},openEditProjectModal:e=>{n.value={id:e.id,mode:"edit",currentName:e.name,currentFolderId:e.folderId,modalTitle:`Edit Project: ${e.name}`,newName:e.name,newFolderId:e.folderId,buttonLoading:null}},openEditFolderModal:e=>{r.value&&(a.value={currentName:e.name,modalTitle:`${e.name} - Settings`,id:e.id,mode:"edit",newName:e.name,newMemberIds:[...e.memberIds],currentMemberIds:e.memberIds,buttonLoading:null})},saveProject:async(e,t)=>{if(n.value){if(n.value.buttonLoading="save",n.value.mode==="edit")await s.project.update(n.value.id,{name:n.value.newName,folderId:n.value.newFolderId});else if(n.value.mode==="create"){const l=await s.project.create({name:n.value.newName,folderId:n.value.newFolderId,organizationId:e});t(l.id);return}await m(e),v()}},deleteProject:async e=>{!n.value||n.value.mode!=="edit"||!await w("Are you sure you want to delete this project? All data will be lost.")||(n.value.buttonLoading="delete",await s.project.delete(n.value.id),await m(e),v())},saveFolder:async e=>{if(j.value=!0,!a.value)return;if(a.value.newName!==a.value.currentName&&!await s.folder.checkNameAvailability(e,a.value.newName)){j.value=!1;return}a.value.buttonLoading="save";const t=[];for(const l of a.value.newMemberIds){if(r.value?.members.find(o=>o.id===l)){t.push(l);continue}if(l.includes("@"))try{const o=await s.member.create({organizationId:e,email:l});t.push(o.id)}catch(o){console.error("Failed to invite member from tag",l,o)}}a.value.mode==="edit"?await s.folder.update(e,{id:a.value.id,name:a.value.newName,memberIds:t,organizationId:e}):a.value.mode==="create"&&await s.folder.create({organizationId:e,name:a.value.newName,memberIds:t}),await m(e),v()},deleteFolder:async e=>{!a.value||a.value.mode!=="edit"||F(a.value.id).length>0||!await w("Are you sure you want to delete this empty folder?",{okText:"Delete",cancelText:"Cancel"})||(a.value.buttonLoading="delete",await s.folder.delete(e,a.value.id),await m(e),v())},moveProject:async(e,t)=>{const l=r.value?.projects.find(o=>o.id===e);if(!l||l.folderId===t)return;const d=l.folderId;l.folderId=t;try{await s.project.update(e,{folderId:t})}catch(o){l.folderId=d,console.error("Failed to move project",o)}},updateFolderName:async(e,t,l,d)=>{const o=r.value?.folders.find(f=>f.id===t);if(!o)return;const h=o.name;o.name=l;try{await s.folder.update(e,{id:t,name:l,memberIds:d,organizationId:e})}catch(f){o.name=h,console.error("Failed to update folder name",f)}},removeProjectOptimistic:async e=>{const t=r.value?.projects.find(o=>o.id===e);if(!t||!r.value||!await w(I.translate("i18n_projectsview_delete_project_confirm",null,t.name)))return!1;const d=[...r.value.projects];r.value.projects=r.value.projects.filter(o=>o.id!==e);try{return await s.project.delete(e),!0}catch(o){return r.value&&(r.value.projects=d),console.error("Failed to delete project",o),!1}},getProjectLastBuild:e=>N.value.get(e)??null}});export{ue as u};
//# sourceMappingURL=projectsStore-Hbr3d2AP.js.map
