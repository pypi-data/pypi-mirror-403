import{L}from"./CircularLoading-KIKDgvZr.js";import{a as B,ag as P,c as T,r as U,k as w,f as d,n as p,b as I,e as C,h as s,t as i,u as a,i as n,w as r,b5 as x,b3 as K,bM as M,B as y,g as k,ba as E,aK as q,af as S,Z as z}from"./jwt-decode.esm-Dw_OlTCW.js";import{a as A,T as F,g as O}from"./router-DzczyMew.js";import{_ as G}from"./AbstraLogo.vue_vue_type_script_setup_true_lang--TrSji4U.js";import{O as Z}from"./OTPInput-BNXizKEV.js";import{i as j}from"./string-BuQ9zSDy.js";import{A as H}from"./index-4hy9Zjs6.js";import"./ts.worker-5sEEipil.js";import"./logo-BiWG9_W5.js";import"./Logo-CecBL509.js";(function(){try{var c=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},l=new Error().stack;l&&(c._sentryDebugIds=c._sentryDebugIds||{},c._sentryDebugIds[l]="4997ced5-9ec3-427b-90e2-846690207922",c._sentryDebugIdIdentifier="sentry-dbid-4997ced5-9ec3-427b-90e2-846690207922")}catch{}})();const J={class:"form"},Q={class:"header"},W={class:"description"},X={class:"description"},Y={class:"footer"},ee={key:2,class:"loading"},ae=B({__name:"Passwordless",emits:["done"],setup(c,{emit:l}){const u=P(),v=T(()=>u.query.reauth==="true"),f=T(()=>u.query.email||""),_=l,e=U({stage:"collect-info",info:{email:f.value||""},token:"",invalid:!1,secsToAllowResend:0});function h(){const t=e.value.info.email,o=j(t);return e.value.invalid=!o,o}let g;const m=async({isResend:t}={})=>{if(h()){e.value.stage="loading";try{await A.authenticate(e.value.info.email,t),e.value.stage="collect-token",e.value.secsToAllowResend=120,clearInterval(g),g=setInterval(()=>{e.value.secsToAllowResend-=1,e.value.secsToAllowResend<=0&&clearInterval(g)},1e3)}catch{e.value.invalid=!0,e.value.stage="collect-info"}}},D=t=>{if(!t){e.value.info.email="";return}e.value.info.email=t.toLowerCase()},R=async()=>{if(e.value.info?.email){e.value.stage="loading";try{const t=await A.verify(e.value.info.email,e.value.token);if(!t)throw new Error("[Passwordless] Login did not return an user");F.trackSession(),_("done",t),e.value.stage="done"}catch{e.value.invalid=!0,e.value.stage="collect-token"}}},N=async t=>{await fetch(`https://admin.abstra.app/_hooks/notify-email-not-received?email=${t}`,{method:"GET"})},V=()=>{e.value.info&&(m({isResend:!0}),N(e.value.info.email))},$=()=>{e.value.stage="collect-info",e.value.info={email:f.value||""},e.value.token="",e.value.invalid=!1};return(t,o)=>(d(),w("div",J,[p("div",Q,[s(G,{"hide-text":"",size:"large"}),p("h2",null,i(v.value?a(n).translate("i18n_auth_session_expired_title"):a(n).translate("i18n_auth_validate_your_email_login",null,{brandName:"Abstra"})),1)]),e.value.stage==="collect-info"?(d(),I(a(E),{key:0,class:"section"},{default:r(()=>[p("div",W,i(v.value?a(n).translate("i18n_auth_session_expired_description"):a(n).translate("i18n_auth_info_description")),1),s(a(x),{"has-feedback":"","validate-status":e.value.invalid?"error":"",help:e.value.invalid?a(n).translate("i18n_auth_info_invalid_email"):""},{default:r(()=>[s(a(K),{type:"email",value:e.value.info.email,placeholder:a(n).translate("i18n_auth_enter_your_work_email"),autofocus:"",onBlur:h,onKeyup:o[0]||(o[0]=M(()=>m(),["enter"])),onChange:o[1]||(o[1]=b=>D(b.target.value))},null,8,["value","placeholder"])]),_:1},8,["validate-status","help"]),s(a(y),{type:"primary",onClick:o[2]||(o[2]=()=>m())},{default:r(()=>[k(i(a(n).translate("i18n_auth_info_send_code")),1)]),_:1})]),_:1})):e.value.stage==="collect-token"?(d(),I(a(E),{key:1,class:"section"},{default:r(()=>[p("div",X,i(a(n).translate("i18n_auth_token_label",null,e.value.info)),1),s(a(x),{"has-feedback":"","validate-status":e.value.invalid?"error":""},{default:r(()=>[s(Z,{value:e.value.token,"onUpdate:value":o[3]||(o[3]=b=>e.value.token=b),length:6,numeric:!0,size:"large",onCollectToken:R},null,8,["value"]),e.value.invalid?(d(),I(a(H),{key:0,message:a(n).translate("i18n_auth_token_invalid"),type:"error",style:{"margin-top":"24px"}},null,8,["message"])):C("",!0)]),_:1},8,["validate-status"]),s(a(y),{type:"primary",onClick:R},{default:r(()=>[k(i(a(n).translate("i18n_auth_token_verify_email")),1)]),_:1}),s(a(y),{onClick:$},{default:r(()=>[k(i(a(n).translate("i18n_auth_edit_email")),1)]),_:1}),s(a(y),{disabled:!!e.value.secsToAllowResend,onClick:V},{default:r(()=>[k(i(a(n).translate("i18n_auth_token_resend_email"))+" ("+i(e.value.secsToAllowResend)+" s) ",1)]),_:1},8,["disabled"]),p("div",Y,i(a(n).translate("i18n_auth_token_footer_alternative_email")),1)]),_:1})):e.value.stage==="loading"?(d(),w("div",ee,[s(L)])):C("",!0)]))}}),te=q(ae,[["__scopeId","data-v-7522cd0d"]]),ne={key:0,class:"login"},oe={key:1,class:"loading"},se=B({__name:"Login",setup(c){const l=S(),u=P();async function v(){const _=u.query.redirect,e=u.query["prev-redirect"],{status:h}=await O.getInfo();if(h!=="active"){l.push({name:"onboarding",query:{redirect:_,"prev-redirect":e}});return}if(_){const m=new URL(_,window.location.origin).pathname;await l.push({path:m,query:{...u.query,redirect:e,"prev-redirect":void 0}});return}l.push({name:"home"})}const f=T(()=>!A.getAuthor());return z(()=>{f.value||v()}),(_,e)=>f.value?(d(),w("div",ne,[s(te,{onDone:v})])):(d(),w("div",oe,[s(L)]))}}),pe=q(se,[["__scopeId","data-v-2abe81c3"]]);export{pe as default};
//# sourceMappingURL=Login--k8_-8QF.js.map
