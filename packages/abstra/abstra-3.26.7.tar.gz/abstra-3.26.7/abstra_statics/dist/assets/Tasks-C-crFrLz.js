import{h as l,I as at,a as E,ag as J,af as nt,c0 as v,bp as F,i as c,c as Q,J as st,q as lt,k as G,f as p,R as H,w as s,u as t,b5 as C,b6 as B,ba as it,b4 as ot,T as D,g as _,t as f,b as m,e as Y,F as T,b9 as rt,bl as ut,Y as dt,a$ as ct,bm as pt,bz as ft,be as gt,aK as mt,ak as _t}from"./jwt-decode.esm-Dw_OlTCW.js";import{_ as N}from"./AbstraButton.vue_vue_type_script_setup_true_lang-60wd7w0p.js";import{G as yt}from"./PhBroom.vue-CDU1y1Fu.js";import{I as bt}from"./PhCopy.vue-CYMhBES8.js";import{T as vt,R as wt}from"./tasksController-DJpAodBz.js";import{s as St}from"./metadata-vgMtKcWz.js";import{t as ht}from"./ant-design-Cvwf7JMR.js";import{R as kt}from"./dayjs-DQa5ivan.js";import{c as U,d as w}from"./router-DzczyMew.js";import{A as q}from"./index-4hy9Zjs6.js";import{B as Dt,a as Tt}from"./build-DHVrj-yw.js";import{a as It}from"./project-Dsz7eI6O.js";import"./tables-CkY-LQhC.js";import{a as Ct}from"./asyncComputed-3zrnCYug.js";import"./contracts.generated-BY4ff4DP.js";import"./record-BTRCUCPd.js";import"./linters-7piodHpP.js";import"./polling-C2YNfl7D.js";import"./taskCreator-Cl5IQgz9.js";import"./PhMagnifyingGlass.vue-7kNaqZFQ.js";import"./PhWebhooksLogo.vue-BZ5oEMJy.js";import"./ts.worker-5sEEipil.js";import"./string-BuQ9zSDy.js";(function(){try{var d=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},u=new Error().stack;u&&(d._sentryDebugIds=d._sentryDebugIds||{},d._sentryDebugIds[u]="85cce559-91a5-4ba9-a8b2-79a8206112d8",d._sentryDebugIdIdentifier="sentry-dbid-85cce559-91a5-4ba9-a8b2-79a8206112d8")}catch{}})();var xt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M168 504.2c1-43.7 10-86.1 26.9-126 17.3-41 42.1-77.7 73.7-109.4S337 212.3 378 195c42.4-17.9 87.4-27 133.9-27s91.5 9.1 133.8 27A341.5 341.5 0 01755 268.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.7 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c0-6.7-7.7-10.5-12.9-6.3l-56.4 44.1C765.8 155.1 646.2 92 511.8 92 282.7 92 96.3 275.6 92 503.8a8 8 0 008 8.2h60c4.4 0 7.9-3.5 8-7.8zm756 7.8h-60c-4.4 0-7.9 3.5-8 7.8-1 43.7-10 86.1-26.9 126-17.3 41-42.1 77.8-73.7 109.4A342.45 342.45 0 01512.1 856a342.24 342.24 0 01-243.2-100.8c-9.9-9.9-19.2-20.4-27.8-31.4l60.2-47a8 8 0 00-3-14.1l-175.7-43c-5-1.2-9.9 2.6-9.9 7.7l-.7 181c0 6.7 7.7 10.5 12.9 6.3l56.4-44.1C258.2 868.9 377.8 932 512.2 932c229.2 0 415.5-183.7 419.8-411.8a8 8 0 00-8-8.2z"}}]},name:"sync",theme:"outlined"};function V(d){for(var u=1;u<arguments.length;u++){var r=arguments[u]!=null?Object(arguments[u]):{},y=Object.keys(r);typeof Object.getOwnPropertySymbols=="function"&&(y=y.concat(Object.getOwnPropertySymbols(r).filter(function(b){return Object.getOwnPropertyDescriptor(r,b).enumerable}))),y.forEach(function(b){At(d,b,r[b])})}return d}function At(d,u,r){return u in d?Object.defineProperty(d,u,{value:r,enumerable:!0,configurable:!0,writable:!0}):d[u]=r,d}var z=function(u,r){var y=V({},u,r.attrs);return l(at,V({},y,{icon:xt}),null)};z.displayName="SyncOutlined";z.inheritAttrs=!1;const Ot=E({__name:"TasksView",props:{api:{},stages:{},editor:{type:Boolean},stageId:{},status:{}},setup(d,{expose:u}){const r=d,y=J(),b=nt();function x(){const{stage:e,status:a,startDate:o,endDate:n}=y.query,g={};return e&&(g.stage=e),a&&(g.status=a),o&&n&&(g.dateRange=[v(o),v(n)]),g}const{setup:S,tearDown:I,state:i,getColumns:h,fetchTasks:A,clearAllTasks:O,updateStatus:$}=vt({api:r.api,poll:!0,stages:r.stages,stageId:r.stageId,status:r.status,initialFilters:r.editor?void 0:x(),onFilterChange:r.editor?void 0:L});function L(){if(r.editor)return;X();const e={},{stage:a,status:o,dateRange:n}=i.filters;e.stage=a,e.status=o,n&&n[0]&&n[1]&&v.isDayjs(n[0])&&v.isDayjs(n[1])?(e.startDate=n[0].toISOString().slice(0,10),e.endDate=n[1].toISOString().slice(0,10)):(e.startDate=void 0,e.endDate=void 0),b.replace({query:e})}function W(){i.filters.dateRange=void 0,i.filters.stage=void 0,i.filters.status=void 0}function X(){const e=i.filters.dateRange,a=v();!e||!e[1]?i.filters.dateRange=[a.subtract(90,"day"),a]:v.isDayjs(e[0])&&v.isDayjs(e[1])&&e[1].diff(e[0],"day")>90&&(i.filters.dateRange=[e[1].subtract(90,"day"),e[1]],F.warning({content:c.translate("i18n_tasksview_date_range_limit_warning",null,90)}))}const M=(e,a)=>!a?.label||typeof a.label!="string"?!1:a.label.toLowerCase().includes(e.toLowerCase()),R=e=>{if(!e.completed?.at||!e.created?.at)return null;const a=new Date(e.created.at).getTime(),o=new Date(e.completed.at).getTime();return Math.round((o-a)/1e3)},j=e=>{if(!e.created?.at)return null;const a=new Date(e.created.at).getTime(),o=Date.now();return Math.round((o-a)/1e3)},P=e=>{if(e<60)return`${e}s`;const a=Math.floor(e/60);if(a<60){const k=e%60;return k>0?`${a}m ${k}s`:`${a}m`}const o=Math.floor(a/60);if(o<24){const k=a%60;return k>0?`${o}h ${k}m`:`${o}h`}const n=Math.floor(o/24),g=o%24;return g>0?`${n}d ${g}h`:`${n}d`},Z=Q(()=>r.stages?i.tasks.map(e=>{const a=r.stages?.find(o=>o.id===e.targetStageId);return a?{...e,targetStageTitle:a.stageTitle,targetStageType:a.stageType,completedAt:e.completed?.at?new Date(e.completed.at).toLocaleString():"Not completed",createdAt:new Date(e.created.at).toLocaleString(),deleted:!1,duration:R(e),pendingDuration:j(e)}:{...e,targetStageTitle:null,targetStageType:null,completedAt:e.completed?.at?new Date(e.completed.at).toLocaleString():c.translate("i18n_tasksview_not_completed"),createdAt:new Date(e.created.at).toLocaleString(),deleted:!0,duration:R(e),pendingDuration:j(e)}}):i.tasks.map(e=>({...e,deleted:!1,completedAt:e.completed?.at?new Date(e.completed.at).toLocaleString():c.translate("i18n_tasksview_not_completed"),createdAt:new Date(e.created.at).toLocaleString(),duration:R(e),pendingDuration:j(e)}))),K=(e,a,o)=>{const n=e.current??1,g=e.pageSize??10;i.pagination.currentIndex=n-1,i.pagination.pageSize=g,A()},tt=(e,a)=>`/_editor/${e}/${a}`,et=e=>{typeof e=="object"?navigator.clipboard.writeText(JSON.stringify(e)):navigator.clipboard.writeText(String(e)),F.success({content:c.translate("i18n_tasksview_copied_to_clipboard")})};return u({clearAllTasks:O}),L(),st(()=>S()),lt(()=>I()),(e,a)=>(p(),G(H,null,[l(t(it),{layout:"vertical"},{default:s(()=>[l(t(U),{gutter:10,align:"bottom"},{default:s(()=>[l(t(w),{span:7},{default:s(()=>[l(t(C),{label:t(c).translate("i18n_tasksview_status_label")},{default:s(()=>[l(t(B),{value:t(i).filters.status,"onUpdate:value":a[0]||(a[0]=o=>t(i).filters.status=o),options:t(i).filterOptions.statuses,"option-label":"label","option-value":"value","show-search":"","filter-option":M,filter:!1,placeholder:t(c).translate("i18n_tasksview_all_placeholder"),"allow-clear":""},null,8,["value","options","placeholder"])]),_:1},8,["label"])]),_:1}),l(t(w),{span:8},{default:s(()=>[l(t(C),{label:t(c).translate("i18n_tasksview_stage_label")},{default:s(()=>[l(t(B),{value:t(i).filters.stage,"onUpdate:value":a[1]||(a[1]=o=>t(i).filters.stage=o),"show-search":"","filter-option":M,options:t(i).filterOptions.stages,placeholder:t(c).translate("i18n_tasksview_all_placeholder"),"allow-clear":""},null,8,["value","options","placeholder"])]),_:1},8,["label"])]),_:1}),l(t(w),{span:8},{default:s(()=>[l(t(C),{label:t(c).translate("i18n_tasksview_created_at_date_label")},{default:s(()=>[l(t(kt),{value:t(i).filters.dateRange,"onUpdate:value":a[2]||(a[2]=o=>t(i).filters.dateRange=o),style:{width:"100%"}},null,8,["value"])]),_:1},8,["label"])]),_:1}),l(t(w),{span:1},{default:s(()=>[l(t(C),null,{default:s(()=>[l(N,{type:"text",size:"middle",tooltip:t(c).translate("i18n_tasksview_clear_filters_tooltip"),onClick:W},{default:s(()=>[l(t(yt))]),_:1},8,["tooltip"])]),_:1})]),_:1})]),_:1})]),_:1}),l(t(gt),{columns:t(h)(),"data-source":Z.value,scroll:{x:"max-content",y:1e3},bordered:"",size:"small",pagination:{current:t(i).pagination.currentIndex+1,pageSize:t(i).pagination.pageSize,total:t(i).pagination.totalCount},onChange:K},{bodyCell:s(({column:o,record:n})=>[o.key==="timeInfo"?(p(),m(t(T),{key:0,vertical:"",gap:4},{default:s(()=>[l(t(D),null,{default:s(()=>[_(f(n.createdAt),1)]),_:2},1024),n.status==="locked"?(p(),m(t(q),{key:0,type:"info"},{message:s(()=>[_(f(t(c).translate("i18n_tasksview_status_running")),1)]),default:s(()=>[l(t(z),{spin:!0,style:{"margin-left":"4px"}})]),_:1})):(p(),m(t(q),{key:1,type:n.status==="pending"?"warning":"success"},rt({action:s(()=>[l(t(ut),{size:"small",checked:n.status==="completed","onUpdate:checked":g=>t($)(n,n.status==="pending"?"completed":"pending")},null,8,["checked","onUpdate:checked"])]),_:2},[n.status==="pending"?{name:"message",fn:s(()=>[_(f(t(c).translate("i18n_tasksview_pending_for"))+" "+f(P(n.pendingDuration)),1)]),key:"0"}:n.status==="completed"?{name:"message",fn:s(()=>[_(f(t(c).translate("i18n_tasksview_completed_in"))+" "+f(P(n.duration)),1)]),key:"1"}:void 0]),1032,["type"]))]),_:2},1024)):o.key==="stageInfo"?(p(),m(t(T),{key:1,vertical:"",gap:4},{default:s(()=>[n.deleted?(p(),m(t(D),{key:0},{default:s(()=>[_(f(t(c).translate("i18n_tasksview_not_found")),1)]),_:1})):(p(),m(t(T),{key:1,gap:8,align:"center"},{default:s(()=>[(p(),m(dt(t(St)(n.targetStageType)),{size:20})),l(t(T),{vertical:"",gap:0},{default:s(()=>[d.editor?(p(),m(t(ct),{key:0,href:tt(n.targetStageType,n.targetStageId)},{default:s(()=>[_(f(n.targetStageTitle),1)]),_:2},1032,["href"])):(p(),m(t(D),{key:1},{default:s(()=>[_(f(n.targetStageTitle),1)]),_:2},1024)),l(t(D),{type:"secondary",style:{fontSize:"12px"}},{default:s(()=>[_(f(n.type),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))]),_:2},1024)):o.key==="payloadInfo"?(p(),m(t(T),{key:2,gap:4,align:"start"},{default:s(()=>[l(N,{type:"text",size:"small",tooltip:t(c).translate("i18n_tasksview_copy_payload_tooltip"),onClick:pt(g=>et(n.payload),["stop"])},{default:s(()=>[l(t(bt))]),_:1},8,["tooltip","onClick"]),l(t(ft),{"tree-data":t(ht)(n.payload),selectable:!1,style:{flex:"1"}},null,8,["tree-data"])]),_:2},1024)):Y("",!0)]),footer:s(()=>[l(t(U),{justify:"end",gutter:10},{default:s(()=>[l(t(w),null,{default:s(()=>[l(t(ot),{size:"small"})]),_:1}),l(t(w),null,{default:s(()=>[l(t(D),null,{default:s(()=>[_(f(t(c).translate("i18n_tasksview_auto_updating")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["columns","data-source","pagination"])],64))}}),$t=mt(Ot,[["__scopeId","data-v-dca34258"]]),ee=E({__name:"Tasks",setup(d){const u=J(),r=u.params.projectId,y=u.query.stage,b=u.query.status,x=new wt(r),{result:S}=Ct(async()=>{const h=(await Dt.list(r)).find($=>$.latest);if(!h)return null;const[A,O]=await Promise.all([Tt.get(h.id),It.get(r)]);return{buildSpec:A,project:O}}),I=Q(()=>!S.value||!S.value.buildSpec?null:S.value.buildSpec.runtimes.map(i=>({id:i.id,stageTitle:i.title,stageType:i.type})));return(i,h)=>(p(),G(H,null,[l(t(_t),null,{default:s(()=>[_(f(t(c).translate("i18n_tasksview_title")),1)]),_:1}),I.value?(p(),m($t,{key:0,class:"tasks",api:t(x),stages:I.value,"stage-id":t(y),status:t(b)},null,8,["api","stages","stage-id","status"])):Y("",!0)],64))}});export{ee as default};
//# sourceMappingURL=Tasks-C-crFrLz.js.map
