"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([["77183"],{38114:function(t,e,r){r.a(t,async function(t,o){try{r.d(e,{AN:function(){return V},B2:function(){return z},BV:function(){return N},DR:function(){return tt},E$:function(){return U},GW:function(){return I},Q4:function(){return C},RB:function(){return S},TI:function(){return it},WN:function(){return B},X4:function(){return q},_d:function(){return X},al:function(){return H},bs:function(){return A},c:function(){return O},gv:function(){return K},h4:function(){return st},lh:function(){return T},m7:function(){return E},n3:function(){return ot},oU:function(){return P},pe:function(){return nt},t5:function(){return at},tb:function(){return R},uh:function(){return x}});r(16280),r(74423),r(44114),r(26910),r(18111),r(81148),r(22489),r(7588),r(61701),r(3362),r(17642),r(58004),r(33853),r(45876),r(32475),r(15024),r(31698),r(62953);var n=r(6946),s=r(78016),a=r(31810),i=r(81977),_=r(49134),u=r(92913),c=r(77972),l=r(56434),f=r(35932),y=r(73983),g=r(57279),d=r(70570),m=r(22786),p=r(91069),h=r(30162),b=r(5911),v=r(23528),w=r(46223),W=r(20058),M=t([h,w,p,v,W]);[h,w,p,v,W]=M.then?(await M)():M;const k=[],E=()=>({stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),S=()=>({stat_energy_to:"",stat_compensation:null,entity_energy_price:null,number_energy_price:null}),x=()=>({type:"grid",flow_from:[],flow_to:[],cost_adjustment_day:0}),C=()=>({type:"solar",stat_energy_from:"",config_entry_solar_forecast:null}),P=()=>({type:"battery",stat_energy_from:"",stat_energy_to:""}),O=()=>({type:"gas",stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),I=()=>({type:"water",stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),N=t=>t.callWS({type:"energy/info"}),z=async t=>(await t.loadBackendTranslation("issues","energy"),t.callWS({type:"energy/validate"})),A=t=>t.callWS({type:"energy/get_prefs"}),B=async(t,e)=>{const r=t.callWS({type:"energy/save_prefs",...e});return F(t),r},G=async(t,e,r,o,n,s="hour")=>t.callWS({type:"energy/fossil_energy_consumption",start_time:e.toISOString(),end_time:null==n?void 0:n.toISOString(),energy_statistic_ids:r,co2_statistic_id:o,period:s}),U=t=>(0,b.$)(t.energy_sources,t=>t.type),V=(t,e,r)=>{const o=[];for(const n of t.energy_sources)if(!r||r.includes(n.type))if("solar"!==n.type){if("gas"===n.type||"water"===n.type){o.push(n.stat_energy_from),n.stat_cost&&o.push(n.stat_cost);const t=e.cost_sensors[n.stat_energy_from];t&&o.push(t);continue}if("battery"!==n.type){for(const t of n.flow_from){o.push(t.stat_energy_from),t.stat_cost&&o.push(t.stat_cost);const r=e.cost_sensors[t.stat_energy_from];r&&o.push(r)}for(const t of n.flow_to){o.push(t.stat_energy_to),t.stat_compensation&&o.push(t.stat_compensation);const r=e.cost_sensors[t.stat_energy_to];r&&o.push(r)}}else o.push(n.stat_energy_from),o.push(n.stat_energy_to)}else o.push(n.stat_energy_from);return r&&!r.includes("device")||o.push(...t.device_consumption.map(t=>t.stat_consumption)),r&&!r.includes("water")||o.push(...t.device_consumption_water.map(t=>t.stat_consumption)),o},$=t=>{const e=[];for(const r of t.energy_sources)"gas"!==r.type&&"water"!==r.type&&("solar"!==r.type&&"battery"!==r.type?r.power&&e.push(...r.power.map(t=>t.stat_rate)):e.push(r.stat_rate));return e.push(...t.device_consumption.map(t=>t.stat_rate)),e.filter(Boolean)};var T=function(t){return t.NONE="",t.PREVIOUS="previous",t.YOY="yoy",t}({});const j=async(t,e,r,o,f)=>{const y=await N(t);let g;for(const n of Object.values(t.entities)){if("co2signal"!==n.platform)continue;const e=t.states[n.entity_id];if(e&&"%"===e.attributes.unit_of_measurement){g=e.entity_id;break}}const d=[];for(const n of e.energy_sources)if("grid"===n.type)for(const t of n.flow_from)d.push(t.stat_energy_from);const m=V(e,y,["grid","solar","battery","gas","device"]),h=$(e),b=V(e,y,["water"]),w=[...m,...b,...h],W=(0,n.c)(o||new Date,r),M=it(r,o),T=it(r,o,!0),D={},k=w.length?await(0,v.Wr)(t,w):[];w.length&&k.forEach(t=>{D[t.statistic_id]=t});const E=Y(t,e,D),S={energy:"kWh",volume:v.r_.includes(E)?E:void 0},x=Z(t,e,D),C={volume:x},P=m.length?(0,v.sz)(t,r,o,m,M,S,["change"]):{},O=h.length?(0,v.sz)(t,r,o,h,T,{power:"kW"},["mean"]):{},I=b.length?(0,v.sz)(t,r,o,b,M,C,["change"]):{};let z,A,B,U,j,F={},L={};f&&("previous"===f?(A=(0,p.xo)(r,s.e,t.locale,t.config)&&(0,p.xo)(o||new Date,a.c,t.locale,t.config)?(0,p.ol)(r,i.P,t.locale,t.config,-(0,p.EO)(o||new Date,r,_.W,t.locale,t.config)-1):(0,p.ol)(r,u.f,t.locale,t.config,-1*(W+1)),B=(0,c.A)(r,-1)):"yoy"===f&&(A=(0,p.ol)(r,l.e,t.locale,t.config,-1),B=(0,p.ol)(o,l.e,t.locale,t.config,-1)),m.length&&(F=(0,v.sz)(t,A,B,m,M,S,["change"])),b.length&&(L=(0,v.sz)(t,A,B,b,M,C,["change"]))),void 0!==g&&(U=G(t,r,d,g,o,M),f&&(j=G(t,A,d,g,B,M)));const[R,H,J,X,q,K,Q]=await Promise.all([P,O,I,F,L,U,j]);f&&(z={...X,...q});return{start:r,end:o,startCompare:A,endCompare:B,compareMode:f,info:y,prefs:e,stats:{...R,...J,...H},statsMetadata:D,statsCompare:z,co2SignalEntity:g,fossilEnergyConsumption:K,fossilEnergyConsumptionCompare:Q,waterUnit:x,gasUnit:E}},F=t=>{k.forEach(e=>{const r=R(t,{key:e});r.clearPrefs(),r._active&&r.refresh()})},L=t=>{if(t._refreshTimeout&&clearTimeout(t._refreshTimeout),t._active&&(!t.end||t.end>new Date)){const e=new Date;e.getMinutes()>=20&&e.setHours(e.getHours()+1),e.setMinutes(20,0,0),t._refreshTimeout=window.setTimeout(()=>t.refresh(),e.getTime()-Date.now())}},R=(t,e={})=>{let r="_energy";if(e.key){if(!e.key.startsWith("energy_"))throw new Error("Key need to start with energy_");r=`_${e.key}`}if(t.connection[r])return t.connection[r];k.push(e.key);const o=(0,d.X)(t.connection,r,async()=>(o.prefs||(o.prefs=await A(t)),L(o),j(t,o.prefs,o.start,o.end,o.compare))),n=o.subscribe;o.subscribe=t=>{const e=n(t);return o._active++,void 0===o._refreshTimeout&&L(o),()=>{o._active--,o._active<1&&(clearTimeout(o._refreshTimeout),o._refreshTimeout=void 0),e()}},o._active=0,o.prefs=e.prefs;const s=new Date,a=(0,h.LW)(s,t.locale,t.config).split(":")[0],i=localStorage.getItem(`energy-default-period-${r}`)||"today",_="today"===i&&"0"===a?"yesterday":i,[u,c]=(0,w.b)(t,_);o.start=(0,p.ol)(u,f.o,t.locale,t.config),o.end=(0,p.ol)(c,y.D,t.locale,t.config);const l=()=>{o._updatePeriodTimeout=window.setTimeout(()=>{o.start=(0,p.ol)(new Date,f.o,t.locale,t.config),o.end=(0,p.ol)(new Date,y.D,t.locale,t.config),o.refresh(),l()},(0,g.L)((0,p.ol)(new Date,y.D,t.locale,t.config),1).getTime()-Date.now())};return l(),o.clearPrefs=()=>{o.prefs=void 0},o.setPeriod=(e,r)=>{var n;o._updatePeriodTimeout&&(clearTimeout(o._updatePeriodTimeout),o._updatePeriodTimeout=void 0),o.start=e,o.end=r,o.start.getTime()===(0,p.ol)(new Date,f.o,t.locale,t.config).getTime()&&(null===(n=o.end)||void 0===n?void 0:n.getTime())===(0,p.ol)(new Date,y.D,t.locale,t.config).getTime()&&l()},o.setCompare=t=>{o.compare=t},o},H=t=>t.callWS({type:"energy/solar_forecast"}),J=["volume","energy"],X=(t,e,r={})=>{for(const o of t.energy_sources){if("gas"!==o.type)continue;if(e&&e===o.stat_energy_from)continue;const t=r[o.stat_energy_from];if(J.includes(null==t?void 0:t.unit_class))return t.unit_class}},Y=(t,e,r={})=>{if("energy"===X(e,void 0,r))return"kWh";const o=e.energy_sources.filter(t=>"gas"===t.type).map(e=>(0,v.JE)(t,e.stat_energy_from,r[e.stat_energy_from]));if(o.length){const t=o[0];if(v.r_.includes(t)&&o.every(e=>e===t))return t}return"km"===t.config.unit_system.length?"m³":"ft³"},Z=(t,e,r)=>{const o=e.energy_sources.filter(t=>"water"===t.type).map(e=>(0,v.JE)(t,e.stat_energy_from,r[e.stat_energy_from]));if(o.length){const t=o[0];if(v.r_.includes(t)&&o.every(e=>e===t))return t}return"km"===t.config.unit_system.length?"L":"gal"},q="/docs/energy/faq/#troubleshooting-missing-entities",K=(0,m.A)(t=>({summedData:Q(t),compareSummedData:t.statsCompare?Q(t,!0):void 0})),Q=(t,e)=>{const r={};for(const s of t.prefs.energy_sources)if("solar"!==s.type)if("battery"!==s.type){if("grid"===s.type){for(const t of s.flow_from)r.from_grid?r.from_grid.push(t.stat_energy_from):r.from_grid=[t.stat_energy_from];for(const t of s.flow_to)r.to_grid?r.to_grid.push(t.stat_energy_to):r.to_grid=[t.stat_energy_to]}}else r.to_battery?(r.to_battery.push(s.stat_energy_to),r.from_battery.push(s.stat_energy_from)):(r.to_battery=[s.stat_energy_to],r.from_battery=[s.stat_energy_from]);else r.solar?r.solar.push(s.stat_energy_from):r.solar=[s.stat_energy_from];const o={total:{},timestamps:[]},n=new Set;return Object.entries(r).forEach(([r,s])=>{const a={},i={};let _=0;s.forEach(r=>{const o=e?t.statsCompare[r]:t.stats[r];if(!o)return;o.forEach(t=>{if(null===t.change||void 0===t.change)return;const e=t.change;_+=e,a[t.start]=t.start in a?a[t.start]+e:e,n.add(t.start)}),i[r]={}}),o[r]=a,o.total[r]=_}),o.timestamps=Array.from(n).sort(),o},tt=(0,m.A)((t,e)=>({consumption:et(t),compareConsumption:e?et(e):void 0})),et=t=>{const e={used_total:{},grid_to_battery:{},battery_to_grid:{},solar_to_battery:{},solar_to_grid:{},used_solar:{},used_grid:{},used_battery:{},total:{used_total:0,grid_to_battery:0,battery_to_grid:0,solar_to_battery:0,solar_to_grid:0,used_solar:0,used_grid:0,used_battery:0}};return t.timestamps.forEach(r=>{var o,n,s,a,i;const{grid_to_battery:_,battery_to_grid:u,used_solar:c,used_grid:l,used_battery:f,used_total:y,solar_to_battery:g,solar_to_grid:d}=rt({from_grid:t.from_grid&&(null!==(o=t.from_grid[r])&&void 0!==o?o:0),to_grid:t.to_grid&&(null!==(n=t.to_grid[r])&&void 0!==n?n:0),solar:t.solar&&(null!==(s=t.solar[r])&&void 0!==s?s:0),to_battery:t.to_battery&&(null!==(a=t.to_battery[r])&&void 0!==a?a:0),from_battery:t.from_battery&&(null!==(i=t.from_battery[r])&&void 0!==i?i:0)});e.used_total[r]=y,e.total.used_total+=y,e.grid_to_battery[r]=_,e.total.grid_to_battery+=_,e.battery_to_grid[r]=u,e.total.battery_to_grid+=u,e.used_battery[r]=f,e.total.used_battery+=f,e.used_grid[r]=l,e.total.used_grid+=l,e.used_solar[r]=c,e.total.used_solar+=c,e.solar_to_battery[r]=g,e.total.solar_to_battery+=g,e.solar_to_grid[r]=d,e.total.solar_to_grid+=d}),e},rt=t=>{let e=Math.max(t.to_grid||0,0),r=Math.max(t.to_battery||0,0),o=Math.max(t.solar||0,0),n=Math.max(t.from_grid||0,0),s=Math.max(t.from_battery||0,0);const a=(n||0)+(o||0)+(s||0)-(e||0)-(r||0);let i=0,_=0,u=0,c=0,l=0,f=0,y=0,g=Math.max(a,0);const d=Math.max(0,Math.min(r,n-g));_+=d,r-=d,n-=d,c=Math.min(o,r),r-=c,o-=c,l=Math.min(o,e),e-=l,o-=l,u=Math.min(s,e),s-=u,e-=u;const m=Math.min(n,r);return _+=m,n-=m,r-=m,i=Math.min(g,o),g-=i,o-=i,f=Math.min(s,g),s-=f,g-=f,y=Math.min(g,n),n-=y,g-=n,{used_solar:i,used_grid:y,used_battery:f,used_total:a,grid_to_battery:_,battery_to_grid:u,solar_to_battery:c,solar_to_grid:l}},ot=(t,e,r,o)=>{const n=["Wh","kWh","MWh","GWh","TWh"];let s=r,a=e||0,i=-1;o&&(i=n.findIndex(t=>t===o));let _=n.findIndex(t=>t===r);if(_>=0){for(;i>-1?i<_:Math.abs(a)<1&&_>0;)a*=1e3,_--;for(;i>-1?i>_:Math.abs(a)>=1e3&&_<n.length-1;)a/=1e3,_++;s=n[_]}return(0,W.ZV)(a,t.locale,{maximumFractionDigits:Math.abs(a)<10?2:Math.abs(a)<100?1:0})+" "+s},nt=(t,e)=>{if(!e.total.solar)return;const{consumption:r,compareConsumption:o}=tt(e,void 0);if(!t){const t=e.total.solar;return r.total.used_solar/t*100}let n=0,s=0;const a=[];e.timestamps.forEach(t=>{var e,o,i,_;n+=null!==(e=r.used_solar[t])&&void 0!==e?e:0,s+=null!==(o=r.solar_to_grid[t])&&void 0!==o?o:0,r.grid_to_battery[t]&&a.push({type:"grid",value:r.grid_to_battery[t]}),r.solar_to_battery[t]&&a.push({type:"solar",value:r.solar_to_battery[t]});let u=null!==(i=r.battery_to_grid[t])&&void 0!==i?i:0,c=null!==(_=r.used_battery[t])&&void 0!==_?_:0;const l=function(t){const e=a[a.length-1],r=e.type;if(t>=e.value){const t=e.value;return a.pop(),{energy:t,type:r}}return e.value-=t,{energy:t,type:r}};for(;c>0&&a.length;){const{energy:t,type:e}=l(c);"solar"===e&&(n+=t),c-=t}for(;u>0&&a.length;){const{energy:t,type:e}=l(u);"solar"===e&&(s+=t),u-=t}});const i=n+s;return!!i?n/i*100:void 0},st=t=>{if(!t)return;const e=parseFloat(t.state);if(isNaN(e))return;switch(t.attributes.unit_of_measurement){case"W":default:return e;case"kW":return 1e3*e;case"mW":return e/1e3;case"MW":return 1e6*e;case"GW":return 1e9*e;case"TW":return 1e12*e}},at=(t,e)=>{const r=["W","kW","MW","GW","TW"];let o=0,n=e;for(;Math.abs(n)>=1e3&&o<r.length-1;)n/=1e3,o++;return(0,W.ZV)(n,t.locale,{maximumFractionDigits:"W"===r[o]?0:3})+" "+r[o]};function it(t,e,r=!1){const o=(0,n.c)(e||new Date,t);return r?o>64?"day":o>8?"hour":"5minute":(0,s.e)(t)&&(!e||(0,a.c)(e))&&o>35?"month":o>2?"day":"hour"}o()}catch(D){o(D)}})}}]);
//# sourceMappingURL=77183.0b9cae4881d06759.js.map