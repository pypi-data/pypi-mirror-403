export const __rspack_esm_id="77183";export const __rspack_esm_ids=["77183"];export const __webpack_modules__={38114(t,e,r){r.a(t,async function(t,o){try{r.d(e,{AN:()=>U,B2:()=>N,BV:()=>I,DR:()=>Q,E$:()=>G,GW:()=>O,Q4:()=>S,RB:()=>E,TI:()=>nt,WN:()=>A,X4:()=>Z,_d:()=>J,al:()=>R,bs:()=>z,c:()=>P,gv:()=>q,h4:()=>st,lh:()=>T,m7:()=>k,n3:()=>rt,oU:()=>C,pe:()=>ot,t5:()=>at,tb:()=>L,uh:()=>x});r(44114),r(18111),r(81148),r(22489),r(7588),r(61701),r(17642),r(58004),r(33853),r(45876),r(32475),r(15024),r(31698);var s=r(6946),a=r(78016),n=r(31810),_=r(81977),i=r(49134),c=r(92913),l=r(77972),u=r(56434),y=r(35932),g=r(73983),f=r(57279),m=r(35518),d=r(22786),p=r(91069),h=r(30162),b=r(5911),w=r(23528),v=r(46223),W=r(20058),M=t([h,v,p,W]);[h,v,p,W]=M.then?(await M)():M;const D=[],k=()=>({stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),E=()=>({stat_energy_to:"",stat_compensation:null,entity_energy_price:null,number_energy_price:null}),x=()=>({type:"grid",flow_from:[],flow_to:[],cost_adjustment_day:0}),S=()=>({type:"solar",stat_energy_from:"",config_entry_solar_forecast:null}),C=()=>({type:"battery",stat_energy_from:"",stat_energy_to:""}),P=()=>({type:"gas",stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),O=()=>({type:"water",stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),I=t=>t.callWS({type:"energy/info"}),N=async t=>(await t.loadBackendTranslation("issues","energy"),t.callWS({type:"energy/validate"})),z=t=>t.callWS({type:"energy/get_prefs"}),A=async(t,e)=>{const r=t.callWS({type:"energy/save_prefs",...e});return j(t),r},B=async(t,e,r,o,s,a="hour")=>t.callWS({type:"energy/fossil_energy_consumption",start_time:e.toISOString(),end_time:s?.toISOString(),energy_statistic_ids:r,co2_statistic_id:o,period:a}),G=t=>(0,b.$)(t.energy_sources,t=>t.type),U=(t,e,r)=>{const o=[];for(const s of t.energy_sources)if(!r||r.includes(s.type))if("solar"!==s.type){if("gas"===s.type||"water"===s.type){o.push(s.stat_energy_from),s.stat_cost&&o.push(s.stat_cost);const t=e.cost_sensors[s.stat_energy_from];t&&o.push(t);continue}if("battery"!==s.type){for(const t of s.flow_from){o.push(t.stat_energy_from),t.stat_cost&&o.push(t.stat_cost);const r=e.cost_sensors[t.stat_energy_from];r&&o.push(r)}for(const t of s.flow_to){o.push(t.stat_energy_to),t.stat_compensation&&o.push(t.stat_compensation);const r=e.cost_sensors[t.stat_energy_to];r&&o.push(r)}}else o.push(s.stat_energy_from),o.push(s.stat_energy_to)}else o.push(s.stat_energy_from);return r&&!r.includes("device")||o.push(...t.device_consumption.map(t=>t.stat_consumption)),r&&!r.includes("water")||o.push(...t.device_consumption_water.map(t=>t.stat_consumption)),o},V=t=>{const e=[];for(const r of t.energy_sources)"gas"!==r.type&&"water"!==r.type&&("solar"!==r.type&&"battery"!==r.type?r.power&&e.push(...r.power.map(t=>t.stat_rate)):e.push(r.stat_rate));return e.push(...t.device_consumption.map(t=>t.stat_rate)),e.filter(Boolean)};var T=function(t){return t.NONE="",t.PREVIOUS="previous",t.YOY="yoy",t}({});const $=async(t,e,r,o,y)=>{const g=await I(t);let f;for(const e of Object.values(t.entities)){if("co2signal"!==e.platform)continue;const r=t.states[e.entity_id];if(r&&"%"===r.attributes.unit_of_measurement){f=r.entity_id;break}}const m=[];for(const t of e.energy_sources)if("grid"===t.type)for(const e of t.flow_from)m.push(e.stat_energy_from);const d=U(e,g,["grid","solar","battery","gas","device"]),h=V(e),b=U(e,g,["water"]),v=[...d,...b,...h],W=(0,s.c)(o||new Date,r),M=nt(r,o),T=nt(r,o,!0),D={},k=v.length?await(0,w.Wr)(t,v):[];v.length&&k.forEach(t=>{D[t.statistic_id]=t});const E=X(t,e,D),x={energy:"kWh",volume:w.r_.includes(E)?E:void 0},S=Y(t,e,D),C={volume:S},P=d.length?(0,w.sz)(t,r,o,d,M,x,["change"]):{},O=h.length?(0,w.sz)(t,r,o,h,T,{power:"kW"},["mean"]):{},N=b.length?(0,w.sz)(t,r,o,b,M,C,["change"]):{};let z,A,G,$,j,F={},L={};y&&("previous"===y?(A=(0,p.xo)(r,a.e,t.locale,t.config)&&(0,p.xo)(o||new Date,n.c,t.locale,t.config)?(0,p.ol)(r,_.P,t.locale,t.config,-(0,p.EO)(o||new Date,r,i.W,t.locale,t.config)-1):(0,p.ol)(r,c.f,t.locale,t.config,-1*(W+1)),G=(0,l.A)(r,-1)):"yoy"===y&&(A=(0,p.ol)(r,u.e,t.locale,t.config,-1),G=(0,p.ol)(o,u.e,t.locale,t.config,-1)),d.length&&(F=(0,w.sz)(t,A,G,d,M,x,["change"])),b.length&&(L=(0,w.sz)(t,A,G,b,M,C,["change"]))),void 0!==f&&($=B(t,r,m,f,o,M),y&&(j=B(t,A,m,f,G,M)));const[R,H,J,Z,q,K,Q]=await Promise.all([P,O,N,F,L,$,j]);y&&(z={...Z,...q});return{start:r,end:o,startCompare:A,endCompare:G,compareMode:y,info:g,prefs:e,stats:{...R,...J,...H},statsMetadata:D,statsCompare:z,co2SignalEntity:f,fossilEnergyConsumption:K,fossilEnergyConsumptionCompare:Q,waterUnit:S,gasUnit:E}},j=t=>{D.forEach(e=>{const r=L(t,{key:e});r.clearPrefs(),r._active&&r.refresh()})},F=t=>{if(t._refreshTimeout&&clearTimeout(t._refreshTimeout),t._active&&(!t.end||t.end>new Date)){const e=new Date;e.getMinutes()>=20&&e.setHours(e.getHours()+1),e.setMinutes(20,0,0),t._refreshTimeout=window.setTimeout(()=>t.refresh(),e.getTime()-Date.now())}},L=(t,e={})=>{let r="_energy";if(e.key){if(!e.key.startsWith("energy_"))throw new Error("Key need to start with energy_");r=`_${e.key}`}if(t.connection[r])return t.connection[r];D.push(e.key);const o=(0,m.X)(t.connection,r,async()=>(o.prefs||(o.prefs=await z(t)),F(o),$(t,o.prefs,o.start,o.end,o.compare))),s=o.subscribe;o.subscribe=t=>{const e=s(t);return o._active++,void 0===o._refreshTimeout&&F(o),()=>{o._active--,o._active<1&&(clearTimeout(o._refreshTimeout),o._refreshTimeout=void 0),e()}},o._active=0,o.prefs=e.prefs;const a=new Date,n=(0,h.LW)(a,t.locale,t.config).split(":")[0],_=localStorage.getItem(`energy-default-period-${r}`)||"today",i="today"===_&&"0"===n?"yesterday":_,[c,l]=(0,v.b)(t,i);o.start=(0,p.ol)(c,y.o,t.locale,t.config),o.end=(0,p.ol)(l,g.D,t.locale,t.config);const u=()=>{o._updatePeriodTimeout=window.setTimeout(()=>{o.start=(0,p.ol)(new Date,y.o,t.locale,t.config),o.end=(0,p.ol)(new Date,g.D,t.locale,t.config),o.refresh(),u()},(0,f.L)((0,p.ol)(new Date,g.D,t.locale,t.config),1).getTime()-Date.now())};return u(),o.clearPrefs=()=>{o.prefs=void 0},o.setPeriod=(e,r)=>{o._updatePeriodTimeout&&(clearTimeout(o._updatePeriodTimeout),o._updatePeriodTimeout=void 0),o.start=e,o.end=r,o.start.getTime()===(0,p.ol)(new Date,y.o,t.locale,t.config).getTime()&&o.end?.getTime()===(0,p.ol)(new Date,g.D,t.locale,t.config).getTime()&&u()},o.setCompare=t=>{o.compare=t},o},R=t=>t.callWS({type:"energy/solar_forecast"}),H=["volume","energy"],J=(t,e,r={})=>{for(const o of t.energy_sources){if("gas"!==o.type)continue;if(e&&e===o.stat_energy_from)continue;const t=r[o.stat_energy_from];if(H.includes(t?.unit_class))return t.unit_class}},X=(t,e,r={})=>{if("energy"===J(e,void 0,r))return"kWh";const o=e.energy_sources.filter(t=>"gas"===t.type).map(e=>(0,w.JE)(t,e.stat_energy_from,r[e.stat_energy_from]));if(o.length){const t=o[0];if(w.r_.includes(t)&&o.every(e=>e===t))return t}return"km"===t.config.unit_system.length?"m³":"ft³"},Y=(t,e,r)=>{const o=e.energy_sources.filter(t=>"water"===t.type).map(e=>(0,w.JE)(t,e.stat_energy_from,r[e.stat_energy_from]));if(o.length){const t=o[0];if(w.r_.includes(t)&&o.every(e=>e===t))return t}return"km"===t.config.unit_system.length?"L":"gal"},Z="/docs/energy/faq/#troubleshooting-missing-entities",q=(0,d.A)(t=>({summedData:K(t),compareSummedData:t.statsCompare?K(t,!0):void 0})),K=(t,e)=>{const r={};for(const e of t.prefs.energy_sources)if("solar"!==e.type)if("battery"!==e.type){if("grid"===e.type){for(const t of e.flow_from)r.from_grid?r.from_grid.push(t.stat_energy_from):r.from_grid=[t.stat_energy_from];for(const t of e.flow_to)r.to_grid?r.to_grid.push(t.stat_energy_to):r.to_grid=[t.stat_energy_to]}}else r.to_battery?(r.to_battery.push(e.stat_energy_to),r.from_battery.push(e.stat_energy_from)):(r.to_battery=[e.stat_energy_to],r.from_battery=[e.stat_energy_from]);else r.solar?r.solar.push(e.stat_energy_from):r.solar=[e.stat_energy_from];const o={total:{},timestamps:[]},s=new Set;return Object.entries(r).forEach(([r,a])=>{const n={},_={};let i=0;a.forEach(r=>{const o=e?t.statsCompare[r]:t.stats[r];if(!o)return;o.forEach(t=>{if(null===t.change||void 0===t.change)return;const e=t.change;i+=e,n[t.start]=t.start in n?n[t.start]+e:e,s.add(t.start)}),_[r]={}}),o[r]=n,o.total[r]=i}),o.timestamps=Array.from(s).sort(),o},Q=(0,d.A)((t,e)=>({consumption:tt(t),compareConsumption:e?tt(e):void 0})),tt=t=>{const e={used_total:{},grid_to_battery:{},battery_to_grid:{},solar_to_battery:{},solar_to_grid:{},used_solar:{},used_grid:{},used_battery:{},total:{used_total:0,grid_to_battery:0,battery_to_grid:0,solar_to_battery:0,solar_to_grid:0,used_solar:0,used_grid:0,used_battery:0}};return t.timestamps.forEach(r=>{const{grid_to_battery:o,battery_to_grid:s,used_solar:a,used_grid:n,used_battery:_,used_total:i,solar_to_battery:c,solar_to_grid:l}=et({from_grid:t.from_grid&&(t.from_grid[r]??0),to_grid:t.to_grid&&(t.to_grid[r]??0),solar:t.solar&&(t.solar[r]??0),to_battery:t.to_battery&&(t.to_battery[r]??0),from_battery:t.from_battery&&(t.from_battery[r]??0)});e.used_total[r]=i,e.total.used_total+=i,e.grid_to_battery[r]=o,e.total.grid_to_battery+=o,e.battery_to_grid[r]=s,e.total.battery_to_grid+=s,e.used_battery[r]=_,e.total.used_battery+=_,e.used_grid[r]=n,e.total.used_grid+=n,e.used_solar[r]=a,e.total.used_solar+=a,e.solar_to_battery[r]=c,e.total.solar_to_battery+=c,e.solar_to_grid[r]=l,e.total.solar_to_grid+=l}),e},et=t=>{let e=Math.max(t.to_grid||0,0),r=Math.max(t.to_battery||0,0),o=Math.max(t.solar||0,0),s=Math.max(t.from_grid||0,0),a=Math.max(t.from_battery||0,0);const n=(s||0)+(o||0)+(a||0)-(e||0)-(r||0);let _=0,i=0,c=0,l=0,u=0,y=0,g=0,f=Math.max(n,0);const m=Math.max(0,Math.min(r,s-f));i+=m,r-=m,s-=m,l=Math.min(o,r),r-=l,o-=l,u=Math.min(o,e),e-=u,o-=u,c=Math.min(a,e),a-=c,e-=c;const d=Math.min(s,r);return i+=d,s-=d,r-=d,_=Math.min(f,o),f-=_,o-=_,y=Math.min(a,f),a-=y,f-=y,g=Math.min(f,s),s-=g,f-=s,{used_solar:_,used_grid:g,used_battery:y,used_total:n,grid_to_battery:i,battery_to_grid:c,solar_to_battery:l,solar_to_grid:u}},rt=(t,e,r,o)=>{const s=["Wh","kWh","MWh","GWh","TWh"];let a=r,n=e||0,_=-1;o&&(_=s.findIndex(t=>t===o));let i=s.findIndex(t=>t===r);if(i>=0){for(;_>-1?_<i:Math.abs(n)<1&&i>0;)n*=1e3,i--;for(;_>-1?_>i:Math.abs(n)>=1e3&&i<s.length-1;)n/=1e3,i++;a=s[i]}return(0,W.ZV)(n,t.locale,{maximumFractionDigits:Math.abs(n)<10?2:Math.abs(n)<100?1:0})+" "+a},ot=(t,e)=>{if(!e.total.solar)return;const{consumption:r,compareConsumption:o}=Q(e,void 0);if(!t){const t=e.total.solar;return r.total.used_solar/t*100}let s=0,a=0;const n=[];e.timestamps.forEach(t=>{s+=r.used_solar[t]??0,a+=r.solar_to_grid[t]??0,r.grid_to_battery[t]&&n.push({type:"grid",value:r.grid_to_battery[t]}),r.solar_to_battery[t]&&n.push({type:"solar",value:r.solar_to_battery[t]});let e=r.battery_to_grid[t]??0,o=r.used_battery[t]??0;const _=function(t){const e=n[n.length-1],r=e.type;if(t>=e.value){const t=e.value;return n.pop(),{energy:t,type:r}}return e.value-=t,{energy:t,type:r}};for(;o>0&&n.length;){const{energy:t,type:e}=_(o);"solar"===e&&(s+=t),o-=t}for(;e>0&&n.length;){const{energy:t,type:r}=_(e);"solar"===r&&(a+=t),e-=t}});const _=s+a;return!!_?s/_*100:void 0},st=t=>{if(!t)return;const e=parseFloat(t.state);if(isNaN(e))return;switch(t.attributes.unit_of_measurement){case"W":default:return e;case"kW":return 1e3*e;case"mW":return e/1e3;case"MW":return 1e6*e;case"GW":return 1e9*e;case"TW":return 1e12*e}},at=(t,e)=>{const r=["W","kW","MW","GW","TW"];let o=0,s=e;for(;Math.abs(s)>=1e3&&o<r.length-1;)s/=1e3,o++;return(0,W.ZV)(s,t.locale,{maximumFractionDigits:"W"===r[o]?0:3})+" "+r[o]};function nt(t,e,r=!1){const o=(0,s.c)(e||new Date,t);return r?o>64?"day":o>8?"hour":"5minute":(0,a.e)(t)&&(!e||(0,n.c)(e))&&o>35?"month":o>2?"day":"hour"}o()}catch(_t){o(_t)}})}};
//# sourceMappingURL=77183.5d12bccc75eecd9d.js.map