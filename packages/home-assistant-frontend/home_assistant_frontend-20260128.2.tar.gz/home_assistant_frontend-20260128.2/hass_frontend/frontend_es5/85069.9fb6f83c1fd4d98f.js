"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([["85069"],{41436:function(e,a,t){t.a(e,async function(e,s){try{t.r(a);t(74423),t(44114),t(72712),t(26910),t(13609),t(18111),t(22489),t(7588),t(18237),t(42762),t(62953);var r=t(40445),o=t(96196),i=t(77845),n=t(94333),l=(t(76776),t(67094),t(38114)),c=t(23528),u=t(54706),h=t(3609),d=t(90433),_=t(20058),p=t(28455),v=t(48949),f=e([h,l,c,_]);[h,l,c,_]=f.then?(await f)():f;let g,y,m,b,x,$=e=>e;const k={group_by_floor:!0,group_by_area:!0};class w extends((0,u.E)((0,v.Q)(o.WF))){setConfig(e){this._config=Object.assign(Object.assign({},k),e)}hassSubscribe(){var e;return[(0,l.tb)(this.hass,{key:null===(e=this._config)||void 0===e?void 0:e.collection_key}).subscribe(e=>{this._data=e})]}getCardSize(){return 5}getGridOptions(){return{columns:12,min_columns:6,rows:6,min_rows:2}}shouldUpdate(e){return e.has("_config")||e.has("_data")||e.has("_isMobileSize")}render(){if(!this._config)return o.s6;if(!this._data)return(0,o.qy)(g||(g=$`${0}`),this.hass.localize("ui.panel.lovelace.cards.energy.loading"));const e=this._data.prefs,a=e.energy_sources.filter(e=>"water"===e.type),t=getComputedStyle(this),s=[],r=[],i=e.device_consumption_water.reduce((e,a)=>e+(a.stat_consumption in this._data.stats&&(0,c.$j)(this._data.stats[a.stat_consumption])||0),0),l=a.reduce((e,a)=>e+(a.stat_energy_from in this._data.stats&&(0,c.$j)(this._data.stats[a.stat_energy_from])||0),0),u=Math.max(i,l),h={id:"home",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.home"),value:Math.max(0,u),color:t.getPropertyValue("--primary-color").trim(),index:1};s.push(h);const _=t.getPropertyValue("--energy-water-color").trim();a.forEach(e=>{if("water"!==e.type)return;const a=e.stat_energy_from in this._data.stats&&(0,c.$j)(this._data.stats[e.stat_energy_from])||0;a<.01||(s.push({id:e.stat_energy_from,label:(0,c.$O)(this.hass,e.stat_energy_from,this._data.statsMetadata[e.stat_energy_from]),value:a,color:_,index:0}),r.push({source:e.stat_energy_from,target:"home",value:a}))});let p=h.value;const v=[],f={};e.device_consumption_water.forEach((e,a)=>{const s=e.stat_consumption in this._data.stats&&(0,c.$j)(this._data.stats[e.stat_consumption])||0;if(s<.01)return;const o={id:e.stat_consumption,label:e.name||(0,c.$O)(this.hass,e.stat_consumption,this._data.statsMetadata[e.stat_consumption]),value:s,color:(0,d.fI)(a,t),index:4,parent:e.included_in_stat};o.parent?(f[o.id]=o.parent,r.push({source:o.parent,target:o.id})):p-=s,v.push(o)});const x=v.filter(e=>!f[e.id]),{group_by_area:k,group_by_floor:w}=this._config;if(k||w){const{areas:e,floors:a}=this._groupByFloorAndArea(x);Object.keys(a).sort((e,a)=>{var t,s,r,o;return(null!==(t=null===(s=this.hass.floors[a])||void 0===s?void 0:s.level)&&void 0!==t?t:-1/0)-(null!==(r=null===(o=this.hass.floors[e])||void 0===o?void 0:o.level)&&void 0!==r?r:-1/0)}).forEach(o=>{let i=`floor_${o}`;"no_floor"!==o&&w?(s.push({id:i,label:this.hass.floors[o].name,value:a[o].value,index:2,color:t.getPropertyValue("--primary-color").trim()}),r.push({source:"home",target:i})):i="home",a[o].areas.forEach(a=>{let o;if("no_area"!==a&&k){const n=`area_${a}`;s.push({id:n,label:this.hass.areas[a].name,value:e[a].value,index:3,color:t.getPropertyValue("--primary-color").trim()}),r.push({source:i,target:n,value:e[a].value}),o=n}else o=i;e[a].devices.forEach(e=>{r.push({source:o,target:e.id,value:e.value})})})})}else x.forEach(e=>{r.push({source:"home",target:e.id,value:e.value})});const E=this._getDeviceSections(f,v);E.forEach((e,a)=>{e.forEach(e=>{s.push(Object.assign(Object.assign({},e),{},{index:4+a}))})}),p>0&&(s.push({id:"untracked",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_devices_detail_graph.untracked_consumption"),value:p,color:t.getPropertyValue("--state-unavailable-color").trim(),index:3+E.length}),r.push({source:"home",target:"untracked",value:p}));const j=s.some(e=>e.value>0),C="vertical"===this._config.layout||"horizontal"!==this._config.layout&&this._isMobileSize;return(0,o.qy)(y||(y=$` <ha-card .header="${0}" class="${0}"> <div class="card-content"> ${0} </div> </ha-card> `),this._config.title,(0,n.H)({"is-grid":"grid"===this.layout,"is-panel":"panel"===this.layout,"is-vertical":C}),j?(0,o.qy)(m||(m=$`<ha-sankey-chart .data="${0}" .vertical="${0}" .valueFormatter="${0}"></ha-sankey-chart>`),{nodes:s,links:r},C,this._valueFormatter):(0,o.qy)(b||(b=$`${0}`),this.hass.localize("ui.panel.lovelace.cards.energy.no_data_period")))}_groupByFloorAndArea(e){const a={no_area:{value:0,devices:[]}},t={no_floor:{value:0,areas:["no_area"]}};return e.forEach(e=>{const s=this.hass.states[e.id],{area:r,floor:o}=s?(0,p.l)(s,this.hass.entities,this.hass.devices,this.hass.areas,this.hass.floors):{area:null,floor:null};r?(r.area_id in a?(a[r.area_id].value+=e.value,a[r.area_id].devices.push(e)):a[r.area_id]={value:e.value,devices:[e]},o?o.floor_id in t?(t[o.floor_id].value+=e.value,t[o.floor_id].areas.includes(r.area_id)||t[o.floor_id].areas.push(r.area_id)):t[o.floor_id]={value:e.value,areas:[r.area_id]}:(t.no_floor.value+=e.value,t.no_floor.areas.includes(r.area_id)||t.no_floor.areas.unshift(r.area_id))):(a.no_area.value+=e.value,a.no_area.devices.push(e))}),{areas:a,floors:t}}_getDeviceSections(e,a){const t=[],s=[],r=Object.values(e),o={};return a.forEach(a=>{const o=a.id in e;r.includes(a.id)&&!o?t.push(a):s.push(a)}),Object.entries(e).forEach(([e,a])=>{t.some(e=>e.id===a)||(o[e]=a)}),t.length>0?[t,...this._getDeviceSections(o,s)]:[a]}constructor(...e){super(...e),this.hassSubscribeRequiredHostProps=["_config"],this._valueFormatter=e=>`${(0,_.ZV)(e,this.hass.locale,e<.1?{maximumFractionDigits:3}:void 0)} ${this._data.waterUnit}`}}w.styles=(0,o.AH)(x||(x=$`ha-card{height:400px;display:flex;flex-direction:column;--chart-max-height:none}ha-card.is-vertical{height:500px}ha-card.is-grid,ha-card.is-panel{height:100%}.card-content{flex:1;display:flex}`)),(0,r.Cg)([(0,i.MZ)({attribute:!1})],w.prototype,"hass",void 0),(0,r.Cg)([(0,i.MZ)({attribute:!1})],w.prototype,"layout",void 0),(0,r.Cg)([(0,i.wk)()],w.prototype,"_config",void 0),(0,r.Cg)([(0,i.wk)()],w.prototype,"_data",void 0),w=(0,r.Cg)([(0,i.EM)("hui-water-sankey-card")],w),s()}catch(g){s(g)}})}}]);
//# sourceMappingURL=85069.9fb6f83c1fd4d98f.js.map