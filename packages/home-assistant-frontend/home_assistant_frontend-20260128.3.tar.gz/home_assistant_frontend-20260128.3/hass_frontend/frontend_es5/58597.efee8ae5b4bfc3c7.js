"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([["58597"],{31396:function(e,a,t){t.a(e,async function(e,r){try{t.r(a);t(74423),t(44114),t(26910),t(13609),t(18111),t(7588),t(42762),t(62953);var o=t(40445),s=t(96196),i=t(77845),l=t(94333),n=(t(76776),t(67094),t(38114)),u=t(23528),c=t(54706),d=t(3609),h=t(90433),_=t(20058),g=t(28455),v=t(48949),p=e([d,n,u,_]);[d,n,u,_]=p.then?(await p)():p;let y,f,b,m,x,k=e=>e;const $={group_by_floor:!0,group_by_area:!0};class z extends((0,c.E)((0,v.Q)(s.WF))){setConfig(e){this._config=Object.assign(Object.assign({},$),e)}hassSubscribe(){var e;return[(0,n.tb)(this.hass,{key:null===(e=this._config)||void 0===e?void 0:e.collection_key}).subscribe(e=>{this._data=e})]}getCardSize(){return 5}getGridOptions(){return{columns:12,min_columns:6,rows:6,min_rows:2}}shouldUpdate(e){return e.has("_config")||e.has("_data")||e.has("_isMobileSize")}render(){if(!this._config)return s.s6;if(!this._data)return(0,s.qy)(y||(y=k`${0}`),this.hass.localize("ui.panel.lovelace.cards.energy.loading"));const e=this._data.prefs,a=(0,n.E$)(e),{summedData:t,compareSummedData:r}=(0,n.gv)(this._data),{consumption:o,compareConsumption:i}=(0,n.DR)(t,void 0),c=getComputedStyle(this),d=[],_=[],g={id:"home",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.home"),value:Math.max(0,o.total.used_total),color:c.getPropertyValue("--primary-color").trim(),index:1};if(d.push(g),a.battery){var v,p;const e=null!==(v=t.total.from_battery)&&void 0!==v?v:0,a=null!==(p=t.total.to_battery)&&void 0!==p?p:0;d.push({id:"battery",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.battery"),value:e,color:c.getPropertyValue("--energy-battery-out-color").trim(),index:0}),_.push({source:"battery",target:"home",value:o.total.used_battery}),d.push({id:"battery_in",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.battery"),value:a,color:c.getPropertyValue("--energy-battery-in-color").trim(),index:1}),o.total.grid_to_battery>0&&_.push({source:"grid",target:"battery_in",value:o.total.grid_to_battery}),o.total.solar_to_battery>0&&_.push({source:"solar",target:"battery_in",value:o.total.solar_to_battery})}if(a.grid){var x;const e=null!==(x=t.total.from_grid)&&void 0!==x?x:0;d.push({id:"grid",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.grid"),value:e,color:c.getPropertyValue("--energy-grid-consumption-color").trim(),index:0}),_.push({source:"grid",target:"home",value:o.total.used_grid})}if(a.solar){var $;const e=null!==($=t.total.solar)&&void 0!==$?$:0;d.push({id:"solar",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.solar"),value:e,color:c.getPropertyValue("--energy-solar-color").trim(),index:0}),_.push({source:"solar",target:"home",value:o.total.used_solar})}if(a.grid&&a.grid[0].flow_to){var z;const e=null!==(z=t.total.to_grid)&&void 0!==z?z:0;d.push({id:"grid_return",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.grid"),value:e,color:c.getPropertyValue("--energy-grid-return-color").trim(),index:1}),o.total.battery_to_grid>0&&_.push({source:"battery",target:"grid_return",value:o.total.battery_to_grid}),o.total.solar_to_grid>0&&_.push({source:"solar",target:"grid_return",value:o.total.solar_to_grid})}let E=g.value;const C=[],P={};e.device_consumption.forEach((e,a)=>{const t=e.stat_consumption in this._data.stats&&(0,u.$j)(this._data.stats[e.stat_consumption])||0;if(t<.01)return;const r={id:e.stat_consumption,label:e.name||(0,u.$O)(this.hass,e.stat_consumption,this._data.statsMetadata[e.stat_consumption]),value:t,color:(0,h.fI)(a,c),index:4,parent:e.included_in_stat};r.parent?(P[r.id]=r.parent,_.push({source:r.parent,target:r.id})):E-=t,C.push(r)});const S=C.filter(e=>!P[e.id]),{group_by_area:V,group_by_floor:O}=this._config;if(V||O){const{areas:e,floors:a}=this._groupByFloorAndArea(S);Object.keys(a).sort((e,a)=>{var t,r,o,s;return(null!==(t=null===(r=this.hass.floors[a])||void 0===r?void 0:r.level)&&void 0!==t?t:-1/0)-(null!==(o=null===(s=this.hass.floors[e])||void 0===s?void 0:s.level)&&void 0!==o?o:-1/0)}).forEach(t=>{let r=`floor_${t}`;"no_floor"!==t&&O?(d.push({id:r,label:this.hass.floors[t].name,value:a[t].value,index:2,color:c.getPropertyValue("--primary-color").trim()}),_.push({source:"home",target:r})):r="home",a[t].areas.forEach(a=>{let t;if("no_area"!==a&&V){const o=`area_${a}`;d.push({id:o,label:this.hass.areas[a].name,value:e[a].value,index:3,color:c.getPropertyValue("--primary-color").trim()}),_.push({source:r,target:o,value:e[a].value}),t=o}else t=r;e[a].devices.forEach(e=>{_.push({source:t,target:e.id,value:e.value})})})})}else S.forEach(e=>{_.push({source:"home",target:e.id,value:e.value})});const j=this._getDeviceSections(P,C);j.forEach((e,a)=>{e.forEach(e=>{d.push(Object.assign(Object.assign({},e),{},{index:4+a}))})}),E>0&&(d.push({id:"untracked",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_devices_detail_graph.untracked_consumption"),value:E,color:c.getPropertyValue("--state-unavailable-color").trim(),index:3+j.length}),_.push({source:"home",target:"untracked",value:E}));const w=d.some(e=>e.value>0),D="vertical"===this._config.layout||"horizontal"!==this._config.layout&&this._isMobileSize;return(0,s.qy)(f||(f=k` <ha-card .header="${0}" class="${0}"> <div class="card-content"> ${0} </div> </ha-card> `),this._config.title,(0,l.H)({"is-grid":"grid"===this.layout,"is-panel":"panel"===this.layout,"is-vertical":D}),w?(0,s.qy)(b||(b=k`<ha-sankey-chart .data="${0}" .vertical="${0}" .valueFormatter="${0}"></ha-sankey-chart>`),{nodes:d,links:_},D,this._valueFormatter):(0,s.qy)(m||(m=k`${0}`),this.hass.localize("ui.panel.lovelace.cards.energy.no_data_period")))}_groupByFloorAndArea(e){const a={no_area:{value:0,devices:[]}},t={no_floor:{value:0,areas:["no_area"]}};return e.forEach(e=>{const r=this.hass.states[e.id],{area:o,floor:s}=r?(0,g.l)(r,this.hass.entities,this.hass.devices,this.hass.areas,this.hass.floors):{area:null,floor:null};o?(o.area_id in a?(a[o.area_id].value+=e.value,a[o.area_id].devices.push(e)):a[o.area_id]={value:e.value,devices:[e]},s?s.floor_id in t?(t[s.floor_id].value+=e.value,t[s.floor_id].areas.includes(o.area_id)||t[s.floor_id].areas.push(o.area_id)):t[s.floor_id]={value:e.value,areas:[o.area_id]}:(t.no_floor.value+=e.value,t.no_floor.areas.includes(o.area_id)||t.no_floor.areas.unshift(o.area_id))):(a.no_area.value+=e.value,a.no_area.devices.push(e))}),{areas:a,floors:t}}_getDeviceSections(e,a){const t=[],r=[],o=Object.values(e),s={};return a.forEach(a=>{const s=a.id in e;o.includes(a.id)&&!s?t.push(a):r.push(a)}),Object.entries(e).forEach(([e,a])=>{t.some(e=>e.id===a)||(s[e]=a)}),t.length>0?[t,...this._getDeviceSections(s,r)]:[a]}constructor(...e){super(...e),this.hassSubscribeRequiredHostProps=["_config"],this._valueFormatter=e=>`<div style="direction:ltr; display: inline;">\n      ${(0,_.ZV)(e,this.hass.locale,e<.1?{maximumFractionDigits:3}:void 0)}\n      kWh</div>`}}z.styles=(0,s.AH)(x||(x=k`ha-card{height:400px;display:flex;flex-direction:column;--chart-max-height:none}ha-card.is-vertical{height:500px}ha-card.is-grid,ha-card.is-panel{height:100%}.card-content{flex:1;display:flex}`)),(0,o.Cg)([(0,i.MZ)({attribute:!1})],z.prototype,"hass",void 0),(0,o.Cg)([(0,i.MZ)({attribute:!1})],z.prototype,"layout",void 0),(0,o.Cg)([(0,i.wk)()],z.prototype,"_config",void 0),(0,o.Cg)([(0,i.wk)()],z.prototype,"_data",void 0),z=(0,o.Cg)([(0,i.EM)("hui-energy-sankey-card")],z),r()}catch(y){r(y)}})}}]);
//# sourceMappingURL=58597.efee8ae5b4bfc3c7.js.map