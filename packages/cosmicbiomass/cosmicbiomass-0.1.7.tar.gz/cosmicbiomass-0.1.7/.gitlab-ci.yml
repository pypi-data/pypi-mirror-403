stages:
  - test
  - build
  - publish

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.uv-cache"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  UV_PYTHON: "python3.12"
  UV_PYTHON_PREFERENCE: "only-system"
  UV_PYTHON_DOWNLOAD: "0"

default:
  image: python:3.12-slim
  tags:
    - hifis-linux-small-amd64
    - dind
    - hifis
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git libexpat1 && rm -rf /var/lib/apt/lists/*
    - python -m pip install --upgrade pip uv

cache:
  key: "uv-cache"
  paths:
    - .uv-cache/
    - .cache/pip/

pytest:
  stage: test
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - when: on_success
  script:
    - uv sync --group dev --frozen
    - uv run ruff check .
    - uv run pytest

build:
  stage: build
  script:
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
        TAG_VERSION=${CI_COMMIT_TAG#v}
        if [ "$TAG_VERSION" != "$VERSION" ]; then
          echo "Tag version ($TAG_VERSION) does not match pyproject.toml ($VERSION)."
          exit 1
        fi
      fi
    - uv build
    - uv publish --dry-run dist/*.whl dist/*.tar.gz
  artifacts:
    paths:
      - dist/
    expire_in: 7 days

publish_testpypi:
  stage: publish
  needs:
    - job: build
      artifacts: true
  dependencies:
    - build
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+a\d+$/'
  script:
    - ls -la dist
    - uv publish --publish-url https://test.pypi.org/legacy/ --token "$TESTPYPI_TOKEN" dist/*.whl dist/*.tar.gz

publish_pypi:
  stage: publish
  needs:
    - job: build
      artifacts: true
  dependencies:
    - build
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  script:
    - ls -la dist
    - uv publish --token "$PYPI_TOKEN" dist/*.whl dist/*.tar.gz
