"""
Explanation Generator for Conductor Handoff.

Auto-generates human-readable markdown explanations
for completed handoff tasks.
"""
from datetime import datetime
from typing import Optional

from conductor.handoff.schema import TaskFile, ResultFile, TaskStatus


def generate_explanation(
    task: TaskFile,
    result: ResultFile,
    historical_success_count: int = 0,
) -> str:
    """
    Generate a markdown explanation from task and result.
    
    Args:
        task: The original task file
        result: The execution result
        historical_success_count: Number of similar successful tasks (optional)
    
    Returns:
        Markdown string explaining the change
    """
    lines = []
    
    # Header
    lines.append(f"# Task Explanation: {task.task_id}")
    lines.append("")
    
    # Summary
    lines.append("## Summary")
    lines.append("")
    if result.summary:
        lines.append(result.summary)
    else:
        lines.append(_generate_summary(result))
    lines.append("")
    
    # What Changed
    lines.append("## What Changed")
    lines.append("")
    if result.files_changed:
        lines.append("| File | Action | Lines |")
        lines.append("|------|--------|-------|")
        for change in result.files_changed:
            file_path = change.path if hasattr(change, 'path') else change.get('path', 'unknown')
            action = change.action if hasattr(change, 'action') else change.get('action', 'unknown')
            added = change.lines_added if hasattr(change, 'lines_added') else change.get('lines_added', 0)
            removed = change.lines_removed if hasattr(change, 'lines_removed') else change.get('lines_removed', 0)
            lines.append(f"| `{file_path}` | {action} | +{added}, -{removed} |")
        lines.append("")
        lines.append(f"**Total:** +{result.total_lines_added}, -{result.total_lines_removed} lines")
    else:
        lines.append("No file changes recorded.")
    lines.append("")
    
    # Constraints
    lines.append("## Constraints")
    lines.append("")
    if result.status == TaskStatus.DONE:
        lines.append("✓ All constraints satisfied")
    elif result.status == TaskStatus.PARTIAL:
        lines.append("⚠ Partial completion — some constraints may not apply")
    elif result.status == TaskStatus.FAILED:
        lines.append("✗ Task failed — constraint check incomplete")
        if result.error:
            lines.append(f"  - Error: {result.error}")
    lines.append("")
    
    # Execution
    lines.append("## Execution")
    lines.append("")
    lines.append(f"- **Status:** {result.status.value}")
    lines.append(f"- **Duration:** {result.execution_time_ms}ms")
    lines.append(f"- **Completed:** {result.completed_at.isoformat() if hasattr(result.completed_at, 'isoformat') else result.completed_at}")
    lines.append("")
    
    # Context (if available)
    if task.context:
        lines.append("## Context")
        lines.append("")
        for key, value in task.context.items():
            lines.append(f"- **{key}:** {value}")
        lines.append("")
    
    # Historical
    if historical_success_count > 0:
        lines.append("## Historical")
        lines.append("")
        lines.append(f"Similar tasks succeeded {historical_success_count} time(s) previously.")
        lines.append("")
    
    # Notes
    if result.notes:
        lines.append("## Notes")
        lines.append("")
        lines.append(result.notes)
        lines.append("")
    
    # Footer
    lines.append("---")
    lines.append(f"*Generated by Conductor at {datetime.utcnow().isoformat()}*")
    
    return "\n".join(lines)


def _generate_summary(result: ResultFile) -> str:
    """Generate a summary from result data when no explicit summary provided."""
    if not result.files_changed:
        return "Task completed with no file changes."
    
    actions = {}
    for change in result.files_changed:
        action = change.action if hasattr(change, 'action') else change.get('action', 'modified')
        actions[action] = actions.get(action, 0) + 1
    
    parts = []
    for action, count in actions.items():
        if count == 1:
            parts.append(f"{action} 1 file")
        else:
            parts.append(f"{action} {count} files")
    
    return f"Task completed: {', '.join(parts)}."
