id: user-dir
title: "Create user and ensure directory exists (idempotent)"
stack: ansible
difficulty: Hard
xp: 150

goal: "Ensure user and filesystem state using an idempotent Ansible playbook"

skills:
  - ansible-idempotency
  - user-management
  - file-system-management
  - state-management

hint: "Focus on desired state and idempotency rather than one-time commands."

validator: "validator.py"

mentor:
  why: >
    This lab reinforces idempotent automation by managing users and
    filesystem state, which is critical for reliable infrastructure
    configuration at scale.
  intent: stretch
  guidance:
    before: |
      Consider how Ansible determines whether a change is required
      and how state is enforced declaratively.

      Optional manual testing (not required for validation):
      - ansible-playbook playbook.yml
      - ansible-playbook playbook.yml --check
    after: >
      Reflect on how ownership and permissions affect system safety and
      repeatability.
  tags:
    - ansible
    - idempotency
    - user-management
    - filesystem

solution:
  overview: >
    This solution evaluates whether infrastructure automation reflects
    declarative, idempotent system design rather than procedural command
    execution. The emphasis is on expressing desired state clearly and
    safely across repeated runs, even on partially configured systems.

  professional_reasoning:
    - Express user creation declaratively rather than imperatively
    - Enforce directory state explicitly instead of assuming defaults
    - Treat ownership and permissions as part of the desired state
    - Ensure tasks are safe to run repeatedly without side effects

  real_world_context:
    - Avoid ordering tricks or conditional execution hacks
    - Do not rely on command or shell modules
    - Do not assume a clean or preconfigured system
    - Maintain clear separation between user state and filesystem state
    - Prefer explicit state declaration over implicit defaults
    - Preserve idempotency across repeated runs

execution:
  runtime: docker
  requires_execution: false
  required_tools:
    - ansible-playbook
