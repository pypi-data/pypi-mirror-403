
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Cookbook &#8212; Alembic 1.18.3 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/changelog.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx_paramlinks.css" />
    <link rel="stylesheet" type="text/css" href="_static/site_custom_css.css?v=54a89d43" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=3388b72f"></script>
    <script src="_static/doctools.js?v=fd6eb6e6"></script>
    <script src="_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=046fa432"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'cookbook';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Details" href="api/index.html" />
    <link rel="prev" title="Operation Reference" href="ops.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Alembic 1.18.3 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/sqlalchemy/alembic" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/alembic/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="https://img.shields.io/pypi/dw/alembic" class="icon-link-image" alt="PyPI"/></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="front.html">Front Matter</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="autogenerate.html">Auto Generating Migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="offline.html">Generating SQL Scripts (a.k.a. “Offline Mode”)</a></li>
<li class="toctree-l1"><a class="reference internal" href="naming.html">The Importance of Naming Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="batch.html">Running “Batch” Migrations for SQLite and Other Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="branches.html">Working with Branches</a></li>
<li class="toctree-l1"><a class="reference internal" href="ops.html">Operation Reference</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Cookbook</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="api/index.html">API Details</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="api/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/runtime.html">Runtime Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/config.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/commands.html">Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/operations.html">Operation Directives</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/autogenerate.html">Autogeneration</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/script.html">Script Directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/ddl.html">DDL Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/plugins.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/exceptions.html">Exception Objects</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/cookbook.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Cookbook</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-an-up-to-date-database-from-scratch">Building an Up to Date Database from Scratch</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conditional-migration-elements">Conditional Migration Elements</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sharing-a-connection-across-one-or-more-programmatic-migration-commands">Sharing a Connection across one or more programmatic migration commands</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#replaceable-objects">Replaceable Objects</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-replaceable-object-structure">The Replaceable Object Structure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-operations-for-the-target-objects">Create Operations for the Target Objects</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#publish-the-extensions">Publish the Extensions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-initial-migrations">Create Initial Migrations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-revision-migrations">Create Revision Migrations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rudimental-schema-level-multi-tenancy-for-postgresql-mysql-other-databases">Rudimental Schema-Level Multi Tenancy for PostgreSQL, MySQL, Other Databases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#don-t-generate-empty-migrations-with-autogenerate">Don’t Generate Empty Migrations with Autogenerate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#don-t-emit-drop-index-when-the-table-is-to-be-dropped-as-well">Don’t emit DROP INDEX when the table is to be dropped as well</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#don-t-generate-any-drop-table-directives-with-autogenerate">Don’t generate any DROP TABLE directives with autogenerate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-custom-sorting-to-table-columns-within-create-table">Apply Custom Sorting to Table Columns within CREATE TABLE</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-if-not-exists-to-create-drop-operations">Add IF [NOT] EXISTS to CREATE/DROP operations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#don-t-emit-create-table-statements-for-views">Don’t emit CREATE TABLE statements for Views</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-multiple-alembic-environments-from-one-ini-file">Run Multiple Alembic Environments from one .ini file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#print-python-code-to-generate-particular-database-tables">Print Python Code to Generate Particular Database Tables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-alembic-operation-objects-directly-as-in-from-autogenerate">Run Alembic Operation Objects Directly (as in from autogenerate)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-current-database-revision-is-at-head-s">Test current database revision is at head(s)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-asyncio-with-alembic">Using Asyncio with Alembic</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#programmatic-api-use-connection-sharing-with-asyncio">Programmatic API use (connection sharing) With Asyncio</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-migrations-general-techniques">Data Migrations - General Techniques</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-data">Small data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#separate-migration-script">Separate migration script</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#online-migration">Online migration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extend-commandline-with-custom-commands">Extend <code class="docutils literal notranslate"><span class="pre">CommandLine</span></code> with custom commands</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="cookbook">
<h1>Cookbook<a class="headerlink" href="#cookbook" title="Link to this heading">#</a></h1>
<p>A collection of “How-Tos” highlighting popular ways to extend
Alembic.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a new section where we catalogue various “how-tos”
based on user requests.  It is often the case that users
will request a feature only to learn it can be provided with
a simple customization.</p>
</div>
<section id="building-an-up-to-date-database-from-scratch">
<span id="building-uptodate"></span><h2>Building an Up to Date Database from Scratch<a class="headerlink" href="#building-an-up-to-date-database-from-scratch" title="Link to this heading">#</a></h2>
<p>There’s a theory of database migrations that says that the revisions in existence for a database should be
able to go from an entirely blank schema to the finished product, and back again.   Alembic can roll
this way.   Though we think it’s kind of overkill, considering that SQLAlchemy itself can emit
the full CREATE statements for any given model using <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/metadata.html#sqlalchemy.schema.MetaData.create_all" title="(in SQLAlchemy v2.1)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_all()</span></code></a>.   If you check out
a copy of an application, running this will give you the entire database in one shot, without the need
to run through all those migration files, which are instead tailored towards applying incremental
changes to an existing database.</p>
<p>Alembic can integrate with a <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/metadata.html#sqlalchemy.schema.MetaData.create_all" title="(in SQLAlchemy v2.1)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_all()</span></code></a> script quite easily.  After running the
create operation, tell Alembic to create a new version table, and to stamp it with the most recent
revision (i.e. <code class="docutils literal notranslate"><span class="pre">head</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># inside of a &quot;create the database&quot; script, first create</span>
<span class="c1"># tables:</span>
<span class="n">my_metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="c1"># then, load the Alembic configuration and generate the</span>
<span class="c1"># version table, &quot;stamping&quot; it with the most recent rev:</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">command</span>
<span class="n">alembic_cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="s2">&quot;/path/to/yourapp/alembic.ini&quot;</span><span class="p">)</span>
<span class="n">command</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">alembic_cfg</span><span class="p">,</span> <span class="s2">&quot;head&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>When this approach is used, the application can generate the database using normal SQLAlchemy
techniques instead of iterating through hundreds of migration scripts.   Now, the purpose of the
migration scripts is relegated just to movement between versions on out-of-date databases, not
<em>new</em> databases.    You can now remove old migration files that are no longer represented
on any existing environments.</p>
<p>To prune old migration files, simply delete the files.   Then, in the earliest, still-remaining
migration file, set <code class="docutils literal notranslate"><span class="pre">down_revision</span></code> to <code class="docutils literal notranslate"><span class="pre">None</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># replace this:</span>
<span class="c1">#down_revision = &#39;290696571ad2&#39;</span>

<span class="c1"># with this:</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>That file now becomes the “base” of the migration series.</p>
</section>
<section id="conditional-migration-elements">
<h2>Conditional Migration Elements<a class="headerlink" href="#conditional-migration-elements" title="Link to this heading">#</a></h2>
<p>This example features the basic idea of a common need, that of affecting
how a migration runs based on command line switches.</p>
<p>The technique to use here is simple; within a migration script, inspect
the <a class="reference internal" href="api/runtime.html#alembic.runtime.environment.EnvironmentContext.get_x_argument" title="alembic.runtime.environment.EnvironmentContext.get_x_argument"><code class="xref py py-meth docutils literal notranslate"><span class="pre">EnvironmentContext.get_x_argument()</span></code></a> collection for any additional,
user-defined parameters.  Then take action based on the presence of those
arguments.</p>
<p>To make it such that the logic to inspect these flags is easy to use and
modify, we modify our <code class="docutils literal notranslate"><span class="pre">script.py.mako</span></code> template to make this feature
available in all new revision files:</p>
<div class="highlight-mako notranslate"><div class="highlight"><pre><span></span><span class="x">&quot;&quot;&quot;</span><span class="cp">${</span><span class="n">message</span><span class="cp">}</span>

<span class="x">Revision ID: </span><span class="cp">${</span><span class="n">up_revision</span><span class="cp">}</span>
<span class="x">Revises: </span><span class="cp">${</span><span class="n">down_revision</span><span class="cp">}</span>
<span class="x">Create Date: </span><span class="cp">${</span><span class="n">create_date</span><span class="cp">}</span>

<span class="x">&quot;&quot;&quot;</span>

<span class="x"># revision identifiers, used by Alembic.</span>
<span class="x">revision = </span><span class="cp">${</span><span class="nb">repr</span><span class="p">(</span><span class="n">up_revision</span><span class="p">)</span><span class="cp">}</span>
<span class="x">down_revision = </span><span class="cp">${</span><span class="nb">repr</span><span class="p">(</span><span class="n">down_revision</span><span class="p">)</span><span class="cp">}</span>

<span class="x">from alembic import op</span>
<span class="x">import sqlalchemy as sa</span>
<span class="cp">${</span><span class="n">imports</span> <span class="k">if</span> <span class="n">imports</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="cp">}</span>

<span class="x">from alembic import context</span>


<span class="x">def upgrade():</span>
<span class="x">    schema_upgrades()</span>
<span class="x">    if context.get_x_argument(as_dictionary=True).get(&#39;data&#39;, None):</span>
<span class="x">        data_upgrades()</span>

<span class="x">def downgrade():</span>
<span class="x">    if context.get_x_argument(as_dictionary=True).get(&#39;data&#39;, None):</span>
<span class="x">        data_downgrades()</span>
<span class="x">    schema_downgrades()</span>

<span class="x">def schema_upgrades():</span>
<span class="x">    &quot;&quot;&quot;schema upgrade migrations go here.&quot;&quot;&quot;</span>
<span class="x">    </span><span class="cp">${</span><span class="n">upgrades</span> <span class="k">if</span> <span class="n">upgrades</span> <span class="k">else</span> <span class="s2">&quot;pass&quot;</span><span class="cp">}</span>

<span class="x">def schema_downgrades():</span>
<span class="x">    &quot;&quot;&quot;schema downgrade migrations go here.&quot;&quot;&quot;</span>
<span class="x">    </span><span class="cp">${</span><span class="n">downgrades</span> <span class="k">if</span> <span class="n">downgrades</span> <span class="k">else</span> <span class="s2">&quot;pass&quot;</span><span class="cp">}</span>

<span class="x">def data_upgrades():</span>
<span class="x">    &quot;&quot;&quot;Add any optional data upgrade migrations here!&quot;&quot;&quot;</span>
<span class="x">    pass</span>

<span class="x">def data_downgrades():</span>
<span class="x">    &quot;&quot;&quot;Add any optional data downgrade migrations here!&quot;&quot;&quot;</span>
<span class="x">    pass</span>
</pre></div>
</div>
<p>Now, when we create a new migration file, the <code class="docutils literal notranslate"><span class="pre">data_upgrades()</span></code> and <code class="docutils literal notranslate"><span class="pre">data_downgrades()</span></code>
placeholders will be available, where we can add optional data migrations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;rev one</span>

<span class="sd">Revision ID: 3ba2b522d10d</span>
<span class="sd">Revises: None</span>
<span class="sd">Create Date: 2014-03-04 18:05:36.992867</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;3ba2b522d10d&#39;</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">op</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sa</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">table</span><span class="p">,</span> <span class="n">column</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">context</span>

<span class="k">def</span><span class="w"> </span><span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">schema_upgrades</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get_x_argument</span><span class="p">(</span><span class="n">as_dictionary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">data_upgrades</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">downgrade</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get_x_argument</span><span class="p">(</span><span class="n">as_dictionary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">data_downgrades</span><span class="p">()</span>
    <span class="n">schema_downgrades</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">schema_upgrades</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;schema upgrade migrations go here.&quot;&quot;&quot;</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s2">&quot;my_table&quot;</span><span class="p">,</span> <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">schema_downgrades</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;schema downgrade migrations go here.&quot;&quot;&quot;</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s2">&quot;my_table&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">data_upgrades</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add any optional data upgrade migrations here!&quot;&quot;&quot;</span>

    <span class="n">my_table</span> <span class="o">=</span> <span class="n">table</span><span class="p">(</span><span class="s1">&#39;my_table&#39;</span><span class="p">,</span>
        <span class="n">column</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">op</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">(</span><span class="n">my_table</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;data 1&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;data 2&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;data 3&#39;</span><span class="p">},</span>
        <span class="p">]</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">data_downgrades</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add any optional data downgrade migrations here!&quot;&quot;&quot;</span>

    <span class="n">op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;delete from my_table&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To invoke our migrations with data included, we use the <code class="docutils literal notranslate"><span class="pre">-x</span></code> flag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alembic</span> <span class="o">-</span><span class="n">x</span> <span class="n">data</span><span class="o">=</span><span class="n">true</span> <span class="n">upgrade</span> <span class="n">head</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="api/runtime.html#alembic.runtime.environment.EnvironmentContext.get_x_argument" title="alembic.runtime.environment.EnvironmentContext.get_x_argument"><code class="xref py py-meth docutils literal notranslate"><span class="pre">EnvironmentContext.get_x_argument()</span></code></a> is an easy way to support
new commandline options within environment and migration scripts.</p>
</section>
<section id="sharing-a-connection-across-one-or-more-programmatic-migration-commands">
<span id="connection-sharing"></span><h2>Sharing a Connection across one or more programmatic migration commands<a class="headerlink" href="#sharing-a-connection-across-one-or-more-programmatic-migration-commands" title="Link to this heading">#</a></h2>
<p>It is often the case that an application will need to call upon a series
of commands within <a class="reference internal" href="api/commands.html#alembic-command-toplevel"><span class="std std-ref">Commands</span></a>, where it would be advantageous
for all operations to proceed along a single transaction.   The connectivity
for a migration is typically solely determined within the <code class="docutils literal notranslate"><span class="pre">env.py</span></code> script
of a migration environment, which is called within the scope of a command.</p>
<p>The steps to take here are:</p>
<ol class="arabic simple">
<li><p>Produce the <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/connections.html#sqlalchemy.engine.Connection" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> object to use.</p></li>
<li><p>Place it somewhere that <code class="docutils literal notranslate"><span class="pre">env.py</span></code> will be able to access it.  This
can be either a. a module-level global somewhere, or b.
an attribute which we place into the <a class="reference internal" href="api/config.html#alembic.config.Config.attributes" title="alembic.config.Config.attributes"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Config.attributes</span></code></a>
dictionary (if we are on an older Alembic version, we may also attach
an attribute directly to the <a class="reference internal" href="api/config.html#alembic.config.Config" title="alembic.config.Config"><code class="xref py py-class docutils literal notranslate"><span class="pre">Config</span></code></a> object).</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">env.py</span></code> script is modified such that it looks for this
<a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/connections.html#sqlalchemy.engine.Connection" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> and makes use of it, in lieu
of building up its own <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/connections.html#sqlalchemy.engine.Engine" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> instance.</p></li>
</ol>
<p>We illustrate using <a class="reference internal" href="api/config.html#alembic.config.Config.attributes" title="alembic.config.Config.attributes"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Config.attributes</span></code></a> a script that will run
the <a class="reference internal" href="api/commands.html#alembic.command.upgrade" title="alembic.command.upgrade"><code class="xref py py-func docutils literal notranslate"><span class="pre">command.upgrade()</span></code></a> command programmatically within a
transaction declared in a Python file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">command</span><span class="p">,</span> <span class="n">config</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="s2">&quot;/path/to/yourapp/alembic.ini&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span>
    <span class="n">command</span><span class="o">.</span><span class="n">upgrade</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;head&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Then in <code class="docutils literal notranslate"><span class="pre">env.py</span></code> we can update <code class="docutils literal notranslate"><span class="pre">run_migrations_online</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run_migrations_online</span><span class="p">():</span>
    <span class="n">connectable</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connectable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># only create Engine if we don&#39;t have a Connection</span>
        <span class="c1"># from the outside</span>
        <span class="n">connectable</span> <span class="o">=</span> <span class="n">engine_from_config</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">config_ini_section</span><span class="p">),</span>
            <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sqlalchemy.&#39;</span><span class="p">,</span>
            <span class="n">poolclass</span><span class="o">=</span><span class="n">pool</span><span class="o">.</span><span class="n">NullPool</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">connectable</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
                <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span> <span class="n">target_metadata</span><span class="o">=</span><span class="n">target_metadata</span>
            <span class="p">)</span>

            <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">begin_transaction</span><span class="p">():</span>
                <span class="n">context</span><span class="o">.</span><span class="n">run_migrations</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">connectable</span><span class="p">,</span>
            <span class="n">target_metadata</span><span class="o">=</span><span class="n">target_metadata</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">begin_transaction</span><span class="p">():</span>
            <span class="n">context</span><span class="o">.</span><span class="n">run_migrations</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="replaceable-objects">
<span id="id1"></span><h2>Replaceable Objects<a class="headerlink" href="#replaceable-objects" title="Link to this heading">#</a></h2>
<p>This recipe proposes a hypothetical way of dealing with
what we might call a <em>replaceable</em> schema object.  A replaceable object
is a schema object that needs to be created and dropped all at once.
Examples of such objects include views, stored procedures, and triggers.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>The Replaceable Object concept has been integrated by the
<a class="reference external" href="https://github.com/olirice/alembic_utils">Alembic Utils</a> project,
which provides autogenerate and migration
support for PostgreSQL functions and views.   See
Alembic Utils at <a class="github reference external" href="https://github.com/olirice/alembic_utils">olirice/alembic_utils</a> .</p>
</div>
<p>Replaceable objects present a problem in that in order to make incremental
changes to them, we have to refer to the whole definition at once.
If we need to add a new column to a view, for example, we have to drop
it entirely and recreate it fresh with the extra column added, referring to
the whole structure; but to make it even tougher, if we wish to support
downgrade operations in our migration scripts,
we need to refer to the <em>previous</em> version of that
construct fully, and we’d much rather not have to type out the whole
definition in multiple places.</p>
<p>This recipe proposes that we may refer to the older version of a
replaceable construct by directly naming the migration version in
which it was created, and having a migration refer to that previous
file as migrations run.   We will also demonstrate how to integrate this
logic within the <a class="reference internal" href="api/operations.html#operation-plugins"><span class="std std-ref">Operation Plugins</span></a> feature introduced in
Alembic 0.8.  It may be very helpful to review
this section first to get an overview of this API.</p>
<section id="the-replaceable-object-structure">
<h3>The Replaceable Object Structure<a class="headerlink" href="#the-replaceable-object-structure" title="Link to this heading">#</a></h3>
<p>We first need to devise a simple format that represents the “CREATE XYZ” /
“DROP XYZ” aspect of what it is we’re building.  We will work with an object
that represents a textual definition; while a SQL view is an object that we can define
using a <a class="reference external" href="https://github.com/sqlalchemy/sqlalchemy/wiki/UsageRecipes/Views">table-metadata-like system</a>,
this is not so much the case for things like stored procedures, where
we pretty much need to have a full string definition written down somewhere.
We’ll use a simple value object called <code class="docutils literal notranslate"><span class="pre">ReplaceableObject</span></code> that can
represent any named set of SQL text to send to a “CREATE” statement of
some kind:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ReplaceableObject</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sqltext</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqltext</span> <span class="o">=</span> <span class="n">sqltext</span>
</pre></div>
</div>
<p>Using this object in a migration script, assuming a Postgresql-style
syntax, looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">customer_view</span> <span class="o">=</span> <span class="n">ReplaceableObject</span><span class="p">(</span>
    <span class="s2">&quot;customer_view&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SELECT name, order_count FROM customer WHERE order_count &gt; 0&quot;</span>
<span class="p">)</span>

<span class="n">add_customer_sp</span> <span class="o">=</span> <span class="n">ReplaceableObject</span><span class="p">(</span>
    <span class="s2">&quot;add_customer_sp(name varchar, order_count integer)&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    RETURNS integer AS $$</span>
<span class="sd">    BEGIN</span>
<span class="sd">        insert into customer (name, order_count)</span>
<span class="sd">        VALUES (in_name, in_order_count);</span>
<span class="sd">    END;</span>
<span class="sd">    $$ LANGUAGE plpgsql;</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ReplaceableObject</span></code> class is only one very simplistic way to do this.
The structure of how we represent our schema objects
is not too important for the purposes of this example; we can just
as well put strings inside of tuples or dictionaries, as well as
that we could define any kind of series of fields and class structures we want.
The only important part is that below we will illustrate how organize the
code that can consume the structure we create here.</p>
</section>
<section id="create-operations-for-the-target-objects">
<h3>Create Operations for the Target Objects<a class="headerlink" href="#create-operations-for-the-target-objects" title="Link to this heading">#</a></h3>
<p>We’ll use the <a class="reference internal" href="ops.html#alembic.operations.Operations" title="alembic.operations.Operations"><code class="xref py py-class docutils literal notranslate"><span class="pre">Operations</span></code></a> extension API to make new operations
for create, drop, and replace of views and stored procedures.  Using this
API is also optional; we can just as well make any kind of Python
function that we would invoke from our migration scripts.
However, using this API gives us operations
built directly into the Alembic <code class="docutils literal notranslate"><span class="pre">op.*</span></code> namespace very nicely.</p>
<p>The most intricate class is below.  This is the base of our “replaceable”
operation, which includes not just a base operation for emitting
CREATE and DROP instructions on a <code class="docutils literal notranslate"><span class="pre">ReplaceableObject</span></code>, it also assumes
a certain model of “reversibility” which makes use of references to
other migration files in order to refer to the “previous” version
of an object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">alembic.operations</span><span class="w"> </span><span class="kn">import</span> <span class="n">Operations</span><span class="p">,</span> <span class="n">MigrateOperation</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ReversibleOp</span><span class="p">(</span><span class="n">MigrateOperation</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">invoke_for_target</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">op</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">operations</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_object_from_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">ident</span><span class="p">):</span>
        <span class="n">version</span><span class="p">,</span> <span class="n">objname</span> <span class="o">=</span> <span class="n">ident</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>

        <span class="n">module</span> <span class="o">=</span> <span class="n">operations</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">get_revision</span><span class="p">(</span><span class="n">version</span><span class="p">)</span><span class="o">.</span><span class="n">module</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">objname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">replace</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">replaces</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replace_with</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">replaces</span><span class="p">:</span>
            <span class="n">old_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_object_from_version</span><span class="p">(</span><span class="n">operations</span><span class="p">,</span> <span class="n">replaces</span><span class="p">)</span>
            <span class="n">drop_old</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">old_obj</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">create_new</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">replace_with</span><span class="p">:</span>
            <span class="n">old_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_object_from_version</span><span class="p">(</span><span class="n">operations</span><span class="p">,</span> <span class="n">replace_with</span><span class="p">)</span>
            <span class="n">drop_old</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">create_new</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">old_obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;replaces or replace_with is required&quot;</span><span class="p">)</span>

        <span class="n">operations</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">drop_old</span><span class="p">)</span>
        <span class="n">operations</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">create_new</span><span class="p">)</span>
</pre></div>
</div>
<p>The workings of this class should become clear as we walk through the
example.   To create usable operations from this base, we will build
a series of stub classes and use <a class="reference internal" href="ops.html#alembic.operations.Operations.register_operation" title="alembic.operations.Operations.register_operation"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.register_operation()</span></code></a>
to make them part of the <code class="docutils literal notranslate"><span class="pre">op.*</span></code> namespace:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Operations</span><span class="o">.</span><span class="n">register_operation</span><span class="p">(</span><span class="s2">&quot;create_view&quot;</span><span class="p">,</span> <span class="s2">&quot;invoke_for_target&quot;</span><span class="p">)</span>
<span class="nd">@Operations</span><span class="o">.</span><span class="n">register_operation</span><span class="p">(</span><span class="s2">&quot;replace_view&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CreateViewOp</span><span class="p">(</span><span class="n">ReversibleOp</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DropViewOp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>


<span class="nd">@Operations</span><span class="o">.</span><span class="n">register_operation</span><span class="p">(</span><span class="s2">&quot;drop_view&quot;</span><span class="p">,</span> <span class="s2">&quot;invoke_for_target&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DropViewOp</span><span class="p">(</span><span class="n">ReversibleOp</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CreateViewOp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>


<span class="nd">@Operations</span><span class="o">.</span><span class="n">register_operation</span><span class="p">(</span><span class="s2">&quot;create_sp&quot;</span><span class="p">,</span> <span class="s2">&quot;invoke_for_target&quot;</span><span class="p">)</span>
<span class="nd">@Operations</span><span class="o">.</span><span class="n">register_operation</span><span class="p">(</span><span class="s2">&quot;replace_sp&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CreateSPOp</span><span class="p">(</span><span class="n">ReversibleOp</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DropSPOp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>


<span class="nd">@Operations</span><span class="o">.</span><span class="n">register_operation</span><span class="p">(</span><span class="s2">&quot;drop_sp&quot;</span><span class="p">,</span> <span class="s2">&quot;invoke_for_target&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DropSPOp</span><span class="p">(</span><span class="n">ReversibleOp</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CreateSPOp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
</pre></div>
</div>
<p>To actually run the SQL like “CREATE VIEW” and “DROP SEQUENCE”, we’ll provide
implementations using <a class="reference internal" href="ops.html#alembic.operations.Operations.implementation_for" title="alembic.operations.Operations.implementation_for"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.implementation_for()</span></code></a>
that run straight into <a class="reference internal" href="ops.html#alembic.operations.Operations.execute" title="alembic.operations.Operations.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.execute()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Operations</span><span class="o">.</span><span class="n">implementation_for</span><span class="p">(</span><span class="n">CreateViewOp</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_view</span><span class="p">(</span><span class="n">operations</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
    <span class="n">operations</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE VIEW </span><span class="si">%s</span><span class="s2"> AS </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">operation</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">operation</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">sqltext</span>
    <span class="p">))</span>


<span class="nd">@Operations</span><span class="o">.</span><span class="n">implementation_for</span><span class="p">(</span><span class="n">DropViewOp</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">drop_view</span><span class="p">(</span><span class="n">operations</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
    <span class="n">operations</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP VIEW </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">operation</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="nd">@Operations</span><span class="o">.</span><span class="n">implementation_for</span><span class="p">(</span><span class="n">CreateSPOp</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_sp</span><span class="p">(</span><span class="n">operations</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
    <span class="n">operations</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;CREATE FUNCTION </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">operation</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">operation</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">sqltext</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="nd">@Operations</span><span class="o">.</span><span class="n">implementation_for</span><span class="p">(</span><span class="n">DropSPOp</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">drop_sp</span><span class="p">(</span><span class="n">operations</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
    <span class="n">operations</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP FUNCTION </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">operation</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="publish-the-extensions">
<h3>Publish the Extensions<a class="headerlink" href="#publish-the-extensions" title="Link to this heading">#</a></h3>
<p>All of the above code can be present anywhere within an application’s
source tree; the only requirement is that when the <code class="docutils literal notranslate"><span class="pre">env.py</span></code> script is
invoked, it includes imports that ultimately call upon these classes
as well as the <a class="reference internal" href="ops.html#alembic.operations.Operations.register_operation" title="alembic.operations.Operations.register_operation"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.register_operation()</span></code></a> and
<a class="reference internal" href="ops.html#alembic.operations.Operations.implementation_for" title="alembic.operations.Operations.implementation_for"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.implementation_for()</span></code></a> sequences.</p>
<p>Alternatively, custom operations and autogenerate support can be organized
into reusable plugins using Alembic’s plugin system. This allows extensions
to be packaged and distributed independently, and automatically discovered
via Python entry points. See <a class="reference internal" href="api/plugins.html#alembic-plugins-toplevel"><span class="std std-ref">Plugins</span></a> for information
on writing and publishing plugins.</p>
</section>
<section id="create-initial-migrations">
<h3>Create Initial Migrations<a class="headerlink" href="#create-initial-migrations" title="Link to this heading">#</a></h3>
<p>We can now illustrate how these objects look during use.  For the first step,
we’ll create a new migration to create a “customer” table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic revision -m &quot;create table&quot;
</pre></div>
</div>
<p>We build the first revision as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;create table</span>

<span class="sd">Revision ID: 3ab8b2dfb055</span>
<span class="sd">Revises:</span>
<span class="sd">Create Date: 2015-07-27 16:22:44.918507</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;3ab8b2dfb055&#39;</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">branch_labels</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">depends_on</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">op</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sa</span>


<span class="k">def</span><span class="w"> </span><span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
        <span class="s2">&quot;customer&quot;</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;order_count&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">),</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">&#39;customer&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>For the second migration, we will create a view and a stored procedure
which act upon this table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic revision -m &quot;create views/sp&quot;
</pre></div>
</div>
<p>This migration will use the new directives:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;create views/sp</span>

<span class="sd">Revision ID: 28af9800143f</span>
<span class="sd">Revises: 3ab8b2dfb055</span>
<span class="sd">Create Date: 2015-07-27 16:24:03.589867</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;28af9800143f&#39;</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="s1">&#39;3ab8b2dfb055&#39;</span>
<span class="n">branch_labels</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">depends_on</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">op</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sa</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">foo</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReplaceableObject</span>

<span class="n">customer_view</span> <span class="o">=</span> <span class="n">ReplaceableObject</span><span class="p">(</span>
    <span class="s2">&quot;customer_view&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SELECT name, order_count FROM customer WHERE order_count &gt; 0&quot;</span>
<span class="p">)</span>

<span class="n">add_customer_sp</span> <span class="o">=</span> <span class="n">ReplaceableObject</span><span class="p">(</span>
    <span class="s2">&quot;add_customer_sp(name varchar, order_count integer)&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    RETURNS integer AS $$</span>
<span class="sd">    BEGIN</span>
<span class="sd">        insert into customer (name, order_count)</span>
<span class="sd">        VALUES (in_name, in_order_count);</span>
<span class="sd">    END;</span>
<span class="sd">    $$ LANGUAGE plpgsql;</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_view</span><span class="p">(</span><span class="n">customer_view</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_sp</span><span class="p">(</span><span class="n">add_customer_sp</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_view</span><span class="p">(</span><span class="n">customer_view</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_sp</span><span class="p">(</span><span class="n">add_customer_sp</span><span class="p">)</span>
</pre></div>
</div>
<p>We see the use of our new <code class="docutils literal notranslate"><span class="pre">create_view()</span></code>, <code class="docutils literal notranslate"><span class="pre">create_sp()</span></code>,
<code class="docutils literal notranslate"><span class="pre">drop_view()</span></code>, and <code class="docutils literal notranslate"><span class="pre">drop_sp()</span></code> directives.  Running these to “head”
we get the following (this includes an edited view of SQL emitted):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic upgrade 28af9800143
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [sqlalchemy.engine.base.Engine] BEGIN (implicit)
INFO  [sqlalchemy.engine.base.Engine] select relname from pg_class c join pg_namespace n on n.oid=c.relnamespace where pg_catalog.pg_table_is_visible(c.oid) and relname=%(name)s
INFO  [sqlalchemy.engine.base.Engine] {&#39;name&#39;: u&#39;alembic_version&#39;}
INFO  [sqlalchemy.engine.base.Engine] SELECT alembic_version.version_num
FROM alembic_version
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] select relname from pg_class c join pg_namespace n on n.oid=c.relnamespace where pg_catalog.pg_table_is_visible(c.oid) and relname=%(name)s
INFO  [sqlalchemy.engine.base.Engine] {&#39;name&#39;: u&#39;alembic_version&#39;}
INFO  [alembic.runtime.migration] Running upgrade  -&gt; 3ab8b2dfb055, create table
INFO  [sqlalchemy.engine.base.Engine]
CREATE TABLE customer (
    id SERIAL NOT NULL,
    name VARCHAR,
    order_count INTEGER,
    PRIMARY KEY (id)
)


INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] INSERT INTO alembic_version (version_num) VALUES (&#39;3ab8b2dfb055&#39;)
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [alembic.runtime.migration] Running upgrade 3ab8b2dfb055 -&gt; 28af9800143f, create views/sp
INFO  [sqlalchemy.engine.base.Engine] CREATE VIEW customer_view AS SELECT name, order_count FROM customer WHERE order_count &gt; 0
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] CREATE FUNCTION add_customer_sp(name varchar, order_count integer)
    RETURNS integer AS $$
    BEGIN
        insert into customer (name, order_count)
        VALUES (in_name, in_order_count);
    END;
    $$ LANGUAGE plpgsql;

INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] UPDATE alembic_version SET version_num=&#39;28af9800143f&#39; WHERE alembic_version.version_num = &#39;3ab8b2dfb055&#39;
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] COMMIT
</pre></div>
</div>
<p>We see that our CREATE TABLE proceeded as well as the CREATE VIEW and CREATE
FUNCTION operations produced by our new directives.</p>
</section>
<section id="create-revision-migrations">
<h3>Create Revision Migrations<a class="headerlink" href="#create-revision-migrations" title="Link to this heading">#</a></h3>
<p>Finally, we can illustrate how we would “revise” these objects.
Let’s consider we added a new column <code class="docutils literal notranslate"><span class="pre">email</span></code> to our <code class="docutils literal notranslate"><span class="pre">customer</span></code> table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic revision -m &quot;add email col&quot;
</pre></div>
</div>
<p>The migration is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;add email col</span>

<span class="sd">Revision ID: 191a2d20b025</span>
<span class="sd">Revises: 28af9800143f</span>
<span class="sd">Create Date: 2015-07-27 16:25:59.277326</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;191a2d20b025&#39;</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="s1">&#39;28af9800143f&#39;</span>
<span class="n">branch_labels</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">depends_on</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">op</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sa</span>


<span class="k">def</span><span class="w"> </span><span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;customer&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">()))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s2">&quot;customer&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We now need to recreate the <code class="docutils literal notranslate"><span class="pre">customer_view</span></code> view and the
<code class="docutils literal notranslate"><span class="pre">add_customer_sp</span></code> function.   To include downgrade capability, we will
need to refer to the <strong>previous</strong> version of the construct; the
<code class="docutils literal notranslate"><span class="pre">replace_view()</span></code> and <code class="docutils literal notranslate"><span class="pre">replace_sp()</span></code> operations we’ve created make
this possible, by allowing us to refer to a specific, previous revision.
the <code class="docutils literal notranslate"><span class="pre">replaces</span></code> and <code class="docutils literal notranslate"><span class="pre">replace_with</span></code> arguments accept a dot-separated
string, which refers to a revision number and an object name, such
as <code class="docutils literal notranslate"><span class="pre">&quot;28af9800143f.customer_view&quot;</span></code>.  The <code class="docutils literal notranslate"><span class="pre">ReversibleOp</span></code> class makes use
of the <a class="reference internal" href="ops.html#alembic.operations.Operations.get_context" title="alembic.operations.Operations.get_context"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.get_context()</span></code></a> method to locate the version file
we refer to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic revision -m &quot;update views/sp&quot;
</pre></div>
</div>
<p>The migration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;update views/sp</span>

<span class="sd">Revision ID: 199028bf9856</span>
<span class="sd">Revises: 191a2d20b025</span>
<span class="sd">Create Date: 2015-07-27 16:26:31.344504</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;199028bf9856&#39;</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="s1">&#39;191a2d20b025&#39;</span>
<span class="n">branch_labels</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">depends_on</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">op</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sa</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">foo</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReplaceableObject</span>

<span class="n">customer_view</span> <span class="o">=</span> <span class="n">ReplaceableObject</span><span class="p">(</span>
    <span class="s2">&quot;customer_view&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SELECT name, order_count, email &quot;</span>
    <span class="s2">&quot;FROM customer WHERE order_count &gt; 0&quot;</span>
<span class="p">)</span>

<span class="n">add_customer_sp</span> <span class="o">=</span> <span class="n">ReplaceableObject</span><span class="p">(</span>
    <span class="s2">&quot;add_customer_sp(name varchar, order_count integer, email varchar)&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    RETURNS integer AS $$</span>
<span class="sd">    BEGIN</span>
<span class="sd">        insert into customer (name, order_count, email)</span>
<span class="sd">        VALUES (in_name, in_order_count, email);</span>
<span class="sd">    END;</span>
<span class="sd">    $$ LANGUAGE plpgsql;</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">replace_view</span><span class="p">(</span><span class="n">customer_view</span><span class="p">,</span> <span class="n">replaces</span><span class="o">=</span><span class="s2">&quot;28af9800143f.customer_view&quot;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">replace_sp</span><span class="p">(</span><span class="n">add_customer_sp</span><span class="p">,</span> <span class="n">replaces</span><span class="o">=</span><span class="s2">&quot;28af9800143f.add_customer_sp&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">replace_view</span><span class="p">(</span><span class="n">customer_view</span><span class="p">,</span> <span class="n">replace_with</span><span class="o">=</span><span class="s2">&quot;28af9800143f.customer_view&quot;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">replace_sp</span><span class="p">(</span><span class="n">add_customer_sp</span><span class="p">,</span> <span class="n">replace_with</span><span class="o">=</span><span class="s2">&quot;28af9800143f.add_customer_sp&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Above, instead of using <code class="docutils literal notranslate"><span class="pre">create_view()</span></code>, <code class="docutils literal notranslate"><span class="pre">create_sp()</span></code>,
<code class="docutils literal notranslate"><span class="pre">drop_view()</span></code>, and <code class="docutils literal notranslate"><span class="pre">drop_sp()</span></code> methods, we now use <code class="docutils literal notranslate"><span class="pre">replace_view()</span></code> and
<code class="docutils literal notranslate"><span class="pre">replace_sp()</span></code>.  The replace operation we’ve built always runs a DROP <em>and</em>
a CREATE.  Running an upgrade to head we see:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic upgrade head
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [sqlalchemy.engine.base.Engine] BEGIN (implicit)
INFO  [sqlalchemy.engine.base.Engine] select relname from pg_class c join pg_namespace n on n.oid=c.relnamespace where pg_catalog.pg_table_is_visible(c.oid) and relname=%(name)s
INFO  [sqlalchemy.engine.base.Engine] {&#39;name&#39;: u&#39;alembic_version&#39;}
INFO  [sqlalchemy.engine.base.Engine] SELECT alembic_version.version_num
FROM alembic_version
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [alembic.runtime.migration] Running upgrade 28af9800143f -&gt; 191a2d20b025, add email col
INFO  [sqlalchemy.engine.base.Engine] ALTER TABLE customer ADD COLUMN email VARCHAR
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] UPDATE alembic_version SET version_num=&#39;191a2d20b025&#39; WHERE alembic_version.version_num = &#39;28af9800143f&#39;
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [alembic.runtime.migration] Running upgrade 191a2d20b025 -&gt; 199028bf9856, update views/sp
INFO  [sqlalchemy.engine.base.Engine] DROP VIEW customer_view
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] CREATE VIEW customer_view AS SELECT name, order_count, email FROM customer WHERE order_count &gt; 0
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] DROP FUNCTION add_customer_sp(name varchar, order_count integer)
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] CREATE FUNCTION add_customer_sp(name varchar, order_count integer, email varchar)
    RETURNS integer AS $$
    BEGIN
        insert into customer (name, order_count, email)
        VALUES (in_name, in_order_count, email);
    END;
    $$ LANGUAGE plpgsql;

INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] UPDATE alembic_version SET version_num=&#39;199028bf9856&#39; WHERE alembic_version.version_num = &#39;191a2d20b025&#39;
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] COMMIT
</pre></div>
</div>
<p>After adding our new <code class="docutils literal notranslate"><span class="pre">email</span></code> column, we see that both <code class="docutils literal notranslate"><span class="pre">customer_view</span></code>
and <code class="docutils literal notranslate"><span class="pre">add_customer_sp()</span></code> are dropped before the new version is created.
If we downgrade back to the old version, we see the old version of these
recreated again within the downgrade for this migration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic downgrade 28af9800143
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [sqlalchemy.engine.base.Engine] BEGIN (implicit)
INFO  [sqlalchemy.engine.base.Engine] select relname from pg_class c join pg_namespace n on n.oid=c.relnamespace where pg_catalog.pg_table_is_visible(c.oid) and relname=%(name)s
INFO  [sqlalchemy.engine.base.Engine] {&#39;name&#39;: u&#39;alembic_version&#39;}
INFO  [sqlalchemy.engine.base.Engine] SELECT alembic_version.version_num
FROM alembic_version
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [alembic.runtime.migration] Running downgrade 199028bf9856 -&gt; 191a2d20b025, update views/sp
INFO  [sqlalchemy.engine.base.Engine] DROP VIEW customer_view
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] CREATE VIEW customer_view AS SELECT name, order_count FROM customer WHERE order_count &gt; 0
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] DROP FUNCTION add_customer_sp(name varchar, order_count integer, email varchar)
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] CREATE FUNCTION add_customer_sp(name varchar, order_count integer)
    RETURNS integer AS $$
    BEGIN
        insert into customer (name, order_count)
        VALUES (in_name, in_order_count);
    END;
    $$ LANGUAGE plpgsql;

INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] UPDATE alembic_version SET version_num=&#39;191a2d20b025&#39; WHERE alembic_version.version_num = &#39;199028bf9856&#39;
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [alembic.runtime.migration] Running downgrade 191a2d20b025 -&gt; 28af9800143f, add email col
INFO  [sqlalchemy.engine.base.Engine] ALTER TABLE customer DROP COLUMN email
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] UPDATE alembic_version SET version_num=&#39;28af9800143f&#39; WHERE alembic_version.version_num = &#39;191a2d20b025&#39;
INFO  [sqlalchemy.engine.base.Engine] {}
INFO  [sqlalchemy.engine.base.Engine] COMMIT
</pre></div>
</div>
</section>
</section>
<section id="rudimental-schema-level-multi-tenancy-for-postgresql-mysql-other-databases">
<span id="cookbook-postgresql-multi-tenancy"></span><h2>Rudimental Schema-Level Multi Tenancy for PostgreSQL, MySQL, Other Databases<a class="headerlink" href="#rudimental-schema-level-multi-tenancy-for-postgresql-mysql-other-databases" title="Link to this heading">#</a></h2>
<p><strong>Multi tenancy</strong> refers to an application that accommodates for many
clients simultaneously.   Within the scope of a database migrations tool,
multi-tenancy typically refers to the practice of maintaining multiple,
identical databases where each database is assigned to one client.</p>
<p>Alembic does not currently have explicit multi-tenant support; typically,
the approach must involve running Alembic multiple times against different
database URLs.</p>
<p>One common approach to multi-tenancy, particularly on the PostgreSQL database,
is to install tenants within <strong>individual PostgreSQL schemas</strong>; similarly
when using MySQL/MariaDB, <strong>individual MySQL/MariaDB databases</strong> are addressed
in the same way as “schemas” on PostgreSQL.</p>
<p>When using PostgreSQL’s schemas, a special variable <code class="docutils literal notranslate"><span class="pre">search_path</span></code> is offered
that is intended to assist with targeting of different schemas.  When using
MySQL or MariaDB databases, a similar command is available at the SQL level
called the <code class="docutils literal notranslate"><span class="pre">USE</span></code> command.  This command may be used in a similar fashion as
that of PostgreSQL’s <code class="docutils literal notranslate"><span class="pre">search_path</span></code> variable to achieve a similar effect.</p>
<p>Overall, this recipe can be used on <strong>any database that supports runtime
modification of the current “tenant” via SQL commands on a particular
connection</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SQLAlchemy includes a system of directing a common set of
<code class="docutils literal notranslate"><span class="pre">Table</span></code> metadata to many schemas called <a class="reference external" href="https://docs.sqlalchemy.org/core/connections.html#translation-of-schema-names">schema_translate_map</a>.   Alembic at the time
of this writing lacks adequate support for this feature.  The recipe below
should be considered <strong>interim</strong> until Alembic has more first-class support
for schema-level multi-tenancy.</p>
</div>
<p>The recipe below can be altered for flexibility.  The primary purpose of this
recipe is to illustrate how to point the Alembic process towards one PostgreSQL
or MySQL/MariaDB schema or another.</p>
<ol class="arabic">
<li><p>The model metadata used as the target for autogenerate must not include any
schema name for tables; the schema must be non-present or set to <code class="docutils literal notranslate"><span class="pre">None</span></code>.
Otherwise, Alembic autogenerate will still attempt
to compare and render tables in terms of this schema:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">UnicodeText</span><span class="p">())</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>The <a class="reference internal" href="api/runtime.html#alembic.runtime.environment.EnvironmentContext.configure.params.include_schemas" title="alembic.runtime.environment.EnvironmentContext.configure"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">EnvironmentContext.configure.include_schemas</span></code></a> flag must
also be False or not included.</p></li>
<li><p>The “tenant” will be a schema name passed to Alembic using the “-x” flag.
In <code class="docutils literal notranslate"><span class="pre">env.py</span></code> an approach like the following allows <code class="docutils literal notranslate"><span class="pre">-xtenant=some_schema</span></code>
to be supported by making use of <a class="reference internal" href="api/runtime.html#alembic.runtime.environment.EnvironmentContext.get_x_argument" title="alembic.runtime.environment.EnvironmentContext.get_x_argument"><code class="xref py py-meth docutils literal notranslate"><span class="pre">EnvironmentContext.get_x_argument()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">text</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_migrations_online</span><span class="p">():</span>
    <span class="n">connectable</span> <span class="o">=</span> <span class="n">engine_from_config</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">config_ini_section</span><span class="p">),</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;sqlalchemy.&quot;</span><span class="p">,</span>
        <span class="n">poolclass</span><span class="o">=</span><span class="n">pool</span><span class="o">.</span><span class="n">NullPool</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">current_tenant</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_x_argument</span><span class="p">(</span><span class="n">as_dictionary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tenant&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">connectable</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;postgresql&quot;</span><span class="p">:</span>
            <span class="c1"># set search path on the connection, which ensures that</span>
            <span class="c1"># PostgreSQL will emit all CREATE / ALTER / DROP statements</span>
            <span class="c1"># in terms of this schema by default</span>

            <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s1">&#39;set search_path to &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">current_tenant</span><span class="p">))</span>
            <span class="c1"># in SQLAlchemy v2+ the search path change needs to be committed</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="s2">&quot;mariadb&quot;</span><span class="p">):</span>
            <span class="c1"># set &quot;USE&quot; on the connection, which ensures that</span>
            <span class="c1"># MySQL/MariaDB will emit all CREATE / ALTER / DROP statements</span>
            <span class="c1"># in terms of this schema by default</span>

            <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s1">&#39;USE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">current_tenant</span><span class="p">))</span>

        <span class="c1"># make use of non-supported SQLAlchemy attribute to ensure</span>
        <span class="c1"># the dialect reflects tables in terms of the current tenant name</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">default_schema_name</span> <span class="o">=</span> <span class="n">current_tenant</span>

        <span class="n">context</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span>
            <span class="n">target_metadata</span><span class="o">=</span><span class="n">target_metadata</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">begin_transaction</span><span class="p">():</span>
            <span class="n">context</span><span class="o">.</span><span class="n">run_migrations</span><span class="p">()</span>
</pre></div>
</div>
<p>The current tenant is set using the PostgreSQL <code class="docutils literal notranslate"><span class="pre">search_path</span></code> variable, or
the MySQL/MariaDB <code class="docutils literal notranslate"><span class="pre">USE</span></code> statement, on the connection.  Note above we must
employ a <strong>non-supported SQLAlchemy workaround</strong> at the moment which is to
hardcode the SQLAlchemy dialect’s default schema name to our target schema.</p>
<p>It is also important to note that the above changes <strong>remain on the connection
permanently unless reversed explicitly</strong>.  If the alembic application simply
exits above, there is no issue.  However if the application attempts to
continue using the above connection for other purposes, it may be necessary
to reset these variables back to the default, which for PostgreSQL is usually
the name “public” however may be different based on configuration, and
for MySQL/MariaDB is typically the “database” portion of the database URL.</p>
</li>
<li><p>Alembic operations will now proceed in terms of whichever schema we pass
on the command line.   All logged SQL will show no schema, except for
reflection operations which will make use of the <code class="docutils literal notranslate"><span class="pre">default_schema_name</span></code>
attribute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[]$ alembic -x tenant=some_schema revision -m &quot;rev1&quot; --autogenerate
</pre></div>
</div>
</li>
<li><p>Since all schemas are to be maintained in sync, autogenerate should be run
against only <strong>one</strong> schema, generating new Alembic migration files.
Autogenerated migration operations are then run against <strong>all</strong> schemas.</p></li>
</ol>
</section>
<section id="don-t-generate-empty-migrations-with-autogenerate">
<span id="cookbook-no-empty-migrations"></span><h2>Don’t Generate Empty Migrations with Autogenerate<a class="headerlink" href="#don-t-generate-empty-migrations-with-autogenerate" title="Link to this heading">#</a></h2>
<p>A common request is to have the <code class="docutils literal notranslate"><span class="pre">alembic</span> <span class="pre">revision</span> <span class="pre">--autogenerate</span></code> command not
actually generate a revision file if no changes to the schema is detected.  Using
the <a class="reference internal" href="api/runtime.html#alembic.runtime.environment.EnvironmentContext.configure.params.process_revision_directives" title="alembic.runtime.environment.EnvironmentContext.configure"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">EnvironmentContext.configure.process_revision_directives</span></code></a>
hook, this is straightforward; place a <code class="docutils literal notranslate"><span class="pre">process_revision_directives</span></code>
hook in <a class="reference internal" href="api/runtime.html#alembic.runtime.migration.MigrationContext.configure" title="alembic.runtime.migration.MigrationContext.configure"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MigrationContext.configure()</span></code></a> which removes the
single <a class="reference internal" href="api/operations.html#alembic.operations.ops.MigrationScript" title="alembic.operations.ops.MigrationScript"><code class="xref py py-class docutils literal notranslate"><span class="pre">MigrationScript</span></code></a> directive if it is empty of
any operations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># for typing purposes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic.environment</span><span class="w"> </span><span class="kn">import</span> <span class="n">MigrationContext</span>

<span class="c1"># this typing-only import requires alembic 1.12.1 or above</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic.operations</span><span class="w"> </span><span class="kn">import</span> <span class="n">MigrationScript</span>


<span class="k">def</span><span class="w"> </span><span class="nf">run_migrations_online</span><span class="p">():</span>

    <span class="c1"># ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_revision_directives</span><span class="p">(</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">MigrationContext</span><span class="p">,</span>
        <span class="n">revision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">directives</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">MigrationScript</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">cmd_opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">cmd_opts</span><span class="p">,</span> <span class="s1">&#39;autogenerate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">script</span> <span class="o">=</span> <span class="n">directives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">script</span><span class="o">.</span><span class="n">upgrade_ops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">script</span><span class="o">.</span><span class="n">upgrade_ops</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">directives</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="c1"># connectable = ...</span>

    <span class="k">with</span> <span class="n">connectable</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span>
            <span class="n">target_metadata</span><span class="o">=</span><span class="n">target_metadata</span><span class="p">,</span>
            <span class="n">process_revision_directives</span><span class="o">=</span><span class="n">process_revision_directives</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">begin_transaction</span><span class="p">():</span>
            <span class="n">context</span><span class="o">.</span><span class="n">run_migrations</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="don-t-emit-drop-index-when-the-table-is-to-be-dropped-as-well">
<span id="cookbook-dont-emit-drop-index"></span><h2>Don’t emit DROP INDEX when the table is to be dropped as well<a class="headerlink" href="#don-t-emit-drop-index-when-the-table-is-to-be-dropped-as-well" title="Link to this heading">#</a></h2>
<p>MySQL may complain when dropping an index that is against a column
that also has a foreign key constraint on it.   If the table is to be dropped
in any case, the DROP INDEX isn’t necessary.  This recipe will process the set
of autogenerate directives such that all <a class="reference internal" href="api/operations.html#alembic.operations.ops.DropIndexOp" title="alembic.operations.ops.DropIndexOp"><code class="xref py py-class docutils literal notranslate"><span class="pre">DropIndexOp</span></code></a> directives
are removed against tables that themselves are to be dropped:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run_migrations_online</span><span class="p">():</span>

    <span class="c1"># ...</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">alembic.operations</span><span class="w"> </span><span class="kn">import</span> <span class="n">ops</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_revision_directives</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="n">directives</span><span class="p">):</span>
        <span class="n">script</span> <span class="o">=</span> <span class="n">directives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># process both &quot;def upgrade()&quot;, &quot;def downgrade()&quot;</span>
        <span class="k">for</span> <span class="n">directive</span> <span class="ow">in</span> <span class="p">(</span><span class="n">script</span><span class="o">.</span><span class="n">upgrade_ops</span><span class="p">,</span> <span class="n">script</span><span class="o">.</span><span class="n">downgrade_ops</span><span class="p">):</span>

            <span class="c1"># make a set of tables that are being dropped within</span>
            <span class="c1"># the migration function</span>
            <span class="n">tables_dropped</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">directive</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">DropTableOp</span><span class="p">):</span>
                    <span class="n">tables_dropped</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">op</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">schema</span><span class="p">))</span>

            <span class="c1"># now rewrite the list of &quot;ops&quot; such that DropIndexOp</span>
            <span class="c1"># is removed for those tables.   Needs a recursive function.</span>
            <span class="n">directive</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">_filter_drop_indexes</span><span class="p">(</span><span class="n">directive</span><span class="o">.</span><span class="n">ops</span><span class="p">,</span> <span class="n">tables_dropped</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_drop_indexes</span><span class="p">(</span><span class="n">directives</span><span class="p">,</span> <span class="n">tables_dropped</span><span class="p">):</span>
        <span class="c1"># given a set of (tablename, schemaname) to be dropped, filter</span>
        <span class="c1"># out DropIndexOp from the list of directives and yield the result.</span>

        <span class="k">for</span> <span class="n">directive</span> <span class="ow">in</span> <span class="n">directives</span><span class="p">:</span>
            <span class="c1"># ModifyTableOps is a container of ALTER TABLE types of</span>
            <span class="c1"># commands.  process those in place recursively.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">directive</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">ModifyTableOps</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="n">directive</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">directive</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tables_dropped</span><span class="p">:</span>
                <span class="n">directive</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">_filter_drop_indexes</span><span class="p">(</span><span class="n">directive</span><span class="o">.</span><span class="n">ops</span><span class="p">,</span> <span class="n">tables_dropped</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># if we emptied out the directives, then skip the</span>
                <span class="c1"># container altogether.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">directive</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">directive</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">DropIndexOp</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="n">directive</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">directive</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tables_dropped</span><span class="p">:</span>
                <span class="c1"># we found a target DropIndexOp.   keep looping</span>
                <span class="k">continue</span>

            <span class="c1"># otherwise if not filtered, yield out the directive</span>
            <span class="k">yield</span> <span class="n">directive</span>

    <span class="c1"># connectable = ...</span>

    <span class="k">with</span> <span class="n">connectable</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span>
            <span class="n">target_metadata</span><span class="o">=</span><span class="n">target_metadata</span><span class="p">,</span>
            <span class="n">process_revision_directives</span><span class="o">=</span><span class="n">process_revision_directives</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">begin_transaction</span><span class="p">():</span>
            <span class="n">context</span><span class="o">.</span><span class="n">run_migrations</span><span class="p">()</span>
</pre></div>
</div>
<p>Whereas autogenerate, when dropping two tables with a foreign key and
an index, would previously generate something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">downgrade</span><span class="p">():</span>
    <span class="c1"># ### commands auto generated by Alembic - please adjust! ###</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_index</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="s1">&#39;ix_b_aid&#39;</span><span class="p">),</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="c1"># ### end Alembic commands ###</span>
</pre></div>
</div>
<p>With the above rewriter, it generates as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">downgrade</span><span class="p">():</span>
    <span class="c1"># ### commands auto generated by Alembic - please adjust! ###</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="c1"># ### end Alembic commands ###</span>
</pre></div>
</div>
</section>
<section id="don-t-generate-any-drop-table-directives-with-autogenerate">
<h2>Don’t generate any DROP TABLE directives with autogenerate<a class="headerlink" href="#don-t-generate-any-drop-table-directives-with-autogenerate" title="Link to this heading">#</a></h2>
<p>When running autogenerate against a database that has existing tables outside
of the application’s autogenerated metadata, it may be desirable to prevent
autogenerate from considering any of those existing tables to be dropped.
This will prevent autogenerate from detecting tables removed from the
local metadata as well however this is only a small caveat.</p>
<p>The most direct way to achieve this using the
<a class="reference internal" href="api/runtime.html#alembic.runtime.environment.EnvironmentContext.configure.params.include_object" title="alembic.runtime.environment.EnvironmentContext.configure"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">EnvironmentContext.configure.include_object</span></code></a> hook.   There is no
need to hardcode a fixed “whitelist” of table names; the hook gives enough
information in the given arguments to determine if a particular table name is
not part of the local <code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code> being autogenerated, by checking first
that the type of object is <code class="docutils literal notranslate"><span class="pre">&quot;table&quot;</span></code>, then that <code class="docutils literal notranslate"><span class="pre">reflected</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>,
indicating this table name is from the local database connection, not the
<code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code>, and finally that <code class="docutils literal notranslate"><span class="pre">compare_to</span></code> is <code class="docutils literal notranslate"><span class="pre">None</span></code>, indicating
autogenerate is not comparing this <code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code> to any <code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code> in
the local <code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code> collection:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># in env.py</span>

<span class="k">def</span><span class="w"> </span><span class="nf">include_object</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">reflected</span><span class="p">,</span> <span class="n">compare_to</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;table&quot;</span> <span class="ow">and</span> <span class="n">reflected</span> <span class="ow">and</span> <span class="n">compare_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="n">context</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="n">include_object</span> <span class="o">=</span> <span class="n">include_object</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="apply-custom-sorting-to-table-columns-within-create-table">
<span id="cookbook-custom-sorting-create-table"></span><h2>Apply Custom Sorting to Table Columns within CREATE TABLE<a class="headerlink" href="#apply-custom-sorting-to-table-columns-within-create-table" title="Link to this heading">#</a></h2>
<p>This example illustrates use of the <a class="reference internal" href="api/autogenerate.html#alembic.autogenerate.rewriter.Rewriter" title="alembic.autogenerate.rewriter.Rewriter"><code class="xref py py-class docutils literal notranslate"><span class="pre">Rewriter</span></code></a> object introduced
at <a class="reference internal" href="api/autogenerate.html#autogen-rewriter"><span class="std std-ref">Fine-Grained Autogenerate Generation with Rewriters</span></a>.   While the rewriter grants access to the
individual <a class="reference internal" href="api/operations.html#alembic.operations.ops.MigrateOperation" title="alembic.operations.ops.MigrateOperation"><code class="xref py py-class docutils literal notranslate"><span class="pre">ops.MigrateOperation</span></code></a> objects, there are sometimes some
special techniques required to get around some structural limitations that
are present.</p>
<p>One is when trying to reorganize the order of columns in a
table within a <a class="reference internal" href="api/operations.html#alembic.operations.ops.CreateTableOp" title="alembic.operations.ops.CreateTableOp"><code class="xref py py-class docutils literal notranslate"><span class="pre">ops.CreateTableOp</span></code></a> directive.  This directive, when
generated by autogenerate, actually holds onto the original <code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code>
object as the source of its information, so attempting to reorder the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">ops.CreateTableOp.columns</span></code> collection will usually have no effect.
Instead, a new <a class="reference internal" href="api/operations.html#alembic.operations.ops.CreateTableOp" title="alembic.operations.ops.CreateTableOp"><code class="xref py py-class docutils literal notranslate"><span class="pre">ops.CreateTableOp</span></code></a> object may be constructed with the
new ordering.   However, a second issue is that the <code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code> objects
inside will already be associated with the <code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code> that is from the
model being autogenerated, meaning they can’t be reassigned directly to a new
<code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code>.  To get around this, we can copy all the columns and constraints
using methods like <code class="xref py py-meth docutils literal notranslate"><span class="pre">Column.copy()</span></code>.</p>
<p>Below we use <a class="reference internal" href="api/autogenerate.html#alembic.autogenerate.rewriter.Rewriter" title="alembic.autogenerate.rewriter.Rewriter"><code class="xref py py-class docutils literal notranslate"><span class="pre">Rewriter</span></code></a> to create a new <a class="reference internal" href="api/operations.html#alembic.operations.ops.CreateTableOp" title="alembic.operations.ops.CreateTableOp"><code class="xref py py-class docutils literal notranslate"><span class="pre">ops.CreateTableOp</span></code></a>
directive and to copy the <code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code> objects from one into another,
copying each column or constraint object and applying a new sorting scheme:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># in env.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">alembic.operations</span><span class="w"> </span><span class="kn">import</span> <span class="n">ops</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic.autogenerate</span><span class="w"> </span><span class="kn">import</span> <span class="n">rewriter</span>

<span class="n">writer</span> <span class="o">=</span> <span class="n">rewriter</span><span class="o">.</span><span class="n">Rewriter</span><span class="p">()</span>

<span class="nd">@writer</span><span class="o">.</span><span class="n">rewrites</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">CreateTableOp</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">order_columns</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>

    <span class="n">special_names</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="mi">1001</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="mi">1002</span><span class="p">}</span>

    <span class="n">cols_by_key</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span>
            <span class="n">special_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">Column</span><span class="p">)</span>
            <span class="k">else</span> <span class="mi">2000</span><span class="p">,</span>
            <span class="n">col</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">col</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cols_by_key</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">ops</span><span class="o">.</span><span class="n">CreateTableOp</span><span class="p">(</span>
        <span class="n">op</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="o">**</span><span class="n">op</span><span class="o">.</span><span class="n">kw</span><span class="p">)</span>


<span class="c1"># ...</span>

<span class="n">context</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="n">process_revision_directives</span><span class="o">=</span><span class="n">writer</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Above, when we apply the <code class="docutils literal notranslate"><span class="pre">writer</span></code> to a table such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;my_table&quot;</span><span class="p">,</span>
    <span class="n">m</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">),</span>
    <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;uq_data&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This will render in the autogenerated file as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">upgrade</span><span class="p">():</span>
    <span class="c1"># ### commands auto generated by Alembic - please adjust! ###</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
        <span class="s2">&quot;my_table&quot;</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;uq_data&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># ### end Alembic commands ###</span>
</pre></div>
</div>
</section>
<section id="add-if-not-exists-to-create-drop-operations">
<span id="cookbook-add-if-exists"></span><h2>Add IF [NOT] EXISTS to CREATE/DROP operations<a class="headerlink" href="#add-if-not-exists-to-create-drop-operations" title="Link to this heading">#</a></h2>
<p>Sometimes CREATE/DROP operations take too long during a production deployment
and it is preferable to apply them offline,
and still keep alembic migrations aligned and/or for test environments.</p>
<p>Using the rewriter makes it possible:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">alembic.operations</span><span class="w"> </span><span class="kn">import</span> <span class="n">ops</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic.autogenerate</span><span class="w"> </span><span class="kn">import</span> <span class="n">rewriter</span>

<span class="n">writer</span> <span class="o">=</span> <span class="n">rewriter</span><span class="o">.</span><span class="n">Rewriter</span><span class="p">()</span>

<span class="nd">@writer</span><span class="o">.</span><span class="n">rewrites</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">CreateTableOp</span><span class="p">)</span>
<span class="nd">@writer</span><span class="o">.</span><span class="n">rewrites</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">CreateIndexOp</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_if_not_exists</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
    <span class="n">op</span><span class="o">.</span><span class="n">if_not_exists</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">op</span>

<span class="nd">@writer</span><span class="o">.</span><span class="n">rewrites</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">DropTableOp</span><span class="p">)</span>
<span class="nd">@writer</span><span class="o">.</span><span class="n">rewrites</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">DropIndexOp</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_if_exists</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
    <span class="n">op</span><span class="o">.</span><span class="n">if_exists</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">op</span>
</pre></div>
</div>
<p>Same operation is possible for ADD/DROP COLUMN on postgresql/mariadb:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@writer</span><span class="o">.</span><span class="n">rewrites</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">AddColumnOp</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_column_if_not_exists</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
    <span class="n">op</span><span class="o">.</span><span class="n">if_not_exists</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">op</span>

<span class="nd">@writer</span><span class="o">.</span><span class="n">rewrites</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">DropColumnOp</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">drop_column_if_not_exists</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
    <span class="n">op</span><span class="o">.</span><span class="n">if_exists</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">op</span>
</pre></div>
</div>
</section>
<section id="don-t-emit-create-table-statements-for-views">
<h2>Don’t emit CREATE TABLE statements for Views<a class="headerlink" href="#don-t-emit-create-table-statements-for-views" title="Link to this heading">#</a></h2>
<p>It is sometimes convenient to create <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/metadata.html#sqlalchemy.schema.Table" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> instances for views
so that they can be queried using normal SQLAlchemy techniques. Unfortunately this
causes Alembic to treat them as tables in need of creation and to generate spurious
<code class="docutils literal notranslate"><span class="pre">create_table()</span></code> operations. This is easily fixable by flagging such Tables and using the
<a class="reference internal" href="api/runtime.html#alembic.runtime.environment.EnvironmentContext.configure.params.include_object" title="alembic.runtime.environment.EnvironmentContext.configure"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">include_object</span></code></a> hook to exclude them:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_view</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;my_view&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">is_view</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>    <span class="c1"># Flag this as a view</span>
</pre></div>
</div>
<p>Or, if you use declarative tables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyView</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;my_view&#39;</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;is_view&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span> <span class="c1"># Flag this as a view</span>
</pre></div>
</div>
<p>Then define <code class="docutils literal notranslate"><span class="pre">include_object</span></code> as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">include_object</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">reflected</span><span class="p">,</span> <span class="n">compare_to</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exclude views from Alembic&#39;s consideration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="ow">not</span> <span class="nb">object</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_view&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, in <code class="docutils literal notranslate"><span class="pre">env.py</span></code> pass your <code class="docutils literal notranslate"><span class="pre">include_object</span></code> as a keyword argument to <a class="reference internal" href="api/runtime.html#alembic.runtime.environment.EnvironmentContext.configure" title="alembic.runtime.environment.EnvironmentContext.configure"><code class="xref py py-meth docutils literal notranslate"><span class="pre">EnvironmentContext.configure()</span></code></a>.</p>
</section>
<section id="run-multiple-alembic-environments-from-one-ini-file">
<span id="multiple-environments"></span><h2>Run Multiple Alembic Environments from one .ini file<a class="headerlink" href="#run-multiple-alembic-environments-from-one-ini-file" title="Link to this heading">#</a></h2>
<p>Long before Alembic had the “multiple bases” feature described in <a class="reference internal" href="branches.html#multiple-bases"><span class="std std-ref">Working with Multiple Bases</span></a>,
projects had a need to maintain more than one Alembic version history in a single
project, where these version histories are completely independent of each other
and each refer to their own alembic_version table, either across multiple databases,
schemas, or namespaces.  A simple approach was added to support this, the
<code class="docutils literal notranslate"><span class="pre">--name</span></code> flag on the commandline.    This flag allows named sections within
the <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> file to be present (but note it does <strong>not apply</strong> to
<code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> configuration, where only the <code class="docutils literal notranslate"><span class="pre">[tool.alembic]</span></code> section
is used).</p>
<p>First, one would create an alembic.ini file of this form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">DEFAULT</span><span class="p">]</span>
<span class="c1"># all defaults shared between environments go here</span>

<span class="n">sqlalchemy</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">postgresql</span><span class="p">:</span><span class="o">//</span><span class="n">scott</span><span class="p">:</span><span class="n">tiger</span><span class="nd">@hostname</span><span class="o">/</span><span class="n">mydatabase</span>


<span class="p">[</span><span class="n">schema1</span><span class="p">]</span>
<span class="c1"># path to env.py and migration scripts for schema1</span>
<span class="n">script_location</span> <span class="o">=</span> <span class="n">myproject</span><span class="o">/</span><span class="n">revisions</span><span class="o">/</span><span class="n">schema1</span>

<span class="p">[</span><span class="n">schema2</span><span class="p">]</span>
<span class="c1"># path to env.py and migration scripts for schema2</span>
<span class="n">script_location</span> <span class="o">=</span> <span class="n">myproject</span><span class="o">/</span><span class="n">revisions</span><span class="o">/</span><span class="n">schema2</span>

<span class="p">[</span><span class="n">schema3</span><span class="p">]</span>
<span class="c1"># path to env.py and migration scripts for schema3</span>
<span class="n">script_location</span> <span class="o">=</span> <span class="n">myproject</span><span class="o">/</span><span class="n">revisions</span><span class="o">/</span><span class="n">db2</span>

<span class="c1"># this schema uses a different database URL as well</span>
<span class="n">sqlalchemy</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">postgresql</span><span class="p">:</span><span class="o">//</span><span class="n">scott</span><span class="p">:</span><span class="n">tiger</span><span class="nd">@hostname</span><span class="o">/</span><span class="n">myotherdatabase</span>
</pre></div>
</div>
<p>Above, in the <code class="docutils literal notranslate"><span class="pre">[DEFAULT]</span></code> section we set up a default database URL.
Then we create three sections corresponding to different revision lineages
in our project.   Each of these directories would have its own <code class="docutils literal notranslate"><span class="pre">env.py</span></code>
and set of versioning files.   Then when we run the <code class="docutils literal notranslate"><span class="pre">alembic</span></code> command,
we simply give it the name of the configuration we want to use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alembic</span> <span class="o">--</span><span class="n">name</span> <span class="n">schema2</span> <span class="n">revision</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;new rev for schema 2&quot;</span> <span class="o">--</span><span class="n">autogenerate</span>
</pre></div>
</div>
<p>Above, the <code class="docutils literal notranslate"><span class="pre">alembic</span></code> command makes use of the configuration in <code class="docutils literal notranslate"><span class="pre">[schema2]</span></code>,
populated with defaults from the <code class="docutils literal notranslate"><span class="pre">[DEFAULT]</span></code> section.</p>
<p>The above approach can be automated by creating a custom front-end to the
Alembic commandline as well.</p>
</section>
<section id="print-python-code-to-generate-particular-database-tables">
<h2>Print Python Code to Generate Particular Database Tables<a class="headerlink" href="#print-python-code-to-generate-particular-database-tables" title="Link to this heading">#</a></h2>
<p>Suppose you have a database already, and want to generate some
<code class="docutils literal notranslate"><span class="pre">op.create_table()</span></code> and other directives that you’d have in a migration file.
How can we automate generating that code?
Suppose the database schema looks like (assume MySQL):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CREATE TABLE IF NOT EXISTS `users` (
    `id` int(11) NOT NULL,
    KEY `id` (`id`)
);

CREATE TABLE IF NOT EXISTS `user_properties` (
  `users_id` int(11) NOT NULL,
  `property_name` varchar(255) NOT NULL,
  `property_value` mediumtext NOT NULL,
  UNIQUE KEY `property_name_users_id` (`property_name`,`users_id`),
  KEY `users_id` (`users_id`),
  CONSTRAINT `user_properties_ibfk_1` FOREIGN KEY (`users_id`)
  REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</pre></div>
</div>
<p>Using <a class="reference internal" href="api/operations.html#alembic.operations.ops.UpgradeOps" title="alembic.operations.ops.UpgradeOps"><code class="xref py py-class docutils literal notranslate"><span class="pre">ops.UpgradeOps</span></code></a>, <a class="reference internal" href="api/operations.html#alembic.operations.ops.CreateTableOp" title="alembic.operations.ops.CreateTableOp"><code class="xref py py-class docutils literal notranslate"><span class="pre">ops.CreateTableOp</span></code></a>, and
<a class="reference internal" href="api/operations.html#alembic.operations.ops.CreateIndexOp" title="alembic.operations.ops.CreateIndexOp"><code class="xref py py-class docutils literal notranslate"><span class="pre">ops.CreateIndexOp</span></code></a>, we create a migration file structure,
using <code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code> objects that we get from SQLAlchemy reflection.
The structure is passed to <a class="reference internal" href="api/autogenerate.html#alembic.autogenerate.render_python_code" title="alembic.autogenerate.render_python_code"><code class="xref py py-func docutils literal notranslate"><span class="pre">autogenerate.render_python_code()</span></code></a> to
produce the Python code for a migration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">autogenerate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic.operations</span><span class="w"> </span><span class="kn">import</span> <span class="n">ops</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;mysql://scott:tiger@localhost/test&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">e</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
    <span class="n">user_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">user_property_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;user_properties&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">autogenerate</span><span class="o">.</span><span class="n">render_python_code</span><span class="p">(</span>
    <span class="n">ops</span><span class="o">.</span><span class="n">UpgradeOps</span><span class="p">(</span>
        <span class="n">ops</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">CreateTableOp</span><span class="o">.</span><span class="n">from_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">CreateIndexOp</span><span class="o">.</span><span class="n">from_index</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">indexes</span>
        <span class="p">]</span>
    <span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ### commands auto generated by Alembic - please adjust! ###</span>
<span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span>
<span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">mysql</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">(</span><span class="n">display_width</span><span class="o">=</span><span class="mi">11</span><span class="p">),</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="n">mysql_default_charset</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">,</span>
<span class="n">mysql_engine</span><span class="o">=</span><span class="s1">&#39;InnoDB&#39;</span>
<span class="p">)</span>
<span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s1">&#39;user_properties&#39;</span><span class="p">,</span>
<span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;users_id&#39;</span><span class="p">,</span> <span class="n">mysql</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">(</span><span class="n">display_width</span><span class="o">=</span><span class="mi">11</span><span class="p">),</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;property_name&#39;</span><span class="p">,</span> <span class="n">mysql</span><span class="o">.</span><span class="n">VARCHAR</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;property_value&#39;</span><span class="p">,</span> <span class="n">mysql</span><span class="o">.</span><span class="n">MEDIUMTEXT</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="n">sa</span><span class="o">.</span><span class="n">ForeignKeyConstraint</span><span class="p">([</span><span class="s1">&#39;users_id&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;users.id&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user_properties_ibfk_1&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
<span class="n">mysql_comment</span><span class="o">=</span><span class="s1">&#39;user properties&#39;</span><span class="p">,</span>
<span class="n">mysql_default_charset</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">,</span>
<span class="n">mysql_engine</span><span class="o">=</span><span class="s1">&#39;InnoDB&#39;</span>
<span class="p">)</span>
<span class="n">op</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">op</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;users_id&#39;</span><span class="p">,</span> <span class="s1">&#39;user_properties&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;users_id&#39;</span><span class="p">],</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">op</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;property_name_users_id&#39;</span><span class="p">,</span> <span class="s1">&#39;user_properties&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;property_name&#39;</span><span class="p">,</span> <span class="s1">&#39;users_id&#39;</span><span class="p">],</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># ### end Alembic commands ###</span>
</pre></div>
</div>
</section>
<section id="run-alembic-operation-objects-directly-as-in-from-autogenerate">
<h2>Run Alembic Operation Objects Directly (as in from autogenerate)<a class="headerlink" href="#run-alembic-operation-objects-directly-as-in-from-autogenerate" title="Link to this heading">#</a></h2>
<p>The <a class="reference internal" href="ops.html#alembic.operations.Operations" title="alembic.operations.Operations"><code class="xref py py-class docutils literal notranslate"><span class="pre">Operations</span></code></a> object has a method known as
<a class="reference internal" href="ops.html#alembic.operations.Operations.invoke" title="alembic.operations.Operations.invoke"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.invoke()</span></code></a> that will generically invoke a particular operation
object.  We can therefore use the <a class="reference internal" href="api/autogenerate.html#alembic.autogenerate.produce_migrations" title="alembic.autogenerate.produce_migrations"><code class="xref py py-func docutils literal notranslate"><span class="pre">autogenerate.produce_migrations()</span></code></a>
function to run an autogenerate comparison, get back a
<a class="reference internal" href="api/operations.html#alembic.operations.ops.MigrationScript" title="alembic.operations.ops.MigrationScript"><code class="xref py py-class docutils literal notranslate"><span class="pre">ops.MigrationScript</span></code></a> structure representing the changes, and with a
little bit of insider information we can invoke them directly.</p>
<p>The traversal through the <a class="reference internal" href="api/operations.html#alembic.operations.ops.MigrationScript" title="alembic.operations.ops.MigrationScript"><code class="xref py py-class docutils literal notranslate"><span class="pre">ops.MigrationScript</span></code></a> structure is as
follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">use_batch</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span>

<span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">migrations</span><span class="o">.</span><span class="n">upgrade_ops</span><span class="p">]</span>
<span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
    <span class="n">elem</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_batch</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">ModifyTableOps</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">operations</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span>
            <span class="n">elem</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">elem</span><span class="o">.</span><span class="n">schema</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">batch_ops</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">table_elem</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                <span class="n">batch_ops</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">table_elem</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s2">&quot;ops&quot;</span><span class="p">):</span>
        <span class="n">stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">operations</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
</pre></div>
</div>
<p>Above, we detect elements that have a collection of operations by looking
for the <code class="docutils literal notranslate"><span class="pre">.ops</span></code> attribute.   A check for <a class="reference internal" href="api/operations.html#alembic.operations.ops.ModifyTableOps" title="alembic.operations.ops.ModifyTableOps"><code class="xref py py-class docutils literal notranslate"><span class="pre">ModifyTableOps</span></code></a> allows
us to use a batch context if we are supporting that.</p>
<p>A full example follows.  The overall setup here is copied from the example
at <a class="reference internal" href="api/autogenerate.html#alembic.autogenerate.compare_metadata" title="alembic.autogenerate.compare_metadata"><code class="xref py py-func docutils literal notranslate"><span class="pre">autogenerate.compare_metadata()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">alembic.autogenerate</span><span class="w"> </span><span class="kn">import</span> <span class="n">produce_migrations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic.migration</span><span class="w"> </span><span class="kn">import</span> <span class="n">MigrationContext</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic.operations</span><span class="w"> </span><span class="kn">import</span> <span class="n">Operations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic.operations.ops</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModifyTableOps</span>


<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite://&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create table foo (</span>
<span class="sd">            id integer not null primary key,</span>
<span class="sd">            old_data varchar(50),</span>
<span class="sd">            x integer</span>
<span class="sd">        )&quot;&quot;&quot;</span>
    <span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create table bar (</span>
<span class="sd">            data varchar(50)</span>
<span class="sd">        )&quot;&quot;&quot;</span>
    <span class="p">)</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">Table</span><span class="p">(</span><span class="s2">&quot;bat&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">)))</span>

<span class="n">mc</span> <span class="o">=</span> <span class="n">MigrationContext</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>

<span class="n">migrations</span> <span class="o">=</span> <span class="n">produce_migrations</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

<span class="n">operations</span> <span class="o">=</span> <span class="n">Operations</span><span class="p">(</span><span class="n">mc</span><span class="p">)</span>

<span class="n">use_batch</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span>

<span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">migrations</span><span class="o">.</span><span class="n">upgrade_ops</span><span class="p">]</span>
<span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
    <span class="n">elem</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_batch</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">ModifyTableOps</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">operations</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span>
            <span class="n">elem</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">elem</span><span class="o">.</span><span class="n">schema</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">batch_ops</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">table_elem</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                <span class="n">batch_ops</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">table_elem</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s2">&quot;ops&quot;</span><span class="p">):</span>
        <span class="n">stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">operations</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="test-current-database-revision-is-at-head-s">
<span id="cookbook-check-heads"></span><h2>Test current database revision is at head(s)<a class="headerlink" href="#test-current-database-revision-is-at-head-s" title="Link to this heading">#</a></h2>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 1.17.1: </span>This recipe is now part of the <code class="docutils literal notranslate"><span class="pre">alembic</span> <span class="pre">current</span></code>
command using the <a class="reference internal" href="api/commands.html#alembic.command.current.params.check_heads" title="alembic.command.current"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">command.current.check_heads</span></code></a> parameter,
available from the command line as <code class="docutils literal notranslate"><span class="pre">--check-heads</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alembic</span> <span class="n">current</span> <span class="o">--</span><span class="n">check</span><span class="o">-</span><span class="n">heads</span>

<span class="n">INFO</span>  <span class="p">[</span><span class="n">alembic</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">migration</span><span class="p">]</span> <span class="n">Context</span> <span class="n">impl</span> <span class="n">SQLiteImpl</span><span class="o">.</span>
<span class="n">INFO</span>  <span class="p">[</span><span class="n">alembic</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">migration</span><span class="p">]</span> <span class="n">Will</span> <span class="n">assume</span> <span class="n">non</span><span class="o">-</span><span class="n">transactional</span> <span class="n">DDL</span><span class="o">.</span>
<span class="n">ERROR</span> <span class="p">[</span><span class="n">alembic</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">messaging</span><span class="p">]</span> <span class="n">Database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">on</span> <span class="nb">all</span> <span class="n">head</span> <span class="n">revisions</span>
<span class="n">FAILED</span><span class="p">:</span> <span class="n">Database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">on</span> <span class="nb">all</span> <span class="n">head</span> <span class="n">revisions</span>
</pre></div>
</div>
</div>
<p>A recipe to determine if a database schema is up to date in terms of applying
Alembic migrations.   May be useful for test or installation suites to
determine if the target database is up to date.   Makes use of the
<a class="reference internal" href="api/runtime.html#alembic.runtime.migration.MigrationContext.get_current_heads" title="alembic.runtime.migration.MigrationContext.get_current_heads"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MigrationContext.get_current_heads()</span></code></a> as well as
<a class="reference internal" href="api/script.html#alembic.script.ScriptDirectory.get_heads" title="alembic.script.ScriptDirectory.get_heads"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ScriptDirectory.get_heads()</span></code></a> methods so that it accommodates for a
branched revision tree:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">script</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic.runtime</span><span class="w"> </span><span class="kn">import</span> <span class="n">migration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">engine</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_current_head</span><span class="p">(</span><span class="n">alembic_cfg</span><span class="p">,</span> <span class="n">connectable</span><span class="p">):</span>
    <span class="c1"># type: (config.Config, engine.Engine) -&gt; bool</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">ScriptDirectory</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">alembic_cfg</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">connectable</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">migration</span><span class="o">.</span><span class="n">MigrationContext</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get_current_heads</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">directory</span><span class="o">.</span><span class="n">get_heads</span><span class="p">())</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;mysql://scott:tiger@localhost/test&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="s2">&quot;alembic.ini&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">check_current_head</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="api/runtime.html#alembic.runtime.migration.MigrationContext.get_current_heads" title="alembic.runtime.migration.MigrationContext.get_current_heads"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MigrationContext.get_current_heads()</span></code></a></p>
<p><a class="reference internal" href="api/script.html#alembic.script.ScriptDirectory.get_heads" title="alembic.script.ScriptDirectory.get_heads"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ScriptDirectory.get_heads()</span></code></a></p>
</div>
</section>
<section id="using-asyncio-with-alembic">
<span id="asyncio-recipe"></span><h2>Using Asyncio with Alembic<a class="headerlink" href="#using-asyncio-with-alembic" title="Link to this heading">#</a></h2>
<p>SQLAlchemy version 1.4 introduced experimental support for asyncio, allowing
use of most of its interface from async applications. Alembic currently does
not provide an async api directly, but it can use an use SQLAlchemy Async
engine to run the migrations and autogenerate.</p>
<p>New configurations can use the template “async” or “pyproject_async” to bootstrap an environment which
can be used with async DBAPI like asyncpg, running the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alembic</span> <span class="n">init</span> <span class="o">-</span><span class="n">t</span> <span class="k">async</span> <span class="o">&lt;</span><span class="n">script_directory_here</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Existing configurations can be updated to use an async DBAPI by updating the <code class="docutils literal notranslate"><span class="pre">env.py</span></code>
file that’s used by Alembic to start its operations. In particular only
<code class="docutils literal notranslate"><span class="pre">run_migrations_online</span></code> will need to be updated to be something like the example below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_engine_from_config</span>

<span class="c1"># ... no change required to the rest of the code</span>


<span class="k">def</span><span class="w"> </span><span class="nf">do_run_migrations</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
    <span class="n">context</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span> <span class="n">target_metadata</span><span class="o">=</span><span class="n">target_metadata</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">begin_transaction</span><span class="p">():</span>
        <span class="n">context</span><span class="o">.</span><span class="n">run_migrations</span><span class="p">()</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_async_migrations</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;In this scenario we need to create an Engine</span>
<span class="sd">    and associate a connection with the context.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">connectable</span> <span class="o">=</span> <span class="n">async_engine_from_config</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">config_ini_section</span><span class="p">),</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;sqlalchemy.&quot;</span><span class="p">,</span>
        <span class="n">poolclass</span><span class="o">=</span><span class="n">pool</span><span class="o">.</span><span class="n">NullPool</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">connectable</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">do_run_migrations</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">connectable</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">run_migrations_online</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run migrations in &#39;online&#39; mode.&quot;&quot;&quot;</span>

    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_async_migrations</span><span class="p">())</span>
</pre></div>
</div>
<p>An async application can also interact with the Alembic api directly by using
the SQLAlchemy <code class="docutils literal notranslate"><span class="pre">run_sync</span></code> method to adapt the non-async api of Alembic to
an async consumer.</p>
<section id="programmatic-api-use-connection-sharing-with-asyncio">
<span id="connection-sharing-plus-asyncio"></span><h3>Programmatic API use (connection sharing) With Asyncio<a class="headerlink" href="#programmatic-api-use-connection-sharing-with-asyncio" title="Link to this heading">#</a></h3>
<p>Combining the examples of <a class="reference internal" href="#connection-sharing"><span class="std std-ref">Sharing a Connection across one or more programmatic migration commands</span></a> with <a class="reference internal" href="#asyncio-recipe"><span class="std std-ref">Using Asyncio with Alembic</span></a>
together, the  <code class="docutils literal notranslate"><span class="pre">env.py</span></code> listed above can be updated as follows works:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run_migrations_online</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run migrations in &#39;online&#39; mode.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">connectable</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;connection&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connectable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_async_migrations</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">do_run_migrations</span><span class="p">(</span><span class="n">connectable</span><span class="p">)</span>
</pre></div>
</div>
<p>Above, using an asyncio database URL in <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> one can run
commands such as <code class="docutils literal notranslate"><span class="pre">alembic</span> <span class="pre">upgrade</span></code> from the command line.  Programmatically,
the same <code class="docutils literal notranslate"><span class="pre">env.py</span></code> file can be invoked using asyncio as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_async_engine</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">command</span><span class="p">,</span> <span class="n">config</span>


<span class="k">def</span><span class="w"> </span><span class="nf">run_upgrade</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;connection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span>
    <span class="n">command</span><span class="o">.</span><span class="n">upgrade</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;head&quot;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_async_upgrade</span><span class="p">():</span>
    <span class="n">async_engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span><span class="s2">&quot;sqlite+aiosqlite://&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">async_engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">run_upgrade</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="s2">&quot;alembic.ini&quot;</span><span class="p">))</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_async_upgrade</span><span class="p">())</span>
</pre></div>
</div>
</section>
</section>
<section id="data-migrations-general-techniques">
<h2>Data Migrations - General Techniques<a class="headerlink" href="#data-migrations-general-techniques" title="Link to this heading">#</a></h2>
<p>Alembic migrations are designed for schema migrations.
The nature of data migrations are inherently different and it’s not in fact advisable
in the general case to write data migrations that integrate with Alembic’s
schema versioning model.
For example downgrades are difficult to address since they might require deletion of data,
which may even not be possible to detect.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The solution needs to be designed specifically for each individual application and migration.
There are no general rules and the following text is only a recommendation based on experience.</p>
</div>
<p>There are three basic approaches for the data migrations.</p>
<section id="small-data">
<h3>Small data<a class="headerlink" href="#small-data" title="Link to this heading">#</a></h3>
<p>Small data migrations are easy to perform, especially in cases of initial data to a new table.
These can be handled using <a class="reference internal" href="ops.html#alembic.operations.Operations.bulk_insert" title="alembic.operations.Operations.bulk_insert"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.bulk_insert()</span></code></a>.</p>
</section>
<section id="separate-migration-script">
<h3>Separate migration script<a class="headerlink" href="#separate-migration-script" title="Link to this heading">#</a></h3>
<p>One possibility is a completely separate script aside of alembic migrations.
The complete migration is then processed in following steps:</p>
<ol class="arabic simple">
<li><p>Run the initial alembic migrations (new columns etc.)</p></li>
<li><p>Run the separate data migration script</p></li>
<li><p>Run the final alembic migrations (database constraints, delete columns etc.)</p></li>
</ol>
<p>The data migration script may also need a separate ORM model to handle intermediate state of the database.</p>
</section>
<section id="online-migration">
<h3>Online migration<a class="headerlink" href="#online-migration" title="Link to this heading">#</a></h3>
<p>The application maintains a version of schema with both versions.
Writes are performed on both places, while the background script move all the remaining data across.
This technique is very challenging and time demanding, since it requires custom application logic to
handle the intermediate states.</p>
</section>
</section>
<section id="extend-commandline-with-custom-commands">
<span id="custom-commandline"></span><h2>Extend <code class="docutils literal notranslate"><span class="pre">CommandLine</span></code> with custom commands<a class="headerlink" href="#extend-commandline-with-custom-commands" title="Link to this heading">#</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 1.15.3.</span></p>
</div>
<p>While Alembic does not have a plugin system that would allow transparently extending the original <code class="docutils literal notranslate"><span class="pre">alembic</span></code> CLI
with additional commands, it is possible to create your own instance of <a class="reference internal" href="api/config.html#alembic.config.CommandLine" title="alembic.config.CommandLine"><code class="xref py py-class docutils literal notranslate"><span class="pre">CommandLine</span></code></a> and extend that via
<a class="reference internal" href="api/config.html#alembic.config.CommandLine.register_command" title="alembic.config.CommandLine.register_command"><code class="xref py py-meth docutils literal notranslate"><span class="pre">CommandLine.register_command()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># myalembic.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">alembic.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommandLine</span><span class="p">,</span> <span class="n">Config</span>


<span class="k">def</span><span class="w"> </span><span class="nf">frobnicate</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">revision</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Frobnicates according to the frobnication specification.</span>

<span class="sd">    :param config: a :class:`.Config` instance</span>
<span class="sd">    :param revision: the revision to frobnicate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span><span class="o">.</span><span class="n">print_stdout</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Revision </span><span class="si">{</span><span class="n">revision</span><span class="si">}</span><span class="s2"> successfully frobnicated.&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">cli</span> <span class="o">=</span> <span class="n">CommandLine</span><span class="p">()</span>
    <span class="n">cli</span><span class="o">.</span><span class="n">register_command</span><span class="p">(</span><span class="n">frobnicate</span><span class="p">)</span>
    <span class="n">cli</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Any named function may be registered as a command, provided it accepts a <a class="reference internal" href="api/config.html#alembic.config.Config" title="alembic.config.Config"><code class="xref py py-class docutils literal notranslate"><span class="pre">Config</span></code></a> object as the first argument;
a docstring is also recommended as it will show up in the help output of the CLI.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python -m myalembic -h
...
positional arguments:
  {branches,check,current,downgrade,edit,ensure_version,heads,history,init,list_templates,merge,revision,show,stamp,upgrade,frobnicate}
    ...
    frobnicate          Frobnicates according to the frobnication specification.

$ python -m myalembic frobnicate -h
usage: myalembic.py frobnicate [-h] revision

positional arguments:
revision    revision identifier

optional arguments:
-h, --help  show this help message and exit

$ python -m myalembic frobnicate 42
Revision 42 successfully frobnicated.
</pre></div>
</div>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="ops.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Operation Reference</p>
      </div>
    </a>
    <a class="right-next"
       href="api/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">API Details</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-an-up-to-date-database-from-scratch">Building an Up to Date Database from Scratch</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conditional-migration-elements">Conditional Migration Elements</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sharing-a-connection-across-one-or-more-programmatic-migration-commands">Sharing a Connection across one or more programmatic migration commands</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#replaceable-objects">Replaceable Objects</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-replaceable-object-structure">The Replaceable Object Structure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-operations-for-the-target-objects">Create Operations for the Target Objects</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#publish-the-extensions">Publish the Extensions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-initial-migrations">Create Initial Migrations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-revision-migrations">Create Revision Migrations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rudimental-schema-level-multi-tenancy-for-postgresql-mysql-other-databases">Rudimental Schema-Level Multi Tenancy for PostgreSQL, MySQL, Other Databases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#don-t-generate-empty-migrations-with-autogenerate">Don’t Generate Empty Migrations with Autogenerate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#don-t-emit-drop-index-when-the-table-is-to-be-dropped-as-well">Don’t emit DROP INDEX when the table is to be dropped as well</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#don-t-generate-any-drop-table-directives-with-autogenerate">Don’t generate any DROP TABLE directives with autogenerate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-custom-sorting-to-table-columns-within-create-table">Apply Custom Sorting to Table Columns within CREATE TABLE</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-if-not-exists-to-create-drop-operations">Add IF [NOT] EXISTS to CREATE/DROP operations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#don-t-emit-create-table-statements-for-views">Don’t emit CREATE TABLE statements for Views</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-multiple-alembic-environments-from-one-ini-file">Run Multiple Alembic Environments from one .ini file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#print-python-code-to-generate-particular-database-tables">Print Python Code to Generate Particular Database Tables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-alembic-operation-objects-directly-as-in-from-autogenerate">Run Alembic Operation Objects Directly (as in from autogenerate)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-current-database-revision-is-at-head-s">Test current database revision is at head(s)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-asyncio-with-alembic">Using Asyncio with Alembic</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#programmatic-api-use-connection-sharing-with-asyncio">Programmatic API use (connection sharing) With Asyncio</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-migrations-general-techniques">Data Migrations - General Techniques</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-data">Small data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#separate-migration-script">Separate migration script</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#online-migration">Online migration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extend-commandline-with-custom-commands">Extend <code class="docutils literal notranslate"><span class="pre">CommandLine</span></code> with custom commands</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Mike Bayer
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2010-2026, Mike Bayer.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>