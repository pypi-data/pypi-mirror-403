
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Running “Batch” Migrations for SQLite and Other Databases &#8212; Alembic 1.18.3 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/changelog.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx_paramlinks.css" />
    <link rel="stylesheet" type="text/css" href="_static/site_custom_css.css?v=54a89d43" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=3388b72f"></script>
    <script src="_static/doctools.js?v=fd6eb6e6"></script>
    <script src="_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=046fa432"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'batch';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Working with Branches" href="branches.html" />
    <link rel="prev" title="The Importance of Naming Constraints" href="naming.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Alembic 1.18.3 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/sqlalchemy/alembic" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/alembic/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="https://img.shields.io/pypi/dw/alembic" class="icon-link-image" alt="PyPI"/></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="front.html">Front Matter</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="autogenerate.html">Auto Generating Migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="offline.html">Generating SQL Scripts (a.k.a. “Offline Mode”)</a></li>
<li class="toctree-l1"><a class="reference internal" href="naming.html">The Importance of Naming Constraints</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Running “Batch” Migrations for SQLite and Other Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="branches.html">Working with Branches</a></li>
<li class="toctree-l1"><a class="reference internal" href="ops.html">Operation Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="cookbook.html">Cookbook</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="api/index.html">API Details</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="api/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/runtime.html">Runtime Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/config.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/commands.html">Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/operations.html">Operation Directives</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/autogenerate.html">Autogeneration</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/script.html">Script Directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/ddl.html">DDL Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/plugins.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/exceptions.html">Exception Objects</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/batch.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Running “Batch” Migrations for SQLite and Other Databases</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#controlling-table-reflection">Controlling Table Reflection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-constraints">Dealing with Constraints</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dropping-unnamed-or-named-foreign-key-constraints">Dropping Unnamed or Named Foreign Key Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-the-type-of-boolean-enum-and-other-implicit-check-datatypes">Changing the Type of Boolean, Enum and other implicit CHECK datatypes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#including-check-constraints">Including CHECK constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-referencing-foreign-keys">Dealing with Referencing Foreign Keys</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#working-in-offline-mode">Working in Offline Mode</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-mode-with-autogenerate">Batch mode with Autogenerate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-mode-with-databases-other-than-sqlite">Batch mode with databases other than SQLite</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="running-batch-migrations-for-sqlite-and-other-databases">
<span id="batch-migrations"></span><h1>Running “Batch” Migrations for SQLite and Other Databases<a class="headerlink" href="#running-batch-migrations-for-sqlite-and-other-databases" title="Link to this heading">#</a></h1>
<p>The SQLite database presents a challenge to migration tools
in that it has almost no support for the ALTER statement which
relational schema migrations rely upon.  The rationale for this stems from
philosophical and architectural concerns within SQLite, and they are unlikely
to be changed.</p>
<p>Migration tools are instead expected to produce copies of SQLite tables that
correspond to the new structure, transfer the data from the existing
table to the new one, then drop the old table.  For our purposes here
we’ll call this <strong>“move and copy”</strong> workflow, and in order to accommodate it
in a way that is reasonably predictable, while also remaining compatible
with other databases, Alembic provides the <strong>batch</strong> operations context.</p>
<p>Within this context, a relational table is named, and then a series of
mutation operations to that table alone are specified within
the block.  When the context is complete, a process begins whereby the
“move and copy” procedure begins; the existing table structure is reflected
from the database, a new version of this table is created with the given
changes, data is copied from the
old table to the new table using “INSERT from SELECT”, and finally the old
table is dropped and the new one renamed to the original name.</p>
<p>The <a class="reference internal" href="ops.html#alembic.operations.Operations.batch_alter_table" title="alembic.operations.Operations.batch_alter_table"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.batch_alter_table()</span></code></a> method provides the gateway to this
process:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">op</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span><span class="s2">&quot;some_table&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch_op</span><span class="p">:</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">))</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>When the above directives are invoked within a migration script, on a
SQLite backend we would see SQL like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">_alembic_batch_temp</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">foo</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">_alembic_batch_temp</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">some_table</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">some_table</span><span class="p">;</span>
<span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">_alembic_batch_temp</span><span class="w"> </span><span class="k">RENAME</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">some_table</span><span class="p">;</span>
</pre></div>
</div>
<p>On other backends, we’d see the usual <code class="docutils literal notranslate"><span class="pre">ALTER</span></code> statements done as though
there were no batch directive - the batch context by default only does
the “move and copy” process if SQLite is in use, and if there are
migration directives other than <a class="reference internal" href="ops.html#alembic.operations.Operations.add_column" title="alembic.operations.Operations.add_column"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.add_column()</span></code></a> present,
which is the one kind of column-level ALTER statement that SQLite supports.
<a class="reference internal" href="ops.html#alembic.operations.Operations.batch_alter_table" title="alembic.operations.Operations.batch_alter_table"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.batch_alter_table()</span></code></a> can be configured
to run “move and copy” unconditionally in all cases, including on databases
other than SQLite; more on this is below.</p>
<section id="controlling-table-reflection">
<span id="batch-controlling-table-reflection"></span><h2>Controlling Table Reflection<a class="headerlink" href="#controlling-table-reflection" title="Link to this heading">#</a></h2>
<p>The <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/metadata.html#sqlalchemy.schema.Table" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object that is reflected when
“move and copy” proceeds is performed using the standard <code class="docutils literal notranslate"><span class="pre">autoload=True</span></code>
approach.  This call can be affected using the
<a class="reference internal" href="ops.html#alembic.operations.Operations.batch_alter_table.params.reflect_args" title="alembic.operations.Operations.batch_alter_table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">reflect_args</span></code></a> and
<a class="reference internal" href="ops.html#alembic.operations.Operations.batch_alter_table.params.reflect_kwargs" title="alembic.operations.Operations.batch_alter_table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">reflect_kwargs</span></code></a> arguments.
For example, to override a <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/metadata.html#sqlalchemy.schema.Column" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> within
the reflection process such that a <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/type_basics.html#sqlalchemy.types.Boolean" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boolean</span></code></a>
object is reflected with the <code class="docutils literal notranslate"><span class="pre">create_constraint</span></code> flag set to <code class="docutils literal notranslate"><span class="pre">False</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span>
    <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
    <span class="n">reflect_args</span><span class="o">=</span><span class="p">[</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">(</span><span class="n">create_constraint</span><span class="o">=</span><span class="kc">False</span><span class="p">))]</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">batch_op</span><span class="p">:</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">alter_column</span><span class="p">(</span>
        <span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="n">new_column_name</span><span class="o">=</span><span class="s1">&#39;bflag&#39;</span><span class="p">,</span> <span class="n">existing_type</span><span class="o">=</span><span class="n">Boolean</span><span class="p">)</span>
</pre></div>
</div>
<p>Another use case, add a listener to the <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/metadata.html#sqlalchemy.schema.Table" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
as it is reflected so that special logic can be applied to columns or
types, using the <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/events.html#sqlalchemy.events.DDLEvents.column_reflect" title="(in SQLAlchemy v2.1)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">column_reflect()</span></code></a> event:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">listen_for_reflect</span><span class="p">(</span><span class="n">inspector</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">column_info</span><span class="p">):</span>
    <span class="s2">&quot;correct an ENUM type&quot;</span>
    <span class="k">if</span> <span class="n">column_info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;my_enum&#39;</span><span class="p">:</span>
        <span class="n">column_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span>
    <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
    <span class="n">reflect_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">listeners</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;column_reflect&#39;</span><span class="p">,</span> <span class="n">listen_for_reflect</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">batch_op</span><span class="p">:</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">alter_column</span><span class="p">(</span>
        <span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="n">new_column_name</span><span class="o">=</span><span class="s1">&#39;bflag&#39;</span><span class="p">,</span> <span class="n">existing_type</span><span class="o">=</span><span class="n">Boolean</span><span class="p">)</span>
</pre></div>
</div>
<p>The reflection process may also be bypassed entirely by sending a
pre-fabricated <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/metadata.html#sqlalchemy.schema.Table" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object; see
<a class="reference internal" href="#batch-offline-mode"><span class="std std-ref">Working in Offline Mode</span></a> for an example.</p>
</section>
<section id="dealing-with-constraints">
<span id="sqlite-batch-constraints"></span><h2>Dealing with Constraints<a class="headerlink" href="#dealing-with-constraints" title="Link to this heading">#</a></h2>
<p>There are a variety of issues when using “batch” mode with constraints,
such as FOREIGN KEY, CHECK and UNIQUE constraints.  This section
will attempt to detail many of these scenarios.</p>
<section id="dropping-unnamed-or-named-foreign-key-constraints">
<span id="dropping-sqlite-foreign-keys"></span><h3>Dropping Unnamed or Named Foreign Key Constraints<a class="headerlink" href="#dropping-unnamed-or-named-foreign-key-constraints" title="Link to this heading">#</a></h3>
<p>SQLite, unlike any other database, allows constraints to exist in the
database that have no identifying name.  On all other backends, the
target database will always generate some kind of name, if one is not
given.</p>
<p>The challenge this represents is that an unnamed constraint can’t
by itself be targeted by the <a class="reference internal" href="ops.html#alembic.operations.BatchOperations.drop_constraint" title="alembic.operations.BatchOperations.drop_constraint"><code class="xref py py-meth docutils literal notranslate"><span class="pre">BatchOperations.drop_constraint()</span></code></a> method.
An unnamed FOREIGN KEY constraint is implicit whenever the
<a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/constraints.html#sqlalchemy.schema.ForeignKey" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKey</span></code></a>
or <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKeyConstraint</span></code></a> objects are used without
passing them a name.  Only on SQLite will these constraints remain entirely
unnamed when they are created on the target database; an automatically generated
name will be assigned in the case of all other database backends.</p>
<p>Within the scope of batch mode, this presents the issue that the
<a class="reference internal" href="ops.html#alembic.operations.BatchOperations.drop_constraint" title="alembic.operations.BatchOperations.drop_constraint"><code class="xref py py-meth docutils literal notranslate"><span class="pre">BatchOperations.drop_constraint()</span></code></a> method requires a constraint name
in order to target the correct constraint.</p>
<p>In order to overcome this, the <a class="reference internal" href="ops.html#alembic.operations.Operations.batch_alter_table" title="alembic.operations.Operations.batch_alter_table"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.batch_alter_table()</span></code></a> method supports a
<a class="reference internal" href="ops.html#alembic.operations.Operations.batch_alter_table.params.naming_convention" title="alembic.operations.Operations.batch_alter_table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">naming_convention</span></code></a> argument, so that
all reflected constraints, including foreign keys that are unnamed may be
given a name, as described in <a class="reference internal" href="naming.html#autogen-naming-conventions"><span class="std std-ref">Integration of Naming Conventions into Operations, Autogenerate</span></a>.
Usage is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">naming_convention</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;fk&quot;</span><span class="p">:</span>
    <span class="s2">&quot;fk_</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">_</span><span class="si">%(referred_table_name)s</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span>
        <span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">naming_convention</span><span class="o">=</span><span class="n">naming_convention</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch_op</span><span class="p">:</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">drop_constraint</span><span class="p">(</span>
        <span class="s2">&quot;fk_bar_foo_id_foo&quot;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="s2">&quot;foreignkey&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the naming convention feature requires at least
<strong>SQLAlchemy 0.9.4</strong> for support.</p>
</section>
<section id="changing-the-type-of-boolean-enum-and-other-implicit-check-datatypes">
<span id="batch-schematype-constraints"></span><h3>Changing the Type of Boolean, Enum and other implicit CHECK datatypes<a class="headerlink" href="#changing-the-type-of-boolean-enum-and-other-implicit-check-datatypes" title="Link to this heading">#</a></h3>
<p>The SQLAlchemy types <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/type_basics.html#sqlalchemy.types.Boolean" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boolean</span></code></a> and
<a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/type_basics.html#sqlalchemy.types.Enum" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> are part of a category of types known as
“schema” types; this style of type creates other structures along with the
type itself, most commonly (but not always) a CHECK constraint.</p>
<p>Alembic handles dropping and creating the CHECK constraints here automatically,
including in the case of batch mode.  When changing the type of an existing
column, what’s necessary is that the existing type be specified fully:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span><span class="s2">&quot;some_table&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch_op</span><span class="p">:</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">alter_column</span><span class="p">(</span>
        <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">existing_type</span><span class="o">=</span><span class="n">Boolean</span><span class="p">(</span><span class="n">create_constraint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constraint_name</span><span class="o">=</span><span class="s2">&quot;ck1&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>When dropping a column that includes a named CHECK constraint, as of Alembic
1.7 this named constraint must also be provided using a similar form, as there
is no ability for Alembic to otherwise link this reflected CHECK constraint as
belonging to a particular column:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span><span class="s2">&quot;some_table&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch_op</span><span class="p">:</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span>
        <span class="s1">&#39;q&#39;</span><span class="p">,</span>
        <span class="n">existing_type</span><span class="o">=</span><span class="n">Boolean</span><span class="p">(</span><span class="n">create_constraint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constraint_name</span><span class="o">=</span><span class="s2">&quot;ck1&quot;</span><span class="p">))</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 1.7: </span>The <a class="reference internal" href="ops.html#alembic.operations.BatchOperations.drop_column" title="alembic.operations.BatchOperations.drop_column"><code class="xref py py-meth docutils literal notranslate"><span class="pre">BatchOperations.drop_column()</span></code></a> operation can
accept an <code class="docutils literal notranslate"><span class="pre">existing_type</span></code> directive where a “schema type” such as
<a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/type_basics.html#sqlalchemy.types.Boolean" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boolean</span></code></a> and <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/type_basics.html#sqlalchemy.types.Enum" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> may
be specified such that an associated named constraint can be removed.</p>
</div>
</section>
<section id="including-check-constraints">
<span id="batch-check-constraints"></span><h3>Including CHECK constraints<a class="headerlink" href="#including-check-constraints" title="Link to this heading">#</a></h3>
<p>As of Alembic 1.7, <strong>named</strong> CHECK constraints are automatically included
in batch mode, as modern SQLAlchemy versions are capable of reflecting these
constraints like any other constraint.</p>
<p>Note that when dropping or renaming a column that is mentioned in a named
CHECK constraint, this CHECK constraint must be explicitly dropped first,
as Alembic has no means of linking a reflected CHECK constraint to that
column.  Supposing column <code class="docutils literal notranslate"><span class="pre">q</span></code> of <code class="docutils literal notranslate"><span class="pre">some_table</span></code> were mentioned in a CHECK
constraint named <code class="docutils literal notranslate"><span class="pre">ck1</span></code>.  In order to drop this column, we have to drop
the check constraint also:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span><span class="s2">&quot;some_table&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch_op</span><span class="p">:</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">drop_constraint</span><span class="p">(</span><span class="s2">&quot;ck1&quot;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="s2">&quot;check&quot;</span><span class="p">)</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 1.7: </span>Named CHECK constraints participate in batch mode
in the same way as any other kind of constraint. This requires that column
drops or renames now include explicit directives to drop an existing named
constraint which refers to this column, as it will otherwise not be
automatically detected as being associated with that particular column.</p>
<p>Unnamed CHECK constraints continue to be silently omitted from the table
recreate operation.</p>
</div>
<p>For <strong>unnamed</strong> CHECK constraints, these are still not automatically included
as part of the batch process.  Note that this limitation <strong>includes</strong> the CHECK
constraints generated by the
<a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/type_basics.html#sqlalchemy.types.Boolean" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boolean</span></code></a> or <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/type_basics.html#sqlalchemy.types.Enum" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a>
datatypes, which up through SQLAlchemy 1.3 would generate CHECK constraints
automatically and cannot be tracked to the reflected table, assuming they are
generated in an unnamed way.</p>
<p>Unnamed constraints can be stated explicitly if they are to be included in the
recreated table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">op</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span><span class="s2">&quot;some_table&quot;</span><span class="p">,</span> <span class="n">table_args</span><span class="o">=</span><span class="p">[</span>
      <span class="n">CheckConstraint</span><span class="p">(</span><span class="s1">&#39;x &gt; 5&#39;</span><span class="p">)</span>
  <span class="p">])</span> <span class="k">as</span> <span class="n">batch_op</span><span class="p">:</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">))</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The above step needs only be taken for CHECK constraints that are explicitly stated
as part of the table definition.</p>
<p>For CHECK constraints that are generated by datatypes such as
<a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/type_basics.html#sqlalchemy.types.Boolean" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boolean</span></code></a> or <a class="reference external" href="https://docs.sqlalchemy.org/en/21/core/type_basics.html#sqlalchemy.types.Enum" title="(in SQLAlchemy v2.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a>, the type
objects themselves <strong>must be named</strong> in order for their CHECK constraints to be
included in the batch process.   Boolean and Enum datatypes that do not
have the <code class="docutils literal notranslate"><span class="pre">.name</span></code> attribute set will <strong>not</strong> have CHECK constraints
regenerated.  This name can be set by specifying the <code class="docutils literal notranslate"><span class="pre">.name</span></code> parameter
or by using a named Python <code class="docutils literal notranslate"><span class="pre">Enum</span></code> object as the source of enumeration.</p>
</section>
<section id="dealing-with-referencing-foreign-keys">
<h3>Dealing with Referencing Foreign Keys<a class="headerlink" href="#dealing-with-referencing-foreign-keys" title="Link to this heading">#</a></h3>
<p>It is important to note that batch table operations <strong>do not work</strong> with
foreign keys that enforce referential integrity.  This because the
target table is dropped; if foreign keys refer to it, this will raise
an error.   On SQLite, whether or not foreign keys actually enforce is
controlled by the <code class="docutils literal notranslate"><span class="pre">PRAGMA</span> <span class="pre">FOREIGN</span> <span class="pre">KEYS</span></code> pragma; this pragma, if in use,
must be disabled when the workflow mode proceeds.   When the operation is
complete, the batch-migrated table will have the same name
that it started with, so those referring foreign keys will again
refer to this table.</p>
<p>A special case is dealing with self-referring foreign keys.  Here,
Alembic takes a special step of recreating the self-referring foreign key
as referring to the original table name, rather than at the “temp” table,
so that like in the case of other foreign key constraints, when the table
is renamed to its original name, the foreign key
again references the correct table.   This operation only works when
referential integrity is disabled, consistent with the same requirement
for referring foreign keys from other tables.</p>
<p>When SQLite’s <code class="docutils literal notranslate"><span class="pre">PRAGMA</span> <span class="pre">FOREIGN</span> <span class="pre">KEYS</span></code> mode is turned on, it does provide
the service that foreign key constraints, including self-referential, will
automatically be modified to point to their table across table renames,
however this mode prevents the target table from being dropped as is required
by a batch migration.  Therefore it may be necessary to manipulate the
<code class="docutils literal notranslate"><span class="pre">PRAGMA</span> <span class="pre">FOREIGN</span> <span class="pre">KEYS</span></code> setting if a migration seeks to rename a table vs.
batch migrate it.</p>
</section>
</section>
<section id="working-in-offline-mode">
<span id="batch-offline-mode"></span><h2>Working in Offline Mode<a class="headerlink" href="#working-in-offline-mode" title="Link to this heading">#</a></h2>
<p>In the preceding sections, we’ve seen how much of an emphasis the
“move and copy” process has on using reflection in order to know the
structure of the table that is to be copied.  This means that in the typical
case, “online” mode, where a live database connection is present so that
<a class="reference internal" href="ops.html#alembic.operations.Operations.batch_alter_table" title="alembic.operations.Operations.batch_alter_table"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.batch_alter_table()</span></code></a> can reflect the table from the
database, is required; the <code class="docutils literal notranslate"><span class="pre">--sql</span></code> flag <strong>cannot</strong> be used without extra
steps.</p>
<p>To support offline mode, the system must work without table reflection
present, which means the full table as it intends to be created must be
passed to <a class="reference internal" href="ops.html#alembic.operations.Operations.batch_alter_table" title="alembic.operations.Operations.batch_alter_table"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.batch_alter_table()</span></code></a> using
<a class="reference internal" href="ops.html#alembic.operations.Operations.batch_alter_table.params.copy_from" title="alembic.operations.Operations.batch_alter_table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">copy_from</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">some_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;some_table&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
<span class="p">)</span>

<span class="k">with</span> <span class="n">op</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span><span class="s2">&quot;some_table&quot;</span><span class="p">,</span> <span class="n">copy_from</span><span class="o">=</span><span class="n">some_table</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch_op</span><span class="p">:</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">))</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The above use pattern is pretty tedious and quite far off from Alembic’s
preferred style of working; however, if one needs to do SQLite-compatible
“move and copy” migrations and need them to generate flat SQL files in
“offline” mode, there’s not much alternative.</p>
</section>
<section id="batch-mode-with-autogenerate">
<h2>Batch mode with Autogenerate<a class="headerlink" href="#batch-mode-with-autogenerate" title="Link to this heading">#</a></h2>
<p>The syntax of batch mode is essentially that <a class="reference internal" href="ops.html#alembic.operations.Operations.batch_alter_table" title="alembic.operations.Operations.batch_alter_table"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.batch_alter_table()</span></code></a>
is used to enter a batch block, and the returned <a class="reference internal" href="ops.html#alembic.operations.BatchOperations" title="alembic.operations.BatchOperations"><code class="xref py py-class docutils literal notranslate"><span class="pre">BatchOperations</span></code></a> context
works just like the regular <a class="reference internal" href="ops.html#alembic.operations.Operations" title="alembic.operations.Operations"><code class="xref py py-class docutils literal notranslate"><span class="pre">Operations</span></code></a> context, except that
the “table name” and “schema name” arguments are omitted.</p>
<p>To support rendering of migration commands in batch mode for autogenerate,
configure the <a class="reference internal" href="api/runtime.html#alembic.runtime.environment.EnvironmentContext.configure.params.render_as_batch" title="alembic.runtime.environment.EnvironmentContext.configure"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">EnvironmentContext.configure.render_as_batch</span></code></a>
flag in <code class="docutils literal notranslate"><span class="pre">env.py</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
    <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span>
    <span class="n">target_metadata</span><span class="o">=</span><span class="n">target_metadata</span><span class="p">,</span>
    <span class="n">render_as_batch</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Autogenerate will now generate along the lines of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">upgrade</span><span class="p">():</span>
    <span class="c1">### commands auto generated by Alembic - please adjust! ###</span>
    <span class="k">with</span> <span class="n">op</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch_op</span><span class="p">:</span>
        <span class="n">batch_op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;street&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p>This mode is safe to use in all cases, as the <a class="reference internal" href="ops.html#alembic.operations.Operations.batch_alter_table" title="alembic.operations.Operations.batch_alter_table"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operations.batch_alter_table()</span></code></a>
directive by default only takes place for SQLite; other backends will
behave just as they normally do in the absence of the batch directives.</p>
<p>Note that autogenerate support does not include “offline” mode, where
the <a class="reference internal" href="ops.html#alembic.operations.Operations.batch_alter_table.params.copy_from" title="alembic.operations.Operations.batch_alter_table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Operations.batch_alter_table.copy_from</span></code></a> parameter is used.
The table definition here would need to be entered into migration files
manually if this is needed.</p>
</section>
<section id="batch-mode-with-databases-other-than-sqlite">
<h2>Batch mode with databases other than SQLite<a class="headerlink" href="#batch-mode-with-databases-other-than-sqlite" title="Link to this heading">#</a></h2>
<p>There’s an odd use case some shops have, where the “move and copy” style
of migration is useful in some cases for databases that do already support
ALTER.   There’s some cases where an ALTER operation may block access to the
table for a long time, which might not be acceptable.  “move and copy” can
be made to work on other backends, though with a few extra caveats.</p>
<p>The batch mode directive will run the “recreate” system regardless of
backend if the flag <code class="docutils literal notranslate"><span class="pre">recreate='always'</span></code> is passed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">op</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span><span class="s2">&quot;some_table&quot;</span><span class="p">,</span> <span class="n">recreate</span><span class="o">=</span><span class="s1">&#39;always&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch_op</span><span class="p">:</span>
    <span class="n">batch_op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">))</span>
</pre></div>
</div>
<p>The issues that arise in this mode are mostly to do with constraints.
Databases such as Postgresql and MySQL with InnoDB will enforce referential
integrity (e.g. via foreign keys) in all cases.   Unlike SQLite, it’s not
as simple to turn off referential integrity across the board (nor would it
be desirable).    Since a new table is replacing the old one, existing
foreign key constraints which refer to the target table will need to be
unconditionally dropped before the batch operation, and re-created to refer
to the new table afterwards.  Batch mode currently does not provide any
automation for this.</p>
<p>The Postgresql database and possibly others also have the behavior such
that when the new table is created, a naming conflict occurs with the
named constraints of the new table, in that they match those of the old
table, and on Postgresql, these names need to be unique across all tables.
The Postgresql dialect will therefore emit a “DROP CONSTRAINT” directive
for all constraints on the old table before the new one is created; this is
“safe” in case of a failed operation because Postgresql also supports
transactional DDL.</p>
<p>Note that also as is the case with SQLite, CHECK constraints need to be
moved over between old and new table manually using the
<a class="reference internal" href="ops.html#alembic.operations.Operations.batch_alter_table.params.table_args" title="alembic.operations.Operations.batch_alter_table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Operations.batch_alter_table.table_args</span></code></a> parameter.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="naming.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">The Importance of Naming Constraints</p>
      </div>
    </a>
    <a class="right-next"
       href="branches.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Working with Branches</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#controlling-table-reflection">Controlling Table Reflection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-constraints">Dealing with Constraints</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dropping-unnamed-or-named-foreign-key-constraints">Dropping Unnamed or Named Foreign Key Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-the-type-of-boolean-enum-and-other-implicit-check-datatypes">Changing the Type of Boolean, Enum and other implicit CHECK datatypes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#including-check-constraints">Including CHECK constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-referencing-foreign-keys">Dealing with Referencing Foreign Keys</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#working-in-offline-mode">Working in Offline Mode</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-mode-with-autogenerate">Batch mode with Autogenerate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-mode-with-databases-other-than-sqlite">Batch mode with databases other than SQLite</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Mike Bayer
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2010-2026, Mike Bayer.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>