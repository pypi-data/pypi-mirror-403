{# Adapted from https://github.com/LandRegistry/govuk-frontend-jinja/blob/main/govuk_frontend_jinja/templates/macros/attributes.html #}

{#
  Renders component attributes as string

  * By default or using `"optional": false`, attributes render as ` name="value"`
  * Using `"optional": true`, attributes with empty (`null`, `undefined` or `false`) values are omitted
  * Using `"optional": true`, attributes with `true` (boolean) values render `name` only without value

  {@link https://developer.mozilla.org/en-US/docs/Glossary/Boolean/HTML}

  @example
  Output attribute ` aria-hidden="true"` when `true` (boolean) or `"true"` (string)

  ```njk
  nhsukAttributes({
    "aria-hidden": true
  })
  ```

  @example
  Output attribute ` aria-hidden="false"` when `false` (boolean) or `"false"` (string)

  ```njk
  nhsukAttributes({
    "aria-hidden": false
  })
  ```

  @example
  Output attribute ` hidden=""` when `null`, `undefined` or empty `""` (string)

  ```njk
  nhsukAttributes({
    "hidden": undefined
  })
  ```

  @example
  Output attribute ` hidden` as boolean attribute when optional and `true`

  ```njk
  nhsukAttributes({
    "hidden": {
      "value": true,
      "optional": true
    },
  })
  ```

  @example
  Output empty string when optional and `null`, `undefined` or `false`

  ```njk
  nhsukAttributes({
    "hidden": {
      "value": undefined,
      "optional": true
    },
  })

  @example
  Output attribute ` data-attribute="value"` when type is `string` (default)

  ```njk
  nhsukAttributes({
    "data-attribute": {
      value: "value",
      type: "string"
    }
  })
  ```

  @example
  Output attribute ` data-attributes='["value1", "value2"]'` when type is `array`

  ```njk
  nhsukAttributes({
    "data-attributes": {
      value: ["value1", "value2"],
      type: "array"
    }
  })
  ```

  @private
  @param {{ [attribute: string]: string | { value: unknown, type?: 'string' | 'array', optional?: boolean } } | string} attributes - Component attributes param
#}
{% macro nhsukAttributes(attributes) -%}
  {#- Default attributes output as string -#}
  {% set ns = namespace(attributesHtml = attributes if attributes is string else "") %}

  {#- Append attribute name/value pairs -#}
  {%- if attributes is mapping %}
    {% for name, item in (attributes.items() if attributes else {}.items()) %}
      {#- Set default attribute options -#}
      {% set options = item if item is mapping else {
        "value": item,
        "type": "string",
        "optional": false
      } %}

      {#- Remove values when not provided -#}
      {%- if options.value is undefined or options.value is none %}
        {% set value = none %}
        {% set valueEscaped = "" %}

      {#- Extract unescaped value when `safe` filtered -#}
      {#- https://github.com/alphagov/govuk-frontend/issues/4937 -#}
      {%- elif options.value is escaped %}
        {% set value = options.value.val %}
        {% set valueEscaped = options.value %}

      {#- Use escaped JSON for iterable values -#}
      {%- elif options.type == "array" and options.value is iterable %}
        {% set valueEscaped = options.value | tojson %}

      {#- Otherwise assume escaping is necessary -#}
      {#- https://github.com/alphagov/govuk-frontend/issues/4940 -#}
      {%- else %}
        {% set value = options.value %}
        {% set valueEscaped = options.value | escape %}
      {% endif %}

      {#- Output ` name` only (no value) for boolean attributes -#}
      {% if options.optional is true and value is true %}
        {% set ns.attributesHtml = "{} {}".format(ns.attributesHtml, name | escape) %}
      {#- Skip optional empty attributes or output ` name="value"` pair by default -#}
      {% elif (options.optional is true and value is not none and value is not false) or options.optional is not true %}
        {% if '"' in valueEscaped %}
          {% set ns.attributesHtml = "{} {}='{}'".format(ns.attributesHtml, name | escape, value | lower if value is boolean else valueEscaped) %}
        {% else %}
          {% set ns.attributesHtml = '{} {}="{}"'.format(ns.attributesHtml, name | escape, value | lower if value is boolean else valueEscaped) %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif -%}

  {{- ns.attributesHtml | safe -}}
{%- endmacro %}
