{% from "nhsuk/components/error-message/macro.jinja" import errorMessage -%}
{% from "nhsuk/components/fieldset/macro.jinja" import fieldset %}
{% from "nhsuk/components/hint/macro.jinja" import hint %}
{% from "nhsuk/components/input/macro.jinja" import input %}
{% from "nhsuk/macros/attributes.jinja" import nhsukAttributes %}

{#- Jinja compatibility - avoid referencing params.values directly
  as it clashes with dict.values() -#}
{% set values = params["values"] %}

{#- a record of other elements that we need to associate with the input using
  aria-describedby â€“ for example hints or error messages -#}
{% set ns = namespace() %}
{% set ns.describedBy = params.fieldset.describedBy if params.fieldset.describedBy else "" %}

{#- fieldset is false by default -#}
{% set hasFieldset = true if params.fieldset else false %}

{% if "items" in params %}
  {% set dateInputItems = params["items"] %}
{% else %}
  {% set dateInputItems = [
    {
      "name": "day",
      "classes": "nhsuk-input--width-2",
      "value": values.day
    },
    {
      "name": "month",
      "classes": "nhsuk-input--width-2",
      "value": values.month
    },
    {
      "name": "year",
      "classes": "nhsuk-input--width-4",
      "value": values.year
    }
  ] %}
{% endif %}

{#- Capture the HTML so we can optionally nest it in a fieldset -#}
{% set innerHtml %}
{% if params.hint %}
  {% set hintId = params.id ~ "-hint" %}
  {% set ns.describedBy = (ns.describedBy ~ " " ~ hintId) | trim %}
  {{ hint({
    "id": hintId,
    "classes": params.hint.classes,
    "attributes": params.hint.attributes,
    "html": params.hint.html,
    "text": params.hint.text
  }) | trim | indent(2) }}
{% endif %}
{% if params.errorMessage %}
  {% set errorId = params.id ~ "-error" %}
  {% set ns.describedBy = (ns.describedBy ~ " " ~ errorId) | trim %}
  {{ errorMessage({
    "id": errorId,
    "classes": params.errorMessage.classes,
    "attributes": params.errorMessage.attributes,
    "html": params.errorMessage.html,
    "text": params.errorMessage.text,
    "visuallyHiddenText": params.errorMessage.visuallyHiddenText
  }) | trim | indent(2) }}
{% endif %}
  <div {%- if params.id %} id="{{ params.id }}"{% endif %} class="nhsuk-date-input {%- if params.classes %} {{ params.classes }}{% endif %}"
    {{- nhsukAttributes(params.attributes) -}}>
    {% if params.formGroup.beforeInputs %}
    {{ params.formGroup.beforeInputs.html | safe | trim | indent(4) if params.formGroup.beforeInputs.html else params.formGroup.beforeInputs.text }}
    {% endif %}
    {% for item in dateInputItems %}
    {% if item %}
    <div class="nhsuk-date-input__item">
      {{ input({
        "label": {
          "text": item.label if item.label else item.name | capitalize,
          "classes": "nhsuk-date-input__label"
        },
        "id": item.id if item.id else (params.id ~ "-" ~ item.name),
        "classes": "nhsuk-date-input__input" ~ (" " ~ item.classes if item.classes),
        "name": (params.namePrefix ~ "[" ~ item.name ~ "]") if params.namePrefix else item.name,
        "value": item.value or values[item.name],
        "type": "text",
        "inputmode": item.inputmode if item.inputmode else "numeric",
        "autocomplete": item.autocomplete,
        "pattern": item.pattern,
        "attributes": item.attributes
      }) | trim | indent(6) }}
    </div>
    {% endif %}
    {% endfor %}
    {% if params.formGroup.afterInputs %}
    {{ params.formGroup.afterInputs.html | safe | trim | indent(4) if params.formGroup.afterInputs.html else params.formGroup.afterInputs.text }}
    {% endif %}
  </div>
{% endset -%}

<div class="nhsuk-form-group {%- if params.errorMessage %} nhsuk-form-group--error{% endif %} {%- if params.formGroup.classes %} {{ params.formGroup.classes }}{% endif %}" {{- nhsukAttributes(params.formGroup.attributes) }}>
{% if hasFieldset %}
  {# We override the fieldset's role to 'group' because otherwise JAWS does not
    announce the description for a fieldset comprised of text inputs, but
    adding the role to the fieldset always makes the output overly verbose for
    radio buttons or checkboxes. -#}
  {{ fieldset({
    "describedBy": ns.describedBy,
    "classes": params.fieldset.classes,
    "role": "group",
    "attributes": params.fieldset.attributes,
    "legend": params.fieldset.legend,
    "html": innerHtml | trim
  }) | trim | indent(2) }}
{% else %}
  {{ innerHtml | safe | trim }}
{% endif %}
</div>
