{% from "nhsuk/macros/attributes.jinja" import nhsukAttributes %}
{% from "nhsuk/components/error-message/macro.jinja" import errorMessage -%}
{% from "nhsuk/components/fieldset/macro.jinja" import fieldset %}
{% from "nhsuk/components/hint/macro.jinja" import hint %}
{% from "nhsuk/components/label/macro.jinja" import label %}

{#- If an id 'prefix' is not passed, fall back to using the name attribute
  instead. We need this for error messages and hints as well -#}
{% set idPrefix = params.idPrefix if params.idPrefix else params.name %}

{#- a record of other elements that we need to associate with the input using
  aria-describedby â€“ for example hints or error messages -#}
{% set ns = namespace() %}
{% set ns.describedBy = params.describedBy if params.describedBy else "" %}
{% if params.fieldset.describedBy %}
  {% set describedBy = params.fieldset.describedBy %}
{% endif %}

{#- Jinja compatibility - avoid referencing params.items/params.values directly
  as it clashes with dict.items() and dict.values() -#}
{% set items = params["items"] if "items" in params else [] %}
{% set values = params["values"] if "values" in params else [] %}

{#- fieldset is false by default -#}
{% set hasFieldset = true if params.fieldset else false %}

{%- macro _checkboxItem(params, item, index) %}
  {#- If the user explicitly sets an id, use this instead of the regular idPrefix -#}
  {#- The first id should not have a number suffix so it's easy to link to from the error summary component -#}
  {% set itemId = item.id if item.id else idPrefix ~ ("-" ~ index if index > 1 else "") %}
  {% set itemName = item.name if item.name else params.name %}
  {% set conditionalId = "conditional-" ~ itemId %}
  {%- if item.divider %}
    <div class="nhsuk-checkboxes__divider">{{ item.divider }}</div>
  {% else %}
    {% set isChecked = item.checked | default((item.value in values and item.checked != false) if values else false, true) %}
    {% set hasHint = true if item.hint.text or item.hint.html %}
    {% set itemHintId = itemId ~ "-item-hint" if hasHint else "" %}
    {% set itemDescribedBy = ns.describedBy if not hasFieldset else "" %}
    {% set itemDescribedBy = (itemDescribedBy ~ " " ~ itemHintId) | trim %}
    {% set itemClasses = "nhsuk-checkboxes__input" ~ (" " ~ item.classes if item.classes) %}
    <div class="nhsuk-checkboxes__item">
      <input class="{{ itemClasses }}" id="{{ itemId }}" name="{{ itemName }}" type="checkbox" value="{{ item.value }}"
        {{- " checked" if isChecked }}
        {{- " disabled" if item.disabled }}
        {%- if item.exclusive %} data-checkbox-exclusive{% endif -%}
        {%- if item.exclusiveGroup %} data-checkbox-exclusive-group="{{ item.exclusiveGroup }}"{% endif -%}
        {%- if item.conditional.html %} data-aria-controls="{{ conditionalId }}"{% endif -%}
        {%- if itemDescribedBy %} aria-describedby="{{ itemDescribedBy }}"{% endif -%}
        {{- nhsukAttributes(item.attributes) }}>
      {{ label({
        "html": item.html,
        "text": item.text,
        "classes": "nhsuk-checkboxes__label" ~ (" " ~ item.label.classes if item.label.classes),
        "size": item.label.size,
        "attributes": item.label.attributes,
        "for": itemId
      }) | trim | indent(6) }}
      {% if hasHint %}
      {{ hint({
        "id": itemHintId,
        "classes": "nhsuk-checkboxes__hint" ~ (" " ~ item.hint.classes if item.hint.classes),
        "attributes": item.hint.attributes,
        "html": item.hint.html,
        "text": item.hint.text
      }) | trim | indent(6) }}
      {% endif %}
    </div>
    {% if item.conditional.html %}
    <div class="nhsuk-checkboxes__conditional {%- if not isChecked %} nhsuk-checkboxes__conditional--hidden{% endif %}" id="{{ conditionalId }}">
      {{ item.conditional.html | safe | trim }}
    </div>
    {% endif %}
  {% endif %}
{% endmacro -%}

{#- Capture the HTML so we can optionally nest it in a fieldset -#}
{% set innerHtml %}
{% if params.hint %}
  {% set hintId = idPrefix ~ "-hint" %}
  {% set ns.describedBy = (ns.describedBy ~ " " ~ hintId) | trim %}
  {{ hint({
    "id": hintId,
    "classes": params.hint.classes,
    "attributes": params.hint.attributes,
    "html": params.hint.html,
    "text": params.hint.text
  }) | trim | indent(2) }}
{% endif %}
{% if params.errorMessage %}
  {% set errorId = idPrefix ~ "-error" %}
  {% set ns.describedBy = (ns.describedBy ~ " " ~ errorId) | trim %}
  {{ errorMessage({
    "id": errorId,
    "classes": params.errorMessage.classes,
    "attributes": params.errorMessage.attributes,
    "html": params.errorMessage.html,
    "text": params.errorMessage.text,
    "visuallyHiddenText": params.errorMessage.visuallyHiddenText
  }) | trim | indent(2) }}
{% endif %}
  <div {%- if params.id %} id="{{ params.id }}"{% endif %} class="nhsuk-checkboxes {%- if params.classes %} {{ params.classes }}{% endif %}"
    {{- nhsukAttributes(params.attributes) }} data-module="nhsuk-checkboxes">
    {% if params.formGroup.beforeInputs %}
    {{ params.formGroup.beforeInputs.html | safe | trim | indent(4) if params.formGroup.beforeInputs.html else params.formGroup.beforeInputs.text }}
    {% endif %}
    {% for item in items %}
      {% if item %}
        {{- _checkboxItem(params, item, loop.index) -}}
      {% endif %}
    {% endfor %}
    {% if params.formGroup.afterInputs %}
    {{ params.formGroup.afterInputs.html | safe | trim | indent(4) if params.formGroup.afterInputs.html else params.formGroup.afterInputs.text }}
    {% endif %}
  </div>
{% endset -%}

<div class="nhsuk-form-group {%- if params.errorMessage %} nhsuk-form-group--error{% endif %} {%- if params.formGroup.classes %} {{ params.formGroup.classes }}{% endif %}"
  {{- nhsukAttributes(params.formGroup.attributes) }}>
{% if hasFieldset %}
  {{ fieldset({
    "describedBy": ns.describedBy,
    "classes": params.fieldset.classes,
    "attributes": params.fieldset.attributes,
    "legend": params.fieldset.legend,
    "html": innerHtml | trim
  }) | trim }}
{% else %}
  {{ innerHtml | safe | trim }}
{% endif %}
</div>
