{% extends "job.bash.j2" %}
{% block directives %}
{{ super() -}}
#SBATCH --array=0-{{ args | length - 1 }}
#SBATCH --output=slurm-%A_%a.out
{% endblock directives %}

{% block bootstrap %}
srun \
  --label \
  --unbuffered \
  --kill-on-bad-exit=1 \
  --export="ALL" \
{% for directive in job.executor.step_directives() %}
  {{ directive }} \
{% endfor %}
  bash <<'SRUN_EOF' &
set -Eeuxo pipefail

readonly XM_SLURM_TRIAL_ARGS=(
{% for trial in args %}
  "{{ trial.to_list() | join(" ") }}"
{% endfor %}
)

{% call run(cluster, job) %}
  ${XM_SLURM_TRIAL_ARGS[$SLURM_ARRAY_TASK_ID]} \
{% endcall %}

SRUN_EOF
{%- endblock bootstrap %}
