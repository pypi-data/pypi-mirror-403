from typing import Dict, Any
from ssf.core.base import BaseScanner

class CORSExploitScanner(BaseScanner):
    """
    Plugin to test CORS vulnerabilities by fuzzing Origin values
    to check if the server accepts dangerous Origins with credentials.
    """

    async def scan(self) -> Dict[str, Any]:
        self.log_info("[*] Starting Active CORS Vulnerability Scan...")
        
        results = {
            "vulnerabilities": [],
            "risk": "SAFE"
        }
        
        target_path = "/rest/v1/" 
        
        test_payloads = [
            {"origin": "https://evil-attacker.com", "desc": "Arbitrary Origin"},
            {"origin": "null", "desc": "Null Origin (Sandboxed iframe)"},
            {"origin": "https://attacker.com.yourdomain.com", "desc": "Subdomain Bypass"}
        ]

        for test in test_payloads:
            origin_val = test["origin"]
            desc = test["desc"]
            
            try:
                headers = self.client.headers.copy()
                headers["Origin"] = origin_val
                
                response = await self.client.get(target_path, headers=headers)
                
                allow_origin = response.headers.get("Access-Control-Allow-Origin", "")
                allow_creds = response.headers.get("Access-Control-Allow-Credentials", "false")

                is_reflected = (origin_val in allow_origin) or (allow_origin == "*")
                
                is_creds_allowed = (allow_creds.lower() == "true")

                if is_reflected and is_creds_allowed:
                    msg = f"    [!] CORS Vulnerability found! Reflected Origin: {origin_val} + Credentials: true"
                    self.log_risk(msg, "HIGH")
                    
                    results["vulnerabilities"].append({
                        "type": "CORS Misconfiguration",
                        "payload": origin_val,
                        "description": f"{desc} allows credentials."
                    })
                    results["risk"] = "HIGH"
                
                elif is_reflected and allow_origin == "*":
                     self.log_warn(f"    [!] Permissive CORS detected (*). Check if this is intended for {desc}.")

            except Exception as e:
                self.log_error(f"CORS scan error on {origin_val}: {e}")

        return results