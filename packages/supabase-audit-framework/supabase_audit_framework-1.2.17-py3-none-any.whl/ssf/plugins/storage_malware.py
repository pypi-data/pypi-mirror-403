from ssf.core.base import BaseScanner
from typing import Dict, Any
import httpx

class StorageMalwareScanner(BaseScanner):
    def __init__(self, client: httpx.AsyncClient, verbose: bool = False, context: Dict[str, Any] = None):
        super().__init__(client, verbose, context)
        self.signatures = [
            (0, b'MZ', 'Windows Executable (EXE/DLL)'),
            (0, b'\x7fELF', 'Linux Executable (ELF)'),
            (0, b'PK\x03\x04', 'Zip Archive (Potential Malware Container)'),
            (0, b'<%', 'Active Server Page (ASP) - Web Shell Risk'),
            (0, b'<?php', 'PHP Script - Web Shell Risk'),
        ]

    async def scan(self) -> Dict[str, Any]:
        result = {"risk": "Low", "malware_candidates": []}
        buckets = self.context.get("buckets", [])
        
        if not buckets:
            self.log("[*] No buckets found in context to scan for malware.", "dim")
            return result

        self.log(f"[*] Scanning {len(buckets)} buckets for malware signatures...", "cyan")

        for bucket in buckets:
            if not bucket.get('public'):
                continue
                
            self.log(f"    [*] Checking public bucket: {bucket['name']}", "cyan")
            endpoint = f"/storage/v1/object/list/{bucket['name']}"
            
            try:
                r = await self.client.post(endpoint, json={"prefix": "", "limit": 10}, timeout=5.0)
                if r.status_code == 200:
                    objects = r.json()
                    for obj in objects:
                        if isinstance(obj, dict) and 'name' in obj:
                            file_url = f"/storage/v1/object/public/{bucket['name']}/{obj['name']}"
                            try:
                                r_file = await self.client.get(file_url, headers={"Range": "bytes=0-511"}, timeout=5.0)
                                if r_file.status_code in (200, 206):
                                    content = r_file.content
                                    for offset, sig, desc in self.signatures:
                                        if content[offset:offset+len(sig)] == sig:
                                            self.log(f"    [!] MALWARE SUSPICION: {obj['name']} matches {desc}", "bold red")
                                            result["malware_candidates"].append({
                                                "bucket": bucket['name'],
                                                "file": obj['name'],
                                                "signature": desc
                                            })
                                            result["risk"] = "High"
                            except Exception as e:
                                pass
            except Exception:
                pass
                
        return result
