<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 1100" font-family="monospace, sans-serif">
  <!-- Title -->
  <text x="450" y="30" font-size="20" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    Empirica Storage Architecture - Complete Data Flow
  </text>
  <text x="450" y="50" font-size="12" text-anchor="middle" fill="#7f8c8d">
    4-Layer Architecture: SQLite + Git Notes + JSON Logs + Qdrant Vectors
  </text>

  <!-- Epistemic Event -->
  <rect x="200" y="70" width="500" height="70" fill="#3498db" stroke="#2980b9" stroke-width="2" rx="5"/>
  <text x="450" y="95" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    EPISTEMIC EVENT
  </text>
  <text x="450" y="115" font-size="12" text-anchor="middle" fill="white">
    AI completes PREFLIGHT, CHECK, or POSTFLIGHT
  </text>
  <text x="450" y="130" font-size="11" text-anchor="middle" fill="white">
    (13 epistemic vectors assessed)
  </text>

  <!-- Arrow down -->
  <line x1="450" y1="140" x2="450" y2="175" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- GitEnhancedReflexLogger -->
  <rect x="200" y="175" width="500" height="60" fill="#e74c3c" stroke="#c0392b" stroke-width="2" rx="5"/>
  <text x="450" y="200" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    GitEnhancedReflexLogger
  </text>
  <text x="450" y="220" font-size="12" text-anchor="middle" fill="white">
    add_checkpoint(phase, round, vectors, metadata)
  </text>

  <!-- Arrow down splits into 4 -->
  <line x1="450" y1="235" x2="450" y2="270" stroke="#2c3e50" stroke-width="2"/>
  <line x1="450" y1="270" x2="130" y2="310" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
  <line x1="450" y1="270" x2="350" y2="310" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
  <line x1="450" y1="270" x2="550" y2="310" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
  <line x1="450" y1="270" x2="770" y2="310" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- Four storage layers -->
  <!-- SQLite -->
  <rect x="30" y="310" width="200" height="120" fill="#9b59b6" stroke="#8e44ad" stroke-width="2" rx="5"/>
  <text x="130" y="335" font-size="13" font-weight="bold" text-anchor="middle" fill="white">
    SQLite Database
  </text>
  <text x="130" y="355" font-size="10" text-anchor="middle" fill="white">
    .empirica/sessions/sessions.db
  </text>
  <text x="130" y="375" font-size="9" text-anchor="middle" fill="white">
    * Table: reflexes
  </text>
  <text x="130" y="390" font-size="9" text-anchor="middle" fill="white">
    * 13 vector columns + metadata
  </text>
  <text x="130" y="405" font-size="9" text-anchor="middle" fill="white">
    * Fast SQL queries
  </text>
  <text x="130" y="420" font-size="9" text-anchor="middle" fill="white">
    * Bayesian beliefs table
  </text>

  <!-- Git Notes -->
  <rect x="250" y="310" width="200" height="120" fill="#16a085" stroke="#0e8c72" stroke-width="2" rx="5"/>
  <text x="350" y="335" font-size="13" font-weight="bold" text-anchor="middle" fill="white">
    Git Notes
  </text>
  <text x="350" y="355" font-size="9" text-anchor="middle" fill="white">
    refs/notes/empirica/session/
  </text>
  <text x="350" y="370" font-size="9" text-anchor="middle" fill="white">
    {id}/{phase}/{round}
  </text>
  <text x="350" y="390" font-size="9" text-anchor="middle" fill="white">
    * Compressed (~450 tokens)
  </text>
  <text x="350" y="405" font-size="9" text-anchor="middle" fill="white">
    * Distributed, versioned
  </text>
  <text x="350" y="420" font-size="9" text-anchor="middle" fill="white">
    * Crypto signable (git SHA)
  </text>

  <!-- JSON Logs -->
  <rect x="470" y="310" width="200" height="120" fill="#f39c12" stroke="#d68910" stroke-width="2" rx="5"/>
  <text x="570" y="335" font-size="13" font-weight="bold" text-anchor="middle" fill="white">
    JSON Reflex Logs
  </text>
  <text x="570" y="355" font-size="9" text-anchor="middle" fill="white">
    .empirica_reflex_logs/
  </text>
  <text x="570" y="370" font-size="9" text-anchor="middle" fill="white">
    {date}/{agent}/{session}/
  </text>
  <text x="570" y="390" font-size="9" text-anchor="middle" fill="white">
    * Full reasoning (~6,500 tokens)
  </text>
  <text x="570" y="405" font-size="9" text-anchor="middle" fill="white">
    * Rationales, evidence
  </text>
  <text x="570" y="420" font-size="9" text-anchor="middle" fill="white">
    * Audit trail + debugging
  </text>

  <!-- Qdrant Vector Store (NEW) -->
  <rect x="690" y="310" width="200" height="120" fill="#e91e63" stroke="#c2185b" stroke-width="2" rx="5"/>
  <text x="790" y="335" font-size="13" font-weight="bold" text-anchor="middle" fill="white">
    Qdrant Vectors
  </text>
  <text x="790" y="355" font-size="9" text-anchor="middle" fill="white">
    project_{id}_eidetic
  </text>
  <text x="790" y="370" font-size="9" text-anchor="middle" fill="white">
    project_{id}_episodic
  </text>
  <text x="790" y="390" font-size="9" text-anchor="middle" fill="white">
    * Semantic search
  </text>
  <text x="790" y="405" font-size="9" text-anchor="middle" fill="white">
    * Confidence scoring
  </text>
  <text x="790" y="420" font-size="9" text-anchor="middle" fill="white">
    * Temporal decay
  </text>

  <!-- Memory Types Detail Box -->
  <rect x="50" y="460" width="800" height="140" fill="#fce4ec" stroke="#e91e63" stroke-width="2" rx="5"/>
  <text x="450" y="485" font-size="14" font-weight="bold" text-anchor="middle" fill="#880e4f">
    Qdrant Memory Layers (NEW)
  </text>

  <!-- Eidetic -->
  <rect x="70" y="500" width="350" height="85" fill="#f8bbd9" stroke="#e91e63" stroke-width="1" rx="3"/>
  <text x="245" y="520" font-size="12" font-weight="bold" text-anchor="middle" fill="#880e4f">
    Eidetic Memory (Facts)
  </text>
  <text x="80" y="540" font-size="10" fill="#880e4f">* Facts with confidence scores (0.5 initial)</text>
  <text x="80" y="555" font-size="10" fill="#880e4f">* +0.1 confidence on each confirmation</text>
  <text x="80" y="570" font-size="10" fill="#880e4f">* Max 0.95 (nothing is unquestionable)</text>
  <text x="80" y="585" font-size="10" fill="#880e4f">* Auto-ingested from finding-log</text>

  <!-- Episodic -->
  <rect x="480" y="500" width="350" height="85" fill="#f8bbd9" stroke="#e91e63" stroke-width="1" rx="3"/>
  <text x="655" y="520" font-size="12" font-weight="bold" text-anchor="middle" fill="#880e4f">
    Episodic Memory (Narratives)
  </text>
  <text x="490" y="540" font-size="10" fill="#880e4f">* Session arcs with learning deltas</text>
  <text x="490" y="555" font-size="10" fill="#880e4f">* Temporal decay (1.0 -> 0.05 over ~1yr)</text>
  <text x="490" y="570" font-size="10" fill="#880e4f">* Recency-weighted retrieval</text>
  <text x="490" y="585" font-size="10" fill="#880e4f">* Auto-ingested from postflight-submit</text>

  <!-- Feedback Loop -->
  <rect x="50" y="620" width="800" height="80" fill="#e8f5e9" stroke="#4caf50" stroke-width="2" rx="5"/>
  <text x="450" y="645" font-size="14" font-weight="bold" text-anchor="middle" fill="#1b5e20">
    Bayesian Feedback Loop
  </text>
  <text x="450" y="665" font-size="11" text-anchor="middle" fill="#2e7d32">
    finding-log -> eidetic (check for existing fact -> confirm or create)
  </text>
  <text x="450" y="685" font-size="11" text-anchor="middle" fill="#2e7d32">
    postflight-submit -> episodic (create session narrative with learning delta)
  </text>

  <!-- Compression info -->
  <rect x="150" y="720" width="600" height="70" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2" rx="5"/>
  <text x="450" y="745" font-size="13" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    Compression Strategy
  </text>
  <text x="450" y="765" font-size="11" text-anchor="middle" fill="#34495e">
    Full Transcript: 15,000 tokens -> Git Notes: 450 tokens (97% reduction)
  </text>
  <text x="450" y="780" font-size="11" text-anchor="middle" fill="#34495e">
    Qdrant: Semantic vectors enable retrieval without full context
  </text>

  <!-- Use cases -->
  <text x="450" y="820" font-size="16" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    Access Patterns by Use Case
  </text>

  <!-- Table -->
  <rect x="50" y="835" width="800" height="30" fill="#34495e"/>
  <text x="150" y="855" font-size="11" font-weight="bold" fill="white">Use Case</text>
  <text x="350" y="855" font-size="11" font-weight="bold" fill="white">Data Source</text>
  <text x="600" y="855" font-size="11" font-weight="bold" fill="white">Why</text>

  <rect x="50" y="865" width="800" height="25" fill="#ecf0f1"/>
  <text x="60" y="882" font-size="10" fill="#2c3e50">Live dashboard</text>
  <text x="310" y="882" font-size="10" fill="#2c3e50">Git Notes</text>
  <text x="510" y="882" font-size="10" fill="#2c3e50">Fast, compressed, versioned</text>

  <rect x="50" y="890" width="800" height="25" fill="#d5dbdb"/>
  <text x="60" y="907" font-size="10" fill="#2c3e50">Historical trends</text>
  <text x="310" y="907" font-size="10" fill="#2c3e50">SQLite</text>
  <text x="510" y="907" font-size="10" fill="#2c3e50">SQL queries, aggregation</text>

  <rect x="50" y="915" width="800" height="25" fill="#ecf0f1"/>
  <text x="60" y="932" font-size="10" fill="#2c3e50">Session resumption</text>
  <text x="310" y="932" font-size="10" fill="#2c3e50">Git Notes + Qdrant</text>
  <text x="510" y="932" font-size="10" fill="#2c3e50">Token efficiency + semantic context</text>

  <rect x="50" y="940" width="800" height="25" fill="#d5dbdb"/>
  <text x="60" y="957" font-size="10" fill="#2c3e50">Deep debugging</text>
  <text x="310" y="957" font-size="10" fill="#2c3e50">JSON Logs</text>
  <text x="510" y="957" font-size="10" fill="#2c3e50">Full reasoning context</text>

  <rect x="50" y="965" width="800" height="25" fill="#ecf0f1"/>
  <text x="60" y="982" font-size="10" fill="#2c3e50">Semantic search</text>
  <text x="310" y="982" font-size="10" fill="#2c3e50">Qdrant (eidetic/episodic)</text>
  <text x="510" y="982" font-size="10" fill="#2c3e50">"What did I learn about X?"</text>

  <rect x="50" y="990" width="800" height="25" fill="#d5dbdb"/>
  <text x="60" y="1007" font-size="10" fill="#2c3e50">Memory challenge</text>
  <text x="310" y="1007" font-size="10" fill="#2c3e50">Qdrant + Bayesian beliefs</text>
  <text x="510" y="1007" font-size="10" fill="#2c3e50">Confidence decay/confirmation</text>

  <rect x="50" y="1015" width="800" height="25" fill="#ecf0f1"/>
  <text x="60" y="1032" font-size="10" fill="#2c3e50">Crypto verification</text>
  <text x="310" y="1032" font-size="10" fill="#2c3e50">Git Notes SHA</text>
  <text x="510" y="1032" font-size="10" fill="#2c3e50">Tamper-proof, verifiable</text>

  <!-- Footer -->
  <text x="450" y="1070" font-size="11" text-anchor="middle" fill="#7f8c8d">
    4-layer architecture: SQLite (queryable) + Git Notes (versioned) + JSON (audit) + Qdrant (semantic)
  </text>

  <!-- Arrow marker definition -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#2c3e50"/>
    </marker>
  </defs>
</svg>
