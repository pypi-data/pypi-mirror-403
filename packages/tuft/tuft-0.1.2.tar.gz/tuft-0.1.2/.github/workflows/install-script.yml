name: Install Script

on:
  push:
    branches: [main, dev/**, feature/**]
    paths:
      - 'scripts/install.sh'
      - '.github/workflows/install-script.yml'
  pull_request:
    branches: [main]
    paths:
      - 'scripts/install.sh'
      - '.github/workflows/install-script.yml'

jobs:
  test-install-script:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test install script syntax
        run: bash -n scripts/install.sh

      - name: Test install script help
        run: bash scripts/install.sh --help

      - name: Run install script (local source)
        run: |
          bash scripts/install.sh --local-source "$GITHUB_WORKSPACE"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Verify tuft command exists
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          which tuft
          tuft --help
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Verify tuft version
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          tuft version
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Verify Python environment
        run: |
          test -f "${TUFT_HOME}/venv/bin/python"
          "${TUFT_HOME}/venv/bin/python" -c "import tuft; print('tuft imported successfully')"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Test tuft launch --help
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          tuft launch --help
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Test tuft launch requires config
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          # Should fail with config error when no config provided
          if tuft launch 2>&1; then
            echo "Expected tuft launch to fail without config"
            exit 1
          fi
          # Verify error message mentions config
          tuft launch 2>&1 | grep -qi "config"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Test tuft launch with config file
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          # Create a minimal config file
          cat > "${TUFT_HOME}/configs/tuft_config.yaml" << 'EOF'
          model_owner: test
          supported_models:
            - model_name: test-model
              model_path: /nonexistent/path
              max_model_len: 1024
          authorized_users:
            test-key: test-user
          EOF
          # Launch should fail due to missing model, but get past config validation
          # We just verify it doesn't fail on config parsing
          tuft launch 2>&1 | grep -v "Configuration file must be provided" || true
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Clean up installation
        run: rm -rf "${TUFT_HOME}"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

  test-backend-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run install script
        run: |
          bash scripts/install.sh --local-source "$GITHUB_WORKSPACE"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Verify backend dependencies installed
        run: |
          "${TUFT_HOME}/venv/bin/python" -c "import peft; print('peft imported successfully')"
          "${TUFT_HOME}/venv/bin/python" -c "import redis; print('redis imported successfully')"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Clean up installation
        run: rm -rf "${TUFT_HOME}"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

  test-wrapper-commands:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install tuft
        run: bash scripts/install.sh --local-source "$GITHUB_WORKSPACE"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Test help command
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          tuft help
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Test version command
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          tuft version
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Test upgrade command (from PyPI)
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          tuft upgrade
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Test upgrade command (from local source)
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          tuft upgrade --local-source "$GITHUB_WORKSPACE"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Clean up installation
        run: rm -rf "${TUFT_HOME}"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

  test-clean-install:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initial install
        run: |
          bash scripts/install.sh --local-source "$GITHUB_WORKSPACE"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Create marker file to verify clean
        run: |
          echo "marker" > "${TUFT_HOME}/marker.txt"
          test -f "${TUFT_HOME}/marker.txt"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Reinstall with --clean
        run: |
          bash scripts/install.sh --local-source "$GITHUB_WORKSPACE" --clean
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Verify marker file was removed
        run: |
          # Marker file should be gone after --clean
          test ! -f "${TUFT_HOME}/marker.txt"
          # But tuft should still be installed
          "${TUFT_HOME}/venv/bin/python" -c "import tuft; print('tuft imported successfully')"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Clean up installation
        run: rm -rf "${TUFT_HOME}"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

  test-upgrade-from-source:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install tuft
        run: bash scripts/install.sh --local-source "$GITHUB_WORKSPACE"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Test upgrade --from-source
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          tuft upgrade --from-source
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Verify tuft still works after upgrade
        run: |
          export PATH="${TUFT_HOME}/bin:$PATH"
          tuft version
          tuft launch --help
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft

      - name: Clean up installation
        run: rm -rf "${TUFT_HOME}"
        env:
          TUFT_HOME: ${{ runner.temp }}/tuft
