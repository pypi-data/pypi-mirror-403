services:
  # use 2 nodes to simulate a cluster environment
  tuft-node-1:
    image: nvcr.io/nvidia/cuda:12.8.1-cudnn-devel-ubuntu22.04
    pull_policy: never
    command: bash -c "
      chmod 1777 /tmp && apt update && apt install -y --no-install-recommends \
      build-essential \
      curl git wget vim tmux net-tools \
      python3 python3-pip python3-dev python3-packaging python3-venv \
      libomp-dev infiniband-diags libibverbs-dev librdmacm-dev rdma-core perftest \
      && rm -rf /var/lib/apt/lists/* \
      && ln -sf /usr/bin/python3 /usr/bin/python \
      && ln -sf /usr/bin/pip3 /usr/bin/pip \
      && bash /workspace/scripts/install.sh --local-source /workspace \
      && source $HOME/.local/bin/env \
      && source /root/.tuft/venv/bin/activate \
      && uv pip install .[dev] \
      && ray start --head --dashboard-host 0.0.0.0 --include-dashboard true --block"
    environment:
      - HF_ENDPOINT=https://hf-mirror.com
      - RAY_ADDRESS=auto
      - TUFT_CHECKPOINT_DIR=/mnt/checkpoints
      - TUFT_TEST_MODEL=/mnt/models/Qwen3-0.6B
      - TUFT_TEST_MODEL_1=/mnt/models/Qwen3-0.6B
      - TUFT_TEST_MODEL_2=/mnt/models/Qwen3-1.7B
      - TEST_REDIS_URL=redis://tuft-redis:6379
      - VIRTUAL_ENV=/root/.tuft/venv
    working_dir: /workspace
    networks:
      - tuft-network
    volumes:
      - tuft-volume:/mnt
      - ../../..:/workspace
    shm_size: "64G"
    deploy:
      resources:
        reservations:
          devices:
          - driver: nvidia
            device_ids: ['0', '1', '2', '3']
            capabilities: [gpu]

  tuft-redis:
    image: redis:7.0
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    networks:
      - tuft-network

networks:
  tuft-network:
    driver: bridge

volumes:
  tuft-volume:
    external: true
