Extra info
==========

.. _project-structure:

ğŸ“‚ Project Structure
--------------------

.. code:: bash

   /qualpipe-webapp
      â”‚
      â”œâ”€â”€ kind-dev-config.yml              # Kind configuration file for local development
      â”œâ”€â”€ chart/                           # Helm chart instructions for deployment
      â”œâ”€â”€ Makefile                         # Makefile to build Backend and Frontend
      â”‚
      â”œâ”€â”€ docs/                            # Document folder
      â”‚
      â”œâ”€â”€ src/
      â”‚   â””â”€â”€ qualpipe_webapp/
      â”‚       â”œâ”€â”€ backend/                 # FastAPI backend
      â”‚       â”‚   â”œâ”€â”€ main.py              # Main FastAPI app for backend
      â”‚       â”‚   â”œâ”€â”€ data/                # JSON data sources
      â”‚       â”‚   â”œâ”€â”€ requirements.txt     # Backend dependencies
      â”‚       â”‚   â”œâ”€â”€ requirements-dev.txt # Backend dependencies for developer
      â”‚       â”‚   â””â”€â”€ Dockerfile           # Backend container
      â”‚       â”‚
      â”‚       â”œâ”€â”€ frontend/                # FastAPI frontend
      â”‚       â”‚   â”œâ”€â”€ /templates/          # Template pages
      â”‚       â”‚   â”œâ”€â”€ /static/             # Static files (css, js, lib)
      â”‚       â”‚   â”œâ”€â”€ main.py              # Main FastAPI app for frontend
      â”‚       â”‚   â”œâ”€â”€ requirements.txt     # Frontend dependencies
      â”‚       â”‚   â”œâ”€â”€ requirements-dev.txt # Frontend dependencies for developer
      â”‚       â”‚   â””â”€â”€ Dockerfile           # Frontend container
      â”‚       â”‚
      â”‚       â”œâ”€â”€ nginx/
      â”‚       â”‚   â”œâ”€â”€ nginx.conf
      â”‚       â”‚   â””â”€â”€ ssl/                 # (optional later)
      â”‚
      â””â”€â”€ .gitignore

.. _pixi-commands:

Pixi Commands
-------------

All the available Pixi tasks are listed and described in the table below.

+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Command: ``pixi``                         | Description                                                                                                                                                         |
+===========================================+=====================================================================================================================================================================+
| ``shell``                                 | Activate the pixi environment                                                                                                                                       |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run install``                           | Install editable pixi environment                                                                                                                                   |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run install-all``                       | Install editable pixi environment with all extra dependencies                                                                                                       |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run compile-requirements-backend``      | Generate/update backend requirements.txt                                                                                                                            |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run compile-requirements-frontend``     | Generate/update frontend requirements.txt                                                                                                                           |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run compile-requirements-backend-dev``  | Generate/update backend requirements-dev.txt                                                                                                                        |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run compile-requirements-frontend-dev`` | Generate/update frontend requirements-dev.txt                                                                                                                       |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run compile-requirements``              | Generate/update backend and frontend requirements.txt                                                                                                               |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run compile-requirements-dev``          | Generate/update backend and frontend requirements-dev.txt                                                                                                           |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run npm-install``                       | Install NodeJS dependencies                                                                                                                                         |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run generate-codegen``                  | Generate Pydantic models from qualpipe criteria                                                                                                                     |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run generate-frontend-schema``          | Generate yaml file for javascript frontend validation (combines those produced by ``generate-codegen``)                                                             |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run build-backend``                     | Build backend image                                                                                                                                                 |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run build-backend-dev``                 | Build backend *dev* image                                                                                                                                           |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run build-frontend``                    | Build frontend image                                                                                                                                                |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run build-frontend-dev``                | Build frontend *dev* image                                                                                                                                          |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run build-images``                      | Build backend- and frontend- images                                                                                                                                 |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run build-images-dev``                  | Build backend- and frontend- *dev* images                                                                                                                           |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run kind-create``                       | Create local kind cluster                                                                                                                                           |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run kind-delete``                       | Delete local kind cluster                                                                                                                                           |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run kind-load-images``                  | Load docker images on the cluster                                                                                                                                   |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run kind-load-dev-images``              | Load docker *dev* images on the cluster                                                                                                                             |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run kind-status``                       | Show kubernetes cluster status                                                                                                                                      |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run kind-clean-failed``                 | Remove kubernetes resources left from previously failed installation                                                                                                |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run helm-install``                      | Install Helm chart                                                                                                                                                  |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run helm-dev-install``                  | Install Helm chart for local development                                                                                                                            |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run helm-uninstall``                    |                                                                                                                                                                     |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run helm-upgrade``                      | Upgrade Helm chart                                                                                                                                                  |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run helm-dev-upgrade``                  | Upgrade Helm chart for local development                                                                                                                            |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run ingress-install``                   | Install NGINX ingress controller for kind                                                                                                                           |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run setup``                             | Install dependencies, execute ``generate-codegen`` and ``generate-frontend-schema``, and install nodejs dependencies                                                |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run dev-setup``                         | Install *dev* dependencies in editable mode, execute ``generate-codegen`` and ``generate-frontend-schema``, and install nodejs dependencies                         |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run up``                                | Production deployment                                                                                                                                               |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run dev-up``                            | Deploy the complete development environment (create kubernetes cluster, build docker dev images, install NGINX ingress controller for kind, install dev helm chart) |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run dev-up-no-build``                   | Deploy the complete development environment without rebuilding images                                                                                               |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run restart``                           | Re-build images and reinstall Helm chart                                                                                                                            |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run dev-restart``                       | Re-build *dev* images and reinstall Helm chart                                                                                                                      |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run dev-restart-no-build``              | Reinstall Helm chart                                                                                                                                                |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run stop``                              | Stop pods preserving cluster                                                                                                                                        |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run stop-and-delete``                   | Stop pods and delete the cluster                                                                                                                                    |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run prune``                             | Cleanup dangling Docker images                                                                                                                                      |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run clean-all``                         | Stop pods, delete cluster, and remove docker images                                                                                                                 |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run browser-install``                   | Install Playwright browsers for e2e tests                                                                                                                           |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run test-backend``                      | Run backend python unit tests with `Pytest <https://docs.pytest.org/>`__                                                                                            |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run test-frontend-py``                  | Run frontend python unit tests with `Pytest <https://docs.pytest.org/>`__                                                                                           |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run test-frontend-js``                  | Run frontend javascript unit tests with `Mocha <https://mochajs.org/>`__                                                                                            |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run test-frontend-e2e``                 | Run frontend javascript end-to-end tests with `Playwright <https://playwright.dev/>`__                                                                              |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run all-tests``                         | Run all backend and frontend tests                                                                                                                                  |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run check-backend``                     | Check backend health                                                                                                                                                |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run check-frontend``                    | Check frontend health                                                                                                                                               |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run check``                             | Check backend and frontend health                                                                                                                                   |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run kind-logs-backend``                 | Show backend container logs                                                                                                                                         |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run kind-logs-frontend``                | Show frontend container logs                                                                                                                                        |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run kind-logs``                         | Show backend and frontend container logs                                                                                                                            |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run dev-health``                        | Check *dev* environment, backend and frontend health, API endpoint, running pods                                                                                    |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run format``                            | Run ruff formatting                                                                                                                                                 |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run lint``                              | Run ruff linting                                                                                                                                                    |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ``run lint-fix``                          | Run ruff linting and fix                                                                                                                                            |
+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+

.. _pixi-graph-tasks:

Pixi dependency graph tasks
~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code:: bash

   install â”€â”
            â”‚
   generate-codegen â”€â”
                     â”‚
   compile-requirements-backend â”€â”€â”
                                  â”œâ”€â†’ compile-requirements
   compile-requirements-frontend â”€â”˜

   compile-requirements-backend-dev â”€â”€â”
                                      â”œâ”€â†’ compile-requirements-dev
   compile-requirements-frontend-dev â”€â”˜

   install-all â”€â”
                â”‚
   generate-codegen â”€â”
                     â”‚
   compile-requirements-backend-dev â”€â”€â”
                                      â”œâ”€â†’ compile-requirements-dev
   compile-requirements-frontend-dev â”€â”˜                  â”‚
                                                         â”‚
   npm-install â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                                         â”œâ”€â†’ dev-setup
   generate-frontend-schema â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


   kind-create â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   build-backend-dev  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
                                   â”œâ”€â†’ build-images-dev â”€â”
   build-frontend-dev â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
                                                         â”œâ”€â†’ dev-up
   ingress-install â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   helm-dev-install â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   kind-create â”€â”€â”€â”€â”€â”€â”€â”
   ingress-install â”€â”€â”€â”œâ”€â†’ dev-up-no-build
   helm-dev-install â”€â”€â”˜

   build-backend â”€â”€â”
                   â”œâ”€â†’ build-images
   build-frontend â”€â”˜

   kind-clean-failed â”€â”
                      â”œâ”€â†’ helm-install
   kind-load-images â”€â”€â”˜

   kind-clean-failed â”€â”€â”€â”€â”
                         â”œâ”€â†’ helm-dev-install
   kind-load-dev-images â”€â”˜

   kind-load-images â”€â”€â†’ helm-upgrade
   kind-load-dev-images â”€â”€â†’ helm-dev-upgrade

   helm-uninstall â”€â”€â”€â”
   build-images â”€â”€â”€â”€â”€â”¤â”€â†’ restart
   helm-install â”€â”€â”€â”€â”€â”˜

   helm-uninstall â”€â”€â”€â”
   build-images-dev â”€â”¤â”€â†’ dev-restart
   helm-install â”€â”€â”€â”€â”€â”˜

   helm-uninstall â”€â”€â”€â”
                     â”œâ”€â†’ dev-restart-no-build
   helm-dev-install â”€â”˜

   helm-uninstall â”€â”€â†’ stop

   kind-delete â”€â”
                â”œâ”€â†’ stop-and-delete
                â””â”€â†’ clean-all

   test-backend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   test-frontend-py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   test-frontend-js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   browser-install â”€â”€â†’ test-frontend-e2e
                              â””â”€â†’ all-tests

   check-backend â”€â”€â”
                   â”œâ”€â†’ check
   check-frontend â”€â”˜

   kind-logs-backend â”€â”€â”
                       â”œâ”€â†’ kind-logs
   kind-logs-frontend â”€â”˜



.. _makefile-commands:

ğŸ› ï¸ Makefile Commands
--------------------

``Makefile`` commands, described in the table below, are used only for advanced debug pourposes.

+-----------------------+--------------------------------------+
| Command: ``make``     | Description                          |
+=======================+======================================+
| ``dev-forward``       | Manual port-forward (debug/fallback) |
+-----------------------+--------------------------------------+
| ``dev-debug-network`` | Debug network cluster/pod/ingress    |
+-----------------------+--------------------------------------+
| ``dev-trace-request`` | Trace end-to-end request             |
+-----------------------+--------------------------------------+
| ``dev-debug-setup``   | Advance diagnostic cluster setup     |
+-----------------------+--------------------------------------+
| ``kind-status-all``   | Complete health check cluster/app    |
+-----------------------+--------------------------------------+


.. _code-generation-workflow:

Code Generation Workflow
------------------------

The project automatically generates Pydantic models from qualpipe
criteria classes:

.. code:: bash

   # Generate models manually
   pixi run generate-codegen

   # Or use the console script directly (after installation)
   qualpipe-generate-models --module qualpipe.core.criterion \
       --out-generated src/qualpipe_webapp/backend/generated \
       --out-schemas src/qualpipe_webapp/frontend/static

The code generation creates:

-  **Python Models**:
   :file:`src/qualpipe_webapp/backend/generated/qualpipe_criterion_model.py`

   -  Pydantic models for each criterion type
   -  Validation logic for telescope parameters
   -  Type-safe configuration classes

-  **JSON/YAML Schemas**:
   :file:`src/qualpipe_webapp/frontend/static/``

   -  :file:`criteria_schema.json` - JSON schema for frontend criteria
      report validation
   -  :file:`criteria_schema.yaml` - YAML schema for configuration

Such files are then implemented into :file:`metadata_schema.yaml` executing:

.. code:: bash

   pixi run generate-frontend-schema

which is used for complete frontend validations, with all the correct
references read from the configuration file :file:`config.js`. The
:file:`metadata_schema.yaml` file is auto-generated from a template, so

.. important::

   Do not edit :file:`metadata_schema.yaml` directly â€” edit
   :file:`template_metadata_schema.yaml` instead.

Integration with CI/CD
----------------------

The generated models are automatically created during:

-  **Local development**: with ``pixi run dev-setup``
-  **CI/CD pipelines**: code generation runs before CI tests
-  **Package installation**: post-install hooks generate models

.. note::
   ğŸ™ˆ **Generated files are git-ignored** -
   They're created automatically and should not be committed.

   ğŸ”„ **Automatic regeneration** - Models update automatically when
   qualpipe criteria change.


.. warning::
   âš ï¸ **Some tests depend on generated models** - Always run code
   generation before testing, if your changes had an impact on the
   models.
