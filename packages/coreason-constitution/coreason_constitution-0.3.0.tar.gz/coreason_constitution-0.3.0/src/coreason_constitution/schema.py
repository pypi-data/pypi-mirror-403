# Copyright (c) 2025 CoReason, Inc.
#
# This software is proprietary and dual-licensed.
# Licensed under the Prosperity Public License 3.0 (the "License").
# A copy of the license is available at https://prosperitylicense.com/versions/3.0.0
# For details, see the LICENSE file.
# Commercial use beyond a 30-day trial requires a separate license.
#
# Source Code: https://github.com/CoReason-AI/coreason_constitution

from enum import Enum
from typing import Any, Dict, List, Optional, Union

from pydantic import BaseModel, Field


class LawCategory(str, Enum):
    UNIVERSAL = "Universal"
    DOMAIN = "Domain"
    TENANT = "Tenant"


class LawSeverity(str, Enum):
    LOW = "Low"
    MEDIUM = "Medium"
    HIGH = "High"
    CRITICAL = "Critical"


class TraceStatus(str, Enum):
    APPROVED = "APPROVED"
    REVISED = "REVISED"
    BLOCKED = "BLOCKED"


class Law(BaseModel):
    id: str = Field(..., min_length=1, description="Unique identifier for the law (e.g., 'GCP.1')")
    category: LawCategory = Field(..., description="Category of the law")
    text: str = Field(..., min_length=1, description="The actual text of the law/principle")
    severity: LawSeverity = Field(default=LawSeverity.MEDIUM, description="Severity of violation")
    tags: List[str] = Field(default_factory=list, description="Tags for classification")
    source: Optional[str] = Field(default=None, description="Source reference (e.g., 'FDA 21 CFR')")


class SentinelRule(BaseModel):
    id: str = Field(..., min_length=1, description="Unique identifier for the rule (e.g., 'SR.1')")
    pattern: str = Field(..., min_length=1, description="Regex pattern to match")
    description: str = Field(..., min_length=1, description="Description of the rule")
    exempt_groups: List[str] = Field(
        default_factory=list, description="List of user groups allowed to bypass this rule"
    )


class Reference(BaseModel):
    id: str = Field(..., min_length=1, description="Unique identifier for the reference (e.g., 'NCT12345')")
    text: str = Field(..., min_length=1, description="The citation text or title")
    tags: List[str] = Field(default_factory=list, description="Tags for context filtering")
    url: Optional[str] = Field(default=None, description="URL to the source")
    metadata: Dict[str, Any] = Field(default_factory=dict, description="Additional metadata")


class Constitution(BaseModel):
    version: str = Field(..., description="Version of this constitution set")
    laws: List[Law] = Field(default_factory=list, description="List of laws")
    sentinel_rules: List[SentinelRule] = Field(default_factory=list, description="List of Sentinel red line rules")
    references: List[Reference] = Field(default_factory=list, description="List of valid references")


# Union type for loading artifacts
LawOrRuleOrRef = Union[Law, SentinelRule, Reference]
Artifact = Union[Constitution, List[LawOrRuleOrRef], LawOrRuleOrRef]


class Critique(BaseModel):
    violation: bool = Field(..., description="True if a constitutional violation was detected")
    article_id: Optional[str] = Field(default=None, description="The ID of the violated law (e.g., 'GCP.4')")
    severity: LawSeverity = Field(default=LawSeverity.LOW, description="Severity of the detected violation")
    reasoning: str = Field(..., min_length=1, description="Explanation of why the content is or is not compliant")


class TraceIteration(BaseModel):
    input_draft: str = Field(..., min_length=1, description="The content evaluated in this iteration")
    critique: Critique = Field(..., description="The critique generated for this draft")
    revised_output: str = Field(..., min_length=1, description="The result of the revision attempt")


class ConstitutionalTrace(BaseModel):
    status: TraceStatus = Field(..., description="Final status of the compliance check")
    input_draft: str = Field(..., min_length=1, description="The original content generated by the agent")
    critique: Critique = Field(..., description="The initial critique that triggered the intervention")
    revised_output: str = Field(
        ..., min_length=1, description="The final content after revision (or original if valid)"
    )
    delta: Optional[str] = Field(default=None, min_length=1, description="Unified diff showing changes made for safety")
    history: List[TraceIteration] = Field(
        default_factory=list, description="Full history of the critique-and-revise loop"
    )
