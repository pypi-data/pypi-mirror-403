"""Typed helpers for {{ module_title }} metadata serialization."""

from __future__ import annotations

from dataclasses import dataclass
from datetime import datetime, timezone
from typing import Any, Mapping, MutableMapping, Sequence


def _coerce_str(value: Any, default: str | None = None) -> str | None:
    if value is None:
        return default
    text = str(value).strip()
    return text or default


def _coerce_bool(value: Any, default: bool) -> bool:
    if isinstance(value, bool):
        return value
    if value is None:
        return default
    lowered = str(value).strip().lower()
    if lowered in {"1", "true", "yes", "on"}:
        return True
    if lowered in {"0", "false", "no", "off"}:
        return False
    return default


def _coerce_int(value: Any, default: int) -> int:
    try:
        return int(value)
    except (TypeError, ValueError):  # pragma: no cover - defensive guard
        return default


def _coerce_sequence(value: Any) -> tuple[str, ...]:
    if value is None:
        return ()
    if isinstance(value, str):
        return tuple(item.strip() for item in value.split(",") if item.strip())
    if isinstance(value, Sequence):
        return tuple(str(item).strip() for item in value if str(item).strip())
    return ()


@dataclass(frozen=True)
class {{ module_class_name }}HealthSnapshot:
    """Normalized Users Profiles health payload."""

    module: str
    status: str
    checked_at: datetime
    default_timezone: str
    max_bio_length: int
    avatar_max_bytes: int
    allow_marketing_opt_in: bool
    social_links_limit: int
    default_visibility: str
    supported_visibilities: tuple[str, ...]
    features: tuple[str, ...]
    detail: str | None = None

    @classmethod
    def from_mapping(
        cls,
        payload: Mapping[str, Any],
        *,
        module_name: str,
        features: Sequence[str],
        detail: str | None = None,
    ) -> "{{ module_class_name }}HealthSnapshot":
        module = _coerce_str(payload.get("module"), module_name) or module_name
        status = _coerce_str(payload.get("status"), "unknown") or "unknown"
        checked_at_raw = payload.get("checked_at")
        if isinstance(checked_at_raw, datetime):
            checked_at = checked_at_raw
        elif checked_at_raw:
            try:
                checked_at = datetime.fromisoformat(str(checked_at_raw))
            except ValueError:  # pragma: no cover - defensive guard
                checked_at = datetime.fromisoformat(str(checked_at_raw))
            except (TypeError, ValueError):
                checked_at = datetime.now(timezone.utc)
        else:
            checked_at = datetime.now(timezone.utc)
        if checked_at.tzinfo is None:
            checked_at = checked_at.replace(tzinfo=timezone.utc)

        return cls(
            module=module,
            status=status,
            checked_at=checked_at,
            default_timezone=_coerce_str(payload.get("default_timezone"), "UTC") or "UTC",
            max_bio_length=_coerce_int(payload.get("max_bio_length"), 280),
            avatar_max_bytes=_coerce_int(payload.get("avatar_max_bytes"), 2_097_152),
            allow_marketing_opt_in=_coerce_bool(payload.get("allow_marketing_opt_in"), True),
            social_links_limit=_coerce_int(payload.get("social_links_limit"), 5),
            default_visibility=_coerce_str(payload.get("default_visibility"), "public") or "public",
            supported_visibilities=_coerce_sequence(payload.get("supported_visibilities")),
            features=tuple(str(feature).strip() for feature in features if str(feature).strip()),
            detail=detail,
        )


def as_dict(snapshot: {{ module_class_name }}HealthSnapshot) -> MutableMapping[str, Any]:
    payload: MutableMapping[str, Any] = {
        "module": snapshot.module,
        "status": snapshot.status,
        "checked_at": snapshot.checked_at.isoformat(),
        "default_timezone": snapshot.default_timezone,
        "max_bio_length": snapshot.max_bio_length,
        "avatar_max_bytes": snapshot.avatar_max_bytes,
        "allow_marketing_opt_in": snapshot.allow_marketing_opt_in,
        "social_links_limit": snapshot.social_links_limit,
        "default_visibility": snapshot.default_visibility,
        "supported_visibilities": list(snapshot.supported_visibilities),
        "features": list(snapshot.features),
    }
    if snapshot.detail:
        payload["detail"] = snapshot.detail
    return payload


__all__ = [
    "{{ module_class_name }}HealthSnapshot",
    "as_dict",
]
