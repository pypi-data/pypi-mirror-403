"""Shared OAuth health router with optional FastAPI integration."""

from __future__ import annotations

import logging
import time
import importlib.util
import sys
from pathlib import Path
from types import SimpleNamespace
from types import ModuleType
from typing import Any, Dict, Mapping, cast


def _load_local_module(suffix: str, path: Path) -> ModuleType:
    module_name = f"{__name__}__{suffix}"
    existing = sys.modules.get(module_name)
    if isinstance(existing, ModuleType):
        return existing
    spec = importlib.util.spec_from_file_location(module_name, path)
    if spec is None or spec.loader is None:
        raise RuntimeError(f"Unable to load vendor module from {path}")
    module = importlib.util.module_from_spec(spec)
    sys.modules[module_name] = module
    spec.loader.exec_module(module)
    return module


_HERE = Path(__file__).resolve()
_SRC_DIR = _HERE.parent.parent
_MODULE_DIR = _SRC_DIR / "modules" / "free" / "auth" / "oauth"
_oauth_runtime = _load_local_module("oauth_runtime", _MODULE_DIR / "oauth.py")
_oauth_types = _load_local_module("oauth_types", _MODULE_DIR / "oauth_types.py")

describe_oauth = getattr(_oauth_runtime, "describe_oauth")
OAuthHealthSnapshot = getattr(_oauth_types, "OAuthHealthSnapshot")
as_dict = getattr(_oauth_types, "as_dict")

APIRouter: Any
FastAPIApp: Any
status: Any
JSONResponse: Any

try:  # pragma: no cover - FastAPI optional at import time
    from fastapi import APIRouter, Depends, FastAPI as FastAPIApp, status
    from fastapi.responses import JSONResponse
except ImportError:  # pragma: no cover - allow import without FastAPI installed
    APIRouter = cast(Any, None)
    FastAPIApp = cast(Any, None)
    JSONResponse = None
    status = SimpleNamespace(HTTP_200_OK=200, HTTP_503_SERVICE_UNAVAILABLE=503)
    _FASTAPI_AVAILABLE = False
else:
    _FASTAPI_AVAILABLE = True

logger = logging.getLogger("oauth.health")

_STARTED_AT = time.monotonic()

if _FASTAPI_AVAILABLE:
    router = APIRouter(prefix="/api/health/module", tags=["health"])
else:  # pragma: no cover - executed only when FastAPI unavailable
    router = None


def _collect_snapshot() -> OAuthHealthSnapshot:
    metadata: Mapping[str, Any] = describe_oauth()
    return OAuthHealthSnapshot.from_mapping(metadata)


if _FASTAPI_AVAILABLE:

    @router.get(  # type: ignore[union-attr]
        "/oauth",
        summary="OAuth module health check",
        status_code=status.HTTP_200_OK,
    )
    async def oauth_health_check(  # pragma: no cover - exercised in integration tests
        snapshot: OAuthHealthSnapshot = Depends(_collect_snapshot),
    ) -> Dict[str, Any]:
        payload: Dict[str, Any] = as_dict(snapshot)
        payload.update({"status": "ok"})
        payload.setdefault("module", "oauth")
        payload.setdefault("version", "{{ rapidkit_vendor_version }}")
        payload.setdefault("uptime", max(0.0, time.monotonic() - _STARTED_AT))
        logger.debug("OAuth health payload generated", extra={"payload": payload})
        return payload

else:  # pragma: no cover - executed only without FastAPI

    async def oauth_health_check() -> Dict[str, Any]:  # type: ignore[override]
        raise RuntimeError("FastAPI must be installed to expose OAuth health endpoints")


def register_oauth_health(app: Any) -> None:
    """Attach the shared OAuth health router to a FastAPI app."""

    if not _FASTAPI_AVAILABLE:
        raise RuntimeError("FastAPI must be installed to register OAuth health routes")
    if FastAPIApp is not None and not isinstance(app, FastAPIApp):  # pragma: no cover
        raise TypeError("register_oauth_health expects a FastAPI application instance")
    if router is None:  # pragma: no cover - defensive guard
        raise RuntimeError("OAuth health router unavailable")

    app.include_router(router)


__all__ = ["oauth_health_check", "register_oauth_health", "router"]
