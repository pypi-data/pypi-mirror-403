{% set runtime = runtime | default('python') -%}
{% set package_manager = package_manager | default('npm') -%}
{% set package_manager_command = package_manager_command | default(package_manager) -%}

{% macro node_run(script) -%}
{% if package_manager == 'yarn' -%}
{{ package_manager_command }} {{ script }}
{% else -%}
{{ package_manager_command }} run {{ script }}
{% endif -%}
{%- endmacro %}
# ==============================================
# RapidKit Project Automation
# ==============================================
.DEFAULT_GOAL := help
.RECIPEPREFIX := >

COMPOSE_BASE ?= deploy/compose/base.yml
COMPOSE_LOCAL ?= deploy/compose/local.yml
COMPOSE_PRODUCTION ?= deploy/compose/production.yml

POETRY ?= poetry
PYTHON ?= python3

.PHONY: help install setup dev start lint format test coverage typecheck build docker-build docker-up docker-down docker-logs docker-up-prod docker-down-prod docker-logs-prod ci

help: ## Show available commands
> @echo "RapidKit project commands:"
> @echo ""
> @grep -E '^[a-zA-Z0-9_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | \
> awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-24s\033[0m %s\n", $$1, $$2}'

install: ## Install project dependencies
> @echo "[install] Installing dependencies"
{% if runtime == 'python' %}
> $(POETRY) install
{% elif package_manager == 'yarn' %}
> {{ package_manager_command }} install --frozen-lockfile
{% elif package_manager == 'pnpm' %}
> {{ package_manager_command }} install --frozen-lockfile
{% else %}
> {{ package_manager_command }} install
{% endif %}

setup: ## Install dependencies and prepare tooling
> @$(MAKE) install
{% if runtime == 'python' %}
> $(POETRY) run pre-commit install --install-hooks || true
{% endif %}

dev: ## Run the application in development mode
> @echo "[dev] Starting development server"
{% if runtime == 'python' %}
> $(POETRY) run uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
{% else %}
> {{ node_run('start:dev') }}
{% endif %}

start: ## Run the application with production settings
> @echo "[start] Starting production server"
{% if runtime == 'python' %}
> $(POETRY) run uvicorn src.main:app --host 0.0.0.0 --port 8000
{% else %}
> {{ node_run('start:prod') }}
{% endif %}

lint: ## Run static analysis checks
{% if runtime == 'python' %}
> $(POETRY) run ruff check src tests
> $(POETRY) run black --check src tests
{% else %}
> {{ node_run('lint') }}
{% endif %}

format: ## Auto-format the codebase
{% if runtime == 'python' %}
> $(POETRY) run ruff check src tests --fix
> $(POETRY) run black src tests
{% else %}
> {{ node_run('format') }}
{% endif %}

test: ## Run unit tests
{% if runtime == 'python' %}
> $(POETRY) run pytest -q
{% else %}
> {{ node_run('test') }}
{% endif %}

coverage: ## Run tests with coverage reporting
{% if runtime == 'python' %}
> $(POETRY) run pytest --cov=src --cov-report=term-missing
{% elif package_manager == 'yarn' %}
> {{ package_manager_command }} test:cov || {{ package_manager_command }} test --coverage
{% else %}
> {{ node_run('test:cov') }} || {{ node_run('test') }} -- --coverage
{% endif %}

typecheck: ## Run static type checks
{% if runtime == 'python' %}
> $(POETRY) run mypy src
{% else %}
> {{ node_run('lint') }}
{% endif %}

build: ## Build distributable artifacts
{% if runtime == 'python' %}
> $(POETRY) run build
{% else %}
> {{ node_run('build') }}
{% endif %}

ci: ## Run the CI pipeline locally
> @echo "[ci] Running CI pipeline"
> $(MAKE) lint
> $(MAKE) typecheck
> $(MAKE) test

# ==============================================
# Docker helpers
# ==============================================

docker-build: ## Build all Docker images
> docker compose -f $(COMPOSE_BASE) -f $(COMPOSE_LOCAL) build

docker-up: ## Start local Docker services
> docker compose -f $(COMPOSE_BASE) -f $(COMPOSE_LOCAL) --profile local up --remove-orphans

docker-up-prod: ## Start production-like Docker services
> docker compose -f $(COMPOSE_BASE) -f $(COMPOSE_PRODUCTION) --profile production up -d --remove-orphans

docker-down: ## Stop local Docker services
> docker compose -f $(COMPOSE_BASE) -f $(COMPOSE_LOCAL) --profile local down

docker-down-prod: ## Stop production-like Docker services
> docker compose -f $(COMPOSE_BASE) -f $(COMPOSE_PRODUCTION) --profile production down

docker-logs: ## Tail logs from local services
> docker compose -f $(COMPOSE_BASE) -f $(COMPOSE_LOCAL) --profile local logs -f

docker-logs-prod: ## Tail logs from production-like services
> docker compose -f $(COMPOSE_BASE) -f $(COMPOSE_PRODUCTION) --profile production logs -f
