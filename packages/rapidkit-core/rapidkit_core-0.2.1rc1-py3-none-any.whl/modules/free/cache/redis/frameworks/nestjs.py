# pyright: reportMissingImports=false

"""NestJS framework plugin for the Redis module."""

from __future__ import annotations

import json
import logging
from pathlib import Path
from typing import Any, Dict, List, Mapping

from modules.shared.frameworks import FrameworkPlugin
from modules.shared.utils.health_specs import build_standard_health_spec

MODULE_ROOT = Path(__file__).resolve().parents[1]
HEALTH_SHIM_SPEC = build_standard_health_spec(MODULE_ROOT)

logger = logging.getLogger(__name__)  # pylint: disable=E1101

_DEFAULT_TSCONFIG: Dict[str, Any] = {
    "compilerOptions": {
        "module": "commonjs",
        "declaration": True,
        "emitDecoratorMetadata": True,
        "experimentalDecorators": True,
        "target": "ES2020",
        "sourceMap": True,
        "outDir": "./dist",
        "baseUrl": "./",
        "incremental": True,
        "skipLibCheck": True,
    }
}

_DEFAULT_PACKAGE_JSON: Dict[str, Any] = {
    "name": "redis-config",
    "version": "1.0.0",
    "description": "NestJS Redis configuration generated by RapidKit",
    "private": True,
    "license": "UNLICENSED",
    "scripts": {
        "build": "nest build",
        "start": "nest start",
        "start:dev": "nest start --watch",
        "test": "jest",
    },
    "dependencies": {
        "@nestjs/common": "^11.1.6",
        "@nestjs/core": "^11.1.6",
        "@nestjs/config": "^4.0.2",
        "joi": "^17.12.0",
    },
    "devDependencies": {
        "typescript": "^5.1.3",
        "ts-node": "^10.9.1",
        "@nestjs/cli": "^11.0.10",
    },
}


class NestJSPlugin(FrameworkPlugin):
    """Plugin for generating NestJS Redis configuration artefacts."""

    @property
    def name(self) -> str:
        return "nestjs"

    @property
    def language(self) -> str:
        return "typescript"

    @property
    def display_name(self) -> str:
        return "NestJS"

    def get_template_mappings(self) -> Dict[str, str]:
        return {
            "configuration": "templates/variants/nestjs/configuration.ts.j2",
            "service": "templates/variants/nestjs/redis.service.ts.j2",
            "module": "templates/variants/nestjs/redis.module.ts.j2",
            "controller": "templates/variants/nestjs/redis.controller.ts.j2",
            "health": "templates/variants/nestjs/redis.health.ts.j2",
            "index": "templates/variants/nestjs/index.ts.j2",
            "validation": "templates/variants/nestjs/validation.ts.j2",
            "integration_test": "templates/tests/integration/redis.integration.spec.ts.j2",
            "e2e_spec": "templates/variants/nestjs/tests/redis.e2e-spec.ts",
        }

    def get_output_paths(self) -> Dict[str, str]:
        return {
            "configuration": "src/modules/free/cache/redis/configuration.ts",
            "service": "src/modules/free/cache/redis/redis.service.ts",
            "module": "src/modules/free/cache/redis/redis.module.ts",
            "controller": "src/modules/free/cache/redis/redis.controller.ts",
            "health": "src/modules/free/cache/redis/redis.health.ts",
            "index": "src/modules/free/cache/redis/index.ts",
            "validation": "src/modules/free/cache/redis/redis.validation.ts",
            "integration_test": "tests/modules/integration/cache/redis/redis.integration.spec.ts",
            "e2e_spec": "tests/modules/e2e/free/cache/redis/redis.e2e-spec.ts",
        }

    def get_context_enrichments(self, base_context: Mapping[str, Any]) -> Dict[str, Any]:
        return {
            **base_context,
            "framework": "nestjs",
            "framework_display_name": "NestJS",
            "language": "typescript",
            "vendor_configuration_relative": base_context.get(
                "rapidkit_vendor_nest_configuration_relative", "nestjs/configuration.js"
            ),
            "vendor_service_relative": base_context.get("rapidkit_vendor_nest_service_relative"),
            "vendor_module_relative": base_context.get("rapidkit_vendor_nest_module_relative"),
            "vendor_index_relative": base_context.get("rapidkit_vendor_nest_index_relative"),
            "vendor_validation_relative": base_context.get(
                "rapidkit_vendor_nest_validation_relative"
            ),
        }

    def validate_requirements(self) -> List[str]:
        return []

    def pre_generation_hook(self, output_dir: Path) -> None:
        config_dir = output_dir / "src" / "modules" / "free" / "cache" / "redis"
        config_dir.mkdir(parents=True, exist_ok=True)
        (output_dir / "tests" / "modules" / "integration" / "cache" / "redis").mkdir(
            parents=True, exist_ok=True
        )
        self._ensure_tsconfig(output_dir / "tsconfig.json")
        self._ensure_package_json(output_dir / "package.json")

    def post_generation_hook(self, output_dir: Path) -> None:  # noqa: ARG002
        return None

    def _ensure_tsconfig(self, tsconfig_path: Path) -> None:
        if tsconfig_path.exists():
            try:
                current = json.loads(tsconfig_path.read_text())
            except json.JSONDecodeError:
                logger.warning("Existing tsconfig.json is invalid JSON; skipping updates")
                return

            compiler_options = current.setdefault("compilerOptions", {})
            updated = False
            for key, value in _DEFAULT_TSCONFIG["compilerOptions"].items():
                if key not in compiler_options:
                    compiler_options[key] = value
                    updated = True

            if updated:
                tsconfig_path.write_text(json.dumps(current, indent=2) + "\n")
                logger.info("Updated tsconfig.json with Redis defaults")
            return

        tsconfig_path.write_text(json.dumps(_DEFAULT_TSCONFIG, indent=2) + "\n")
        logger.info("Created tsconfig.json scaffold for NestJS Redis module")

    def _ensure_package_json(self, package_path: Path) -> None:
        if package_path.exists():
            try:
                current = json.loads(package_path.read_text())
            except json.JSONDecodeError:
                logger.warning("Existing package.json is invalid JSON; skipping updates")
                return

            updated = False
            for section, defaults in _DEFAULT_PACKAGE_JSON.items():
                if section not in {"dependencies", "devDependencies", "scripts"}:
                    continue
                target = current.setdefault(section, {})
                if not isinstance(target, dict):
                    logger.warning("package.json section '%s' is not a mapping; skipping", section)
                    continue
                for key, value in defaults.items():
                    if key not in target:
                        target[key] = value
                        updated = True

            for root_key in ("name", "version", "description", "private", "license"):
                if root_key not in current:
                    current[root_key] = _DEFAULT_PACKAGE_JSON[root_key]
                    updated = True

            if updated:
                package_path.write_text(json.dumps(current, indent=2) + "\n")
                logger.info("Augmented package.json with Redis defaults")
            return

        package_path.write_text(json.dumps(_DEFAULT_PACKAGE_JSON, indent=2) + "\n")
        logger.info("Created package.json scaffold for NestJS Redis module")

    def get_documentation_urls(self) -> Dict[str, str]:
        return {
            "framework_docs": "https://docs.nestjs.com/",
            "redis": "https://redis.io/docs/clients/node/",
            "configuration": "https://docs.nestjs.com/techniques/configuration",
        }

    def get_example_configurations(self) -> Dict[str, Any]:
        return {
            "redis": {
                "url": "redis://localhost:6379/0",
                "preconnect": False,
                "retries": 3,
                "backoffBase": 0.5,
                "ttl": 3600,
            }
        }

    def get_dependencies(self) -> List[str]:
        return [
            "@nestjs/common",
            "@nestjs/core",
            "@nestjs/config",
            "joi",
            "ioredis",
        ]

    def get_dev_dependencies(self) -> List[str]:
        return [
            "typescript",
            "ts-node",
            "@nestjs/cli",
            "@nestjs/testing",
            "jest",
            "ts-jest",
            "@types/jest",
        ]


class NestJSStandardPlugin(NestJSPlugin):
    """Alias plugin so nestjs.standard reuses the canonical NestJS implementation."""

    @property
    def name(self) -> str:  # noqa: D401 - alias reroutes to NestJS plugin
        return "nestjs.standard"

    @property
    def display_name(self) -> str:
        return "NestJS (standard kit)"
