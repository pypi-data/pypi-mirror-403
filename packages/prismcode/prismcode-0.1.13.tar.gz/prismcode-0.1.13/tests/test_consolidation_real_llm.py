"""
Test consolidation with a REAL LLM call to see actual gist output.

Outputs:
- gist_output.md: The raw gist generated by the LLM
- consolidation_real_llm_results.md: Full results with working history
"""
import sys
import asyncio
from pathlib import Path
from datetime import datetime

sys.path.insert(0, str(Path(__file__).parent))

import litellm
from core.context_management import (
    HistoryManager,
    CharCounter,
    ContextAwareGist,
    HistoryQuery,
)

SESSION_FILE = Path.home() / ".mobius/histories/20260121_171256_7f44c4.gt.json"
OUTPUT_DIR = Path("/Users/offbeat/mobius")


async def real_gist_fn(prompt: str) -> str:
    """Call a real LLM to generate the gist."""
    response = await litellm.acompletion(
        model="anthropic/claude-sonnet-4-20250514",
        messages=[{"role": "user", "content": prompt}],
        max_tokens=4000,  # Allow longer gists
    )
    return response.choices[0].message.content


async def main():
    print("Loading session...")
    manager = HistoryManager.load(SESSION_FILE)
    counter = CharCounter()

    query = HistoryQuery(manager.working.entries, counter)
    initial_entries = query.total_entries()
    initial_tokens = query.total_tokens()
    print(f"Initial: {initial_entries} entries, {initial_tokens:,} tokens\n")

    # Use ContextAwareGist with real LLM
    strategy = ContextAwareGist(
        budget=initial_tokens,
        threshold=0.5,
        compress_ratio=0.2,  # Oldest 20%
        min_entries_to_keep=4,
        consolidator_context=0.5,  # Recent 50% as context
    )

    print("Running consolidation with real LLM (Claude Sonnet)...")
    result = await strategy.consolidate(manager, counter, gist_fn=real_gist_fn)

    # === Output 1: Just the raw gist ===
    gist_output = f"""# Gist Output

**Generated**: {datetime.now().isoformat()}
**Model**: Claude Sonnet
**Entries compressed**: {result.entries_replaced}
**Tokens before**: {result.tokens_before:,}
**Tokens after**: {result.tokens_after:,}
**Tokens saved**: {result.tokens_saved:,}
**Compression ratio**: {result.compression_ratio:.2f}x

---

{result.gist_text}
"""

    gist_file = OUTPUT_DIR / "gist_output.md"
    gist_file.write_text(gist_output)
    print(f"Raw gist written to: {gist_file}")

    # === Output 2: Full results with working history ===
    output = []
    output.append("# Real LLM Consolidation Results\n")
    output.append(f"**Generated**: {datetime.now().isoformat()}")
    output.append(f"**Model**: Claude Sonnet")
    output.append(f"**Entries replaced**: {result.entries_replaced}")
    output.append(f"**Tokens before**: {result.tokens_before:,}")
    output.append(f"**Tokens after**: {result.tokens_after:,}")
    output.append(f"**Tokens saved**: {result.tokens_saved:,}")
    output.append(f"**Compression ratio**: {result.compression_ratio:.2f}x\n")

    output.append("---\n")
    output.append("## The Gist\n")
    output.append(result.gist_text)
    output.append("\n---\n")
    output.append("## Working History After Consolidation\n")

    for i, entry in enumerate(manager.working.entries):
        role = entry.role.upper()
        content = entry.content or ""

        if entry.is_gist:
            output.append(f"### Entry {i}: ðŸ—œï¸ GIST\n")
            output.append("```")
            output.append(content)
            output.append("```\n")
        else:
            # Truncate long content
            if entry.tool_calls:
                tools = [tc["function"]["name"] for tc in entry.tool_calls]
                preview = f"[Tool calls: {', '.join(tools)}]"
            elif len(content) > 300:
                preview = content[:300] + "..."
            else:
                preview = content

            output.append(f"### Entry {i}: {role}\n")
            output.append(f"{preview}\n")

    results_file = OUTPUT_DIR / "consolidation_real_llm_results.md"
    results_file.write_text("\n".join(output))
    print(f"Full results written to: {results_file}")


if __name__ == "__main__":
    asyncio.run(main())
