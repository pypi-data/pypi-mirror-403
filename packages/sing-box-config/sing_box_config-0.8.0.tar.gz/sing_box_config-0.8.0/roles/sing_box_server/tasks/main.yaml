---
# Main tasks for sing_box_server role

- name: validate configuration parameters
  ansible.builtin.import_tasks: validate.yaml

- name: generate credentials if not provided
  ansible.builtin.import_tasks: generate_credentials.yaml

- name: template sing-box server configuration on local
  become: false
  ansible.builtin.template:
    src: config.json.j2
    dest: "{{ sing_box_local_client_outbounds }}/{{ inventory_hostname }}.config.json"
    mode: "0600"
    validate: sing-box check -c %s
  delegate_to: localhost
  run_once: true

- name: template sing-box server configuration
  ansible.builtin.template:
    src: config.json.j2
    dest: "{{ sing_box_etc_config_file }}"
    owner: "{{ sing_box_user.name }}"
    group: "{{ sing_box_group.name }}"
    mode: "0600"
    validate: sing-box check -c %s
  notify:
    - systemctl restart sing-box
