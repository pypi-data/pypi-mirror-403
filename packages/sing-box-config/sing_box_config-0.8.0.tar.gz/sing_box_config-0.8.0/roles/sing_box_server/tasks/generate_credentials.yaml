---
# Generate credentials task - auto-generate passwords if not provided
# All tasks run on localhost without privilege escalation

- name: validate and normalize user_count
  ansible.builtin.set_fact:
    _user_count: "{{ [sing_box_server_user_count | int, 1] | max | int }}"
    _user_count_max: "{{ [sing_box_server_user_count | int, 10] | min | int }}"
  become: false

- name: set final user_count within range
  ansible.builtin.set_fact:
    _final_user_count: "{{ [_user_count, _user_count_max] | min | int }}"
  become: false

- name: select user names from predefined list
  ansible.builtin.set_fact:
    _selected_user_names: "{{ sing_box_server_user_names[:_final_user_count | int] }}"
  become: false

- name: generate shadowsocks credentials
  when: sing_box_server_enable_shadowsocks
  become: false
  block:
    - name: generate shadowsocks server password if empty
      when: sing_box_server_shadowsocks_password == ""
      ansible.builtin.set_fact:
        sing_box_server_shadowsocks_password: "{{ lookup('password', '/dev/null length=' + (sing_box_server_shadowsocks_method_key_length[sing_box_server_shadowsocks_method] | string) + ' chars=ascii_letters,digits') | b64encode }}"

    - name: initialize shadowsocks users list if empty
      when: sing_box_server_shadowsocks_users | length == 0
      ansible.builtin.set_fact:
        sing_box_server_shadowsocks_users: []

    - name: generate shadowsocks users if empty
      ansible.builtin.set_fact:
        sing_box_server_shadowsocks_users: "{{ sing_box_server_shadowsocks_users + [{'name': item, 'password': lookup('password', '/dev/null length=' + (sing_box_server_shadowsocks_method_key_length[sing_box_server_shadowsocks_method] | string) + ' chars=ascii_letters,digits') | b64encode}] }}"
      loop: "{{ _selected_user_names }}"
      when: item not in (sing_box_server_shadowsocks_users | map(attribute='name') | list)

- name: generate trojan credentials
  when: sing_box_server_enable_trojan
  become: false
  block:
    - name: initialize trojan users list if empty
      when: sing_box_server_trojan_users | length == 0
      ansible.builtin.set_fact:
        sing_box_server_trojan_users: []

    - name: generate trojan users if empty
      ansible.builtin.set_fact:
        sing_box_server_trojan_users: "{{ sing_box_server_trojan_users + [{'name': item, 'password': lookup('password', '/dev/null length=24 chars=ascii_letters,digits')}] }}"
      loop: "{{ _selected_user_names }}"
      when: item not in (sing_box_server_trojan_users | map(attribute='name') | list)

- name: generate hysteria2 credentials
  when: sing_box_server_enable_hysteria2
  become: false
  block:
    - name: generate hysteria2 obfs password if needed
      when: sing_box_server_hysteria2_obfs_enabled and sing_box_server_hysteria2_obfs_password == ""
      ansible.builtin.set_fact:
        sing_box_server_hysteria2_obfs_password: "{{ lookup('password', '/dev/null length=24 chars=ascii_letters,digits') }}"

    - name: initialize hysteria2 users list if empty
      when: sing_box_server_hysteria2_users | length == 0
      ansible.builtin.set_fact:
        sing_box_server_hysteria2_users: []

    - name: generate hysteria2 users if empty
      ansible.builtin.set_fact:
        sing_box_server_hysteria2_users: "{{ sing_box_server_hysteria2_users + [{'name': item, 'password': lookup('password', '/dev/null length=24 chars=ascii_letters,digits')}] }}"
      loop: "{{ _selected_user_names }}"
      when: item not in (sing_box_server_hysteria2_users | map(attribute='name') | list)

- name: generate vless credentials
  when: sing_box_server_enable_vless
  become: false
  block:
    - name: initialize vless users list if empty
      when: sing_box_server_vless_users | length == 0
      ansible.builtin.set_fact:
        sing_box_server_vless_users: []

    - name: generate vless users if empty
      ansible.builtin.set_fact:
        sing_box_server_vless_users: "{{ sing_box_server_vless_users + [{'name': item, 'uuid': lookup('password', '/dev/null length=36 chars=hexdigits') | regex_replace('^(.{8})(.{4})(.{4})(.{4})(.{12}).*$', '\\1-\\2-\\3-\\4-\\5') | lower}] }}"
      loop: "{{ _selected_user_names }}"
      when: item not in (sing_box_server_vless_users | map(attribute='name') | list)

- name: generate tuic credentials
  when: sing_box_server_enable_tuic
  become: false
  block:
    - name: initialize tuic users list if empty
      when: sing_box_server_tuic_users | length == 0
      ansible.builtin.set_fact:
        sing_box_server_tuic_users: []

    - name: generate tuic users if empty
      ansible.builtin.set_fact:
        sing_box_server_tuic_users: "{{ sing_box_server_tuic_users + [{'name': item, 'uuid': lookup('password', '/dev/null length=36 chars=hexdigits') | regex_replace('^(.{8})(.{4})(.{4})(.{4})(.{12}).*$', '\\1-\\2-\\3-\\4-\\5') | lower, 'password': lookup('password', '/dev/null length=24 chars=ascii_letters,digits')}] }}"
      loop: "{{ _selected_user_names }}"
      when: item not in (sing_box_server_tuic_users | map(attribute='name') | list)

- name: ensure host_vars directory exists for host
  ansible.builtin.file:
    path: "{{ playbook_dir }}/host_vars/{{ inventory_hostname }}"
    state: directory
    mode: "0755"
  delegate_to: localhost
  become: false

- name: save generated credentials to host_vars
  ansible.builtin.template:
    src: host_vars.yaml.j2
    dest: "{{ playbook_dir }}/host_vars/{{ inventory_hostname }}/sing_box_server.yml"
    mode: "0600"
  delegate_to: localhost
  become: false

- name: generate unified sing-box client outbounds configuration
  ansible.builtin.template:
    src: client_outbounds.json.j2
    dest: "{{ sing_box_local_client_outbounds }}/{{ inventory_hostname }}.outbounds.json"
    mode: "0600"
  delegate_to: localhost
  become: false

- name: generate unified clash client proxies configuration
  ansible.builtin.template:
    src: clash_nodelist.yaml.j2
    dest: "{{ sing_box_local_client_outbounds }}/{{ inventory_hostname }}.proxies.yaml"
    mode: "0600"
  delegate_to: localhost
  become: false

- name: display credentials location
  ansible.builtin.debug:
    msg:
      - "✓ Credentials saved to: {{ playbook_dir }}/host_vars/{{ inventory_hostname }}/sing_box_server.yml"
      - "✓ Client outbounds config: {{ sing_box_local_client_outbounds }}/{{ inventory_hostname }}.json"
      - "✓ Generated {{ _final_user_count }} user(s): {{ _selected_user_names | join(', ') }}"
  become: false
