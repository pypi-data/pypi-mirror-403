---
- name: validate configuration
  ansible.builtin.import_tasks: validation.yaml

- name: ensure sing_box_group exists
  ansible.builtin.group:
    name: "{{ sing_box_group.name }}"
    gid: "{{ sing_box_group.gid | int }}"
    state: present

- name: ensure sing_box_user exists
  ansible.builtin.user:
    name: "{{ sing_box_user.name }}"
    uid: "{{ sing_box_user.uid | int }}"
    home: "{{ sing_box_user.home }}"
    shell: "{{ sing_box_user.shell }}"
    group: "{{ sing_box_group.name }}"
    state: present

- name: create drop-in directory on remote
  ansible.builtin.file:
    path: "{{ directory }}"
    owner: "{{ sing_box_user.name }}"
    group: "{{ sing_box_group.name }}"
    mode: "0700"
    state: directory
  loop:
    - "{{ sing_box_etc_dir }}"
    - "{{ sing_box_log_dir }}"
    - "{{ sing_box_state_dir }}"
    - "{{ sing_box_state_config_dir }}"
    - "{{ sing_box_state_acme_dir }}"
  loop_control:
    loop_var: directory

- name: create drop-in directory on local
  become: false
  ansible.builtin.file:
    path: "{{ directory }}"
    mode: "0700"
    state: directory
  loop:
    - "{{ sing_box_local_config_dir }}"
    - "{{ sing_box_local_client_outbounds }}"
  loop_control:
    loop_var: directory
  delegate_to: localhost
  run_once: true

- name: ensure apt_keyrings_dest directory exists
  ansible.builtin.file:
    path: "{{ sing_box_install_apt_keyrings_dest | ansible.builtin.dirname }}"
    state: directory
    mode: "0755"

# $ curl -sL https://sing-box.app/gpg.key | gpg
# pub   rsa4096 2024-03-12 [SC]
#       2C317FBD5D886B4E89BAE8DA6D9152172A2B2F0C
# uid           Project S <contact@sagernet.org>
# sub   rsa4096 2024-03-12 [E]
- name: get apt key from apt_key_url
  ansible.builtin.get_url:
    url: "{{ sing_box_install_apt_key_url }}"
    dest: "{{ sing_box_install_apt_keyrings_dest }}"
    mode: "0644"

- name: add apt repo in DEB822 format
  vars:
    # ansible_architecture return x86_64,
    # but $(dpkg --print-architecture) return = amd64
    deb_architectures:
      x86_64: amd64
  ansible.builtin.deb822_repository:
    name: "{{ sing_box_install_apt_repo }}"
    state: present
    enabled: true
    types: deb
    uris: "{{ sing_box_install_apt_repo_uris }}"
    suites: "{{ sing_box_install_apt_repo_suites }}"
    components: "{{ sing_box_install_apt_repo_components }}"
    architectures: "{{ deb_architectures[ansible_architecture] }}"
    signed_by: "{{ sing_box_install_apt_keyrings_dest }}"

- name: add apt package pinning
  ansible.builtin.copy:
    dest: "/etc/apt/preferences.d/99{{ sing_box_install_apt_repo }}"
    content: |
      Package: *
      Pin: origin {{ sing_box_install_apt_repo_uris | ansible.builtin.urlsplit('hostname') }}
      Pin-Priority: 900
    mode: "0644"

- name: install sing-box package
  ansible.builtin.apt:
    name: "{{ sing_box_install_apt_repo_packages }}"
    update_cache: true
    state: present

- name: template systemd service
  ansible.builtin.import_tasks: systemd.yaml
