---
# sing-box å®‰è£…æ¨¡å¼: [mixed, local, gateway]
# mixed: ä»…å®‰è£…å¹¶å¯ç”¨ mixed port, ä¸é…ç½®é€æ˜ä»£ç†, éœ€è¦é¢å¤–é…ç½® system proxy
# local: æœ¬åœ°é€æ˜ä»£ç†, ä¸ä»£ç†å†…ç½‘ä¸­å…¶å®ƒä¸»æœºçš„æµé‡
# gateway: ç”¨ä½œé€æ˜ä»£ç†ç½‘å…³, è¿™ä¹Ÿæ˜¯ç›®å‰çš„é»˜è®¤è¡Œä¸º
sing_box_mode: gateway
sing_box_mode_available: ["mixed", "local", "gateway"]

# åŸºäºæ¨¡å¼è‡ªåŠ¨è®¡ç®—çš„ç‰¹æ€§å¼€å…³ (å†…éƒ¨ä½¿ç”¨, ä¸è¦æ‰‹åŠ¨ä¿®æ”¹)
_sing_box_enable_tproxy: "{{ sing_box_mode in ['local', 'gateway'] }}"
_sing_box_enable_nftables: "{{ sing_box_mode in ['local', 'gateway'] }}"
_sing_box_enable_ip_forward: "{{ sing_box_mode == 'gateway' }}"
_sing_box_enable_netplan_routing: "{{ sing_box_mode in ['local', 'gateway'] }}"

# æ˜¯å¦å¯ç”¨ IPv6
_sing_box_enable_ipv6: "{{ ansible_default_ipv6 is defined and ansible_default_ipv6.interface is defined }}"

# https://wiki.debian.org/SystemGroups#Groups_with_an_associated_user
# proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
sing_box_user:
  name: proxy
  uid: 13
  home: /bin
  shell: /usr/sbin/nologin
sing_box_group:
  name: proxy
  gid: 13

# github proxy for ruleset.url
# sing_box_github_proxy: "https://gh.ak1ra.xyz/"
sing_box_github_proxy: ""

# å¯¹åº” sing-box ä¸­ type = mixed çš„ inbounds
sing_box_mixed_port: 7890

# å¯¹åº” sing-box ä¸­ type = tproxy çš„ inbounds
sing_box_tproxy_port: 7895

# ip -f inet rule add fwmark $PROXY_MARK lookup $PROXY_ROUTE_TABLE
# ip -f inet route add local default dev $INTERFACE table $PROXY_ROUTE_TABLE
# echo "224 sing_box_tproxy" | sudo tee /etc/iproute2/rt_tables.d/sing_box_tproxy.conf >/dev/null
sing_box_proxy_route_table: 224
sing_box_proxy_mark: 224

# å¯¹åº” sing-box é…ç½®é¡¹ route.default_mark
sing_box_route_default_mark: 225

# sing-box config.json log.level
# Log level. One of: trace debug info warn error fatal panic
sing_box_log_level: warn

sing_box_etc_dir: /etc/sing-box
sing_box_log_dir: /var/log/sing-box
sing_box_state_dir: /var/lib/sing-box

sing_box_etc_config_file: "{{ sing_box_etc_dir }}/config.json"

sing_box_state_venv_dir: "{{ sing_box_state_dir }}/.venv"
sing_box_state_config_dir: "{{ sing_box_state_dir }}/config"
sing_box_state_acme_dir: "{{ sing_box_state_dir }}/acme"

# git repo root dir, also same as uv build dir
# playbook, host_vars, group_vars ç°åœ¨æ”¾ç½®åœ¨ playbooks/ ç›®å½•ä¸‹, è¿™æ ·æŒ‰ playbook_dir å–ç›¸å¯¹è·¯å¾„æ‰ä¸ä¼šå‡ºé”™
sing_box_local_repo_root: "{{ playbook_dir | ansible.builtin.dirname }}"
sing_box_local_config_dir: "{{ sing_box_local_repo_root }}/config"

# roles/sing_box_server å°† client_outbounds.json.j2 æ¸²æŸ“åˆ° sing_box_local_client_outbounds
# roles/sing_box_config å°è¯•ä» sing_box_local_client_outbounds ç›®å½•æ•´ä½“å¤åˆ¶åˆ° sing_box_state_config_dir
# å³ç›®å½•ç»“æ„ä¸º /var/lib/sing-box/config/outbounds/{{ inventory_hostname }}.json
sing_box_local_client_outbounds: "{{ sing_box_local_config_dir }}/client_outbounds"

# https://github.com/MetaCubeX/meta-rules-dat/tree/sing/geo/
# https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/sing/geo/
sing_box_remote_rule_set_url_prefix: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/sing/geo/"

sing_box_remote_rule_sets:
  - path: geoip/cn.srs
  - path: geoip/private.srs
  - path: geoip/telegram.srs
  - path: geosite/category-ai-!cn.srs
  - path: geosite/category-entertainment.srs
  - path: geosite/cn.srs
  - path: geosite/gfw.srs
  - path: geosite/github.srs
  - path: geosite/google.srs
  - path: geosite/private.srs
  - path: geosite/telegram.srs

sing_box_dns_rules:
  - action: route
    rule_set:
      - geosite-cn
      - geosite-private
    server: dns_direct
  - action: route
    query_type: [A, AAAA]
    rule_set:
      - geosite-category-ai-!cn
      - geosite-category-entertainment
      - geosite-gfw
      - geosite-github
      - geosite-google
      - geosite-telegram
    server: dns_fakeip

sing_box_basic_rules:
  - action: hijack-dns
    port: 53
  - action: hijack-dns
    protocol: dns
  - action: route
    port: 22
    outbound: SSH

sing_box_filtering_rules:
  - action: route
    rule_set: [geoip-private, geosite-private]
    outbound: DIRECT
  - action: route
    rule_set: [geoip-cn, geosite-cn]
    outbound: DIRECT
  - action: route
    rule_set: [geosite-category-ai-!cn]
    outbound: AI
  - action: route
    rule_set: [geosite-category-entertainment]
    outbound: Entertainment
  - action: route
    rule_set: [geoip-telegram, geosite-telegram]
    outbound: TELEGRAM
  - action: route
    rule_set: [geosite-gfw, geosite-github, geosite-google]
    outbound: PROXY

sing_box_proxy_groups:
  - tag: PROXY
    type: selector
    outbounds: []
  - tag: FINAL
    type: selector
    outbounds: [PROXY, DIRECT]
  - tag: AI
    type: selector
    outbounds: [PROXY, DIRECT]
  - tag: Entertainment
    type: selector
    outbounds: [PROXY, DIRECT]
  - tag: TELEGRAM
    type: selector
    outbounds: [PROXY, DIRECT]
  - tag: SSH
    type: selector
    outbounds: [DIRECT, PROXY]

sing_box_auto_groups:
  - tag: "ğŸ‡¸ğŸ‡¬ ç‹®åŸèŠ‚ç‚¹ - AUTO"
    filter: "æ–°åŠ å¡|å¡|ç‹®åŸ|SG|Singapore"
  - tag: "ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹ - AUTO"
    filter: "æ¸¯|HK|Hong Kong"
  - tag: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹ - AUTO"
    filter: "æ—¥æœ¬|å·æ—¥|ä¸œäº¬|å¤§é˜ª|æ³‰æ—¥|åŸ¼ç‰|æ²ªæ—¥|æ·±æ—¥|JP|Japan"
  - tag: "ğŸ‡¹ğŸ‡¼ å°æ¹¾èŠ‚ç‚¹ - AUTO"
    filter: "å°|æ–°åŒ—|å½°åŒ–|TW|Taiwan"
  - tag: "ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹ - AUTO"
    filter: "ç¾|æ³¢ç‰¹å…°|è¾¾æ‹‰æ–¯|ä¿„å‹’å†ˆ|å‡¤å‡°åŸ|è´¹åˆ©è’™|ç¡…è°·|æ‹‰æ–¯ç»´åŠ æ–¯|æ´›æ‰çŸ¶|åœ£ä½•å¡|åœ£å…‹æ‹‰æ‹‰|è¥¿é›…å›¾|èŠåŠ å“¥|US|United States"
  - tag: "ğŸ° æ¬§æ´²èŠ‚ç‚¹ - AUTO"
    filter: "(Belgium|æ¯”åˆ©æ—¶)|(Finland|Helsinki|èŠ¬å…°|èµ«å°”è¾›åŸº)|\\bDE[U]?\\b|Germany|æ³•å…°å…‹ç¦|å¾·(å›½|æ„å¿—)|ä¸­å¾·|^å¾·$|\\bD[N]?K\\b|Denmark|ä¸¹éº¦|\\bES[P]?\\b|Spain|è¥¿ç­ç‰™|\\bFR[A]?\\b|France|Paris|æ³•å›½|å·´é»|\\bIS[L]?\\b|Iceland|å†°å²›|\\bNL[D]?\\b|Netherlands|è·å…°|é˜¿å§†æ–¯ç‰¹ä¸¹|\\bUK\\b|\\bGB[R]?\\b|England|United.*?Kingdom|London|è‹±å›½|[^-]è‹±|ä¼¦æ•¦|(Ireland|Dublin|çˆ±å°”å…°|éƒ½æŸæ—)|(Italy|Milan|æ„å¤§åˆ©|ç±³å…°)|(Switzerland|Zurich|ç‘å£«|è‹é»ä¸–)|(å¸Œè…Š|Greece)|(æŒªå¨|Norway)"
  - tag: "ğŸ‡°ğŸ‡· éŸ©å›½èŠ‚ç‚¹ - AUTO"
    filter: "KR|Korea|KOR|é¦–å°”|éŸ©|éŸ“"

sing_box_selector_groups:
  - tag: "ğŸ‡¸ğŸ‡¬ ç‹®åŸèŠ‚ç‚¹"
    filter: "æ–°åŠ å¡|å¡|ç‹®åŸ|SG|Singapore"
  - tag: "ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹"
    filter: "æ¸¯|HK|Hong Kong"
  - tag: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹"
    filter: "æ—¥æœ¬|å·æ—¥|ä¸œäº¬|å¤§é˜ª|æ³‰æ—¥|åŸ¼ç‰|æ²ªæ—¥|æ·±æ—¥|[^-]æ—¥|JP|Japan"
  - tag: "ğŸ‡¹ğŸ‡¼ å°æ¹¾èŠ‚ç‚¹"
    filter: "å°|æ–°åŒ—|å½°åŒ–|TW|Taiwan"
  - tag: "ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹"
    filter: "ç¾|æ³¢ç‰¹å…°|è¾¾æ‹‰æ–¯|ä¿„å‹’å†ˆ|å‡¤å‡°åŸ|è´¹åˆ©è’™|ç¡…è°·|æ‹‰æ–¯ç»´åŠ æ–¯|æ´›æ‰çŸ¶|åœ£ä½•å¡|åœ£å…‹æ‹‰æ‹‰|è¥¿é›…å›¾|èŠåŠ å“¥|US|United States"
  - tag: "ğŸ° æ¬§æ´²èŠ‚ç‚¹"
    filter: "(Belgium|æ¯”åˆ©æ—¶)|(Finland|Helsinki|èŠ¬å…°|èµ«å°”è¾›åŸº)|\\bDE[U]?\\b|Germany|æ³•å…°å…‹ç¦|å¾·(å›½|æ„å¿—)|ä¸­å¾·|^å¾·$|\\bD[N]?K\\b|Denmark|ä¸¹éº¦|\\bES[P]?\\b|Spain|è¥¿ç­ç‰™|\\bFR[A]?\\b|France|Paris|æ³•å›½|å·´é»|\\bIS[L]?\\b|Iceland|å†°å²›|\\bNL[D]?\\b|Netherlands|è·å…°|é˜¿å§†æ–¯ç‰¹ä¸¹|\\bUK\\b|\\bGB[R]?\\b|England|United.*?Kingdom|London|è‹±å›½|[^-]è‹±|ä¼¦æ•¦|(Ireland|Dublin|çˆ±å°”å…°|éƒ½æŸæ—)|(Italy|Milan|æ„å¤§åˆ©|ç±³å…°)|(Switzerland|Zurich|ç‘å£«|è‹é»ä¸–)|(å¸Œè…Š|Greece)|(æŒªå¨|Norway)"
  - tag: "ğŸ‡°ğŸ‡· éŸ©å›½èŠ‚ç‚¹"
    filter: "KR|Korea|KOR|é¦–å°”|éŸ©|éŸ“"
