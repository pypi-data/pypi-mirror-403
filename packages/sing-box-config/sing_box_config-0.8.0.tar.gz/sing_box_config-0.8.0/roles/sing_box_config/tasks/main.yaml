---
# tasks file for sing_box_config
- name: verify sing_box_state_dir exists
  ansible.builtin.stat:
    path: "{{ sing_box_state_dir }}"
  register: sing_box_state_dir_stat
  failed_when:
    - not sing_box_state_dir_stat.stat.exists
    - not sing_box_state_dir_stat.stat.isdir

- name: ensure python3-venv packages is installed
  ansible.builtin.package:
    name:
      - python3-packaging
      - python3-venv
    state: present

- name: install sing-box-config from dist_wheel
  when: sing_box_config_install_source == 'local'
  ansible.builtin.import_tasks: dist_wheel.yaml

- name: install sing-box-config from PyPI
  when: sing_box_config_install_source in ['pypi', 'testpypi']
  ansible.builtin.pip:
    name: sing-box-config
    state: latest
    virtualenv: "{{ sing_box_state_venv_dir }}"
    virtualenv_command: python3 -m venv
    extra_args: "{{ sing_box_config_pip_extra_args[sing_box_config_install_source] }}"
  notify:
    - ensure sing-box working directory ownership

- name: validate sing_box_config_subscriptions
  ansible.builtin.import_tasks: validation.yaml
  vars:
    sub_types: ["inline", "local", "remote"]
    sub_formats: ["sing-box", "sip002"]

- name: ensure sing-box-config configuration and service state
  vars:
    # sing_box_config_base_template 用于从外部传入不同的 template 覆盖 templates/base.json.j2
    # sing_box_config_base_template: "{{ playbook_dir }}/config/base.json.j2"
    basename: "{{ sing_box_config_base_template | ansible.builtin.basename | ansible.builtin.splitext | first }}"
    sing_box_config_base_dest: "{{ [sing_box_state_config_dir, basename] | ansible.builtin.path_join }}"
    sing_box_config_subscriptions_dest: "{{ [sing_box_state_config_dir, 'subscriptions.json'] | ansible.builtin.path_join }}"
    sing_box_config_local_base_dest: "{{ [sing_box_local_config_dir, basename] | ansible.builtin.path_join }}"
    sing_box_config_local_subscriptions_dest: "{{ [sing_box_local_config_dir, 'subscriptions.json'] | ansible.builtin.path_join }}"
  ansible.builtin.import_tasks: state.yaml
