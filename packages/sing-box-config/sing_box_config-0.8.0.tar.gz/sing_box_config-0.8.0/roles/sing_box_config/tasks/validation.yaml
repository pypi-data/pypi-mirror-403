---
- name: validate sing_box_config_subscriptions
  ansible.builtin.assert:
    that:
      - sing_box_config_subscriptions is defined
      - sing_box_config_subscriptions is mapping
      - sing_box_config_subscriptions | length > 0
    fail_msg: |
      Required variable sing_box_config_subscriptions is not defined or invalid.
      Please define it in group_vars or host_vars.
    quiet: true

- name: validate each subscription entry in sing_box_config_subscriptions
  ansible.builtin.assert:
    that:
      - item.value.type is defined
      - item.value.type in sub_types
      - item.value.format is defined
      - item.value.format in sub_formats
    fail_msg: |
      subscription '{{ item.key }}' must have 'type' and 'format' defined,
      and type must in {{ sub_types }}, format must in {{ sub_formats }}
    quiet: true
  loop: "{{ sing_box_config_subscriptions | ansible.builtin.dict2items }}"
  loop_control:
    label: "{{ item.key }}"

- name: validate subscription urls (optional)
  when: sing_box_config_validate_subscription_urls | ansible.builtin.bool
  block:
    - name: validate subscription urls (optional)
      ansible.builtin.uri:
        url: "{{ item.value.url }}"
        method: HEAD
        timeout: 10
        follow_redirects: safe
        validate_certs: true
      loop: "{{ sing_box_config_subscriptions | ansible.builtin.dict2items }}"
      loop_control:
        label: "{{ item.key }}"
      register: subscription_url_checks
      failed_when: false
      changed_when: false

    - name: report subscription urls
      ansible.builtin.debug:
        msg: "subscription '{{ item.item.key }}': {{ 'accessible' if item.status == 200 else 'FAILED (' + (item.status | string) + ')' }}"
      loop: "{{ subscription_url_checks.results }}"
      loop_control:
        label: "{{ item.item.key }}"
