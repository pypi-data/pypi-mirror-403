---
- name: template sing-box-config config/base.json on local
  become: false
  ansible.builtin.template:
    src: "{{ sing_box_config_base_template }}"
    dest: "{{ sing_box_config_local_base_dest }}"
    mode: "0600"
  delegate_to: localhost
  run_once: true

- name: template sing-box-config config/base.json on remote
  ansible.builtin.template:
    src: "{{ sing_box_config_base_template }}"
    dest: "{{ sing_box_config_base_dest }}"
    owner: "{{ sing_box_user.name }}"
    group: "{{ sing_box_group.name }}"
    mode: "0600"

- name: template sing-box-config config/subscriptions.json to local
  become: false
  ansible.builtin.template:
    src: subscriptions.json.j2
    dest: "{{ sing_box_config_local_subscriptions_dest }}"
    mode: "0600"
  delegate_to: localhost
  run_once: true

- name: template sing-box-config config/subscriptions.json to remote
  ansible.builtin.template:
    src: subscriptions.json.j2
    dest: "{{ sing_box_config_subscriptions_dest }}"
    owner: "{{ sing_box_user.name }}"
    group: "{{ sing_box_group.name }}"
    mode: "0600"

- name: try to copy client outbounds from sing_box_local_client_outbounds
  ansible.builtin.copy:
    src: "{{ sing_box_local_client_outbounds }}"
    dest: "{{ sing_box_state_config_dir }}"
    owner: "{{ sing_box_user.name }}"
    group: "{{ sing_box_group.name }}"
    mode: "0600"
  failed_when: false

- name: template systemd timer on remote
  ansible.builtin.template:
    src: "{{ template }}"
    dest: "{{ ['/', template] | ansible.builtin.path_join | ansible.builtin.splitext | first }}"
    mode: "0644"
  loop:
    - etc/systemd/system/sing-box-config-updater.service.j2
    - etc/systemd/system/sing-box-config-updater.timer.j2
  loop_control:
    loop_var: template
  notify:
    - systemctl daemon-reload

- name: flush handlers to ensure daemon-reload completes
  ansible.builtin.meta: flush_handlers

- name: ensure sing-box-config-updater.timer state
  ansible.builtin.systemd_service:
    name: sing-box-config-updater.timer
    state: "{{ sing_box_config_updater_timer_state }}"
    enabled: "{{ sing_box_config_updater_timer_enabled }}"

- name: force clash_api.external_ui (yacd) reinstall
  when: (sing_box_config_clash_api_external_ui_reinstall | ansible.builtin.bool)
  ansible.builtin.file:
    path: "{{ [sing_box_state_dir, sing_box_config_clash_api_external_ui] | ansible.builtin.path_join }}"
    state: absent
  notify:
    - systemctl restart sing-box

# 是否手动执行 sing-box-config 生成/更新 /etc/sing-box/config.json
# 这一步配置文件一旦有变更会被 sing-box-reload.path 监听到从而触发 reload, 所以不需要添加 notify restart
- name: update /etc/sing-box/config.json if requested
  when: sing_box_config_updater_service_state in sing_box_config_updater_service_active_state
  ansible.builtin.systemd_service:
    name: sing-box-config-updater.service
    state: started

# sing-box 服务状态与 nftables 状态相对独立
- name: ensure sing-box.service is started
  ansible.builtin.systemd_service:
    name: sing-box.service
    state: started
    enabled: true
