# Generated by Ansible - DO NOT EDIT MANUALLY

# ip route show default | awk '/default/ {print $5}'
define INTERFACE = "{{ ansible_default_ipv4.interface }}"
{% if _sing_box_enable_ipv6 %}
define INTERFACE6 = "{{ ansible_default_ipv6.interface }}"
{% endif %}

# sing-box tproxy inbound
define TPROXY_PORT = {{ sing_box_tproxy_port }}

# ip -f inet rule add fwmark $PROXY_MARK lookup $PROXY_ROUTE_TABLE
# ip -f inet route add local default dev $INTERFACE table $PROXY_ROUTE_TABLE
{% if _sing_box_enable_ipv6 %}
# ip -f inet6 rule add fwmark $PROXY_MARK lookup $PROXY_ROUTE_TABLE
# ip -f inet6 route add local default dev $INTERFACE6 table $PROXY_ROUTE_TABLE
{% endif %}
# echo "{{ sing_box_proxy_route_table }} sing_box_tproxy" | sudo tee /etc/iproute2/rt_tables.d/sing_box_tproxy.conf >/dev/null
define PROXY_ROUTE_TABLE = {{ sing_box_proxy_route_table }}
define PROXY_MARK = {{ sing_box_proxy_mark }}

# Mark packets generated by PROXY_UID / PROXY_GID process,
# This serves the same purpose as the `route.default_mark` config item in the /etc/sing-box/config.json
# But instead of letting sing-box add its own fwmark in user space, we opted to handle it in nftables
define ROUTE_DEFAULT_MARK = {{ sing_box_route_default_mark }}

# https://wiki.debian.org/SystemGroups#Groups_with_an_associated_user
# proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
define PROXY_UID = {{ sing_box_user.uid }}
define PROXY_GID = {{ sing_box_group.gid }}

table inet sing_box_tproxy {
	# IETF/IANA IPv4 Special-Purpose Address Registry
	# https://www.iana.org/assignments/iana-ipv4-special-registry/
	set reserved_ip4 {
		type ipv4_addr
		flags interval
		elements = {
			0.0.0.0/8,          # "This host on this network" (RFC 1122)
			10.0.0.0/8,         # Private-Use (RFC 1918)
			100.64.0.0/10,      # Shared Address Space (RFC 6598)
			127.0.0.0/8,        # Loopback (RFC 1122)
			169.254.0.0/16,     # Link Local (RFC 3927)
			172.16.0.0/12,      # Private-Use (RFC 1918)
			192.0.0.0/24,       # IETF Protocol Assignments (RFC 6890)
			192.0.2.0/24,       # Documentation (TEST-NET-1) (RFC 5737)
			192.88.99.0/24,     # 6to4 Relay Anycast (RFC 3068, deprecated)
			192.168.0.0/16,     # Private-Use (RFC 1918)
			# 198.18.0.0/15,    # Benchmarking (RFC 2544) + sing-box fakeip
			198.51.100.0/24,    # Documentation (TEST-NET-2) (RFC 5737)
			203.0.113.0/24,     # Documentation (TEST-NET-3) (RFC 5737)
			224.0.0.0/4,        # Multicast (RFC 5771)
			240.0.0.0/4,        # Reserved for Future Use (RFC 1112)
		}
	}

{% if sing_box_tproxy_nftables_custom_bypassed_ip4 | default([], true) | length > 0 %}
	# Custom bypassed addresses (user-defined)
	# Add your custom bypass rules here
	set custom_bypassed_ip4 {
		type ipv4_addr
		flags interval
		elements = {
{% for ip in sing_box_tproxy_nftables_custom_bypassed_ip4 %}
			{{ ip }},
{% endfor %}
		}
	}

{% endif %}
{% if _sing_box_enable_ipv6 %}
	# IETF/IANA IPv6 Special-Purpose Address Registry
	# https://www.iana.org/assignments/iana-ipv6-special-registry/
	set reserved_ip6 {
		type ipv6_addr
		flags interval
		elements = {
			::/128,             # Unspecified Address (RFC 4291)
			::1/128,            # Loopback Address (RFC 4291)
			::ffff:0:0/96,      # IPv4-mapped Address (RFC 4291)
			64:ff9b::/96,       # IPv4-IPv6 Translation (RFC 6052)
			64:ff9b:1::/48,     # IPv4-IPv6 Translation (RFC 8215)
			100::/64,           # Discard-Only Address Block (RFC 6666)
			2001::/32,          # TEREDO (RFC 4380)
			2001:20::/28,       # ORCHIDv2 (RFC 7343)
			2001:db8::/32,      # Documentation (RFC 3849)
			2002::/16,          # 6to4 (RFC 3056, deprecated)
			fd00::/8,           # Unique Local Addresses (RFC 4193), excluding fc00::/18 (sing-box fakeip)
			fe80::/10,          # Link-Local Unicast (RFC 4291)
			ff00::/8,           # Multicast (RFC 4291)
		}
	}

{% if sing_box_tproxy_nftables_custom_bypassed_ip6 | default([], true) | length > 0 %}
	# Custom bypassed addresses (user-defined)
	# Add your custom bypass rules here
	set custom_bypassed_ip6 {
		type ipv6_addr
		flags interval
		elements = {
{% for ip in sing_box_tproxy_nftables_custom_bypassed_ip6 %}
			{{ ip }},
{% endfor %}
		}
	}

{% endif %}
{% endif %}
{% if sing_box_tproxy_nftables_flow_offload %}
	flowtable bypass_ft {
		hook ingress priority 0
		devices = { {{ sing_box_tproxy_nftables_flow_offload_interfaces | join(', ') }} }
	}

{% endif %}
	chain prerouting_tproxy {
		type filter hook prerouting priority mangle; policy accept;

		# DNS Transparent Proxy
		meta l4proto { tcp, udp } th dport 53 tproxy to :$TPROXY_PORT accept comment "DNS Transparent Proxy"

		# Reject direct access to tproxy port to prevent loops
		fib daddr type local meta l4proto { tcp, udp } \
			th dport $TPROXY_PORT reject with icmpx type host-unreachable comment "Reject direct access to tproxy port to prevent loops"

		# Bypass local packets
		fib daddr type local accept comment "Bypass local packets"

		# Bypass reserved addresses
		ip daddr @reserved_ip4 accept comment "Bypass reserved addresses"

{% if sing_box_tproxy_nftables_custom_bypassed_ip4 | default([], true) | length > 0 %}
		# Bypass custom addresses
		ip daddr @custom_bypassed_ip4 accept comment "Bypass custom addresses"

{% endif %}
{% if _sing_box_enable_ipv6 %}
		# Bypass reserved addresses (IPv6)
		ip6 daddr @reserved_ip6 accept comment "Bypass reserved addresses (IPv6)"

{% if sing_box_tproxy_nftables_custom_bypassed_ip6 | default([], true) | length > 0 %}
		# Bypass custom addresses (IPv6)
		ip6 daddr @custom_bypassed_ip6 accept comment "Bypass custom addresses (IPv6)"

{% endif %}
{% endif %}
		# Bypass established transparent proxy connections
		meta l4proto tcp socket transparent 1 meta mark set $PROXY_MARK accept comment "Bypass established transparent proxy connections"

		# Redirect the remaining packets to the TPROXY_PORT
		meta l4proto { tcp, udp } counter tproxy to :$TPROXY_PORT meta mark set $PROXY_MARK comment "Redirect the remaining packets to the TPROXY_PORT"
	}

{% if sing_box_tproxy_nftables_flow_offload %}
	chain forward_flowtable {
		type filter hook forward priority 0; policy accept;
		counter

		# Flow Offloading - Only accelerate reserved IPs and custom bypassed IPs
		ip daddr @reserved_ip4 ct state new flow offload @bypass_ft comment "flowtable offload for reserved IPs"
{% if sing_box_tproxy_nftables_custom_bypassed_ip4 | default([], true) | length > 0 %}
		ip daddr @custom_bypassed_ip4 ct state new flow offload @bypass_ft comment "flowtable offload for custom bypassed IPs"

{% endif %}
{% if _sing_box_enable_ipv6 %}
		ip daddr @reserved_ip6 ct state new flow offload @bypass_ft comment "flowtable offload for reserved IPs"
{% if sing_box_tproxy_nftables_custom_bypassed_ip6 | default([], true) | length > 0 %}
		ip daddr @custom_bypassed_ip6 ct state new flow offload @bypass_ft comment "flowtable offload for custom bypassed IPs"

{% endif %}
{% endif %}
	}

{% endif %}
	chain output_tproxy {
		type route hook output priority mangle; policy accept;

		# Exclude non-exit interface packets
		oifname != $INTERFACE accept comment "Exclude non-exit interface packets"

{% if _sing_box_enable_ipv6 %}
		# Exclude non-exit interface packets (IPv6)
		meta nfproto ipv6 oifname != $INTERFACE6 accept comment "Exclude non-exit interface packets (IPv6)"

{% endif %}
		# Mark PROXY user process packets
		meta skuid $PROXY_UID meta skgid $PROXY_GID \
			meta mark set $ROUTE_DEFAULT_MARK accept comment "Mark PROXY user process packets"

		# Bypass marked packets
		meta mark $ROUTE_DEFAULT_MARK accept comment "Bypass marked packets"

		# Reroute DNS
		meta l4proto { tcp, udp } th dport 53 meta mark set $PROXY_MARK accept comment "Reroute DNS"

		# Bypass NetBIOS
		udp dport { netbios-ns, netbios-dgm, netbios-ssn, microsoft-ds } accept comment "Bypass NetBIOS"

		# Bypass local packets
		fib daddr type local accept comment "Bypass local packets"

		# Bypass reserved addresses
		ip daddr @reserved_ip4 accept comment "Bypass reserved addresses"

{% if sing_box_tproxy_nftables_custom_bypassed_ip4 | default([], true) | length > 0 %}
		# Bypass custom addresses
		ip daddr @custom_bypassed_ip4 accept comment "Bypass custom addresses"

{% endif %}
{% if _sing_box_enable_ipv6 %}
		# Bypass reserved addresses (IPv6)
		ip6 daddr @reserved_ip6 accept comment "Bypass reserved addresses (IPv6)"

{% if sing_box_tproxy_nftables_custom_bypassed_ip6 | default([], true) | length > 0 %}
		# Bypass custom addresses (IPv6)
		ip6 daddr @custom_bypassed_ip6 accept comment "Bypass custom addresses (IPv6)"

{% endif %}
{% endif %}
		# Set PROXY_MARK for other packets
		meta l4proto { tcp, udp } counter meta mark set $PROXY_MARK comment "Set PROXY_MARK for other packets"
	}
}
