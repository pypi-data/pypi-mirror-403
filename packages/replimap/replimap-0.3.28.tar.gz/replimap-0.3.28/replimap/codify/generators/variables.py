"""
Variables Generator - Generate variables.tf with extracted secrets.

Creates Terraform variable definitions for:
- Extracted sensitive values (passwords, API keys, etc.)
- Common configuration variables
"""

from __future__ import annotations

import logging
from pathlib import Path
from typing import Any

logger = logging.getLogger(__name__)


class VariablesGenerator:
    """
    Generate variables.tf with variable definitions.

    Creates properly typed variable definitions with:
    - Sensitive flag for secrets
    - Descriptions for clarity
    - No default values for sensitive variables
    """

    def generate(
        self,
        variables: list[dict[str, Any]],
        output_dir: Path,
        region: str,
    ) -> Path:
        """
        Generate variables.tf.

        Args:
            variables: List of extracted variable definitions
            output_dir: Directory to write the file
            region: AWS region for default

        Returns:
            Path to generated file
        """
        lines = [
            "# Generated by RepliMap Codify",
            "# Variable Definitions",
            "",
            "# =============================================================================",
            "# Common Variables",
            "# =============================================================================",
            "",
            'variable "aws_region" {',
            '  description = "AWS region for deployment"',
            "  type        = string",
            f'  default     = "{region}"',
            "}",
            "",
        ]

        # Add extracted sensitive variables
        sensitive_vars = [v for v in variables if v.get("sensitive")]
        if sensitive_vars:
            lines.extend(
                [
                    "# =============================================================================",
                    "# Sensitive Variables (Extracted by Codify)",
                    "# =============================================================================",
                    "#",
                    "# These values were detected as sensitive and extracted from resource configs.",
                    "# Provide values via:",
                    "#   - secrets.tfvars file (don't commit to git!)",
                    "#   - Environment variables: TF_VAR_<name>",
                    "#   - Command line: -var='name=value'",
                    "#",
                    "",
                ]
            )

            for var in sensitive_vars:
                var_name = var.get("name", "unknown")
                var_type = var.get("type", "string")
                description = var.get("description", f"Sensitive value for {var_name}")

                lines.extend(
                    [
                        f'variable "{var_name}" {{',
                        f'  description = "{description}"',
                        f"  type        = {var_type}",
                        "  sensitive   = true",
                        "  # No default - must be provided via tfvars or environment",
                        "}",
                        "",
                    ]
                )

        # Add non-sensitive extracted variables
        non_sensitive_vars = [v for v in variables if not v.get("sensitive")]
        if non_sensitive_vars:
            lines.extend(
                [
                    "# =============================================================================",
                    "# Other Extracted Variables",
                    "# =============================================================================",
                    "",
                ]
            )

            for var in non_sensitive_vars:
                var_name = var.get("name", "unknown")
                var_type = var.get("type", "string")
                description = var.get("description", f"Variable {var_name}")
                default = var.get("default")

                lines.extend(
                    [
                        f'variable "{var_name}" {{',
                        f'  description = "{description}"',
                        f"  type        = {var_type}",
                    ]
                )

                if default is not None:
                    if isinstance(default, str):
                        lines.append(f'  default     = "{default}"')
                    elif isinstance(default, bool):
                        lines.append(f"  default     = {str(default).lower()}")
                    else:
                        lines.append(f"  default     = {default}")

                lines.extend(
                    [
                        "}",
                        "",
                    ]
                )

        file_path = output_dir / "variables.tf"
        file_path.write_text("\n".join(lines))

        logger.debug(f"Generated variables.tf with {len(variables)} variables")
        return file_path
