"""
README Generator - Generate dynamic operation guide.

Creates README.md with:
- Summary statistics
- Safety notes about lifecycle protection
- Step-by-step instructions
- File listing
"""

from __future__ import annotations

import logging
from pathlib import Path
from typing import Any

logger = logging.getLogger(__name__)


class ReadmeGenerator:
    """
    Generate README.md with operation guide.

    Creates a dynamic README based on what was generated,
    including appropriate instructions for the import method used.
    """

    def generate(
        self,
        output_dir: Path,
        stats: dict[str, Any],
        use_import_blocks: bool = True,
    ) -> Path:
        """
        Generate README.md.

        Args:
            output_dir: Directory to write the file
            stats: Statistics about generated code
            use_import_blocks: Whether imports.tf or imports.sh was generated

        Returns:
            Path to generated file
        """
        resource_count = stats.get("total_resources", 0)
        protected_count = stats.get("protected_resources", 0)
        variables_count = stats.get("extracted_variables", 0)
        region = stats.get("region", "us-east-1")

        import_method = "imports.tf" if use_import_blocks else "imports.sh"

        if use_import_blocks:
            import_instructions = self._get_import_tf_instructions()
        else:
            import_instructions = self._get_import_sh_instructions()

        content = f"""# Infrastructure Code

Generated by **RepliMap Codify v4.1**

## Summary

| Metric | Value |
|--------|-------|
| Total Resources | {resource_count} |
| Protected Resources | {protected_count} |
| Extracted Variables | {variables_count} |
| Region | {region} |
| Import Method | {import_method} |

## ⚠️ Important Safety Notes

This code includes **lifecycle protection** for critical resources (RDS, S3, DynamoDB, etc.):

```hcl
lifecycle {{
  prevent_destroy = true
}}
```

This prevents accidental deletion during the adoption phase. Only remove this
block after verifying the import is correct and you understand the implications.

## Next Steps

### 1. Initialize Terraform

```bash
terraform init
```

{import_instructions}

## Sensitive Values

{self._get_sensitive_instructions(variables_count)}

## Files

```
.
├── backend.tf              # Provider and backend configuration
├── data.tf                 # Data sources (AMIs, etc.) - if applicable
├── vpc.tf                  # VPC and subnets
├── networking.tf           # Route tables, gateways
├── security_groups.tf      # Security group definitions
├── security_group_rules.tf # Standalone SG rules
├── ec2.tf                  # EC2 instances
├── rds.tf                  # RDS databases (protected)
├── s3.tf                   # S3 buckets (protected)
├── iam_roles.tf            # IAM roles
├── iam_attachments.tf      # Policy attachments (standalone)
├── iam_policies.tf         # Inline policies (converted)
├── variables.tf            # Variable definitions
├── secrets.tfvars.example  # Template for secrets
├── {import_method.ljust(20)} # Import commands
└── README.md               # This file
```

## Troubleshooting

### Import shows "changes"

If `terraform plan` shows changes after import:

1. Review the differences carefully
2. Some drift is expected (e.g., default values)
3. Apply the changes if they're acceptable
4. File an issue if significant drift occurs

### Lifecycle protection blocks destroy

If you need to destroy a protected resource:

1. Edit the resource block
2. Remove or comment out the `lifecycle {{ prevent_destroy = true }}` block
3. Run `terraform apply` to update state
4. Now you can destroy the resource

### Missing credentials

If terraform plan fails with auth errors:

1. Verify AWS credentials: `aws sts get-caller-identity`
2. Check the region matches: `aws configure get region`
3. Ensure you have necessary IAM permissions

## Support

For issues with generated code, please check:
1. AWS credentials are configured correctly
2. All secrets in `secrets.tfvars` are filled in
3. No manual changes were made to imported resources

---
*Generated by RepliMap v4.1 | https://replimap.io*
"""

        file_path = output_dir / "README.md"
        file_path.write_text(content)

        logger.debug("Generated README.md")
        return file_path

    def _get_import_tf_instructions(self) -> str:
        """Get instructions for import blocks."""
        return """### 2. Validate Import (Crucial!)

Since `imports.tf` with Terraform 1.5+ import blocks was generated,
run the following to verify the generated code matches your live resources:

```bash
terraform plan
```

**Success Criteria:** You should see something like:

```
Plan: X to import, 0 to add, 0 to change, 0 to destroy.
```

If you see "changes", review them carefully before proceeding.

### 3. Apply Import

```bash
terraform apply
```

After successful import, you can optionally remove `imports.tf`:

```bash
rm imports.tf
terraform plan  # Should show: No changes
```"""

    def _get_import_sh_instructions(self) -> str:
        """Get instructions for import script."""
        return """### 2. Run Import Script

Since `imports.sh` was generated, make it executable and run:

```bash
chmod +x imports.sh
./imports.sh
```

Review any errors and fix the HCL if needed.

### 3. Verify State

```bash
terraform plan
```

**Success Criteria:** "No changes. Your infrastructure matches the configuration."

If you see changes, review them and apply if acceptable."""

    def _get_sensitive_instructions(self, count: int) -> str:
        """Get instructions for sensitive values."""
        if count == 0:
            return "No sensitive values were extracted."

        return f"""{count} sensitive value(s) were extracted to `variables.tf`.

**Before running terraform:**

1. Copy the template:
   ```bash
   cp secrets.tfvars.example secrets.tfvars
   ```

2. Edit `secrets.tfvars` with actual values

3. Add to `.gitignore`:
   ```bash
   echo "secrets.tfvars" >> .gitignore
   ```

4. Run terraform with the secrets file:
   ```bash
   terraform plan -var-file=secrets.tfvars
   terraform apply -var-file=secrets.tfvars
   ```"""
