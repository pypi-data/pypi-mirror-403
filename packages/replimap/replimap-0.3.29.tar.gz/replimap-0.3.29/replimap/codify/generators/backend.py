"""
Backend Generator - Generate backend.tf with configuration hints.

Generates Terraform backend configuration appropriate for the use case:
- Local backend for individual use
- S3 backend hints for team collaboration
"""

from __future__ import annotations

import logging
from pathlib import Path

logger = logging.getLogger(__name__)


class BackendGenerator:
    """
    Generate Terraform backend configuration.

    Creates backend.tf with appropriate configuration for
    brownfield infrastructure adoption.
    """

    def generate(
        self,
        output_dir: Path,
        region: str,
        use_s3: bool = False,
        s3_bucket: str | None = None,
    ) -> Path:
        """
        Generate backend.tf.

        Args:
            output_dir: Directory to write the file
            region: AWS region for provider
            use_s3: Whether to configure S3 backend
            s3_bucket: S3 bucket name for remote state

        Returns:
            Path to generated file
        """
        if use_s3 and s3_bucket:
            content = self._generate_s3_backend(region, s3_bucket)
        else:
            content = self._generate_local_backend(region)

        file_path = output_dir / "backend.tf"
        file_path.write_text(content)

        logger.debug("Generated backend.tf")
        return file_path

    def _generate_local_backend(self, region: str) -> str:
        """Generate local backend configuration."""
        return f'''# Generated by RepliMap Codify
# Terraform Backend and Provider Configuration

terraform {{
  # Local backend (default)
  # For team collaboration, uncomment and configure S3 backend:
  # backend "s3" {{
  #   bucket = "my-terraform-state-ACCOUNT_ID"
  #   key    = "replimap-import/terraform.tfstate"
  #   region = "{region}"
  #   encrypt = true
  # }}

  backend "local" {{
    path = "terraform.tfstate"
  }}

  required_version = ">= 1.5.0"

  required_providers {{
    aws = {{
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }}
  }}
}}

provider "aws" {{
  region = "{region}"

  default_tags {{
    tags = {{
      ManagedBy = "Terraform"
      Source    = "RepliMap"
    }}
  }}
}}
'''

    def _generate_s3_backend(self, region: str, bucket: str) -> str:
        """Generate S3 backend configuration."""
        return f'''# Generated by RepliMap Codify
# Terraform Backend and Provider Configuration

terraform {{
  backend "s3" {{
    bucket  = "{bucket}"
    key     = "replimap-import/terraform.tfstate"
    region  = "{region}"
    encrypt = true
    # Uncomment for state locking:
    # dynamodb_table = "terraform-locks"
  }}

  required_version = ">= 1.5.0"

  required_providers {{
    aws = {{
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }}
  }}
}}

provider "aws" {{
  region = "{region}"

  default_tags {{
    tags = {{
      ManagedBy = "Terraform"
      Source    = "RepliMap"
    }}
  }}
}}
'''
