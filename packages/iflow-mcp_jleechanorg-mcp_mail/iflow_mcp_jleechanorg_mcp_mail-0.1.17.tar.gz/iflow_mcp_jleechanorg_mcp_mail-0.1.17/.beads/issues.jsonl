{"id":"MCP-2pj","content_hash":"9a50e278136173548c86a2fa974ce3da079d45b642b0d7d85cd3afeff3620046","title":"Fix reply_message to work without valid project_key","description":"reply_message is part of the global agent messaging system but requires valid project_key by calling _get_project_by_identifier(project_key) at line 4452.\n\nFIX: Look up sender agent first using _get_agent_by_name(sender_name), then use agent.project_id for message routing.\n\nREFERENCE: mark_message_read and acknowledge_message correctly skip _get_project_by_identifier()\n\nPARENT: MCP-5pi","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-28T23:48:04.864939-05:00","updated_at":"2025-12-28T23:51:25.987022-05:00","closed_at":"2025-12-28T23:51:25.987022-05:00","source_repo":".","labels":["medium","project_key_violation"],"dependencies":[{"issue_id":"MCP-2pj","depends_on_id":"MCP-5pi","type":"blocks","created_at":"2025-12-28T23:48:04.865611-05:00","created_by":"daemon"}]}
{"id":"MCP-5h4","content_hash":"058edcab16c474ffe9114edf87e2d2c5ba0993ee2557bd11f5f280506fb4edfa","title":"Slack mirror subject fallback for empty messages","description":"Empty/whitespace Slack messages produce blank subjects (e.g., \"[Slack] \"). Add fallback subject (e.g., \"Empty message\") after trimming whitespace.","status":"closed","priority":3,"issue_type":"bug","created_at":"2025-11-28T23:34:52.92299-08:00","updated_at":"2025-11-29T00:08:26.616267-08:00","closed_at":"2025-11-29T00:08:26.616267-08:00","source_repo":"."}
{"id":"MCP-5pi","content_hash":"3d2db82453977e87ddc0f192687b0560f3058f9359659cc76035cff464af8535","title":"Fix fetch_inbox and other tools to work without project_key","description":"Agents are globally unique but fetch_inbox and potentially other tools still fail when project_key doesn't exist. This violates the design principle that \"agent names are globally unique and project_key is informational only.\"\n\nUser report: \"I keep getting constant errors requiring a project key\"\n\nExample error from Codex CLI:\n\"No inbox yet. The fetch failed because that project key isn't registered in MCP Mail.\"\n\nRoot cause: fetch_inbox calls _get_project_by_identifier(project_key) which raises NoResultFound if project doesn't exist, even though agents are global.","design":"Phase 1 - Investigation (no coding):\n1. Search all MCP tools that accept project_key parameter\n2. Identify which ones incorrectly require project to exist\n3. Analyze dependencies - does _list_inbox actually need Project object?\n4. Document all affected tools and their usage patterns\n\nPhase 2 - Fix Strategy:\n1. Make project_key truly optional - handle NoResultFound gracefully\n2. Either use agent's associated project OR skip project-specific logic\n3. Update all affected tools consistently\n4. Add integration tests for agents without project_key\n\nPhase 3 - Prevention:\n1. Create linting rule or test that detects project_key requirements\n2. Add documentation standards for tool parameters\n3. CI checks for \"project_key is informational only\" contract","acceptance_criteria":"- fetch_inbox works when project_key doesn't exist\n- All tools with \"project_key is informational only\" documentation actually work without registered project\n- Integration test: register agent without project_key, then fetch_inbox succeeds\n- CI lint check catches future violations of \"informational only\" contract\n- Documentation audit completed: all tool docstrings accurate","notes":"Fixes implemented in PR #151: https://github.com/jleechanorg/mcp_mail/pull/151\n\nAll 5 critical violations fixed:\n- MCP-iu3: fetch_inbox \u2705\n- MCP-uxk: send_message \u2705\n- MCP-c25: whois \u2705\n- MCP-915: delete_agent \u2705\n- MCP-2pj: reply_message \u2705\n\nReady for review and merge.\nAudit report: docs/mcp_mail_project_key_violations.md","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-28T23:21:47.564082-05:00","updated_at":"2025-12-28T23:54:23.566243-05:00","source_repo":"."}
{"id":"MCP-6dw","content_hash":"4d40b8fc0030078fd453c44e9060eeca31502a8d8f927ca37e1735d1c6633d51","title":"BUG: MCP send_message resolves recipients across projects with same name","description":"During REAL_CLAUDE_MULTI_AGENT_TEST via Codex CLI, send_message routed messages to agents with the same name in a different project. SQLite for project /tmp/real_codex_test_project_20251129_005916 (project_id=8) shows recipients with agent_ids 16/17 (from project_id=6) instead of current agents 22/23/24. fetch_inbox for new agents misses messages. Need to fix recipient resolution logic to respect project scoping or clarify the intended global scoping and enforce consistent delivery.","status":"open","priority":2,"issue_type":"bug","created_at":"2025-11-29T01:14:37.492053-08:00","updated_at":"2025-11-29T01:14:37.492053-08:00","source_repo":"."}
{"id":"MCP-6fi","content_hash":"b255ccdbaa54ac2ea18d61e2a97a0ca17cbc964cab5dd0f92092ce0c12f7b3c0","title":"Slack body truncation exceeds limit when adding suffix","description":"When truncating Slack body to 3000 chars, code slices 3000 then appends a 26-char suffix, yielding up to 3026 chars. Slack section text limit can be exceeded. Adjust slice to account for suffix length.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-28T23:34:55.619134-08:00","updated_at":"2025-11-29T00:08:29.723884-08:00","closed_at":"2025-11-29T00:08:29.723884-08:00","source_repo":"."}
{"id":"MCP-7uq","content_hash":"fc4b93f1ad01578822a4f5c4fda1579a6f9cc99b2711c1153855720099f689c9","title":"Slack thread replies route to default project instead of original message's project","description":"When a user replies in a Slack thread to an MCP-originated message, the reply goes to the default `slack-sync` project (configured via `sync_project_name`) instead of the project that owns the original MCP message.\n\nExpected behavior: If MCP message #181 in project \"my-app\" creates a Slack thread, and a user replies in that thread, the reply should be ingested as a message in project \"my-app\" with thread_id linking to message #181.\n\nCurrent behavior: The reply goes to \"slack-sync\" project regardless of the original message's project.\n\nRoot cause: The webhook handler in http.py `_ingest_slack_bridge_message()` uses `settings.slack.sync_project_name` to determine the target project, rather than looking up the original MCP message's project via the thread mapping.\n\nFix approach:\n1. When processing a threaded Slack message (has `thread_ts`), look up the reverse thread mapping to find the original MCP message ID\n2. Query that message's project_id\n3. Use that project for the reply instead of the default sync project","acceptance_criteria":"1. Slack thread replies are routed to the same project as the original MCP message\n2. Thread mapping correctly links the reply to the original message\n3. Non-threaded Slack messages still go to the default sync project\n4. Test case covering cross-project thread reply scenario","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-17T23:02:43.277009-08:00","updated_at":"2025-12-17T23:10:32.34406-08:00","closed_at":"2025-12-17T23:10:32.34406-08:00","source_repo":"."}
{"id":"MCP-915","content_hash":"a904585d98e3b5b8f9837de20a62a4ad3d513e63b770ddd71501ecde07468680","title":"Fix delete_agent to work with global agent namespace","description":"delete_agent requires valid project_key by calling _get_project_by_identifier(project_key) at line 3705. In a global agent namespace, agents shouldn't be scoped to projects for deletion.\n\nFIX: Look up agent globally using _get_agent_by_name(agent_name), then delete the agent regardless of project_key validity.\n\nREFERENCE: mark_message_read and acknowledge_message correctly skip _get_project_by_identifier()\n\nPARENT: MCP-5pi","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-28T23:48:04.352337-05:00","updated_at":"2025-12-28T23:51:25.497538-05:00","closed_at":"2025-12-28T23:51:25.497538-05:00","source_repo":".","labels":["high","project_key_violation"],"dependencies":[{"issue_id":"MCP-915","depends_on_id":"MCP-5pi","type":"blocks","created_at":"2025-12-28T23:48:04.353117-05:00","created_by":"daemon"}]}
{"id":"MCP-b5g","content_hash":"ce7900dd5c6567537258d5e26c50fd51657354c1aa1f79d303362d3bd028b017","title":"Slack integration tests bypass /slack/events webhook path","description":"Current Slack integration tests write directly to .mcp_mail/messages.jsonl rather than POSTing to /slack/events with signatures. They do not exercise webhook verification, DB message creation, thread mapping, or error handling. Add true webhook integration tests (or clearly rename scope) that hit /slack/events with signed payloads and assert DB/archive/thread behavior.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-28T23:34:59.644572-08:00","updated_at":"2025-11-29T00:08:34.271831-08:00","closed_at":"2025-11-29T00:08:34.271831-08:00","source_repo":"."}
{"id":"MCP-b9x","content_hash":"bd251199fb6a42c8273e07177ea766ae157b5957e0237a2710edf1925f5b1c4a","title":"Extended MCP tools not registered in app -> ToolError Unknown tool create_file_reservation","description":"E2E workflow tests report fastmcp.exceptions.ToolError: Unknown tool: create_file_reservation (and other extended tools like acquire_build_slot). Regression likely from refactor/cherry-pick: tools exist in _EXTENDED_TOOL_REGISTRY but are not registered on the FastMCP server in src/mcp_agent_mail/app.py. Result: build slots/file reservations unavailable; tests fail (tests/test_e2e_workflows.py). Need to rewire registration/decorators so all extended tools are exposed.","acceptance_criteria":"All extended tools in _EXTENDED_TOOL_REGISTRY are registered and callable via MCP; e2e workflow tests pass without Unknown tool errors; manual invocation of create_file_reservation succeeds.","notes":"Confirmed regression: EXTENDED_TOOLS contains file_reservation_paths but tests call create_file_reservation. _EXTENDED_TOOL_REGISTRY lacks create_file_reservation alias, so FastMCP raises Unknown tool. Needs alias or exposure change so e2e workflows pass.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-17T22:09:54.114393-08:00","updated_at":"2025-12-17T23:43:53.279072-08:00","closed_at":"2025-12-17T23:43:53.279072-08:00","source_repo":"."}
{"id":"MCP-c25","content_hash":"9074a4d031c20aac273f5883eb8957ac4a91a61de550e0226141714c0b0aaa26","title":"Fix whois to not require valid project_key","description":"whois documentation claims \"Agent names are GLOBALLY UNIQUE across all projects\" but implementation requires valid project_key by calling _get_project_by_identifier(project_key) at line 3762, which fails when project doesn't exist.\n\nFIX: Look up agent globally using _get_agent_by_name(agent_name) without requiring project_key validation. Only use project_key for logging/telemetry if provided.\n\nREFERENCE: mark_message_read and acknowledge_message correctly skip _get_project_by_identifier()\n\nPARENT: MCP-5pi","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-28T23:48:03.810885-05:00","updated_at":"2025-12-28T23:51:25.044941-05:00","closed_at":"2025-12-28T23:51:25.044941-05:00","source_repo":".","labels":["critical","project_key_violation"],"dependencies":[{"issue_id":"MCP-c25","depends_on_id":"MCP-5pi","type":"blocks","created_at":"2025-12-28T23:48:03.811632-05:00","created_by":"daemon"}]}
{"id":"MCP-e1b","content_hash":"d2d77c10269ae4647cb929e974a42275ef67f45696ce73135549b4f526239727","title":"Guard pre-commit hook not blocking violations in e2e Guard lifecycle test","description":"tests/test_e2e_workflows.py::test_e2e_guard_lifecycle now fails because the guard pre-commit hook exits 0 (allows commit) instead of 1 when a violation is present. Likely regression in guard.py handling of WORKTREES_ENABLED/worktree path resolution or staged diff parsing after recent refactors. Need to reproduce under test harness and restore failure behavior when conflicts detected.","acceptance_criteria":"Guard lifecycle e2e test passes; guard pre-commit hook returns non-zero on violations; manual simulation confirms block when staged conflicts exist; no false positives in clean state.","notes":"Not re-run today, but prior report still likely: guard pre-commit hook returns 0 in e2e guard lifecycle test. Needs reproduction and fix in guard.py (worktree/env handling or staged diff parsing).","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-17T22:10:02.017067-08:00","updated_at":"2025-12-17T23:43:56.845669-08:00","closed_at":"2025-12-17T23:43:56.845669-08:00","source_repo":"."}
{"id":"MCP-fq5","content_hash":"5c31335d231e5c83beeae07b70e4120c5a1d8cee207a5df85c33421984def7f2","title":"CRITICAL: Database session bug in _ensure_project() blocks agent registration","description":"Location: app.py:674-702 in _ensure_project()\n\nSymptom: InvalidRequestError: Could not refresh instance\n\nRoot Cause: _ensure_project() opens a database session and calls _ensure_global_inbox_agent(project) which opens a NESTED session. The project object becomes detached from the inner session causing SQLAlchemy errors.\n\nImpact: PRODUCTION BLOCKING - Prevents agent registration in multi-agent scenarios\n\nIntroduced: Commit 8ec673f (2025-11-09) 'Add global inbox with TTL auto-deletion'\n\nEvidence: Test 3 Agent 2 failure in /tmp/real_claude_multiagent_20251118_193652/outputs/agent2_output.txt\n\nFix Required:\n1. Pass session to _ensure_global_inbox_agent() OR\n2. Accept project_id instead of project object to avoid detached instance\n\nPriority: URGENT - Blocks Test 3 completion and production use","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-18T20:20:22.634052-08:00","updated_at":"2025-11-18T20:38:11.023347-08:00","closed_at":"2025-11-18T20:38:11.023347-08:00","source_repo":".","labels":["bug","critical","production-blocking"]}
{"id":"MCP-hny","content_hash":"23b35e4e240a20c83c5a9b857ea027f14f3433e6f0cd0f507fad108ef826c208","title":"Resolve ty type-check warnings (230 diagnostics)","description":"`uvx ty check` reports ~230 warnings across app + tests (SQLAlchemy typing, test stubs, etc.). These appear pre-existing and unrelated to current PR/test changes. Track cleanup separately.","acceptance_criteria":"- `uvx ty check` returns 0 diagnostics (or only approved baseline).\n- Any fixes are consistent with SQLModel/SQLAlchemy async usage guidelines.\n- Tests still pass after changes.","status":"open","priority":3,"issue_type":"chore","created_at":"2025-12-20T16:38:40.815247-08:00","updated_at":"2025-12-20T16:38:40.815247-08:00","source_repo":"."}
{"id":"MCP-iu3","content_hash":"465d5640f00bb551407a504945aedb9ad93fcd956e26a43b9bf2894582815ef5","title":"Fix fetch_inbox to not require valid project_key","description":"fetch_inbox documentation claims \"project_key is informational only and does not affect message retrieval\" but implementation calls _get_project_by_identifier(project_key) at line 4655, which raises NoResultFound when project doesn't exist.\n\nFIX: Look up agent first using _get_agent_by_name(agent_name), then use agent.project_id instead of project_key lookup.\n\nREFERENCE: mark_message_read and acknowledge_message correctly skip _get_project_by_identifier()\n\nPARENT: MCP-5pi","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-28T23:48:02.72017-05:00","updated_at":"2025-12-28T23:51:24.138822-05:00","closed_at":"2025-12-28T23:51:24.138822-05:00","source_repo":".","labels":["critical","project_key_violation"],"dependencies":[{"issue_id":"MCP-iu3","depends_on_id":"MCP-5pi","type":"blocks","created_at":"2025-12-28T23:48:02.72154-05:00","created_by":"daemon"}]}
{"id":"MCP-ods","content_hash":"c6dbe0ad14c4640c69a28f652cfffce5e95f7459390fe36296730ed3c326d453","title":"Inbound Slack thread mapping not persisted to SlackClient","description":"Webhook handler creates MCP messages with thread_id like slack_{channel}_{thread_ts} but does not call SlackClient.map_thread(), so outbound replies won\u2019t land in the original Slack thread. Add mapping when processing inbound Slack events.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-28T23:34:49.47293-08:00","updated_at":"2025-11-29T00:08:22.795967-08:00","closed_at":"2025-11-29T00:08:22.795967-08:00","source_repo":"."}
{"id":"MCP-szt","content_hash":"538060f0c47013c56ec4a90cdeb9283af3ea7e75ffb2b0063fdaa1a46b6b9cb1","title":"SlackClient methods unreachable (mis-indented in slack_integration.py)","description":"SlackClient\u2019s core methods (_check_client, _call_api, post_message, upload_file, add_reaction, list_channels, get_channel_info, get_permalink, map_thread, get_slack_thread, get_mcp_thread_id, verify_signature) are currently nested inside mirror_message_to_slack after a return. They\u2019re unreachable at runtime, so Slack API calls will raise AttributeError. Fix by re-indenting methods into the SlackClient class and ensuring imports/usage are correct.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-28T23:34:45.970741-08:00","updated_at":"2025-11-29T00:08:19.552134-08:00","closed_at":"2025-11-29T00:08:19.552134-08:00","source_repo":"."}
{"id":"MCP-uxk","content_hash":"8ba2aa8d747f8e589a33d09ed0f9c53cb78724741e6ee1dd7fad1ed4a79a3556","title":"Fix send_message to not require valid project_key","description":"send_message documentation claims \"project_key is informational only for agent lookup; agents are global\" but implementation calls _get_project_by_identifier(project_key) at line 4036, which can fail when project doesn't exist.\n\nFIX: Look up sender agent first using _get_agent_by_name(sender_name), then use agent.project_id for routing metadata.\n\nREFERENCE: mark_message_read and acknowledge_message correctly skip _get_project_by_identifier()\n\nPARENT: MCP-5pi","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-28T23:48:03.32391-05:00","updated_at":"2025-12-28T23:51:24.589304-05:00","closed_at":"2025-12-28T23:51:24.589304-05:00","source_repo":".","labels":["critical","project_key_violation"],"dependencies":[{"issue_id":"MCP-uxk","depends_on_id":"MCP-5pi","type":"blocks","created_at":"2025-12-28T23:48:03.324783-05:00","created_by":"daemon"}]}
{"id":"MCP-w04","content_hash":"2990aa5882a5dfe48077d0e052756ea3985de9312cf0e0874e82fa664221bee3","title":"Slack webhook ingestion fails when multiple projects receive events (SlackBridge name uniqueness)","description":"Slack Events ingestion now looks up/creates the SlackBridge agent scoped to the resolved project (src/mcp_agent_mail/http.py _ingest_slack_bridge_message). The agents table enforces a global unique index on name (uq_agents_name_ci), so the second project that ingests a Slack event hits IntegrityError UNIQUE constraint failed: index 'uq_agents_name_ci' and the request returns 500. Repro: uv run pytest tests/integration/test_slack_webhook_api.py::test_slack_webhook_records_thread_mapping_for_top_level. Impact: any deployment with Slack enabled for more than one project will break after the first SlackBridge is created; Slack replies never ingested. Likely fixes: revert to global lookup (previous _get_agent_by_name_optional) or use a globally unique sender name (e.g., SlackBridge/<project.slug>) when creating the bridge agent.","acceptance_criteria":"Slack webhook ingestion succeeds across multiple projects without IntegrityError; automated test covering multiple-project Slack ingestion passes; global uniqueness constraint respected.","notes":"Reproduced 2025-12-18 via `uv run pytest tests/integration/test_slack_webhook_api.py::test_slack_webhook_records_thread_mapping_for_top_level`; SlackBridge per-project creation conflicts with global unique index uq_agents_name_ci, causing 500 on second project ingest. Needs global lookup or globally unique bridge name.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-17T22:09:47.758607-08:00","updated_at":"2025-12-17T22:38:00.576745-08:00","closed_at":"2025-12-17T22:38:00.576745-08:00","source_repo":"."}
{"id":"MCP-xr3","content_hash":"50116f6a729bd94c4f5d9b4601d319a66b4374e5c209266a745b87003e5d7637","title":"Build Slack bot integration for MCP Mail (bidirectional)","description":"Implement a Slack app (bot) integration for MCP Mail to support Slack -> MCP ingest and MCP -> Slack messaging.\n\nScope:\n- Use Slack Web API + Events API with bot token and signing secret.\n- Verify Slack requests (signing secret) and handle `message.*` events (channels, groups, im, mpim), including threads via `thread_ts`, mapping to MCP `thread_id`.\n- Outbound: use bot token to post messages and thread replies to Slack channels; plan migration away from incoming webhook.\n- Optional slash command `/mcp-mail` to send MCP messages from Slack with project/thread/recipients.\n- Config: env vars `SLACK_BOT_TOKEN`, `SLACK_SIGNING_SECRET`, channel allowlist, event endpoint URL; support public tunnel (ngrok/Cloudflare) or deployed URL.\n- Tests: integration-style tests for Slack event ingestion and outbound posting (mock Slack API).","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-28T21:43:32.388709-08:00","updated_at":"2025-11-28T21:43:32.388709-08:00","source_repo":"."}
