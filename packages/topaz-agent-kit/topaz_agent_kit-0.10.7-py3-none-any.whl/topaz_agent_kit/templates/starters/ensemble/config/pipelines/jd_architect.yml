# =============================================================================
# PIPELINE CONFIGURATION
# =============================================================================
#
# Pipeline parameters:
# - name (str, required): human-readable pipeline name
# - description (str, required): detailed description of pipeline purpose
#
# =============================================================================

name: "JD Architect"
description: "JD Architect is an end-to-end agentic workflow that generates detailed job descriptions and competitive salary ranges based on job roles. The process starts with a parser agent that extracts structured information from user input, followed by a conditional selection gate for job level if not provided. A research agent then gathers current market data on salaries, skills, and qualifications. An analysis agent synthesizes this research into structured requirements and salary ranges. Finally, a generation agent creates a comprehensive job description in markdown format with embedded salary information."

# =============================================================================
# PIPELINE PATTERN CONFIGURATION
# =============================================================================
#
# Define the execution flow explicitly using one of three constructs:
#   - sequential: run children in order
#   - parallel: run children concurrently (wait_all)
#   - loop: repeat body up to max_iterations
#
# NODES REGISTRY (REQUIRED)
# - nodes (list[object], required)
#   - nodes[].id (str, required): agent identifier
#   - nodes[].config_file (str, required): path to agent configuration file (relative to config/)
#
# PATTERN (REQUIRED)
# - pattern (object, required): one of sequential | parallel | loop
#
# STEP (LEAF)
# - node (str, required): "agent_id"
#
# SEQUENTIAL
# - type: sequential (required)
# - steps: list of (step | pattern) (required, >=1)
#
# PARALLEL
# - type: parallel (required)
# - steps: list of (step | pattern) (required, >=1)
# - semantics: wait_all; first error fails the group (MVP defaults)
#
# LOOP
# - type: loop (required)
# - body: (step | sequential | parallel) (required)
# - max_iterations: int (required, >=1)
#
# NOTES
# - Context model unchanged: each node writes to context.upstream[node_id]
# - Gates and outputs are configured in their respective sections below
#
# =============================================================================

nodes:
  - id: jd_architect_parser
    config_file: "agents/jd_architect_parser.yml"
  - id: jd_architect_researcher
    config_file: "agents/jd_architect_researcher.yml"
  - id: jd_architect_analyzer
    config_file: "agents/jd_architect_analyzer.yml"
  - id: jd_architect_generator
    config_file: "agents/jd_architect_generator.yml"

pattern:
  type: sequential
  name: "Job Description Generation Flow"
  description: |
    ## Job Description Generation Flow
    
    This sequential pattern orchestrates the complete job description generation workflow:
    1. **Parser** extracts structured information from user input (role, location, etc.)
    2. **Job Level Selection Gate** (conditional) allows user to select job level if not provided
    3. **Researcher** gathers current market data on salaries, skills, and qualifications
    4. **Analyzer** synthesizes research into structured requirements and salary ranges
    5. **Generator** creates a comprehensive job description in markdown format
    
    The workflow ensures job descriptions are based on current market data and include competitive salary ranges.
  steps:
    - node: jd_architect_parser
    - gate: jd_architect_job_level_selection
      condition: "jd_architect_parser.job_level is null OR jd_architect_parser.job_level == ''"
      on_entry_level: continue
      on_mid_level: continue
      on_senior_level: continue
    - node: jd_architect_researcher
    - node: jd_architect_analyzer
    - node: jd_architect_generator
# =============================================================================
# HITL SECTION - Human-in-the-loop gates
# =============================================================================
#
# Human-in-the-Loop gates configuration (optional)
# Parameters:
# - gates (list[object], optional): human-in-the-loop pause points
#   - gates[].id (str, required): unique gate id
#   - gates[].type (str, required): "approval" | "input" | "selection"
#   - gates[].title (str, optional): UI title
#   - gates[].description (str, optional): UI description
#   - gates[].fields (list[object], optional): form fields for input gates
#   - gates[].options (list[object], optional): selection options for selection gates
#   - gates[].target_agents (list[str], optional): which agents receive this data
#   - gates[].context_key (str, optional): key to store data in context
#   - gates[].timeout_ms (int, optional): wait timeout; default 300000
#   - gates[].on_timeout (str, optional): "approve" | "reject" | "skip" | "default"
#
# =============================================================================

gates:
  - id: jd_architect_job_level_selection
    type: selection
    title: "Select Job Level"
    description: |
      ## Job Level Selection

      {% if jd_architect_parser.job_role %}
      **Role:** {{ jd_architect_parser.job_role | default('N/A') }}
      {% endif %}
      {% if jd_architect_parser.location %}
      **Location:** {{ jd_architect_parser.location | default('N/A') }}
      {% endif %}

      Select the job level for this position. This helps determine appropriate salary ranges, required experience, and qualification expectations for the job description.

      **Note:** This gate only appears if the job level was not specified in the original request.
    options:
      - value: entry_level
        label: "Entry Level"
        description: "Entry-level position requiring minimal experience (0-2 years)"
      - value: mid_level
        label: "Mid Level"
        description: "Mid-level position requiring moderate experience (3-7 years)"
      - value: senior_level
        label: "Senior Level"
        description: "Senior-level position requiring extensive experience (8+ years)"
    context_key: job_level
    timeout_ms: 60000
    on_timeout: default
    default: mid_level

# =============================================================================
# OUTPUTS SECTION - Intermediate and Final Outputs
# =============================================================================
#
# Output configuration for pipeline results
# Parameters:
# - intermediate (list[object], optional): intermediate outputs during execution
#   - intermediate[].id (str, required): unique output identifier
#   - intermediate[].node (str, required): which node's output to capture
#   - intermediate[].selectors (list[str], required): JSON keys/paths to extract
#   - intermediate[].transform (str, optional): Jinja2 expression for transformation
# - final (object, required): final pipeline output
#   - final.node (str, required): which node's output to use as final result
#   - final.selectors (list[str], required): JSON keys/paths to extract
#   - final.transform (str, optional): Jinja2 expression for transformation
#
# =============================================================================

outputs:
  final:
    node: jd_architect_generator
    selectors:
      - job_description_md
      - error
    transform: "{{ value }}"

