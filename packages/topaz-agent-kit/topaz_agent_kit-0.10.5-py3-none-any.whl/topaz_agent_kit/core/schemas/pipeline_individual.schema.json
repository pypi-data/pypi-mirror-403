{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://topaz.ai/schemas/pipeline_individual.schema.json",
  "type": "object",
  "required": ["name", "description", "nodes", "pattern"],
  "properties": {
    "name": {
      "type": "string",
      "description": "Human-readable pipeline name"
    },
    "description": {
      "type": "string",
      "description": "Detailed description of pipeline purpose"
    },
    "pipeline_dir": {
      "type": "string",
      "description": "Pipeline directory path relative to config/ (added automatically by ConfigurationEngine)"
    },
    "pipelines": {
      "type": "array",
      "description": "Registry of sub-pipelines that can be used as nodes",
      "items": {
        "type": "object",
        "required": ["id", "pipeline_file"],
        "properties": {
          "id": { 
            "type": "string",
            "description": "Pipeline identifier for use in pattern steps"
          },
          "pipeline_file": { 
            "type": "string",
            "description": "Path to pipeline configuration file (relative to config/)"
          }
        },
        "additionalProperties": false
      }
    },
    "nodes": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "config_file"],
        "properties": {
          "id": { "type": "string" },
          "config_file": { "type": "string" }
        },
        "additionalProperties": false
      }
    },
    "pattern": {
      "oneOf": [
        { "$ref": "#/definitions/sequential" },
        { "$ref": "#/definitions/parallel" },
        { "$ref": "#/definitions/loop" },
        { "$ref": "#/definitions/switch" },
        { "$ref": "#/definitions/handoff" },
        { "$ref": "#/definitions/group_chat" }
      ]
    },
    "gates": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique gate identifier"
          },
          "type": {
            "type": "string",
            "enum": ["approval", "input", "selection"],
            "description": "Gate type - approval, input, or selection"
          },
          "title": {
            "type": "string",
            "description": "UI title for the gate"
          },
          "description": {
            "oneOf": [
              {
                "type": "string",
                "description": "UI description for the gate (inline string or Jinja2 template)"
              },
              {
                "type": "object",
                "properties": {
                  "jinja": {
                    "type": "string",
                    "description": "Path to Jinja2 template file relative to config/ directory (e.g., 'hitl/gate_description.jinja')"
                  }
                },
                "required": ["jinja"],
                "additionalProperties": false
              }
            ],
            "description": "UI description for the gate - can be inline string or reference to Jinja2 template file"
          },
          "fields": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "name": { "type": "string" },
                "label": { "type": "string" },
                "type": {
                  "type": "string",
                  "enum": [
                    "text",
                    "textarea",
                    "number",
                    "email",
                    "select",
                    "checkbox",
                    "radio",
                    "date",
                    "time",
                    "url",
                    "file"
                  ]
                },
                "required": { "type": "boolean" },
                "default": { "type": "string" },
                "options": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "value": { "type": "string" },
                      "label": { "type": "string" }
                    },
                    "required": ["value", "label"],
                    "additionalProperties": false
                  }
                },
                "options_source": {
                  "type": "string",
                  "description": "Explicit source path for field options (agent_id.key.path)"
                },
                "validation": {
                  "type": "object",
                  "properties": {
                    "min_length": { "type": "integer", "minimum": 0 },
                    "max_length": { "type": "integer", "minimum": 1 },
                    "min": { "type": "number" },
                    "max": { "type": "number" },
                    "pattern": { "type": "string" },
                    "file_types": {
                      "type": "array",
                      "items": { "type": "string" },
                      "description": "Allowed file extensions for file fields"
                    },
                    "max_size_mb": {
                      "type": "number",
                      "minimum": 0,
                      "description": "Maximum file size in MB for file fields"
                    },
                    "max_files": {
                      "type": "integer",
                      "minimum": 1,
                      "description": "Maximum number of files for file fields"
                    }
                  },
                  "additionalProperties": false
                },
                "condition": {
                  "type": "string",
                  "description": "Optional conditional expression - field is shown only if expression evaluates to true"
                }
              },
              "required": ["name", "label", "type"],
              "allOf": [
                {
                  "if": { "properties": { "type": { "enum": ["select", "checkbox", "radio"] } } },
                  "then": {
                    "not": {
                      "allOf": [
                        { "required": ["options"] },
                        { "required": ["options_source"] }
                      ]
                    }
                  }
                }
              ],
              "additionalProperties": false
            }
          },
          "options": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "value": { "type": "string" },
                "label": { "type": "string" },
                "description": { "type": "string" },
                "condition": { "type": "string", "description": "Optional expression to conditionally show this option" },
                "color": { "type": "string", "description": "Color name for highlighting this option (e.g., 'green', 'red', 'amber')" },
                "badge": { "type": "string", "description": "Badge text to display on this option when it's the default value" }
              },
              "required": ["value", "label"],
              "additionalProperties": false
            },
            "description": "Options for selection gates"
          },
          "options_source": {
            "type": "string",
            "description": "Explicit source path for selection options (agent_id.key.path)"
          },
          "default": {
            "type": ["string", "null"],
            "description": "Default option value for selection gates (null or empty string if no default)"
          },
          "buttons": {
            "type": "object",
            "properties": {
              "continue": {
                "type": "object",
                "properties": {
                  "label": { "type": "string" },
                  "description": { "type": "string" }
                },
                "required": ["label"],
                "additionalProperties": false
              },
              "retry": {
                "type": "object",
                "properties": {
                  "label": { "type": "string" },
                  "description": { "type": "string" }
                },
                "required": ["label"],
                "additionalProperties": false
              },
              "submit": {
                "type": "object",
                "properties": {
                  "label": { "type": "string" },
                  "description": { "type": "string" }
                },
                "required": ["label"],
                "additionalProperties": false
              },
              "cancel": {
                "type": "object",
                "properties": {
                  "label": { "type": "string" },
                  "description": { "type": "string" }
                },
                "required": ["label"],
                "additionalProperties": false
              },
              "approve": {
                "type": "object",
                "properties": {
                  "label": { "type": "string" },
                  "description": { "type": "string" }
                },
                "required": ["label"],
                "additionalProperties": false
              },
              "reject": {
                "type": "object",
                "properties": {
                  "label": { "type": "string" },
                  "description": { "type": "string" }
                },
                "required": ["label"],
                "additionalProperties": false
              }
            },
            "additionalProperties": false,
            "description": "Button configuration for input gates"
          },
          "context_key": {
            "type": "string",
            "description": "Key name for storing HITL data in agent context"
          },
          "context_strategy": {
            "type": "string",
            "enum": ["append"],
            "description": "Optional write strategy for context_key. 'append' appends text to existing value; default is overwrite."
          },
          "preserve_feedback": {
            "type": "boolean",
            "description": "Whether to preserve gate data when retry is triggered (default: true). Set to false for simple retries that don't need feedback (e.g., rate case option regeneration). When true, retried agents can access feedback via context_key (e.g., article_smith research feedback)."
          },
          "timeout_ms": {
            "type": "integer",
            "minimum": 1000,
            "description": "Wait timeout in milliseconds"
          },
          "on_timeout": {
            "type": "string",
            "enum": ["approve", "reject", "skip", "default"],
            "description": "Action to take on timeout"
          },
          "hitl_mode": {
            "type": "string",
            "enum": ["sync", "async"],
            "description": "Override pipeline-level hitl_mode for this specific gate. 'sync' blocks for user response, 'async' queues and continues"
          },
          "priority": {
            "type": "string",
            "enum": ["high", "medium", "low"],
            "default": "medium",
            "description": "Priority for async HITL queue (default: medium)"
          },
          "resume_match_field": {
            "type": "string",
            "description": "Optional field path to match loop_item to accumulated list entries when resuming from checkpoint (e.g., 'transaction_id' or 'extracted_entry.transaction_id'). When specified, resume will match by field value instead of index, ensuring correct entry is selected even if list order changed. Only applies to async HITL gates within loop patterns. If not specified, falls back to index-based matching."
          }
        },
        "required": ["id", "type"],
        "allOf": [
          {
            "if": { "properties": { "type": { "const": "selection" } } },
            "then": {
              "not": {
                "allOf": [
                  { "required": ["options"] },
                  { "required": ["options_source"] }
                ]
              }
            }
          }
        ],
        "additionalProperties": false
      }
    },
    "execution_settings": {
      "type": "object",
      "description": "Pipeline execution settings including HITL mode configuration",
      "properties": {
        "hitl_mode": {
          "type": "string",
          "enum": ["sync", "async"],
          "default": "sync",
          "description": "Default HITL mode for this pipeline. 'sync' blocks for user response (default), 'async' queues and continues processing"
        },
        "checkpoint_expiry_days": {
          "type": "integer",
          "minimum": 1,
          "default": 7,
          "description": "Days until async HITL checkpoints expire (default: 7)"
        }
      },
      "additionalProperties": false
    },
    "case_management": {
      "type": "object",
      "description": "Case management configuration for tracking pipeline cases",
      "properties": {
        "config_file": {
          "type": "string",
          "description": "Path to case configuration file (e.g., 'cases/my_pipeline.yml'). Required when hitl_mode is 'async'"
        },
        "tracking_variables": {
          "type": "object",
          "description": "Optional variable names for tracking async HITL cases in loop patterns",
          "properties": {
            "hitl_queued": {
              "type": "string",
              "description": "Context key used to store cases queued for HITL review (default: 'hitl_queued_cases')"
            },
            "completed": {
              "type": "string",
              "description": "Context key used to store straight-through completed cases (default: 'completed_cases')"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "event_triggers": {
      "description": "Event-based trigger configuration for automatic pipeline execution. Can be a single trigger config (object) or multiple trigger configs (array). If present, triggers are enabled.",
      "oneOf": [
        {
          "type": "object",
          "description": "Single trigger configuration"
        },
        {
          "type": "array",
          "description": "Multiple trigger configurations, each with its own settings",
          "items": {
            "type": "object"
          },
          "minItems": 1
        }
      ],
      "allOf": [
        {
          "if": {
            "type": "object"
          },
          "then": {
            "required": ["type"],
            "properties": {
              "type": {
                "type": "string",
                "const": "file_watcher",
                "description": "Type of trigger (currently only 'file_watcher' supported, extensible for future types)"
              },
              "directories": {
                "type": "object",
                "description": "Directory configuration (new grouped structure - recommended)",
                "properties": {
                  "watch": {
                    "oneOf": [
                      {
                        "type": "string",
                        "description": "Single directory to watch (relative to project_dir)"
                      },
                      {
                        "type": "array",
                        "items": { "type": "string" },
                        "minItems": 1,
                        "description": "Multiple directories to watch (relative to project_dir)"
                      }
                    ],
                    "description": "Directory(ies) to watch. Can be a string (single directory) or array of strings (multiple directories)"
                  },
                  "exclude": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": [],
                    "description": "Subdirectories to exclude within watch directories (uses fnmatch patterns relative to each watch directory)"
                  }
                },
                "required": ["watch"],
                "additionalProperties": false
              },
              "files": {
                "type": "object",
                "description": "File pattern configuration (new grouped structure - recommended)",
                "properties": {
                  "include": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": ["*"],
                    "description": "File patterns to include (uses fnmatch wildcards, e.g., ['*.txt', '*.pdf'])"
                  },
                  "exclude": {
                    "type": "array",
                    "items": { "type": "string" },
                    "default": [],
                    "description": "File patterns to exclude (uses fnmatch patterns for filenames or relative paths)"
                  }
                },
                "additionalProperties": false
              },
              "watch_directories": {
                "oneOf": [
                  {
                    "type": "string",
                    "description": "Single directory to watch (relative to project_dir)"
                  },
                  {
                    "type": "array",
                    "items": { "type": "string" },
                    "minItems": 1,
                    "description": "Multiple directories to watch (relative to project_dir)"
                  }
                ],
                "description": "[DEPRECATED] Use directories.watch instead. Directory(ies) to watch. Can be a string (single directory) or array of strings (multiple directories)"
              },
              "watch_directory": {
                "type": "string",
                "description": "[DEPRECATED] Use directories.watch instead. Directory to watch (relative to project_dir)"
              },
              "trigger_mode": {
                "type": "string",
                "enum": ["single", "batch", "directory"],
                "default": "single",
                "description": "How to handle multiple file events: 'single' (trigger immediately for each event), 'batch' (batch events within time window), 'directory' (collect all files in directory)"
              },
              "debounce_seconds": {
                "type": "number",
                "default": 2.0,
                "description": "Wait time in seconds before triggering after last event (only used when trigger_mode is 'batch')"
              },
              "exclude_directories": {
                "type": "array",
                "items": { "type": "string" },
                "default": [],
                "description": "[DEPRECATED] Use directories.exclude instead. Directory patterns to exclude from triggering (uses fnmatch patterns relative to watch_directory)"
              },
              "exclude_patterns": {
                "type": "array",
                "items": { "type": "string" },
                "default": [],
                "description": "[DEPRECATED] Use files.exclude instead. File patterns to exclude from triggering (uses fnmatch patterns for filenames or relative paths)"
              },
              "file_patterns": {
                "type": "array",
                "items": { "type": "string" },
                "default": ["*"],
                "description": "[DEPRECATED] Use files.include instead. File patterns to match using fnmatch wildcards (e.g., ['*.txt', '*.pdf'])"
              },
              "event_types": {
                "type": "array",
                "items": {
                  "type": "string",
                  "enum": ["created", "modified", "deleted", "moved"]
                },
                "default": ["created"],
                "description": "File system events to trigger on"
              },
              "extract_context": {
                "type": "object",
                "description": "Configuration for extracting context from trigger events",
                "properties": {
                  "user_text_template": {
                    "type": "string",
                    "description": "Jinja2 template for user_text. Available variables: {{source}}, {{file_path}}, {{file_name}}, {{folder_path}}, {{event_type}}, {{file_count}}, {{file_paths}} (list of all file paths), and trigger-specific metadata",
                    "default": "Process file: {{source}}"
                  }
                },
                "additionalProperties": false
              },
              "pass_files_as_uploads": {
                "type": "boolean",
                "default": false,
                "description": "If true, files are passed as uploads to the pipeline (for multimodal frameworks). If false, files are only referenced in user_text_template and agent uses tools to read from disk."
              },
              "session_strategy": {
                "type": "string",
                "enum": ["per_file", "per_pipeline", "use_current", "custom"],
                "default": "per_file",
                "description": "Session management: 'per_file' (new session each event), 'per_pipeline' (one session for all events), 'use_current' (use most recent active session), 'custom' (pipeline-specific)"
              },
              "ui_mode": {
                "type": "string",
                "enum": ["background", "ui"],
                "default": "background",
                "description": "Execution mode: 'background' (no UI, runs silently), 'ui' (creates session and shows in UI)"
              }
            },
            "anyOf": [
              { "required": ["directories"] },
              { "required": ["watch_directories"] },
              { "required": ["watch_directory"] }
            ],
            "additionalProperties": false
          }
        },
        {
          "if": {
            "type": "array"
          },
          "then": {
            "items": {
              "type": "object",
              "required": ["type"],
              "properties": {
                "type": {
                  "type": "string",
                  "const": "file_watcher",
                  "description": "Type of trigger (currently only 'file_watcher' supported, extensible for future types)"
                },
                "directories": {
                  "type": "object",
                  "description": "Directory configuration (new grouped structure - recommended)",
                  "properties": {
                    "watch": {
                      "oneOf": [
                        {
                          "type": "string",
                          "description": "Single directory to watch (relative to project_dir)"
                        },
                        {
                          "type": "array",
                          "items": { "type": "string" },
                          "minItems": 1,
                          "description": "Multiple directories to watch (relative to project_dir)"
                        }
                      ],
                      "description": "Directory(ies) to watch. Can be a string (single directory) or array of strings (multiple directories)"
                    },
                    "exclude": {
                      "type": "array",
                      "items": { "type": "string" },
                      "default": [],
                      "description": "Subdirectories to exclude within watch directories (uses fnmatch patterns relative to each watch directory)"
                    }
                  },
                  "required": ["watch"],
                  "additionalProperties": false
                },
                "files": {
                  "type": "object",
                  "description": "File pattern configuration (new grouped structure - recommended)",
                  "properties": {
                    "include": {
                      "type": "array",
                      "items": { "type": "string" },
                      "default": ["*"],
                      "description": "File patterns to include (uses fnmatch wildcards, e.g., ['*.txt', '*.pdf'])"
                    },
                    "exclude": {
                      "type": "array",
                      "items": { "type": "string" },
                      "default": [],
                      "description": "File patterns to exclude (uses fnmatch patterns for filenames or relative paths)"
                    }
                  },
                  "additionalProperties": false
                },
                "watch_directories": {
                  "oneOf": [
                    {
                      "type": "string",
                      "description": "Single directory to watch (relative to project_dir)"
                    },
                    {
                      "type": "array",
                      "items": { "type": "string" },
                      "minItems": 1,
                      "description": "Multiple directories to watch (relative to project_dir)"
                    }
                  ],
                  "description": "[DEPRECATED] Use directories.watch instead. Directory(ies) to watch. Can be a string (single directory) or array of strings (multiple directories)"
                },
                "watch_directory": {
                  "type": "string",
                  "description": "[DEPRECATED] Use directories.watch instead. Directory to watch (relative to project_dir)"
                },
                "trigger_mode": {
                  "type": "string",
                  "enum": ["single", "batch", "directory"],
                  "default": "single",
                  "description": "How to handle multiple file events: 'single' (trigger immediately for each event), 'batch' (batch events within time window), 'directory' (collect all files in directory)"
                },
                "debounce_seconds": {
                  "type": "number",
                  "default": 2.0,
                  "description": "Wait time in seconds before triggering after last event (only used when trigger_mode is 'batch')"
                },
                "exclude_directories": {
                  "type": "array",
                  "items": { "type": "string" },
                  "default": [],
                  "description": "[DEPRECATED] Use directories.exclude instead. Directory patterns to exclude from triggering (uses fnmatch patterns relative to watch_directory)"
                },
                "exclude_patterns": {
                  "type": "array",
                  "items": { "type": "string" },
                  "default": [],
                  "description": "[DEPRECATED] Use files.exclude instead. File patterns to exclude from triggering (uses fnmatch patterns for filenames or relative paths)"
                },
                "file_patterns": {
                  "type": "array",
                  "items": { "type": "string" },
                  "default": ["*"],
                  "description": "[DEPRECATED] Use files.include instead. File patterns to match using fnmatch wildcards (e.g., ['*.txt', '*.pdf'])"
                },
                "event_types": {
                  "type": "array",
                  "items": {
                    "type": "string",
                    "enum": ["created", "modified", "deleted", "moved"]
                  },
                  "default": ["created"],
                  "description": "File system events to trigger on"
                },
                "extract_context": {
                  "type": "object",
                  "description": "Configuration for extracting context from trigger events",
                  "properties": {
                    "user_text_template": {
                      "type": "string",
                      "description": "Jinja2 template for user_text. Available variables: {{source}}, {{file_path}}, {{file_name}}, {{event_type}}, and trigger-specific metadata",
                      "default": "Process file: {{source}}"
                    }
                  },
                  "additionalProperties": false
                },
                "session_strategy": {
                  "type": "string",
                  "enum": ["per_file", "per_pipeline", "use_current", "custom"],
                  "default": "per_file",
                  "description": "Session management: 'per_file' (new session each event), 'per_pipeline' (one session for all events), 'use_current' (use most recent active session), 'custom' (pipeline-specific)"
                },
                "ui_mode": {
                  "type": "string",
                  "enum": ["background", "ui"],
                  "default": "background",
                  "description": "Execution mode: 'background' (no UI, runs silently), 'ui' (creates session and shows in UI)"
                }
              },
              "anyOf": [
                { "required": ["directories"] },
                { "required": ["watch_directories"] },
                { "required": ["watch_directory"] }
              ],
              "additionalProperties": false
            }
          }
        }
      ]
    },
    "outputs": {
      "type": "object",
      "required": ["final"],
      "properties": {
        "intermediate": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "node": {
                "type": "string",
                "description": "Which node's output to capture"
              },
              "selectors": {
                "type": "array",
                "items": { "type": "string" },
                "minItems": 1,
                "description": "JSON keys/paths to extract"
              },
              "transform": {
                "type": "string",
                "description": "Jinja2 expression for transformation"
              }
            },
            "required": ["node", "selectors"],
            "additionalProperties": false
          }
        },
        "final": {
          "type": "object",
          "properties": {
            "node": {
              "type": "string",
              "description": "Which node's output to use as final result (optional in transform-only mode)"
            },
            "selectors": {
              "type": "array",
              "items": { "type": "string" },
              "minItems": 1,
              "description": "JSON keys/paths to extract (optional in transform-only mode)"
            },
            "transform": {
              "type": "string",
              "description": "Jinja2 expression for transformation. In transform-only mode, use 'results' dict for full access"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "memory": {
      "type": "object",
      "description": "AgentOS memory configuration for pipeline-level shared memory",
      "properties": {
        "shared": {
          "type": "object",
          "description": "Pipeline-level shared memory configuration",
          "properties": {
            "directories": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "path": {
                    "type": "string",
                    "description": "Virtual path (e.g., '/shared/email_templates/')"
                  },
                  "description": {
                    "type": "string",
                    "description": "Human-readable description of the directory"
                  },
                  "readonly": {
                    "type": "boolean",
                    "default": false,
                    "description": "Whether the directory is read-only"
                  },
                  "auto_index": {
                    "type": "boolean",
                    "default": false,
                    "description": "Whether to auto-index files for semantic search"
                  },
                  "bootstrap": {
                    "type": "boolean",
                    "default": false,
                    "description": "Whether to create directory on first run"
                  },
                  "template_source": {
                    "type": "string",
                    "description": "Template source path relative to project root (e.g., 'config/memory/shared/pipeline/reply_wizard/email_templates/')"
                  },
                  "schemas": {
                    "type": "object",
                    "description": "File schemas for this directory",
                    "additionalProperties": {
                      "type": "object",
                      "properties": {
                        "file": {
                          "type": "string",
                          "description": "Filename for this schema"
                        },
                        "format": {
                          "type": "string",
                          "enum": ["jsonl", "json", "markdown"],
                          "default": "json",
                          "description": "File format"
                        },
                        "write_mode": {
                          "type": "string",
                          "enum": ["append", "overwrite"],
                          "default": "overwrite",
                          "description": "How to write to this file"
                        },
                        "readonly": {
                          "type": "boolean",
                          "default": false,
                          "description": "Whether this file is read-only"
                        },
                        "structure": {
                          "type": "object",
                          "description": "Structure definition for this file (simple key-value mapping)",
                          "additionalProperties": true
                        },
                        "instructions": {
                          "type": "object",
                          "description": "Custom instructions for reading/writing this file",
                          "properties": {
                            "read": {
                              "type": "string",
                              "description": "Custom read instruction"
                            },
                            "write": {
                              "type": "string",
                              "description": "Custom write instruction"
                            }
                          },
                          "additionalProperties": false
                        }
                      },
                      "required": ["file"],
                      "additionalProperties": false
                    }
                  }
                },
                "required": ["path"],
                "additionalProperties": false
              }
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  },
  "definitions": {
    "step": {
      "oneOf": [
        {
          "type": "object",
          "required": ["node"],
          "properties": {
            "node": { "type": "string" },
            "condition": {
              "type": "string",
              "description": "Conditional expression - node executes only if true"
            },
            "on_false": {
              "oneOf": [
                {
                  "type": "string",
                  "enum": ["stop", "continue"],
                  "description": "Simple action: 'stop' to end pipeline execution, 'continue' to skip and continue (default)"
                },
                {
                  "type": "array",
                  "items": {
                    "oneOf": [
                      { "$ref": "#/definitions/step" },
                      { "$ref": "#/definitions/sequential" },
                      { "$ref": "#/definitions/parallel" },
                      { "$ref": "#/definitions/loop" },
                      { "$ref": "#/definitions/switch" }
                    ]
                  },
                  "description": "Array of steps to execute when condition is false (if-else pattern)"
                },
                {
                  "oneOf": [
                    { "$ref": "#/definitions/step" },
                    { "$ref": "#/definitions/sequential" },
                    { "$ref": "#/definitions/parallel" },
                    { "$ref": "#/definitions/loop" },
                    { "$ref": "#/definitions/switch" }
                  ],
                  "description": "Single step or pattern to execute when condition is false (if-else pattern)"
                }
              ],
              "description": "Action when condition is false: string action ('stop'/'continue'), array of steps, or single step/pattern"
            },
            "input_mapping": {
              "type": "object",
              "additionalProperties": { "type": "string" },
              "description": "Optional mapping of input variable names to templates with {{index}} substitution (used in enhanced repeat patterns)"
            }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["pipeline"],
          "properties": {
            "pipeline": { 
              "type": "string",
              "description": "Pipeline ID from pipelines registry"
            },
            "condition": {
              "type": "string",
              "description": "Conditional expression - pipeline executes only if true"
            },
            "on_false": {
              "oneOf": [
                {
                  "type": "string",
                  "enum": ["stop", "continue"],
                  "description": "Simple action: 'stop' to end pipeline execution, 'continue' to skip and continue (default)"
                },
                {
                  "type": "array",
                  "items": {
                    "oneOf": [
                      { "$ref": "#/definitions/step" },
                      { "$ref": "#/definitions/sequential" },
                      { "$ref": "#/definitions/parallel" },
                      { "$ref": "#/definitions/loop" },
                      { "$ref": "#/definitions/switch" }
                    ]
                  },
                  "description": "Array of steps to execute when condition is false (if-else pattern)"
                },
                {
                  "oneOf": [
                    { "$ref": "#/definitions/step" },
                    { "$ref": "#/definitions/sequential" },
                    { "$ref": "#/definitions/parallel" },
                    { "$ref": "#/definitions/loop" },
                    { "$ref": "#/definitions/switch" }
                  ],
                  "description": "Single step or pattern to execute when condition is false (if-else pattern)"
                }
              ],
              "description": "Action when condition is false: string action ('stop'/'continue'), array of steps, or single step/pattern"
            },
            "input_mapping": {
              "type": "object",
              "additionalProperties": { "type": "string" },
              "description": "Required mapping of input variable names to expressions/Jinja2 templates. Maps to what the first node in the sub-pipeline expects."
            }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["gate"],
          "properties": {
            "gate": { "type": "string" },
            "condition": {
              "type": "string",
              "description": "Conditional expression - gate executes only if true"
            },
            "on_false": {
              "oneOf": [
                {
                  "type": "string",
                  "enum": ["stop", "continue"],
                  "description": "Simple action: 'stop' to end pipeline execution, 'continue' to skip and continue (default)"
                },
                {
                  "type": "array",
                  "items": {
                    "oneOf": [
                      { "$ref": "#/definitions/step" },
                      { "$ref": "#/definitions/sequential" },
                      { "$ref": "#/definitions/parallel" },
                      { "$ref": "#/definitions/loop" },
                      { "$ref": "#/definitions/switch" }
                    ]
                  },
                  "description": "Array of steps to execute when condition is false (if-else pattern)"
                },
                {
                  "oneOf": [
                    { "$ref": "#/definitions/step" },
                    { "$ref": "#/definitions/sequential" },
                    { "$ref": "#/definitions/parallel" },
                    { "$ref": "#/definitions/loop" },
                    { "$ref": "#/definitions/switch" }
                  ],
                  "description": "Single step or pattern to execute when condition is false (if-else pattern)"
                }
              ],
              "description": "Action when condition is false: string action ('stop'/'continue'), array of steps, or single step/pattern"
            },
            "retry_target": { "type": "string" },
            "max_retries": { "type": "integer", "minimum": 1, "default": 3 },
            "skip_to": { "oneOf": [{ "type": "string" }, { "type": "object" }] }
          },
          "patternProperties": {
            "^on_[a-zA-Z_][a-zA-Z0-9_]*$": {
              "oneOf": [
                {
                  "enum": ["continue", "stop", "skip_to_node", "retry_node"],
                  "description": "Simple flow action"
                },
                {
                  "type": "array",
                  "items": {
                    "oneOf": [
                      { "$ref": "#/definitions/step" },
                      { "$ref": "#/definitions/sequential" },
                      { "$ref": "#/definitions/parallel" },
                      { "$ref": "#/definitions/loop" },
                      { "$ref": "#/definitions/switch" }
                    ]
                  },
                  "description": "Array of steps to execute when this button is clicked"
                }
              ],
              "description": "Action to take when button is clicked (on_<button_name>) - can be a simple action or array of steps"
            }
          },
          "additionalProperties": false
        }
      ]
    },
    "sequential": {
      "type": "object",
      "required": ["type", "steps"],
      "properties": {
        "type": { "const": "sequential" },
        "name": {
          "type": "string",
          "description": "Optional pattern name for UI display"
        },
        "description": {
          "type": "string",
          "description": "Optional pattern description for UI display"
        },
        "condition": {
          "type": "string",
          "description": "Optional conditional expression - branch executes only if true"
        },
        "steps": {
          "type": "array",
          "items": {
            "oneOf": [
              { "$ref": "#/definitions/step" },
              { "$ref": "#/definitions/sequential" },
              { "$ref": "#/definitions/parallel" },
              { "$ref": "#/definitions/loop" },
              { "$ref": "#/definitions/switch" },
              { "$ref": "#/definitions/group_chat" }
            ]
          },
          "minItems": 1
        }
      },
      "additionalProperties": false
    },
    "parallel": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": { "const": "parallel" },
        "name": {
          "type": "string",
          "description": "Optional pattern name for UI display"
        },
        "description": {
          "type": "string",
          "description": "Optional pattern description for UI display"
        },
        "condition": {
          "type": "string",
          "description": "Optional conditional expression - branch executes only if true"
        },
        "steps": {
          "type": "array",
          "items": {
            "oneOf": [
              { "$ref": "#/definitions/step" },
              { "$ref": "#/definitions/sequential" },
              { "$ref": "#/definitions/parallel" }
            ]
          },
          "minItems": 1,
          "description": "List of steps for standard parallel pattern (required if 'repeat' is not present)"
        },
        "repeat": {
          "type": "object",
          "oneOf": [
            {
              "required": ["node", "instances"],
              "properties": {
                "name": {
                  "type": "string",
                  "description": "Optional pattern name for UI display"
                },
                "description": {
                  "type": "string",
                  "description": "Optional pattern description for UI display"
                },
                "node": {
                  "type": "string",
                  "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*(:in-proc)?$",
                  "description": "Agent node ID to repeat"
                },
                "instances": {
                  "oneOf": [
                    { "type": "integer", "minimum": 1 },
                    { "type": "string" }
                  ],
                  "description": "Number of instances (integer) or expression string that evaluates to instance count"
                },
                "max_concurrency": {
                  "type": "integer",
                  "minimum": 1,
                  "description": "Optional cap on how many repeat instances can run concurrently. If omitted, all instances run in parallel."
                },
                "input_mapping": {
                  "type": "object",
                  "additionalProperties": { "type": "string" },
                  "description": "Optional mapping of input variable names to templates with {{index}} substitution"
                },
                "instance_id_template": {
                  "type": "string",
                  "default": "{{node_id}}_instance_{{index}}",
                  "description": "Template for generating instance IDs (supports {{index}} and {{node_id}})"
                },
                "instance_context_key": {
                  "type": "string",
                  "default": "repeat_instance",
                  "description": "Context key for instance metadata (default: 'repeat_instance')"
                }
              },
              "additionalProperties": false,
              "description": "Single agent repeat pattern configuration"
            },
            {
              "required": ["pipeline", "instances"],
              "properties": {
                "name": {
                  "type": "string",
                  "description": "Optional pattern name for UI display"
                },
                "description": {
                  "type": "string",
                  "description": "Optional pattern description for UI display"
                },
                "pipeline": {
                  "type": "string",
                  "description": "Pipeline ID from pipelines registry to repeat"
                },
                "instances": {
                  "oneOf": [
                    { "type": "integer", "minimum": 1 },
                    { "type": "string" }
                  ],
                  "description": "Number of instances (integer) or expression string that evaluates to instance count"
                },
                "max_concurrency": {
                  "type": "integer",
                  "minimum": 1,
                  "description": "Optional cap on how many repeat instances can run concurrently. If omitted, all instances run in parallel."
                },
                "input_mapping": {
                  "type": "object",
                  "additionalProperties": { "type": "string" },
                  "description": "Required mapping of input variable names to templates with {{index}} substitution. Maps to what the first node in the sub-pipeline expects."
                },
                "instance_id_template": {
                  "type": "string",
                  "default": "{{pipeline_id}}_instance_{{index}}",
                  "description": "Template for generating instance IDs (supports {{index}} and {{pipeline_id}})"
                },
                "instance_context_key": {
                  "type": "string",
                  "default": "repeat_instance",
                  "description": "Context key for instance metadata (default: 'repeat_instance')"
                }
              },
              "additionalProperties": false,
              "description": "Single pipeline repeat pattern configuration"
            },
            {
              "required": ["type", "instances", "steps"],
              "properties": {
                "type": {
                  "const": "sequential",
                  "description": "Pattern type for enhanced repeat (must be 'sequential')"
                },
                "name": {
                  "type": "string",
                  "description": "Optional pattern name for UI display"
                },
                "description": {
                  "type": "string",
                  "description": "Optional pattern description for UI display"
                },
                "instances": {
                  "oneOf": [
                    { "type": "integer", "minimum": 1 },
                    { "type": "string" }
                  ],
                  "description": "Number of instances (integer) or expression string that evaluates to instance count"
                },
                "max_concurrency": {
                  "type": "integer",
                  "minimum": 1,
                  "description": "Optional cap on how many repeat instances can run concurrently. If omitted, all instances run in parallel."
                },
                "steps": {
                  "type": "array",
                  "minItems": 1,
                  "items": {
                    "oneOf": [
                      { "$ref": "#/definitions/step" },
                      { "$ref": "#/definitions/sequential" },
                      { "$ref": "#/definitions/parallel" }
                    ]
                  },
                  "description": "Sequence of agents/steps to run for each instance"
                },
                "input_mapping": {
                  "type": "object",
                  "additionalProperties": { "type": "string" },
                  "description": "Optional global mapping of input variable names to templates with {{index}} substitution (applies to all agents in sequence)"
                },
                "instance_id_template": {
                  "type": "string",
                  "default": "{{node_id}}_instance_{{index}}",
                  "description": "Template for generating instance IDs (supports {{index}} and {{node_id}})"
                },
                "instance_context_key": {
                  "type": "string",
                  "default": "repeat_instance",
                  "description": "Context key for instance metadata (default: 'repeat_instance')"
                }
              },
              "additionalProperties": false,
              "description": "Enhanced repeat pattern configuration with nested sequential pattern"
            }
          ],
          "description": "Repeat pattern configuration (required if 'steps' is not present). Supports single agent repeat (node) or enhanced repeat with nested sequential pattern (type: sequential)"
        }
      },
      "allOf": [
        {
          "anyOf": [
            { "required": ["steps"] },
            { "required": ["repeat"] }
          ]
        }
      ],
      "additionalProperties": false
    },
    "loop": {
      "type": "object",
      "required": ["type", "body"],
      "properties": {
        "type": { "const": "loop" },
        "name": {
          "type": "string",
          "description": "Optional pattern name for UI display"
        },
        "description": {
          "type": "string",
          "description": "Optional pattern description for UI display"
        },
        "condition": {
          "type": "string",
          "description": "Optional conditional expression - branch executes only if true"
        },
        "max_iterations": {
          "oneOf": [
            { "type": "integer", "minimum": 1 },
            { "type": "string", "description": "Expression to evaluate max_iterations (e.g., 'min(folder_scanner.file_count, 50)')" }
          ],
          "description": "Maximum iterations (integer) or expression string. Deprecated: use termination.max_iterations instead"
        },
        "termination": {
          "type": "object",
          "properties": {
            "max_iterations": {
              "oneOf": [
                { "type": "integer", "minimum": 1 },
                { "type": "string", "description": "Expression to evaluate max_iterations (e.g., 'min(folder_scanner.file_count, 50)')" }
              ],
              "description": "Maximum iterations (integer) or expression string"
            },
            "condition": {
              "type": "string",
              "description": "Optional early termination condition expression (e.g., 'file_selector.current_file_path is null')"
            }
          },
          "additionalProperties": false
        },
        "body": {
          "oneOf": [
            { "$ref": "#/definitions/step" },
            { "$ref": "#/definitions/sequential" },
            { "$ref": "#/definitions/parallel" }
          ]
        },
        "loop_context_key": {
          "type": "string",
          "description": "Context key for loop iteration metadata (default: 'loop_iteration'). Use in agent YAML to access {{loop_context_key.index}} and {{loop_context_key.iteration}}",
          "default": "loop_iteration"
        },
        "accumulate_results": {
          "type": "boolean",
          "description": "Whether to accumulate results in arrays for downstream access (default: true). If false, only the last iteration's results are available.",
          "default": true
        },
        "iterate_over": {
          "type": "string",
          "description": "Optional path to array/list to iterate over (e.g., 'scanner.pending_claims_list'). When provided, loop iterates over array items instead of using numeric iteration. Mutually exclusive with max_iterations/termination.max_iterations."
        },
        "loop_item_key": {
          "type": "string",
          "description": "Context key for current item when using iterate_over (default: 'loop_item'). The current array item is injected into context at this key for each iteration.",
          "default": "loop_item"
        },
        "skip_condition": {
          "type": "string",
          "description": "Optional condition expression to skip items during iteration (e.g., 'loop_item.claim_id in processed_claims'). If true, the item is skipped and loop continues to next item."
        },
        "dynamic_iterate_over": {
          "type": "boolean",
          "description": "If true, re-evaluate iterate_over list before each iteration to pick up newly added items. Default: false (static snapshot for backward compatibility).",
          "default": false
        },
        "iterate_over_tool_results": {
          "type": "string",
          "description": "Alternative to iterate_over: Tool name in toolkit.name format (e.g., 'reconvoy.get_blackline_unmatched_items'). When provided, tool is called each iteration to get fresh data. Mutually exclusive with iterate_over."
        },
        "iterate_over_tool_args": {
          "type": "object",
          "description": "Dictionary of tool arguments (required when using iterate_over_tool_results). Keys are tool parameter names, values are Jinja2 expressions resolved from context.",
          "additionalProperties": { "type": "string" }
        },
        "iterate_over_result_path": {
          "type": "string",
          "description": "Dot-separated path to extract list from tool result (required when using iterate_over_tool_results). Use empty string if tool returns list directly."
        },
        "flush_loop_context": {
          "type": "boolean",
          "description": "If true, clears loop_item_key and loop context variables from context after loop completes. Useful for nested loops to prevent inner loop items persisting in outer loop iterations. Default: false.",
          "default": false
        }
      },
      "additionalProperties": false
    },
    "switch": {
      "type": "object",
      "required": ["type", "cases"],
      "properties": {
        "type": {
          "oneOf": [
            { "const": "switch" },
            { "type": "string", "pattern": "^switch\\(" }
          ],
          "description": "Switch pattern type, optionally with field or expression in parentheses"
        },
        "name": {
          "type": "string",
          "description": "Optional pattern name for UI display"
        },
        "description": {
          "type": "string",
          "description": "Optional pattern description for UI display"
        },
        "field": {
          "type": "string",
          "description": "Field name to evaluate (alternative to switch(field) syntax)"
        },
        "condition": {
          "type": "string",
          "description": "Optional conditional expression - branch executes only if true"
        },
        "cases": {
          "type": "object",
          "description": "Map of case values to step arrays (keys can be any type: string, number, boolean)",
          "additionalProperties": {
            "type": "array",
            "items": {
              "oneOf": [
                { "$ref": "#/definitions/step" },
                { "$ref": "#/definitions/sequential" },
                { "$ref": "#/definitions/parallel" },
                { "$ref": "#/definitions/loop" },
                { "$ref": "#/definitions/switch" }
              ]
            },
            "minItems": 1
          }
        },
        "default": {
          "type": "array",
          "description": "Default steps if no case matches",
          "items": {
            "oneOf": [
              { "$ref": "#/definitions/step" },
              { "$ref": "#/definitions/sequential" },
              { "$ref": "#/definitions/parallel" },
              { "$ref": "#/definitions/loop" },
              { "$ref": "#/definitions/switch" }
            ]
          },
          "minItems": 1
        }
      },
      "additionalProperties": false
    },
    "handoff": {
      "type": "object",
      "required": ["type", "handoffs"],
      "properties": {
        "type": {
          "const": "handoff"
        },
        "name": {
          "type": "string",
          "description": "Optional pattern name for UI display"
        },
        "description": {
          "type": "string",
          "description": "Optional pattern description for UI display"
        },
        "condition": {
          "type": "string",
          "description": "Optional conditional expression - branch executes only if true"
        },
        "orchestrator": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
          "description": "OPTIONAL: Custom orchestrator agent. If omitted, uses generic orchestrator auto-generated from agent descriptions."
        },
        "handoffs": {
          "type": "array",
          "description": "List of specialist agents or pipelines available for handoff",
          "items": {
            "oneOf": [
              {
                "type": "object",
                "required": ["node"],
                "properties": {
                  "node": {
                    "type": "string",
                    "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$"
                  }
                },
                "additionalProperties": false
              },
              {
                "type": "object",
                "required": ["pipeline"],
                "properties": {
                  "pipeline": {
                    "type": "string",
                    "description": "Pipeline ID from pipelines registry"
                  },
                  "input_mapping": {
                    "type": "object",
                    "additionalProperties": { "type": "string" },
                    "description": "Required mapping of input variable names to expressions/Jinja2 templates. Maps to what the first node in the sub-pipeline expects."
                  }
                },
                "additionalProperties": false
              }
            ]
          },
          "minItems": 1
        }
      },
      "additionalProperties": false
    },
    "group_chat": {
      "type": "object",
      "required": ["type", "participants", "selection_strategy", "termination"],
      "properties": {
        "type": {
          "const": "group_chat",
          "description": "Group chat pattern with multiple agents in shared conversation"
        },
        "name": {
          "type": "string",
          "description": "Optional pattern name for UI display"
        },
        "description": {
          "type": "string",
          "description": "Optional pattern description for UI display"
        },
        "condition": {
          "type": "string",
          "description": "Optional conditional expression - branch executes only if true"
        },
        "participants": {
          "type": "array",
          "description": "List of agents or pipelines participating in the group chat",
          "items": {
            "oneOf": [
              {
                "type": "object",
                "required": ["node"],
                "properties": {
                  "node": {
                    "type": "string",
                    "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*(:in-proc)?$",
                    "description": "Agent node reference: agent_id[:protocol]"
                  }
                },
                "additionalProperties": false
              },
              {
                "type": "object",
                "required": ["pipeline"],
                "properties": {
                  "pipeline": {
                    "type": "string",
                    "description": "Pipeline ID from pipelines registry"
                  },
                  "input_mapping": {
                    "type": "object",
                    "additionalProperties": { "type": "string" },
                    "description": "Required mapping of input variable names to expressions/Jinja2 templates. Maps to what the first node in the sub-pipeline expects."
                  }
                },
                "additionalProperties": false
              }
            ]
          },
          "minItems": 2
        },
        "selection_strategy": {
          "type": "string",
          "enum": ["llm", "round_robin"],
          "description": "How to select next speaker: llm (orchestrator decides) or round_robin (fixed order)"
        },
        "orchestrator": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*(:in-proc)?$",
          "description": "Optional custom orchestrator agent for LLM strategy"
        },
        "orchestrator_model": {
          "type": "string",
          "description": "Model for virtual orchestrator (LLM strategy only)"
        },
        "termination": {
          "type": "object",
          "required": ["max_rounds"],
          "properties": {
            "max_rounds": {
              "type": "integer",
              "minimum": 1,
              "description": "Maximum number of conversation rounds"
            },
            "condition": {
              "type": "string",
              "description": "Optional early termination condition expression"
            }
          }
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
