# =============================================================================
# PIPELINE CONFIGURATION
# =============================================================================
#
# Pipeline parameters:
# - name (str, required): human-readable pipeline name
# - description (str, required): detailed description of pipeline purpose
#
# =============================================================================

name: "Reply Wizard"
description: "Reply Wizard is an end-to-end agentic workflow that transforms an incoming email into a high-quality, polished response. The process starts with Reply Context Wizard, which extracts intent, key points, tone, and urgency from the original message. Reply Draft Wizard then composes the initial draft based on this structured context. Reply Critique Wizard reviews the draft and provides actionable improvement points, which Reply Polish Wizard uses to refine and deliver a professional, engaging, and ready-to-send email."

# =============================================================================
# MEMORY CONFIGURATION
# =============================================================================
#
# Shared memory configuration for all agents in this pipeline.
# Agents can inherit this shared memory by setting inherit: true in their
# agent-level memory configuration.
#
# Memory parameters:
# - memory (object, optional): pipeline-level memory configuration
#   - memory.shared (object, optional): shared memory across all pipeline agents
#     - memory.shared.directories (list[object], optional): shared directories
#       - directories[].path (str, required): virtual path (e.g., "/shared/email_templates/")
#       - directories[].description (str, required): human-readable description
#       - directories[].readonly (bool, optional): whether directory is read-only (default: true for shared)
#       - directories[].auto_index (bool, optional): auto-index for semantic search (default: true)
#       - directories[].bootstrap (bool, optional): create on init (default: true)
#
# =============================================================================
memory:
  shared:
    directories:
      - path: "/shared/email_templates/"
        description: "Pipeline-specific email templates (READ-ONLY)"
        readonly: true
        auto_index: true
        bootstrap: true
        template_source: "config/memory/shared/pipeline/reply_wizard/email_templates/"
      - path: "/shared/company_info/"
        description: "Company information and standard responses (READ-ONLY)"
        readonly: true
        auto_index: true
        bootstrap: true
        template_source: "config/memory/shared/pipeline/reply_wizard/company_info/"
      - path: "/shared/senders/"
        description: "Sender-specific preferences and interaction history (shared across all agents)"
        readonly: false
        auto_index: true
        bootstrap: true
        schemas:
          interactions:
            file: "interactions.jsonl"
            format: "jsonl"
            write_mode: "append"
            structure:
              timestamp: "ISO 8601 timestamp"
              original_email:
                subject: "string"
                content: "string"
                sender:
                  name: "string"
                  email: "string"
              response:
                subject: "string"
                content: "string"
              metadata:
                intent: "string"
                urgency: "string"
                tone: "string"
          preferences:
            file: "preferences.json"
            format: "json"
            write_mode: "overwrite"
            structure:
              preferred_tone: "string"
              communication_style: "string"
              notes: "string"

# =============================================================================
# PIPELINE PATTERN CONFIGURATION
# =============================================================================
#
# Define the execution flow explicitly using one of three constructs:
#   - sequential: run children in order
#   - parallel: run children concurrently (wait_all)
#   - loop: repeat body up to max_iterations
#
# NODES REGISTRY (REQUIRED)
# - nodes (list[object], required)
#   - nodes[].id (str, required): agent identifier
#   - nodes[].config_file (str, required): path to agent configuration file (relative to config/)
#
# PATTERN (REQUIRED)
# - pattern (object, required): one of sequential | parallel | loop
#
# STEP (LEAF)
# - node (str, required): "agent_id"
#
# SEQUENTIAL
# - type: sequential (required)
# - steps: list of (step | pattern) (required, >=1)
#
# PARALLEL
# - type: parallel (required)
# - steps: list of (step | pattern) (required, >=1)
# - semantics: wait_all; first error fails the group (MVP defaults)
#
# LOOP
# - type: loop (required)
# - body: (step | sequential | parallel) (required)
# - max_iterations: int (required, >=1)
#
# NOTES
# - Context model unchanged: each node writes to context.upstream[node_id]
# - Gates and outputs are configured in their respective sections below
#
# =============================================================================

nodes:
  - id: reply_context_wizard
    config_file: "agents/reply_context_wizard.yml"
  - id: reply_draft_wizard
    config_file: "agents/reply_draft_wizard.yml"
  - id: reply_critique_wizard
    config_file: "agents/reply_critique_wizard.yml"
  - id: reply_polish_wizard
    config_file: "agents/reply_polish_wizard.yml"

pattern:
  type: sequential
  name: "Email Reply Generation Flow"
  description: |
    ## Email Reply Generation Flow
    
    This sequential pattern orchestrates the complete email reply generation workflow:
    1. **Context Wizard** extracts intent, key points, tone, and urgency from the original message
    2. **Draft Wizard** composes the initial draft based on structured context
    3. **Critique Wizard** reviews the draft and provides actionable improvement points
    4. **Approval Gate** allows human review of the critique before polishing
    5. **Polish Wizard** refines the draft using critique feedback to deliver a professional, ready-to-send email
    
    The workflow ensures high-quality email responses through structured analysis, critique, and refinement.
  steps:
    - node: reply_context_wizard
    - node: reply_draft_wizard
    - node: reply_critique_wizard
    - gate: approve_critique_wizard
      on_approve: continue
      on_reject: stop
    - node: reply_polish_wizard
# =============================================================================
# HITL SECTION - Human-in-the-loop gates
# =============================================================================
#
# Human-in-the-Loop gates configuration (optional)
# Parameters:
# - gates (list[object], optional): human-in-the-loop pause points
#   - gates[].id (str, required): unique gate id
#   - gates[].type (str, required): "approval" | "input" | "selection"
#   - gates[].title (str, optional): UI title
#   - gates[].description (str, optional): UI description
#   - gates[].fields (list[object], optional): form fields for input gates
#   - gates[].options (list[object], optional): selection options for selection gates
#   - gates[].target_agents (list[str], optional): which agents receive this data
#   - gates[].context_key (str, optional): key to store data in context
#   - gates[].timeout_ms (int, optional): wait timeout; default 300000
#   - gates[].on_timeout (str, optional): "approve" | "reject" | "skip" | "default"
#
# =============================================================================

gates:
  - id: approve_critique_wizard
    type: approval
    title: "Review Critique and Approve"
    description: |
      ## Critique Summary

      **Strengths:**
      {% if reply_critique_wizard.critique and reply_critique_wizard.critique.strengths %}
      {% for strength in reply_critique_wizard.critique.strengths %}
      - ‚úÖ {{ strength }}
      {% endfor %}
      {% else %}
      - No specific strengths identified
      {% endif %}

      **Weaknesses:**
      {% if reply_critique_wizard.critique and reply_critique_wizard.critique.weaknesses %}
      {% for weakness in reply_critique_wizard.critique.weaknesses %}
      - ‚ö†Ô∏è {{ weakness }}
      {% endfor %}
      {% else %}
      - No specific weaknesses identified
      {% endif %}

      **Suggested Improvements:**
      {% if reply_critique_wizard.critique and reply_critique_wizard.critique.suggested_improvements %}
      {% for improvement in reply_critique_wizard.critique.suggested_improvements %}
      - üí° {{ improvement }}
      {% endfor %}
      {% else %}
      - No specific improvements suggested
      {% endif %}

      ---

      Review the critique above. **Approve** to proceed with polishing the draft using these feedback points, or **Reject** to stop.
    timeout_ms: 30000
    on_timeout: approve

# =============================================================================
# OUTPUTS SECTION - Intermediate and Final Outputs
# =============================================================================
#
# Output configuration for pipeline results
# Parameters:
# - intermediate (list[object], optional): intermediate outputs during execution
#   - intermediate[].id (str, required): unique output identifier
#   - intermediate[].node (str, required): which node's output to capture
#   - intermediate[].selectors (list[str], required): JSON keys/paths to extract
#   - intermediate[].transform (str, optional): Jinja2 expression for transformation
# - final (object, required): final pipeline output
#   - final.node (str, required): which node's output to use as final result
#   - final.selectors (list[str], required): JSON keys/paths to extract
#   - final.transform (str, optional): Jinja2 expression for transformation
#
# =============================================================================

outputs:
  final:
    node: reply_polish_wizard
    selectors:
      - polished_response_md
      - error
    transform: "{{ value }}"
