# =============================================================================
# PIPELINE CONFIGURATION
# =============================================================================
#
# Pipeline parameters:
# - name (str, required): human-readable pipeline name
# - description (str, required): detailed description of pipeline purpose
#
# =============================================================================

name: "Enhanced Math Repeater"
description: "A multi-agent pipeline that processes multiple math problem files in parallel using enhanced repeat pattern. Scans a folder for math problem files, processes each file through a sequence (read → solve → report), and generates a final aggregated report."

# =============================================================================
# PIPELINE PATTERN CONFIGURATION
# =============================================================================
#
# Define the execution flow explicitly using one of these constructs:
#   - sequential: run children in order
#   - parallel: run children concurrently (wait_all)
#   - loop: repeat body up to max_iterations
#   - repeat: run same agent multiple times in parallel (new pattern)
#   - enhanced repeat: run sequence of agents multiple times in parallel (new pattern)
#
# NODES REGISTRY (REQUIRED)
# - nodes (list[object], required)
#   - nodes[].id (str, required): agent identifier
#   - nodes[].config_file (str, required): path to agent configuration file (relative to config/)
#
# PATTERN (REQUIRED)
# - pattern (object, required): one of sequential | parallel | loop | repeat
#
# STEP (LEAF)
# - node (str, required): "agent_id"
#
# SEQUENTIAL
# - type: sequential (required)
# - steps: list of (step | pattern) (required, >=1)
#
# PARALLEL
# - type: parallel (required)
# - steps: list of (step | pattern) (required, >=1)
# - OR repeat: repeat configuration (required if using repeat pattern)
# - semantics: wait_all; first error fails the group (MVP defaults)
#
# REPEAT PATTERN (SINGLE AGENT)
# - type: parallel (required)
# - repeat (object, required): repeat configuration
#   - repeat.node (str, required): agent node ID to repeat
#   - repeat.instances (int | str, required): number of instances or expression
#   - repeat.input_mapping (object, optional): input mapping with {{index}} variable
#   - repeat.instance_id_template (str, optional): template for instance IDs
#   - repeat.instance_context_key (str, optional): context variable name for instance metadata (default: "repeat_instance")
#
# ENHANCED REPEAT PATTERN (NESTED SEQUENTIAL)
# - type: parallel (required)
# - repeat (object, required): repeat configuration
#   - repeat.type: sequential (required): nested sequential pattern
#   - repeat.instances (int | str, required): number of instances or expression
#   - repeat.steps (list, required): sequence of agents to run for each instance
#   - repeat.instance_id_template (str, optional): template for instance IDs
#   - repeat.instance_context_key (str, optional): context variable name for instance metadata
#   - repeat.input_mapping (object, optional): global input mapping (applies to all agents in sequence)
#
# NOTES
# - Context model unchanged: each node writes to context.upstream[node_id]
# - Gates and outputs are configured in their respective sections below
#
# =============================================================================

nodes:
  - id: enhanced_math_repeater_folder_scanner
    config_file: "agents/enhanced_math_repeater_folder_scanner.yml"
  - id: enhanced_math_repeater_file_reader
    config_file: "agents/enhanced_math_repeater_file_reader.yml"
  - id: enhanced_math_repeater_problem_solver
    config_file: "agents/enhanced_math_repeater_problem_solver.yml"
  - id: enhanced_math_repeater_file_report_generator
    config_file: "agents/enhanced_math_repeater_file_report_generator.yml"
  - id: enhanced_math_repeater_final_report_generator
    config_file: "agents/enhanced_math_repeater_final_report_generator.yml"

pattern:
  type: sequential
  name: "Enhanced Math Problem File Processing Flow"
  description: |
    ## Enhanced Math Problem File Processing Flow
    
    This sequential pattern orchestrates the complete enhanced batch math problem-solving workflow:
    1. **Folder Scanner** scans a folder for math problem files
    2. **Parallel File Processor** processes each file through a sequence (read → solve → report) concurrently
    3. **Final Report Generator** aggregates results from all files into a comprehensive report
    
    The enhanced repeat pattern enables nested sequential processing within parallel execution, allowing each file to be processed through a complete workflow while maintaining parallelism across files.
  steps:
    - node: enhanced_math_repeater_folder_scanner
    - type: parallel
      name: "Parallel File Processing"
      description: |
        ## Concurrent File Processing
        
        This parallel repeat pattern processes multiple math problem files concurrently:
        - Each file is processed through a complete sequence: read → solve → report
        - All file sequences run in parallel for maximum efficiency
        - Results from all files are collected for final aggregation
        
        The nested sequential pattern within each instance ensures proper ordering of read, solve, and report operations for each file.
      repeat:
        type: sequential  # Enhanced repeat pattern with nested sequential
        name: "File Processing Sequence"
        description: |
          ## Per-File Processing Workflow
          
          This nested sequential pattern processes a single file through the complete workflow:
          1. **File Reader** reads and parses problems from the file
          2. **Parallel Problem Solver** solves all problems in the file concurrently
          3. **File Report Generator** creates a report for this file's solutions
          
          This sequence runs for each file in parallel, ensuring proper ordering within each file while maintaining parallelism across files.
        instances: "enhanced_math_repeater_folder_scanner.file_count"
        instance_id_template: "file_{{index}}"
        instance_context_key: "file_instance"
        steps:
          - node: enhanced_math_repeater_file_reader
            input_mapping:
              file_path: "enhanced_math_repeater_folder_scanner.file_paths[index]"
              file_index: "index"
          - type: parallel
            name: "Parallel Problem Solver"
            description: |
              ## Concurrent Problem Solving
              
              This parallel repeat pattern solves all problems within a file concurrently:
              - Each problem is solved independently by a solver instance
              - All solvers run in parallel for maximum efficiency
              - Results are collected for the file report generator
            repeat:
              node: enhanced_math_repeater_problem_solver
              instances: "enhanced_math_repeater_file_reader.problem_count"
              input_mapping:
                problem_text: "enhanced_math_repeater_file_reader.problems[index]"
                problem_index: "index"
              instance_id_template: "{{node_id}}_{{index}}"
          - node: enhanced_math_repeater_file_report_generator
    - node: enhanced_math_repeater_final_report_generator

# =============================================================================
# HITL SECTION - Human-in-the-loop gates
# =============================================================================
#
# Human-in-the-Loop gates configuration (optional)
# Parameters:
# - gates (list[object], optional): human-in-the-loop pause points
#   - gates[].id (str, required): unique gate id
#   - gates[].type (str, required): "approval" | "input" | "selection"
#   - gates[].title (str, optional): UI title
#   - gates[].description (str, optional): UI description
#   - gates[].fields (list[object], optional): form fields for input gates
#   - gates[].options (list[object], optional): selection options for selection gates
#   - gates[].target_agents (list[str], optional): which agents receive this data
#   - gates[].context_key (str, optional): key to store data in context
#   - gates[].timeout_ms (int, optional): wait timeout; default 300000
#   - gates[].on_timeout (str, optional): "approve" | "reject" | "skip" | "default"
#
# =============================================================================

gates: []

# =============================================================================
# OUTPUTS CONFIGURATION
# =============================================================================
#
# Pipeline output configuration for final and intermediate results
#
# Parameters:
# - outputs.final (object, required): final pipeline output
#   - outputs.final.node (str, required): agent ID that produces final output
#   - outputs.final.selectors (list[str], optional): JSONPath selectors to extract specific fields
#   - outputs.final.transform (str, optional): transformation expression
# - outputs.intermediate (list[object], optional): intermediate outputs for debugging/monitoring
#   - outputs.intermediate[].node (str, required): agent ID that produces intermediate output
#   - outputs.intermediate[].selectors (list[str], optional): JSONPath selectors
#   - outputs.intermediate[].transform (str, optional): transformation expression
#
# =============================================================================

outputs:
  final:
    node: enhanced_math_repeater_final_report_generator
    selectors: 
      - final_report_md
      - error
    transform: "{{ value }}"

