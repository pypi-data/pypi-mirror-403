# =============================================================================
# PIPELINE CONFIGURATION
# =============================================================================
#
# Pipeline parameters:
# - name (str, required): human-readable pipeline name
# - description (str, required): detailed description of pipeline purpose
#
# =============================================================================

name: "Legal Contract Analyzer"
description: "A comprehensive multi-agent pipeline for analyzing legal contracts to extract key terms, identify risks, summarize obligations, and provide structured recommendations. Handles different contract types including employment agreements, service agreements, and NDAs."

# =============================================================================
# PIPELINE PATTERN CONFIGURATION
# =============================================================================
#
# Define the execution flow explicitly using one of three constructs:
#   - sequential: run children in order
#   - parallel: run children concurrently (wait_all)
#   - loop: repeat body up to max_iterations
#
# NODES REGISTRY (REQUIRED)
# - nodes (list[object], required)
#   - nodes[].id (str, required): agent identifier
#   - nodes[].config_file (str, required): path to agent configuration file (relative to config/)
#
# PATTERN (REQUIRED)
# - pattern (object, required): one of sequential | parallel | loop
#
# STEP (LEAF)
# - node (str, required): "agent_id"
#
# SEQUENTIAL
# - type: sequential (required)
# - steps: list of (step | pattern) (required, >=1)
#
# PARALLEL
# - type: parallel (required)
# - steps: list of (step | pattern) (required, >=1)
# - semantics: wait_all; first error fails the group (MVP defaults)
#
# LOOP
# - type: loop (required)
# - body: (step | sequential | parallel) (required)
# - max_iterations: int (required, >=1)
#
# NOTES
# - Context model unchanged: each node writes to context.upstream[node_id]
# - Gates and outputs are configured in their respective sections below
#
# =============================================================================

nodes:
  - id: legal_document_extractor
    config_file: "agents/legal_document_extractor.yml"
  - id: legal_classifier
    config_file: "agents/legal_classifier.yml"
  - id: legal_key_terms_extractor
    config_file: "agents/legal_key_terms_extractor.yml"
  - id: legal_risk_identifier
    config_file: "agents/legal_risk_identifier.yml"
  - id: legal_obligation_summarizer
    config_file: "agents/legal_obligation_summarizer.yml"
  - id: legal_critical_clause_identifier
    config_file: "agents/legal_critical_clause_identifier.yml"
  - id: legal_recommendation_generator
    config_file: "agents/legal_recommendation_generator.yml"

pattern:
  type: sequential
  name: "Legal Contract Analysis Flow"
  description: |
    ## Legal Contract Analysis Flow
    
    This sequential pattern orchestrates the complete legal contract analysis workflow:
    1. **Upload Gate** allows user to upload the contract document
    2. **Document Extractor** extracts text and structure from the contract
    3. **Classifier** identifies the contract type (employment, service, NDA, etc.)
    4. **Classification Review Gate** allows human review of classification
    5. **Parallel Analysis** runs key terms extraction, risk identification, and obligation summarization concurrently
    6. **Critical Clause Identifier** identifies critical clauses requiring attention
    7. **Analysis Review Gate** allows human review of complete analysis
    8. **Recommendation Generator** provides structured recommendations
    
    The workflow ensures thorough analysis through parallel processing while maintaining human oversight at key decision points.
  steps:
    - gate: legal_upload_contract
      on_submit: continue
      on_cancel: stop
    - node: legal_document_extractor
    - node: legal_classifier
    - gate: legal_review_classification
      on_approve: continue
      on_reject: stop
    - type: parallel
      name: "Parallel Contract Analysis"
      description: |
        ## Concurrent Analysis Execution
        
        This parallel pattern performs comprehensive contract analysis concurrently:
        - **Key Terms Extractor** identifies and extracts important contract terms
        - **Risk Identifier** identifies potential risks and red flags
        - **Obligation Summarizer** summarizes contractual obligations for all parties
        
        All three analyses run simultaneously to maximize efficiency while providing comprehensive coverage.
      steps:
        - node: legal_key_terms_extractor
        - node: legal_risk_identifier
        - node: legal_obligation_summarizer
    - node: legal_critical_clause_identifier
    - gate: legal_review_analysis
      on_approve: continue
      on_reject: stop
    - node: legal_recommendation_generator
# =============================================================================
# HITL SECTION - Human-in-the-loop gates
# =============================================================================
#
# Human-in-the-Loop gates configuration (optional)
# Parameters:
# - gates (list[object], optional): human-in-the-loop pause points
#   - gates[].id (str, required): unique gate id
#   - gates[].type (str, required): "approval" | "input" | "selection"
#   - gates[].title (str, optional): UI title
#   - gates[].description (str, optional): UI description
#   - gates[].fields (list[object], optional): form fields for input gates
#   - gates[].options (list[object], optional): selection options for selection gates
#   - gates[].target_agents (list[str], optional): which agents receive this data
#   - gates[].context_key (str, optional): key to store data in context
#   - gates[].timeout_ms (int, optional): wait timeout; default 300000
#   - gates[].on_timeout (str, optional): "approve" | "reject" | "skip" | "default"
#
# =============================================================================

gates:
  - id: legal_upload_contract
    type: input
    title: "Upload Contract Document"
    description: "Please upload the contract document for analysis. Supported formats: PDF, DOCX, TXT."
    fields:
      - name: contract_file
        label: "Contract Document"
        type: file
        required: true
        validation:
          file_types: ["pdf", "docx", "txt"]
          max_size_mb: 10
    buttons:
      submit:
        label: "UPLOAD"
        description: "Upload document and proceed"
      cancel:
        label: "CANCEL"
        description: "Cancel and stop"
    context_key: "uploaded_contract_file"
    timeout_ms: 300000
    on_timeout: default
    default: stop

  - id: legal_review_classification
    type: approval
    title: "Review Contract Classification"
    description: "Review the contract type classification and provide approval to proceed with analysis."
    timeout_ms: 30000
    on_timeout: approve

  - id: legal_review_analysis
    type: approval
    title: "Review Contract Analysis"
    description: "Review the complete contract analysis including key terms, risks, obligations, and critical clauses before generating recommendations."
    timeout_ms: 60000
    on_timeout: approve

# =============================================================================
# OUTPUTS SECTION - Intermediate and Final Outputs
# =============================================================================
#
# Output configuration for pipeline results
# Parameters:
# - intermediate (list[object], optional): intermediate outputs during execution
#   - intermediate[].id (str, required): unique output identifier
#   - intermediate[].node (str, required): which node's output to capture
#   - intermediate[].selectors (list[str], required): JSON keys/paths to extract
#   - intermediate[].transform (str, optional): Jinja2 expression for transformation
# - final (object, required): final pipeline output
#   - final.node (str, required): which node's output to use as final result
#   - final.selectors (list[str], required): JSON keys/paths to extract
#   - final.transform (str, optional): Jinja2 expression for transformation
#
# =============================================================================

outputs:
  final:
    node: legal_recommendation_generator
    selectors:
      - final_report_md
      - recommendations
      - summary
      - error
    transform: "{{ value }}"

