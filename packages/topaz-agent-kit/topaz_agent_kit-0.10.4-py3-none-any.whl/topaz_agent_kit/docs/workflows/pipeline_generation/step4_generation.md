# Step 4: File Generation

This step generates all configuration files, prompts, icons, and updates existing files.

## Prerequisites

‚úÖ Step 1-3 complete with explicit user confirmation to proceed

---

## 4.0 Pre-Generation Checks

Before generating files, verify:

- [ ] Base path confirmed (default: `src/topaz_agent_kit/templates/starters/ensemble/`)
- [ ] Pipeline ID unique (no conflicts)
- [ ] All agent IDs unique (no conflicts)
- [ ] Pattern structure validated
- [ ] Dependencies validated

---

## 4.1 Generate Pipeline Config

**File**: `{base_path}/config/pipelines/{pipeline_id}.yml`

### Pipeline Config Template

```yaml
# Pipeline: {Pipeline Name}
# Generated by Pipeline Generation Workflow

id: "{pipeline_id}"
name: "{Pipeline Name}"
description: "{Pipeline description}"
version: "1.0.0"

# Execution Settings (if async HITL enabled)
execution_settings:
  hitl_mode: "async"              # "sync" (default) or "async"
  checkpoint_expiry_days: 7       # How long checkpoints remain valid

# Case Management (if async HITL enabled)
case_management:
  config_file: "cases/{pipeline_id}.yml"
  tracking_variables:            # Optional: customize variable names
    hitl_queued: "hitl_queued_cases"
    completed: "completed_cases"

# Execution Pattern
pattern:
  type: {sequential|parallel|loop|switch|handoff|group_chat}
  name: "{Pattern Name}"
  description: |
    {Pattern description}
  steps:
    - {agent_id_1}
    - {agent_id_2}
    # ... or nested patterns

# Agent References
agents:
  - {agent_id_1}
  - {agent_id_2}
  # ... all agents in this pipeline

# HITL Gates (if any)
hitl:
  - id: "{gate_id}"
    type: "{approval|input|selection}"
    after: "{agent_id}"  # or "start"
    title: "{Gate Title}"
    description_template: "config/hitl/{gate_id}.jinja"
    # ... gate-specific configuration

# Output Configuration
outputs:
  - source: "{final_agent_id}"
    fields: ["*"]  # or specific fields
    # transform: null
```

### 4.1.1 Async HITL Configuration (if applicable)

**If async HITL is enabled**, generate case configuration file:

**File**: `{base_path}/config/cases/{pipeline_id}.yml`

```yaml
# Case type for categorization
case_type: "{case_type}"

# Identity configuration - how to identify cases
identity:
  prefix: "{CASE_PREFIX}"         # Case ID prefix (e.g., "CASE", "MATH")
  uniqueness: "uuid_suffix"        # "uuid_suffix" (default), "timestamp", or "none"

# Detail view - what to show in case detail panel
detail_view:
  sections:
    - id: "{section_id}"
      title: "{Section Title}"
      source_agent: "{agent_id}"
      fields:
        - source: "{agent_id}.field"
          label: "{Field Label}"
          type: text  # text, multiline, number, boolean, list, object
```

**Reference**: See `reference_hitl.md` for detailed async HITL configuration.

### Checklist
- [ ] Pipeline ID matches filename
- [ ] All agent IDs match agent config files
- [ ] Pattern structure is valid
- [ ] HITL gates reference existing agents
- [ ] Output source is valid agent
- [ ] Async HITL config present (if async mode selected)
- [ ] Case management config file created (if async HITL enabled)

---

## 4.2 Generate Agent Configs

**Files**: `{base_path}/config/agents/{agent_id}.yml` (one per agent)

### Agent Config Template

```yaml
# Agent: {Agent Display Name}
# Pipeline: {pipeline_id}

id: "{agent_id}"
name: "{Agent Display Name}"
description: "{Agent description}"
framework: "agno"  # or crewai, langgraph, adk, oak, sk, maf

# Model Configuration
model:
  provider: "azure"
  model_name: "gpt-4o"
  temperature: 0.7

# Prompt Template
prompt_template: "config/prompts/{agent_id}.jinja"

# Expected Output (optional but recommended)
expected_output: |
  {Description of what this agent should output}

# MCP Tools (if any)
mcp_tools:
  - toolkit: "{toolkit_name}"
    tools: ["{tool_1}", "{tool_2}"]

# Local Tools (if any)
local_tools:
  modules:
    - "tools.{pipeline_id}.{module_name}"
  toolkits: ["{toolkit_name}"]
  tools: ["{toolkit_name}.*"]

# Remote Configuration (always included for flexibility)
remote:
  protocol: "a2a"
  enabled: false  # or true if running remotely initially
```

### 4.2.1 Model Configuration

**Default Model Config**:
```yaml
model:
  provider: "azure"
  model_name: "gpt-4o"
  temperature: 0.7
```

**Alternative Providers**:
- `openai` - OpenAI direct
- `google` - Google AI (Gemini)
- `anthropic` - Anthropic (Claude)

### 4.2.2 Remote Configuration (MANDATORY)

**üîç CRITICAL**: ALL agents MUST include `remote` configuration, even if running locally.

**Required Structure**:
```yaml
# =============================================================================
# REMOTE EXECUTION CONFIGURATION
# =============================================================================
#
# Remote service configuration for agent-to-agent communication.
# If this section is present, the agent supports remote execution and will be
# available as a service for other agents to call via A2A protocols.
#
# Remote parameters:
# - url (str, required): A2A protocol endpoint URL
# - timeout (int, optional): request timeout in milliseconds; default 30000
# - retry_attempts (int, optional): number of retry attempts for failed requests; default 3
#
# =============================================================================
remote:
  url: http://127.0.0.1:8100/{agent_id}
  timeout: 30000
  retry_attempts: 3
```

**Why Mandatory**:
- Enables easy switching between local and remote execution
- Required for A2A protocol support
- Allows agents to be called remotely in the future without config changes

**URL Format**: `http://127.0.0.1:8100/{agent_id}` (standard A2A endpoint pattern)

### 4.2.3 MCP Server Configuration

**üîç CRITICAL**: When configuring MCP servers, all fields are required.

**Required Structure**:
```yaml
# =============================================================================
# MCP (MODEL CONTEXT PROTOCOL) CONFIGURATION
# =============================================================================
#
# MCP configuration for external tool access.
# If this section is present, the agent has access to MCP tools that provide
# external capabilities like web search, data gathering, etc.
#
# MCP parameters:
# - servers (list[object], required): list of MCP servers to connect to
#   - servers[].url (str, required): MCP server URL (must be provided, no hardcoded fallbacks)
#   - servers[].toolkits (list[str], required): list of toolkits available on this server
#   - servers[].tools (list[str], required): list of tools to use from this server
#     - Supports wildcard patterns: "math.*" (all math tools), "*.evaluate_*" (all evaluate tools)
#     - Supports exact tool names: "math.addition", "browser.scrape_website"
#
# =============================================================================
mcp:
  servers:
    - url: "http://localhost:8050/mcp"
      toolkits: ["doc_extract"]
      tools: ["doc_extract.*"]
```

**Example 1: Document Extraction**:
```yaml
mcp:
  servers:
    - url: "http://localhost:8050/mcp"
      toolkits: ["doc_extract"]
      tools: ["doc_extract.*"]  # All doc_extract tools
```

**Example 2: Multiple Toolkits**:
```yaml
mcp:
  servers:
    - url: "http://localhost:8050/mcp"
      toolkits: ["doc_extract", "web_search"]
      tools: 
        - "doc_extract.*"        # All doc_extract tools
        - "web_search.search"    # Specific web_search tool
```

**Example 3: Multiple Servers**:
```yaml
mcp:
  servers:
    - url: "http://localhost:8050/mcp"
      toolkits: ["doc_extract"]
      tools: ["doc_extract.*"]
    - url: "http://localhost:8051/mcp"
      toolkits: ["math"]
      tools: ["math.*"]
```

**Example 4: No MCP Tools (Empty Array)**:
```yaml
mcp:
  servers: []  # No MCP servers configured
```

**Common Mistakes to Avoid**:
- ‚ùå **Missing url**: `servers: [{ toolkits: ["doc_extract"], tools: ["doc_extract.*"] }]`
- ‚ùå **Missing toolkits**: `servers: [{ url: "http://localhost:8050/mcp", tools: ["doc_extract.*"] }]`
- ‚ùå **Missing tools**: `servers: [{ url: "http://localhost:8050/mcp", toolkits: ["doc_extract"] }]`
- ‚ùå **Invalid URL format**: `url: "localhost:8050/mcp"` (must include http:// or https://)
- ‚úÖ **Correct**: All three fields (url, toolkits, tools) must be present and valid

### Checklist per Agent
- [ ] Agent ID follows naming convention (`{prefix}_{role}`)
- [ ] Prompt template path is correct
- [ ] **Remote config is present** (mandatory for all agents)
- [ ] **Remote config has url, timeout, retry_attempts**
- [ ] MCP servers configured correctly (if needed): url, toolkits, tools all present
- [ ] MCP tools are valid toolkit names
- [ ] Local tools module path exists (if using local tools)
- [ ] Model configuration is valid

---

## 4.3 Generate Prompt Templates

**Files**: `{base_path}/config/prompts/{agent_id}.jinja` (one per agent)

### 4.3.0 Context Variable Access Rules

**Critical Rules**:
1. Agents can ONLY access outputs from **upstream** agents
2. Pattern descriptions rendered BEFORE agents execute
3. Use explicit syntax `{{agent_id.field}}` for clarity
4. Variables from user input available as `{{user_input}}`

**Variable Sources**:
| Source | Syntax | Example |
|--------|--------|---------|
| User input | `{{user_input}}` | User's message |
| Upstream agent | `{{agent_id.field}}` | `{{extractor.document_text}}` |
| Loop item | `{{loop_item_key}}` | `{{current_claim}}` |
| Project directory | `{{project_dir}}` | For file paths |

### Prompt Template Structure

Reference `reference_jinja.md` for detailed Jinja2 syntax.

```jinja
You are a **{Agent Role}** responsible for {agent purpose}.

---

**Tasks:**
1. {Task 1 description}
2. {Task 2 description}
3. {Task 3 description}

---

**Notes:**
- {Important note 1}
- {Important note 2}

---

**Instructions:**
- Return STRICT JSON ONLY (no trailing commas, no comments)
- {Tool usage hints if MCP tools available}
- {Error handling expectations}

---

**Input:**
{%- if user_input %}
**User Request:** {{ user_input }}
{%- endif %}

{%- if upstream_agent.field %}
**Previous Analysis:** {{ upstream_agent.field }}
{%- endif %}

---

**Output Format (STRICT JSON ONLY, no trailing commas, no comments):**
```json
{
  "field_1": "<description>",
  "field_2": "<description>",
  "error": "<string error message or empty string if none>"
}
```

---

**‚úÖ Example Successful Output:**
```json
{
  "field_1": "example value",
  "field_2": "example value",
  "error": ""
}
```

---

**‚ùå Example Error Output:**
```json
{
  "field_1": null,
  "field_2": null,
  "error": "Description of what went wrong"
}
```
```

### 4.3.1 Prompt Quality Validation

**Checklist per prompt**:
- [ ] Clear role definition
- [ ] Numbered task list
- [ ] Output format specification with JSON schema
- [ ] At least one example successful output
- [ ] Error output example (if applicable)
- [ ] All variable references are valid (upstream agents exist)
- [ ] Proper Jinja2 syntax (no bare `{%` without control)

### 4.3.2 Path Resolution for File and Database Operations

**üîç CRITICAL**: When agents need to access files or databases, they **MUST** use `project_dir` for absolute paths.

**Why This Is Required**:
- MCP tools (`sqlite_query`, `sqlite_execute`, `fs_listdir`, `fs_move_file`) require **absolute paths**
- Relative paths like `"data/ag/ag_database.db"` will fail with "file not found" errors
- The `project_dir` variable contains the absolute path to the project root

**Required Pattern**:

**1. Always pass `project_dir` in agent YML inputs**:
```yaml
prompt:
  inputs:
    inline: |
      - User Request: {{user_text}}
      - Project Directory: {{project_dir}}
```

**2. Instruct agents to resolve paths in the prompt**:
```jinja
Notes:
- **Database Path Resolution**: Resolve as `"<project_dir>/data/{pipeline_id}/{db_name}.db"` 
  where `project_dir` is the absolute path provided in the input.
- **Always use absolute paths** when calling `sqlite_query`.
```

**3. Include path resolution in Instructions section**:
```jinja
Instructions:
- **Path Resolution**: 
  - Read the **Project Directory** from input (absolute path to project root).
  - Resolve database path as `"<Project Directory>/data/{pipeline_id}/{db_name}.db"`.
  - **Always use absolute paths** when calling `sqlite_query` or `fs_*` tools.
```

**When to Apply This Pattern**:
- ‚úÖ **Database operations**: `sqlite_query`, `sqlite_execute`, `sqlite_schema`
- ‚úÖ **File operations**: `fs_listdir`, `fs_move_file`, `fs_makedirs`, `fs_delete`
- ‚úÖ **Document operations**: Any agent referencing file paths
- ‚ùå **Not needed**: Agents that only process text/data without file system access

**Example: Database Path Resolution**:
```jinja
Tasks:
1. Read the **project directory path** from input (absolute path to project root).
2. Resolve **database path** as `"<project_dir>/data/claims/claims_database.db"`.
3. Use `sqlite_query` with the resolved absolute database path.
```

**Example: File Path Resolution**:
```jinja
Tasks:
1. Read the **project directory path** from input.
2. Resolve **folder path** as `"<project_dir>/data/invoices"`.
3. Use `fs_listdir` with the resolved absolute path.
```

**Common Mistakes to Avoid**:
- ‚ùå **Wrong**: `"Database path: projects/ensemble/data/ag/ag_database.db (relative)"`
- ‚úÖ **Correct**: `"Resolve as '<project_dir>/data/ag/ag_database.db' (absolute)"`
- ‚ùå **Wrong**: Not passing `project_dir` in agent YML inputs
- ‚úÖ **Correct**: Include `- Project Directory: {{project_dir}}` in `inputs.inline`

**Checklist**:
- [ ] Agent YML includes `- Project Directory: {{project_dir}}` in `inputs.inline`
- [ ] Prompt includes path resolution instructions in Notes section
- [ ] Prompt includes path resolution in Instructions section
- [ ] Prompt explicitly states to use absolute paths in tool calls
- [ ] Examples show absolute paths, not relative paths

---

## 4.4 Generate UI Manifest

**File**: `{base_path}/config/ui_manifests/{pipeline_id}.yml`

### UI Manifest Template

```yaml
# UI Manifest: {Pipeline Name}

title: "{Pipeline Name}"
subtitle: "{Pipeline description}"

agents:
  - id: "{agent_id_1}"
    title: "{Agent Display Name}"  # WITHOUT pipeline prefix
    subtitle: "{Agent description}"
    icon: "assets/{agent_id_1}.svg"
  
  - id: "{agent_id_2}"
    title: "{Agent Display Name}"
    subtitle: "{Agent description}"
    icon: "assets/{agent_id_2}.svg"
  # ... all agents

interaction_diagram: "assets/{pipeline_id}_workflow.svg"
```

### Agent Title Format

**Important**: Agent titles should be human-readable WITHOUT pipeline prefix:
- Agent ID: `article_research_analyst` ‚Üí Title: "Research Analyst"
- Agent ID: `contract_analyzer_extractor` ‚Üí Title: "Extractor"

### Checklist
- [ ] Title and subtitle match pipeline config
- [ ] All agents listed with correct IDs
- [ ] Agent titles are human-readable (no prefix)
- [ ] Icon paths match generated icon files
- [ ] Interaction diagram path is correct

---

## 4.5 Generate SVG Icons

**Files**: 
- `{base_path}/ui/static/assets/{pipeline_id}.svg` (pipeline icon)
- `{base_path}/ui/static/assets/{agent_id}.svg` (one per agent)

### SVG Icon Generation

**Generate actual SVG files** for the pipeline and all agents.

Reference `reference_icons.md` for templates and guidelines.

### SVG Base Template

```xml
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <!-- Icon content here -->
</svg>
```

### Common Icon Elements

**Document/File**:
```xml
<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
<polyline points="14 2 14 8 20 8"/>
```

**Search/Analysis**:
```xml
<circle cx="11" cy="11" r="8"/>
<path d="m21 21-4.3-4.3"/>
```

**Checkmark/Validation**:
```xml
<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
<polyline points="22 4 12 14.01 9 11.01"/>
```

**Email/Message**:
```xml
<rect width="20" height="16" x="2" y="4" rx="2"/>
<path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
```

**Brain/Intelligence**:
```xml
<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 4.44-1.04"/>
<path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-4.44-1.04"/>
```

### Role-Based Icon Selection

| Agent Role | Icon Concept | Elements |
|------------|--------------|----------|
| Extractor | Download/Document | Arrow down + document |
| Analyzer | Magnifying glass | Circle + line |
| Classifier | Tags/Layers | Stacked shapes |
| Validator | Checkmark | Check in circle |
| Generator | Wand/Sparkles | Star burst |
| Reviewer | Eye | Eye shape |
| Aggregator | Merge | Converging arrows |
| Drafter | Pen | Pen tip |

### Checklist
- [ ] Pipeline icon generated
- [ ] All agent icons generated
- [ ] All icons use 24x24 viewBox
- [ ] All icons use `stroke="currentColor"`
- [ ] File names match agent IDs exactly

---

## 4.6 Update Main Config Files

### 4.6.1 Update pipeline.yml

**File**: `{base_path}/config/pipeline.yml`

**Add entry**:
```yaml
pipelines:
  # ... existing pipelines
  - id: {pipeline_id}
    config_file: "pipelines/{pipeline_id}.yml"
```

### 4.6.2 Update ui_manifest.yml

**File**: `{base_path}/config/ui_manifest.yml`

**Add entry**:
```yaml
pipelines:
  # ... existing pipelines
  - id: "{pipeline_id}"
    title: "{Pipeline Name}"
    subtitle: "{Pipeline description}"
    ui_manifest: "ui_manifests/{pipeline_id}.yml"
    icon: "assets/{pipeline_id}.svg"
```

### 4.6.3 Update Assistant Classification Prompt

**File**: `{base_path}/config/prompts/assistant_intent_classifier.jinja`

**Add pipeline entry** to the "Pipelines:" section:
```jinja
- `{pipeline_id}`: {Brief description of what the pipeline does}
```

**Location**: Around line 36-45, in alphabetical or logical order.

### Checklist
- [ ] Entry added to pipeline.yml
- [ ] Entry added to ui_manifest.yml
- [ ] Entry added to assistant_intent_classifier.jinja
- [ ] All paths and IDs are consistent

---

## 4.7 User Review: Generated Files

**üîç CHECKPOINT**: Review generated files with user.

### File Summary

Present list of all generated files:

```
## Generated Files Summary

### New Files Created
1. `config/pipelines/{pipeline_id}.yml`
2. `config/agents/{agent_id_1}.yml`
3. `config/agents/{agent_id_2}.yml`
   ... (all agents)
4. `config/prompts/{agent_id_1}.jinja`
5. `config/prompts/{agent_id_2}.jinja`
   ... (all prompts)
6. `config/hitl/{gate_id}.jinja` (if any)
   ... (all HITL templates)
7. `config/ui_manifests/{pipeline_id}.yml`
8. `ui/static/assets/{pipeline_id}.svg`
9. `ui/static/assets/{agent_id_1}.svg`
   ... (all icons)

### Updated Files
1. `config/pipeline.yml` - Added pipeline entry
2. `config/ui_manifest.yml` - Added UI manifest entry
3. `config/prompts/assistant_intent_classifier.jinja` - Added to pipeline list
```

### Questions to Ask

- "Would you like to review any specific file contents?"
- "Are there any changes needed to the generated files?"
- "Should we proceed to validation?"

---

## Proceed to Step 5

After user confirms generated files, proceed to:
‚Üí `step5_validation.md`

