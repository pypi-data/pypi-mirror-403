# =============================================================================
# PIPELINE CONFIGURATION
# =============================================================================
#
# Pipeline parameters:
# - name (str, required): human-readable pipeline name
# - description (str, required): detailed description of pipeline purpose
#
# =============================================================================

name: "Claim Processor"
description: "Claim Processor is an end-to-end agentic workflow that processes insurance claims by analyzing the claim documents, validating against policy documents, presenting the case to the claim adjuster and generating an email draft for the claim adjuster."

# =============================================================================
# PIPELINE PATTERN CONFIGURATION
# =============================================================================
#
# Define the execution flow explicitly using one of three constructs:
#   - sequential: run children in order
#   - parallel: run children concurrently (wait_all)
#   - loop: repeat body up to max_iterations
#
# NODES REGISTRY (REQUIRED)
# - nodes (list[object], required)
#   - nodes[].id (str, required): agent identifier
#   - nodes[].config_file (str, required): path to agent configuration file (relative to config/)
#
# PATTERN (REQUIRED)
# - pattern (object, required): one of sequential | parallel | loop
#
# STEP (LEAF)
# - node (str, required): "agent_id"
#
# SEQUENTIAL
# - type: sequential (required)
# - steps: list of (step | pattern) (required, >=1)
#
# PARALLEL
# - type: parallel (required)
# - steps: list of (step | pattern) (required, >=1)
# - semantics: wait_all; first error fails the group (MVP defaults)
#
# LOOP
# - type: loop (required)
# - body: (step | sequential | parallel) (required)
# - max_iterations: int (required, >=1)
#
# NOTES
# - Context model unchanged: each node writes to context.upstream[node_id]
# - Gates and outputs are configured in their respective sections below
#
# =============================================================================

nodes:
  - id: claim_document_extractor
    config_file: "agents/claim_document_extractor.yml"
  - id: claim_policy_validator
    config_file: "agents/claim_policy_validator.yml"
  - id: claim_case_presenter
    config_file: "agents/claim_case_presenter.yml"
  - id: claim_email_drafter
    config_file: "agents/claim_email_drafter.yml"

pattern:
  type: sequential
  name: "Claim Processing Flow"
  description: |
    ## Claim Processing Flow
    
    This sequential pattern orchestrates the complete insurance claim processing workflow:
    1. **Document Extractor** extracts and analyzes claim documents
    2. **Policy Validator** validates the claim against policy documents
    3. **Case Presenter** presents the case analysis to the claim adjuster
    4. **Approval Gate** allows the adjuster to review and approve the case
    5. **Email Drafter** generates an email draft for the claim adjuster
    
    The workflow ensures thorough document analysis, policy validation, and human oversight before generating the final email communication.
  steps:
    - node: claim_document_extractor
    - node: claim_policy_validator
    - node: claim_case_presenter
    - gate: approve_claim
      on_approve: continue
      on_reject: stop
    - node: claim_email_drafter
# =============================================================================
# HITL SECTION - Human-in-the-loop gates
# =============================================================================
#
# Human-in-the-Loop gates configuration (optional)
# Parameters:
# - gates (list[object], optional): human-in-the-loop pause points
#   - gates[].id (str, required): unique gate id
#   - gates[].type (str, required): "approval" | "input" | "selection"
#   - gates[].title (str, optional): UI title
#   - gates[].description (str, optional): UI description
#   - gates[].fields (list[object], optional): form fields for input gates
#   - gates[].options (list[object], optional): selection options for selection gates
#   - gates[].target_agents (list[str], optional): which agents receive this data
#   - gates[].context_key (str, optional): key to store data in context
#   - gates[].timeout_ms (int, optional): wait timeout; default 300000
#   - gates[].on_timeout (str, optional): "approve" | "reject" | "skip" | "default"
#
# =============================================================================

gates:
  - id: approve_claim
    type: approval
    title: "Review Claim Case and Approve"
    description:
      jinja: "hitl/claim_processor_approve_claim.jinja"
    timeout_ms: 30000
    on_timeout: approve

# =============================================================================
# OUTPUTS SECTION - Intermediate and Final Outputs
# =============================================================================
#
# Output configuration for pipeline results
# Parameters:
# - intermediate (list[object], optional): intermediate outputs during execution
#   - intermediate[].id (str, required): unique output identifier
#   - intermediate[].node (str, required): which node's output to capture
#   - intermediate[].selectors (list[str], required): JSON keys/paths to extract
#   - intermediate[].transform (str, optional): Jinja2 expression for transformation
# - final (object, required): final pipeline output
#   - final.node (str, required): which node's output to use as final result
#   - final.selectors (list[str], required): JSON keys/paths to extract
#   - final.transform (str, optional): Jinja2 expression for transformation
#
# =============================================================================

outputs:
  final:
    node: claim_email_drafter
    selectors:
      - final_email_md
      - error
    transform: "{{ value }}"
