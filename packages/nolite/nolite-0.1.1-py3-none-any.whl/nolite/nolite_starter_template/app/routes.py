"""
Application Routes

This file defines the URL routes for your application and the logic that
handles requests to those routes.
"""

# Import the main application object and the database instance
from . import app, db

# Import the database models
from .models import User

# Import the reusable layout
from .layout import main_layout

# Import Nolite components
from nolite.components import Container, H1, P, Code, Ul, Li, Strong

# Route Definitions


# Use the @app.route() decorator to create a new page
@app.route("/")
def index():
    """
    This function is called when a user navigates to the root URL ('/').
    It queries the database, displays the results, and returns a rendered page.
    """

    # Database Interaction
    # Query the database to get all users.
    all_users = User.query.all()

    # If the database is empty, create a default user for demonstration.
    if not all_users:
        default_user = User(username="admin", email="admin")
        db.session.add(default_user)
        db.session.commit()
        all_users = User.query.all()

    # Page Content
    # Create a list of components from our database query results.
    user_list_items = [
        Li(children=[Strong(children=[user.username]), f" - {user.email}"])
        for user in all_users
    ]

    page_content = Container(
        children=[
            H1(children=["Welcome to Your Full-Stack Nolite App!"]),
            P(
                children=[
                    "This page is dynamically generated by querying a SQLite database. ",
                    "A default user was created for you automatically.",
                ]
            ),
            P(
                children=[
                    "You can define your database schema in ",
                    Code(children=["app/models.py"]),
                    " and build your pages here in ",
                    Code(children=["app/routes.py"]),
                    ".",
                ]
            ),
            Ul(margin_top=20, children=user_list_items),
        ]
    )

    # Use the reusable layout to render the final page
    return main_layout(children=[page_content], title="Nolite Starter App")
