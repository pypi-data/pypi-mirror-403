"""
Contains constants variables to support CoDICE processing.

Notes
-----
The ``plan_id``, ``plan_step``, and ``view_id`` mentioned in this module are
derived from the packet data.

Some notable acronyms:
SW = SunWard
NSW = Non-SunWard
PUI = PickUp Ion
ESA = ElectroStatic Analyzer
"""

from typing import Any

import numpy as np

from imap_processing.codice.utils import CODICEAPID, CoDICECompression

# -------L1A Constants-------
# Numerical constants
SPIN_PERIOD_CONVERSION = 0.00032
K_FACTOR = 5.76  # This is used to convert voltages to energies in L2
NUM_ESA_STEPS = 128
LO_DESPIN_SPIN_SECTORS = 24
MAX_DE_EVENTS_PER_PACKET = 10000

# Define the packet fields needed to be stored in segmented data and their
# corresponding bit lengths for I-ALiRT data products
IAL_BIT_STRUCTURE = {
    "SHCOARSE": 32,
    "PACKET_VERSION": 16,
    "SPIN_PERIOD": 16,
    "ACQ_START_SECONDS": 32,
    "ACQ_START_SUBSECONDS": 20,
    "SPARE_00": 8,
    "ST_BIAS_GAIN_MODE": 2,
    "SW_BIAS_GAIN_MODE": 2,
    "TABLE_ID": 32,
    "PLAN_ID": 16,
    "PLAN_STEP": 4,
    "VIEW_ID": 4,
    "RGFO_HALF_SPIN": 6,
    "NSO_HALF_SPIN": 6,
    "SPARE_01": 1,
    "SUSPECT": 1,
    "COMPRESSION": 3,
    "BYTE_COUNT": 23,
}

LO_IALIRT_VARIABLE_NAMES = [
    "heplusplus",
    "cplus5",
    "cplus6",
    "oplus6",
    "oplus7",
    "oplus8",
    "mg",
    "fe_loq",
    "fe_hiq",
]
HI_IALIRT_VARIABLE_NAMES = ["h"]
# Mass over charge (AMU/e)
# Section 13.2 of Algorithm Document.
LO_IALIRT_M_OVER_Q = {
    "heplusplus": 2.0,
    "cplus5": 2.4,
    "cplus6": 2.0,
    "oplus6": 2.7,
    "oplus7": 2.28,
    "oplus8": 2.0,
    "mg": 3.5,
    "fe_loq": 3.85,
    "fe_hiq": 7.25,
}

HI_IALIRT_ELEVATION_ANGLE = np.array(
    [
        132.8,
        65.7,
        47.1,
        114.3,
    ],
    dtype=np.float32,
)
HI_IALIRT_REF_SPIN_ANGLE = np.array(
    [
        286.85,
        264.55,
        343.16,
        5.44,
    ],
    dtype=float,
)

# Define the packet fields needed to be stored in segmented data and their
# corresponding bit lengths for direct event data products
DE_METADATA_FIELDS = {
    "packet_version": 16,
    "spin_period": 16,
    "acq_start_seconds": 32,
    "acq_start_subseconds": 20,
    "spare_1": 2,
    "st_bias_gain_mode": 2,
    "sw_bias_gain_mode": 2,
    "priority": 4,
    "suspect": 1,
    "compressed": 1,
    "num_events": 32,
    "byte_count": 32,
}

# Various configurations to support processing of direct events data products
# These are described in the algorithm document in chapter 10 ("Data Level 1A")
DE_DATA_PRODUCT_CONFIGURATIONS: dict[Any, dict[str, Any]] = {
    CODICEAPID.COD_HI_PHA: {
        "num_priorities": 6,
        "bit_structure": {
            "ssd_energy": {
                "bit_length": 11,
                "dtype": np.uint16,
                "fillval": np.iinfo(np.uint16).max,
            },
            "tof": {
                "bit_length": 10,
                "dtype": np.uint16,
                "fillval": np.iinfo(np.uint16).max,
            },
            "ssd_id": {
                "bit_length": 4,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "gain": {
                "bit_length": 2,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "multi_flag": {
                "bit_length": 1,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "type": {
                "bit_length": 2,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "spin_sector": {
                "bit_length": 5,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "spin_number": {
                "bit_length": 4,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "priority": {
                "bit_length": 3,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "spare": {
                "bit_length": 22,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
        },
    },
    CODICEAPID.COD_LO_PHA: {
        "num_priorities": 8,
        "bit_structure": {
            "gain": {
                "bit_length": 1,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "apd_id": {
                "bit_length": 5,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "position": {
                "bit_length": 5,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "apd_energy": {
                "bit_length": 9,
                "dtype": np.uint16,
                "fillval": np.iinfo(np.uint16).max,
            },
            "tof": {
                "bit_length": 10,
                "dtype": np.uint16,
                "fillval": np.iinfo(np.uint16).max,
            },
            "multi_flag": {
                "bit_length": 1,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "type": {
                "bit_length": 2,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "spin_sector": {
                "bit_length": 5,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "energy_step": {
                "bit_length": 7,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "priority": {
                "bit_length": 3,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
            "spare": {
                "bit_length": 16,
                "dtype": np.uint8,
                "fillval": np.iinfo(np.uint8).max,
            },
        },
    },
}

# Compression ID lookup tables
# The key is the view_id and the value is the ID for the compression algorithm
# (see utils.CoDICECompression to see how the values correspond)
# These are defined in the "Views" tab of the "*-SCI-LUT-*.xml" spreadsheet that
# largely defines CoDICE processing.
LO_COMPRESSION_ID_LOOKUP = {
    0: CoDICECompression.PACK_24_BIT,
    1: CoDICECompression.LOSSY_B_LOSSLESS,
    2: CoDICECompression.LOSSY_B_LOSSLESS,
    3: CoDICECompression.LOSSY_A_LOSSLESS,
    4: CoDICECompression.LOSSY_A_LOSSLESS,
    5: CoDICECompression.LOSSY_A_LOSSLESS,
    6: CoDICECompression.LOSSY_A_LOSSLESS,
    7: CoDICECompression.LOSSY_A_LOSSLESS,
    8: CoDICECompression.LOSSY_A_LOSSLESS,
}
HI_COMPRESSION_ID_LOOKUP = {
    0: CoDICECompression.LOSSY_A,
    1: CoDICECompression.LOSSY_A,
    2: CoDICECompression.LOSSY_A,
    3: CoDICECompression.LOSSY_B_LOSSLESS,
    4: CoDICECompression.LOSSY_B_LOSSLESS,
    5: CoDICECompression.LOSSY_A_LOSSLESS,
    6: CoDICECompression.LOSSY_A_LOSSLESS,
    7: CoDICECompression.LOSSY_A_LOSSLESS,
    8: CoDICECompression.LOSSY_A_LOSSLESS,
    9: CoDICECompression.LOSSY_A_LOSSLESS,
}

# Lookup tables for Lossy decompression algorithms "A" and "B"
# These were provided by Greg Dunn via his sohis_cdh_utils.v script and then
# transformed into python dictionaries. The values in these tables are subject
# to change, but the format is expected to stay the same.
LOSSY_A_TABLE = {
    0: 0,
    1: 1,
    2: 2,
    3: 3,
    4: 4,
    5: 5,
    6: 6,
    7: 7,
    8: 8,
    9: 9,
    10: 10,
    11: 11,
    12: 12,
    13: 13,
    14: 14,
    15: 15,
    16: 16,
    17: 17,
    18: 18,
    19: 19,
    20: 20,
    21: 21,
    22: 22,
    23: 23,
    24: 24,
    25: 25,
    26: 26,
    27: 27,
    28: 28,
    29: 29,
    30: 30,
    31: 31,
    32: 32,
    33: 34,
    34: 36,
    35: 38,
    36: 40,
    37: 42,
    38: 44,
    39: 46,
    40: 48,
    41: 50,
    42: 52,
    43: 54,
    44: 56,
    45: 58,
    46: 60,
    47: 62,
    48: 65,
    49: 69,
    50: 73,
    51: 77,
    52: 81,
    53: 85,
    54: 89,
    55: 93,
    56: 97,
    57: 101,
    58: 105,
    59: 109,
    60: 113,
    61: 117,
    62: 121,
    63: 125,
    64: 131,
    65: 139,
    66: 147,
    67: 155,
    68: 163,
    69: 171,
    70: 179,
    71: 187,
    72: 195,
    73: 203,
    74: 211,
    75: 219,
    76: 227,
    77: 235,
    78: 243,
    79: 251,
    80: 263,
    81: 279,
    82: 295,
    83: 311,
    84: 327,
    85: 343,
    86: 359,
    87: 375,
    88: 391,
    89: 407,
    90: 423,
    91: 439,
    92: 455,
    93: 471,
    94: 487,
    95: 503,
    96: 527,
    97: 559,
    98: 591,
    99: 623,
    100: 655,
    101: 687,
    102: 719,
    103: 751,
    104: 783,
    105: 815,
    106: 847,
    107: 879,
    108: 911,
    109: 943,
    110: 975,
    111: 1007,
    112: 1055,
    113: 1119,
    114: 1183,
    115: 1247,
    116: 1311,
    117: 1375,
    118: 1439,
    119: 1503,
    120: 1567,
    121: 1631,
    122: 1695,
    123: 1759,
    124: 1823,
    125: 1887,
    126: 1951,
    127: 2015,
    128: 2111,
    129: 2239,
    130: 2367,
    131: 2495,
    132: 2623,
    133: 2751,
    134: 2879,
    135: 3007,
    136: 3135,
    137: 3263,
    138: 3391,
    139: 3519,
    140: 3647,
    141: 3775,
    142: 3903,
    143: 4031,
    144: 4223,
    145: 4479,
    146: 4735,
    147: 4991,
    148: 5247,
    149: 5503,
    150: 5759,
    151: 6015,
    152: 6271,
    153: 6527,
    154: 6783,
    155: 7039,
    156: 7295,
    157: 7551,
    158: 7807,
    159: 8063,
    160: 8447,
    161: 8959,
    162: 9471,
    163: 9983,
    164: 10495,
    165: 11007,
    166: 11519,
    167: 12031,
    168: 12543,
    169: 13055,
    170: 13567,
    171: 14079,
    172: 14591,
    173: 15103,
    174: 15615,
    175: 16127,
    176: 16895,
    177: 17919,
    178: 18943,
    179: 19967,
    180: 20991,
    181: 22015,
    182: 23039,
    183: 24063,
    184: 25087,
    185: 26111,
    186: 27135,
    187: 28159,
    188: 29183,
    189: 30207,
    190: 31231,
    191: 32255,
    192: 33791,
    193: 35839,
    194: 37887,
    195: 39935,
    196: 41983,
    197: 44031,
    198: 46079,
    199: 48127,
    200: 50175,
    201: 52223,
    202: 54271,
    203: 56319,
    204: 58367,
    205: 60415,
    206: 62463,
    207: 64511,
    208: 67583,
    209: 71679,
    210: 75775,
    211: 79871,
    212: 83967,
    213: 88063,
    214: 92159,
    215: 96255,
    216: 100351,
    217: 104447,
    218: 108543,
    219: 112639,
    220: 116735,
    221: 120831,
    222: 124927,
    223: 129023,
    224: 135167,
    225: 143359,
    226: 151551,
    227: 159743,
    228: 167935,
    229: 176127,
    230: 184319,
    231: 192511,
    232: 200703,
    233: 208895,
    234: 217087,
    235: 225279,
    236: 233471,
    237: 241663,
    238: 249855,
    239: 258047,
    240: 270335,
    241: 286719,
    242: 303103,
    243: 319487,
    244: 335871,
    245: 352255,
    246: 368639,
    247: 385023,
    248: 401407,
    249: 417791,
    250: 434175,
    251: 450559,
    252: 466943,
    253: 483327,
    254: 499711,
    255: 2147737599,
}

LOSSY_B_TABLE = {
    0: 0,
    1: 1,
    2: 2,
    3: 3,
    4: 4,
    5: 5,
    6: 6,
    7: 7,
    8: 8,
    9: 9,
    10: 10,
    11: 11,
    12: 12,
    13: 13,
    14: 14,
    15: 15,
    16: 16,
    17: 17,
    18: 18,
    19: 19,
    20: 20,
    21: 21,
    22: 22,
    23: 23,
    24: 24,
    25: 25,
    26: 26,
    27: 27,
    28: 28,
    29: 29,
    30: 30,
    31: 31,
    32: 32,
    33: 34,
    34: 36,
    35: 38,
    36: 40,
    37: 42,
    38: 44,
    39: 46,
    40: 48,
    41: 50,
    42: 52,
    43: 54,
    44: 56,
    45: 58,
    46: 60,
    47: 62,
    48: 65,
    49: 69,
    50: 73,
    51: 77,
    52: 81,
    53: 85,
    54: 89,
    55: 93,
    56: 97,
    57: 101,
    58: 105,
    59: 109,
    60: 113,
    61: 117,
    62: 121,
    63: 125,
    64: 131,
    65: 139,
    66: 147,
    67: 155,
    68: 163,
    69: 171,
    70: 179,
    71: 187,
    72: 195,
    73: 203,
    74: 211,
    75: 219,
    76: 227,
    77: 235,
    78: 243,
    79: 251,
    80: 263,
    81: 279,
    82: 295,
    83: 311,
    84: 327,
    85: 343,
    86: 359,
    87: 375,
    88: 391,
    89: 407,
    90: 423,
    91: 439,
    92: 455,
    93: 471,
    94: 487,
    95: 503,
    96: 527,
    97: 559,
    98: 591,
    99: 623,
    100: 655,
    101: 687,
    102: 719,
    103: 751,
    104: 783,
    105: 815,
    106: 847,
    107: 879,
    108: 911,
    109: 943,
    110: 975,
    111: 1007,
    112: 1055,
    113: 1119,
    114: 1183,
    115: 1247,
    116: 1311,
    117: 1375,
    118: 1439,
    119: 1503,
    120: 1567,
    121: 1631,
    122: 1695,
    123: 1759,
    124: 1823,
    125: 1887,
    126: 1951,
    127: 2015,
    128: 2111,
    129: 2239,
    130: 2367,
    131: 2495,
    132: 2623,
    133: 2751,
    134: 2879,
    135: 3007,
    136: 3135,
    137: 3263,
    138: 3391,
    139: 3519,
    140: 3647,
    141: 3775,
    142: 3903,
    143: 4031,
    144: 4223,
    145: 4479,
    146: 4735,
    147: 4991,
    148: 5247,
    149: 5503,
    150: 5759,
    151: 6015,
    152: 6271,
    153: 6527,
    154: 6783,
    155: 7039,
    156: 7295,
    157: 7551,
    158: 7807,
    159: 8063,
    160: 8447,
    161: 8959,
    162: 9471,
    163: 9983,
    164: 10495,
    165: 11007,
    166: 11519,
    167: 12031,
    168: 12543,
    169: 13055,
    170: 13567,
    171: 14079,
    172: 14591,
    173: 15103,
    174: 15615,
    175: 16127,
    176: 16895,
    177: 17919,
    178: 18943,
    179: 19967,
    180: 20991,
    181: 22015,
    182: 23039,
    183: 24063,
    184: 25087,
    185: 26111,
    186: 27135,
    187: 28159,
    188: 29183,
    189: 30207,
    190: 31231,
    191: 32255,
    192: 34815,
    193: 38911,
    194: 43007,
    195: 47103,
    196: 51199,
    197: 55295,
    198: 59391,
    199: 63487,
    200: 69631,
    201: 77823,
    202: 86015,
    203: 94207,
    204: 102399,
    205: 110591,
    206: 118783,
    207: 126975,
    208: 139263,
    209: 155647,
    210: 172031,
    211: 188415,
    212: 204799,
    213: 221183,
    214: 237567,
    215: 253951,
    216: 278527,
    217: 311295,
    218: 344063,
    219: 376831,
    220: 409599,
    221: 442367,
    222: 475135,
    223: 507903,
    224: 557055,
    225: 622591,
    226: 688127,
    227: 753663,
    228: 819199,
    229: 884735,
    230: 950271,
    231: 1015807,
    232: 1114111,
    233: 1245183,
    234: 1376255,
    235: 1507327,
    236: 1638399,
    237: 1769471,
    238: 1900543,
    239: 2031615,
    240: 2228223,
    241: 2490367,
    242: 2752511,
    243: 3014655,
    244: 3276799,
    245: 3538943,
    246: 3801087,
    247: 4063231,
    248: 4456447,
    249: 4980735,
    250: 5505023,
    251: 6029311,
    252: 6553599,
    253: 7077887,
    254: 7602175,
    255: 2151415807,
}

# ------L1B Constants------
HI_ACQUISITION_TIME = 0.59916

# TODO: in the future, read from sci-lut
LO_SW_ANGULAR_VARIABLE_NAMES = ["hplus", "heplusplus", "oplus6", "fe_loq"]
LO_NSW_ANGULAR_VARIABLE_NAMES = ["heplusplus"]
LO_SW_PRIORITY_VARIABLE_NAMES = [
    "p0_tcrs",
    "p1_hplus",
    "p2_heplusplus",
    "p3_heavies",
    "p4_dcrs",
]
LO_NSW_PRIORITY_VARIABLE_NAMES = ["p5_heavies", "p6_hplus_heplusplus"]
LO_SW_SPECIES_VARIABLE_NAMES = [
    "hplus",
    "heplusplus",
    "cplus4",
    "cplus5",
    "cplus6",
    "oplus5",
    "oplus6",
    "oplus7",
    "oplus8",
    "ne",
    "mg",
    "si",
    "fe_loq",
    "fe_hiq",
    "heplus",
    "cnoplus",
]
LO_COUNTERS_AGGREGATED_VARIABLE_NAMES = [
    "tcr",
    "dcr",
    "sta",
    "stb",
    "sp",
    "total_position_count",
]
HI_COUNTERS_AGGREGATED_VARIABLE_NAMES = [
    "dcr",
    "mst",
    "starts_only",
    "stops_only",
    "singles_starts",
    "singles_stops",
    "low_tof_cutoff",
]
LO_COUNTERS_SINGLES_VARIABLE_NAMES = ["apd_singles"]
HI_COUNTERS_SINGLES_VARIABLE_NAMES = ["tcr", "ssdo", "stssd"]
# Various configurations to support L1b processing of individual data products
# Much of these are described in the algorithm document in chapter 11 ("Data
# Level 1B")
L1B_DATA_PRODUCT_CONFIGURATIONS: dict[str, dict] = {
    "hi-counters-aggregated": {
        "num_spin_sectors": 24,
        "num_spins": 16,
    },
    "hi-counters-singles": {
        "num_spin_sectors": 24,
        "num_spins": 16,
    },
    "hi-ialirt": {
        "num_spin_sectors": 6,
        "num_spins": 4,
    },
    "hi-omni": {
        "num_spin_sectors": 24,
        "num_spins": 4,
    },
    "hi-priority": {
        "num_spin_sectors": 24,
        "num_spins": 16,
    },
    "hi-sectored": {
        "num_spin_sectors": 2,
        "num_spins": 16,
    },
    "lo-counters-aggregated": {
        "num_spin_sectors": 2,
    },
    "lo-counters-singles": {
        "num_spin_sectors": 2,
    },
    "lo-nsw-angular": {
        "num_spin_sectors": 1,
    },
    "lo-sw-angular": {
        "num_spin_sectors": 1,
    },
    "lo-nsw-priority": {
        "num_spin_sectors": 1,
    },
    "lo-sw-priority": {
        "num_spin_sectors": 1,
    },
    "lo-nsw-species": {
        "num_spin_sectors": 12,
    },
    "lo-sw-species": {
        "num_spin_sectors": 12,
    },
    "lo-ialirt": {
        "num_spin_sectors": 12,
    },
}

# ------L2 Constants------
LO_SW_SOLAR_WIND_SPECIES_VARIABLE_NAMES = [
    "hplus",
    "heplusplus",
    "cplus4",
    "cplus5",
    "cplus6",
    "oplus5",
    "oplus6",
    "oplus7",
    "oplus8",
    "ne",
    "mg",
    "si",
    "fe_loq",
    "fe_hiq",
]
LO_SW_PICKUP_ION_SPECIES_VARIABLE_NAMES = [
    "heplus",
    "cnoplus",
]
LO_NSW_SPECIES_VARIABLE_NAMES = [
    "hplus",
    "heplusplus",
    "c",
    "o",
    "ne_si_mg",
    "fe",
    "heplus",
    "cnoplus",
]
HI_OMNI_VARIABLE_NAMES = ["h", "he3", "he4", "c", "o", "ne_mg_si", "fe", "uh", "junk"]
HI_SECTORED_VARIABLE_NAMES = ["h", "he3he4", "cno", "fe"]
HI_PRIORITY_VARIABLE_NAMES = [
    "priority0",
    "priority1",
    "priority2",
    "priority3",
    "priority4",
    "priority5",
]

NSW_POSITIONS = [x for x in range(3, 22)]
SW_POSITIONS = [0, 1, 2, 22, 23]
SOLAR_WIND_POSITIONS = [0]
PUI_POSITIONS = SW_POSITIONS
IALIRT_HI_NUMBER_OF_SSD_PER_GROUP = 3.0

L2_HI_SECTORED_ANGLE = np.array(
    [
        285.00,
        244.11,
        228.69,
        225.00,
        228.69,
        244.11,
        285.00,
        325.89,
        341.31,
        345.00,
        341.31,
        325.89,
    ]
)

HI_L2_ELEVATION_ANGLE = np.array(
    [
        150.0,
        138.6,
        115.7,
        90.0,
        64.3,
        41.4,
        30.0,
        41.4,
        64.3,
        90.0,
        115.7,
        138.6,
    ],
    dtype=float,
)


LO_POSITION_TO_ELEVATION_ANGLE = {
    "sw": {
        1: 0,
        2: 15,
        24: 15,
        3: 30,
        23: 30,
    },
    "nsw": {
        4: 45,
        22: 45,
        5: 60,
        21: 60,
        6: 75,
        20: 75,
        7: 90,
        19: 90,
        8: 105,
        18: 105,
        9: 120,
        17: 120,
        10: 135,
        16: 135,
        11: 150,
        15: 150,
        12: 165,
        14: 165,
        13: 180,
    },
}

# SSD ID to Elevation Angle
# The index corresponds to the SSD ID. Missing SSD IDs are represented with np.nan.
SSD_ID_TO_ELEVATION = np.array(
    [
        150.0,
        138.6,
        np.nan,
        115.7,
        90.0,
        64.3,
        np.nan,
        41.4,
        30.0,
        41.4,
        np.nan,
        64.3,
        90.0,
        115.7,
        np.nan,
        138.6,
    ]
)

# gain lookup table
GAIN_ID_TO_STR = {1: "LG", 2: "MG", 3: "HG"}

# SSD ID to Spin Angle (degrees)
# The index corresponds to the SSD ID. Missing SSD IDs are represented with np.nan.
SSD_ID_TO_SPIN_ANGLE = np.array(
    [
        277.50,
        236.61,
        np.nan,
        221.19,
        217.5,
        221.19,
        np.nan,
        236.61,
        277.50,
        318.39,
        np.nan,
        333.81,
        337.50,
        333.81,
        np.nan,
        318.39,
    ]
)

HALF_SPIN_FILLVAL = 63
