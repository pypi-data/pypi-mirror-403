const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./cloudRemoteConfig-DjeQS72v.js","./dialogService-BJDTj7su.js","./_plugin-vue_export-helper-Ckv1EJQX.js","./rolldown-runtime-BKYq3fBv.js","./vendor-primevue-Cg-HmKZY.js","./vendor-other-BQ5HftVH.js","./vendor-three-J548ptDO.js","./vendor-tiptap-B3MquJdf.js","./vendor-vue-J4jYbuLn.js","./vendor-other-CaaUC6Qe.css","./vendor-reka-ui-C5bN2j5U.js","./vendor-xterm-CLifWSRJ.js","./vendor-xterm-kHJ-D0s7.css","./PanelTemplate-B87Qym7Z.js","./api-Dwy4NIr-.js","./i18n-iveDrznX.js","./widget-D00AxrDc.js","./colorUtil-DZPpB8qI.js","./tailwindUtil-B1qIgpoz.js","./Button-B4OHW57I.js","./Slider-IryJc9AU.js","./useErrorHandling-D82ZFYUs.js","./remoteConfig-CyTTjg6h.js","./userStore-C65Cn7r8.js","./widgetTypes-B2p76Yu_.js","./markdownRendererUtil-cjiB75V3.js","./dialogService-DwOUltBv.css","./refreshRemoteConfig-DL7sZqZW.js","./cloudBadges-CDe4CnGP.js","./cloudSessionCookie-DHmD9o2l.js","./cloudSubscription-pq2NQAVm.js","./cloudFeedbackTopbarButton-CXYTaYnw.js","./config-mtTya6dB.js","./nightlyBadges-tOJJ2jwF.js"])))=>i.map(i=>d[i]);
import{i as e,n as t,o as n}from"./rolldown-runtime-BKYq3fBv.js";import{Nn as r,Zr as i,bn as a,gr as o,yn as s}from"./vendor-primevue-Cg-HmKZY.js";import{Ct as c,i as l,pt as u,r as d,wt as f}from"./vendor-other-BQ5HftVH.js";import{$t as p,A as ee,D as te,Et as ne,Ht as re,L as ie,M as ae,O as oe,R as se,T as ce,Tt as le,an as m,at as ue,dn as de,fn as fe,i as h,in as g,k as _,ln as pe,on as me,ot as he,r as v,sn as ge,un as _e,v as y,wt as b,x,y as S}from"./api-Dwy4NIr-.js";import{r as C,s as w}from"./i18n-iveDrznX.js";import{D as ve,N as ye,P as be,x as xe,y as Se}from"./PanelTemplate-B87Qym7Z.js";import{$r as Ce,Ai as we,Bt as Te,Ct as Ee,Ei as T,Fi as De,Ga as Oe,Go as ke,Gt as E,Ha as Ae,Ht as je,Ii as Me,Jr as Ne,Ka as Pe,Kt as Fe,Li as Ie,Lt as D,Mi as Le,Ni as Re,Oi as ze,Pi as Be,Q as Ve,Qr as He,Rt as O,St as k,Ti as Ue,Ua as We,Uo as Ge,Ut as Ke,Va as A,Wa as qe,Wo as Je,Wt as Ye,X as Xe,Xo as Ze,Yr as Qe,Zo as j,_s as $e,ai as et,at as M,bi as N,bt as tt,cn as nt,co as rt,da as it,do as at,ei as ot,es as st,fo as ct,ft as lt,go as ut,gt as dt,ho as ft,ht as pt,ii as P,it as F,ki as mt,lo as I,mo as ht,mt as gt,n as L,ni as R,nn as _t,ns as vt,po as yt,ps as bt,pt as xt,qa as St,qt as Ct,ri as wt,rn as Tt,rt as z,sn as Et,t as Dt,ti as Ot,ua as kt,uo as At,wi as jt,xi as B,xt as Mt}from"./dialogService-BJDTj7su.js";import{n as Nt,t as Pt}from"./Load3D-CpyfQQQj.js";import{i as Ft,n as V,r as It}from"./audioUtils-BEJ0QtX_.js";import{n as H,t as Lt}from"./audioService-CwgMV-pB.js";var U,Rt=t((()=>{M(),We(),U=class ClipspaceDialog extends Ae{static items=[];static instance=null;static registerButton(e,t,n){let r=A(`button`,{type:`button`,textContent:e,contextPredicate:t,onclick:n});ClipspaceDialog.items.push(r)}static invalidatePreview(){if(z.clipspace&&z.clipspace.imgs&&z.clipspace.imgs.length>0){let e=document.getElementById(`clipspace_preview`);e&&(e.src=z.clipspace.imgs[z.clipspace.selectedIndex].src,e.style.maxHeight=`100%`,e.style.maxWidth=`100%`)}}static invalidate(){if(ClipspaceDialog.instance){let e=ClipspaceDialog.instance,t=e.createImgSettings(),n=A(`div.comfy-modal-content`,[...t?[t]:[],...e.createButtons()]);e.element?(e.element.firstChild&&e.element.removeChild(e.element.firstChild),e.element.appendChild(n)):e.element=A(`div.comfy-modal`,{parent:document.body},[n]),e.element.children[0].children.length<=1&&e.element.children[0].appendChild(A(`p`,{},[`Unable to find the features to edit content of a format stored in the current Clipspace.`])),ClipspaceDialog.invalidatePreview()}}constructor(){super()}createButtons(){let e=[];for(let t in ClipspaceDialog.items){let n=ClipspaceDialog.items[t];(!n.contextPredicate||n.contextPredicate())&&e.push(ClipspaceDialog.items[t])}return e.push(A(`button`,{type:`button`,textContent:`Close`,onclick:()=>{this.close()}})),e}createImgSettings(){if(z.clipspace?.imgs){let e=[],t=z.clipspace.imgs;for(let n=0;n<t.length;n++)e.push(A(`option`,{value:n},[`${n}`]));let n=A(`select`,{id:`clipspace_img_selector`,onchange:e=>{e.target&&z.clipspace&&(z.clipspace.selectedIndex=e.target.selectedIndex,ClipspaceDialog.invalidatePreview())}},e),r=A(`tr`,{},[A(`td`,{},[A(`font`,{color:`white`},[`Select Image`])]),A(`td`,{},[n])]),i=A(`select`,{id:`clipspace_img_paste_mode`,onchange:e=>{e.target&&z.clipspace&&(z.clipspace.img_paste_mode=e.target.value)}},[A(`option`,{value:`selected`},`selected`),A(`option`,{value:`all`},`all`)]);return i.value=z.clipspace.img_paste_mode,A(`table`,{},[r,A(`tr`,{},[A(`td`,{},[A(`font`,{color:`white`},[`Paste Mode`])]),A(`td`,{},[i])]),A(`tr`,{},[A(`td`,{align:`center`,width:`100px`,height:`100px`,colSpan:`2`},[A(`img`,{id:`clipspace_preview`,ondragstart:()=>!1},[])])])])}else return null}createImgPreview(){return z.clipspace?.imgs?A(`img`,{id:`clipspace_preview`,ondragstart:()=>!1}):null}show(){ClipspaceDialog.invalidate(),this.element.style.display=`block`}},F.registerExtension({name:`Comfy.Clipspace`,init(){F.openClipspace=function(){U.instance||(U.instance=new U,z.clipspace_invalidate_handler=U.invalidate),z.clipspace?U.instance.show():F.ui.dialog.show(`Clipspace is Empty!`)}}}),window.comfyAPI=window.comfyAPI||{},window.comfyAPI.clipspace=window.comfyAPI.clipspace||{},window.comfyAPI.clipspace.ClipspaceDialog=U})),zt=t((()=>{S(),M(),F.registerExtension({name:`Comfy.ContextMenuFilter`,init(){let e=y.ContextMenu;y.ContextMenu=function(t,n){let r=new e(t,n);if(n?.className===`dark`&&t?.length>4){let e=document.createElement(`input`);e.classList.add(`comfy-context-menu-filter`),e.placeholder=`Filter list`,r.root.prepend(e);let i=Array.from(r.root.querySelectorAll(`.litemenu-entry`)),a=[...i],o=a.length;requestAnimationFrame(()=>{let s=x.active_canvas.current_node?.widgets?.filter(e=>ae(e)&&e.options.values?.length===t.length).find(e=>e.options.values?.every((e,n)=>e===t[n]))?.value,c=s?t.findIndex(e=>e===s):0;c<0&&(c=0);let l=a[c];updateSelected();function updateSelected(){l?.style.setProperty(`background-color`,``),l?.style.setProperty(`color`,``),l=a[c],l?.style.setProperty(`background-color`,`#ccc`,`important`),l?.style.setProperty(`color`,`#000`,`important`)}let positionList=()=>{if(r.root.getBoundingClientRect().top<0){let e=1-r.root.getBoundingClientRect().height/r.root.clientHeight,t=r.root.clientHeight*e/2;r.root.style.top=-t+`px`}};e.addEventListener(`keydown`,e=>{switch(e.key){case`ArrowUp`:e.preventDefault(),c===0?c=o-1:c--,updateSelected();break;case`ArrowRight`:e.preventDefault(),c=o-1,updateSelected();break;case`ArrowDown`:e.preventDefault(),c===o-1?c=0:c++,updateSelected();break;case`ArrowLeft`:e.preventDefault(),c=0,updateSelected();break;case`Enter`:l?.click();break;case`Escape`:r.close();break}}),e.addEventListener(`input`,()=>{let t=e.value.toLocaleLowerCase();if(a=i.filter(e=>{let n=!t||e.textContent?.toLocaleLowerCase().includes(t);return e.style.display=n?`block`:`none`,n}),c=0,a.includes(l)&&(c=a.findIndex(e=>e===l)),o=a.length,updateSelected(),n.event){let e=n.event.clientY-10,t=document.body.getBoundingClientRect(),i=r.root.getBoundingClientRect();t.height&&e>t.height-i.height-10&&(e=Math.max(0,t.height-i.height-10)),r.root.style.top=e+`px`,positionList()}}),requestAnimationFrame(()=>{e.focus(),positionList()})})}return r},y.ContextMenu.prototype=e.prototype}})}));function applyToGraph(e=[]){if(!this.outputs[0].links?.length||!this.graph)return;let t=[...this.outputs[0].links.map(e=>this.graph.links[e]),...e],n=this.widgets?.[0].value;for(let e of t){let t=this.graph?.getNodeById(e.target_id),r=t?.inputs[e.target_slot];if(!r){console.warn(`Unable to resolve node or input for link`,e);continue}let i=r.widget?.name;if(!i){console.warn(`Invalid widget or widget name`,r.widget);continue}let a=t.widgets?.find(e=>e.name===i);if(!a){console.warn(`Unable to find widget "${i}" on node [${t.id}]`);continue}a.value=n,a.callback?.(a.value,F.canvas,t,F.canvas.graph_mouse,{})}}function onCustomComboCreated(){this.applyToGraph=applyToGraph;let e=this.widgets[0],t=i([]);e.options.values=t;let updateCombo=()=>{t.splice(0,t.length,...this.widgets.filter(e=>e.name.startsWith(`option`)&&e.value).map(e=>`${e.value}`)),!F.configuringGraph&&(t.includes(`${e.value}`)||(e.value=t[0]??``,e.callback?.(e.value)))};e.callback=j(e.callback,()=>this.applyToGraph());function addOption(e){if(!e.widgets)return;let t=e.widgets.length-1;e.addWidget(`string`,`option${t}`,``,()=>{});let n=e.widgets.at(-1);if(!n)return;let r=``;Object.defineProperty(n,`value`,{get(){return r},set(t){if(r=t,updateCombo(),!e.widgets)return;let n=e.widgets.at(-1);if(n===this){t&&addOption(e);return}t||e.widgets.at(-2)!==this||n?.value||(e.widgets.pop(),e.computeSize(e.size),this.callback(t))}})}let n=this.widgets;n.push({name:`index`,type:`hidden`,get value(){return n.slice(2).findIndex(t=>t.value===e.value)},set value(e){},draw:()=>void 0,computeSize:()=>[0,-4],options:{hidden:!0},y:0}),addOption(this)}function onCustomIntCreated(){let e=this.widgets?.[0];e&&(Object.defineProperty(e.options,`min`,{get:()=>this.properties.min??-(2**63),set:t=>{this.properties.min=t,e.callback?.(e.value)}}),Object.defineProperty(e.options,`max`,{get:()=>this.properties.max??2**63,set:t=>{this.properties.max=t,e.callback?.(e.value)}}),Object.defineProperty(e.options,`step2`,{get:()=>this.properties.step??1,set:t=>{this.properties.step=t,e.callback?.(e.value)}}))}function onCustomFloatCreated(){let e=this.widgets?.[0];e&&(Object.defineProperty(e.options,`min`,{get:()=>this.properties.min??-1/0,set:t=>{this.properties.min=t,e.callback?.(e.value)}}),Object.defineProperty(e.options,`max`,{get:()=>this.properties.max??1/0,set:t=>{this.properties.max=t,e.callback?.(e.value)}}),Object.defineProperty(e.options,`precision`,{get:()=>this.properties.precision??1,set:t=>{this.properties.precision=t,e.callback?.(e.value)}}),Object.defineProperty(e.options,`step2`,{get:()=>{if(this.properties.step)return this.properties.step;let{precision:e}=this.properties;return typeof e==`number`?5*10**-e:1},set:e=>this.properties.step=e}),Object.defineProperty(e.options,`round`,{get:()=>{if(this.properties.round)return this.properties.round;let{precision:e}=this.properties;return typeof e==`number`?10**-e:.1},set:t=>{this.properties.round=t,e.callback?.(e.value)}}))}var Bt=t((()=>{r(),Ze(),ee(),S(),M(),F.registerExtension({name:`Comfy.CustomWidgets`,beforeRegisterNodeDef(e,t){t?.name===`CustomCombo`?e.prototype.onNodeCreated=j(e.prototype.onNodeCreated,onCustomComboCreated):t?.name===`PrimitiveInt`?e.prototype.onNodeCreated=j(e.prototype.onNodeCreated,onCustomIntCreated):t?.name===`PrimitiveFloat`&&(e.prototype.onNodeCreated=j(e.prototype.onNodeCreated,onCustomFloatCreated))}})})),Vt=t((()=>{N(),Se(),B().registerExtension({name:`Comfy.DynamicPrompts`,nodeCreated(e){if(e.widgets){let t=e.widgets.filter(e=>e.dynamicPrompts);for(let e of t)e.serializeValue=(t,n)=>{if(typeof e.value!=`string`)return e.value;let r=ve(e.value);return t?.widgets_values&&(t.widgets_values[n]=r),r}}}})})),Ht=t((()=>{M(),F.registerExtension({name:`Comfy.EditAttention`,init(){let e=F.ui.settings.addSetting({id:`Comfy.EditAttention.Delta`,category:[`Comfy`,`EditTokenWeight`,`Delta`],name:`Ctrl+up/down precision`,type:`slider`,attrs:{min:.01,max:.5,step:.01},defaultValue:.05});function incrementWeight(e,t){let n=parseFloat(e);if(isNaN(n))return e;let r=n+t;return String(Number(r.toFixed(10)))}function findNearestEnclosure(e,t){let n=t,r=t,i=0,a=0;for(;n>=0&&(n--,!(e[n]===`(`&&i===a));)e[n]===`(`&&i++,e[n]===`)`&&a++;if(n<0)return null;for(i=0,a=0;r<e.length&&!(e[r]===`)`&&i===a);)e[r]===`(`&&i++,e[r]===`)`&&a++,r++;return r===e.length?null:{start:n+1,end:r}}function addWeightToParentheses(e){let t=e.match(/^\((.*)\)$/),n=e.match(/:([+-]?(\d*\.)?\d+([eE][+-]?\d+)?)/);return t&&!n?`(${t[1]}:1.0)`:e}function editAttention(t){let n=t.composedPath()[0],r=parseFloat(e.value);if(n.tagName!==`TEXTAREA`||!(t.key===`ArrowUp`||t.key===`ArrowDown`)||!t.ctrlKey&&!t.metaKey)return;t.preventDefault();let i=n.selectionStart,a=n.selectionEnd,o=n.value.substring(i,a);if(!o){let e=findNearestEnclosure(n.value,i);if(e)i=e.start,a=e.end,o=n.value.substring(i,a);else{let e=` .,\\/!?%^*;:{}=-_\`~()\r
	`;for(;!e.includes(n.value[i-1])&&i>0;)i--;for(;!e.includes(n.value[a])&&a<n.value.length;)a++;if(o=n.value.substring(i,a),!o)return}}o[o.length-1]===` `&&(o=o.substring(0,o.length-1),--a),n.value[i-1]===`(`&&n.value[a]===`)`&&(--i,a+=1,o=n.value.substring(i,a)),(o[0]!==`(`||o[o.length-1]!==`)`)&&(o=`(${o})`),o=addWeightToParentheses(o);let s=t.key===`ArrowUp`?r:-r,c=o.replace(/\((.*):([+-]?\d+(?:\.\d+)?)\)/,(e,t,n)=>(n=incrementWeight(n,s),n==1?t:`(${t}:${n})`));n.setSelectionRange(i,a),document.execCommand(`insertText`,!1,c),n.setSelectionRange(i,i+c.length)}window.addEventListener(`keydown`,editAttention)}})})),Ut,Wt=t((()=>{Ut={settingId:`Comfy-Desktop.UV.PythonInstallMirror`,mirror:`https://github.com/astral-sh/python-build-standalone/releases/download`,fallbackMirror:`https://python-standalone.org/mirror/astral-sh/python-build-standalone`,validationPathSuffix:`/20250115/cpython-3.10.16+20250115-aarch64-apple-darwin-debug-full.tar.zst.sha256`}})),checkMirrorReachable,Gt=t((()=>{de(),Se(),checkMirrorReachable=async e=>xe(e)&&await _e().NetWork.canAccessUrl(e)})),Kt,qt=t((()=>{Kt=n(u(),1),ye(),Wt(),C(),g(),Xe(),M(),Dt(),Gt(),de(),(async()=>{if(!fe())return;let e=_e(),t=await e.getElectronVersion(),n=Ve(),r=m(),{staticUrls:i,buildDocsUrl:a}=be(),onChangeRestartApp=(t,n)=>{n!==void 0&&t!==n&&e.restartApp(`Restart ComfyUI to apply changes.`,1500)};F.registerExtension({name:`Comfy.ElectronAdapter`,settings:[{id:`Comfy-Desktop.AutoUpdate`,category:[`Comfy-Desktop`,`General`,`AutoUpdate`],name:`Automatically check for updates`,type:`boolean`,defaultValue:!0,onChange:onChangeRestartApp},{id:`Comfy-Desktop.SendStatistics`,category:[`Comfy-Desktop`,`General`,`Send Statistics`],name:`Send anonymous usage metrics`,type:`boolean`,defaultValue:!0,onChange:onChangeRestartApp},{id:`Comfy-Desktop.WindowStyle`,category:[`Comfy-Desktop`,`General`,`Window Style`],name:`Window Style`,tooltip:`Custom: Replace the system title bar with ComfyUI's Top menu`,type:`combo`,experimental:!0,defaultValue:`default`,options:[`default`,`custom`],onChange:(t,n)=>{n&&e.Config.setWindowStyle(t)}},{id:`Comfy-Desktop.UV.PythonInstallMirror`,name:`Python Install Mirror`,tooltip:`Managed Python installations are downloaded from the Astral python-build-standalone project. This variable can be set to a mirror URL to use a different source for Python installations. The provided URL will replace https://github.com/astral-sh/python-build-standalone/releases/download in, e.g., https://github.com/astral-sh/python-build-standalone/releases/download/20240713/cpython-3.12.4%2B20240713-aarch64-apple-darwin-install_only.tar.gz. Distributions can be read from a local directory by using the file:// URL scheme.`,type:`url`,defaultValue:``,attrs:{validateUrlFn(e){return checkMirrorReachable(e+Ut.validationPathSuffix)}}},{id:`Comfy-Desktop.UV.PypiInstallMirror`,name:`Pypi Install Mirror`,tooltip:`Default pip install mirror`,type:`url`,defaultValue:``,attrs:{validateUrlFn:checkMirrorReachable}},{id:`Comfy-Desktop.UV.TorchInstallMirror`,name:`Torch Install Mirror`,tooltip:`Pip install mirror for pytorch`,type:`url`,defaultValue:``,attrs:{validateUrlFn:checkMirrorReachable}}],commands:[{id:`Comfy-Desktop.Folders.OpenLogsFolder`,label:`Open Logs Folder`,icon:`pi pi-folder-open`,function(){e.openLogsFolder()}},{id:`Comfy-Desktop.Folders.OpenModelsFolder`,label:`Open Models Folder`,icon:`pi pi-folder-open`,function(){e.openModelsFolder()}},{id:`Comfy-Desktop.Folders.OpenOutputsFolder`,label:`Open Outputs Folder`,icon:`pi pi-folder-open`,function(){e.openOutputsFolder()}},{id:`Comfy-Desktop.Folders.OpenInputsFolder`,label:`Open Inputs Folder`,icon:`pi pi-folder-open`,function(){e.openInputsFolder()}},{id:`Comfy-Desktop.Folders.OpenCustomNodesFolder`,label:`Open Custom Nodes Folder`,icon:`pi pi-folder-open`,function(){e.openCustomNodesFolder()}},{id:`Comfy-Desktop.Folders.OpenModelConfig`,label:`Open extra_model_paths.yaml`,icon:`pi pi-file`,function(){e.openModelConfig()}},{id:`Comfy-Desktop.OpenDevTools`,label:`Open DevTools`,icon:`pi pi-code`,function(){e.openDevTools()}},{id:`Comfy-Desktop.OpenUserGuide`,label:`Desktop User Guide`,icon:`pi pi-book`,function(){window.open(a(`/installation/desktop`,{includeLocale:!0,platform:!0}),`_blank`)}},{id:`Comfy-Desktop.CheckForUpdates`,label:`Check for Updates`,icon:`pi pi-sync`,async function(){try{let t=await e.checkForUpdates({disableUpdateReadyAction:!0});if(!t.isUpdateAvailable){r.add({severity:`info`,summary:w(`desktopUpdate.noUpdateFound`),life:5e3});return}if(await L().confirm({title:w(`desktopUpdate.updateFoundTitle`,{version:t.version}),message:w(`desktopUpdate.updateAvailableMessage`),type:`default`}))try{e.restartAndInstall()}catch(e){Kt.default.error(`Error installing update:`,e),r.add({severity:`error`,summary:w(`g.error`),detail:w(`desktopUpdate.errorInstallingUpdate`),life:1e4})}}catch(e){Kt.default.error(`Error checking for updates:`,e),r.add({severity:`error`,summary:w(`g.error`),detail:w(`desktopUpdate.errorCheckingUpdate`),life:1e4})}}},{id:`Comfy-Desktop.Reinstall`,label:`Reinstall`,icon:`pi pi-refresh`,async function(){await L().confirm({message:w(`desktopMenu.confirmReinstall`),title:w(`desktopMenu.reinstall`),type:`reinstall`})&&e.reinstall()}},{id:`Comfy-Desktop.Restart`,label:`Restart`,icon:`pi pi-refresh`,function(){e.restartApp()}},{id:`Comfy-Desktop.Quit`,label:`Quit`,icon:`pi pi-sign-out`,async function(){n.modifiedWorkflows.length>0&&!await L().confirm({message:w(`desktopMenu.confirmQuit`),title:w(`desktopMenu.quit`),type:`default`})||e.quit()}}],menuCommands:[{path:[`Help`],commands:[`Comfy-Desktop.OpenUserGuide`]},{path:[`Help`],commands:[`Comfy-Desktop.OpenDevTools`]},{path:[`Help`,`Open Folder`],commands:[`Comfy-Desktop.Folders.OpenLogsFolder`,`Comfy-Desktop.Folders.OpenModelsFolder`,`Comfy-Desktop.Folders.OpenOutputsFolder`,`Comfy-Desktop.Folders.OpenInputsFolder`,`Comfy-Desktop.Folders.OpenCustomNodesFolder`,`Comfy-Desktop.Folders.OpenModelConfig`]},{path:[`Help`],commands:[`Comfy-Desktop.CheckForUpdates`,`Comfy-Desktop.Reinstall`]}],keybindings:[{commandId:`Workspace.CloseWorkflow`,combo:{key:`w`,ctrl:!0}}],aboutPageBadges:[{label:`ComfyUI_desktop v`+t,url:i.githubElectron,icon:`pi pi-github`}]})})()})),ExecutableGroupNodeChildDTO,Jt=t((()=>{S(),ExecutableGroupNodeChildDTO=class extends te{groupNodeHandler;constructor(e,t,n,r,i){super(e,t,n,r),this.groupNodeHandler=i}resolveInput(e){if(this.id.split(`:`).length>2)throw Error(`Group nodes inside subgraphs are not supported. Please convert the group node to a subgraph instead.`);let t=this.node.getInputNode(e);if(!t)return;let n=this.node.getInputLink(e);if(!n)throw Error(`Failed to get input link`);let r=String(t.id),i=this.nodesByExecutionId?.get(r);if(!i){let e=r.split(`:`).at(-1);e!==void 0&&(i=this.nodesByExecutionId?.get(e))}if(!i)throw Error(`Failed to get input node ${r} for group node child ${this.id} with slot ${e}`);return{node:i,origin_id:r,origin_slot:n.origin_slot}}}})),Yt=t((()=>{}));function merge(e,t){for(let n in t){let r=t[n];if(typeof r==`object`&&r){let t=e[n];t||=e[n]={},merge(t,r)}else e[n]=r}return e}var W,ManageGroupDialog,Xt=t((()=>{ne(),S(),g(),M(),We(),Oe(),xt(),rn(),Yt(),W=Symbol(),ManageGroupDialog=class extends qe{tabs;selectedNodeIndex;selectedTab=`Inputs`;selectedGroup;modifications={};nodeItems;app;groupNodeType;groupData;innerNodesList;widgetsPage;inputsPage;outputsPage;draggable;get selectedNodeInnerIndex(){let e=this.selectedNodeIndex;if(e==null)throw Error(`No node selected`);let t=this.nodeItems[e];if(!t?.dataset.nodeindex)throw Error(`Invalid node item`);return+t.dataset.nodeindex}constructor(e){super(),this.app=e,this.element=A(`dialog.comfy-group-manage`,{parent:document.body})}changeTab(e){this.tabs[this.selectedTab].tab.classList.remove(`active`),this.tabs[this.selectedTab].page.classList.remove(`active`),this.tabs[e].tab.classList.add(`active`),this.tabs[e].page.classList.add(`active`),this.selectedTab=e}changeNode(e,t){!t&&this.selectedNodeIndex===e||(this.selectedNodeIndex!=null&&this.nodeItems[this.selectedNodeIndex].classList.remove(`selected`),this.nodeItems[e].classList.add(`selected`),this.selectedNodeIndex=e,!this.buildInputsPage()&&this.selectedTab===`Inputs`&&this.changeTab(`Widgets`),!this.buildWidgetsPage()&&this.selectedTab===`Widgets`&&this.changeTab(`Outputs`),!this.buildOutputsPage()&&this.selectedTab===`Outputs`&&this.changeTab(`Inputs`),this.changeTab(this.selectedTab))}getGroupData(){this.groupNodeType=y.registered_node_types[`${b}>`+this.selectedGroup],this.groupData=J.getGroupData(this.groupNodeType)}changeGroup(e,t=!0){this.selectedGroup=e,this.getGroupData();let n=this.groupData.nodeData.nodes;if(this.nodeItems=n.map((e,t)=>A(`li.draggable-item`,{dataset:{nodeindex:e.index+``},onclick:()=>{this.changeNode(t)}},[A(`span.drag-handle`),A(`div`,{textContent:e.title??e.type},e.title?A(`span`,{textContent:e.type}):[])])),this.innerNodesList.replaceChildren(...this.nodeItems),t)this.selectedNodeIndex=null,this.changeNode(0);else{let e=this.draggable.getAllItems().findIndex(e=>e.classList.contains(`selected`));e===-1&&(e=this.selectedNodeIndex),this.changeNode(e,!0)}let r=[...n];this.draggable?.dispose(),this.draggable=new lt(this.innerNodesList,`li`),this.draggable.addEventListener(`dragend`,e=>{let{oldPosition:t,newPosition:n}=e.detail;if(t!==n){r.splice(n,0,r.splice(t,1)[0]);for(let e=0;e<r.length;e++)this.storeModification({nodeIndex:r[e].index,section:W,prop:`order`,value:e})}})}storeModification(e){let{nodeIndex:t,section:n,prop:r,value:i}=e,a=this.selectedGroup,o=this.modifications[a]??={},s=o.nodes??={},c=s[t??this.selectedNodeInnerIndex]??={},l=c[n]??={};if(typeof i==`object`&&i){let e=l[r]??={};Object.assign(e,i)}else l[r]=i}getEditElement(e,t,n,r,i,a=!0){let o=n===r?``:n,s=this.selectedGroup,c=(this.modifications[s]?.nodes)?.[this.selectedNodeInnerIndex]?.[e]?.[t];return c&&(c.name!=null&&(o=c.name),c.visible!=null&&(i=c.visible)),A(`div`,[A(`input`,{value:o,placeholder:r,type:`text`,onchange:n=>{this.storeModification({section:e,prop:String(t),value:{name:n.target.value}})}}),A(`label`,{textContent:`Visible`},[A(`input`,{type:`checkbox`,checked:i,disabled:!a,onchange:n=>{this.storeModification({section:e,prop:String(t),value:{visible:!!n.target.checked}})}})])])}buildWidgetsPage(){let e=this.groupData.oldToNewWidgetMap[this.selectedNodeInnerIndex],t=Object.keys(e??{}),n=F.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.widgetsPage.replaceChildren(...t.map(t=>this.getEditElement(`input`,t,e[t],t,n?.[t]?.visible!==!1))),!!t.length}buildInputsPage(){let e=this.groupData.nodeInputs[this.selectedNodeInnerIndex],t=Object.keys(e??{}),n=F.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input,r=t.map(t=>{let r=e[t];return r?this.getEditElement(`input`,t,r,t,n?.[t]?.visible!==!1):null}).filter(e=>e!==null);return this.inputsPage.replaceChildren(...r),!!t.length}buildOutputsPage(){let e=this.groupData.nodeData.nodes,t=this.groupData.getNodeDef(e[this.selectedNodeInnerIndex]),n=t?.output??[],r=this.groupData.oldToNewOutputMap[this.selectedNodeInnerIndex],i=F.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.output,a=this.groupData.nodeData.nodes[this.selectedNodeInnerIndex].type!==`PrimitiveNode`,o=n.map((e,n)=>{let o=r?.[n],s=t?.output_name?.[n]??String(e),c=i?.[n]?.name,l=i?.[n]?.visible||o!=null;return(!c||c===s)&&(c=``),this.getEditElement(`output`,n,c,s,l,a)});return this.outputsPage.replaceChildren(...o),!!n.length}show(e){let t=typeof e==`string`?e:void 0,n=Object.keys(F.rootGraph.extra?.groupNodes??{}).sort((e,t)=>e.localeCompare(t));this.innerNodesList=A(`ul.comfy-group-manage-list-items`),this.widgetsPage=A(`section.comfy-group-manage-node-page`),this.inputsPage=A(`section.comfy-group-manage-node-page`),this.outputsPage=A(`section.comfy-group-manage-node-page`);let r=A(`div`,[this.widgetsPage,this.inputsPage,this.outputsPage]);this.tabs=[[`Inputs`,this.inputsPage],[`Widgets`,this.widgetsPage],[`Outputs`,this.outputsPage]].reduce((e,[t,n])=>(e[t]={tab:A(`a`,{onclick:()=>{this.changeTab(t)},textContent:t}),page:n},e),{});let i=A(`div.comfy-group-manage-outer`,[A(`header`,[A(`h2`,`Group Nodes`),A(`select`,{onchange:e=>{this.changeGroup(e.target.value)}},n.map(e=>A(`option`,{textContent:e,selected:`${b}>${e}`===t,value:e})))]),A(`main`,[A(`section.comfy-group-manage-list`,this.innerNodesList),A(`section.comfy-group-manage-node`,[A(`header`,Object.values(this.tabs).map(e=>e.tab)),r])]),A(`footer`,[A(`button.comfy-btn`,{onclick:()=>{if(F.rootGraph.nodes.find(e=>e.type===`workflow>`+this.selectedGroup)){m().addAlert(`This group node is in use in the current workflow, please first remove these.`);return}confirm(`Are you sure you want to remove the node: "${this.selectedGroup}"`)&&(delete F.rootGraph.extra.groupNodes[this.selectedGroup],y.unregisterNodeType(`${b}>`+this.selectedGroup)),this.show()}},`Delete Group Node`),A(`button.comfy-btn`,{onclick:async()=>{let e,t=[],n={};for(let r in this.modifications){let i=F.rootGraph.extra.groupNodes[r],a=i.config??={},o=this.modifications[r]?.nodes;if(o){let e=Object.keys(o);if(o[e[0]]?.[W]){let t=[],n={},r={};for(let r of e){let e=o[r][W].order;t[e]=i.nodes[+r],n[e]=o[r],t[e].index=e}let s=i.nodes.length;for(let e of i.links){let t=e[0],n=e[2];t!=null&&t<s&&(e[0]=i.nodes[t].index),n!=null&&n<s&&(e[2]=i.nodes[n].index)}if(i.external)for(let e of i.external){let t=e[0];t!=null&&t<s&&(e[0]=i.nodes[t].index)}for(let t of e)a[+t]&&(r[i.nodes[+t].index]=a[+t]),delete a[+t];i.nodes=t,o=n,i.config=a=r}merge(a,o)}n[r]=i,e||=F.rootGraph.nodes.reduce((e,t)=>{let n=t.type??``;return e[n]??=[],e[n].push(t),e},{});let s=e[`${b}>`+r];s&&t.push(...s)}await q.registerFromWorkflow(n,[]);for(let e of t)e.recreate?.();this.modifications={},this.app.canvas.setDirty(!0,!0),this.changeGroup(this.selectedGroup,!1)}},`Save`),A(`button.comfy-btn`,{onclick:()=>this.element.close()},`Close`)])]);this.element.replaceChildren(i),this.changeGroup(t?n.find(e=>`workflow>${e}`===t)??n[0]:n[0]),this.element.showModal(),this.element.addEventListener(`close`,()=>{this.draggable?.dispose(),this.element.remove()})}},window.comfyAPI=window.comfyAPI||{},window.comfyAPI.groupNodeManage=window.comfyAPI.groupNodeManage||{},window.comfyAPI.groupNodeManage.ManageGroupDialog=ManageGroupDialog})),Zt,getRange,mergeNumericInputSpec,mergeComboInputSpec,mergeCommonInputSpec,mergeInputSpec,Qt=t((()=>{c(),ct(),tt(),Zt=new Set([`default`,`forceInput`,`defaultInput`,`control_after_generate`,`multiline`,`tooltip`,`dynamicPrompts`]),getRange=e=>({min:e.min??-1/0,max:e.max??1/0}),mergeNumericInputSpec=(e,t)=>{let n=e[0],r=e[1]??{},i=t[1]??{},a=getRange(r),o=getRange(i);if(a.min>o.max||a.max<o.min)return null;let s=r.step??1,c=i.step??1,l={min:Math.max(a.min,o.min),max:Math.min(a.max,o.max),step:Mt(s,c)};return mergeCommonInputSpec([n,{...r,...l}],[n,{...i,...l}])},mergeComboInputSpec=(e,t)=>{let n=e[1]??{},r=t[1]??{},i=At(e),a=At(t),o=f.intersection(i,a);return o.length===0?null:mergeCommonInputSpec([`COMBO`,{...n,options:o}],[`COMBO`,{...r,options:o}])},mergeCommonInputSpec=(e,t)=>{let n=at(e),r=e[1]??{},i=t[1]??{};return f.union(f.keys(r),f.keys(i)).filter(e=>!Zt.has(e)).every(e=>{let t=r[e],n=i[e];return t===n||f.isNil(t)&&f.isNil(n)})?[n,{...r,...i}]:null},mergeInputSpec=(e,t)=>at(e)===at(t)?ut(e)||ft(e)?mergeNumericInputSpec(e,t):yt(e)?mergeComboInputSpec(e,t):mergeCommonInputSpec(e,t):null})),isPrimitiveNode,$t=t((()=>{isPrimitiveNode=e=>e.type===`PrimitiveNode`}));function getWidgetConfig(e){return e.widget?.[D]??e.widget?.[O]?.()??[`*`,{}]}function getConfig(e){let{nodeData:t}=this.constructor;return t?.input?.required?.[e]??t?.input?.optional?.[e]}function convertToInput(e,t){return console.warn(`Please remove call to convertToInput. Widget to socket conversion is no longer necessary, as they co-exist now.`),e.inputs.find(e=>e.widget?.name===t.name)}function getWidgetType(e){let t=e[0];return t instanceof Array&&(t=`COMBO`),{type:t}}function setWidgetConfig(e,t){if(!e.widget||(t?e.widget[O]=()=>t:delete e.widget,!(e instanceof ie)))return;let n=e.node.graph;if(!n)return;let r=n.links[e.link??-1];if(!r)return;let i=n.getNodeById(r.origin_id);!i||!isPrimitiveNode(i)||(t?i.recreateWidget():F.configuringGraph||(i.disconnectOutput(0),i.onLastDisconnect()))}function mergeIfValid(e,t,n,r,i){i||=getWidgetConfig(e);let a=mergeInputSpec(i,t);if(a||n){a&&(e.widget[D]=a);let t=r?.call(this);if(t){let e=t.options.min,n=t.options.max;e!=null&&t.value<e&&(t.value=e),n!=null&&t.value>n&&(t.value=n),t.callback(t.value)}}return{customConfig:a?.[1]??{}}}var G,PrimitiveNode,en=t((()=>{Ze(),S(),se(),M(),mt(),Te(),Qt(),St(),$t(),G=`Run widget replace on values`,PrimitiveNode=class extends _{controlValues;lastType;static category;constructor(e){super(e),this.addOutput(`connect to widget input`,`*`),this.serialize_widgets=!0,this.isVirtualNode=!0,(!this.properties||!(G in this.properties))&&this.addProperty(G,!1,`boolean`)}applyToGraph(e=[]){if(!this.outputs[0].links?.length||!this.graph)return;let t=[...this.outputs[0].links.map(e=>this.graph.links[e]),...e],n=this.widgets?.[0].value;n&&this.properties[G]&&(n=Pe(this.graph,n));for(let e of t){let t=this.graph?.getNodeById(e.target_id),r=t?.inputs[e.target_slot];if(!r){console.warn(`Unable to resolve node or input for link`,e);continue}let i=r.widget?.name;if(!i){console.warn(`Invalid widget or widget name`,r.widget);continue}let a=t.widgets?.find(e=>e.name===i);if(!a){console.warn(`Unable to find widget "${i}" on node [${t.id}]`);continue}a.value=n,a.callback?.(a.value,F.canvas,t,F.canvas.graph_mouse,{})}}refreshComboInNode(){let e=this.widgets?.[0];e?.type===`combo`&&(e.options.values=this.outputs[0].widget[O]()[0],e.options.values.includes(e.value)||(e.value=e.options.values[0],e.callback(e.value)))}onAfterGraphConfigured(){if(this.outputs[0].links?.length&&!this.widgets?.length){if(this.#e(),this.widgets&&this.widgets_values)for(let e=0;e<this.widgets_values.length;e++){let t=this.widgets[e];t&&(t.value=this.widgets_values[e])}this.#n()}}onConnectionsChange(e,t,n){if(F.configuringGraph)return;let r=this.outputs[0].links;n?r?.length&&!this.widgets?.length&&this.#e():(this.#n(),r?.length||this.onLastDisconnect())}onConnectOutput(e,t,n,r,i){if(!n.widget&&!(n.type in T))return!1;if(this.outputs[e].links?.length){let e=this.#r(n);return e&&this.applyToGraph([{target_id:r.id,target_slot:i}]),e}return!0}#e(e){if(!this.outputs[0].links||!this.graph){this.onLastDisconnect();return}let t=this.outputs[0].links[0],n=this.graph.links[t];if(!n)return;let r=this.graph.getNodeById(n.target_id);if(!r||!r.inputs)return;let i=r.inputs[n.target_slot];if(!i)return;let a;if(i.widget)a=i.widget;else{if(!(i.type in T))return;a={name:i.name,[O]:()=>[i.type,{}]}}let o=a[O]?.();if(!o)return;let{type:s}=getWidgetType(o);this.outputs[0].type=s,this.outputs[0].name=s,this.outputs[0].widget=a,this.#t(a[D]??o,r,a.name,e)}#t(e,t,n,r){let i=e[0];i instanceof Array&&(i=`COMBO`);let[a,o]=this.size,s;if(s=we(i)?(T[i](this,`value`,e,F)||{}).widget:this.addWidget(i,`value`,null,()=>{},{}),t?.widgets&&s){let e=t.widgets.find(e=>e.name===n);e&&(s.value=e.value)}if(!e?.[1]?.control_after_generate&&(s.type===`number`||s.type===`combo`)){let t=this.widgets_values?.[1];t||=`fixed`,ze(this,s,t,void 0,e),this.widgets?.[1]&&(s.linkedWidgets=[this.widgets[1]]);let n=this.widgets_values?.[2];n&&this.widgets&&this.widgets.length===3&&(this.widgets[2].value=n)}let c=this.controlValues;if(this.widgets&&this.lastType===this.widgets[0]?.type&&c?.length===this.widgets.length-1)for(let e=0;e<c.length;e++)this.widgets[e+1].value=c[e];if(s.callback=j(s.callback,()=>{this.applyToGraph()}),this.setSize([Math.max(this.size[0],a),Math.max(this.size[1],o)]),!r){let e=this.computeSize();this.size[0]<e[0]&&(this.size[0]=e[0]),this.size[1]<e[1]&&(this.size[1]=e[1]),requestAnimationFrame(()=>{this.onResize?.(this.size)})}}recreateWidget(){let e=this.widgets?.map(e=>e.value);if(this.#i(),this.#e(!0),e?.length&&this.widgets)for(let t=0;t<this.widgets.length;t++)this.widgets[t].value=e[t];return this.widgets?.[0]}#n(){let e=this.outputs[0],t=e.links??[],n=!!e.widget?.[D];if(n&&delete e.widget?.[D],t?.length<2&&n){t.length&&this.recreateWidget();return}let r=e.widget?.[O]?.();if(r&&!(!(r[0]===`INT`||r[0]===`FLOAT`)||!this.graph))for(let e of t){let t=this.graph.links[e];if(!t)continue;let r=this.graph.getNodeById(t.target_id);if(!r)continue;let i=r.inputs[t.target_slot];this.#r(i,n)}}#r(e,t){let n=this.outputs?.[0],r=e.widget?.[O]?.();return r?!!mergeIfValid.call(this,n,r,t,this.recreateWidget):!1}#i(){if(this.widgets){for(let e of this.widgets)e.onRemove&&e.onRemove();this.controlValues=[],this.lastType=this.widgets[0]?.type;for(let e=1;e<this.widgets.length;e++)this.controlValues.push(this.widgets[e].value);setTimeout(()=>{delete this.lastType,delete this.controlValues},15),this.widgets.length=0}}onLastDisconnect(){this.outputs[0].type=`*`,this.outputs[0].name=`connect to widget input`,delete this.outputs[0].widget,this.#i()}},F.registerExtension({name:`Comfy.WidgetInputs`,async beforeRegisterNodeDef(e,t){e.prototype.convertWidgetToInput=function(){return console.warn(`Please remove call to convertWidgetToInput. Widget to socket conversion is no longer necessary, as they co-exist now.`),!1},e.prototype.onGraphConfigured=j(e.prototype.onGraphConfigured,function(){if(this.inputs){this.widgets??=[];for(let e of this.inputs)if(e.widget){let t=e.widget.name;e.widget[O]||(e.widget[O]=()=>getConfig.call(this,t)),this.widgets?.find(e=>e.name===t)||this.removeInput(this.inputs.findIndex(t=>t===e))}}}),e.prototype.onConfigure=j(e.prototype.onConfigure,function(){if(!F.configuringGraph&&this.inputs){for(let e of this.inputs)if(e.widget&&!e.widget[O]){let t=e.widget.name;e.widget[O]=()=>getConfig.call(this,t)}}});let n=e.prototype.onInputDblClick;e.prototype.onInputDblClick=function(...[e,...t]){let r=n?.apply(this,[e,...t]),i=this.inputs[e];if(!i.widget&&!(i.type in T)&&!((i.widget?.[O])?.()?.[0]instanceof Array))return r;let a=y.createNode(`PrimitiveNode`),o=F.canvas.graph;if(!a||!o)return r;o?.add(a);let s=[this.pos[0]-a.size[0]-30,this.pos[1]];for(;o.getNodeOnPos(s[0],s[1],o.nodes);)s[1]+=y.NODE_TITLE_HEIGHT;return a.pos=s,a.connect(0,this,e),a.title=i.name,r}},registerCustomNodes(){y.registerNodeType(`PrimitiveNode`,Object.assign(PrimitiveNode,{title:`Primitive`})),PrimitiveNode.category=`utils`}}),window.comfyAPI=window.comfyAPI||{},window.comfyAPI.widgetInputs=window.comfyAPI.widgetInputs||{},window.comfyAPI.widgetInputs.PrimitiveNode=PrimitiveNode,window.comfyAPI.widgetInputs.getWidgetConfig=getWidgetConfig,window.comfyAPI.widgetInputs.convertToInput=convertToInput,window.comfyAPI.widgetInputs.setWidgetConfig=setWidgetConfig,window.comfyAPI.widgetInputs.mergeIfValid=mergeIfValid}));async function convertSelectedNodesToGroupNode(){let e=Object.values(F.canvas.selected_nodes??{});if(e.length===0)throw Error(`No nodes selected`);if(e.length===1)throw Error(`Please select multiple nodes to convert to group node`);for(let t of e){if(t instanceof ce)throw Error(`Selected nodes contain a subgraph node`);if(J.isGroupNode(t))throw Error(`Selected nodes contain a group node`)}return await J.fromNodes(e)}function ungroupSelectedGroupNodes(){let e=Object.values(F.canvas.selected_nodes??{});for(let t of e)J.isGroupNode(t)&&t.convertToNodes?.()}function manageGroupNodes(e){new ManageGroupDialog(F).show(e)}var K,GroupNodeBuilder,q,J,replaceLegacySeparators,convertDisabled,tn,Y,nn,rn=t((()=>{ne(),C(),S(),g(),p(),Dt(),_t(),Et(),jt(),Jt(),Ee(),pt(),h(),M(),Xt(),en(),K={InUse:{Free:0,Registered:1,InWorkflow:2},isInUseGroupNode(e){let t=`${b}>${e}`;return F.rootGraph.extra?.groupNodes?.[e]?F.rootGraph.nodes.find(e=>e.type===t)?K.InUse.InWorkflow:K.InUse.Registered:K.InUse.Free},storeGroupNode(e,t){let n=F.rootGraph.extra;n||(F.rootGraph.extra=n={});let r=n.groupNodes;r||(n.groupNodes=r={}),r[e]=t}},GroupNodeBuilder=class{nodes;nodeData;constructor(e){this.nodes=e}async build(){let e=await this.getName();if(e)return this.sortNodes(),this.nodeData=this.getNodeData(),K.storeGroupNode(e,this.nodeData),{name:e,nodeData:this.nodeData}}async getName(){let e=await L().prompt({title:w(`groupNode.create`),message:w(`groupNode.enterName`),defaultValue:``});if(e){switch(K.isInUseGroupNode(e)){case K.InUse.InWorkflow:m().addAlert(`An in use group node with this name already exists embedded in this workflow, please remove any instances or use a new name.`);return;case K.InUse.Registered:if(!confirm(`A group node with this name already exists embedded in this workflow, are you sure you want to overwrite it?`))return;break}return e}}sortNodes(){let e=F.rootGraph.computeExecutionOrder(!1);this.nodes=this.nodes.map(t=>({index:e.indexOf(t),node:t})).sort((e,t)=>e.index-t.index||String(e.node.id).localeCompare(String(t.node.id))).map(({node:e})=>e)}getNodeData(){let storeLinkTypes=e=>{for(let t of e.links){let e=F.rootGraph.getNodeById(t[4])?.outputs?.[Number(t[1])]?.type;e!==void 0&&t.push(e)}},storeExternalLinks=e=>{e.external=[];for(let t=0;t<this.nodes.length;t++){let n=this.nodes[t];if(n.outputs?.length)for(let r=0;r<n.outputs.length;r++){let i=!1,a=n.outputs[r],o=a.type;if(a.links?.length){for(let e of a.links){let t=F.rootGraph.links[e];if(t&&(o===`*`&&(o=t.type),!F.canvas.selected_nodes[t.target_id])){i=!0;break}}i&&e.external.push([t,r,String(o)])}}}},e=F.canvas?.graph;if(!e)return{nodes:[],links:[],external:[]};let t=dt(this.nodes,e),n=JSON.parse(t);return n.external=[],storeLinkTypes(n),storeExternalLinks(n),n}},q=class GroupNodeConfig{name;nodeData;inputCount;oldToNewOutputMap;newToOldOutputMap;oldToNewInputMap;oldToNewWidgetMap;newToOldWidgetMap;primitiveDefs;widgetToPrimitive;primitiveToWidget;nodeInputs;outputVisibility;nodeDef;inputs;linksFrom;linksTo;externalFrom;constructor(e,t){this.name=e,this.nodeData=t,this.getLinks(),this.inputCount=0,this.oldToNewOutputMap={},this.newToOldOutputMap={},this.oldToNewInputMap={},this.oldToNewWidgetMap={},this.newToOldWidgetMap={},this.primitiveDefs={},this.widgetToPrimitive={},this.primitiveToWidget={},this.nodeInputs={},this.outputVisibility=[]}async registerType(e=b){this.nodeDef={output:[],output_name:[],output_is_list:[],output_node:!1,name:e+`>`+this.name,display_name:this.name,category:`group nodes`+(`>`+e),input:{required:{}},description:`Group node combining ${this.nodeData.nodes.map(e=>e.type).join(`, `)}`,python_module:`custom_nodes.`+this.name,[k]:this},this.inputs=[];let t={},n={};for(let e=0;e<this.nodeData.nodes.length;e++){let r=this.nodeData.nodes[e];r.index=e,this.processNode(r,t,n)}for(let e of this.#e)e();this.#e=[],this.nodeDef&&(await F.registerNodeDef(`${b}>`+this.name,this.nodeDef),nt().addNodeDef(this.nodeDef))}getLinks(){this.linksFrom={},this.linksTo={},this.externalFrom={};for(let e of this.nodeData.links){let[t,n,r,i]=e;if(t==null||n==null||r==null||i==null)continue;let a=Number(t),o=Number(n),s=Number(r),c=Number(i);this.linksFrom[a]||(this.linksFrom[a]={}),this.linksFrom[a][o]||(this.linksFrom[a][o]=[]),this.linksFrom[a][o].push(e),this.linksTo[s]||(this.linksTo[s]={}),this.linksTo[s][c]=e}if(this.nodeData.external)for(let e of this.nodeData.external){let t=Number(e[0]),n=Number(e[1]),r=e[2];r!=null&&(this.externalFrom[t]?this.externalFrom[t][n]=r:this.externalFrom[t]={[n]:r})}}processNode(e,t,n){let r=this.getNodeDef(e);if(!r)return;let i={...r.input?.required,...r.input?.optional};this.inputs.push(this.processNodeInputs(e,t,i)),r.output?.length&&this.processNodeOutputs(e,n,r)}getNodeDef(e){if(e.type){let t=Y[e.type];if(t)return t}let t=e.index;if(t==null)return;let n=this.linksFrom[t];if(e.type===`PrimitiveNode`){if(!n)return;let r=n[0]?.[0]?.[5]??null;if(r===`COMBO`){let t=(e.outputs?.[0])?.widget?.name,i=n[0]?.[0]?.[2];if(t&&i!=null){let e=this.nodeData.nodes[Number(i)]?.type;if(e){let n=Y[e],i=(n?.input?.required?.[t]??n?.input?.optional?.[t])?.[0];r=typeof i==`string`||typeof i==`number`?i:null}}}return this.primitiveDefs[t]={input:{required:{value:[r,{}]}},output:[r],output_name:[],output_is_list:[]}}else if(e.type===`Reroute`){let r=this.linksTo[t];if(r&&n&&!this.externalFrom[t]?.[0])return null;let i={},a=`*`;if(n){let e=n[0]??[];for(let t of e){let e=t[2],n=t[3];if(e==null||n==null)continue;let r=this.nodeData.nodes[Number(e)],o=r?.inputs?.[Number(n)];if(o?.type&&a===`*`&&(a=o.type),o?.widget&&r?.type){let e=Y[r.type],t=e?.input?.required?.[o.widget.name]??e?.input?.optional?.[o.widget.name];if(t){let e=[t[0],i];i=mergeIfValid({widget:e},t,!1,void 0,e)?.customConfig??i}}}}else if(r){let e=r[0];if(e){let t=e[0],n=e[1];if(t!=null&&n!=null){let e=this.nodeData.nodes[Number(t)]?.outputs?.[Number(n)];e&&typeof e==`object`&&`type`in e&&(a=String(e.type??`*`))}}}else{for(let t of this.nodeData.links)if(t[2]===e.index){let e=t[5];e!=null&&(a=String(e));break}if(a===`*`){let e=this.externalFrom[t]?.[0];e&&(a=String(e))}}return i.forceInput=!0,{input:{required:{[a]:[a,i]}},output:[a],output_name:[],output_is_list:[]}}console.warn(`Skipping virtual node `+e.type+` when building group node `+this.name)}getInputConfig(e,t,n,r,i){let a=(this.nodeData.config?.[e.index??-1])?.input?.[t],o=a?.name??e.inputs?.find(e=>e.name===t)?.label??t,s=o,c=``;if((e.type===`PrimitiveNode`&&e.title||o in n)&&(c=`${e.title??e.type} `,s=o=`${c}${t}`,o in n&&(o=`${c}${n[o]} ${t}`)),n[s]=(n[s]??1)+1,(t===`seed`||t===`noise_seed`)&&(i||={},i.control_after_generate=`${c}control_after_generate`),r[0]===`IMAGEUPLOAD`){i||={};let t=e.index??-1,n=typeof r[1]==`object`&&r[1]!==null?r[1]:{},a=`widget`in n&&typeof n.widget==`string`?n.widget:`image`;i.widget=this.oldToNewWidgetMap[t]?.[a]??`image`}if(i){let e=typeof r[1]==`object`&&r[1]?r[1]:{};r=[r[0],{...e,...i}]}return{name:o,config:r,customConfig:a}}processWidgetInputs(e,t,n,r){let i=[],a=new Map,o=t.index??-1,s=this.oldToNewWidgetMap[o]={};for(let o of n){let n=e[o];if(Array.isArray(n)&&n.length>=1&&typeof n[0]==`string`&&Ue().inputIsWidget(n)){let n=t.inputs?.findIndex(e=>e.name===o&&e.widget?.name===o)??-1;if(n>-1)a.set(n,o),s[o]=null;else{let{name:n,config:i}=this.getInputConfig(t,o,r,e[o]);this.nodeDef?.input?.required&&(this.nodeDef.input.required[n]=i),s[o]=n,this.newToOldWidgetMap[n]={node:t,inputName:o}}}else i.push(o)}return{converted:a,slots:i}}checkPrimitiveConnection(e,t,n){let r=e[0];if(r!=null&&this.nodeData.nodes[Number(r)]?.type===`PrimitiveNode`){let r=Number(e[0]),i=Number(e[2]),a=this.primitiveDefs[r];if(!a)return;let o=n[t],s=a.input.required.value,c=mergeIfValid({widget:s},o,!1,void 0,s),l=n[t]?.[1];s[1]=c?.customConfig??l?{...typeof l==`object`?l:{}}:{};let u=this.oldToNewWidgetMap[r]?.value;if(u){let e=u.substring(0,u.length-6);s[1].control_after_generate=!0,s[1].control_prefix=e}let d=this.widgetToPrimitive[i];d||=this.widgetToPrimitive[i]={};let f=d[t];Array.isArray(f)?f.push(r):typeof f==`number`?d[t]=[f,r]:d[t]=r;let p=this.primitiveToWidget[r];p||=this.primitiveToWidget[r]=[],p.push({nodeId:i,inputName:t})}}processInputSlots(e,t,n,r,i,a){let o=t.index??-1;this.nodeInputs[o]={};for(let s=0;s<n.length;s++){let c=n[s];if(r[s]){this.checkPrimitiveConnection(r[s],c,e);continue}let{name:l,config:u,customConfig:d}=this.getInputConfig(t,c,a,e[c]);this.nodeInputs[o][c]=l,d?.visible!==!1&&(this.nodeDef?.input?.required&&(this.nodeDef.input.required[l]=u),i[s]=this.inputCount++)}}processConvertedWidgets(e,t,n,r,i,a,o){let s=[...r.keys()].sort().map(e=>r.get(e));for(let r=0;r<s.length;r++){let c=s[r];if(!c)continue;if(i[n.length+r]){this.checkPrimitiveConnection(i[n.length+r],c,e);continue}let{name:l,config:u}=this.getInputConfig(t,c,o,e[c],{defaultInput:!0});this.nodeDef?.input?.required&&(this.nodeDef.input.required[l]=u),this.newToOldWidgetMap[l]={node:t,inputName:c};let d=t.index??-1;this.oldToNewWidgetMap[d]||(this.oldToNewWidgetMap[d]={}),this.oldToNewWidgetMap[d][c]=l,a[n.length+r]=this.inputCount++}}#e=[];processNodeInputs(e,t,n){let r=[],i=Object.keys(n);if(!i.length)return;let{converted:a,slots:o}=this.processWidgetInputs(n,e,i,t),s=e.index??-1,c=this.linksTo[s]??{},l=this.oldToNewInputMap[s]={};return this.processInputSlots(n,e,o,c,l,t),this.#e.push(()=>this.processConvertedWidgets(n,e,o,a,c,l,t)),r}processNodeOutputs(e,t,n){let r=e.index??-1,i=this.oldToNewOutputMap[r]={},a=n.output??[];for(let o=0;o<a.length;o++){let s=this.linksFrom[r]?.[o]&&!this.externalFrom[r]?.[o],c=(this.nodeData.config?.[e.index??-1])?.output?.[o],l=c?.visible??!s;if(this.outputVisibility.push(l),!l)continue;this.nodeDef?.output&&(i[o]=this.nodeDef.output.length,this.newToOldOutputMap[this.nodeDef.output.length]={node:e,slot:o},this.nodeDef.output.push(a[o]),this.nodeDef.output_is_list?.push(n.output_is_list?.[o]??!1));let u=c?.name;if(!u){let t=a[o];u=n.output_name?.[o]??(typeof t==`string`?t:void 0);let r=e.outputs?.find(e=>e.name===u);r?.label&&(u=r.label)}let d=String(u??`output_${o}`);if(d in t){let n=`${e.title??e.type} `;d=`${n}${u??o}`,d in t&&(d=`${n}${e.index} ${u??o}`)}t[d]=1,this.nodeDef?.output_name?.push(d)}}static async registerFromWorkflow(e,t){for(let n in e){let r=e[n],i=!1;for(let a of r.nodes)(!a.type||!(a.type in y.registered_node_types))&&(t.push({type:a.type??`unknown`,hint:` (In group node '${b}>${n}')`}),t.push({type:`${b}>`+n,action:{text:`Remove from workflow`,callback:t=>{delete e[n];let r=t.target;r.textContent=`Removed`,r.style.pointerEvents=`none`,r.style.opacity=`0.7`}}}),i=!0);i||await new GroupNodeConfig(n,r).registerType()}}},J=class GroupNodeHandler{node;groupData;innerNodes=null;constructor(e){this.node=e,this.groupData=e.constructor?.nodeData?.[k],this.node.setInnerNodes=e=>{this.innerNodes=e;for(let t=0;t<this.innerNodes.length;t++){let n=this.innerNodes[t];n.graph??=this.node.graph;for(let e of n.widgets??[])e.type===`converted-widget`&&(e.serializeValue=e.origSerializeValue);n.index=t,n.getInputNode=t=>{let r=n.index??0,i=this.groupData.oldToNewInputMap[r]?.[t];if(i!=null)return this.node.getInputNode(i);let a=this.groupData.linksTo[r]?.[t];if(!a)return null;let o=a[0];if(o==null)return null;let s=e[Number(o)];return s.type===`PrimitiveNode`?null:s},n.getInputLink=t=>{let r=n.index??0,i=this.groupData.oldToNewInputMap[r]?.[t];if(i!=null){let e=this.node.inputs[i].link;if(e==null)return null;let r=F.rootGraph.links[e];return r?{...r,target_id:n.id,target_slot:+t}:null}let a=this.groupData.linksTo[r]?.[t];if(!a)return null;let o=a[0];return o==null?null:{origin_id:e[Number(o)].id,origin_slot:a[1],target_id:n.id,target_slot:+t}}}},this.node.updateLink=e=>{e={...e};let t=this.groupData.newToOldOutputMap[e.origin_slot];if(!t||!this.innerNodes)return null;let n=t.node.index??0,r=this.innerNodes[n],i;for(;r?.type===`Reroute`;)i=r.getInputLink(0),r=r.getInputNode(0);return r?i&&GroupNodeHandler.isGroupNode(r)&&r.updateLink?r.updateLink(i):(e.origin_id=r.id,e.origin_slot=i?.origin_slot??t.slot,e):null},this.node.getInnerNodes=(e,t=[],n=[],r=new Set)=>{if(r.has(this.node))throw Error(`RecursionError: while flattening subgraph`);if(r.add(this.node),!this.innerNodes){let e=this.groupData.nodeData.nodes.map((e,t)=>{if(!e.type)return null;let n=y.createNode(e.type);return n?(n.configure(e),n.id=`${this.node.id}:${t}`,n.graph=this.node.graph,n):null}).filter(e=>e!==null);this.node.setInnerNodes?.(e)}this.updateInnerWidgets();let i=[...t,this.node.id],a=this.node.graph?.getNodeById(t.at(-1))??void 0;for(let t of this.innerNodes??[]){t.graph??=this.node.graph;let r=String(t.id);t.id=r.split(`:`).at(-1);let o=new ExecutableGroupNodeChildDTO(t,i,e,a);t.id=r,o.groupNodeHandler=this,n.push(o)}return n},this.node.recreate=async()=>{let e=this.node.id,t=this.node.size,n=this.node.convertToNodes?.();if(!n)return null;let r=y.createNode(this.node.type);if(!r)return null;r.id=e,r.setInnerNodes?.(n);let i=GroupNodeHandler.getHandler(r);i?.populateWidgets(),F.rootGraph.add(r),r.setSize?.([Math.max(r.size[0],t[0]),Math.max(r.size[1],t[1])]);let a=new GroupNodeBuilder(n).getNodeData();return i&&(i.groupData.nodeData.links=a.links,i.replaceNodes(n)),r},this.node.convertToNodes=()=>{let addInnerNodes=()=>{let e={...this.groupData.nodeData};e.nodes=[...e.nodes];let t=this.node.getInnerNodes?.(),n=[];for(let r=0;r<e.nodes.length;r++){let i=t?.[r]?.id;i==null||typeof i==`number`&&isNaN(i)?i=void 0:n.push(i),e.nodes[r]={...e.nodes[r],id:i}}gt(JSON.stringify(e),F.canvas);let[r,i]=this.node.pos,a,o,s=n.length?n:Object.keys(F.canvas.selected_nodes),c=[];for(let e=0;e<s.length;e++){let n=s[e],r=F.rootGraph.getNodeById(n),i=t?.[e];if(!r||(c.push(r),(o==null||r.pos[0]<o)&&(o=r.pos[0]),(a==null||r.pos[1]<a)&&(a=r.pos[1]),!r.widgets||!i))continue;let l=this.groupData.oldToNewWidgetMap[i.index??0];if(l){let e=Object.keys(l);for(let t of e){let e=l[t];if(!e)continue;let n=this.node.widgets?.findIndex(t=>t.name===e)??-1;if(n!==-1)if(i.type===`PrimitiveNode`)for(let e=0;e<r.widgets.length;e++){let t=this.node.widgets?.[n+e];t&&(r.widgets[e].value=t.value)}else{let e=this.node.widgets?.[n],i=r.widgets.find(e=>e.name===t);if(!i||!e)continue;i.value=e.value;let a=e.linkedWidgets??[];for(let e=0;e<a.length;e++){let t=i.linkedWidgets?.[e];t&&a[e]&&(t.value=a[e].value)}}}}}for(let e of c)e.pos[0]-=(o??0)-r,e.pos[1]-=(a??0)-i;return{newNodes:c,selectedIds:s}},reconnectInputs=t=>{for(let n in this.groupData.oldToNewInputMap){let r=t[Number(n)],i=F.rootGraph.getNodeById(r);if(!i)continue;let a=this.groupData.oldToNewInputMap[Number(n)];for(let t in a){let n=a[Number(t)];if(n==null)continue;let r=e.inputs[n];if(r.link==null)continue;let o=F.rootGraph.links[r.link];o&&F.rootGraph.getNodeById(o.origin_id)?.connect(o.origin_slot,i,+t)}}},reconnectOutputs=t=>{for(let n=0;n<e.outputs?.length;n++){let r=e.outputs[n];if(!r.links)continue;let i=[...r.links];for(let e of i){let r=this.groupData.newToOldOutputMap[n];if(!r)continue;let i=F.rootGraph.links[e];if(!i)continue;let a=F.rootGraph.getNodeById(i.target_id),o=F.rootGraph.getNodeById(t[r.node.index??0]);a&&o?.connect(r.slot,a,i.target_slot)}}};F.canvas.emitBeforeChange();try{let{newNodes:e,selectedIds:t}=addInnerNodes();return reconnectInputs(t),reconnectOutputs(t),F.rootGraph.remove(this.node),e}finally{F.canvas.emitAfterChange()}};let t=this.node.getExtraMenuOptions,n=this.node;this.node.getExtraMenuOptions=function(e,r){t?.call(this,e,r);let i=r.findIndex(e=>e?.content===`Outputs`);return i===-1?i=r.length:i++,r.splice(i,0,null,{content:`Convert to nodes`,callback:async()=>{let e=n.convertToNodes;return e?.()}},{content:`Manage Group Node`,callback:()=>manageGroupNodes(this.type)}),[]};let r=this.node.onDrawTitleBox;this.node.onDrawTitleBox=function(e,t,n,i){r?.call(this,e,t,n,i);let a=e.fillStyle;e.beginPath(),e.rect(11,-t+11,2,2),e.rect(14,-t+11,2,2),e.rect(17,-t+11,2,2),e.rect(11,-t+14,2,2),e.rect(14,-t+14,2,2),e.rect(17,-t+14,2,2),e.rect(11,-t+17,2,2),e.rect(14,-t+17,2,2),e.rect(17,-t+17,2,2),e.fillStyle=this.boxcolor||y.NODE_DEFAULT_BOXCOLOR,e.fill(),e.fillStyle=a};let i=e.onDrawForeground,a=this.groupData.nodeData;e.onDrawForeground=function(t,n,r){i?.call(this,t,n,r);let o=Tt().nodeProgressStates[this.id];if(o&&o.state===`running`&&this.runningInternalNodeId!==null){let n=typeof this.runningInternalNodeId==`number`?this.runningInternalNodeId:parseInt(String(this.runningInternalNodeId),10),r=a.nodes[n];if(!r)return;let i=`Running ${r.title||r.type} (${this.runningInternalNodeId}/${a.nodes.length})`;t.save(),t.font=`12px sans-serif`;let o=t.measureText(i);t.fillStyle=e.boxcolor||y.NODE_DEFAULT_BOXCOLOR,t.beginPath(),t.roundRect(0,-y.NODE_TITLE_HEIGHT-20,o.width+12,20,5),t.fill(),t.fillStyle=`#fff`,t.fillText(i,6,-y.NODE_TITLE_HEIGHT-6),t.restore()}};let o=this.node.onExecutionStart;this.node.onExecutionStart=function(){return this.resetExecution=!0,o?.call(this)};let s=this.node.onNodeCreated,c=this.groupData;this.node.onNodeCreated=function(){if(!this.widgets)return;let e=c.nodeData.config;if(e)for(let t in e){let n=e[t]?.input;if(n)for(let e in n){if(n[e]?.visible!==!1)continue;let r=c.oldToNewWidgetMap[Number(t)]?.[e],i=this.widgets.find(e=>e.name===r);i&&(i.type=`hidden`,i.computeSize=()=>[0,-4])}}return s?.call(this)};let handleEvent=(e,t,n)=>{let handler=({detail:r})=>{let i=t(r);if(!i||F.rootGraph.getNodeById(i))return;let a=this.innerNodes?.findIndex(e=>e.id==i)??-1;a>-1&&(this.node.runningInternalNodeId=a,v.dispatchCustomEvent(e,n(r,`${this.node.id}`,this.node)))};return v.addEventListener(e,handler),handler},l=handleEvent(`executing`,e=>typeof e==`string`?e:void 0,(e,t)=>t),u=handleEvent(`executed`,e=>typeof e==`object`?e?.display_node||e?.node:void 0,(e,t,n)=>({...typeof e==`object`?e:{},node:t,display_node:t,merge:!n.resetExecution})),d=e.onRemoved;this.node.onRemoved=function(){d?.call(this),v.removeEventListener(`executing`,l),v.removeEventListener(`executed`,u)},this.node.refreshComboInNode=e=>{for(let t in this.groupData.newToOldWidgetMap){let n=this.node.widgets?.find(e=>e.name===t);if(n?.type===`combo`){let r=this.groupData.newToOldWidgetMap[t];if(!r.node.type)continue;let i=e[r.node.type],a=i?.input?.required?.[r.inputName]??i?.input?.optional?.[r.inputName];if(!a)continue;n.options.values=a[0];let o=n.options.values;r.inputName!==`image`&&!o.includes(n.value)&&(n.value=o[0],n.callback?.(n.value))}}}}updateInnerWidgets(){if(this.innerNodes)for(let e in this.groupData.newToOldWidgetMap){let t=this.node.widgets?.find(t=>t.name===e);if(!t)continue;let n=t.value,r=this.groupData.newToOldWidgetMap[e],i=r.node.index??0,a=this.innerNodes[i];if(!a)continue;if(a.type===`PrimitiveNode`){a.primitiveValue=n;let e=this.groupData.primitiveToWidget[i];for(let t of e??[]){let e=typeof t.nodeId==`number`?t.nodeId:Number(t.nodeId),r=this.innerNodes[e]?.widgets?.find(e=>e.name===t.inputName);r&&(r.value=n)}continue}else if(a.type===`Reroute`){let e=this.groupData.linksFrom[i];if(e)for(let[,,t,r]of e[0]??[]){if(t==null||r==null)continue;let e=this.innerNodes[Number(t)];if(!e)continue;let i=e.inputs?.[Number(r)];if(i?.widget){let t=i.widget.name,r=e.widgets?.find(e=>e.name===t);r&&(r.value=n)}}}let o=a.widgets?.find(e=>e.name===r.inputName);o&&(o.value=n)}}populatePrimitive(e,t,n){let r=this.groupData.widgetToPrimitive[t]?.[n];if(r==null)return!1;let i=this.groupData.oldToNewWidgetMap[Array.isArray(r)?r[0]:r]?.value;if(!i)return!1;let a=this.node.widgets?.findIndex(e=>e.name===i)??-1;if(a>-1&&this.innerNodes){let e=Array.isArray(r)?r[0]:r,t=this.innerNodes[e];if(!t?.widgets)return!0;let n=t.widgets.length;n-1!==(this.node.widgets?.[a]?.linkedWidgets?.length??0)&&(n=1);for(let e=0;e<n;e++){let n=this.node.widgets?.[a+e],r=t.widgets[e];n&&r&&(n.value=r.value)}}return!0}populateReroute(e,t,n){if(e.type!==`Reroute`)return;let r=this.groupData.linksFrom[t]?.[0]?.[0];if(!r)return;let i=r[2],a=r[3];if(i==null||a==null)return;let o=this.groupData.nodeData.nodes[Number(i)],s=o?.inputs;if(!s?.[Number(a)]?.widget)return;let c=(s?.length??0)-(o?.widgets_values?.length??0),l=o?.widgets_values?.[Number(a)-c];if(l==null)return;let u=Object.values(n)[0],d=this.node.widgets?.find(e=>e.name===u);d&&(d.value=l)}populateWidgets(){if(this.node.widgets)for(let e=0;e<this.groupData.nodeData.nodes.length;e++){let t=this.groupData.nodeData.nodes[e],n=this.groupData.oldToNewWidgetMap[e]??{},r=Object.keys(n);if(!t.widgets_values?.length){this.populateReroute(t,e,n);continue}let i=0;for(let a=0;a<r.length;a++){let o=r[a],s=n[o],c=this.node.widgets.findIndex(e=>e.name===s),l=this.node.widgets[c];if(this.populatePrimitive(t,e,o)||c===-1){let t=this.innerNodes?.[e]?.widgets?.find(e=>e.name===o);i+=t?.linkedWidgets?.length??0}if(c===-1)continue;l.value=t.widgets_values?.[a+i];let u=l.linkedWidgets??[];for(let e=0;e<u.length;e++)this.node.widgets[c+e+1].value=t.widgets_values?.[a+ ++i]}}}replaceNodes(e){let t,n;for(let r=0;r<e.length;r++){let i=e[r];(n==null||i.pos[0]<n)&&(n=i.pos[0]),(t==null||i.pos[1]<t)&&(t=i.pos[1]),this.linkOutputs(i,r),F.rootGraph.remove(i),i.id=`${this.node.id}:${r}`}this.linkInputs(),this.node.pos=[n??0,t??0]}linkOutputs(e,t){if(e.outputs)for(let n of e.outputs){if(!n.links)continue;let e=[...n.links];for(let n of e){let e=F.rootGraph.links[n];if(!e)continue;let r=F.rootGraph.getNodeById(e.target_id),i=this.groupData.oldToNewOutputMap[t]?.[e.origin_slot];i!=null&&r&&this.node.connect(i,r,e.target_slot)}}}linkInputs(){for(let e of this.groupData.nodeData.links??[]){let[,t,n,r,i]=e;if(i==null||typeof i==`object`)continue;let a=F.rootGraph.getNodeById(i);if(!a||n==null||r==null)continue;let o=this.groupData.oldToNewInputMap[Number(n)]?.[Number(r)];o!=null&&(typeof t==`number`||typeof t==`string`)&&a.connect(t,this.node.id,o)}}static getGroupData(e){if(typeof e==`function`)return e.nodeData?.[k];let t=e.nodeData;return t?.[k]?t[k]:e.constructor?.nodeData?.[k]}static getHandler(e){let t=e[k];return!t&&GroupNodeHandler.isGroupNode(e)&&(t=new GroupNodeHandler(e),e[k]=t),t}static isGroupNode(e){return!!e.constructor?.nodeData?.[k]}static async fromNodes(e){let t=new GroupNodeBuilder(e),n=await t.build();if(!n)return;let{name:r,nodeData:i}=n;await new q(r,i).registerType();let a=y.createNode(`${b}>${r}`);if(!a)return;a.setInnerNodes?.(t.nodes);let o=GroupNodeHandler.getHandler(a);return o?.populateWidgets(),F.rootGraph.add(a),o?.replaceNodes(t.nodes),a}},replaceLegacySeparators=e=>{for(let t of e)typeof t.type==`string`&&t.type.startsWith(`workflow/`)&&(t.type=t.type.replace(/^workflow\//,`${b}>`))},convertDisabled=e=>e.length<2||!!e.find(e=>J.isGroupNode(e)),tn=`Comfy.GroupNode`,nn={name:tn,commands:[{id:`Comfy.GroupNode.ConvertSelectedNodesToGroupNode`,label:`Convert selected nodes to group node`,icon:`pi pi-sitemap`,versionAdded:`1.3.17`,function:()=>convertSelectedNodesToGroupNode()},{id:`Comfy.GroupNode.UngroupSelectedGroupNodes`,label:`Ungroup selected group nodes`,icon:`pi pi-sitemap`,versionAdded:`1.3.17`,function:()=>ungroupSelectedGroupNodes()},{id:`Comfy.GroupNode.ManageGroupNodes`,label:`Manage group nodes`,icon:`pi pi-cog`,versionAdded:`1.3.17`,function:(...e)=>manageGroupNodes(e[0])}],keybindings:[{commandId:`Comfy.GroupNode.ConvertSelectedNodesToGroupNode`,combo:{alt:!0,key:`g`}},{commandId:`Comfy.GroupNode.UngroupSelectedGroupNodes`,combo:{alt:!0,shift:!0,key:`G`}}],getCanvasMenuItems(e){let t=[],n=!convertDisabled(Object.values(e.selected_nodes??{}));t.push({content:`Convert to Group Node (Deprecated)`,disabled:!n,callback:async()=>convertSelectedNodesToGroupNode()});let r=e.graph?.extra?.groupNodes,i=!r||!Object.keys(r).length;return t.push({content:`Manage Group Nodes`,disabled:i,callback:()=>manageGroupNodes()}),t},getNodeMenuItems(e){return J.isGroupNode(e)?[]:[{content:`Convert to Group Node (Deprecated)`,disabled:!!convertDisabled(Object.values(F.canvas.selected_nodes??{})),callback:async()=>convertSelectedNodesToGroupNode()}]},async beforeConfigureGraph(e,t){let n=e?.extra?.groupNodes;n&&(replaceLegacySeparators(e.nodes),await q.registerFromWorkflow(n,t))},addCustomNodeDefs(e){Y=e},nodeCreated(e){if(J.isGroupNode(e)){e[k]=new J(e);let t=J.getHandler(e);e.title&&t?.groupData?.nodeData&&K.storeGroupNode(e.title,t.groupData.nodeData)}},async refreshComboInNodes(e){Object.assign(Y,e);let t=F.rootGraph.extra?.groupNodes;t&&await q.registerFromWorkflow(t,[])}},F.registerExtension(nn),window.comfyAPI=window.comfyAPI||{},window.comfyAPI.groupNode=window.comfyAPI.groupNode||{},window.comfyAPI.groupNode.GroupNodeConfig=q,window.comfyAPI.groupNode.GroupNodeHandler=J}));function setNodeMode(e,t){e.mode=t,e.graph?.change()}function addNodesToGroup(e,t){let n=I().get(`Comfy.GroupSelectedNodes.Padding`);e.resizeTo([...e.children,...t],n)}var an=t((()=>{S(),rt(),M(),F.registerExtension({name:`Comfy.GroupOptions`,getCanvasMenuItems(e){let t=[],n=e.graph.getGroupOnPos(e.graph_mouse[0],e.graph_mouse[1]);if(!n)return e.selectedItems.size>0&&t.push({content:`Add Group For Selected Nodes`,callback:()=>{let t=new oe;addNodesToGroup(t,e.selectedItems),e.graph.add(t),e.graph.change(),t.recomputeInsideNodes()}}),t;n.recomputeInsideNodes();let r=n.nodes;if(t.push({content:`Add Selected Nodes To Group`,disabled:!e.selectedItems?.size,callback:()=>{addNodesToGroup(n,e.selectedItems),e.graph.change()}}),r.length===0)return t;t.push(null);let i=!0;for(let e=1;e<r.length;e++)if(r[e].mode!==r[0].mode){i=!1;break}if(t.push({content:`Fit Group To Nodes`,callback:()=>{n.recomputeInsideNodes();let t=I().get(`Comfy.GroupSelectedNodes.Padding`);n.resizeTo(n.children,t),e.graph.change()}}),t.push({content:`Select Nodes`,callback:()=>{e.selectNodes(r),e.graph.change(),e.canvas.focus()}}),i)switch(r[0].mode){case 0:t.push({content:`Set Group Nodes to Never`,callback:()=>{for(let e of r)setNodeMode(e,2)}}),t.push({content:`Bypass Group Nodes`,callback:()=>{for(let e of r)setNodeMode(e,4)}});break;case 2:t.push({content:`Set Group Nodes to Always`,callback:()=>{for(let e of r)setNodeMode(e,0)}}),t.push({content:`Bypass Group Nodes`,callback:()=>{for(let e of r)setNodeMode(e,4)}});break;case 4:t.push({content:`Set Group Nodes to Always`,callback:()=>{for(let e of r)setNodeMode(e,0)}}),t.push({content:`Set Group Nodes to Never`,callback:()=>{for(let e of r)setNodeMode(e,2)}});break;default:t.push({content:`Set Group Nodes to Always`,callback:()=>{for(let e of r)setNodeMode(e,0)}}),t.push({content:`Set Group Nodes to Never`,callback:()=>{for(let e of r)setNodeMode(e,2)}}),t.push({content:`Bypass Group Nodes`,callback:()=>{for(let e of r)setNodeMode(e,4)}});break}else t.push({content:`Set Group Nodes to Always`,callback:()=>{for(let e of r)setNodeMode(e,0)}}),t.push({content:`Set Group Nodes to Never`,callback:()=>{for(let e of r)setNodeMode(e,2)}}),t.push({content:`Bypass Group Nodes`,callback:()=>{for(let e of r)setNodeMode(e,4)}});return t}})})),on=t((()=>{h(),M(),N(),B().registerExtension({name:`Comfy.ImageCompare`,async nodeCreated(e){if(e.constructor.comfyClass!==`ImageCompare`)return;let[t,n]=e.size;e.setSize([Math.max(t,400),Math.max(n,350)]);let r=e.onExecuted;e.onExecuted=function(t){r?.call(this,t);let{a_images:n,b_images:i}=t,a=F.getRandParam(),o=n&&n.length>0?v.apiURL(`/view?${new URLSearchParams(n[0])}${a}`):``,s=i&&i.length>0?v.apiURL(`/view?${new URLSearchParams(i[0])}${a}`):``,c=e.widgets?.find(e=>e.type===`imagecompare`);c&&(c.value={before:o,after:s},c.callback?.(c.value))}}})})),sn=t((()=>{N(),B().registerExtension({name:`Comfy.ImageCrop`,async nodeCreated(e){if(e.constructor.comfyClass!==`ImageCrop`)return;let[t,n]=e.size;e.setSize([Math.max(t,300),Math.max(n,450)])}})}));function createExportMenuItems(e){return[null,{content:`Save`,has_submenu:!0,callback:(t,n,r,i)=>{let a=cn.map(t=>({content:t.label,callback:()=>{(async()=>{try{await e.exportModel(t.value),m().add({severity:`success`,summary:w(`toastMessages.exportSuccess`,{format:t.label})})}catch(e){console.error(`Export failed:`,e),m().addAlert(w(`toastMessages.failedToExportModel`,{format:t.label}))}})()}}));new y.ContextMenu(a,{event:r,parentMenu:i})}}]}var cn,ln=t((()=>{C(),g(),wt(),S(),cn=[{label:`GLB`,value:`glb`},{label:`OBJ`,value:`obj`},{label:`STL`,value:`stl`}],window.comfyAPI=window.comfyAPI||{},window.comfyAPI.exportMenuHelper=window.comfyAPI.exportMenuHelper||{},window.comfyAPI.exportMenuHelper.createExportMenuItems=createExportMenuItems})),Load3DConfiguration,X,un=t((()=>{wt(),et(),rt(),h(),Load3DConfiguration=class{constructor(e,t){this.load3d=e,this.properties=t}configureForSaveMesh(e,t){this.setupModelHandlingForSaveMesh(t,e),this.setupDefaultProperties()}configure(e){this.setupModelHandling(e.modelWidget,e.loadFolder,e.cameraState),this.setupTargetSize(e.width,e.height),this.setupDefaultProperties(e.bgImagePath)}setupTargetSize(e,t){e&&t&&(this.load3d.setTargetSize(e.value,t.value),e.callback=e=>{this.load3d.setTargetSize(e,t.value)},t.callback=t=>{this.load3d.setTargetSize(e.value,t)})}setupModelHandlingForSaveMesh(e,t){let n=this.createModelUpdateHandler(t);e&&n(e)}setupModelHandling(e,t,n){let r=this.createModelUpdateHandler(t,n);e.value&&r(e.value);let i=e.callback,a=e.value;Object.defineProperty(e,`value`,{get(){return a},set(t){a=t,e.callback&&t!==void 0&&t!==``&&e.callback(t)},enumerable:!0,configurable:!0}),e.callback=e=>{r(e),i&&i(e)}}setupDefaultProperties(e){let t=this.loadSceneConfig();this.applySceneConfig(t,e);let n=this.loadCameraConfig();this.applyCameraConfig(n);let r=this.loadLightConfig();this.applyLightConfig(r)}loadSceneConfig(){return this.properties&&`Scene Config`in this.properties?this.properties[`Scene Config`]:{showGrid:I().get(`Comfy.Load3D.ShowGrid`),backgroundColor:`#`+I().get(`Comfy.Load3D.BackgroundColor`),backgroundImage:``}}loadCameraConfig(){return this.properties&&`Camera Config`in this.properties?this.properties[`Camera Config`]:{cameraType:I().get(`Comfy.Load3D.CameraType`),fov:35}}loadLightConfig(){return this.properties&&`Light Config`in this.properties?this.properties[`Light Config`]:{intensity:I().get(`Comfy.Load3D.LightIntensity`)}}loadModelConfig(){return this.properties&&`Model Config`in this.properties?this.properties[`Model Config`]:{upDirection:`original`,materialMode:`original`,showSkeleton:!1}}applySceneConfig(e,t){if(this.load3d.toggleGrid(e.showGrid),this.load3d.setBackgroundColor(e.backgroundColor),e.backgroundImage){if(t&&t!=e.backgroundImage)return;this.load3d.setBackgroundImage(e.backgroundImage),e.backgroundRenderMode&&this.load3d.setBackgroundRenderMode(e.backgroundRenderMode)}}applyCameraConfig(e){this.load3d.toggleCamera(e.cameraType),this.load3d.setFOV(e.fov),e.state&&this.load3d.setCameraState(e.state)}applyLightConfig(e){this.load3d.setLightIntensity(e.intensity)}applyModelConfig(e){this.load3d.setUpDirection(e.upDirection),this.load3d.setMaterialMode(e.materialMode)}createModelUpdateHandler(e,t){let n=!0;return async r=>{if(!r)return;let i=r;this.setResourceFolder(i);let a=v.apiURL(P.getResourceURL(...P.splitFilePath(i),e));await this.load3d.loadModel(a,i);let o=this.loadModelConfig();if(this.applyModelConfig(o),n&&t){try{this.load3d.setCameraState(t)}catch(e){console.warn(`Failed to restore camera state:`,e)}n=!1}}}setResourceFolder(e){let t=e.split(`/`).filter(e=>e.trim());if(t.length<=2)return;let n=t.slice(1,-1).join(`/`);n&&this.properties&&(this.properties[`Resource Folder`]=n)}},X=Load3DConfiguration}));async function handleModelUpload(e,t){if(!e?.length)return;let n=t.widgets?.find(e=>e.name===`model_file`);try{let r=t.properties[`Resource Folder`]||``,i=r.trim()?`3d/${r.trim()}`:`3d`,a=await P.uploadFile(e[0],i);if(!a){m().addAlert(w(`toastMessages.fileUploadFailed`));return}let o=v.apiURL(P.getResourceURL(...P.splitFilePath(a),`input`));R(t).waitForLoad3d(e=>{try{e.loadModel(o)}catch{m().addAlert(w(`toastMessages.failedToLoadModel`))}}),a&&n&&(n.options?.values?.includes(a)||n.options?.values?.push(a),n.value=a)}catch(e){console.error(`Model upload failed:`,e),m().addAlert(w(`toastMessages.fileUploadFailed`))}}async function handleResourcesUpload(e,t){if(e?.length)try{let n=t.properties[`Resource Folder`]||``,r=n.trim()?`3d/${n.trim()}`:`3d`;await P.uploadMultipleFiles(e,r)}catch(e){console.error(`Extra resources upload failed:`,e),m().addAlert(w(`toastMessages.extraResourcesUploadFailed`))}}function createFileInput(e,t=!1){let n=document.createElement(`input`);return n.type=`file`,n.accept=e,n.multiple=t,n.style.display=`none`,n}var dn,fn,pn=t((()=>{r(),Nt(),Qe(),ot(),ln(),un(),et(),C(),g(),h(),M(),ke(),N(),He(),kt(),bt(),dn={name:`image`,type:`Load3D`,isPreview:!1},fn={name:`image`,type:`Preview3D`,isPreview:!0},B().registerExtension({name:`Comfy.Load3D`,settings:[{id:`Comfy.Load3D.ShowGrid`,category:[`3D`,`Scene`,`Initial Grid Visibility`],name:`Initial Grid Visibility`,tooltip:`Controls whether the grid is visible by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.`,type:`boolean`,defaultValue:!0,experimental:!0},{id:`Comfy.Load3D.BackgroundColor`,category:[`3D`,`Scene`,`Initial Background Color`],name:`Initial Background Color`,tooltip:`Controls the default background color of the 3D scene. This setting determines the background appearance when a new 3D widget is created, but can be adjusted individually for each widget after creation.`,type:`color`,defaultValue:`282828`,experimental:!0},{id:`Comfy.Load3D.CameraType`,category:[`3D`,`Camera`,`Initial Camera Type`],name:`Initial Camera Type`,tooltip:`Controls whether the camera is perspective or orthographic by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.`,type:`combo`,options:[`perspective`,`orthographic`],defaultValue:`perspective`,experimental:!0},{id:`Comfy.Load3D.LightIntensity`,category:[`3D`,`Light`,`Initial Light Intensity`],name:`Initial Light Intensity`,tooltip:`Sets the default brightness level of lighting in the 3D scene. This value determines how intensely lights illuminate objects when a new 3D widget is created, but can be adjusted individually for each widget after creation.`,type:`number`,defaultValue:3,experimental:!0},{id:`Comfy.Load3D.LightIntensityMaximum`,category:[`3D`,`Light`,`Light Intensity Maximum`],name:`Light Intensity Maximum`,tooltip:`Sets the maximum allowable light intensity value for 3D scenes. This defines the upper brightness limit that can be set when adjusting lighting in any 3D widget.`,type:`number`,defaultValue:10,experimental:!0},{id:`Comfy.Load3D.LightIntensityMinimum`,category:[`3D`,`Light`,`Light Intensity Minimum`],name:`Light Intensity Minimum`,tooltip:`Sets the minimum allowable light intensity value for 3D scenes. This defines the lower brightness limit that can be set when adjusting lighting in any 3D widget.`,type:`number`,defaultValue:1,experimental:!0},{id:`Comfy.Load3D.LightAdjustmentIncrement`,category:[`3D`,`Light`,`Light Adjustment Increment`],name:`Light Adjustment Increment`,tooltip:`Controls the increment size when adjusting light intensity in 3D scenes. A smaller step value allows for finer control over lighting adjustments, while a larger value results in more noticeable changes per adjustment.`,type:`slider`,attrs:{min:.1,max:1,step:.1},defaultValue:.5,experimental:!0},{id:`Comfy.Load3D.3DViewerEnable`,category:[`3D`,`3DViewer`,`Enable`],name:`Enable 3D Viewer (Beta)`,tooltip:`Enables the 3D Viewer (Beta) for selected nodes. This feature allows you to visualize and interact with 3D models directly within the full size 3d viewer.`,type:`boolean`,defaultValue:!1,experimental:!0},{id:`Comfy.Load3D.PLYEngine`,category:[`3D`,`PLY`,`PLY Engine`],name:`PLY Engine`,tooltip:`Select the engine for loading PLY files. "threejs" uses the native Three.js PLYLoader (best for mesh PLY files). "fastply" uses an optimized loader for ASCII point cloud PLY files. "sparkjs" uses Spark.js for 3D Gaussian Splatting PLY files.`,type:`combo`,options:[`threejs`,`fastply`,`sparkjs`],defaultValue:`threejs`,experimental:!0}],commands:[{id:`Comfy.3DViewer.Open3DViewer`,icon:`pi pi-pencil`,label:`Open 3D Viewer (Beta) for Selected Node`,function:()=>{let e=F.canvas.selected_nodes;if(!e||Object.keys(e).length!==1)return;let t=e[Object.keys(e)[0]];if(!$e(t))return;z.copyToClipspace(t),z.clipspace_return_node=t;let n={node:t};it().showDialog({key:`global-load3d-viewer`,title:w(`load3d.viewer.title`),component:Ne,props:n,dialogComponentProps:{style:`width: 80vw; height: 80vh;`,maximizable:!0,onClose:async()=>{await Ce().handleViewerClose(n.node)}}})}}],getCustomWidgets(){return{LOAD_3D(e){let t=createFileInput(`.gltf,.glb,.obj,.fbx,.stl,.ply,.spz,.splat,.ksplat`,!1);e.properties[`Resource Folder`]=``,t.onchange=async()=>{await handleModelUpload(t.files,e)},e.addWidget(`button`,`upload 3d model`,`upload3dmodel`,()=>{t.click()});let n=createFileInput(`*`,!0);n.onchange=async()=>{await handleResourcesUpload(n.files,e),n.value=``},e.addWidget(`button`,`upload extra resources`,`uploadExtraResources`,()=>{n.click()}),e.addWidget(`button`,`clear`,`clear`,()=>{R(e).waitForLoad3d(e=>{e.clearModel()});let t=e.widgets?.find(e=>e.name===`model_file`);t&&(t.value=``)});let r=new Ge({node:e,name:`image`,component:Pt,inputSpec:dn,options:{}});return r.type=`load3D`,Je(e,r),{widget:r}}}},getNodeMenuItems(e){if(e.constructor.comfyClass!==`Load3D`)return[];let t=Ce().getLoad3d(e);return!t||t.isSplatModel()?[]:createExportMenuItems(t)},async nodeCreated(e){if(e.constructor.comfyClass!==`Load3D`)return;let[t,n]=e.size;e.setSize([Math.max(t,300),Math.max(n,600)]),await o(),R(e).waitForLoad3d(t=>{let n=e.properties[`Camera Config`]?.state,r=new X(t,e.properties),i=e.widgets?.find(e=>e.name===`model_file`),a=e.widgets?.find(e=>e.name===`width`),o=e.widgets?.find(e=>e.name===`height`),s=e.widgets?.find(e=>e.name===`image`);if(i&&a&&o&&s){let t={loadFolder:`input`,modelWidget:i,cameraState:n,width:a,height:o};r.configure(t),s.serializeValue=async()=>{let t=Ot.get(e);if(!t)return console.error(`No load3d instance found for node`),null;let n=e.properties[`Camera Config`]||{cameraType:t.getCurrentCameraType(),fov:t.cameraManager.perspectiveCamera.fov};n.state=t.getCameraState(),e.properties[`Camera Config`]=n,t.stopRecording();let{scene:r,mask:i,normal:s}=await t.captureScene(a.value,o.value),[c,l,u]=await Promise.all([P.uploadTempImage(r,`scene`),P.uploadTempImage(i,`scene_mask`),P.uploadTempImage(s,`scene_normal`)]);t.handleResize();let d={image:`threed/${c.name} [temp]`,mask:`threed/${l.name} [temp]`,normal:`threed/${u.name} [temp]`,camera_info:e.properties[`Camera Config`]?.state||null,recording:``},f=t.getRecordingData();if(f){let[e]=await Promise.all([P.uploadTempImage(f,`recording`,`mp4`)]);d.recording=`threed/${e.name} [temp]`}return d}}})}}),B().registerExtension({name:`Comfy.Preview3D`,async beforeRegisterNodeDef(e,t){t.name===`Preview3D`&&(t.input.required.image=[`PREVIEW_3D`])},getNodeMenuItems(e){if(e.constructor.comfyClass!==`Preview3D`)return[];let t=Ce().getLoad3d(e);return!t||t.isSplatModel()?[]:createExportMenuItems(t)},getCustomWidgets(){return{PREVIEW_3D(e){let t=new Ge({node:e,name:fn.name,component:Pt,inputSpec:fn,options:{}});return t.type=`load3D`,Je(e,t),{widget:t}}}},async nodeCreated(e){if(e.constructor.comfyClass!==`Preview3D`)return;let[t,n]=e.size;e.setSize([Math.max(t,400),Math.max(n,550)]),await o();let r=e.onExecuted;R(e).waitForLoad3d(t=>{let n=new X(t,e.properties),i=e.widgets?.find(e=>e.name===`model_file`);if(i){let a=e.properties[`Last Time Model File`];if(a){i.value=a;let t={loadFolder:`output`,modelWidget:i,cameraState:e.properties[`Camera Config`]?.state};n.configure(t)}e.onExecuted=function(a){r?.call(this,a);let o=a.result,s=o?.[0];if(!s){let e=w(`toastMessages.unableToGetModelFilePath`);console.error(e),m().addAlert(e)}let c=o?.[1],l=o?.[2];i.value=s?.replaceAll(`\\`,`/`),e.properties[`Last Time Model File`]=i.value;let u={loadFolder:`output`,modelWidget:i,cameraState:c,bgImagePath:l};n.configure(u),l&&t.setBackgroundImage(l)}}})}})}));function openMaskEditor(e){if(!e){console.error(`[MaskEditor] No node provided`);return}if(!e.imgs?.length&&e.previewMediaType!==`image`){console.error(`[MaskEditor] Node has no images`);return}Ke().openMaskEditor(e)}function openMaskEditorFromClipspace(){let e=z.clipspace_return_node;if(!e){console.error(`[MaskEditor] No clipspace_return_node found`);return}openMaskEditor(e)}function isOpened(){return it().isDialogOpen(`global-mask-editor`)}var changeBrushSize,mn=t((()=>{c(),M(),Fe(),kt(),je(),Ye(),changeBrushSize=async e=>{if(!isOpened())return;let t=Ct(),n=t.brushSettings.size,r=e(n);t.setBrushSize(r)},F.registerExtension({name:`Comfy.MaskEditor`,settings:[{id:`Comfy.MaskEditor.BrushAdjustmentSpeed`,category:[`Mask Editor`,`BrushAdjustment`,`Sensitivity`],name:`Brush adjustment speed multiplier`,tooltip:`Controls how quickly the brush size and hardness change when adjusting. Higher values mean faster changes.`,type:`slider`,attrs:{min:.1,max:2,step:.1},defaultValue:1,versionAdded:`1.0.0`},{id:`Comfy.MaskEditor.UseDominantAxis`,category:[`Mask Editor`,`BrushAdjustment`,`UseDominantAxis`],name:`Lock brush adjustment to dominant axis`,tooltip:`When enabled, brush adjustments will only affect size OR hardness based on which direction you move more`,type:`boolean`,defaultValue:!0}],commands:[{id:`Comfy.MaskEditor.OpenMaskEditor`,icon:`pi pi-pencil`,label:`Open Mask Editor for Selected Node`,function:()=>{let e=F.canvas.selected_nodes;if(!e||Object.keys(e).length!==1)return;let t=e[Object.keys(e)[0]];openMaskEditor(t)}},{id:`Comfy.MaskEditor.BrushSize.Increase`,icon:`pi pi-plus-circle`,label:`Increase Brush Size in MaskEditor`,function:()=>changeBrushSize(e=>f.clamp(e+2,1,250))},{id:`Comfy.MaskEditor.BrushSize.Decrease`,icon:`pi pi-minus-circle`,label:`Decrease Brush Size in MaskEditor`,function:()=>changeBrushSize(e=>f.clamp(e-2,1,250))},{id:`Comfy.MaskEditor.ColorPicker`,icon:`pi pi-palette`,label:`Open Color Picker in MaskEditor`,function:()=>{isOpened()&&Ct().colorInput?.click()}},{id:`Comfy.MaskEditor.Rotate.Right`,icon:`pi pi-refresh`,label:`Rotate Right in MaskEditor`,function:async()=>{isOpened()&&await E().rotateClockwise()}},{id:`Comfy.MaskEditor.Rotate.Left`,icon:`pi pi-undo`,label:`Rotate Left in MaskEditor`,function:async()=>{isOpened()&&await E().rotateCounterclockwise()}},{id:`Comfy.MaskEditor.Mirror.Horizontal`,icon:`pi pi-arrows-h`,label:`Mirror Horizontal in MaskEditor`,function:async()=>{isOpened()&&await E().mirrorHorizontal()}},{id:`Comfy.MaskEditor.Mirror.Vertical`,icon:`pi pi-arrows-v`,label:`Mirror Vertical in MaskEditor`,function:async()=>{isOpened()&&await E().mirrorVertical()}}],init(){z.open_maskeditor=openMaskEditorFromClipspace,console.warn(`[MaskEditor] ComfyApp.open_maskeditor is deprecated. Plugins should migrate to using the command system or direct node context menu integration.`)}})})),hn,gn,ManageTemplates,Z,clipboardAction,_n,vn=t((()=>{vt(),C(),g(),Dt(),pt(),h(),M(),We(),rn(),hn=`Comfy.NodeTemplates`,gn=`comfy.templates.json`,ManageTemplates=class extends Ae{templates=[];draggedEl;saveVisualCue;emptyImg;importInput;constructor(){super(),this.load().then(e=>{this.templates=e}),this.element.classList.add(`comfy-manage-templates`),this.draggedEl=null,this.saveVisualCue=null,this.emptyImg=new Image,this.emptyImg.src=`data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=`,this.importInput=A(`input`,{type:`file`,accept:`.json`,multiple:!0,style:{display:`none`},parent:document.body,onchange:()=>this.importAll()})}createButtons(){let e=super.createButtons();return e[0].textContent=`Close`,e[0].onclick=()=>{clearTimeout(this.saveVisualCue),this.close()},e.unshift(A(`button`,{type:`button`,textContent:`Export`,onclick:()=>this.exportAll()})),e.unshift(A(`button`,{type:`button`,textContent:`Import`,onclick:()=>{this.importInput.click()}})),e}async load(){let e=[],t=await v.getUserData(gn);if(t.status===200)try{e=await t.json()}catch{}else t.status!==404&&console.error(t.status+` `+t.statusText);return e??[]}async store(){let e=JSON.stringify(this.templates,void 0,4);try{await v.storeUserData(gn,e,{stringify:!1})}catch(e){console.error(e),m().addAlert(e.message)}}async importAll(){for(let e of this.importInput.files)if(e.type===`application/json`||e.name.endsWith(`.json`)){let t=new FileReader;t.onload=async()=>{let e=JSON.parse(t.result);if(e?.templates){for(let t of e.templates)t?.name&&t?.data&&this.templates.push(t);await this.store()}},await t.readAsText(e)}this.importInput.value=null,this.close()}exportAll(){if(this.templates.length==0){m().addAlert(w(`toastMessages.noTemplatesToExport`));return}let e=JSON.stringify({templates:this.templates},null,2);st(`node_templates.json`,new Blob([e],{type:`application/json`}))}show(){super.show(A(`div`,{},this.templates.flatMap((e,t)=>{let n;return[A(`div`,{dataset:{id:t.toString()},className:`templateManagerRow`,style:{display:`grid`,gridTemplateColumns:`1fr auto`,border:`1px dashed transparent`,gap:`5px`,backgroundColor:`var(--comfy-menu-bg)`},ondragstart:e=>{this.draggedEl=e.currentTarget,e.currentTarget.style.opacity=`0.6`,e.currentTarget.style.border=`1px dashed yellow`,e.dataTransfer.effectAllowed=`move`,e.dataTransfer.setDragImage(this.emptyImg,0,0)},ondragend:e=>{e.target.style.opacity=`1`,e.currentTarget.style.border=`1px dashed transparent`,e.currentTarget.removeAttribute(`draggable`),this.element.querySelectorAll(`.templateManagerRow`).forEach((e,t)=>{var n=Number.parseInt(e.dataset.id);e==this.draggedEl&&n!=t&&this.templates.splice(t,0,this.templates.splice(n,1)[0]),e.dataset.id=t.toString()}),this.store()},ondragover:e=>{if(e.preventDefault(),e.currentTarget==this.draggedEl)return;let t=e.currentTarget.getBoundingClientRect();e.clientY>t.top+t.height/2?e.currentTarget.parentNode.insertBefore(this.draggedEl,e.currentTarget.nextSibling):e.currentTarget.parentNode.insertBefore(this.draggedEl,e.currentTarget)}},[A(`label`,{textContent:`Name: `,style:{cursor:`grab`},onmousedown:e=>{e.target.localName==`label`&&(e.currentTarget.parentNode.draggable=`true`)}},[A(`input`,{value:e.name,dataset:{name:e.name},style:{transitionProperty:`background-color`,transitionDuration:`0s`},onchange:e=>{clearTimeout(this.saveVisualCue);var t=e.target,n=t.parentNode.parentNode;this.templates[n.dataset.id].name=t.value.trim()||`untitled`,this.store(),t.style.backgroundColor=`rgb(40, 95, 40)`,t.style.transitionDuration=`0s`,this.saveVisualCue=setTimeout(function(){t.style.transitionDuration=`.7s`,t.style.backgroundColor=`var(--comfy-input-bg)`},15)},onkeypress:e=>{var t=e.target;clearTimeout(this.saveVisualCue),t.style.transitionDuration=`0s`,t.style.backgroundColor=`var(--comfy-input-bg)`},$:e=>n=e})]),A(`div`,{},[A(`button`,{textContent:`Export`,style:{fontSize:`12px`,fontWeight:`normal`},onclick:()=>{let t=JSON.stringify({templates:[e]},null,2),r=new Blob([t],{type:`application/json`});st((n.value||e.name)+`.json`,r)}}),A(`button`,{textContent:`Delete`,style:{fontSize:`12px`,color:`red`,fontWeight:`normal`},onclick:e=>{let t=e.target.parentNode.parentNode;t.parentNode.removeChild(t),this.templates.splice(t.dataset.id*1,1),this.store();var n=this;setTimeout(function(){n.element.querySelectorAll(`.templateManagerRow`).forEach((e,t)=>{e.dataset.id=t.toString()})},0)}})])])]})))}},Z=new ManageTemplates,clipboardAction=async e=>{let t=localStorage.getItem(`litegrapheditor_clipboard`);await e(),localStorage.setItem(`litegrapheditor_clipboard`,t)},_n={name:hn,getCanvasMenuItems(e){let t=[];t.push(null),t.push({content:`Save Selected as Template`,disabled:!Object.keys(F.canvas.selected_nodes||{}).length,callback:async()=>{let e=await L().prompt({title:w(`nodeTemplates.saveAsTemplate`),message:w(`nodeTemplates.enterName`),defaultValue:``});e?.trim()&&clipboardAction(()=>{F.canvas.copyToClipboard();let t=localStorage.getItem(`litegrapheditor_clipboard`);t=JSON.parse(t||`{}`);let n=Object.keys(F.canvas.selected_nodes);for(let e=0;e<n.length;e++){let r=F.canvas.graph?.getNodeById(n[e]),i=r?.constructor.nodeData;if(!r)continue;let a=J.getGroupData(r);if(a){let n=a.nodeData;if(t.groupNodes||={},i==null)throw TypeError(`nodeData is not set`);t.groupNodes[i.name]=n,t.nodes[e].type=i.name}}Z.templates.push({name:e,data:JSON.stringify(t)}),Z.store()})}});let n=Z.templates.map(e=>({content:e.name,callback:()=>{clipboardAction(async()=>{let t=JSON.parse(e.data);await q.registerFromWorkflow(t.groupNodes??{},[]),t.reroutes?(localStorage.setItem(`litegrapheditor_clipboard`,e.data),F.canvas.pasteFromClipboard()):gt(e.data,F.canvas)})}}));return n.push(null,{content:`Manage`,callback:()=>Z.show()}),t.push({content:`Node Templates`,submenu:{options:n}}),t}},F.registerExtension(_n)})),yn=t((()=>{S(),M(),mt(),F.registerExtension({name:`Comfy.NoteNode`,registerCustomNodes(){class NoteNode extends _{static category;static collapsable;static title_mode;groupcolor=x.node_colors.yellow.groupcolor;isVirtualNode;constructor(e){super(e),this.color=x.node_colors.yellow.color,this.bgcolor=x.node_colors.yellow.bgcolor,this.properties||={text:``},T.STRING(this,`text`,[`STRING`,{default:this.properties.text,multiline:!0}],F),this.serialize_widgets=!0,this.isVirtualNode=!0}}y.registerNodeType(`Note`,Object.assign(NoteNode,{title_mode:y.NORMAL_TITLE,title:`Note`,collapsable:!0})),NoteNode.category=`utils`;class MarkdownNoteNode extends _{static title=`Markdown Note`;groupcolor=x.node_colors.yellow.groupcolor;constructor(e){super(e),this.color=x.node_colors.yellow.color,this.bgcolor=x.node_colors.yellow.bgcolor,this.properties||={text:``},T.MARKDOWN(this,`text`,[`STRING`,{default:this.properties.text}],F),this.serialize_widgets=!0,this.isVirtualNode=!0}}y.registerNodeType(`MarkdownNote`,MarkdownNoteNode),MarkdownNoteNode.category=`utils`}})})),bn=t((()=>{M(),ke(),mt(),N(),B().registerExtension({name:`Comfy.PreviewAny`,async beforeRegisterNodeDef(e,t){if(t.name===`PreviewAny`){let t=e.prototype.onNodeCreated;e.prototype.onNodeCreated=function(){t&&t.apply(this,[]);let e=T.MARKDOWN(this,`preview`,[`MARKDOWN`,{}],F).widget,n=T.STRING(this,`preview`,[`STRING`,{multiline:!0}],F).widget,r=T.BOOLEAN(this,`previewMode`,[`BOOLEAN`,{label_on:`Markdown`,label_off:`Plaintext`,default:!1}],F);r.widget.callback=t=>{e.hidden=!t,e.options.hidden=!t,n.hidden=t,n.options.hidden=t},e.hidden=!0,e.options.hidden=!0,e.options.read_only=!0,e.element.readOnly=!0,e.element.disabled=!0,e.serialize=!1,n.hidden=!1,n.options.hidden=!1,n.options.read_only=!0,n.element.readOnly=!0,n.element.disabled=!0,n.serialize=!1};let n=e.prototype.onExecuted;e.prototype.onExecuted=function(e){n?.apply(this,[e]);let t=this.widgets?.filter(e=>e.name===`preview`)??[];for(let n of t){let t=e.text??``;n.value=Array.isArray(t)?t?.join(`

`)??``:t}}}}})})),xn=t((()=>{S(),M(),en(),F.registerExtension({name:`Comfy.RerouteNode`,registerCustomNodes(){class RerouteNode extends _{static category;static defaultVisibility=!1;constructor(e){super(e??``),this.properties||={},this.properties.showOutputText=RerouteNode.defaultVisibility,this.properties.horizontal=!1,this.addInput(``,`*`),this.addOutput(this.properties.showOutputText?`*`:``,`*`),this.isVirtualNode=!0}onAfterGraphConfigured(){requestAnimationFrame(()=>{this.onConnectionsChange(y.INPUT,void 0,!0)})}clone(){let e=super.clone();return e&&(e.removeOutput(0),e.addOutput(this.properties.showOutputText?`*`:``,`*`),e.setSize(e.computeSize()),e)}onConnectionsChange(e,t,n){let{graph:r}=this;if(!r||F.configuringGraph)return;if(n&&e===y.OUTPUT&&new Set(this.outputs[0].links?.map(e=>r.links[e]?.type)?.filter(e=>e&&e!==`*`)??[]).size>1){let e=[];for(let t of this.outputs[0].links??[]){let n=r.links[t];e.push(n)}e.pop();for(let t of e)r.getNodeById(t.target_id)?.disconnectInput(t.target_slot)}let i=this,a=[],o=null,s=null;for(;i;){a.unshift(i);let e=i.inputs[0].link;if(e!==null){let t=r.links[e];if(!t)return;let n=r.getNodeById(t.origin_id);if(!n)return;if(n instanceof RerouteNode)n===this?(i.disconnectInput(t.target_slot),i=null):i=n;else{s=i,o=n.outputs[t.origin_slot]?.type??null;break}}else{i=null;break}}let c=[this],l=null;for(;c.length;){i=c.pop();let e=i.outputs?.[0]?.links??[];for(let t of e){let e=r.links[t];if(!e)continue;let n=r.getNodeById(e.target_id);if(n)if(n instanceof RerouteNode)c.push(n),a.push(n);else{let t=n.inputs[e.target_slot],r=t.type,i=!o||!r||y.isValidConnection(o,r);if(!i){n.disconnectInput(e.target_slot);continue}n.onConnectionsChange?.(y.INPUT,e.target_slot,i,e,t),l=n.inputs[e.target_slot].type}}}let u=o||l||`*`,d=x.link_type_colors[u],f,p;for(let e of a){e.outputs[0].type=o||`*`,e.__outputType=u,e.outputs[0].name=e.properties.showOutputText?`${u}`:``,e.setSize(e.computeSize());for(let t of e.outputs[0].links||[]){let e=r.links[t];if(!e||(e.color=d,F.configuringGraph))continue;let n=r.getNodeById(e.target_id);if(!n)continue;let i=n.inputs?.[e.target_slot];if(i?.widget){let e=getWidgetConfig(i);f||(f=e[1]??{},p=e[0]);let t=mergeIfValid(i,[e[0],f]);t.customConfig&&(f=t.customConfig)}}}for(let e of a)f&&l?(e.inputs[0].widget={name:`value`},setWidgetConfig(e.inputs[0],[p??`${u}`,f])):setWidgetConfig(e.inputs[0],void 0);if(s?.inputs?.[0]?.link){let e=r.links[s.inputs[0].link];e&&(e.color=d)}}getExtraMenuOptions(e,t){return t.unshift({content:(this.properties.showOutputText?`Hide`:`Show`)+` Type`,callback:()=>{this.properties.showOutputText=!this.properties.showOutputText,this.properties.showOutputText?this.outputs[0].name=`${this.__outputType||this.outputs[0].type}`:this.outputs[0].name=``,this.setSize(this.computeSize()),F.canvas.setDirty(!0,!0)}},{content:(RerouteNode.defaultVisibility?`Hide`:`Show`)+` Type By Default`,callback:()=>{RerouteNode.setDefaultTextVisibility(!RerouteNode.defaultVisibility)}}),[]}computeSize(){return[this.properties.showOutputText&&this.outputs&&this.outputs.length?Math.max(75,y.NODE_TEXT_SIZE*this.outputs[0].name.length*.6+40):75,26]}static setDefaultTextVisibility(e){RerouteNode.defaultVisibility=e,e?localStorage[`Comfy.RerouteNode.DefaultVisibility`]=`true`:delete localStorage[`Comfy.RerouteNode.DefaultVisibility`]}}RerouteNode.setDefaultTextVisibility(!!localStorage[`Comfy.RerouteNode.DefaultVisibility`]),y.registerNodeType(`Reroute`,Object.assign(RerouteNode,{title_mode:y.NO_TITLE,title:`Reroute`,collapsable:!1})),RerouteNode.category=`utils`}})})),Sn,Cn=t((()=>{St(),M(),Sn=new Set([`SaveImage`,`SaveVideo`,`SaveAnimatedWEBP`,`SaveWEBM`,`SaveAudio`,`SaveGLB`,`SaveAnimatedPNG`,`CLIPSave`,`VAESave`,`ModelSave`,`LoraSave`,`SaveLatent`]),F.registerExtension({name:`Comfy.SaveImageExtraOutput`,async beforeRegisterNodeDef(e,t){if(Sn.has(t.name)){let t=e.prototype.onNodeCreated;e.prototype.onNodeCreated=function(){let e=t?t.apply(this,arguments):void 0,n=this.widgets.find(e=>e.name===`filename_prefix`);return n.serializeValue=()=>Pe(F.graph,n.value),e}}else{let t=e.prototype.onNodeCreated;e.prototype.onNodeCreated=function(){let e=t?t.apply(this,arguments):void 0;return(!this.properties||!(`Node name for S&R`in this.properties))&&this.addProperty(`Node name for S&R`,this.constructor.type,`string`),e}}}})})),wn,Tn=t((()=>{r(),Nt(),ot(),ln(),un(),et(),ke(),N(),He(),wn={name:`image`,type:`Preview3D`,isPreview:!0},B().registerExtension({name:`Comfy.SaveGLB`,async beforeRegisterNodeDef(e,t){t.name===`SaveGLB`&&(t.input.required.image=[`PREVIEW_3D`])},getCustomWidgets(){return{PREVIEW_3D(e){let t=new Ge({node:e,name:wn.name,component:Pt,inputSpec:wn,options:{}});return t.type=`load3D`,Je(e,t),{widget:t}}}},getNodeMenuItems(e){if(e.constructor.comfyClass!==`SaveGLB`)return[];let t=Ce().getLoad3d(e);return!t||t.isSplatModel()?[]:createExportMenuItems(t)},async nodeCreated(e){if(e.constructor.comfyClass!==`SaveGLB`)return;let[t,n]=e.size;e.setSize([Math.max(t,400),Math.max(n,550)]),await o();let r=e.onExecuted;e.onExecuted=function(t){r?.call(this,t);let n=t[`3d`]?.[0];n&&R(e).waitForLoad3d(t=>{let r=e.widgets?.find(e=>e.name===`image`);if(t&&r){let i=(n.subfolder??``)+`/`+(n.filename??``);r.value=i;let a=new X(t,e.properties),o=n.type,onModelLoaded=()=>{t.removeEventListener(`modelLoadingEnd`,onModelLoaded),P.generateThumbnailIfNeeded(t,i,o)};t.addEventListener(`modelLoadingEnd`,onModelLoaded),a.configureForSaveMesh(o,i)}})}}})}));function drawSelectionBorder(e,t){let n=t.selectedItems;if(n.size<=1)return;let r=re(n,10);if(!r)return;let[i,a,o,s]=r;e.save(),e.lineWidth=2/t.ds.scale,e.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue(`--border-color`).trim()||`#ffffff66`;let c=5/t.ds.scale;e.setLineDash([c,c]),e.beginPath(),e.roundRect(i,a,o,s,8/t.ds.scale),e.stroke(),e.restore()}var En=t((()=>{S(),M(),F.registerExtension({name:`Comfy.SelectionBorder`,async init(){let e=F.canvas.onDrawForeground;F.canvas.onDrawForeground=function(t,n){e?.call(this,t,n),drawSelectionBorder(t,F.canvas)}}})})),Q,$,Dn,On,kn=t((()=>{S(),M(),Q=!1,$=0,F.registerExtension({name:`Comfy.SimpleTouchSupport`,setup(){let e=null,t=null,n=null,r=null;function getMultiTouchPos(e){return Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY)}function getMultiTouchCenter(e){return{clientX:(e.touches[0].clientX+e.touches[1].clientX)/2,clientY:(e.touches[0].clientY+e.touches[1].clientY)/2}}F.canvasEl.parentElement?.addEventListener(`touchstart`,i=>{$+=i.changedTouches.length,n=null,r=null,i.touches?.length===1?(t=new Date,n=i.touches[0]):(t=null,i.touches?.length===2&&(r=F.canvas.ds.scale,n=getMultiTouchCenter(i),e=getMultiTouchPos(i),F.canvas.pointer.isDown=!1))},!0),F.canvasEl.parentElement?.addEventListener(`touchend`,e=>{if($-=e.changedTouches.length,e.touches?.length!==1&&(Q=!1),t&&!e.touches?.length){if(new Date().getTime()-t.getTime()>600&&e.target===F.canvasEl){let t={button:2,clientX:e.changedTouches[0].clientX,clientY:e.changedTouches[0].clientY,pointerId:1,isPrimary:!0};F.canvasEl.dispatchEvent(new PointerEvent(`pointerdown`,t)),setTimeout(()=>{F.canvasEl.dispatchEvent(new PointerEvent(`pointerup`,t))}),e.preventDefault()}t=null}});let resetTouchState=()=>{$=0,Q=!1,t=null,n=null,r=null,e=null};document.addEventListener(`visibilitychange`,()=>{document.hidden&&resetTouchState()}),F.canvasEl.parentElement?.addEventListener(`touchcancel`,resetTouchState),F.canvasEl.parentElement?.addEventListener(`touchmove`,i=>{if(t&&n&&i.touches?.length===1){let e=i.touches[0],r=e.clientX-n.clientX,a=e.clientY-n.clientY;r*r+a*a>30&&(t=null)}if(i.touches?.length===2&&n&&!i.ctrlKey&&!i.shiftKey){i.preventDefault(),F.canvas.pointer.isDown=!1,Q=!0,y.closeAllContextMenus(window),F.canvas.search_box?.close();let t=getMultiTouchPos(i),s=getMultiTouchCenter(i);if(r===null||e===null)return;let c=r*t/e,l=(s.clientX-n.clientX)/c,u=(s.clientY-n.clientY)/c;c<F.canvas.ds.min_scale?c=F.canvas.ds.min_scale:c>F.canvas.ds.max_scale&&(c=F.canvas.ds.max_scale);let d=F.canvas.ds.scale;F.canvas.ds.scale=c,Math.abs(F.canvas.ds.scale-1)<.01&&(F.canvas.ds.scale=1);let f=F.canvas.ds.scale,convertScaleToOffset=e=>[s.clientX/e-F.canvas.ds.offset[0],s.clientY/e-F.canvas.ds.offset[1]];var a=convertScaleToOffset(d),o=convertScaleToOffset(f);F.canvas.ds.offset[0]+=l+o[0]-a[0],F.canvas.ds.offset[1]+=u+o[1]-a[1],n.clientX=s.clientX,n.clientY=s.clientY,F.canvas.setDirty(!0,!0)}},!0)}}),Dn=x.prototype.processMouseDown,x.prototype.processMouseDown=function(e){if(!(Q||$))return F.canvas.pointer.isDown=!1,Dn.apply(this,[e])},On=x.prototype.processMouseMove,x.prototype.processMouseMove=function(e){if(!(Q||$>1))return On.apply(this,[e])}})),An=t((()=>{S(),M(),mt(),F.registerExtension({name:`Comfy.SlotDefaults`,suggestionsNumber:null,init(){y.search_filter_enabled=!0,y.middle_click_slot_add_default_node=!0,this.suggestionsNumber=F.ui.settings.addSetting({id:`Comfy.NodeSuggestions.number`,category:[`Comfy`,`Node Search Box`,`NodeSuggestions`],name:`Number of nodes suggestions`,tooltip:`Only for litegraph searchbox/context menu`,type:`slider`,attrs:{min:1,max:100,step:1},defaultValue:5,onChange:e=>{this.setDefaults(e)}})},slot_types_default_out:{},slot_types_default_in:{},async beforeRegisterNodeDef(e,t){var n=t.name;let r=t.input?.required;for(let t in r){var i=r[t];if(typeof i[0]!=`string`)continue;var a=i[0];if(a in T&&!i[1]?.forceInput||(a in this.slot_types_default_out||(this.slot_types_default_out[a]=[`Reroute`]),this.slot_types_default_out[a].includes(n)))continue;this.slot_types_default_out[a].push(n);let o=a.toLocaleLowerCase();o in y.registered_slot_in_types||(y.registered_slot_in_types[o]={nodes:[]}),y.registered_slot_in_types[o].nodes.push(e.comfyClass)}var o=t.output??[];for(let t of o){let r=t;r in this.slot_types_default_in||(this.slot_types_default_in[r]=[`Reroute`]),!this.slot_types_default_in[r].includes(n)&&(this.slot_types_default_in[r].push(n),r in y.registered_slot_out_types||(y.registered_slot_out_types[r]={nodes:[]}),y.registered_slot_out_types[r].nodes.push(e.comfyClass),y.slot_types_out.includes(r)||y.slot_types_out.push(r))}var s=this.suggestionsNumber.value;this.setDefaults(s)},setDefaults(e){for(let t in y.slot_types_default_out={},y.slot_types_default_in={},this.slot_types_default_out)y.slot_types_default_out[t]=this.slot_types_default_out[t].slice(0,e);for(let t in this.slot_types_default_in)y.slot_types_default_in[t]=this.slot_types_default_in[t].slice(0,e)}})}));function updateUIWidget(e,t=``){e.element.src=t,e.value=t,e.callback?.(t),t?e.element.classList.remove(`empty-audio-widget`):e.element.classList.add(`empty-audio-widget`)}async function uploadFile(e,t,n,r,i=!1){try{let a=new FormData;a.append(`image`,n),i&&a.append(`subfolder`,`pasted`);let o=await v.fetchApi(`/upload/image`,{method:`POST`,body:a});if(o.status===200){let n=await o.json(),i=n.name;n.subfolder&&(i=n.subfolder+`/`+i),e.options.values.includes(i)||e.options.values.push(i),r&&(updateUIWidget(t,v.apiURL(V(...Ft(i)))),e.callback?.(i))}else m().addAlert(o.status+` - `+o.statusText)}catch(e){m().addAlert(e)}}var jn=t((()=>{d(),Me(),Be(),Le(),C(),g(),It(),Lt(),he(),h(),M(),F.registerExtension({name:`Comfy.AudioWidget`,async beforeRegisterNodeDef(e,t){[`LoadAudio`,`SaveAudio`,`PreviewAudio`,`SaveAudioMP3`,`SaveAudioOpus`].includes(e.prototype.comfyClass)&&(t.input.required.audioUI=[`AUDIO_UI`,{}])},getCustomWidgets(){return{AUDIO_UI(e,t){let n=document.createElement(`audio`);n.controls=!0,n.classList.add(`comfy-audio`),n.setAttribute(`name`,`media`);let r=e.addDOMWidget(t,`audioUI`,n);r.serialize=!1;let{nodeData:i}=e.constructor;if(i==null)throw TypeError(`nodeData is null`);if(i.output_node){r.element.classList.add(`empty-audio-widget`);let t=e.onExecuted;e.onExecuted=function(e){t?.call(this,e);let n=e.audio;if(!n?.length)return;let i=n[0],a=V(i.subfolder??``,i.filename??``,i.type);updateUIWidget(r,v.apiURL(a))}}let a=``;return r.options.getValue=()=>a,r.options.setValue=e=>a=e,{widget:r}}}},onNodeOutputsUpdated(e){for(let[t,n]of Object.entries(e)){if(!n.audio?.length)continue;let e=ue(F.rootGraph,t);if(!e)continue;let r=e.widgets?.find(e=>e.name===`audioUI`),i=n.audio[0],a=V(i.subfolder??``,i.filename??``,i.type);updateUIWidget(r,v.apiURL(a))}}}),F.registerExtension({name:`Comfy.UploadAudio`,async beforeRegisterNodeDef(e,t){t?.input?.required?.audio?.[1]?.audio_upload===!0&&(t.input.required.upload=[`AUDIOUPLOAD`,{}])},getCustomWidgets(){return{AUDIOUPLOAD(e,t){let n=e.widgets.find(e=>e.name===`audio`),r=e.widgets.find(e=>e.name===`audioUI`),onAudioWidgetUpdate=()=>{updateUIWidget(r,v.apiURL(V(...Ft(n.value??``))))};onAudioWidgetUpdate(),n.callback=onAudioWidgetUpdate;let i=e.onGraphConfigured;e.onGraphConfigured=function(){i?.apply(this,arguments),onAudioWidgetUpdate()};let handleUpload=async e=>(e?.length&&uploadFile(n,r,e[0],!0),e),isAudioFile=e=>e.type.startsWith(`audio/`),{openFileSelection:a}=De(e,{accept:`audio/*`,onSelect:handleUpload}),o=e.addWidget(`button`,t,``,a,{serialize:!1,canvasOnly:!0});return o.label=w(`g.choose_file_to_upload`),Ie(e,{fileFilter:isAudioFile,onDrop:handleUpload}),Re(e,{fileFilter:isAudioFile,onPaste:handleUpload}),e.previewMediaType=`audio`,{widget:o}}}}}),F.registerExtension({name:`Comfy.RecordAudio`,getCustomWidgets(){return{AUDIO_RECORD(e,t){let n=document.createElement(`audio`);n.controls=!0,n.classList.add(`comfy-audio`),n.setAttribute(`name`,`media`);let r=e.addDOMWidget(t,`audioUI`,n);r.options.canvasOnly=!1;let i=null,a=!1,o=[],s=null,c=null,u=null,d=null;r.serializeValue=async()=>{a&&i&&(u=new Promise(e=>{d=e}),i.stop(),await u);let e=r.element.src;if(!e)return m().addAlert(w(`g.noAudioRecorded`)),``;let t=await fetch(e).then(e=>e.blob());return await H().convertBlobToFileAndSubmit(t)},c=e.addWidget(`button`,t,``,async()=>{if(a)i&&a&&i.stop();else try{s=await navigator.mediaDevices.getUserMedia({audio:!0}),i=new l(s,{mimeType:`audio/wav`}),o=[],i.ondataavailable=e=>{o.push(e.data)},i.onstop=async()=>{let e=new Blob(o,{type:`audio/wav`});H().stopAllTracks(s),r.element.src&&r.element.src.startsWith(`blob:`)&&URL.revokeObjectURL(r.element.src),updateUIWidget(r,URL.createObjectURL(e)),a=!1,c&&(c.label=w(`g.startRecording`)),d&&(d(),d=null,u=null)},i.onerror=e=>{console.error(`MediaRecorder error:`,e),H().stopAllTracks(s),a=!1,c&&(c.label=w(`g.startRecording`)),d&&(d(),d=null,u=null)},i.start(),a=!0,c&&(c.label=w(`g.stopRecording`))}catch(e){if(console.error(`Error accessing microphone:`,e),m().addAlert(w(`g.micPermissionDenied`)),i)try{i.stop()}catch{}H().stopAllTracks(s),s=null,a=!1,c&&(c.label=w(`g.startRecording`))}},{serialize:!1,canvasOnly:!1}),c.label=w(`g.startRecording`),c.type=`audiorecord`;let f=e.onRemoved;return e.onRemoved=function(){a&&i&&i.stop(),H().stopAllTracks(s),r.element.src?.startsWith(`blob:`)&&URL.revokeObjectURL(r.element.src),f?.call(this)},{widget:c}}}},async nodeCreated(e){e.constructor.comfyClass===`RecordAudio`&&await H().registerWavEncoder()}})})),isMediaUploadComboInput,createUploadInput,Mn=t((()=>{ct(),M(),isMediaUploadComboInput=e=>{let[t,n]=e;return n?(n.image_upload===!0||n.video_upload===!0||n.animated_image_upload===!0)&&(ht(e)||t===`COMBO`):!1},createUploadInput=(e,t)=>[`IMAGEUPLOAD`,{...t[1],imageInputName:e}],F.registerExtension({name:`Comfy.UploadImage`,beforeRegisterNodeDef(e,t){let{input:n}=t??{},{required:r}=n??{};if(!r)return;let i=Object.entries(r).find(([e,t])=>isMediaUploadComboInput(t));if(i){let[e,t]=i;r.upload=createUploadInput(e,t)}}})})),Nn,Pn=t((()=>{C(),g(),h(),M(),Nn=Symbol(),F.registerExtension({name:`Comfy.WebcamCapture`,getCustomWidgets(){return{WEBCAM(e,t){let n;e[Nn]=new Promise(e=>n=e);let r=document.createElement(`div`);r.style.background=`rgba(0,0,0,0.25)`,r.style.textAlign=`center`;let i=document.createElement(`video`);i.style.height=i.style.width=`100%`;let loadVideo=async()=>{try{let e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});r.replaceChildren(i),setTimeout(()=>n(i),500),i.addEventListener(`loadedmetadata`,()=>n(i),!1),i.srcObject=e,i.play()}catch(e){let t=document.createElement(`div`);t.style.color=`red`,t.style.overflow=`auto`,t.style.maxHeight=`100%`,t.style.whiteSpace=`pre-wrap`,window.isSecureContext?t.textContent=`Unable to load webcam, please ensure access is granted:
`+e.message:t.textContent=`Unable to load webcam. A secure context is required, if you are not accessing ComfyUI on localhost (127.0.0.1) you will have to enable TLS (https)

`+e.message,r.replaceChildren(t)}};return loadVideo(),{widget:e.addDOMWidget(t,`WEBCAM`,r)}}}},nodeCreated(e){if(e.type,e.constructor.comfyClass!==`WebcamCapture`)return;let t,n=e.widgets.find(e=>e.name===`image`),r=e.widgets.find(e=>e.name===`width`),i=e.widgets.find(e=>e.name===`height`),a=e.widgets.find(e=>e.name===`capture_on_queue`),o=document.createElement(`canvas`),capture=()=>{o.width=r.value,o.height=i.value,o.getContext(`2d`).drawImage(t,0,0,r.value,i.value);let n=o.toDataURL(`image/png`),a=new Image;a.onload=()=>{e.imgs=[a],F.canvas.setDirty(!0)},a.src=n},s=e.addWidget(`button`,`waiting for camera...`,`capture`,capture,{canvasOnly:!0});s.disabled=!0,s.serializeValue=()=>void 0,n.serializeValue=async()=>{if(a.value)capture();else if(!e.imgs?.length){let e=`No webcam image captured`;throw m().addAlert(e),Error(e)}let t=await new Promise(e=>o.toBlob(e)),n=`${+new Date}.png`,r=new File([t],n),i=new FormData;i.append(`image`,r),i.append(`subfolder`,`webcam`),i.append(`type`,`temp`);let s=await v.fetchApi(`/upload/image`,{method:`POST`,body:i});if(s.status!==200){let e=`Error uploading camera image: ${s.status} - ${s.statusText}`;throw m().addAlert(e),Error(e)}return`webcam/${n} [temp]`},e[Nn].then(e=>{t=e,r.value||(r.value=t.videoWidth||640,i.value=t.videoHeight||480),s.disabled=!1,s.label=w(`g.capture`)})}})}));await t((async()=>{me(),Rt(),zt(),Bt(),Vt(),Ht(),qt(),rn(),Xt(),an(),on(),sn(),pn(),mn(),vn(),yn(),bn(),xn(),Cn(),Tn(),En(),kn(),An(),jn(),Mn(),Pn(),en(),a(),ge&&(await s(()=>import(`./cloudRemoteConfig-DjeQS72v.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27]),import.meta.url),await s(()=>import(`./cloudBadges-CDe4CnGP.js`),__vite__mapDeps([28,4,3,1,2,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26]),import.meta.url),await s(()=>import(`./cloudSessionCookie-DHmD9o2l.js`),__vite__mapDeps([29,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26]),import.meta.url),window.__CONFIG__?.subscription_required&&await s(()=>import(`./cloudSubscription-pq2NQAVm.js`),__vite__mapDeps([30,4,3,1,2,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26]),import.meta.url)),await s(()=>import(`./cloudFeedbackTopbarButton-CXYTaYnw.js`),__vite__mapDeps([31,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,32]),import.meta.url),ge||await s(()=>import(`./nightlyBadges-tOJJ2jwF.js`),__vite__mapDeps([33,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26]),import.meta.url)}))();
//# sourceMappingURL=core-DIi5do3u.js.map