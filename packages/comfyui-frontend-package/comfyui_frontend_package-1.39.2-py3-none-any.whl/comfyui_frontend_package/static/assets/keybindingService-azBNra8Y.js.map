{"version":3,"file":"keybindingService-azBNra8Y.js","names":[],"sources":["../../src/constants/coreKeybindings.ts","../../src/services/keybindingService.ts"],"sourcesContent":["import type { Keybinding } from '@/schemas/keyBindingSchema'\n\nexport const CORE_KEYBINDINGS: Keybinding[] = [\n  {\n    combo: {\n      ctrl: true,\n      key: 'Enter'\n    },\n    commandId: 'Comfy.QueuePrompt'\n  },\n  {\n    combo: {\n      ctrl: true,\n      shift: true,\n      key: 'Enter'\n    },\n    commandId: 'Comfy.QueuePromptFront'\n  },\n  {\n    combo: {\n      ctrl: true,\n      alt: true,\n      key: 'Enter'\n    },\n    commandId: 'Comfy.Interrupt'\n  },\n  {\n    combo: {\n      key: 'r'\n    },\n    commandId: 'Comfy.RefreshNodeDefinitions'\n  },\n  {\n    combo: {\n      key: 'w'\n    },\n    commandId: 'Workspace.ToggleSidebarTab.workflows'\n  },\n  {\n    combo: {\n      key: 'n'\n    },\n    commandId: 'Workspace.ToggleSidebarTab.node-library'\n  },\n  {\n    combo: {\n      key: 'm'\n    },\n    commandId: 'Workspace.ToggleSidebarTab.model-library'\n  },\n  {\n    combo: {\n      key: 's',\n      ctrl: true\n    },\n    commandId: 'Comfy.SaveWorkflow'\n  },\n  {\n    combo: {\n      key: 'o',\n      ctrl: true\n    },\n    commandId: 'Comfy.OpenWorkflow'\n  },\n  {\n    combo: {\n      key: 'g',\n      ctrl: true\n    },\n    commandId: 'Comfy.Graph.GroupSelectedNodes'\n  },\n  {\n    combo: {\n      key: ',',\n      ctrl: true\n    },\n    commandId: 'Comfy.ShowSettingsDialog'\n  },\n  // For '=' both holding shift and not holding shift\n  {\n    combo: {\n      key: '=',\n      alt: true\n    },\n    commandId: 'Comfy.Canvas.ZoomIn',\n    targetElementId: 'graph-canvas'\n  },\n  {\n    combo: {\n      key: '+',\n      alt: true,\n      shift: true\n    },\n    commandId: 'Comfy.Canvas.ZoomIn',\n    targetElementId: 'graph-canvas'\n  },\n  // For number pad '+'\n  {\n    combo: {\n      key: '+',\n      alt: true\n    },\n    commandId: 'Comfy.Canvas.ZoomIn',\n    targetElementId: 'graph-canvas'\n  },\n  {\n    combo: {\n      key: '-',\n      alt: true\n    },\n    commandId: 'Comfy.Canvas.ZoomOut',\n    targetElementId: 'graph-canvas'\n  },\n  {\n    combo: {\n      key: '.'\n    },\n    commandId: 'Comfy.Canvas.FitView',\n    targetElementId: 'graph-canvas-container'\n  },\n  {\n    combo: {\n      key: 'p'\n    },\n    commandId: 'Comfy.Canvas.ToggleSelected.Pin',\n    targetElementId: 'graph-canvas-container'\n  },\n  {\n    combo: {\n      key: 'c',\n      alt: true\n    },\n    commandId: 'Comfy.Canvas.ToggleSelectedNodes.Collapse',\n    targetElementId: 'graph-canvas-container'\n  },\n  {\n    combo: {\n      key: 'b',\n      ctrl: true\n    },\n    commandId: 'Comfy.Canvas.ToggleSelectedNodes.Bypass',\n    targetElementId: 'graph-canvas-container'\n  },\n  {\n    combo: {\n      key: 'm',\n      ctrl: true\n    },\n    commandId: 'Comfy.Canvas.ToggleSelectedNodes.Mute',\n    targetElementId: 'graph-canvas-container'\n  },\n  {\n    combo: {\n      key: '`',\n      ctrl: true\n    },\n    commandId: 'Workspace.ToggleBottomPanelTab.logs-terminal'\n  },\n  {\n    combo: {\n      key: 'e',\n      ctrl: true,\n      shift: true\n    },\n    commandId: 'Comfy.Graph.ConvertToSubgraph'\n  },\n  {\n    combo: {\n      key: 'm',\n      alt: true\n    },\n    commandId: 'Comfy.Canvas.ToggleMinimap'\n  },\n  {\n    combo: {\n      ctrl: true,\n      shift: true,\n      key: 'k'\n    },\n    commandId: 'Workspace.ToggleBottomPanel.Shortcuts'\n  },\n  {\n    combo: {\n      key: 'v'\n    },\n    commandId: 'Comfy.Canvas.Unlock'\n  },\n  {\n    combo: {\n      key: 'h'\n    },\n    commandId: 'Comfy.Canvas.Lock'\n  },\n  {\n    combo: {\n      key: 'Escape'\n    },\n    commandId: 'Comfy.Graph.ExitSubgraph'\n  }\n]\n","import { CORE_KEYBINDINGS } from '@/constants/coreKeybindings'\nimport { useSettingStore } from '@/platform/settings/settingStore'\nimport { app } from '@/scripts/app'\nimport { useCommandStore } from '@/stores/commandStore'\nimport { useDialogStore } from '@/stores/dialogStore'\nimport {\n  KeyComboImpl,\n  KeybindingImpl,\n  useKeybindingStore\n} from '@/stores/keybindingStore'\n\nexport const useKeybindingService = () => {\n  const keybindingStore = useKeybindingStore()\n  const commandStore = useCommandStore()\n  const settingStore = useSettingStore()\n  const dialogStore = useDialogStore()\n\n  // Helper function to determine if an event should be forwarded to canvas\n  const shouldForwardToCanvas = (event: KeyboardEvent): boolean => {\n    // Don't forward if modifier keys are pressed (except shift)\n    if (event.ctrlKey || event.altKey || event.metaKey) {\n      return false\n    }\n\n    // Keys that LiteGraph handles but aren't in core keybindings\n    const canvasKeys = ['Delete', 'Backspace']\n\n    return canvasKeys.includes(event.key)\n  }\n\n  const keybindHandler = async function (event: KeyboardEvent) {\n    const keyCombo = KeyComboImpl.fromEvent(event)\n    if (keyCombo.isModifier) {\n      return\n    }\n\n    // Ignore reserved or non-modifier keybindings if typing in input fields\n    const target = event.composedPath()[0] as HTMLElement\n    if (\n      keyCombo.isReservedByTextInput &&\n      (target.tagName === 'TEXTAREA' ||\n        target.tagName === 'INPUT' ||\n        target.contentEditable === 'true' ||\n        (target.tagName === 'SPAN' &&\n          target.classList.contains('property_value')))\n    ) {\n      return\n    }\n\n    const keybinding = keybindingStore.getKeybinding(keyCombo)\n    if (keybinding && keybinding.targetElementId !== 'graph-canvas') {\n      // Special handling for Escape key - let dialogs handle it first\n      if (\n        event.key === 'Escape' &&\n        !event.ctrlKey &&\n        !event.altKey &&\n        !event.metaKey\n      ) {\n        // If dialogs are open, don't execute the keybinding - let the dialog handle it\n        if (dialogStore.dialogStack.length > 0) {\n          return\n        }\n      }\n\n      // Prevent default browser behavior first, then execute the command\n      event.preventDefault()\n      const runCommandIds = new Set([\n        'Comfy.QueuePrompt',\n        'Comfy.QueuePromptFront',\n        'Comfy.QueueSelectedOutputNodes'\n      ])\n      if (runCommandIds.has(keybinding.commandId)) {\n        await commandStore.execute(keybinding.commandId, {\n          metadata: {\n            trigger_source: 'keybinding'\n          }\n        })\n      } else {\n        await commandStore.execute(keybinding.commandId)\n      }\n      return\n    }\n\n    // Forward unhandled canvas-targeted events to LiteGraph\n    if (!keybinding && shouldForwardToCanvas(event)) {\n      const canvas = app.canvas\n      if (\n        canvas &&\n        canvas.processKey &&\n        typeof canvas.processKey === 'function'\n      ) {\n        // Let LiteGraph handle the event\n        canvas.processKey(event)\n        return\n      }\n    }\n\n    // Only clear dialogs if not using modifiers\n    if (event.ctrlKey || event.altKey || event.metaKey) {\n      return\n    }\n\n    // Escape key: close the first open modal found, and all dialogs\n    if (event.key === 'Escape') {\n      const modals = document.querySelectorAll<HTMLElement>('.comfy-modal')\n      for (const modal of modals) {\n        const modalDisplay = window\n          .getComputedStyle(modal)\n          .getPropertyValue('display')\n\n        if (modalDisplay !== 'none') {\n          modal.style.display = 'none'\n          break\n        }\n      }\n\n      for (const d of document.querySelectorAll('dialog')) d.close()\n    }\n  }\n\n  const registerCoreKeybindings = () => {\n    for (const keybinding of CORE_KEYBINDINGS) {\n      keybindingStore.addDefaultKeybinding(new KeybindingImpl(keybinding))\n    }\n  }\n\n  function registerUserKeybindings() {\n    // Unset bindings first as new bindings might conflict with default bindings.\n    const unsetBindings = settingStore.get('Comfy.Keybinding.UnsetBindings')\n    for (const keybinding of unsetBindings) {\n      keybindingStore.unsetKeybinding(new KeybindingImpl(keybinding))\n    }\n    const newBindings = settingStore.get('Comfy.Keybinding.NewBindings')\n    for (const keybinding of newBindings) {\n      keybindingStore.addUserKeybinding(new KeybindingImpl(keybinding))\n    }\n  }\n\n  async function persistUserKeybindings() {\n    // TODO(https://github.com/Comfy-Org/ComfyUI_frontend/issues/1079):\n    // Allow setting multiple values at once in settingStore\n    await settingStore.set(\n      'Comfy.Keybinding.NewBindings',\n      Object.values(keybindingStore.getUserKeybindings())\n    )\n    await settingStore.set(\n      'Comfy.Keybinding.UnsetBindings',\n      Object.values(keybindingStore.getUserUnsetKeybindings())\n    )\n  }\n\n  return {\n    keybindHandler,\n    registerCoreKeybindings,\n    registerUserKeybindings,\n    persistUserKeybindings\n  }\n}\n"],"mappings":"mNAEa,EAAiC,CAC5C,CACE,MAAO,CACL,KAAM,GACN,IAAK,QACN,CACD,UAAW,oBACZ,CACD,CACE,MAAO,CACL,KAAM,GACN,MAAO,GACP,IAAK,QACN,CACD,UAAW,yBACZ,CACD,CACE,MAAO,CACL,KAAM,GACN,IAAK,GACL,IAAK,QACN,CACD,UAAW,kBACZ,CACD,CACE,MAAO,CACL,IAAK,IACN,CACD,UAAW,+BACZ,CACD,CACE,MAAO,CACL,IAAK,IACN,CACD,UAAW,uCACZ,CACD,CACE,MAAO,CACL,IAAK,IACN,CACD,UAAW,0CACZ,CACD,CACE,MAAO,CACL,IAAK,IACN,CACD,UAAW,2CACZ,CACD,CACE,MAAO,CACL,IAAK,IACL,KAAM,GACP,CACD,UAAW,qBACZ,CACD,CACE,MAAO,CACL,IAAK,IACL,KAAM,GACP,CACD,UAAW,qBACZ,CACD,CACE,MAAO,CACL,IAAK,IACL,KAAM,GACP,CACD,UAAW,iCACZ,CACD,CACE,MAAO,CACL,IAAK,IACL,KAAM,GACP,CACD,UAAW,2BACZ,CAED,CACE,MAAO,CACL,IAAK,IACL,IAAK,GACN,CACD,UAAW,sBACX,gBAAiB,eAClB,CACD,CACE,MAAO,CACL,IAAK,IACL,IAAK,GACL,MAAO,GACR,CACD,UAAW,sBACX,gBAAiB,eAClB,CAED,CACE,MAAO,CACL,IAAK,IACL,IAAK,GACN,CACD,UAAW,sBACX,gBAAiB,eAClB,CACD,CACE,MAAO,CACL,IAAK,IACL,IAAK,GACN,CACD,UAAW,uBACX,gBAAiB,eAClB,CACD,CACE,MAAO,CACL,IAAK,IACN,CACD,UAAW,uBACX,gBAAiB,yBAClB,CACD,CACE,MAAO,CACL,IAAK,IACN,CACD,UAAW,kCACX,gBAAiB,yBAClB,CACD,CACE,MAAO,CACL,IAAK,IACL,IAAK,GACN,CACD,UAAW,4CACX,gBAAiB,yBAClB,CACD,CACE,MAAO,CACL,IAAK,IACL,KAAM,GACP,CACD,UAAW,0CACX,gBAAiB,yBAClB,CACD,CACE,MAAO,CACL,IAAK,IACL,KAAM,GACP,CACD,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"}