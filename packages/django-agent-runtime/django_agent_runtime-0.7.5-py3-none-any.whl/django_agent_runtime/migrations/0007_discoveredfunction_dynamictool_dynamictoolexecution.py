# Generated by Django 5.2.10 on 2026-01-23 14:15

import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('django_agent_runtime', '0006_step_execution_models'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='DiscoveredFunction',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(help_text='Function name', max_length=100)),
                ('module_path', models.CharField(help_text="Full module path (e.g., 'myapp.utils')", max_length=500)),
                ('function_path', models.CharField(help_text="Full function path (e.g., 'myapp.utils.calculate_tax')", max_length=600)),
                ('function_type', models.CharField(choices=[('function', 'Standalone Function'), ('method', 'Class Method'), ('view', 'Django View'), ('model_method', 'Model Method'), ('manager_method', 'Manager Method'), ('utility', 'Utility Function')], default='function', max_length=20)),
                ('class_name', models.CharField(blank=True, help_text='Class name if this is a method', max_length=100)),
                ('file_path', models.CharField(help_text='Relative file path from project root', max_length=500)),
                ('line_number', models.PositiveIntegerField(help_text='Line number where function is defined')),
                ('signature', models.TextField(help_text='Function signature string')),
                ('docstring', models.TextField(blank=True, help_text='Function docstring')),
                ('parameters', models.JSONField(default=list, help_text='List of parameter info dicts')),
                ('return_type', models.CharField(blank=True, help_text='Return type annotation if available', max_length=200)),
                ('is_async', models.BooleanField(default=False, help_text='Whether function is async')),
                ('has_side_effects', models.BooleanField(default=False, help_text='Whether function likely has side effects (writes to DB, etc.)')),
                ('is_private', models.BooleanField(default=False, help_text='Whether function name starts with underscore')),
                ('is_selected', models.BooleanField(default=False, help_text='Whether this function has been selected to become a tool')),
                ('scan_session', models.CharField(help_text='Identifier for the scan session that discovered this', max_length=100)),
                ('discovered_at', models.DateTimeField(auto_now_add=True)),
            ],
            options={
                'verbose_name': 'Discovered Function',
                'verbose_name_plural': 'Discovered Functions',
                'ordering': ['module_path', 'name'],
                'unique_together': {('function_path', 'scan_session')},
            },
        ),
        migrations.CreateModel(
            name='DynamicTool',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(help_text='Tool name (must be unique within agent)', max_length=100)),
                ('description', models.TextField(help_text='Description of what the tool does (shown to LLM)')),
                ('function_path', models.CharField(help_text="Full import path to the function (e.g., 'myapp.utils.calculate_tax')", max_length=600)),
                ('source_file', models.CharField(blank=True, help_text='Source file path', max_length=500)),
                ('source_line', models.PositiveIntegerField(blank=True, help_text='Source line number', null=True)),
                ('parameters_schema', models.JSONField(default=dict, help_text='JSON Schema for tool parameters')),
                ('execution_mode', models.CharField(choices=[('direct', 'Direct Import & Call'), ('sandboxed', 'Sandboxed Execution'), ('subprocess', 'Subprocess Isolation')], default='direct', max_length=20)),
                ('timeout_seconds', models.PositiveIntegerField(default=30, help_text='Maximum execution time in seconds')),
                ('is_safe', models.BooleanField(default=False, help_text='Whether this tool is considered safe (no side effects)')),
                ('requires_confirmation', models.BooleanField(default=True, help_text='Whether to ask user before executing')),
                ('allowed_for_auto_execution', models.BooleanField(default=False, help_text='Whether agent can execute without human approval')),
                ('allowed_imports', models.JSONField(blank=True, default=list, help_text='List of allowed import patterns for sandboxed execution')),
                ('blocked_imports', models.JSONField(blank=True, default=list, help_text='List of blocked import patterns')),
                ('is_active', models.BooleanField(default=True)),
                ('is_verified', models.BooleanField(default=False, help_text='Whether this tool has been manually verified')),
                ('version', models.PositiveIntegerField(default=1)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('agent', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='dynamic_tools', to='django_agent_runtime.agentdefinition')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_dynamic_tools', to=settings.AUTH_USER_MODEL)),
                ('discovered_function', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='tools', to='django_agent_runtime.discoveredfunction')),
            ],
            options={
                'verbose_name': 'Dynamic Tool',
                'verbose_name_plural': 'Dynamic Tools',
                'ordering': ['name'],
                'unique_together': {('agent', 'name')},
            },
        ),
        migrations.CreateModel(
            name='DynamicToolExecution',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('agent_run_id', models.UUIDField(blank=True, help_text='ID of the agent run that triggered this execution', null=True)),
                ('input_arguments', models.JSONField(default=dict, help_text='Arguments passed to the tool')),
                ('output_result', models.JSONField(blank=True, help_text='Result returned by the tool', null=True)),
                ('error_message', models.TextField(blank=True, help_text='Error message if execution failed')),
                ('error_traceback', models.TextField(blank=True, help_text='Full traceback if execution failed')),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('running', 'Running'), ('success', 'Success'), ('failed', 'Failed'), ('timeout', 'Timeout'), ('blocked', 'Blocked (Security)')], default='pending', max_length=20)),
                ('started_at', models.DateTimeField(auto_now_add=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('duration_ms', models.PositiveIntegerField(blank=True, help_text='Execution duration in milliseconds', null=True)),
                ('was_sandboxed', models.BooleanField(default=False)),
                ('user_confirmed', models.BooleanField(default=False, help_text='Whether user confirmed execution')),
                ('executed_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('tool', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='executions', to='django_agent_runtime.dynamictool')),
            ],
            options={
                'verbose_name': 'Dynamic Tool Execution',
                'verbose_name_plural': 'Dynamic Tool Executions',
                'ordering': ['-started_at'],
            },
        ),
    ]
