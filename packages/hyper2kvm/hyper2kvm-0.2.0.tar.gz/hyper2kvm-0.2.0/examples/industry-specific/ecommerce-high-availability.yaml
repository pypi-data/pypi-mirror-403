# E-Commerce High-Availability Migration
#
# Scenario: Migrating e-commerce platform from VMware to KVM with zero downtime
# Industry: E-Commerce / Retail
# Scale: 10,000 orders/day, Black Friday peak: 100,000 orders/day
#
# Requirements:
# - Zero downtime migration (live migration preferred)
# - Load balancer integration (HAProxy/NGINX)
# - Database replication (MySQL primary-replica)
# - Redis cluster for sessions
# - CDN integration (Cloudflare/Fastly)
# - Performance monitoring (Prometheus/Grafana)
#
# VM Profile:
# - OS: Ubuntu 22.04 LTS
# - Application: Magento 2.4 / WooCommerce / Shopify Plus
# - Web Server: NGINX 1.24
# - PHP-FPM 8.2
# - Database: MySQL 8.0 (separate VM)
#

# Migration strategy: Blue-Green deployment
# 1. Migrate to KVM (green environment)
# 2. Sync data incrementally
# 3. Run parallel for 24 hours
# 4. Switch DNS/load balancer
# 5. Monitor for 7 days
# 6. Decommission VMware (blue)

cmd: vsphere

# vCenter connection
vcenter: vcenter.ecommerce.cloud
username: ${VCENTER_MIGRATION_USER}
password_file: ${HOME}/.vcenter-pass
datacenter: US-East-1
cluster: WebServers-Prod

# Source VM (web server node 1 of 4)
vs_vm_name: webshop-web-01
vs_action: export-vm

# Output configuration
output_dir: /data/kvm/webshop
out_format: qcow2
compress: true

# Logging for performance analysis
verbose: 2
log_file: /var/log/migrations/webshop-web-01.log
report: /data/kvm/webshop/migration-report.md

# Guest OS fixes (Ubuntu 22.04)
regen_initramfs: true
fstab_mode: stabilize-all
fix_grub: true

# Network configuration
# Keep existing network config during migration
network_mode: preserve

# Libvirt domain configuration
domain_name: webshop-web-01-kvm
domain_memory: 8192  # 8GB (web server)
domain_vcpus: 4
domain_cpu_mode: host-passthrough

# Storage (performance-optimized)
disk_bus: virtio
disk_cache: writeback  # High performance for web content
disk_io: threads
disk_discard: unmap  # Thin provisioning

# Network (high-performance)
nic_model: virtio
network_bridge: br-public  # Public-facing network
# Secondary NIC for backend (database, cache)
# network_bridge_2: br-backend

# Performance tuning
# NUMA pinning for high performance:
# virsh numatune webshop-web-01-kvm --mode strict --nodeset 0
#
# CPU pinning to avoid context switches:
# virsh vcpupin webshop-web-01-kvm 0 0
# virsh vcpupin webshop-web-01-kvm 1 1
# virsh vcpupin webshop-web-01-kvm 2 2
# virsh vcpupin webshop-web-01-kvm 3 3

# Validation tests
test_boot: true
test_timeout: 300

# Migration execution plan
#
# Phase 1: Preparation (Week 1)
# - Migrate webshop-web-01 (this config)
# - Run in parallel with production
# - Sync shared storage (NFS/GlusterFS)
# - Configure rsync for media files
#
# Phase 2: Data Synchronization (Week 2)
# - MySQL replication: VMware (primary) â†’ KVM (replica)
# - Redis cluster: Add KVM nodes
# - Elasticsearch: Add KVM nodes to cluster
# - File sync: rsync every 5 minutes
#
# Phase 3: Testing (Week 2-3)
# - Load testing: JMeter (1000 concurrent users)
# - Smoke tests: Selenium suite
# - Payment gateway integration test
# - Shipping API integration test
# - Email service (SendGrid/Mailgun) test
# - Performance baseline:
#   * Homepage: < 500ms TTFB
#   * Product page: < 800ms
#   * Checkout: < 1.2s
#   * API calls: < 200ms
#
# Phase 4: Gradual Traffic Shift (Week 3)
# - HAProxy/NGINX load balancer adjustment
# - Day 1: 10% traffic to KVM
# - Day 2: 25% traffic to KVM
# - Day 3: 50% traffic to KVM
# - Day 4: 75% traffic to KVM
# - Day 5: 100% traffic to KVM
#
# Monitoring during cutover:
# - Error rate: < 0.1%
# - Response time: within 10% of baseline
# - CPU usage: < 70%
# - Memory usage: < 80%
# - Disk I/O: monitor wait time
#
# Phase 5: Validation (Week 4)
# - 7-day monitoring period
# - Black Friday load test (100k orders/day simulation)
# - Verify CDN cache hit ratio (> 90%)
# - Check database replication lag (< 1 second)
# - Validate payment processing (100% success rate)
# - Customer session persistence (Redis)
#
# Rollback procedure:
# 1. Load balancer: Switch all traffic to VMware
# 2. DNS TTL: 60 seconds (pre-configured)
# 3. Database: Promote VMware to primary
# 4. Total rollback time: < 5 minutes

# Post-migration optimizations
#
# 1. Enable huge pages for performance
#    echo "vm.nr_hugepages = 1024" >> /etc/sysctl.conf
#    sysctl -p
#
# 2. Tune NGINX worker processes
#    worker_processes auto;
#    worker_rlimit_nofile 65535;
#
# 3. PHP-FPM optimization
#    pm = dynamic
#    pm.max_children = 50
#    pm.start_servers = 10
#    pm.min_spare_servers = 5
#    pm.max_spare_servers = 20
#
# 4. MySQL tuning (on database VM)
#    innodb_buffer_pool_size = 6G
#    innodb_log_file_size = 512M
#    max_connections = 500
#
# 5. Redis tuning
#    maxmemory 2gb
#    maxmemory-policy allkeys-lru
#
# 6. Enable HTTP/2 and TLS 1.3
#    ssl_protocols TLSv1.3;
#    http2 on;

# Monitoring and alerting
#
# Prometheus exporters to install:
# - node_exporter (system metrics)
# - nginx_exporter (web server metrics)
# - php-fpm_exporter (PHP metrics)
# - mysqld_exporter (database metrics - separate VM)
#
# Grafana dashboards:
# - Web server performance
# - Application response times
# - Database query performance
# - Redis cache hit ratio
# - Business metrics (orders, revenue, cart abandonment)
#
# Alerting rules:
# - Response time > 2s (warning)
# - Error rate > 1% (critical)
# - CPU > 80% (warning)
# - Memory > 90% (critical)
# - Disk usage > 85% (warning)
# - Failed payments > 5/hour (critical)

# Disaster recovery
#
# RPO (Recovery Point Objective): 5 minutes
# RTO (Recovery Time Objective): 15 minutes
#
# Backup strategy:
# - Database: Streaming replication + hourly snapshots
# - Files: Rsync to DR site every 5 minutes
# - VM snapshots: Daily (kept for 7 days)
# - Off-site backups: Daily to S3/GCS
#
# DR testing: Quarterly failover drill
