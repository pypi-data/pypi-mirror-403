name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      full_suite:
        description: "Run slow/perf/stress tests too"
        required: false
        default: "false"
  schedule:
    # Nightly full-suite run (slow/perf/stress)
    - cron: "0 6 * * *"

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12', '3.13', '3.14']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install maturin
      run: python -m pip install maturin

    - name: Verify Python version
      run: |
        python --version
        which python
        python -c "import sys; print(f'Python executable: {sys.executable}')"

    - name: Build package (Linux)
      if: runner.os == 'Linux'
      run: python -m maturin build --release --skip-auditwheel

    - name: Build package (macOS/Windows)
      if: runner.os != 'Linux'
      run: python -m maturin build --release

    - name: Install package
      shell: bash
      run: |
        # Windows: Use D: drive for temporary files (30%+ faster I/O than C: drive)
        if [ "${{ runner.os }}" == "Windows" ]; then
          export TEMP="D:/a/_temp"
          export TMP="D:/a/_temp"
          mkdir -p "$TEMP" || true
        fi
        python --version
        python -m pip install target/wheels/rapsqlite-*.whl --force-reinstall || echo "Wheel installation failed or no wheels found"
        if [ "${{ runner.os }}" == "Windows" ]; then
          cd "$TEMP" || cd "$TMP"
          python -c "import rapsqlite; print(f'Successfully imported rapsqlite version {rapsqlite.__version__}')" || (echo "Import failed, checking installed packages:" && python -m pip list | grep rapsqlite && exit 1)
        else
          cd /tmp && python -c "import rapsqlite; print(f'Successfully imported rapsqlite version {rapsqlite.__version__}')" || (echo "Import failed, checking installed packages:" && python -m pip list | grep rapsqlite && exit 1)
        fi

    - name: Install test dependencies
      shell: bash
      run: pip install pytest pytest-asyncio pytest-cov pytest-xdist hypothesis

    - name: Test package import
      shell: bash
      run: |
        # Windows: Use D: drive for temporary files (faster I/O)
        if [ "${{ runner.os }}" == "Windows" ]; then
          export TEMP="D:/a/_temp"
          export TMP="D:/a/_temp"
          mkdir -p "$TEMP" || true
          cd "$TEMP" || cd "$TMP"
          python -c "import rapsqlite; print('Version:', rapsqlite.__version__)"
        else
          cd /tmp && python -c "import rapsqlite; print('Version:', rapsqlite.__version__)"
        fi

    - name: Run tests
      shell: bash
      timeout-minutes: 25
      run: |
        # Default (PR/push): skip slow/stress/full perf, but run perf_smoke for quick validation.
        # Full suite runs on schedule or when manually requested via workflow_dispatch input.
        PYTEST_MARKERS='not slow and not stress and (not performance or perf_smoke)'
        if [ "${{ github.event_name }}" == "schedule" ]; then
          PYTEST_MARKERS="true"
        fi
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.full_suite }}" == "true" ]; then
          PYTEST_MARKERS="true"
        fi
        # When full suite, omit -m entirely. Passing -m "true" is a marker expression that selects
        # no tests (no test has marker "true"), causing "500 deselected" and exit code 5.
        if [ "$PYTEST_MARKERS" == "true" ]; then
          M_OPT=()
        else
          M_OPT=(-m "$PYTEST_MARKERS")
        fi

        # Windows: Use D: drive for temporary files (30%+ faster I/O than C: drive)
        # The D: drive has significantly better I/O performance on GitHub Actions Windows runners
        # This addresses the primary cause of Windows CI slowness
        if [ "${{ runner.os }}" == "Windows" ]; then
          export TEMP="D:/a/_temp"
          export TMP="D:/a/_temp"
          mkdir -p "$TEMP" || true
        fi
        # Change to a temp directory to avoid importing from source
        # On Windows, use temp directory and absolute paths to avoid source import issues
        if [ "${{ runner.os }}" == "Windows" ]; then
          WORKSPACE=$(echo "${{ github.workspace }}" | sed 's|\\|/|g')
          cd "$TEMP" || cd "$TMP"
          # Ensure coverage XML directory exists
          mkdir -p "$WORKSPACE"
          # Windows: Try limited parallelization (2 workers) with fallback to sequential
          # With WindowsSelectorEventLoopPolicy set in conftest.py, each spawned worker
          # process will have the correct event loop policy. Windows uses spawn (not fork)
          # which is better for asyncio. If parallel execution fails, fallback to sequential.
          # Using limited workers (2) instead of auto to reduce risk of event loop conflicts
          python -m pytest "$WORKSPACE/tests/" -v "${M_OPT[@]}" --cov=rapsqlite --cov-report=term-missing --cov-report=xml:"$WORKSPACE/coverage.xml" -n 2 || python -m pytest "$WORKSPACE/tests/" -v "${M_OPT[@]}" --cov=rapsqlite --cov-report=term-missing --cov-report=xml:"$WORKSPACE/coverage.xml"
        else
          cd /tmp
          # Ensure coverage XML directory exists and is writable
          mkdir -p "${{ github.workspace }}"
          COV_XML="${{ github.workspace }}/coverage.xml"
          # Run tests with parallel execution
          # If pytest-xdist fails (e.g., on macOS Python 3.10), fallback to sequential execution
          python -m pytest ${{ github.workspace }}/tests/ -v "${M_OPT[@]}" --cov=rapsqlite --cov-report=term-missing --cov-report=xml:"$COV_XML" -n auto || python -m pytest ${{ github.workspace }}/tests/ -v "${M_OPT[@]}" --cov=rapsqlite --cov-report=term-missing --cov-report=xml:"$COV_XML"
        fi

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
      uses: codecov/codecov-action@v3
      with:
        file: ${{ github.workspace }}/coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  rust-tests:
    name: Rust unit tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python (for pyo3 build config)
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Run cargo test
      shell: bash
      run: |
        set -e
        # Run tests without extension-module so the test binary links against libpython.
        # Use --lib to skip doc tests (they contain Python examples, not Rust code).
        export PYO3_PYTHON="$(python -c 'import sys; print(sys.executable)')"
        cargo test --no-default-features --lib

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install Rust components
      run: rustup component add clippy rustfmt

    - name: Run clippy
      run: cargo clippy --lib -- -D clippy::all -A deprecated

    - name: Check formatting
      run: cargo fmt -- --check

  build-wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install maturin
      run: pip install maturin

    - name: Build wheels (Linux with manylinux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        docker run --rm -v "${{ github.workspace }}":/io -w /io ghcr.io/pyo3/maturin:main build --release --out dist --manylinux manylinux_2_24

    - name: Build wheels (macOS/Windows)
      if: matrix.os != 'ubuntu-latest'
      run: maturin build --release --out dist

    - name: Upload wheels
      uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.os }}
        path: dist

