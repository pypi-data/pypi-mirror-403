#!/usr/bin/env bash

# Half-ORM pre-commit hook
# 1. Checks if current ho-* branch exists on remote origin
# 2. Protects ho-prod branch from direct commits
# 3. Optionally calls pre-commit-custom if it exists
# Generated by half_orm_dev

# Get current branch
CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)

# =============================================================================
# CUSTOM PRE-COMMIT HOOK SUPPORT
# =============================================================================
# If a pre-commit-custom script exists in .git/hooks/, execute it first.
# This allows users to add their own custom checks (linting, formatting, etc.)
#
# ⚠️  WARNING: pre-commit-custom is NOT tracked by Git and NOT cloned.
# It must be added manually to each local repository clone.
#
# To create a custom hook:
#   1. Create .git/hooks/pre-commit-custom (executable)
#   2. Add your custom checks
#   3. Exit with 0 (success) or non-zero (failure) to block the commit
#
# Example .git/hooks/pre-commit-custom:
#   #!/usr/bin/env bash
#   # Run Python linter
#   python -m pylint $(git diff --cached --name-only --diff-filter=ACM | grep '\.py$')
#   exit $?
# =============================================================================

CUSTOM_HOOK=".git/hooks/pre-commit-custom"
if [ -x "$CUSTOM_HOOK" ]; then
    "$CUSTOM_HOOK"
    CUSTOM_EXIT_CODE=$?
    if [ $CUSTOM_EXIT_CODE -ne 0 ]; then
        echo ""
        echo "❌ Custom pre-commit hook failed (exit code: $CUSTOM_EXIT_CODE)"
        exit $CUSTOM_EXIT_CODE
    fi
fi

# =============================================================================
# HALF-ORM STANDARD CHECKS
# =============================================================================

# Check if current ho-* branch (except ho-prod) still exists on remote origin
# This prevents committing to ho-* branches that were deleted remotely
if [[ "$CURRENT_BRANCH" == ho-* ]] && [ "$CURRENT_BRANCH" != "ho-prod" ]; then
    # Fetch remote refs quietly (only updates remote tracking, doesn't modify local branches)
    git fetch origin --prune --quiet 2>/dev/null || true

    # Check if branch exists on remote
    if ! git show-ref --verify --quiet "refs/remotes/origin/$CURRENT_BRANCH"; then
        cat << EOF
❌ Branch '$CURRENT_BRANCH' no longer exists on remote origin

This Half-ORM branch was deleted on the remote repository (likely cleaned up
after a release promotion). You cannot commit to a branch that doesn't exist
remotely.

Common causes:
  • ho-release/<version>/<patch_id> branches are deleted after promotion to prod
  • ho-patch/<patch_id> branches are renamed to ho-release/<version>/<patch_id> after integration
  • Branch was manually deleted by another team member

What to do:
  1. Save your changes if needed:
     $ git stash

  2. Switch to ho-prod:
     $ git checkout ho-prod

  3. Delete this stale local branch:
     $ git branch -D $CURRENT_BRANCH

  4. Create a new patch and restore your changes if you stashed them:
     $ git stash pop

For more information about branch lifecycle, see Half-ORM documentation.

EOF
        exit 1
    fi
fi

# Check if we're on ho-prod branch
if [ "$CURRENT_BRANCH" != "ho-prod" ]; then
    # Not on ho-prod, allow commit
    exit 0
fi

# Check if this is a temporary validation tag commit (allows automated promotion)
CURRENT_TAG=$(git describe --exact-match --tags HEAD 2>/dev/null | grep -E '^temp-valid-')

if [ -n "$CURRENT_TAG" ]; then
    # This is an automated promotion commit with temp tag, allow it
    exit 0
fi

# Check if there's an active lock on ho-prod
# Lock tags follow pattern: lock-ho-prod-{timestamp}
LOCK_TAG=$(git tag -l 'lock-ho-prod-*' 2>/dev/null | head -n 1)

if [ -n "$LOCK_TAG" ]; then
    # Lock is active, allow commit from Half-ORM workflow
    exit 0
fi

# Direct commit on ho-prod is not allowed
cat << 'EOF'
❌ Direct commits on 'ho-prod' are not allowed

The ho-prod branch is a protected production branch. Changes must be
promoted through the official Half-ORM release workflow.

To create a patch:
  $ half_orm dev patch create <patch_id>

To merge a patch into a release:
  $ git checkout ho-patch/<patch_id>
  $ half_orm dev patch merge

To add a patch to a release (on a patch branch):
  $ half_orm dev patch merge

To promote a stage release to rc/production (on a release branch):
  $ half_orm dev release promote <rc|prod>

This workflow ensures:
  • All patches are validated and tested
  • Code is properly merged from patch branches
  • Active patch branches are notified to rebase
  • Production deploys are tracked and auditable

For more information, see the Half-ORM documentation on release management.

EOF

exit 1
