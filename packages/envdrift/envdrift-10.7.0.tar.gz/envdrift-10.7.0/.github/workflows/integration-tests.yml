# Integration Tests CI Workflow
#
# Runs integration tests with Docker service containers
# for LocalStack (AWS) and HashiCorp Vault.
#
# Triggered on:
# - Pull requests to main
# - Pushes to main
# - Manual dispatch

name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  # Common environment for all jobs
  PYTHONUNBUFFERED: "1"
  FORCE_COLOR: "1"

jobs:
  integration-tests:
    name: Integration Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]

    # Service containers for integration tests
    services:
      localstack:
        image: localstack/localstack:4.12
        ports:
          - 4566:4566
        env:
          SERVICES: secretsmanager
          DEBUG: "0"
          EAGER_SERVICE_LOADING: "1"
        options: >-
          --health-cmd="curl -f http://localhost:4566/_localstack/health"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10
          --health-start-period=10s

      vault:
        image: hashicorp/vault:1.21
        ports:
          - 8200:8200
        env:
          VAULT_DEV_ROOT_TOKEN_ID: test-root-token
          VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
          VAULT_ADDR: http://0.0.0.0:8200
        options: >-
          --cap-add=IPC_LOCK
          --health-cmd="vault status || exit 0"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10
          --health-start-period=5s

      lowkey-vault:
        image: nagyesta/lowkey-vault:7.0.9
        ports:
          - 8443:8443
        env:
          LOWKEY_VAULT_NAMES: envdrift-test-vault
        options: >-
          --health-cmd="curl -f -k https://localhost:8443/ping || exit 0"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10
          --health-start-period=5s

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: |
          uv sync --all-extras
          # Install optional integration test dependencies
          uv pip install boto3 hvac

      - name: Install dotenvx
        run: |
          mkdir -p "$HOME/.local/bin"
          curl -sfS "https://dotenvx.sh?directory=$HOME/.local/bin" | sh -s -- --version=1.51.4
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify services are accessible
        run: |
          # Wait for services to fully start after health checks pass
          echo "Waiting for services to be fully ready..."
          sleep 10
          
          echo "Checking LocalStack..."
          LOCALSTACK_READY=false
          for i in {1..30}; do
            if curl -sf http://localhost:4566/_localstack/health > /dev/null 2>&1; then
              echo "LocalStack is ready!"
              LOCALSTACK_READY=true
              break
            fi
            echo "Waiting for LocalStack... ($i/30)"
            sleep 2
          done
          if [ "$LOCALSTACK_READY" != "true" ]; then
            echo "ERROR: LocalStack failed to become ready within timeout"
            exit 1
          fi
          
          echo "Checking Vault..."
          VAULT_READY=false
          for i in {1..30}; do
            if curl -sf http://localhost:8200/v1/sys/health > /dev/null 2>&1; then
              echo "Vault is ready!"
              VAULT_READY=true
              break
            fi
            echo "Waiting for Vault... ($i/30)"
            sleep 2
          done
          if [ "$VAULT_READY" != "true" ]; then
            echo "ERROR: Vault failed to become ready within timeout"
            exit 1
          fi
          
          echo "Checking Lowkey Vault..."
          LOWKEY_VAULT_READY=false
          for i in {1..30}; do
            if curl -sfk https://localhost:8443/ping > /dev/null 2>&1; then
              echo "Lowkey Vault is ready!"
              LOWKEY_VAULT_READY=true
              break
            fi
            echo "Waiting for Lowkey Vault... ($i/30)"
            sleep 2
          done
          if [ "$LOWKEY_VAULT_READY" != "true" ]; then
            echo "ERROR: Lowkey Vault failed to become ready within timeout"
            exit 1
          fi
          
          echo "All services ready!"

      - name: Run integration tests
        env:
          # AWS (LocalStack) configuration
          AWS_ENDPOINT_URL: http://localhost:4566
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
          AWS_MAX_ATTEMPTS: "3"
          # HashiCorp Vault configuration
          VAULT_ADDR: http://localhost:8200
          VAULT_TOKEN: test-root-token
          # Azure (Lowkey Vault) configuration
          AZURE_KEYVAULT_URL: https://localhost:8443
          CURL_CA_BUNDLE: ""
          REQUESTS_CA_BUNDLE: ""
          AZURE_CLI_DISABLE_CONNECTION_VERIFICATION: "1"
        run: |
          uv run pytest tests/integration/ \
            -v \
            --tb=short \
            --timeout=300 \
            -x \
            --cov=src/envdrift \
            --cov-report=xml:coverage-integration.xml \
            --cov-report=term-missing

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-integration-py${{ matrix.python-version }}
          path: coverage-integration.xml
          retention-days: 7

  # Job to collect and report coverage
  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: integration-tests
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download coverage artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: coverage-integration-*
          path: coverage-reports
          merge-multiple: true

      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage-reports/coverage-integration*.xml
          flags: integration
          fail_ci_if_error: false
          verbose: true

  # Optional: Run tests with real cloud credentials (manual trigger only)
  cloud-integration-tests:
    name: Cloud Provider Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    env:
      # Map secrets to env vars at job level for step conditional access
      ENVDRIFT_TEST_GCP: ${{ secrets.ENVDRIFT_TEST_GCP }}
      ENVDRIFT_TEST_AZURE: ${{ secrets.ENVDRIFT_TEST_AZURE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python 3.14
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: |
          uv sync --all-extras
          uv pip install boto3 hvac google-cloud-secret-manager azure-keyvault-secrets azure-identity

      - name: Run GCP tests (if configured)
        if: env.ENVDRIFT_TEST_GCP == '1'
        env:
          GCP_KEY_CONTENT: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "$GCP_KEY_CONTENT" > gcp_key.json
          export GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcp_key.json
          uv run pytest tests/integration/ -v -m gcp --timeout=120
          rm gcp_key.json

      - name: Run Azure tests (if configured)
        if: env.ENVDRIFT_TEST_AZURE == '1'
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_KEYVAULT_URL: ${{ secrets.AZURE_KEYVAULT_URL }}
        run: |
          uv run pytest tests/integration/ -v -m azure --timeout=120
