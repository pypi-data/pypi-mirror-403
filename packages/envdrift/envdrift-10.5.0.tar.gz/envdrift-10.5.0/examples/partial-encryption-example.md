# Example: Partial Encryption Setup

## Quick Start Example

This example shows how to set up partial encryption for a production environment.

### Step 1: Create Configuration

Create `envdrift.toml`:

```toml
[partial_encryption]
enabled = true

[[partial_encryption.environments]]
name = "production"
clear_file = ".env.production.clear"
secret_file = ".env.production.secret"
combined_file = ".env.production"
```

### Step 2: Create Source Files

**`.env.production.clear`** (non-sensitive):

```bash
# Application Settings
DEBUG=false
LOG_LEVEL=info
PORT=8080
APP_NAME=my-awesome-app
ENVIRONMENT=production

# Feature Flags
ENABLE_CACHING=true
ENABLE_ANALYTICS=true
```

**`.env.production.secret`** (sensitive, will be encrypted):

```bash
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/mydb

# Authentication
JWT_SECRET=my-super-secret-jwt-key-change-this
SESSION_SECRET=my-session-secret-key

# External APIs
STRIPE_API_KEY=sk_live_abc123xyz
SENDGRID_API_KEY=SG.abc123xyz
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
```

### Step 3: Initialize

```bash
# Encrypt and combine
envdrift push --env production

# What happens:
# 1. .env.production.secret is encrypted in-place
# 2. .env.production is generated from .clear + encrypted .secret
```

### Step 4: Verify

Check `.env.production` (generated file):

```bash
cat .env.production
```

Output:

```bash
#/---------------------------------------------------/
#/ WARNING: AUTO-GENERATED FILE                      /
#/ DO NOT EDIT THIS FILE DIRECTLY                    /
#/                                                    /
#/ This file is generated by: envdrift push          /
#/                                                    /
#/ To make changes:                                  /
#/   1. Edit: .env.production.clear                  /
#/   2. Edit: .env.production.secret                 /
#/   3. Run:  envdrift pull-partial                  /
#/   4. Run:  envdrift push                          /
#/---------------------------------------------------/

# From .env.production.clear
# Application Settings
DEBUG=false
LOG_LEVEL=info
PORT=8080
APP_NAME=my-awesome-app
ENVIRONMENT=production

# Feature Flags
ENABLE_CACHING=true
ENABLE_ANALYTICS=true

# From .env.production.secret (encrypted)
# Database
DATABASE_URL="encrypted:BDaLMxznvYWcHP..."

# Authentication
JWT_SECRET="encrypted:BD9XKwmZvYWcHP..."
SESSION_SECRET="encrypted:BDcNPxvnvYWcHP..."

# External APIs
STRIPE_API_KEY="encrypted:BDeRQxznvYWcHP..."
SENDGRID_API_KEY="encrypted:BDfSRyznvYWcHP..."
AWS_ACCESS_KEY_ID="encrypted:BDgTSzznvYWcHP..."
AWS_SECRET_ACCESS_KEY="encrypted:BDhUTAznvYWcHP..."
```

### Step 5: Commit

```bash
git add envdrift.toml .env.production.clear .env.production.secret .env.production
git commit -m "feat: Add production environment with partial encryption"
git push
```

## Developer Onboarding

When a new developer clones the repo:

```bash
# Clone repo
git clone <repo>
cd <repo>

# Decrypt secret file for editing
envdrift pull-partial --env production

# Now .env.production.secret is decrypted and can be edited
```

## Making Changes

### Changing a non-sensitive variable

```bash
# Edit clear file
echo "PORT=9000" >> .env.production.clear

# Regenerate combined file
envdrift push --env production

# Commit
git add .env.production.clear .env.production
git commit -m "Change port to 9000"
```

### Changing a sensitive variable

```bash
# Decrypt first (if not already)
envdrift pull-partial --env production

# Edit secret file (now in cleartext locally)
vim .env.production.secret
# Change: STRIPE_API_KEY=sk_live_new_key

# Re-encrypt and regenerate
envdrift push --env production

# Commit
git add .env.production.secret .env.production
git commit -m "Update Stripe API key"
```

## Git Diffs

### Non-sensitive change (readable)

```diff
diff --git a/.env.production.clear b/.env.production.clear
index 1234567..89abcdef 100644
--- a/.env.production.clear
+++ b/.env.production.clear
@@ -1,4 +1,4 @@
 DEBUG=false
 LOG_LEVEL=info
-PORT=8080
+PORT=9000
 APP_NAME=my-awesome-app
```

### Sensitive change (opaque)

```diff
diff --git a/.env.production.secret b/.env.production.secret
index abc1234..def5678 100644
--- a/.env.production.secret
+++ b/.env.production.secret
@@ -1,1 +1,1 @@
-STRIPE_API_KEY="encrypted:BDaLMxznvYWcHP..."
+STRIPE_API_KEY="encrypted:BDnEWKEYznvYWcHP..."
```

## Benefits Demonstrated

1. ✅ **Clear vars visible in git** - Can see PORT change
2. ✅ **Secrets encrypted** - STRIPE_API_KEY is opaque
3. ✅ **Simple workflow** - Edit, push, commit
4. ✅ **One file for app** - Use `.env.production`
