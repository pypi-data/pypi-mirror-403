name: EnvDrift Agent CI

on:
  push:
    branches: [main]
    paths:
      - 'envdrift-agent/**'
      - '.github/workflows/agent-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'envdrift-agent/**'
      - '.github/workflows/agent-ci.yml'

permissions:
  contents: read

defaults:
  run:
    working-directory: envdrift-agent

jobs:
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go: ['1.22']

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go }}
          cache-dependency-path: envdrift-agent/go.sum

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        shell: bash
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        if: matrix.os == 'ubuntu-latest'
        with:
          files: envdrift-agent/coverage.out
          flags: go-agent
          name: envdrift-agent

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            artifact: envdrift-agent-linux-amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            artifact: envdrift-agent-linux-arm64
          - os: macos-latest
            goos: darwin
            goarch: amd64
            artifact: envdrift-agent-darwin-amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
            artifact: envdrift-agent-darwin-arm64
          - os: windows-latest
            goos: windows
            goarch: amd64
            artifact: envdrift-agent-windows-amd64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache-dependency-path: envdrift-agent/go.sum

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -ldflags "-X github.com/jainal09/envdrift-agent/internal/cmd.Version=${{ github.sha }}" -o dist/${{ matrix.artifact }} ./cmd/envdrift-agent

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact }}
          path: envdrift-agent/dist/${{ matrix.artifact }}

  integration-linux:
    name: Integration Tests (Linux)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download binary
        uses: actions/download-artifact@v7
        with:
          name: envdrift-agent-linux-amd64
          path: ./bin

      - name: Make executable
        run: chmod +x ../bin/envdrift-agent-linux-amd64

      - name: Test version command
        run: ../bin/envdrift-agent-linux-amd64 version

      - name: Test status command
        run: ../bin/envdrift-agent-linux-amd64 status

      - name: Test config command
        run: ../bin/envdrift-agent-linux-amd64 config

      - name: Test help command
        run: ../bin/envdrift-agent-linux-amd64 --help

  integration-macos:
    name: Integration Tests (macOS)
    runs-on: macos-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download binary
        uses: actions/download-artifact@v7
        with:
          name: envdrift-agent-darwin-arm64
          path: ./bin

      - name: Make executable
        run: chmod +x ../bin/envdrift-agent-darwin-arm64

      - name: Test version command
        run: ../bin/envdrift-agent-darwin-arm64 version

      - name: Test status command
        run: ../bin/envdrift-agent-darwin-arm64 status

      - name: Test config command
        run: ../bin/envdrift-agent-darwin-arm64 config

      - name: Test help command
        run: ../bin/envdrift-agent-darwin-arm64 --help

  integration-windows:
    name: Integration Tests (Windows)
    runs-on: windows-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download binary
        uses: actions/download-artifact@v7
        with:
          name: envdrift-agent-windows-amd64.exe
          path: ./bin

      - name: Test version command
        run: ..\bin\envdrift-agent-windows-amd64.exe version

      - name: Test status command
        run: ..\bin\envdrift-agent-windows-amd64.exe status

      - name: Test config command
        run: ..\bin\envdrift-agent-windows-amd64.exe config

      - name: Test help command
        run: ..\bin\envdrift-agent-windows-amd64.exe --help

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache-dependency-path: envdrift-agent/go.sum

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          working-directory: envdrift-agent
