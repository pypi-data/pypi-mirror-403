"""Tests for partial encryption functionality."""

from __future__ import annotations

from pathlib import Path

import pytest

from envdrift.config import PartialEncryptionEnvironmentConfig
from envdrift.core.partial_encryption import (
    combine_files,
    is_file_encrypted,
)


@pytest.fixture
def temp_env_files(tmp_path: Path):
    """Create temporary environment files for testing."""
    clear_file = tmp_path / ".env.test.clear"
    secret_file = tmp_path / ".env.test.secret"
    combined_file = tmp_path / ".env.test"

    # Create clear file
    clear_file.write_text(
        """# Application Settings
DEBUG=false
LOG_LEVEL=info
PORT=8080
"""
    )

    # Create secret file (not encrypted yet)
    secret_file.write_text(
        """# Database
DATABASE_URL=postgres://user:pass@localhost/db
JWT_SECRET=my-secret-key
"""
    )

    config = PartialEncryptionEnvironmentConfig(
        name="test",
        clear_file=str(clear_file),
        secret_file=str(secret_file),
        combined_file=str(combined_file),
    )

    return {
        "config": config,
        "clear_file": clear_file,
        "secret_file": secret_file,
        "combined_file": combined_file,
    }


def test_is_file_encrypted_plaintext(temp_env_files):
    """Test detection of plaintext files."""
    secret_file = temp_env_files["secret_file"]
    assert not is_file_encrypted(secret_file)


def test_is_file_encrypted_with_encrypted_prefix(tmp_path: Path):
    """Test detection of encrypted files."""
    encrypted_file = tmp_path / ".env.encrypted"
    encrypted_file.write_text('DATABASE_URL="encrypted:BDaLMxznvYWcHP..."')

    assert is_file_encrypted(encrypted_file)


def test_is_file_encrypted_with_vault_marker(tmp_path: Path):
    """Test detection of files with DOTENV_VAULT marker."""
    vault_file = tmp_path / ".env.vault"
    vault_file.write_text(
        """DATABASE_URL=value
#/---BEGIN DOTENV_VAULT---/
DOTENV_VAULT_PRODUCTION="vlt_abc123..."
#/---END DOTENV_VAULT---/
"""
    )

    assert is_file_encrypted(vault_file)


def test_combine_files(temp_env_files):
    """Test combining clear and secret files."""
    config = temp_env_files["config"]
    combined_file = temp_env_files["combined_file"]

    # Combine files
    stats = combine_files(config)

    # Verify combined file was created
    assert combined_file.exists()

    # Verify stats
    assert stats["clear_lines"] == 4  # Including comments
    assert stats["secret_vars"] == 2  # DATABASE_URL and JWT_SECRET

    # Verify content
    content = combined_file.read_text()

    # Check warning header
    assert "WARNING: AUTO-GENERATED FILE" in content
    assert "DO NOT EDIT THIS FILE DIRECTLY" in content

    # Check clear section
    assert ".env.test.clear" in content
    assert "DEBUG=false" in content
    assert "PORT=8080" in content

    # Check secret section
    assert ".env.test.secret" in content
    assert "DATABASE_URL" in content
    assert "JWT_SECRET" in content


def test_combine_files_with_encrypted_secret(temp_env_files):
    """Test combining with encrypted secret file."""
    config = temp_env_files["config"]
    secret_file = temp_env_files["secret_file"]
    combined_file = temp_env_files["combined_file"]

    # Simulate encrypted secret file
    secret_file.write_text(
        """DATABASE_URL="encrypted:BDaLMxznvYWcHP..."
JWT_SECRET="encrypted:BD9XKwmZvYWcHP..."
"""
    )

    # Combine files
    combine_files(config)

    # Verify content includes encrypted values
    content = combined_file.read_text()
    assert "encrypted:BDaLMxznvYWcHP..." in content
    assert "encrypted:BD9XKwmZvYWcHP..." in content


def test_combine_files_missing_clear(temp_env_files):
    """Test combining when clear file doesn't exist."""
    config = temp_env_files["config"]
    clear_file = temp_env_files["clear_file"]
    combined_file = temp_env_files["combined_file"]

    # Remove clear file
    clear_file.unlink()

    # Should still work (just secret file)
    stats = combine_files(config)

    assert combined_file.exists()
    assert stats["clear_lines"] == 0
    assert stats["secret_vars"] == 2


def test_combine_files_missing_secret(temp_env_files):
    """Test combining when secret file doesn't exist."""
    config = temp_env_files["config"]
    secret_file = temp_env_files["secret_file"]
    combined_file = temp_env_files["combined_file"]

    # Remove secret file
    secret_file.unlink()

    # Should still work (just clear file)
    stats = combine_files(config)

    assert combined_file.exists()
    assert stats["clear_lines"] == 4
    assert stats["secret_vars"] == 0


def test_combine_files_filters_dotenvx_headers(temp_env_files):
    """Test that dotenvx header comments are filtered from secret file."""
    config = temp_env_files["config"]
    secret_file = temp_env_files["secret_file"]
    combined_file = temp_env_files["combined_file"]

    # Add dotenvx headers to secret file
    secret_file.write_text(
        """#/---BEGIN DOTENV_VAULT---/
#/---WARNING: ENCRYPTED FILE---/
#/---END DOTENV_VAULT---/
DATABASE_URL="encrypted:BDaLMxznvYWcHP..."
"""
    )

    # Combine files
    combine_files(config)

    # Verify headers are filtered
    content = combined_file.read_text()
    assert "#/---BEGIN DOTENV_VAULT---/" not in content
    assert "#/---WARNING: ENCRYPTED FILE---/" not in content
    assert "#/---END DOTENV_VAULT---/" not in content

    # But encrypted value should be present
    assert "DATABASE_URL" in content
    assert "encrypted:BDaLMxznvYWcHP..." in content


def test_warning_header_format(temp_env_files):
    """Test that warning header has correct format."""
    config = temp_env_files["config"]
    combined_file = temp_env_files["combined_file"]

    combine_files(config)

    content = combined_file.read_text()
    lines = content.splitlines()

    # Check first line
    assert lines[0] == "#/---------------------------------------------------/"

    # Check it mentions both source files
    assert any(".env.test.clear" in line for line in lines[:15])
    assert any(".env.test.secret" in line for line in lines[:15])

    # Check commands mentioned
    assert any("envdrift pull-partial" in line for line in lines[:15])
    assert any("envdrift push" in line for line in lines[:15])
