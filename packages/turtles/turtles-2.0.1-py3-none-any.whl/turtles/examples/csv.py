"""
CSV grammar as defined by RFC 4180.
Supports all CSV features: quoted fields, unquoted fields, empty fields, multiple record separators, etc.

Generated by GPT-5.2. Currently untested.
"""

from turtles import Rule, char, repeat, at_least, separator, sequence, optional

# --- Bytes / misc ---
class BOM(Rule):
    "\ufeff"  # UTF-8 BOM if present


# --- Record separators (accept CRLF, LF, or CR) ---
class CRLF(Rule):
    "\r\n"

RecordSep = CRLF | "\n" | "\r"


# --- Delimiter (default comma) ---
class Delim(Rule):
    ","


# Optional: allow whitespace after delimiter before *next field*
# This mimics a common "skipinitialspace" behavior.
class DelimSkipInitialSpace(Rule):
    ","
    repeat[char[" \t"]]  # swallow spaces/tabs after delimiter


# --- Quoting ---
class EscapedQuote(Rule):
    '""'  # doubled quote inside a quoted field


# Any char except a double quote. Includes CR/LF, commas, etc.
# (thatâ€™s what allows multiline quoted fields)
class QuotedChar(Rule):
    ch: char["\x00-\x21\x23-\U0010FFFF"]


class QuotedField(Rule):
    '"'
    value: repeat[EscapedQuote | QuotedChar]
    '"'


# --- Unquoted fields ---
# Typical CSV: unquoted fields end at delimiter or record separator.
# Also disallow raw quotes in unquoted fields (common strict-ish behavior).
class UnquotedChar(Rule):
    ch: char[
        "\x00-\x09"         # include tabs and control chars except LF/CR
        "\x0B-\x0C"
        "\x0E-\x21"         # up to '!' (0x21), excludes '"'(0x22)
        "\x23-\x2B"         # '#'..'+'
        "\x2D-\U0010FFFF"   # '-'..unicode max (excludes ',' 0x2C)
    ]


class UnquotedField(Rule):
    value: repeat[UnquotedChar]


Field = QuotedField | UnquotedField


# --- Records (this is the key part to support empty fields cleanly) ---
# record := [field] (delim [field])*
#
# That means:
#   ""         -> one empty unquoted field (Field present but length 0)
#   ,a,        -> first optional[Field] is missing => leading empty field
#                then ",a" then "," with missing field => trailing empty
#
class Record(Rule):
    first: optional[Field]
    rest: repeat[sequence[Delim, optional[Field]]]


# Variant that allows spaces/tabs after commas (like skipinitialspace):
class RecordSkipInitialSpace(Rule):
    first: optional[Field]
    rest: repeat[sequence[DelimSkipInitialSpace, optional[Field]]]


# --- Top-level file ---
# file := [BOM] record (record_sep record)* [record_sep]
#
# Note: allowing an optional trailing RecordSep is convenient and common.
class CSV(Rule):
    optional[BOM]
    records: repeat[Record, separator[RecordSep], at_least[1]]
    optional[RecordSep]


# If you prefer skipinitialspace behavior, swap in this top-level instead:
class CSVSkipInitialSpace(Rule):
    optional[BOM]
    records: repeat[RecordSkipInitialSpace, separator[RecordSep], at_least[1]]
    optional[RecordSep]
