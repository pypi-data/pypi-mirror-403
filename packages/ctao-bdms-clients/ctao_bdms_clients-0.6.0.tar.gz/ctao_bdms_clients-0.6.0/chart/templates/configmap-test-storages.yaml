---
apiVersion: v1
kind: ConfigMap
metadata:
  name: xrdconfig
data:
  xrdrucio.cfg: |
    all.export /rucio
    xrootd.seclib /usr/lib64/libXrdSec.so
    sec.protocol /usr/lib64 gsi -dlgpxy:1 -exppxy:=creds
    xrootd.chksum adler32 /usr/local/bin/xrdadler32.sh
    ofs.tpc autorm fcreds gsi =X509_USER_PROXY pgm /usr/bin/xrdcp --server
    xrd.port 1094

    xrd.maxfd 1024

    # enable webdav
    if exec xrootd
      xrd.protocol http:1094 /usr/lib64/libXrdHttp-5.so
      http.cadir /etc/grid-security/certificates
      http.cert /etc/grid-security/xrd/xrdcert.pem
      http.key /etc/grid-security/xrd/xrdkey.pem
      http.desthttps yes
      http.listingdeny no
    fi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: xrd-entrypoint
data:
  docker-entrypoint.sh: |
    #!/bin/bash

    ulimit -n 1024

    echo "xrd.port $XRDPORT" >> /etc/xrootd/xrdrucio.cfg
    echo '======== /etc/xrootd/xrdrucio.cfg ========'
    cat /etc/xrootd/xrdrucio.cfg
    echo '=========================================='

    echo 'Fixing ownership and permissions'
    cp /tmp/xrdcert.pem /etc/grid-security/xrd/xrdcert.pem
    cp /tmp/xrdkey.pem /etc/grid-security/xrd/xrdkey.pem
    chown -R xrootd:xrootd /etc/grid-security/xrd
    chmod 0400 /etc/grid-security/xrd/xrdkey.pem

    xrootd -R xrootd -n rucio -c /etc/xrootd/xrdrucio.cfg
