[tool.poetry]
name = "tidy3d"
version = "2.10.2"
description = "A fast FDTD solver"
authors = ["Tyler Hughes <tyler@flexcompute.com>"]
license = "LGPLv2+"
readme = "README.md"
homepage = "https://github.com/flexcompute/tidy3d"
repository = "https://github.com/flexcompute/tidy3d"
classifiers = [
  "License :: OSI Approved :: GNU Lesser General Public License v2 or later (LGPLv2+)",
  "Programming Language :: Python :: 3.10",
  "Programming Language :: Python :: 3.11",
  "Programming Language :: Python :: 3.12",
  "Programming Language :: Python :: 3.13",
  "Operating System :: OS Independent",
]
documentation = "https://docs.flexcompute.com/projects/tidy3d/en/latest/"
include = [{ path = "tidy3d/style.mplstyle", format = ["sdist", "wheel"] }]

[tool.poetry.urls]
"Bug Tracker" = "https://github.com/flexcompute/tidy3d/issues"

[tool.poetry.dependencies]
python = ">=3.10,<3.14"
pyroots = ">=0.5.0,<0.6.0"
xarray = ">=2023.08,<2026.0.0"
importlib-metadata = ">=6.0.0,<9.0.0"
h5netcdf = "1.0.2"
h5py = ">=3.0.0,<3.15"
rich = "^13.0"
numpy = ">=2.2.6,<2.5.0"
matplotlib = "^3.10.0"
shapely = "^2.0"
pandas = "^2.2"
pydantic = "^2.0"
PyYAML = "^6.0.3"
dask = "^2025.12.0"
toml = "^0.10.2"
tomlkit = "^0.13.2"
autograd = ">=1.7.0,<2.0.0"
scipy = "^1.14"
### NOT CORE
boto3 = "^1.28.0"
requests = "^2.31.0"
pyjwt = "^2.10.1"
click = "^8.1.0"
responses = "^0.25.8"
joblib = "^1.5.3"
typing-extensions = "^4.15.0"
### END NOT CORE

### Optional dependencies ###
# development core
ruff = { version = "0.11.11", optional = true }
coverage = { version = "^7.13.1", optional = true }
dill = { version = "^0.4.0", optional = true }
ipython = { version = "^8.38.0", optional = true }
memory_profiler = { version = "^0.61.0", optional = true }
psutil = { version = "^7.2.1", optional = true }
pre-commit = { version = ">=4,<5", optional = true }
pylint = { version = "^4.0.4", optional = true }
pytest = { version = ">=8.1,<10.0.0", optional = true }
pytest-timeout = { version = "^2.4.0", optional = true }
pytest-xdist = "^3.6.1"
pytest-cov = "^6.0.0"
pytest-env = "^1.1.5"
tox = { version = "^4.33.0", optional = true }
diff-cover = { version = "^10.1.0", optional = true }
zizmor = { version = "^1.20.0", optional = true }
mypy = { version = "1.13.0", optional = true }

# gdstk
gdstk = { version = ">=0.9.49,<0.10.0", optional = true }

# design
bayesian-optimization = { version = "<2", optional = true }
pygad = { version = "3.3.1", optional = true }
pyswarms = { version = "^1.3.0", optional = true }

# pytorch
torch = [
  { version = "^2.2.0", source = "PyPI", platform = "darwin", optional = true },
  { version = "^2.2.0", source = "torch-cpu", platform = "!=darwin", optional = true },
]

# scikit-rf
scikit-rf = { version = "^1.9.0", optional = true }

# trimesh
networkx = { version = "^2.6.3", optional = true }
rtree = { version = "1.2.0", optional = true }
trimesh = { version = ">=4.6,<5.0.0", optional = true }

# docs
jupyter = { version = "^1.1.1", optional = true }
jinja2 = { version = ">=3.1.2,<4.0.0", optional = true }
nbconvert = { version = ">=7.11.0,<8.0.0", optional = true }
sphinx = { version = ">=6,<9.0.0", optional = true }
nbsphinx = { version = ">=0.8.7,<0.10.0", optional = true }
sphinx-copybutton = { version = ">=0.5.2,<0.6.0", optional = true }
sphinx-book-theme = { version = ">=1.0.1,<2.0.0", optional = true }
pydata-sphinx-theme = { version = ">=0.13.3,<0.16.0", optional = true }
# divparams = {optional = true, git = "https://github.com/daquinteroflex/sphinxcontrib-divparams.git"} # TODO FIX
tmm = { version = "^0.2.0", optional = true }
grcwa = { version = "^0.1.2", optional = true }
sphinx-design = { version = "^0.6.1", optional = true }
sphinx-favicon = { version = "^1.0.1", optional = true }
sphinx-sitemap = { version = ">=2.5.1,<3.0.0", optional = true }
sphinx-notfound-page = { version = "^1.1.0", optional = true }
sphinx-tabs = { version = "^3.4.7", optional = true }
nbdime = { version = "^4.0.2", optional = true }
myst-parser = { version = "^4.0.1", optional = true }
optax = { version = ">=0.2.2,<0.3.0", optional = true }
signac = { version = "^2.3.0", optional = true }
flax = { version = ">=0.8.2,<0.13", optional = true }
sax = { version = "^0.11", optional = true }
vtk = { version = ">=9.2.6,<10.0.0", optional = true }
sphinxemoji = { version = "^0.3.2", optional = true }
cma = { version = "^4.4.1", optional = true }
openpyxl = { version = "^3.1.5", optional = true }
tidy3d-extras = { version = "2.10.2", optional = true }

[tool.poetry.extras]
dev = [
  'bayesian-optimization',
  "coverage",
  'dill',
  'divparams',
  'gdstk',
  'grcwa',
  'ipython',
  'ipython',
  'torch',
  'jinja2',
  'jupyter',
  'myst-parser',
  'memory_profiler',
  'mypy',
  'nbconvert',
  'nbdime',
  'nbsphinx',
  'networkx',
  'optax',
  'psutil',
  'pre-commit',
  'pydata-sphinx-theme',
  'pygad',
  'pylint',
  'pyswarms',
  'pytest',
  'pytest-timeout',
  'pytest-xdist',
  'pytest-env',
  'pytest-cov',
  'rtree',
  'ruff',
  'sax',
  'signac',
  'sphinx',
  'sphinx-book-theme',
  'sphinx-design',
  'sphinx-copybutton',
  'sphinx-favicon',
  'sphinx-notfound-page',
  'sphinx-sitemap',
  'sphinx-tabs',
  'sphinxemoji',
  'tmm',
  'tox',
  'trimesh',
  'scikit-rf',
  'vtk',
  'cma',
  'diff-cover',
  'openpyxl',
  'zizmor',
]
tests = [
  'psutil',
  'pre-commit',
  'pylint',
  'pytest',
  'pytest-timeout',
  'pytest-xdist',
  'pytest-env',
  'pytest-cov',
  'trimesh'
]
docs = [
  "jupyter",
  "jinja2",
  "nbconvert",
  "sphinx",
  "nbsphinx",
  "ipython",
  "divparams",
  'sphinx-design',
  "sphinx-copybutton",
  'sphinx-favicon',
  "sphinx-book-theme",
  "pydata-sphinx-theme",
  "tmm",
  "gdstk",
  "grcwa",
  "sphinx-sitemap",
  'sphinx-notfound-page',
  "nbdime",
  "optax",
  "signac",
  "sax",
  "pylint",
  "sphinx-tabs",
  "sphinxemoji",
  "myst-parser",
  "cma",
  "openpyxl"
]
gdstk = ["gdstk"]
scikit-rf = ["scikit-rf"]
trimesh = ["trimesh", "networkx", "rtree"]
vtk = ["vtk"]
ruff = ["ruff"]
heatcharge = ["trimesh", "vtk"]
# plugins with extra deps
pytorch = ["torch"]
design = ["bayesian-optimization", "pygad", "pyswarms"]
extras = ["tidy3d-extras"]

[tool.poetry.scripts]
tidy3d = "tidy3d.web.cli:tidy3d_cli"

[[tool.poetry.source]]
name = "pypi"
priority = "primary"


[[tool.poetry.source]]
name = "torch-cpu"
url = "https://download.pytorch.org/whl/cpu"
priority = "explicit"


[[tool.poetry.source]]
name = "codeartifact"
url = "https://flexcompute-625554095313.d.codeartifact.us-east-1.amazonaws.com/pypi/pypi-releases/simple/"
priority = "supplemental"

[build-system]
requires = ["poetry-core>=1.0.0"]
build-backend = "poetry.core.masonry.api"

[tool.ruff]
target-version = "py39"
line-length = 100
extend-exclude = ["docs/faq/", "docs/notebooks/"]

[tool.ruff.lint]
extend-select = [
  "E",      # pycodestyle errors
  "F",      # pyflakes
  "B",      # bugbear
  "I",      # isort
  "UP",     # pyupgrade
  "W",      # pycodestyle
  "C4",     # flake8-comprehensions
  "NPY",    # numpy-specific rules
  "RUF",    # ruff builtins
  "ISC",    # implicit string concatenation
  "PIE",    # flake8-pie
  "RSE",    # unnecessary parantheses on raised exceptions
  "TID",    # no relative imports from parent modules
  "PLE",    # pylint errors
  "PLC",    # pylint conventions
]
extend-ignore = [
  "RUF001", # ambiguous unicode characters
  "RUF002", # ambiguous unicode characters
  "RUF003", # ambiguous unicode characters
  "RUF012", # type hints for mutable defaults
  "RUF015", # next(iter(...)) instead of list(...)[0]
  "E501",   # line too long
  "B905",   # `zip()` without an explicit `strict=` parameter
  "UP007",  # TODO: Remove once Python >= 3.10
  "NPY002", # TODO: Revisit RNG handling
]

[tool.ruff.lint.isort]
required-imports = ["from __future__ import annotations"]

[tool.ruff.lint.flake8-tidy-imports]
banned-module-level-imports = ["scipy", "matplotlib"]

[tool.ruff.lint.per-file-ignores]
"tests/**/*" = [
    "B015",   # useless comparison
    "B018",   # useless expression
    "E402",   # module-level import not at top of file
    "E731",   # lambda assignment
    "F841",   # unused local variable
    "S101",   # asserts allowed in tests
    "NPY201", # numpy 2.* compatibility check
    "TID252", # allow relative imports in tests
    "TID253", # allow heavy imports in tests
]
"tidy3d/plugins/**/*" = [
    "TID253", # allow heavy imports in plugins (not used by MC)
]

[tool.pytest.ini_options]
# TODO: remove --assert=plain when https://github.com/scipy/scipy/issues/22236 is resolved
addopts = "--cov=tidy3d --doctest-modules -n auto --dist worksteal --assert=plain -m 'not numerical and not perf'"
markers = [
  "numerical: marks numerical tests for adjoint gradients that require running simulations (deselect with '-m \"not numerical\"')",
  "perf: marks tests which test the runtime of operations (deselect with '-m \"not perf\"')",
  "slow: marks tests as slow (deselect with -m 'not slow')",
]
env = ["MPLBACKEND=Agg", "OMP_NUM_THREADS=1", "TIDY3D_MICROWAVE__SUPPRESS_RF_LICENSE_WARNING=true"]
doctest_optionflags = "NORMALIZE_WHITESPACE ELLIPSIS"
norecursedirs = [
  "tests/_test_local",
  "tests/test_cli",
  "tests/_test_data",
  "tests/_test_notebooks",
  "tests/_test_tidy3d_extras",
  "tidy3d/web",
  "docs/notebooks",
  "docs/faq",
]
filterwarnings = "ignore::DeprecationWarning"
testpaths = ["tidy3d", "tests", "docs"]
python_files = "*.py"

[tool.mypy]
python_version = "3.10"
files = [
  "tidy3d/web",
  "tidy3d/config",
  "tidy3d/material_library",
  "tidy3d/components/geometry"
]
ignore_missing_imports = true
follow_imports = "skip"
disallow_untyped_defs = true
disable_error_code = [
  "abstract",
  "annotation-unchecked",
  "arg-type",
  "assert-type",
  "assignment",
  "attr-defined",
  "await-not-async",
  "call-arg",
  "call-overload",
  "comparison-overlap",
  "dict-item",
  "empty-body",
  "exit-return",
  "explicit-override",
  "func-returns-value",
  "has-type",
  "ignore-without-code",
  "import",
  "import-not-found",
  "import-untyped",
  "index",
  "list-item",
  "literal-required",
  "method-assign",
  "misc",
  "mutable-override",
  "name-defined",
  "name-match",
  "narrowed-type-not-subtype",
  "no-any-return",
  "no-any-unimported",
  "no-overload-impl",
  "no-redef",
  "no-untyped-call",
  "operator",
  "overload-cannot-match",
  "overload-overlap",
  "override",
  "possibly-undefined",
  "prop-decorator",
  "redundant-cast",
  "redundant-expr",
  "redundant-self",
  "return",
  "return-value",
  "safe-super",
  "str-bytes-safe",
  "str-format",
  "syntax",
  "top-level-await",
  "truthy-bool",
  "truthy-function",
  "truthy-iterable",
  "type-abstract",
  "type-arg",
  "type-var",
  "typeddict-item",
  "typeddict-readonly-mutated",
  "typeddict-unknown-key",
  "unimported-reveal",
  "union-attr",
  "unreachable",
  "unused-awaitable",
  "unused-coroutine",
  "unused-ignore",
  "used-before-def",
  "valid-newtype",
  "valid-type",
  "var-annotated",
]
enable_error_code = ["no-untyped-def"]
