"""
GR Model Configuration.

Provides configuration schema, defaults, transformers, and validation
for the GR4J/GR5J/GR6J family of hydrological models.

This module registers GR-specific configuration components with the
ModelRegistry, enabling the core config system to remain model-agnostic.

PHASE 2 REFACTORING: This adapter now uses AutoGeneratedConfigAdapter
to auto-generate defaults and transformers from Pydantic Field declarations.
All defaults are maintained in GRConfig (model_configs.py) for single
source of truth.
"""

from typing import Dict, Any
from symfluence.models.base import AutoGeneratedConfigAdapter, ConfigValidationError
from symfluence.core.config.models.model_configs import GRConfig


# ============================================================================
# GR Config Adapter
# ============================================================================

class GRConfigAdapter(AutoGeneratedConfigAdapter):
    """
    Configuration adapter for GR models with auto-generated defaults and transformers.

    Defaults and transformers are automatically extracted from GRConfig
    Pydantic model. Only custom validation logic is implemented here.

    This reduces boilerplate from ~120 lines to ~60 lines while maintaining
    all functionality. All defaults are now in GRConfig Field declarations.
    """

    def __init__(self, model_name: str = 'GR'):
        super().__init__(model_name)

    def get_config_schema(self):
        """Return GR Pydantic configuration schema."""
        return GRConfig

    def validate(self, config: Dict[str, Any]) -> None:
        """Validate GR-specific configuration."""
        required_fields = self.get_required_keys()
        missing_fields = []

        for field in required_fields:
            value = config.get(field)
            if value is None or value == '' or value == 'None':
                missing_fields.append(field)

        if missing_fields:
            raise ConfigValidationError(
                "GR configuration incomplete. Missing required fields:\n"
                + "\n".join(f"  â€¢ {field}" for field in missing_fields)
            )

        # Validate GR model type
        model_type = config.get('GR_MODEL_TYPE', 'GR4J')
        valid_types = ['GR4J', 'GR5J', 'GR6J']
        if model_type not in valid_types:
            raise ConfigValidationError(
                f"Invalid GR_MODEL_TYPE '{model_type}'. "
                f"Must be one of: {', '.join(valid_types)}"
            )

        # Validate spatial mode
        spatial_mode = config.get('GR_SPATIAL_MODE', 'lumped')
        valid_modes = ['auto', 'lumped', 'semi_distributed', 'distributed']
        if spatial_mode not in valid_modes:
            raise ConfigValidationError(
                f"Invalid GR_SPATIAL_MODE '{spatial_mode}'. "
                f"Must be one of: {', '.join(valid_modes)}"
            )

    def get_required_keys(self) -> list:
        """Get list of required configuration keys for GR."""
        return [
            'GR_EXE',
            'SETTINGS_GR_PATH',
        ]
