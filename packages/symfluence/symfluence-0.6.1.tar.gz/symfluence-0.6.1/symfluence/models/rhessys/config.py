"""
RHESSys Model Configuration.

Provides configuration schema, defaults, transformers, and validation
for the RHESSys model.

This module registers RHESSys-specific configuration components with the
ModelRegistry, enabling the core config system to remain model-agnostic.

PHASE 2 REFACTORING: This adapter now uses AutoGeneratedConfigAdapter
to auto-generate defaults and transformers from Pydantic Field declarations.
All defaults are maintained in RHESSysConfig (model_configs.py) for single
source of truth.
"""

from typing import Dict, Any
from symfluence.models.base import AutoGeneratedConfigAdapter
from symfluence.core.config.models.model_configs import RHESSysConfig


class RHESSysConfigAdapter(AutoGeneratedConfigAdapter):
    """
    Configuration adapter for RHESSys model with auto-generated defaults and transformers.

    Defaults and transformers are automatically extracted from RHESSysConfig
    Pydantic model. Only custom validation logic is implemented here.
    """

    def __init__(self, model_name: str = 'RHESSYS'):
        super().__init__(model_name)

    def get_config_schema(self):
        """Return RHESSys Pydantic configuration schema."""
        return RHESSysConfig

    def validate(self, config: Dict[str, Any]) -> None:
        """
        Validate RHESSys-specific configuration parameters.

        Performs custom validation beyond what Pydantic enforces, such as
        checking for required input files (worldfile, flowtable), valid
        date ranges, and WMFire configuration consistency.

        Args:
            config: Dictionary containing RHESSys configuration values to validate.

        Raises:
            ValueError: If configuration values are invalid or inconsistent.

        Note:
            Currently a placeholder. Add custom validation logic for RHESSys
            parameters like worldfile existence, TEC file format validation,
            and fire module configuration when WMFire is enabled.
        """
        pass  # Add custom validation logic if needed


# Legacy schema function for backward compatibility
def create_rhessys_schema():
    """
    Create RHESSys schema for legacy model_config_schema module.

    DEPRECATED: This function exists for backward compatibility with the
    legacy schema registry system. New code should use RHESSysConfigAdapter
    from ModelRegistry instead.
    """
    from symfluence.models.config.model_config_schema import (
        ModelConfigSchema,
        InstallationConfig,
        ExecutionConfig,
        InputConfig,
        OutputConfig,
        ConfigKey,
        ConfigKeyType
    )

    return ModelConfigSchema(
        model_name='RHESSys',
        description='Regional Hydro-Ecologic Simulation System',
        installation=InstallationConfig(
            install_path_key='RHESSYS_INSTALL_PATH',
            default_install_subpath='installs/rhessys',
            exe_name_key='RHESSYS_EXE',
            default_exe_name='rhessys'
        ),
        execution=ExecutionConfig(
            method='subprocess',
            supports_parallel=False,
            default_timeout=3600
        ),
        input=InputConfig(
            forcing_dir_key='FORCING_RHESSYS_PATH',
            default_forcing_subpath='forcing/rhessys',
            forcing_file_pattern='*.nc',
            required_variables=['time', 'tmax', 'tmin', 'precip']
        ),
        output=OutputConfig(
            output_dir_key='EXPERIMENT_OUTPUT_RHESSYS',
            default_output_subpath='simulations/{experiment_id}/RHESSys',
            output_file_pattern='rhessys_output.csv',
            primary_output_var='streamflow'
        ),
        config_keys=[
            ConfigKey('RHESSYS_WORLDFILE', ConfigKeyType.STRING, True),
            ConfigKey('RHESSYS_FLOWTABLE', ConfigKeyType.STRING, True),
            ConfigKey('RHESSYS_TECFILE', ConfigKeyType.STRING, False),
            ConfigKey('RHESSYS_PARAMS_TO_CALIBRATE', ConfigKeyType.STRING, False),
        ]
    )
