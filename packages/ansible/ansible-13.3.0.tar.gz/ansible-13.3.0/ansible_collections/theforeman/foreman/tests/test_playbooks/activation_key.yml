---
- hosts: localhost
  collections:
    - theforeman.foreman
  tags:
    - setup
  gather_facts: false
  vars_files:
    - vars/server.yml
  tasks:
    - include_tasks: tasks/organization.yml
      vars:
        organization_state: present
    - include_tasks: tasks/product.yml
      vars:
        product_state: present
    - include_tasks: tasks/repository.yml
      vars:
        repository_state: present
    - include_tasks: tasks/host_collection.yml
      vars:
        host_collection_state: present
    - include_tasks: tasks/activation_key.yml
      vars:
        activation_key_state: absent
    - include_tasks: tasks/activation_key.yml
      vars:
        activation_key_state: absent
        activation_key_name: Test Activation Key Copy
    - include_tasks: tasks/lifecycle_environment.yml
      vars:
        lifecycle_environment_state: present
        lifecycle_environment_name: "{{ item.name }}"
        lifecycle_environment_label: "{{ item.label }}"
        lifecycle_environment_prior: "{{ item.prior }}"
      loop:
        - name: Dev
          prior: Library
        - name: Test
          prior: Dev
        - name: Prod
          prior: Test
    - include_tasks: tasks/content_view.yml
      vars:
        content_view_name: "{{ item }}"
      loop:
        - Test Content View 1
        - Test Content View 2
        - Test Content View 3
    - include_tasks: tasks/content_view_version.yml
      vars:
        content_view_name: "{{ item }}"
        lifecycle_environments:
          - Dev
          - Test
          - Prod
      loop:
        - Test Content View 1
        - Test Content View 2
        - Test Content View 3

- hosts: tests
  collections:
    - theforeman.foreman
  tags:
    - test
  gather_facts: false
  vars_files:
    - vars/server.yml
  tasks:
    - name: create minimal AK
      include_tasks: tasks/activation_key.yml
      vars:
        expected_change: true
    - name: create minimal AK again, no change
      include_tasks: tasks/activation_key.yml
      vars:
        expected_change: false
    - name: remove minimal AK
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_state: absent
        expected_change: true

    - name: create AK with CV
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_lifecycle_environment: "Library"
        activation_key_content_view: "Default Organization View"
        expected_change: true
    - name: create AK with CV, no change
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_lifecycle_environment: "Library"
        activation_key_content_view: "Default Organization View"
        expected_change: false
    - name: remove AK with CV
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_state: absent
        expected_change: true

    - name: create AK with content overrides set to disabled
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_lifecycle_environment: "Library"
        activation_key_content_view: "Default Organization View"
        activation_key_content_overrides:
          - label: "Test_Organization_Test_Product_Test_Repository"
            override: disabled
        expected_change: true
        expected_diff: true
        expected_diff_before: "content_overrides.*{}"
        expected_diff_after: "Test_Organization_Test_Product_Test_Repository.*false"
    - name: create AK with content overrides set to disabled again, no change
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_content_overrides:
          - label: "Test_Organization_Test_Product_Test_Repository"
            override: disabled
        expected_change: false
    - name: update AK with content overrides set to default
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_content_overrides:
          - label: "Test_Organization_Test_Product_Test_Repository"
            override: default
        expected_change: true
        expected_diff: true
        expected_diff_before: "Test_Organization_Test_Product_Test_Repository.*false"
        expected_diff_after: "content_overrides.*{}"
    - name: update AK with content overrides set to default again, no change
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_content_overrides:
          - label: "Test_Organization_Test_Product_Test_Repository"
            override: default
        expected_change: false
    - name: update AK with content overrides set to enabled
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_content_overrides:
          - label: "Test_Organization_Test_Product_Test_Repository"
            override: enabled
        expected_change: true
        expected_diff: true
        expected_diff_before: "content_overrides.*{}"
        expected_diff_after: "Test_Organization_Test_Product_Test_Repository.*true"
    - name: update AK with content overrides set to enabled again, no change
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_content_overrides:
          - label: "Test_Organization_Test_Product_Test_Repository"
            override: enabled
        expected_change: false
    - name: remove AK with content overrides
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_state: absent
        expected_change: true

    - name: create AK with unlimited_hosts=false
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_unlimited_hosts: false
        activation_key_max_hosts: 10
        expected_change: true
    - name: create AK with unlimited_hosts=false again, no change
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_unlimited_hosts: false
        activation_key_max_hosts: 10
        expected_change: false
    - name: remove AK with unlimited_hosts=false
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_state: absent
        expected_change: true

    - name: create AK with host_collections
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_host_collections:
          - "TheAnswer"
        expected_change: true
        expected_diff: true
        expected_diff_before: ""
        expected_diff_after: "activation_keys/host_collections"
    - name: create AK with host_collections again, no change
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_host_collections:
          - "TheAnswer"
        expected_change: false
    - name: remove host_collections from AK
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_host_collections: []
        expected_change: true
    - name: remove AK with host_collectione
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_state: absent
        expected_change: true

    - name: create minimal AK with state=present_with_defaults
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_state: present_with_defaults
        expected_change: true
    - name: try to update an AK with state=present_with_defaults, no change
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_lifecycle_environment: "Library"
        activation_key_content_view: "Default Organization View"
        activation_key_content_overrides:
          - label: "Test_Organization_Test_Product_Test_Repository"
            override: disabled
        activation_key_state: present_with_defaults
        expected_change: false

    - name: copy AK
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_new_name: "Test Activation Key Copy"
        activation_key_state: copied
        expected_change: true
    - name: copy AK again, no change
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_new_name: "Test Activation Key Copy"
        activation_key_state: copied
        expected_change: false
    - name: remove copied AK
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_name: "Test Activation Key Copy"
        activation_key_state: absent
        expected_change: true

    - name: remove AK
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_state: absent
        expected_change: true
    - name: remove AK again, no change
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_state: absent
        expected_change: false

    - name: create AK with multiple CVs
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_name: "Test Activation Key with multiple CVs"
        activation_key_content_view_environments: 
          - "Dev/Test_Content_View_1"
          - "Test/Test_Content_View_2"
        expected_change: true
        expected_diff: true
        expected_diff_before: "{}"
        # Dev/Test_Content_View_1 must appear
        # Test/Test_Content_View_2 must appear
        # Default Organization View must NOT appear
        expected_diff_after: '^(?=.*Dev/Test_Content_View_1)(?=.*Test/Test_Content_View_2)(?!.*Default Organization View).*'
    - name: swap content-view-environments, nothing should happen
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_name: "Test Activation Key with multiple CVs"
        activation_key_content_view_environments: 
          - "Test/Test_Content_View_2"
          - "Dev/Test_Content_View_1"
        expected_change: false
    - name: add another content-view-environment
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_name: "Test Activation Key with multiple CVs"
        activation_key_content_view_environments: 
          - "Dev/Test_Content_View_1"
          - "Test/Test_Content_View_2"
          - "Prod/Test_Content_View_3"
        expected_change: true
        expected_diff: true
        # Dev/Test_Content_View_1 must appear
        # Test/Test_Content_View_2 must appear
        # Default Organization View must NOT appear
        expected_diff_before: '^(?=.*Dev/Test_Content_View_1)(?=.*Test/Test_Content_View_2)(?!.*Default Organization View).*'
        # Dev/Test_Content_View_1 must appear
        # Test/Test_Content_View_2 must appear
        # Prod/Test_Content_View_3 must appear
        # Default Organization View must NOT appear
        expected_diff_after: '^(?=.*Dev/Test_Content_View_1)(?=.*Test/Test_Content_View_2)(?=.*Prod/Test_Content_View_3)(?!.*Default Organization View).*'
    - name: remove AK with multiple CVs
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_name: "Test Activation Key with multiple CVs"
        activation_key_state: absent
        expected_change: true

    - name: create AK with multiple CVs
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_content_view_environments: 
          - "Dev/Test_Content_View_1"
          - "Test/Test_Content_View_2"
        expected_change: true
        expected_diff: true
        expected_diff_before: "{}"
        # Dev/Test_Content_View_1 must appear
        # Test/Test_Content_View_2 must appear
        # Default Organization View must NOT appear
        expected_diff_after: "^(?=.*Dev/Test_Content_View_1)(?=.*Test/Test_Content_View_2)(?!.*Default Organization View).*"
    - name: change AK to single CV mode
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_content_view: "Default Organization View"
        activation_key_lifecycle_environment: Library
        expected_change: true
        # Dev/Test_Content_View_1 must appear
        # Test/Test_Content_View_2 must appear
        # Default Organization View must NOT appear
        expected_diff_before: "^(?=.*Dev/Test_Content_View_1)(?=.*Test/Test_Content_View_2)(?!.*Default Organization View).*"
        # Dev/Test_Content_View_1 must NOT appear
        # Test/Test_Content_View_2 must NOT appear
        # Default Organization View must appear
        expected_diff_after: "^(?!.*(Dev/Test_Content_View_1|Test/Test_Content_View_2))(?=.*Default Organization View).*"
    - name: change AK back to multiple CV mode
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_content_view_environments: 
          - "Dev/Test_Content_View_1"
          - "Test/Test_Content_View_2"
        expected_change: true
        # Dev/Test_Content_View_1 must NOT appear
        # Test/Test_Content_View_2 must NOT appear
        # Default Organization View must appear
        expected_diff_before: "^(?!.*(Dev/Test_Content_View_1|Test/Test_Content_View_2))(?=.*Default Organization View).*"
        # Dev/Test_Content_View_1 must appear
        # Test/Test_Content_View_2 must appear
        # Default Organization View must NOT appear
        expected_diff_after: "^(?=.*Dev/Test_Content_View_1)(?=.*Test/Test_Content_View_2)(?!.*Default Organization View).*"
    - name: remove AK
      include_tasks: tasks/activation_key.yml
      vars:
        activation_key_state: absent
        expected_change: true

- hosts: localhost
  collections:
    - theforeman.foreman
  tags:
    - teardown
  gather_facts: false
  vars_files:
    - vars/server.yml
  tasks:
    - include_tasks: tasks/repository.yml
      vars:
        repository_state: absent
    - include_tasks: tasks/product.yml
      vars:
        product_state: absent
    - include_tasks: tasks/lifecycle_environment.yml
      vars:
        lifecycle_environment_state: absent
        lifecycle_environment_name: "{{ item }}"
      loop:
        - Test
        - Dev
    - include_tasks: tasks/content_view_version.yml
      vars:
        state: absent
        content_view_name: "{{ item }}"
        lifecycle_environments:
          - Dev
          - Test
      loop:
        - Test Content View 1
        - Test Content View 2
    - include_tasks: tasks/content_view.yml
      vars:
        content_view_state: absent
        content_view_name: "{{ item }}"
      loop:
        - Test Content View 1
        - Test Content View 2
    - include_tasks: tasks/organization.yml
      vars:
        organization_state: absent
