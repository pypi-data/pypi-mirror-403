name: CI
on:
  # Run CI against all pushes (direct commits, also merged PRs), Pull Requests
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev

jobs:
  ###
  # Sanity tests (REQUIRED)
  #
  # https://docs.ansible.com/ansible/latest/dev_guide/testing_sanity.html
  sanity:
    name: Sanity (${{ matrix.ansible }})
    strategy:
      matrix:
        ansible:
          # - stable-2.16 # End Of Life July 2025 https://docs.ansible.com/ansible/latest/reference_appendices/release_and_maintenance.html#ansible-core-support-matrix
          # - stable-2.17 # End Of Life Nov 2025
          - stable-2.18
          - stable-2.19
          - stable-2.20
          - devel
    runs-on: ubuntu-latest
    steps:
      - name: Perform sanity testing
        uses: ansible-community/ansible-test-gh-action@release/v1
        with:
          ansible-core-version: ${{ matrix.ansible }}
          testing-type: sanity
          pull-request-change-detection: false

  # ansible-lint checks
  lint-checks:
    name: Lint Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install ansible-lint pylint
      - run: ansible-lint --exclude "tests/integration/targets/inventory_azure/playbooks/vars.yml" --force-color
      - run: |
          echo "Running pylint on EDA event_source..."
          pylint extensions/eda/plugins/event_source/*.py \
            --output-format=parseable \
            --score=no \
            --disable=R0801,E0401,C0103,R0913,R0902,R0903,W0621

  # requirements.txt validation
  requirements-validation:
    name: Requirements Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          echo "Checking requirements.txt for pinned versions..."
          if grep '==' requirements.txt | grep -v -E '^(azure-|msgraph-sdk)'; then
            echo "Error: Found pinned third-party dependencies! Please remove version pins."
            exit 1
          else
            echo "Success: requirements.txt validation passed."
          fi

  # ruff-check
  ruff-checks:
    name: Ruff Check for EDA plugins
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install ruff
      - run: |
          echo "Running Ruff check for EDA plugins..."
          ruff check --select ALL --ignore D100,D104,INP001,FA102,UP001,UP010,I001,FA100,PLR0913,E501 -q extensions/eda/plugins
