import re
from nonebot.drivers import HTTPClientMixin, Request, Response
from nonebot.adapters import Adapter

from .exception import ApiNotAvailable, NetworkError

YUNHU_EMOJI_MAP = {
    "[.æ»‘ç¨½]": "ğŸ¤ª",
    "[.é¾‡ç‰™å’§å˜´]": "ğŸ˜¬",
    "[.ç±³é¥­]": "ğŸš",
    "[.å–·åš]": "ğŸ¤§",
    "[.æ”¾å£°å¤§å“­]": "ğŸ˜­",
    "[.é¢æ¡]": "ğŸœ",
    "[.çœ‰ä¸Šæ‰¬]": "ğŸ¤¨",
    "[.åƒæƒŠ]": "ğŸ˜®",
    "[.æ£’æ£’ç³–]": "ğŸ­",
    "[.å´‡æ‹œ]": "ğŸ¤©",
    "[.å‘¼æ°”]": "ğŸ˜®â€ğŸ’¨",
    "[.é¸¡å°¾é…’]": "ğŸ¸",
    "[.æ€è€ƒ]": "ğŸ¤”",
    "[.ç¼„é»˜]": "ğŸ˜¶",
    "[.å¹²æ¯]": "ğŸ»",
    "[.ä¹¦å‘†]": "ğŸ¤“",
    "[.å¤§ç¬‘çš„çŒ«]": "ğŸ˜¸",
    "[.å¥¶ç“¶]": "ğŸ¼",
    "[.è¯´è°]": "ğŸ¤¥",
    "[.èŠ±ç—´çš„çŒ«]": "ğŸ˜»",
    "[.çˆ†ç±³èŠ±]": "ğŸ¿",
    "[.ç¬‘æ­ª]": "ğŸ¤£",
    "[.å¥¸ç¬‘çš„çŒ«]": "ğŸ˜¼",
    "[.ç¤¼ç‰©]": "ğŸ",
    "[.å–œç¬‘é¢œå¼€]": "ğŸ˜Š",
    "[.äº²äº²çŒ«]": "ğŸ˜½",
    "[.è›‹ç³•]": "ğŸ‚",
    "[.èšä¼šç¬‘è„¸]": "ğŸ¥³",
    "[.ç”Ÿæ°”çš„çŒ«]": "ğŸ˜ ",
    "[.å½©å¸¦]": "ğŸ‰",
    "[.èåŒ–]": "ğŸ« ",
    "[.å“­æ³£çš„çŒ«]": "ğŸ˜¿",
    "[.è¥¿çº¢æŸ¿]": "ğŸ…",
    "[.å·çœ‹]": "ğŸ«£",
    "[.å¤´ç–¼å¥³]": "ğŸ¤¦â€â™€ï¸",
    "[.èŒ„å­]": "ğŸ†",
    "[.æ–œå˜´]": "ğŸ«¤",
    "[.å¤´ç–¼ç”·]": "ğŸ¤¦â€â™‚ï¸",
    "[.è‘¡è„]": "ğŸ‡",
    "[.å’’éª‚]": "ğŸ¤¬",
    "[.æ‘Šæ‰‹å¥³]": "ğŸ¤·â€â™€ï¸",
    "[.è¥¿ç“œ]": "ğŸ‰",
    "[.æ‚å˜´ç¬‘]": "ğŸ¤­",
    "[.æ‘Šæ‰‹ç”·]": "ğŸ¤·â€â™‚ï¸",
    "[.æ©˜å­]": "ğŸŠ",
    "[.å‘•å]": "ğŸ¤®",
    "[.æ‚å˜´]": "ğŸ«¢",
    "[.æŸ æª¬]": "ğŸ‹",
    "[.æµæ±—]": "ğŸ˜…",
    "[.OK]": "ğŸ‘Œ",
    "[.é¦™è•‰]": "ğŸŒ",
    "[.æ— è¯­]": "ğŸ˜¶",
    "[.æ¯”å¿ƒ]": "ğŸ«°",
    "[.è è]": "ğŸ",
    "[.é£å»]": "ğŸ˜˜",
    "[.ç‚¹èµ]": "ğŸ‘",
    "[.çº¢è‹¹æœ]": "ğŸ",
    "[.å¢¨é•œ]": "ğŸ˜",
    "[.é¼“æŒ]": "ğŸ‘",
    "[.é’è‹¹æœ]": "ğŸ",
    "[.ç¬‘å“­]": "ğŸ˜‚",
    "[.ä¿ä½‘]": "ğŸ™",
    "[.æ¡ƒ]": "ğŸ‘",
    "[.å˜˜]": "ğŸ¤«",
    "[.æ¡æ‰‹]": "ğŸ¤",
    "[.æ¨±æ¡ƒ]": "ğŸ’",
    "[.å§”å±ˆ]": "ğŸ¥²",
    "[.èƒœåˆ©]": "âœŒï¸",
    "[.è‰è“]": "ğŸ“",
    "[.å†·æ±—]": "ğŸ˜¥",
    "[.å‡»æ‹³]": "ğŸ‘Š",
    "[.ä¸Šç®­å¤´ï¸]": "â¬†ï¸",
    "[.æ–œçœ¼]": "ğŸ˜‰",
    "[.éœ¸ç‹é¾™]": "ğŸ¦–",
    "[.ä¸‹ç®­å¤´ï¸]": "â¬‡ï¸",
    "[.ç¾æ¶©å¾®ç¬‘]": "ğŸ¥°",
    "[.çŒªå¤´]": "ğŸ·",
    "[.å·¦ç®­å¤´]": "â¬…ï¸",
    "[.åèˆŒå¤´]": "ğŸ˜‹",
    "[.é’è›™]": "ğŸ¸",
    "[.å³ç®­å¤´ï¸]": "â¡ï¸",
    "[.æ¾äº†å£æ°”]": "ğŸ˜®â€ğŸ’¨",
    "[.ä»“é¼ ]": "ğŸ¹",
    "[.æŒ‰é”®1]": "1ï¸âƒ£",
    "[.èŠ±ç—´]": "ğŸ˜",
    "[.ç†Š]": "ğŸ»",
    "[.æŒ‰é”®2]": "2ï¸âƒ£",
    "[.å¾—æ„]": "ğŸ˜",
    "[.çŒ«]": "ğŸ±",
    "[.æŒ‰é”®3]": "3ï¸âƒ£",
    "[.ç¾æ¶©äº²äº²]": "ğŸ˜š",
    "[.é¸¡]": "ğŸ”",
    "[.æŒ‰é”®4]": "4ï¸âƒ£",
    "[.åèˆŒ]": "ğŸ˜›",
    "[.å°é¸¡ç ´å£³]": "ğŸ£",
    "[.æŒ‰é”®5]": "5ï¸âƒ£",
    "[.å•çœ¼åèˆŒ]": "ğŸ˜œ",
    "[.å°é¸¡]": "ğŸ¤",
    "[.æŒ‰é”®6]": "6ï¸âƒ£",
    "[.çœ¯çœ¼åèˆŒ]": "ğŸ˜",
    "[.é¾Ÿ]": "ğŸ¢",
    "[.æŒ‰é”®7]": "7ï¸âƒ£",
    "[.å¤±æœ›]": "ğŸ˜”",
    "[.çƒ­å¸¦é±¼]": "ğŸ ",
    "[.æŒ‰é”®8]": "8ï¸âƒ£",
    "[.æ‹…å¿ƒ]": "ğŸ˜Ÿ",
    "[.èœ—ç‰›]": "ğŸŒ",
    "[.æŒ‰é”®9]": "9ï¸âƒ£",
    "[.å›°]": "ğŸ˜´",
    "[.æ±‰å ¡]": "ğŸ”",
    "[.ç´¯]": "ğŸ˜©",
    "[.æŠ«è¨]": "ğŸ•",
}

# é¢„å…ˆè®¡ç®—è¡¨æƒ… key åˆ—è¡¨ä¸åŒ¹é…æ­£åˆ™ï¼Œé¿å…åœ¨ decode_emoji ä¸­é‡å¤æ„å»º
# æŒ‰é•¿åº¦é™åºï¼Œé˜²æ­¢çŸ­ key ä¼˜å…ˆåŒ¹é…å¹¶æˆªæ–­é•¿ key
_EMOJI_KEYS = sorted(YUNHU_EMOJI_MAP.keys(), key=len, reverse=True)
_EMOJI_PATTERN = re.compile("|".join(re.escape(k) for k in _EMOJI_KEYS))


async def fetch_bytes(adapter: Adapter, url: str) -> bytes:
    """ä¸‹è½½urlèµ„æºï¼Œè¿”å›bytes"""
    
    request = Request(
        method="GET",
        url=url,
    )
    if not isinstance(adapter.driver, HTTPClientMixin):
        raise ApiNotAvailable
    try:
        response: Response = await adapter.driver.request(request)
    except Exception as e:
        raise NetworkError(f"Fail to fetch bytes: {e}") from e
    if isinstance(response.content, bytes):
        return response.content
    raise ValueError("Response content is not bytes")


__all__ = ["_EMOJI_KEYS", "_EMOJI_PATTERN", "fetch_bytes"]
