[project]
name = "highlighter-sdk"
version = "2.6.37"
readme = "README.md"
description = "Package to interact with the Highlighter Perception System"
requires-python = ">=3.12,<=3.14"

# From pep 0639:
# https://peps.python.org/pep-0639/#i-have-a-private-package-that-won-t-be-distributed
license-files = { paths = ["LICENSE"] }


keywords = [
  "enterprise perception system"
]

# See: https://pypi.org/classifiers/
classifiers = [
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "License :: OSI Approved :: Apache Software License",
    "Operating System :: Unix",
    "Intended Audience :: Developers",
]

authors = [
{name = "Joshua Patterson", email = "joshua.patterson@silverpond.com.au"},
{name = "Jono Chang", email = "jonathan.chang@silverpond.com.au"},
{name = "Simon Hudson", email = "simon.hudson@silverpond.com.au"},
]


dependencies = [
  "alembic==1.15.2",
  "av~=14.1.0",  # Python API for ffmpeg
  "boto3~=1.34.00",  # S3 API
  "click>=7, <9, != 8.0.0",  # CLI
  "colorama~=0.4.4",  # Colored logs
  "cookiecutter",  # Templated repos
  "fastavro~=1.8",  # Avro loading/saving
  "gql[aiohttp,requests]~=3.5.0",  # GraphQL queries to HL Web
  "litellm~=1.80.0", # requests to llm for agentic behaviour
  "pandas~=2.2",  # Dataset in-memory representation
  "Pillow~=10.4.0",  # Saving/loading images
  "pooch~=1.5",  # Caching artefacts
  "pybreaker~=1.4.0", # Circuit breaker
  "cel-python~=0.4.0",  # CEL expression evaluation for RuleTrigger
  "pydantic>=1.6, <2.9",  # Core data structures
  "python-magic~=0.4.0; sys_platform == 'linux'",  # Guessing file MIME-type
  "python-magic~=0.4.0; sys_platform == 'darwin'",
  "python-magic-bin~=0.4.0; sys_platform == 'win32'",
  "PyYAML>=5.0",  # Reading/writing data in the CLI, dataset manifest
  "requests>=2.32.3,<3",  # Downloading images
  "scipy~=1.16.0", # from scipy.spatial.distance import pdist, squareform
  "shapely>2.0.1",  # Geometry representation and operations
  "sqlmodel~=0.0.22",
  "tenacity~=9.1.2", # used for retries
  "tomli-w~=1.2.0", # Used by Highlighter Runtime Config
  "tqdm~=4.0",  # Upload/download progress
  "zeroconf>=0.147.0,<1.0.0",  # mDNS/Bonjour service discovery for camera lookup
  
  #aiko dependecies
  "asciimatics~=1.15.0",
  "avro~=1.12.0",
  "avro-validator~=1.2.1",
  "paho-mqtt>=1.6.1,<2.0.0",
  "psutil~=6.0.0",
  "pyperclip~=1.9.0",
  "pyzmq~=26.2.0",
  "transitions~=0.9.2",
  "wrapt~=1.16.0"
]

[project.optional-dependencies]
cv2 =        ["opencv-python~=4.7"]
predictors = ["opencv-python~=4.7", "torch", "onnxruntime"]
yolo =       ["opencv-python~=4.7", "torch", "onnx", "onnxruntime", "ultralytics"]
tracker =    ["pykalman~=0.10.1", "torch"]
matplotlib = ["matplotlib~=3.10"]
rtspserver = ["PyGObject"]
hdf        = [
  # tables depends on blosc2 whose nix derivation depends on torch at test time
  # so we make tables optional
  "tables~=3.7", # Used by pandas to write .hdf files
]

# Needed to allow aiko_services git dependency
[tool.hatch.metadata]
allow-direct-references = true

[tool.hatch.envs.default]
dependencies = [
  "pytest~=8.0",
  "twine",
  "black>=19.10b0",
  "pylint~=2.6",
  "wrapt",  # needed due to error in pylint
  "nbstripout",
  "isort~=5.0",
]

[tool.hatch.envs.default.scripts]
test = "pytest {args:tests}"

check = [ ]

# Run formatting
# hatch run fmt:fmt
fmt = [
  "isort --cr . --resolve-all-configs --overwrite-in-place . ",
  "black --config pyproject.toml .",
  "nbstripout notebooks/*",
  "check",
  ]

[project.scripts]
hl = "highlighter.cli.highlighter_cli:highlighter_group"
aiko_dashboard = "aiko_services.main.dashboard:main"
aiko_pipeline = "aiko_services.main.pipeline:main"
aiko_registrar = "aiko_services.main.registrar:main"
rtsp-server = "highlighter.testing.rtsp_server_cli:main"

[project.urls]
Documentation = "https://highlighter-docs.netlify.app/"

[tool.hatch]
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.isort]
profile = "black"
skip = ["./venv", "./src/highlighter/templates"]

[tool.black]
line-length = 110
target-version = ['py310']
exclude = '''
(
    /src/highlighter/templates/.*
  | /venv/.*
)
'''

# https://hatch.pypa.io/latest/config/build/#build-targets
[tool.hatch.build.targets.wheel]
packages = ["src/highlighter", "src/aiko_services"]
exclude = [
  "dist/",
  "venv/",
  "hl/",
  "docs/",
  "src/aiko_services/archive",
  "src/aiko_services/elements/media/data",
  "src/aiko_services/examples"
]

[tool.hatch.build.targets.sdist]
packages = ["src/highlighter", "src/aiko_services"]
exclude = [
  "dist/",
  "venv/",
  "hl/",
  "docs/",
  "src/aiko_services/archive",
  "src/aiko_services/elements/media/data",
  "src/aiko_services/examples"
]

[tool.hatch.build.targets.sdist.hooks.custom]
path = "check_aiko_is_vendored.py"

[tool.pytest.ini_options]
# Pytest configuration for Highlighter SDK

# Pytest options
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]

# Log capturing configuration
# - Capture logs at WARNING level and above for display on test failures
# - Show captured logs automatically when tests fail (log_cli_level not set, relying on caplog)
# - For live logging during test runs, use: HL_LOG_LEVEL=ERROR pytest -s
log_cli = false
log_level = "WARNING"  # Capture WARNING+ logs from all sources for display on failures
log_cli_level = "CRITICAL"  # Don't show logs during test run unless HL_LOG_LEVEL is set

# Note: Logging display is configured via conftest.py's pytest_configure() hook
# which respects the HL_LOG_LEVEL environment variable.
#
# Examples:
#   pytest                      # Clean output, logs shown only on failures
#   HL_LOG_LEVEL=ERROR pytest   # Show ERROR+ logs during test execution
#   HL_LOG_LEVEL=INFO pytest    # Show INFO+ logs during test execution

# Disable warnings for cleaner output
filterwarnings = [
    "ignore::DeprecationWarning",
]
