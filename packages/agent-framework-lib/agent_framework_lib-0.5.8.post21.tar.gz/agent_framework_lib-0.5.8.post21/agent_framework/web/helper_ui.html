<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Framework Helper Agent</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    
    <!-- Code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    
    <!-- Mermaid for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        
        .message-user {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
            align-self: flex-end;
            margin-left: auto;
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            border-bottom-right-radius: 0.25rem;
            margin-bottom: 0.75rem;
        }
        
        .message-assistant {
            background-color: #ffffff;
            color: #1e293b;
            border: 1px solid #e2e8f0;
            align-self: flex-start;
            margin-right: auto;
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .message-content pre {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 1rem;
            overflow-x: auto;
            margin: 0.5rem 0;
            position: relative;
        }
        
        .message-content code {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 0.875em;
        }
        
        .message-content pre code {
            background-color: transparent;
            padding: 0;
        }
        
        .message-content p code {
            background-color: #f1f5f9;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
        }
        
        .message-content h1, .message-content h2, .message-content h3 {
            font-weight: 600;
            margin: 1rem 0 0.5rem 0;
        }
        
        .message-content ul, .message-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .message-content ul { list-style-type: disc; }
        .message-content ol { list-style-type: decimal; }
        
        /* Copy button styles */
        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            background-color: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            color: #64748b;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .copy-button:hover {
            opacity: 1;
            background-color: #e2e8f0;
        }

        .warning-banner {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Sidebar styles */
        .sidebar {
            width: 280px;
            min-width: 280px;
            transition: transform 0.3s ease;
        }
        
        .sidebar-collapsed {
            transform: translateX(-100%);
            width: 0;
            min-width: 0;
            overflow: hidden;
        }
        
        .session-item {
            cursor: pointer;
            transition: background-color 0.15s ease;
            position: relative;
        }
        
        .session-item:hover {
            background-color: #f1f5f9;
        }
        
        .session-item.active {
            background-color: #dbeafe;
            border-left: 3px solid #3b82f6;
        }
        
        .session-item .delete-btn {
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        
        .session-item:hover .delete-btn {
            opacity: 1;
        }
        
        /* Tool activity indicator */
        .tool-indicator {
            background-color: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            margin: 0.5rem 0;
            font-size: 0.875rem;
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tool-indicator .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid #fcd34d;
            border-top-color: #f59e0b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Mermaid container styles */
        .mermaid-container {
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.75rem 0;
            max-width: 100%;
            overflow-x: auto;
        }
        
        .mermaid svg {
            max-width: 100%;
            height: auto;
        }
        
        /* Chart.js container styles */
        .chartjs-container {
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.75rem 0;
            position: relative;
        }
    </style>
</head>
<body class="h-full bg-gray-50" x-data="helperApp()" x-init="init()">
    <div class="h-full flex">
        <!-- Session Sidebar -->
        <aside class="sidebar bg-white border-r border-gray-200 flex flex-col h-full" 
               :class="{ 'sidebar-collapsed': !sidebarOpen }">
            <!-- Sidebar Header -->
            <div class="p-4 border-b border-gray-200">
                <button @click="newChat()" 
                        class="w-full px-4 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    New Chat
                </button>
            </div>
            
            <!-- Sessions List -->
            <div class="flex-1 overflow-y-auto">
                <div class="p-2">
                    <h3 class="px-2 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider">Previous Sessions</h3>
                    
                    <!-- Loading state -->
                    <div x-show="loadingSessions" class="px-2 py-4 text-center">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mx-auto"></div>
                        <span class="text-xs text-gray-500 mt-2 block">Loading sessions...</span>
                    </div>
                    
                    <!-- Empty state -->
                    <div x-show="!loadingSessions && sessions.length === 0" class="px-2 py-4 text-center text-sm text-gray-500">
                        No previous sessions
                    </div>
                    
                    <!-- Sessions list -->
                    <div x-show="!loadingSessions && sessions.length > 0" class="space-y-1 mt-2">
                        <template x-for="session in sessions" :key="session.session_id">
                            <div class="session-item px-3 py-2 rounded-md flex items-center justify-between group"
                                 :class="{ 'active': currentSessionId === session.session_id }">
                                <div @click="loadSession(session.session_id)" class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-gray-900 truncate" 
                                         x-text="session.session_label || 'Untitled Session'"></div>
                                    <div class="text-xs text-gray-500 mt-0.5" 
                                         x-text="formatDate(session.updated_at || session.created_at)"></div>
                                </div>
                                <button @click.stop="deleteSession(session.session_id)" 
                                        class="delete-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors"
                                        title="Delete session">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar Footer -->
            <div class="p-3 border-t border-gray-200 text-xs text-gray-500 text-center">
                <span x-text="sessions.length"></span> session(s)
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <!-- Sidebar Toggle -->
                        <button @click="sidebarOpen = !sidebarOpen" 
                                class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900">Framework Helper Agent</h1>
                            <p class="text-sm text-gray-500">Expert assistance for Agent Framework development</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <a href="/ui" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Back to Main UI
                        </a>
                    </div>
                </div>
            </header>
            
            <!-- Warnings Banner -->
            <div x-show="warnings.length > 0" x-cloak class="px-6 py-2 bg-amber-50">
                <template x-for="warning in warnings" :key="warning">
                    <div class="warning-banner text-sm text-amber-800" x-text="warning"></div>
                </template>
            </div>
            
            <!-- Loading Indicator -->
            <div x-show="!loaded" x-cloak class="px-6 py-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center gap-3">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                    <span class="text-blue-800">Initializing Framework Helper Agent<span class="loading-dots"></span></span>
                </div>
            </div>

            <!-- Chat Container -->
            <main class="flex-1 overflow-hidden px-6 py-4">
                <div class="h-full flex flex-col max-w-4xl mx-auto">
                    <!-- Messages -->
                    <div class="flex-1 overflow-y-auto space-y-4 pb-4" id="messages-container" 
                         @scroll="handleScroll($event)">
                        <!-- Welcome Message -->
                        <div x-show="messages.length === 0" class="text-center py-12">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                                </svg>
                            </div>
                            <h2 class="text-xl font-semibold text-gray-900 mb-2">Welcome to Framework Helper</h2>
                            <p class="text-gray-600 mb-6 max-w-md mx-auto">
                                I'm here to help you create agents using the Agent Framework library. 
                                Ask me anything about agent creation, tools, memory, or best practices.
                            </p>
                            <div class="flex flex-wrap justify-center gap-2">
                                <button @click="sendSuggestion('How do I create a simple agent?')" 
                                        class="px-4 py-2 bg-white border border-gray-300 rounded-full text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                    How do I create a simple agent?
                                </button>
                                <button @click="sendSuggestion('What tools can I add to my agent?')"
                                        class="px-4 py-2 bg-white border border-gray-300 rounded-full text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                    What tools can I add?
                                </button>
                                <button @click="sendSuggestion('How do I add memory to my agent?')"
                                        class="px-4 py-2 bg-white border border-gray-300 rounded-full text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                    How do I add memory?
                                </button>
                            </div>
                        </div>
                        
                        <!-- Message List -->
                        <template x-for="(msg, index) in messages" :key="index">
                            <div>
                                <!-- Tool Activity Indicator -->
                                <div x-show="msg.toolActivity" class="tool-indicator fade-in">
                                    <div class="spinner"></div>
                                    <span x-text="msg.toolActivity"></span>
                                </div>
                                <!-- Message Content -->
                                <div x-show="msg.content" 
                                     :class="msg.role === 'user' ? 'message-user' : 'message-assistant'" 
                                     class="fade-in"
                                     :id="'message-' + index">
                                    <div class="message-content" x-html="formatMessageContent(msg.content, index)"></div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Active Tool Indicator (during streaming) -->
                        <div x-show="activeTool" x-cloak class="tool-indicator">
                            <div class="spinner"></div>
                            <span x-text="'Using tool: ' + activeTool"></span>
                        </div>
                        
                        <!-- Typing Indicator -->
                        <div x-show="isTyping && !activeTool" x-cloak class="message-assistant">
                            <div class="flex items-center gap-2">
                                <div class="flex gap-1">
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                                </div>
                                <span class="text-sm text-gray-500">Thinking...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Input Area -->
            <footer class="bg-white border-t border-gray-200 px-6 py-4">
                <div class="max-w-4xl mx-auto">
                    <form @submit.prevent="sendMessage()" class="flex gap-3">
                        <input 
                            type="text"
                            x-model="inputMessage"
                            :disabled="isTyping || !loaded"
                            placeholder="Ask about creating agents, tools, memory, or best practices..."
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
                        >
                        <button 
                            type="submit"
                            :disabled="!inputMessage.trim() || isTyping || !loaded"
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                        >
                            <span x-show="!isTyping">Send</span>
                            <span x-show="isTyping" class="flex items-center gap-2">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                            </span>
                        </button>
                    </form>
                    <p class="text-xs text-gray-500 mt-2 text-center">
                        Indexed <span x-text="indexedFiles"></span> framework files • 
                        <a href="/documentation" class="text-blue-600 hover:underline">View Documentation</a>
                    </p>
                </div>
            </footer>
        </div>
    </div>

    <script>
        // Initialize Mermaid
        if (typeof mermaid !== 'undefined') {
            mermaid.initialize({ 
                startOnLoad: false, 
                theme: 'default',
                securityLevel: 'loose'
            });
        }
        
        // Configure marked for markdown rendering
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });
        
        function helperApp() {
            return {
                loaded: false,
                warnings: [],
                indexedFiles: 0,
                messages: [],
                inputMessage: '',
                isTyping: false,
                currentSessionId: null,
                userId: 'default_user',
                
                // Sidebar state
                sidebarOpen: true,
                sessions: [],
                loadingSessions: false,
                
                // Streaming state
                activeTool: null,
                autoScroll: true,
                lastScrollTop: 0,
                streamingCompleteText: '',
                
                async init() {
                    await this.checkStatus();
                    await this.loadSessions();
                    this.currentSessionId = this.generateUUID();
                },
                
                async checkStatus() {
                    try {
                        const response = await fetch('/helper/status');
                        const data = await response.json();
                        
                        this.warnings = data.warnings || [];
                        this.indexedFiles = data.indexed_files || 0;
                        this.loaded = true;
                    } catch (error) {
                        console.error('Failed to check helper status:', error);
                        this.loaded = true;
                        this.warnings = ['⚠️ Could not verify helper agent status'];
                    }
                },

                async loadSessions() {
                    this.loadingSessions = true;
                    try {
                        const response = await fetch(`/helper/sessions?user_id=${encodeURIComponent(this.userId)}`);
                        if (response.ok) {
                            const data = await response.json();
                            this.sessions = data.sort((a, b) => {
                                const dateA = new Date(a.updated_at || a.created_at || 0);
                                const dateB = new Date(b.updated_at || b.created_at || 0);
                                return dateB - dateA;
                            });
                        }
                    } catch (error) {
                        console.error('Failed to load sessions:', error);
                    } finally {
                        this.loadingSessions = false;
                    }
                },
                
                async loadSession(sessionId) {
                    if (this.isTyping) return;
                    
                    try {
                        const response = await fetch(
                            `/helper/sessions/${sessionId}/history?user_id=${encodeURIComponent(this.userId)}`
                        );
                        
                        if (response.ok) {
                            const history = await response.json();
                            this.messages = history.map(msg => ({
                                role: msg.role,
                                content: msg.response_text_main || msg.text_content || ''
                            }));
                            this.currentSessionId = sessionId;
                            this.streamingCompleteText = '';
                            this.scrollToBottom();
                            // Render mermaid and charts after loading
                            this.$nextTick(() => {
                                setTimeout(() => this.renderDeferredContent(), 100);
                            });
                        } else {
                            console.error('Failed to load session history');
                        }
                    } catch (error) {
                        console.error('Failed to load session:', error);
                    }
                },
                
                async deleteSession(sessionId) {
                    if (!confirm('Are you sure you want to delete this session?')) return;
                    
                    try {
                        const response = await fetch(
                            `/helper/sessions/${sessionId}?user_id=${encodeURIComponent(this.userId)}`,
                            { method: 'DELETE' }
                        );
                        
                        if (response.ok) {
                            // Remove from local list
                            this.sessions = this.sessions.filter(s => s.session_id !== sessionId);
                            // If deleted current session, start new chat
                            if (this.currentSessionId === sessionId) {
                                this.newChat();
                            }
                        } else {
                            console.error('Failed to delete session');
                            alert('Failed to delete session');
                        }
                    } catch (error) {
                        console.error('Failed to delete session:', error);
                        alert('Failed to delete session');
                    }
                },
                
                newChat() {
                    this.messages = [];
                    this.currentSessionId = this.generateUUID();
                    this.activeTool = null;
                    this.streamingCompleteText = '';
                },

                async sendMessage() {
                    if (!this.inputMessage.trim() || this.isTyping) return;
                    
                    const userMessage = this.inputMessage.trim();
                    this.inputMessage = '';
                    
                    this.messages.push({
                        role: 'user',
                        content: userMessage
                    });
                    
                    this.autoScroll = true;
                    this.scrollToBottom();
                    this.isTyping = true;
                    this.activeTool = null;
                    this.streamingCompleteText = '';
                    
                    // Add session to sidebar immediately when user sends first message
                    const isNewSession = !this.sessions.find(s => s.session_id === this.currentSessionId);
                    if (isNewSession) {
                        this.sessions.unshift({
                            session_id: this.currentSessionId,
                            session_label: userMessage.substring(0, 50) + (userMessage.length > 50 ? '...' : ''),
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                    }
                    
                    try {
                        const response = await fetch(`/helper/stream?user_id=${encodeURIComponent(this.userId)}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,
                                session_id: this.currentSessionId
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const assistantMessageIndex = this.messages.length;
                        this.messages.push({
                            role: 'assistant',
                            content: ''
                        });
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';
                        
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    this.processStreamEvent(line.slice(6), assistantMessageIndex);
                                }
                            }
                        }
                        
                        if (buffer.startsWith('data: ')) {
                            this.processStreamEvent(buffer.slice(6), assistantMessageIndex);
                        }
                        
                    } catch (error) {
                        console.error('Failed to send message:', error);
                        this.messages.push({
                            role: 'assistant',
                            content: `❌ Error: ${error.message}. Please try again.`
                        });
                    } finally {
                        this.isTyping = false;
                        this.activeTool = null;
                        this.scrollToBottom();
                        // Reload sessions to get updated labels
                        await this.loadSessions();
                        // Render deferred content (mermaid, charts)
                        this.$nextTick(() => {
                            setTimeout(() => this.renderDeferredContent(), 100);
                        });
                    }
                },

                processStreamEvent(data, assistantMessageIndex) {
                    try {
                        const event = JSON.parse(data);
                        
                        if (event.status === 'done') {
                            if (event.session_id) {
                                this.currentSessionId = event.session_id;
                            }
                            this.activeTool = null;
                            return;
                        }
                        
                        if (event.error) {
                            this.messages[assistantMessageIndex].content = `❌ Error: ${event.error}`;
                            return;
                        }
                        
                        if (event.parts && Array.isArray(event.parts)) {
                            const hasFinalContent = event.response_text && event.response_text.length > 0;
                            
                            if (hasFinalContent) {
                                this.messages[assistantMessageIndex].content = event.response_text;
                                if (this.autoScroll) this.scrollToBottom();
                            } else {
                                for (const part of event.parts) {
                                    if (part.type === 'text_output_stream' && part.text) {
                                        const text = part.text;
                                        
                                        if (text.startsWith('__STREAM_CHUNK__')) {
                                            const chunk = text.substring(16);
                                            this.streamingCompleteText += chunk;
                                            this.messages[assistantMessageIndex].content = this.streamingCompleteText;
                                            if (this.autoScroll) this.scrollToBottom();
                                        }
                                        else if (text.startsWith('__STREAM_ACTIVITY__')) {
                                            try {
                                                const activityJson = text.substring(19);
                                                const activity = JSON.parse(activityJson);
                                                if (activity.type === 'tool_request') {
                                                    const toolName = activity.tools?.[0]?.name || 'tool';
                                                    this.activeTool = toolName;
                                                } else if (activity.type === 'tool_result') {
                                                    this.activeTool = null;
                                                }
                                            } catch (e) { /* ignore */ }
                                        }
                                        else {
                                            this.streamingCompleteText += text;
                                            this.messages[assistantMessageIndex].content = this.streamingCompleteText;
                                            if (this.autoScroll) this.scrollToBottom();
                                        }
                                    }
                                }
                            }
                        }
                        else if (event.response_text && event.response_text.length > 0) {
                            this.messages[assistantMessageIndex].content = event.response_text;
                            if (this.autoScroll) this.scrollToBottom();
                        }
                        
                    } catch (e) {
                        if (e.message && !e.message.includes('JSON')) {
                            console.error('Stream event error:', e);
                        }
                    }
                },

                // Format message content with copy buttons, mermaid, and charts
                formatMessageContent(content, messageIndex) {
                    if (!content) return '';
                    
                    // Parse markdown
                    let html = marked.parse(content);
                    
                    // Create temp container to manipulate DOM
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    // Process code blocks - add copy buttons and handle special languages
                    const codeBlocks = tempDiv.querySelectorAll('pre > code');
                    codeBlocks.forEach((codeBlock, index) => {
                        const preElement = codeBlock.parentNode;
                        if (!preElement || preElement.tagName !== 'PRE') return;
                        
                        const originalCode = codeBlock.textContent;
                        const language = codeBlock.className.replace('language-', '');
                        
                        // Handle mermaid code blocks
                        if (codeBlock.classList.contains('language-mermaid')) {
                            const mermaidContainer = document.createElement('div');
                            mermaidContainer.className = 'mermaid-container';
                            mermaidContainer.setAttribute('data-needs-mermaid', 'true');
                            
                            const mermaidDiv = document.createElement('div');
                            mermaidDiv.className = 'mermaid';
                            mermaidDiv.id = `mermaid-${messageIndex}-${index}-${Date.now()}`;
                            mermaidDiv.textContent = originalCode;
                            mermaidContainer.appendChild(mermaidDiv);
                            
                            preElement.replaceWith(mermaidContainer);
                            return;
                        }
                        
                        // Handle chart code blocks
                        if (codeBlock.classList.contains('language-chart')) {
                            try {
                                const chartJson = JSON.parse(originalCode);
                                if (chartJson && chartJson.type === 'chartjs' && chartJson.chartConfig) {
                                    const chartContainer = document.createElement('div');
                                    chartContainer.className = 'chartjs-container';
                                    chartContainer.style.width = '100%';
                                    chartContainer.style.height = '400px';
                                    chartContainer.setAttribute('data-needs-chart', 'true');
                                    chartContainer.setAttribute('data-chart-config', JSON.stringify(chartJson.chartConfig));
                                    
                                    const canvasId = `chart-${messageIndex}-${index}-${Date.now()}`;
                                    const canvas = document.createElement('canvas');
                                    canvas.id = canvasId;
                                    chartContainer.setAttribute('data-canvas-id', canvasId);
                                    chartContainer.appendChild(canvas);
                                    
                                    preElement.replaceWith(chartContainer);
                                    return;
                                }
                            } catch (e) {
                                console.error('Error parsing chart JSON:', e);
                            }
                        }
                        
                        // Add copy button to regular code blocks
                        preElement.style.position = 'relative';
                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'copy-button';
                        copyBtn.textContent = 'Copy';
                        copyBtn.setAttribute('onclick', `window.helperCopyCode(this, \`${originalCode.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)`);
                        preElement.appendChild(copyBtn);
                    });
                    
                    // Sanitize and return
                    return DOMPurify.sanitize(tempDiv.innerHTML, {
                        ADD_ATTR: ['onclick', 'id', 'data-needs-mermaid', 'data-needs-chart', 'data-chart-config', 'data-canvas-id'],
                        ADD_TAGS: ['button', 'canvas']
                    });
                },
                
                // Render deferred content (mermaid diagrams and charts)
                async renderDeferredContent() {
                    const container = document.getElementById('messages-container');
                    if (!container) return;
                    
                    // Render Mermaid diagrams
                    if (typeof mermaid !== 'undefined') {
                        const mermaidDivs = container.querySelectorAll('.mermaid:not([data-processed])');
                        if (mermaidDivs.length > 0) {
                            try {
                                await mermaid.run({ nodes: mermaidDivs });
                                mermaidDivs.forEach(div => div.setAttribute('data-processed', 'true'));
                            } catch (e) {
                                console.error('Mermaid rendering error:', e);
                            }
                        }
                    }
                    
                    // Render Chart.js charts
                    if (typeof Chart !== 'undefined') {
                        const chartContainers = container.querySelectorAll('[data-needs-chart]:not([data-chart-rendered])');
                        chartContainers.forEach(chartContainer => {
                            try {
                                const configStr = chartContainer.getAttribute('data-chart-config');
                                const canvasId = chartContainer.getAttribute('data-canvas-id');
                                const canvas = document.getElementById(canvasId);
                                
                                if (configStr && canvas) {
                                    const config = JSON.parse(configStr);
                                    config.options = config.options || {};
                                    config.options.responsive = true;
                                    config.options.maintainAspectRatio = false;
                                    
                                    new Chart(canvas, config);
                                    chartContainer.setAttribute('data-chart-rendered', 'true');
                                }
                            } catch (e) {
                                console.error('Chart rendering error:', e);
                            }
                        });
                    }
                },
                
                handleScroll(event) {
                    const container = event.target;
                    const isAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 50;
                    
                    if (container.scrollTop < this.lastScrollTop && !isAtBottom) {
                        this.autoScroll = false;
                    } else if (isAtBottom) {
                        this.autoScroll = true;
                    }
                    
                    this.lastScrollTop = container.scrollTop;
                },
                
                sendSuggestion(text) {
                    this.inputMessage = text;
                    this.sendMessage();
                },

                scrollToBottom() {
                    this.$nextTick(() => {
                        const container = document.getElementById('messages-container');
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });
                },
                
                formatDate(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins}m ago`;
                    if (diffHours < 24) return `${diffHours}h ago`;
                    if (diffDays < 7) return `${diffDays}d ago`;
                    
                    return date.toLocaleDateString();
                },
                
                generateUUID() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }
            };
        }
        
        // Global copy function for code blocks
        window.helperCopyCode = async function(button, text) {
            try {
                await navigator.clipboard.writeText(text);
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = 'Copy'; }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                button.textContent = 'Error!';
                setTimeout(() => { button.textContent = 'Copy'; }, 2000);
            }
        };
    </script>
</body>
</html>
