name: release
on:
  release:
    types:
      - published

permissions:
  contents: read  # Read access at workflow level

jobs:
  build_package:
    name: Build and publish package
    runs-on: ubuntu-latest
    environment: pypi-release
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Extract version from tag
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      - name: Update pyproject.toml version
        run: | 
          sed -i "s/^version = .*/version = \"${VERSION}\"/" pyproject.toml

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade hatch
          hatch --version

      - name: Build package
        run: hatch build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
          if-no-files-found: error
          retention-days: 1  # Artifact to be deleted after 1 day

  publish_release_to_pypi:
    name: Publish release to PyPI
    needs: [ build_package ]
    runs-on: ubuntu-latest
    environment:
      name: pypi-release
      url: https://pypi.org/project/clover-synth/
    permissions:
      contents: read  # Needs read access
      id-token: write  # Needs to be able to write the publishing token
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

#  publish_release_to_pypitest:
#    name: Publish release to PyPI Test
#    needs: [ build_package ]
#    runs-on: ubuntu-latest
#    environment:
#      name: pypi-release
#      url: https://test.pypi.org/project/clover-synth/
#    permissions:
#      contents: read  # Needs read access
#      id-token: write  # Needs to be able to write the publishing token
#    steps:
#      - name: Download artifacts
#        uses: actions/download-artifact@v4
#        with:
#          name: python-package-distributions
#          path: dist/
#
#      - name: Publish to PyPI Test
#        uses: pypa/gh-action-pypi-publish@release/v1
#        with:
#          repository-url: https://test.pypi.org/legacy/