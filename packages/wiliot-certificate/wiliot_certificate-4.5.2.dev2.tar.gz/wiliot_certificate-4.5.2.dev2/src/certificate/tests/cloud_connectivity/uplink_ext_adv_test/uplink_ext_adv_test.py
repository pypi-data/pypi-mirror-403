# This test verifies that the gateway correctly handles extended advertising packets
# where a 31-byte payload is expanded to 31*7 bytes (217 bytes) containing the same payload repeated 7 times
from certificate.cert_prints import *
from certificate.cert_defines import *
from certificate.wlt_types import *
import certificate.cert_common as cert_common
import certificate.cert_mqtt as cert_mqtt
import certificate.cert_config as cert_config
import certificate.cert_data_sim as cert_data_sim
from certificate.cert_gw_sim import GW_CERT_TESTER

# DEFINES
EXT_ADV_TEST_INDICATOR = get_random_hex_str(6)
EXPECTED_REPEAT_COUNT = 7


def ext_adv_analysis(test, pkts):
    """
    Analyze received packets to verify extended advertising scanning:
    - Each 31-byte payload should be expanded to 217 bytes (31*7) (aggregated packet generated by the TESTER FW)
    - The aggregated payload should contain the same 31-byte payload repeated 7 times
    """
    phase_run_print("Extended Advertising Analysis")

    # Create list of expected expanded payloads (each payload repeated 7 times)
    expected_payloads = [pkt.get_pkt()[12:] * EXPECTED_REPEAT_COUNT for pkt in pkts]

    # Get received aggregated packets from MQTT
    received_pkts_mqtt = cert_mqtt.get_all_aggregated_data_pkts(test.get_mqttc_by_target(DUT), indicator=EXT_ADV_TEST_INDICATOR)

    if len(received_pkts_mqtt) == 0:
        test.rc = TEST_FAILED
        test.reason = "No packets were received from the gateway, make sure the gateway is able to receive aggregated \
        packets with 7 31-byte payloads"
        return test

    # Count how many expected payloads were received
    received_payloads = {pkt[AGGREGATED_PAYLOAD] for pkt in received_pkts_mqtt}
    received_count = sum(expected_payload in received_payloads for expected_payload in expected_payloads)
    expected_count = len(expected_payloads)

    wlt_print(f'Expected payloads: {expected_count}, Received matching payloads: {received_count}')

    if received_count < expected_count * 0.8:
        test.rc = TEST_FAILED
        wlt_print(f"Insufficient packets received: {received_count}/{expected_count} (expected at least 80%)")
        test.reason = f"Insufficient packets received: {received_count}/{expected_count} (expected at least 80%)"
    else:
        test.rc = TEST_PASSED
        wlt_print(f"Extended advertising validation passed: {received_count}/{expected_count} packets received")
        test.reason = f"Extended advertising validation passed: {received_count}/{expected_count} packets received"
    return test


def run(test):
    datapath_module = test.tester.internal_brg.datapath
    test = cert_common.test_prolog(test)
    if test.rc == TEST_FAILED:
        return cert_common.test_epilog(test)

    wlt_print("Setting GW CERT TESTER to enable, to allow the TESTER transmit extended advertising packets", "GREEN")
    cert_config.gw_action(test, f"{GW_CERT_TESTER} 1", target=TESTER)

    # Configure the tester to transmit in extended advertising
    wlt_print('Configuring TESTER to transmit in extended advertising', "GREEN")
    test = cert_config.brg_configure(test, fields=[BRG_PATTERN], values=[ag.DATAPATH_PATTERN_EXTENDED_ADV],
                                     module=datapath_module, target=TESTER)[0]
    time.sleep(1)

    phase_run_print("Extended Advertising Gateway Scan Test")
    test.flush_all_mqtt_packets()

    # Generate packets with pixel header
    # Each packet will have a 31-byte payload, the FW expands it to aggregated packet with 7 packets with the same payload
    pkts, bridge_ids = cert_data_sim.brg_pkt_gen(num_of_pkts_per_brg=100, num_of_brgs=1, pkt_type=PIXELS_PKT,
                                                 indicator=EXT_ADV_TEST_INDICATOR)

    # Temporary partner patch: send simulated HB packets before traffic.
    cert_data_sim.send_hb_before_sim(test, bridge_ids)

    # Send packets using GenericSimThread
    sim_thread = cert_data_sim.GenericSimThread(test=test, pkts=pkts, send_single_cycle=True)
    sim_thread.start()

    # Wait for packets to be scanned and uploaded
    mqtt_scan_wait(test, 20)

    # Analyze the results
    test = ext_adv_analysis(test, pkts)

    test = cert_config.config_brg_defaults(test, modules=[datapath_module], target=TESTER)[0]
    field_functionality_pass_fail_print(test, "Extended advertising scanning")
    cert_config.gw_action(test, f"{GW_CERT_TESTER} 0", target=TESTER)
    return cert_common.test_epilog(test)
