# Building Afterpaths: AI Session Analysis Tool with Git Integration

**Date:** 2026-01-10 | **Duration:** 2h 4m
**Files:** 13 files modified
**Git refs:** None detected

## Summary
Built "Afterpaths" - a tool to extract, analyze and summarize AI coding sessions from Claude Code. Started with session listing/viewing, added git ref extraction and commit tracing via diff matching, then implemented LLM-powered summarization with provider-agnostic architecture. Extended with file modification tracking, repo-scoped git ref filtering, and protective flags for summary management.

## Discoveries
- **Claude Code session format differs from spec**: Directory names use hyphen-separated paths (`-Users-burnssa-Code-afterpaths`), not base64 encoding as documented
- **Tool results are embedded**: Tool responses appear as `tool_result` content blocks within `user` entries, not as separate entry types
- **Agent vs main sessions pattern**: Sessions starting with `agent-` are sub-processes spawned by Task tool, typically 1-2KB vs main sessions of 100KB+
- **Time filtering complexity**: Session file modification time != session activity time - needed 1-day buffer after commit to catch active sessions
- **Path decoding ambiguity**: Hyphens in directory names make decoding tricky - added fallback verification against actual filesystem paths
- **Caching provides 4x speedup**: File modification extraction went from 0.277s to 0.065s with JSON caching
- **Git ref false positives from tool output**: Command outputs like `afterpaths link` results were being parsed as legitimate git refs - needed to filter against actual repo existence
- **Sessions can have built-in summaries**: Claude Code itself generates `summary` fields for some sessions, stored directly in the JSONL file

## Dead Ends
- **Base64 path decoding approach** - Original spec assumed base64 encoding, but actual format uses simple hyphen replacement (discovered after implementing decoder)
- **30-day commit search window** - Too broad, most commits happen within days of session, reduced to 7 days default
- **Exact content matching for commits** - Initially planned fuzzy diff matching, but file-path-based matching proved sufficient and much simpler
- **Git ref extraction from all text** - Initially parsed all session content for refs, but this captured false positives from discussions about other repos and from afterpaths' own output

## Decisions
- **Session type filtering by default** - Show only main sessions in `log` command since agent sessions are usually noise, but allow `--type=all` for full view
- **Provider-agnostic LLM architecture** - Built abstraction layer supporting Anthropic, OpenAI, and OpenAI-compatible APIs rather than hardcoding Anthropic
- **Caching at file-activity level** - Cache extracted file modifications per session rather than raw parsing, provides good speedup without excessive storage
- **7-day commit trace window** - Reasonable default covering weekend delays while avoiding false positives from old sessions
- **Repo-scoped git ref filtering** - Filter detected refs against current git repo using `git branch -a` and `git rev-parse --verify` to eliminate false positives from other projects
- **Summary overwrite protection** - Require `--force` to overwrite existing summaries, `--update` to refine them with LLM
- **Extract refs from git commands only** - Changed from parsing all text to only extracting from actual Bash tool inputs containing git commands, reducing false positives

## Gotchas & Warnings
- **Session numbering consistency** - `show` command must use same type filtering as `log` so session numbers match between commands
- **Git ref false positives** - Documentation text can contain words like "branch" and "commit" - needed context-aware regex filtering
- **Time zone handling** - Commit times and session times may be in different zones, using 1-day buffer to handle edge cases
- **Large session files** - Some sessions are 30MB+ (especially hex-line-assignment), parsing can be slow without caching
- **Cross-repo git ref pollution** - Sessions discussing multiple repos can show refs from other projects unless filtered by current repo
- **Model version defaults** - Initial config used `claude-sonnet-4-20250514` instead of correct `claude-sonnet-4-5-20250929`; Opus 4.5 is `claude-opus-4-5-20251101`
- **Renamed directories** - Sessions may reference paths that no longer exist (e.g., `hex-line-assignment` renamed to `hex_line_assignment`) - fallback decoding handles this gracefully

## Open Questions
- **Content-based commit matching** - Current approach matches by files modified, but doesn't verify actual content similarity - would fuzzy diff matching catch more cases?
- **Session activity time extraction** - Could parse session timestamps more precisely rather than using file modification time?
- **Cross-session linking** - Sessions sometimes reference other sessions or continue work - worth extracting these connections?
- **Summary quality evaluation** - How to measure if generated summaries are actually useful for future work?
- **Git ref scope balance** - Current repo-only filtering prevents false positives but might miss legitimate cross-repo references

---
*Generated by anthropic/claude-opus-4-5-20251101 | Tokens: 27721 in, 1196 out*