# =============================================================================
# WORKFLOW: Build and Publish to PyPI and MCP Registry
# =============================================================================
#
# TRIGGER: Push to master branch when pyproject.toml changes, or manual dispatch
#          (relevant fields: publish_on_pypi and version - see steps 1. & 2.)
#
# WHAT IT DOES:
#   1. Checks if publish_on_pypi is set to true in pyproject.toml
#   2. Compares version in pyproject.toml against latest PyPI version
#   3. Builds and publishes to PyPI (if version is greater)
#   4. Waits for PyPI propagation (90s + retry loop with verification)
#   5. Updates server.json with the new version (transiently, not committed)
#   6. Publishes to MCP Registry (with retry logic)
#   7. Logs workflow result (always runs)
#
# REQUIREMENTS:
#   - GitHub environment "pypi-release-of-the-master-branch" configured
#   - PyPI trusted publisher configured for this repo
#   - MCP Registry namespace ownership (io.github.PCfVW/)
#
# KEY FILES:
#   - pyproject.toml: source of version and publish_on_pypi flag
#   - server.json: MCP registry manifest (version updated transiently for publish, kept at 0.0.0 in repo)
#   - README.md: must contain "mcp-name: io.github.PCfVW/mcp-arangodb-async"
#
# =============================================================================

name: Build and Publish to PyPI and MCP Registry

on:
  push:
    branches:
      - master
    paths:
      - 'pyproject.toml'
  workflow_dispatch:

jobs:
  check-and-publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    environment: pypi-release-of-the-master-branch
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: python -m pip install --upgrade pip build packaging requests toml

      # Step 1. Checks if publish_on_pypi is set to true in pyproject.toml
      - name: Check publish flag
        id: publish_flag
        run: |
          publish_flag=$(python -c "
          import toml
          import sys

          try:
              with open('pyproject.toml', 'r') as f:
                  data = toml.load(f)

              if 'project' not in data:
                  print('Error: [project] section not found in pyproject.toml', file=sys.stderr)
                  sys.exit(1)

              if 'publish_on_pypi' not in data['project']:
                  print('publish_on_pypi field not found, defaulting to false', file=sys.stderr)
                  print('false')
                  sys.exit(0)

              publish = str(data['project']['publish_on_pypi']).lower()
              if publish not in ['true', 'false']:
                  print(f'Error: publish_on_pypi must be true or false, got {publish}', file=sys.stderr)
                  print('false')
                  sys.exit(0)
              
              print(f'Found publish flag: {publish}', file=sys.stderr)
              print(publish)
          except FileNotFoundError:
              print('Error: pyproject.toml file not found', file=sys.stderr)
              print('false')
              sys.exit(0)
          except toml.TomlDecodeError as e:
              print(f'Error: Failed to parse pyproject.toml: {e}', file=sys.stderr)
              print('false')
              sys.exit(0)
          except Exception as e:
              print(f'Error reading publish flag: {e}', file=sys.stderr)
              print('false')
              sys.exit(0)
          ")
          echo "flag=$publish_flag" >> $GITHUB_OUTPUT
          echo "Publish flag is set to: $publish_flag"

      # Step 2. Compares version in pyproject.toml against latest PyPI version
      - name: Get current version from pyproject.toml
        id: current_version
        if: steps.publish_flag.outputs.flag == 'true'
        run: |
          current_version=$(python -c "
          import toml
          import sys

          try:
              with open('pyproject.toml', 'r') as f:
                  data = toml.load(f)

              if 'project' not in data:
                  print('Error: [project] section not found in pyproject.toml', file=sys.stderr)
                  sys.exit(1)

              if 'version' not in data['project']:
                  print('Error: version field not found in [project] section of pyproject.toml', file=sys.stderr)
                  sys.exit(1)

              version = data['project']['version']
              if not version or not isinstance(version, str):
                  print('Error: version field is empty or not a string', file=sys.stderr)
                  sys.exit(1)

              print(version)
          except FileNotFoundError:
              print('Error: pyproject.toml file not found', file=sys.stderr)
              sys.exit(1)
          except toml.TomlDecodeError as e:
              print(f'Error: Failed to parse pyproject.toml: {e}', file=sys.stderr)
              sys.exit(1)
          except Exception as e:
              print(f'Error: Unexpected error reading version: {e}', file=sys.stderr)
              sys.exit(1)
          ")
          echo "version=$current_version" >> $GITHUB_OUTPUT

      - name: Get latest published version from PyPI
        id: pypi_version
        if: steps.publish_flag.outputs.flag == 'true'
        run: |
          pypi_version=$(python -c "
          import json
          import requests
          import sys
          from packaging import version

          package_name = 'mcp-arangodb-async'
          pypi_url = f'https://pypi.org/pypi/{package_name}/json'

          try:
              print(f'Checking PyPI for package: {package_name}', file=sys.stderr)
              response = requests.get(pypi_url, timeout=30)

              if response.status_code == 404:
                  print('Package not found on PyPI, using default version 0.0.0', file=sys.stderr)
                  print('0.0.0')
              elif response.status_code == 200:
                  try:
                      data = response.json()
                      if 'info' not in data or 'version' not in data['info']:
                          print('Error: Invalid PyPI API response format', file=sys.stderr)
                          sys.exit(1)

                      pypi_ver = data['info']['version']
                      print(f'Found PyPI version: {pypi_ver}', file=sys.stderr)

                      # Validate that it's a proper version string
                      try:
                          version.parse(pypi_ver)
                          print(pypi_ver)
                      except Exception as e:
                          print(f'Error: Invalid version format from PyPI: {pypi_ver} - {e}', file=sys.stderr)
                          sys.exit(1)

                  except json.JSONDecodeError as e:
                      print(f'Error: Failed to parse PyPI API response: {e}', file=sys.stderr)
                      sys.exit(1)
              else:
                  print(f'Error: PyPI API returned status code {response.status_code}', file=sys.stderr)
                  sys.exit(1)

          except requests.exceptions.Timeout:
              print('Error: Timeout while connecting to PyPI API', file=sys.stderr)
              sys.exit(1)
          except requests.exceptions.ConnectionError:
              print('Error: Failed to connect to PyPI API', file=sys.stderr)
              sys.exit(1)
          except requests.exceptions.RequestException as e:
              print(f'Error: Request to PyPI API failed: {e}', file=sys.stderr)
              sys.exit(1)
          except Exception as e:
              print(f'Error: Unexpected error while checking PyPI: {e}', file=sys.stderr)
              sys.exit(1)
          ")
          echo "version=$pypi_version" >> $GITHUB_OUTPUT

      - name: Check if version is greater than PyPI version
        id: version_check
        if: steps.publish_flag.outputs.flag == 'true'
        run: |
          echo "Current version: ${{ steps.current_version.outputs.version }}"
          echo "Latest PyPI version: ${{ steps.pypi_version.outputs.version }}"

          python -c "
          from packaging import version
          import sys

          current = '${{ steps.current_version.outputs.version }}'
          pypi_published = '${{ steps.pypi_version.outputs.version }}'

          print(f'Comparing versions: {current} vs {pypi_published}')

          # Validate version strings
          try:
              current_parsed = version.parse(current)
              pypi_parsed = version.parse(pypi_published)
          except Exception as e:
              print(f'Error: Failed to parse version strings - {e}', file=sys.stderr)
              sys.exit(1)

          # Check if versions are the same
          if current == pypi_published:
              print(f'Error: Current version ({current}) is the same as the latest PyPI version ({pypi_published}). Please increment the version number.')
              sys.exit(1)

          # Check if current version is greater than PyPI version
          elif current_parsed > pypi_parsed:
              print(f'✓ New version ({current}) is greater than PyPI version ({pypi_published}). Proceeding with publication of mcp-arangodb-async to PyPI.')
              sys.exit(0)

          # Current version is less than PyPI version
          else:
              print(f'Error: Current version ({current}) is not greater than the latest PyPI version ({pypi_published}). Please ensure the version number is properly incremented.')
              print(f'Note: You cannot publish a version that is lower than or equal to an already published version.')
              sys.exit(1)
          "

      # Step 3. Builds and publishes to PyPI (if version is greater)
      - name: Build package
        if: steps.publish_flag.outputs.flag == 'true'
        run: python -m build

      - name: Publish to PyPI
        if: steps.publish_flag.outputs.flag == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1

      # Step 4. Waits for PyPI propagation (90s + retry loop with verification)
      - name: Wait for PyPI to propagate and verify availability
        if: steps.publish_flag.outputs.flag == 'true'
        run: |
          VERSION="${{ steps.current_version.outputs.version }}"
          echo "Waiting 90 seconds for initial PyPI propagation..."
          sleep 90

          echo "Verifying package version $VERSION is available on PyPI..."
          for i in {1..10}; do
            if curl -s "https://pypi.org/pypi/mcp-arangodb-async/$VERSION/json" | grep -q "\"version\": \"$VERSION\""; then
              echo "✓ Package version $VERSION is available on PyPI"
              exit 0
            fi
            echo "Attempt $i/10: Package not yet available, waiting 15s..."
            sleep 15
          done
          echo "::error::Package version $VERSION not available on PyPI after ~4 minutes"
          exit 1

      # Step 5. Updates server.json with the new version (transiently, not committed)
      - name: Update server.json version
        if: steps.publish_flag.outputs.flag == 'true'
        run: |
          VERSION="${{ steps.current_version.outputs.version }}"
          echo "Updating server.json to version $VERSION"
          python -c "
          import json
          with open('server.json', 'r') as f:
              data = json.load(f)
          data['version'] = '$VERSION'
          data['packages'][0]['version'] = '$VERSION'
          with open('server.json', 'w') as f:
              json.dump(data, f, indent=2)
              f.write('\n')
          "
          echo "Updated server.json:"
          cat server.json

      # Step 6. Publishes to MCP Registry (with retry logic)
      - name: Install MCP Publisher CLI
        if: steps.publish_flag.outputs.flag == 'true'
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/download/v1.0.0/mcp-publisher_1.0.0_linux_amd64.tar.gz" | tar xz mcp-publisher
          chmod +x mcp-publisher

      - name: Login to MCP Registry
        if: steps.publish_flag.outputs.flag == 'true'
        run: |
          for i in {1..3}; do
            echo "Attempt $i/3: Logging in to MCP Registry..."
            if ./mcp-publisher login github-oidc; then
              echo "✓ Successfully logged in to MCP Registry"
              exit 0
            fi
            echo "Login attempt $i failed, waiting 10s before retry..."
            sleep 10
          done
          echo "::error::Failed to login to MCP Registry after 3 attempts"
          exit 1

      - name: Publish to MCP Registry
        if: steps.publish_flag.outputs.flag == 'true'
        run: |
          for i in {1..3}; do
            echo "Attempt $i/3: Publishing to MCP Registry..."
            if ./mcp-publisher publish; then
              echo "✓ Successfully published to MCP Registry"
              exit 0
            fi
            echo "Publish attempt $i failed, waiting 10s before retry..."
            sleep 10
          done
          echo "::error::Failed to publish to MCP Registry after 3 attempts"
          exit 1

      # Step 7. Logs workflow result (always runs)
      - name: Log workflow result
        if: always()
        run: |
          if [ "${{ steps.publish_flag.outputs.flag }}" != "true" ]; then
            echo "::notice::Workflow skipped: publish_on_pypi is not set to true in pyproject.toml"
          elif [ "${{ job.status }}" == "success" ]; then
            echo "::notice::Package successfully published to PyPI and MCP Registry"
            echo "::notice::Published version: ${{ steps.current_version.outputs.version }}"
          else
            echo "::error::Workflow failed. Check the logs above for details."
            echo "::warning::Current version: ${{ steps.current_version.outputs.version }}"
            echo "::warning::PyPI version: ${{ steps.pypi_version.outputs.version }}"
          fi