name: Release

on:
  push:
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  build_linux:
    name: Build and Push (Linux - Python ${{ matrix.python-version }})
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    steps:
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
    - name: Check out the repo
      uses: actions/checkout@v4
    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
    - name: Build Wheel
      run: |
        set -x
        pip install --upgrade pip
        pip install -U 'pdm>=2.20.0' twine torch==2.3.0 setuptools
        pdm build -vv
    - name: Release to PyPI
      if: ${{ github.event_name == 'release' }}
      run: |
        export TWINE_USERNAME=pypi-upload
        export TWINE_PASSWORD=${{ secrets.TWINE_PASSWORD }}
        export TWINE_REPOSITORY_URL=https://nexus.meshy.ai/repository/pypi/
        export TWINE_NON_INTERACTIVE='true'
        python3 -m twine upload dist/*.whl

  build_windows:
    name: Build and Push (Windows - Python ${{ matrix.python-version }})
    runs-on: windows-2022
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    steps:
    - name: Check out the repo
      uses: actions/checkout@v4
    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip
    - name: Build Wheel
      run: |
        $env:PATH="$env:APPDATA\Python\Library\Bin;$env:PATH"
        pip install --upgrade pip
        pip install -U 'pdm>=2.20.0' twine torch==2.1.2 setuptools
        pdm build -vv
    - name: Release to PyPI
      if: ${{ github.event_name == 'release' }}
      run: |
        $env:TWINE_USERNAME="pypi-upload"
        $env:TWINE_PASSWORD="${{ secrets.TWINE_PASSWORD }}"
        $env:TWINE_REPOSITORY_URL="https://nexus.meshy.ai/repository/pypi/"
        $env:TWINE_NON_INTERACTIVE="true"
        python3 -m twine upload dist/*.whl
