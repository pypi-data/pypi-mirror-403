{%- if production.event.repository -%}
{%- assign repo_dir = production.event.repository.directory -%}
{%- else -%}
{%- assign repo_dir = "." -%}
{%- endif -%}
{%- if production.meta['likelihood'] contains "calibration" -%}
{%- assign calibration_on = production.meta['likelihood']['calibration']['sample'] -%}
{%- else -%}
{%- assign calibration_on = True %}
{%- endif -%}
{%- assign meta = production.meta -%}
{%- assign sampler = production.meta['sampler'] -%}
{%- assign scheduler = production.meta['scheduler'] -%}
{%- assign likelihood = production.meta['likelihood'] -%}
{%- assign priors = production.meta['priors'] -%}
{%- assign data = production.meta['data'] -%}
{%- assign quality = production.meta['quality'] -%}
{%- assign ifos = production.meta['interferometers'] -%}

{%- if data contains "calibration" %}
{%- if calibration_on %}
{%- if data['calibration'] contains ifos[0] %}
################################################################################
## Calibration arguments
################################################################################
calibration-model=CubicSpline
calibration-correction-type={{ data['calibration']['correction type'] | default: None }}
spline-calibration-envelope-dict={ {% for ifo in ifos %}{{ifo}}:{{data['calibration'][ifo]}},{% endfor %} }
spline-calibration-nodes=10
spline-calibration-amplitude-uncertainty-dict=None
spline-calibration-phase-uncertainty-dict=None
{%- if priors contains 'calibration' %}
calibration-prior-boundary={{ priors['calibration']['boundary'] | default: reflective }}
{%- endif %}
{%- endif %}
{%- endif %}
{%- endif %}

################################################################################
## Data generation arguments
################################################################################

ignore-gwpy-data-quality-check=True
gps-tuple=None
gps-file=None
timeslide-file=None
timeslide-dict=None
trigger-time={{ production.meta['event time'] }}
gaussian-noise=False
n-simulation=0
{%- if data['data files'].size > 0 %}
data-dict={ {% for ifo in ifos %}{{ifo}}:{{data['data files'][ifo]}},{% endfor %} }
{%- else %}
data-dict=None
{%- endif %}
data-format={{ data['format'] | default: "gwf" }}
channel-dict={ {% for ifo in ifos %}{{data['channels'][ifo]}},{% endfor %} }
frame-type-dict={ {% for ifo in ifos %}{{ifo}}:{{data['frame types'][ifo]}},{% endfor %} }
data-find-url={{ data['datafind url'] | default: "https://datafind.igwn.org" }}
data-find-urltype={{ data['datafind url type'] | default: "osdf" }}

################################################################################
## Detector arguments
################################################################################

coherence-test={{ likelihood['coherence test'] | default: "False" }}
detectors={{ ifos }}
duration={{ data['segment length'] }}
generation-seed=42
{%- if production._previous_assets() contains "psds" %}
psd-dict={ {% for ifo in ifos %}{{ifo}}:{{production._previous_assets()['psds'][ifo]}},{% endfor %} }
{%- elif production.meta contains "psds" %}
psd-dict={ {% for ifo in ifos %}{{ifo}}:{{production.meta['psds'][ifo]}},{% endfor %} }
{% endif %}
psd-fractional-overlap=0.5
post-trigger-duration={{ likelihood['post trigger time'] | default: 2.0 }}
sampling-frequency={{ likelihood['sample rate'] | round }}
psd-length={{ likelihood['psd length'] | round }}
psd-maximum-duration=1024
psd-method=median
psd-start-time=None
minimum-frequency={ {% for ifo in ifos %}{{ifo}}:{{quality['minimum frequency'][ifo]}},{% endfor %}{% if likelihood contains 'start frequency'%} waveform: {{ likelihood['start frequency'] }} {% endif %} }
maximum-frequency={ {% for ifo in ifos %}{{ifo}}:{{quality['maximum frequency'][ifo]}},{% endfor %} }
zero-noise=False
tukey-roll-off={{ likelihood['roll off time'] | default: 0.4 }}
resampling-method=lal

################################################################################
## Injection arguments
################################################################################

injection=False
injection-dict=None
injection-file=None
injection-numbers=None
injection-waveform-approximant=None

################################################################################
## Job submission arguments
################################################################################

{%- if scheduler contains "accounting group" %}
accounting={{ scheduler['accounting group'] }}
accounting_user = {{ config['condor']['user'] }}
{%- else %}
accounting=not.required.here
accounting_user = {{ config['condor']['user'] }}
{%- endif %}
label={{ production.name }}
local=False
generation-pool={{ scheduler['generation pool'] | default: "local-pool" }}
local-plot=False
outdir={{ production.rundir }}
periodic-restart-time={{ scheduler['periodic restart time'] | default: 28800 }}
request-memory={{ scheduler['request memory'] | default: 4.0}}
request-memory-generation={{ scheduler['request generation memory'] | default: None }}
request-cpus={{ scheduler['request cpus'] | default: 1 }}
request-disk={{ scheduler['request disk'] | default: 1 }}
scheduler={{ scheduler['type'] | default: "condor" }}
scheduler-args=None
scheduler-module=None
scheduler-env=None
transfer-files={% if scheduler['osg'] %}True{% else %}{{ scheduler['transfer files'] | default: True }}{% endif %}
log-directory=None
osg={{ scheduler['osg'] | default: False }}
desired-sites={{ scheduler['desired sites'] | default: None }}
container={{ scheduler['container'] | default: None }}
conda-env={{ scheduler['conda env'] | default: None }}
environment-variables={{ scheduler['environment variables'] | default: "{'HDF5_USE_FILE_LOCKING': False, 'OMP_NUM_THREADS'=1, 'OMP_PROC_BIND'=False}" }}
analysis-executable={{ scheduler['analysis executable'] | default: None }}
scitoken-issuer={{ scheduler['scitoken issuer'] | default: None }}
queue={{ scheduler['queue'] | default: None }}

################################################################################
## Likelihood arguments
################################################################################

distance-marginalization={{ likelihood['marginalization']['distance'] | default: "True" }}
{% assign lookup_default = production.name+".TD.npz" -%}
distance-marginalization-lookup-table={{ likelihood['marginalization']['distance lookup'] | default: lookup_default }}
phase-marginalization={{ likelihood['marginalization']['phase'] | default: "False" }}
time-marginalization={{ likelihood['marginalization']['time'] | default: "False" }}
calibration-marginalization={{ likelihood['marginalization']['calibration'] | default: "False" }}
jitter-time=True
time-reference={{ likelihood['time reference'] | default: "geocent" }}
reference-frame={{ likelihood['reference frame'] | default: "sky" }}

likelihood-type={{ likelihood['type'] | default: "GravitationalWaveTransient" }}

{%- if likelihood contains "roq" %}
roq-folder={{ likelihood['roq']['folder'] | default: "None" }}
roq-weights={{ likelihood['roq']['weights'] | default: "None" }}
roq-weight-format={{ likelihood['roq']['weight format'] | default: "None" }}
roq-scale-factor={{ likelihood['roq']['scale'] | default: 1 }}
roq-linear-matrix={{ likelihood['roq']['linear matrix'] }}
roq-quadratic-matrix={{ likelihood['roq']['quadratic matrix'] }}
{%- endif %}

{%- if likelihood contains "relative binning" %}
fiducial-parameters={{ likelihood['relative binning']['fiducial parameters'] | default: None }}
update-fiducial-parameters={{ likelihood['relative binning']['update fiducial parameters'] | default: False }}
epsilon={{ likelihood['relative binning']['epsilon'] | default: 0.025 }}
{%- endif %}

extra-likelihood-kwargs={{ likelihood['kwargs'] | default: "None" }}

################################################################################
## Output arguments
################################################################################

plot-calibration=False
plot-corner=False
plot-marginal=False
plot-skymap=False
plot-waveform=False
plot-format=png
create-summary=False
email=None
existing-dir=None
webdir={{ config['general']['webroot'] }}/{{ production.event.name }}/{{ production.name }}
summarypages-arguments=None
result-format=hdf5
final-result=True
final-result-nsamples=20000

################################################################################
## Prior arguments
################################################################################
{%- assign prior_interface = production.pipeline.get_prior_interface() -%}

default-prior = {{ prior_interface.get_default_prior() }}
deltaT=0.2
{% if production.meta contains "priors" %}
prior-dict = {{ prior_interface.to_prior_dict_string() }}
{% endif %}
enforce-signal-duration={{ production.meta['waveform']['enforce signal duration'] | default: False }}

################################################################################
## Post processing arguments
################################################################################

postprocessing-executable=None
postprocessing-arguments=None
single-postprocessing-executable=None
single-postprocessing-arguments=None

################################################################################
## Sampler arguments
################################################################################

sampler={{sampler['sampler'] | default: "dynesty" }}
sampling-seed={{sampler['seed'] | default: 1 }}
n-parallel={{ sampler['parallel jobs'] | default: 2 }}
{% assign sampler_kwargs = production.pipeline.get_sampler_kwargs() %}
sampler-kwargs={{ sampler_kwargs |  default: "{'nlive': 1000, 'naccept': 60, 'check_point_plot': True, 'check_point_delta_t': 1800, 'print_method': 'interval-60', 'sample': 'acceptance-walk'}"  }} 
reweighting-configuration={{ likelihood['reweighting_configuration'] | default: None }}
reweight-nested-samples={{ likelihood['reweight_nested_samples'] | default: False }}

################################################################################
## Waveform arguments
################################################################################

waveform-generator={{ production.meta['waveform']['generator'] | default: "bilby.gw.waveform_generator.LALCBCWaveformGenerator" }}
reference-frequency={{ production.meta['waveform']['reference frequency'] }}
waveform-approximant={{ production.meta['waveform']['approximant'] }}
catch-waveform-errors=True
pn-spin-order={{ production.meta['waveform']['pn spin order'] | default: -1 }}
pn-tidal-order={{ production.meta['waveform']['pn tidal order'] | default: -1 }}
pn-phase-order={{ production.meta['waveform']['pn phase order'] | default: -1 }}
pn-amplitude-order={{ production.meta['waveform']['pn amplitude order'] | default: 0 }}
numerical-relativity-file={{ production.meta['waveform']['file'] | default: "None" }}
waveform-arguments-dict={{ production.meta['waveform']['arguments'] | default: "None" }}
mode-array={{ production.meta['waveform']['mode array'] | default: "None" }}
frequency-domain-source-model={{ production.meta['likelihood']['frequency domain source model'] | default: "lal_binary_black_hole" }}
conversion-function={{ production.meta['waveform']['conversion function'] | default: "None" }}
generation-function={{ production.meta['waveform']['generation function'] | default: "None" }}

{%- assign additional_files = production.pipeline.get_additional_files() %}
{%- if additional_files.size > 0 %}
additional-transfer-paths={% for file in additional_files %}{{ file }} {% endfor %}
{%- endif %}
################################################################################
## Global settings
################################################################################

cosmology={{ production.meta['cosmology'] | default: "Planck15" }}
