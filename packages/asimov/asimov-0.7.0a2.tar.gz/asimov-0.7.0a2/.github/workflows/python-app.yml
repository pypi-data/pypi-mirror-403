name: Python multi-OS

on:
  push:
    branches: [ master, v*-release, v*-preview ]
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-alpha.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-beta.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-rc.[0-9]+'
  pull_request:
    branches: [ master, v*-release, v*-preview ]

jobs:
  build-ubuntu-python:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
        os: [ubuntu-latest] # , macOS-latest, windows-latest

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install .
        pip install .[bilby]
    - name: Set up git
      run: |
          git config --global init.defaultBranch master
          git config --global user.email "you@example.com"
          git config --global user.name "Your Name"

    - name: Run unittests
      run: |
        python -m unittest discover tests/

  publish:
    name: Build and publish to PyPI
    needs: build-ubuntu-python
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      id-token: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check tag branch
      id: check-branch
      run: |
        git fetch --all
        branches=$(git branch -r --contains ${{ github.ref }})
        echo "Branches containing this tag: $branches"

        if echo "$branches" | grep -E "origin/master|origin/.*-preview"; then
          echo "Tag is on master or *-preview branch"
          echo "publish=true" >> $GITHUB_OUTPUT
        else
          echo "Tag is not on master or *-preview branch"
          echo "publish=false" >> $GITHUB_OUTPUT
        fi

    - name: Set up Python
      if: steps.check-branch.outputs.publish == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build dependencies
      if: steps.check-branch.outputs.publish == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      if: steps.check-branch.outputs.publish == 'true'
      run: python -m build

    - name: Publish to PyPI
      if: steps.check-branch.outputs.publish == 'true'
      uses: pypa/gh-action-pypi-publish@release/v1

    - name: Determine if pre-release
      if: steps.check-branch.outputs.publish == 'true'
      id: prerelease
      run: |
        if echo "${{ github.ref_name }}" | grep -E "alpha|beta|rc"; then
          echo "prerelease=true" >> $GITHUB_OUTPUT
        else
          echo "prerelease=false" >> $GITHUB_OUTPUT
        fi

    - name: Extract changelog entry
      if: steps.check-branch.outputs.publish == 'true'
      id: changelog
      run: |
        # Remove 'v' prefix from tag to match changelog version
        VERSION="${{ github.ref_name }}"
        VERSION="${VERSION#v}"

        # Extract the changelog section for this version
        python3 << 'EOF' > release_notes.md
        import re
        import sys

        version = "$VERSION"

        try:
            with open('CHANGELOG.rst', 'r') as f:
                content = f.read()

            # Pattern to match version header (e.g., "0.7.0-alpha1" followed by "=====")
            # This captures content until the next version header
            pattern = rf'^{re.escape(version)}\s*\n=+\s*\n(.*?)(?=\n\S+\s*\n=+\s*\n|\Z)'

            match = re.search(pattern, content, re.MULTILINE | re.DOTALL)

            if match:
                changelog_text = match.group(1).strip()
                print(changelog_text)
            else:
                print(f"Release notes for version {version}")
                print("")
                print("See [CHANGELOG.rst](CHANGELOG.rst) for details.")
        except FileNotFoundError:
            print(f"Release {version}")
            print("")
            print("No changelog found.")
        except Exception as e:
            print(f"Release {version}")
            print("")
            print(f"Error extracting changelog: {e}")
        EOF

        echo "Extracted changelog for version $VERSION"
        cat release_notes.md

    - name: Create GitHub Release
      if: steps.check-branch.outputs.publish == 'true'
      uses: softprops/action-gh-release@v1
      with:
        draft: false
        prerelease: ${{ steps.prerelease.outputs.prerelease == 'true' }}
        body_path: release_notes.md
        files: |
          dist/*
