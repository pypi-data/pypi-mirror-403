FROM kernsuite/base:8

#Setup environment
ENV DDFACET_TEST_DATA_DIR /test_data
ENV DDFACET_TEST_OUTPUT_DIR /test_output

# Support large mlocks
RUN echo "*        -   memlock     unlimited" > /etc/security/limits.conf
ENV DEBIAN_FRONTEND noninteractive
ENV DEBIAN_PRIORITY critical
ENV GNUCOMPILER 10
ENV PYTHONVER 3.8
ENV DEB_SETUP_DEPENDENCIES \
    dpkg-dev \
    g++-$GNUCOMPILER \
    gcc-$GNUCOMPILER \
    libc-dev \
    cmake \
    gfortran-$GNUCOMPILER \
    git \
    wget \
    subversion \
    rsync

ENV DEB_DEPENCENDIES \
    python3-virtualenv \
    python3-pip \
    libfftw3-dev \
    python3-numpy \
    libfreetype6 \
    libfreetype6-dev \
    libpng-dev \
    pkg-config \
    python3-dev \
    libboost-all-dev \
    libcfitsio-dev \
    libhdf5-dev \
    wcslib-dev \
    libatlas-base-dev \
    liblapack-dev \
    python3-tk \
    libreadline6-dev \
    subversion \
    liblog4cplus-dev \
    libhdf5-dev \
    libncurses5-dev \
    flex \
    bison \
    libbison-dev \
    libqdbm-dev \
    make \
    casacore-dev \
    casacore-tools \
    casarest \
    casacore-data \
    makems \
    python3-casacore

ENV TEST_DEPENDENCIES \
    meqtrees \
    python3-meqtrees-cattery \
    meqtrees-timba \
    python3-meqtrees-timba \
    python3-astro-kittens \
    python3-astro-tigger-lsm \
    python3-owlcat \
    python3-purr \
    python3-pyxis

RUN apt-get update
RUN apt-get install -y $DEB_SETUP_DEPENDENCIES
RUN apt-get install -y $DEB_DEPENCENDIES
RUN apt-get install -y $TEST_DEPENDENCIES

RUN update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-$GNUCOMPILER 100 && \
    update-alternatives --install /usr/bin/cc cc /usr/bin/gcc-$GNUCOMPILER 100 && \
    update-alternatives --install /usr/bin/x86_64-linux-gnu-gcc x86_64-linux-gnu-gcc /usr/bin/gcc-$GNUCOMPILER 100 && \
    update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-$GNUCOMPILER 100 && \
    update-alternatives --install /usr/bin/x86_64-linux-gnu-g++ x86_64-linux-gnu-g++ /usr/bin/g++-$GNUCOMPILER 100 && \
    update-alternatives --install /usr/bin/cpp cpp /usr/bin/g++-$GNUCOMPILER 100 && \
    update-alternatives --install /usr/bin/x86_64-linux-gnu-cpp x86_64-linux-gnu-cpp /usr/bin/g++-$GNUCOMPILER 100 && \
    update-alternatives --install /usr/bin/gfortran gfortran /usr/bin/gfortran-$GNUCOMPILER 100 && \
    update-alternatives --install /usr/bin/x86_64-linux-gnu-gfortran x86_64-linux-gnu-gfortran /usr/bin/gfortran-$GNUCOMPILER 100

## All python dependencies go into venv

WORKDIR /opt
RUN virtualenv venv -p python${PYTHONVER}
RUN . /opt/venv/bin/activate && python -m pip install -U pip setuptools wheel

#####################################################################
## BUILD LOFAR FROM SOURCE
#####################################################################
WORKDIR /opt
RUN wget https://github.com/bennahugo/LOFARBeam/archive/refs/tags/DDF_KMS_20.04.tar.gz && \
    tar zxvf DDF_KMS_20.04.tar.gz && \
    rm DDF_KMS_20.04.tar.gz && \
    cd LOFARBeam-DDF_KMS_20.04 && \
    mkdir -p build/gnucxx11_opt && \
    cd build/gnucxx11_opt && \
    cmake -DCMAKE_INSTALL_PREFIX=/usr \
          -DPYTHON_PACKAGES_DIR=/opt/venv/lib/python${PYTHONVER}/site-packages \
          ../../ && \
    make -j4 && \
    make install && \
    . /opt/venv/bin/activate && python -c "import lofar.stationresponse as lsr" && \
    rm -r /opt/LOFARBeam-DDF_KMS_20.04

#####################################################################
## BUILD DDF FROM SOURCE
#####################################################################
#Copy DDFacet and SkyModel into the image
ADD DDFacet /opt/DDFacet/DDFacet
ADD SkyModel /opt/DDFacet/SkyModel
ADD README.rst /opt/DDFacet/README.rst
ADD LICENSE.md /opt/DDFacet/LICENSE.md
ADD pyproject.toml /opt/DDFacet/pyproject.toml
ADD .git /opt/DDFacet/.git
ADD .gitignore /opt/DDFacet/.gitignore
ADD .gitmodules /opt/DDFacet/.gitmodules

RUN cd /opt/DDFacet/ && git submodule update --init --recursive && cd /
# Finally install DDFacet
RUN rm -rf /opt/DDFacet/DDFacet/cbuild
RUN . /opt/venv/bin/activate && python -m pip install "/opt/DDFacet[dft-support,moresane-support,testing-requirements,fits-beam-support,kms-support,alternate-data-backends]"

# test montblanc install
WORKDIR /tmp
RUN . /opt/venv/bin/activate && python -c "import montblanc"
RUN . /opt/venv/bin/activate && python -m nose /opt/venv/lib/python${PYTHONVER}/site-packages/montblanc/impl/rime/tensorflow/rime_ops/test*

# ensure bdsf backend still works
RUN . /opt/venv/bin/activate && python -c "import bdsf"

# Finally Make VENV globally available in this container
ENV LD_LIBRARY_PATH /opt/venv/lib:$LD_LIBRARY_PATH
ENV PATH /opt/venv/bin:$PATH
ENV PYTHONPATH /opt/venv/lib/python${PYTHONVER}/site-packages:/usr/lib/python3/dist-packages

# perform some basic tests
RUN DDF.py --help
RUN MakeMask.py --help
RUN MakeCatalog.py --help
RUN MakeModel.py --help
RUN MaskDicoModel.py --help
RUN ClusterCat.py --help
RUN flag-ms.py --help
RUN meqtree-pipeliner.py --help
RUN pyxis --help
RUN python3 -c 'from Timba import mequtils'

# set as entrypoint - user should be able to run docker run ddftag and get help printed
ENTRYPOINT ["DDF.py"]
CMD ["--help"]
