chapter:
  number: 28
  title: "Persistent Volumes"
  description: "Provision and use persistent storage that outlives pods"

concepts:
  - title: "PV and PVC Concepts"
    content: |
      **PersistentVolumes (PV)** are cluster-level storage resources.
      **PersistentVolumeClaims (PVC)** are requests for storage by users.

      **The Apartment Rental Analogy**

      - **PV** = Available apartments in a building (storage resources)
      - **PVC** = Rental application (request for an apartment)
      - **Binding** = Lease signed (PVC gets a matching PV)

      **The Two-Step Model:**

      ```
      ┌─────────────────────────────────────────────────────────────┐
      │                 PV / PVC MODEL                              │
      │                                                             │
      │   ADMIN creates PVs           USERS create PVCs            │
      │   (provision storage)         (request storage)            │
      │                                                             │
      │   ┌─────────────────┐         ┌─────────────────┐          │
      │   │      PV         │         │      PVC        │          │
      │   │  10Gi, RWO      │◄───────►│  Request: 5Gi  │          │
      │   │  "Available"    │ BIND    │  RWO           │          │
      │   └─────────────────┘         └─────────────────┘          │
      │                                       │                     │
      │   ┌─────────────────┐                 │                     │
      │   │      PV         │                 │                     │
      │   │  5Gi, RWX       │                 │                     │
      │   │  "Available"    │                 │                     │
      │   └─────────────────┘                 ▼                     │
      │                               ┌─────────────────┐          │
      │                               │      Pod        │          │
      │                               │  Uses PVC       │          │
      │                               └─────────────────┘          │
      └─────────────────────────────────────────────────────────────┘
      ```

      **Why This Separation?**

      | Concern | Who | Object |
      |---------|-----|--------|
      | Provision storage | Admin | PV |
      | Request storage | Developer | PVC |
      | Use storage | App | Pod |

      **Access Modes:**

      | Mode | Abbreviation | Description |
      |------|--------------|-------------|
      | ReadWriteOnce | RWO | Single node read-write |
      | ReadOnlyMany | ROX | Multiple nodes read-only |
      | ReadWriteMany | RWX | Multiple nodes read-write |

      **Key insight:** PVs are cluster resources (like nodes). PVCs are
      namespace resources that claim PVs.
    key_points:
      - "PV = cluster storage resource"
      - "PVC = request for storage"
      - "PVC binds to matching PV"
      - "Access modes: RWO, ROX, RWX"

  - title: "Creating PVs and PVCs"
    content: |
      **PersistentVolume Example:**

      ```yaml
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: my-pv
      spec:
        capacity:
          storage: 10Gi
        accessModes:
          - ReadWriteOnce
        persistentVolumeReclaimPolicy: Retain
        storageClassName: manual
        hostPath:                    # For testing only!
          path: /data/my-pv
      ```

      **PersistentVolumeClaim Example:**

      ```yaml
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: my-pvc
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 5Gi
        storageClassName: manual     # Must match PV!
      ```

      **Binding Process:**

      ```
      ┌─────────────────────────────────────────────────────────────┐
      │                    BINDING FLOW                             │
      │                                                             │
      │   1. PV Created                                             │
      │      ┌──────────────┐                                       │
      │      │ PV: my-pv    │                                       │
      │      │ Status:      │                                       │
      │      │  Available   │                                       │
      │      │ 10Gi, RWO    │                                       │
      │      └──────────────┘                                       │
      │                                                             │
      │   2. PVC Created - Kubernetes finds matching PV             │
      │      ┌──────────────┐      ┌──────────────┐                │
      │      │ PV: my-pv    │◄────►│ PVC: my-pvc  │                │
      │      │ Status:      │      │ Status:      │                │
      │      │  Bound       │      │  Bound       │                │
      │      └──────────────┘      └──────────────┘                │
      │                                                             │
      │   3. Pod uses PVC                                           │
      │      ┌──────────────┐                                       │
      │      │ Pod          │                                       │
      │      │ volumes:     │                                       │
      │      │   - pvc:     │──────► my-pvc ──────► my-pv          │
      │      └──────────────┘                                       │
      └─────────────────────────────────────────────────────────────┘
      ```

      **Using PVC in a Pod:**

      ```yaml
      apiVersion: v1
      kind: Pod
      metadata:
        name: pvc-pod
      spec:
        containers:
        - name: app
          image: nginx
          volumeMounts:
          - name: storage
            mountPath: /data
        volumes:
        - name: storage
          persistentVolumeClaim:
            claimName: my-pvc        # Reference the PVC
      ```

      **Key insight:** Pods reference PVCs, not PVs directly.
      Kubernetes handles the binding.
    key_points:
      - "PV defines capacity, access modes, reclaim policy"
      - "PVC requests size and access mode"
      - "storageClassName must match for binding"
      - "Pods reference PVCs in volumes section"

  - title: "Reclaim Policies and Lifecycle"
    content: |
      **What happens when a PVC is deleted?**

      ```
      ┌─────────────────────────────────────────────────────────────┐
      │                 RECLAIM POLICIES                            │
      │                                                             │
      │   Retain:                                                   │
      │   ┌─────────────────────────────────────────────┐          │
      │   │ PVC deleted → PV becomes "Released"        │          │
      │   │ Data is kept, admin must manually reclaim  │          │
      │   │ Use for: important data you want to keep   │          │
      │   └─────────────────────────────────────────────┘          │
      │                                                             │
      │   Delete:                                                   │
      │   ┌─────────────────────────────────────────────┐          │
      │   │ PVC deleted → PV and data are deleted      │          │
      │   │ Automatic cleanup                          │          │
      │   │ Use for: temporary or easily recreated data│          │
      │   └─────────────────────────────────────────────┘          │
      │                                                             │
      │   Recycle (deprecated):                                     │
      │   ┌─────────────────────────────────────────────┐          │
      │   │ PVC deleted → Data wiped, PV reusable      │          │
      │   │ Don't use - use dynamic provisioning       │          │
      │   └─────────────────────────────────────────────┘          │
      └─────────────────────────────────────────────────────────────┘
      ```

      **PV Status Lifecycle:**

      ```
      Available ──► Bound ──► Released ──► Available (if reclaimed)
                      │                         │
                      └──────► Failed ◄─────────┘
      ```

      | Status | Meaning |
      |--------|---------|
      | Available | Free, ready to be bound |
      | Bound | Claimed by a PVC |
      | Released | PVC deleted, data still exists |
      | Failed | Automatic reclaim failed |

      **Checking Status:**

      ```bash
      $ kubectl get pv
      NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM
      my-pv   10Gi       RWO            Retain           Available
      pv-1    5Gi        RWO            Delete           Bound       default/pvc-1
      pv-2    5Gi        RWO            Retain           Released    default/old-pvc

      $ kubectl get pvc
      NAME    STATUS   VOLUME   CAPACITY   ACCESS MODES
      pvc-1   Bound    pv-1     5Gi        RWO
      ```

      **Key insight:** Use `Retain` for databases and important data.
      Use `Delete` for temporary or reproducible data.
    key_points:
      - "Retain: keep data after PVC deletion"
      - "Delete: remove PV and data"
      - "Released PVs need manual intervention"
      - "Check status with kubectl get pv"

command_practice:
  - id: "cmd-01"
    title: "Create a PersistentVolume"
    instructions: |
      **What we're doing:** Create a PV as the storage administrator.

      **Why this matters:** PVs are the foundation for persistent storage.

      Create a PV:
    command_hint: "kubectl apply -f - <<EOF
apiVersion: v1
kind: PersistentVolume
metadata:
  name: practice-pv
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: manual
  hostPath:
    path: /tmp/practice-pv
EOF"
    validation:
      type: "command_output"
      command: "kubectl get pv practice-pv"
      expected_contains: "Available"
    points: 10

  - id: "cmd-02"
    title: "Create a PersistentVolumeClaim"
    instructions: |
      **What we're doing:** Request storage as a user/developer.

      **Why this matters:** PVCs are how applications request storage.

      Create a PVC that binds to the PV:
    command_hint: "kubectl apply -f - <<EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: practice-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
  storageClassName: manual
EOF"
    validation:
      type: "command_output"
      command: "kubectl get pvc practice-pvc"
      expected_contains: "Bound"
    points: 10

  - id: "cmd-03"
    title: "Use PVC in a Pod"
    instructions: |
      **What we're doing:** Create a pod that uses the PVC.

      **Why this matters:** This completes the storage chain: PV → PVC → Pod.

      Create a pod using the PVC:
    command_hint: "kubectl run pvc-user --image=nginx --overrides='{\"spec\":{\"volumes\":[{\"name\":\"data\",\"persistentVolumeClaim\":{\"claimName\":\"practice-pvc\"}}],\"containers\":[{\"name\":\"pvc-user\",\"image\":\"nginx\",\"volumeMounts\":[{\"name\":\"data\",\"mountPath\":\"/data\"}]}]}}'"
    validation:
      type: "command_output"
      command: "kubectl get pod pvc-user -o jsonpath='{.spec.volumes[0].persistentVolumeClaim.claimName}'"
      expected_contains: "practice-pvc"
    points: 10

scenarios:
  - id: "scenario-01"
    title: "PVC Stuck Pending"
    description: |
      A PVC won't bind to any PV:

      ```
      $ kubectl get pvc
      NAME      STATUS    VOLUME   CAPACITY   ACCESS MODES
      db-pvc    Pending
      ```

      Your mission: Figure out why and fix it!
    manifest: |
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: available-pv
      spec:
        capacity:
          storage: 5Gi
        accessModes:
          - ReadWriteOnce
        storageClassName: fast
        hostPath:
          path: /tmp/available-pv
      ---
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: db-pvc
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 5Gi
        storageClassName: slow
    hints:
      - "Check the storageClassName on both PV and PVC"
      - "PV has storageClassName: fast but PVC requests 'slow'"
      - "Change the PVC storageClassName to 'fast'"
    solution_validation:
      type: "command_output"
      command: "kubectl get pvc db-pvc -o jsonpath='{.status.phase}'"
      expected_contains: "Bound"
    points: 25
    hint_penalty: 5

  - id: "scenario-02"
    title: "PV Released But Not Available"
    description: |
      A PV shows "Released" status but can't be used by new PVCs:

      ```
      $ kubectl get pv
      NAME      STATUS     CLAIM
      old-pv    Released   default/deleted-pvc
      ```

      Your mission: Make the PV available again!
    manifest: |
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: released-pv
      spec:
        capacity:
          storage: 1Gi
        accessModes:
          - ReadWriteOnce
        persistentVolumeReclaimPolicy: Retain
        storageClassName: manual
        hostPath:
          path: /tmp/released-pv
        claimRef:
          name: old-claim
          namespace: default
    hints:
      - "The PV has a claimRef pointing to the old PVC"
      - "You need to remove the claimRef to make it Available"
      - "kubectl patch pv released-pv --type=json -p='[{\"op\":\"remove\",\"path\":\"/spec/claimRef\"}]'"
    solution_validation:
      type: "command_output"
      command: "kubectl get pv released-pv -o jsonpath='{.status.phase}'"
      expected_contains: "Available"
    points: 25
    hint_penalty: 5

quiz:
  passing_score: 70
  questions:
    - type: "multiple_choice"
      question: "What is the relationship between PV and PVC?"
      options:
        - "PVC creates PV automatically"
        - "PV requests storage from PVC"
        - "PVC claims storage from a matching PV"
        - "They are the same thing"
      correct: 2
      explanation: "PVCs request storage that is fulfilled by binding to a matching PV."
      points: 5

    - type: "fill_yaml"
      question: "Complete the PVC spec to request 10Gi of storage:"
      yaml_template: |
        resources:
          _________:
            storage: 10Gi
      expected: "requests"
      explanation: "PVCs use 'requests' to specify the desired storage size."
      points: 10

    - type: "multiple_choice"
      question: "What does the 'Retain' reclaim policy do?"
      options:
        - "Deletes the PV when PVC is deleted"
        - "Keeps the PV and data after PVC deletion"
        - "Automatically resizes the PV"
        - "Recycles the PV for immediate reuse"
      correct: 1
      explanation: "Retain keeps the PV and data, requiring manual cleanup."
      points: 5

    - type: "command_challenge"
      question: "Write the command to list all PersistentVolumes"
      expected_contains: "get pv"
      alternatives:
        - "kubectl get pv"
        - "kubectl get persistentvolume"
        - "kubectl get persistentvolumes"
      hint: "Use kubectl get"
      explanation: "`kubectl get pv` lists all PersistentVolumes."
      points: 10

    - type: "fill_yaml"
      question: "Complete the pod volume to use PVC 'db-storage':"
      yaml_template: |
        volumes:
        - name: data
          persistentVolumeClaim:
            _________: db-storage
      expected: "claimName"
      explanation: "claimName references the PVC to use."
      points: 10

    - type: "multiple_choice"
      question: "What access mode allows multiple nodes to mount read-write?"
      options:
        - "ReadWriteOnce (RWO)"
        - "ReadOnlyMany (ROX)"
        - "ReadWriteMany (RWX)"
        - "ReadWriteSingle (RWS)"
      correct: 2
      explanation: "RWX (ReadWriteMany) allows multiple nodes to mount read-write."
      points: 5

    - type: "true_false"
      question: "A PVC must have the same storageClassName as the PV it binds to."
      correct: true
      explanation: "storageClassName must match for binding to occur (or both be empty)."
      points: 5

    - type: "multiple_choice"
      question: "What status does a PV show when it's bound to a PVC?"
      options:
        - "Available"
        - "Bound"
        - "Released"
        - "Active"
      correct: 1
      explanation: "Bound status indicates the PV is claimed by a PVC."
      points: 5
