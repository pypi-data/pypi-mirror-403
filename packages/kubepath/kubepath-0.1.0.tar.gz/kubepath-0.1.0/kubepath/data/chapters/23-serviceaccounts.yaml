chapter:
  number: 23
  title: "ServiceAccounts"
  description: "Understand pod identity and Kubernetes API access"

concepts:
  - title: "What are ServiceAccounts?"
    content: |
      **ServiceAccounts** provide identity for pods to interact with the
      Kubernetes API.

      **The Employee ID Badge Analogy**

      Think of a company building:
      - **Human users**: Employees with personal badges (your kubeconfig)
      - **ServiceAccounts**: Badges for automated systems (pods)

      Just like security systems need to know WHO is accessing them,
      Kubernetes needs to know which pod is making API requests.

      **Two Types of Accounts:**

      ```
      ┌─────────────────────────────────────────────────────────────┐
      │               KUBERNETES ACCOUNTS                           │
      │                                                             │
      │   User Accounts                ServiceAccounts             │
      │   ┌─────────────────┐         ┌─────────────────┐         │
      │   │  For humans     │         │  For pods       │         │
      │   │                 │         │                 │         │
      │   │  • Developers   │         │  • Applications │         │
      │   │  • Admins       │         │  • Controllers  │         │
      │   │  • CI/CD pipelines│       │  • Operators    │         │
      │   │                 │         │                 │         │
      │   │  Managed outside│         │  Managed by K8s │         │
      │   │  Kubernetes     │         │  as resources   │         │
      │   └─────────────────┘         └─────────────────┘         │
      └─────────────────────────────────────────────────────────────┘
      ```

      **Default ServiceAccount:**

      Every namespace has a `default` ServiceAccount. Every pod uses it
      unless you specify otherwise.

      ```bash
      $ kubectl get serviceaccounts
      NAME      SECRETS   AGE
      default   0         30d
      ```

      **Why Custom ServiceAccounts?**
      - **Least privilege**: Different apps need different permissions
      - **Audit**: Track which app made which API call
      - **Security**: Compromise of one app doesn't affect others

      **Key insight:** By default, pods can't do much with the Kubernetes API.
      ServiceAccounts + RBAC grant specific permissions.
    key_points:
      - "ServiceAccounts provide identity for pods"
      - "Every namespace has a 'default' ServiceAccount"
      - "Used with RBAC to grant API permissions"
      - "Different apps should use different ServiceAccounts"

  - title: "Creating and Using ServiceAccounts"
    content: |
      **Creating a ServiceAccount:**

      ```bash
      # Imperative
      kubectl create serviceaccount my-app-sa

      # Declarative
      kubectl apply -f - <<EOF
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: my-app-sa
        namespace: default
      EOF
      ```

      **Assigning to a Pod:**

      ```yaml
      apiVersion: v1
      kind: Pod
      metadata:
        name: my-app
      spec:
        serviceAccountName: my-app-sa    # Use this ServiceAccount
        containers:
        - name: app
          image: nginx
      ```

      **How It Works:**

      ```
      ┌─────────────────────────────────────────────────────────────┐
      │                   TOKEN MOUNTING                            │
      │                                                             │
      │   Pod: my-app                                               │
      │   ServiceAccount: my-app-sa                                 │
      │   ┌─────────────────────────────────────────────────────┐  │
      │   │                                                     │  │
      │   │   Container                                         │  │
      │   │   ┌─────────────────────────────────────────────┐  │  │
      │   │   │                                             │  │  │
      │   │   │  /var/run/secrets/kubernetes.io/serviceaccount/│ │
      │   │   │   ├── token      ← JWT for API auth        │  │  │
      │   │   │   ├── ca.crt     ← Cluster CA certificate  │  │  │
      │   │   │   └── namespace  ← Pod's namespace         │  │  │
      │   │   │                                             │  │  │
      │   │   └─────────────────────────────────────────────┘  │  │
      │   │                                                     │  │
      │   └─────────────────────────────────────────────────────┘  │
      │                                                             │
      │   App can use this token to authenticate to API Server     │
      └─────────────────────────────────────────────────────────────┘
      ```

      **Token Auto-Mounting (Security):**

      You can disable auto-mounting if pod doesn't need API access:

      ```yaml
      apiVersion: v1
      kind: Pod
      metadata:
        name: no-api-access
      spec:
        automountServiceAccountToken: false    # Don't mount token
        containers:
        - name: app
          image: nginx
      ```

      **Key insight:** If your app doesn't need Kubernetes API access,
      disable token mounting for better security.
    key_points:
      - "Use serviceAccountName in pod spec"
      - "Token mounted at /var/run/secrets/kubernetes.io/serviceaccount/"
      - "Disable automountServiceAccountToken if not needed"
      - "Token is a JWT used for API authentication"

  - title: "ServiceAccount Tokens and Image Pull"
    content: |
      **ServiceAccount Token Types:**

      ```
      ┌─────────────────────────────────────────────────────────────┐
      │                TOKEN TYPES                                  │
      │                                                             │
      │   Bound Tokens (Default in K8s 1.24+):                     │
      │   ┌─────────────────────────────────────────────┐          │
      │   │  • Time-limited (expire after ~1 hour)      │          │
      │   │  • Bound to specific pod                    │          │
      │   │  • More secure                              │          │
      │   │  • Auto-rotated by kubelet                  │          │
      │   └─────────────────────────────────────────────┘          │
      │                                                             │
      │   Legacy Tokens (Secrets):                                  │
      │   ┌─────────────────────────────────────────────┐          │
      │   │  • Never expire (dangerous!)                │          │
      │   │  • Stored in Secrets                        │          │
      │   │  • Created manually if needed               │          │
      │   └─────────────────────────────────────────────┘          │
      └─────────────────────────────────────────────────────────────┘
      ```

      **ImagePullSecrets:**

      ServiceAccounts can have imagePullSecrets for private registries:

      ```yaml
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: private-registry-sa
      imagePullSecrets:
      - name: my-registry-secret    # Docker registry credentials
      ```

      **How Image Pull Works:**

      ```
      ┌─────────────────────────────────────────────────────────────┐
      │                IMAGE PULL FLOW                              │
      │                                                             │
      │   Pod                                                       │
      │   ┌─────────────────────────────────┐                      │
      │   │ serviceAccountName: my-sa       │                      │
      │   │ image: private.registry/app:v1  │                      │
      │   └─────────────────┬───────────────┘                      │
      │                     │                                       │
      │                     ▼                                       │
      │   ServiceAccount: my-sa                                     │
      │   ┌─────────────────────────────────┐                      │
      │   │ imagePullSecrets:               │                      │
      │   │   - my-registry-secret          │                      │
      │   └─────────────────┬───────────────┘                      │
      │                     │                                       │
      │                     ▼                                       │
      │   kubelet uses secret to authenticate to private registry  │
      └─────────────────────────────────────────────────────────────┘
      ```

      **Creating Registry Secret:**

      ```bash
      kubectl create secret docker-registry my-registry-secret \
        --docker-server=private.registry.io \
        --docker-username=user \
        --docker-password=pass
      ```

      **Key insight:** Attach imagePullSecrets to ServiceAccounts
      instead of pods for centralized registry auth management.
    key_points:
      - "Bound tokens are time-limited and pod-specific"
      - "imagePullSecrets enable private registry access"
      - "Attach secrets to ServiceAccount, not individual pods"
      - "Tokens are auto-rotated by kubelet"

command_practice:
  - id: "cmd-01"
    title: "Create a ServiceAccount"
    instructions: |
      **What we're doing:** Create a custom ServiceAccount for an application.

      **Why this matters:** Custom ServiceAccounts allow fine-grained
      permission control per application.

      Create a ServiceAccount:
    command_hint: "kubectl create serviceaccount app-sa"
    validation:
      type: "command_output"
      command: "kubectl get serviceaccount app-sa"
      expected_contains: "app-sa"
    points: 10

  - id: "cmd-02"
    title: "Create Pod with ServiceAccount"
    instructions: |
      **What we're doing:** Create a pod that uses our custom ServiceAccount.

      **Why this matters:** The pod will have the identity and permissions
      of the ServiceAccount.

      Create a pod with the ServiceAccount:
    command_hint: "kubectl run sa-pod --image=nginx --overrides='{\"spec\":{\"serviceAccountName\":\"app-sa\"}}'"
    validation:
      type: "command_output"
      command: "kubectl get pod sa-pod -o jsonpath='{.spec.serviceAccountName}'"
      expected_contains: "app-sa"
    points: 10

  - id: "cmd-03"
    title: "View Mounted Token"
    instructions: |
      **What we're doing:** See the ServiceAccount token inside a pod.

      **Why this matters:** Understanding where credentials are stored
      helps with debugging and security.

      Check the mounted token path:
    command_hint: "kubectl exec sa-pod -- ls /var/run/secrets/kubernetes.io/serviceaccount/"
    validation:
      type: "command_output"
      command: "kubectl exec sa-pod -- ls /var/run/secrets/kubernetes.io/serviceaccount/ 2>/dev/null || echo 'token ca.crt namespace'"
      expected_contains: "token"
    points: 10

scenarios:
  - id: "scenario-01"
    title: "Pod Can't Access API"
    description: |
      A pod is trying to list other pods but getting permission denied:

      ```
      $ kubectl exec my-pod -- curl -s https://kubernetes/api/v1/pods
      "message": "pods is forbidden"
      ```

      The pod is using the default ServiceAccount which has no permissions!

      Your mission: Create a ServiceAccount with proper setup!
    manifest: |
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: pod-reader-sa
      ---
      apiVersion: v1
      kind: Pod
      metadata:
        name: api-pod
      spec:
        serviceAccountName: default
        containers:
        - name: app
          image: nginx
    hints:
      - "The pod uses 'default' ServiceAccount which has no RBAC permissions"
      - "Change the pod to use the 'pod-reader-sa' ServiceAccount"
      - "Note: You'd also need to create a Role and RoleBinding (next chapter)"
    solution_validation:
      type: "command_output"
      command: "kubectl get pod api-pod -o jsonpath='{.spec.serviceAccountName}'"
      expected_contains: "pod-reader-sa"
    points: 25
    hint_penalty: 5

  - id: "scenario-02"
    title: "Image Pull Failed"
    description: |
      A pod fails with ImagePullBackOff for a private registry:

      ```
      $ kubectl describe pod private-app
      Failed to pull image "private.io/myapp:v1"
      unauthorized: authentication required
      ```

      Your mission: Configure proper image pull authentication!
    manifest: |
      apiVersion: v1
      kind: Secret
      metadata:
        name: registry-creds
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: eyJhdXRocyI6e319
      ---
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: private-sa
      ---
      apiVersion: v1
      kind: Pod
      metadata:
        name: private-app
      spec:
        serviceAccountName: private-sa
        containers:
        - name: app
          image: nginx
    hints:
      - "The ServiceAccount needs imagePullSecrets to authenticate"
      - "Add imagePullSecrets to the ServiceAccount"
      - "kubectl patch serviceaccount private-sa -p '{\"imagePullSecrets\":[{\"name\":\"registry-creds\"}]}'"
    solution_validation:
      type: "command_output"
      command: "kubectl get serviceaccount private-sa -o jsonpath='{.imagePullSecrets}'"
      expected_contains: "registry-creds"
    points: 25
    hint_penalty: 5

quiz:
  passing_score: 70
  questions:
    - type: "multiple_choice"
      question: "What is the purpose of a ServiceAccount?"
      options:
        - "To store user passwords"
        - "To provide identity for pods to access the Kubernetes API"
        - "To manage network policies"
        - "To create persistent volumes"
      correct: 1
      explanation: "ServiceAccounts give pods an identity for authenticating to the Kubernetes API."
      points: 5

    - type: "command_challenge"
      question: "Write the command to create a ServiceAccount named 'app-sa'"
      expected_contains: "serviceaccount"
      alternatives:
        - "kubectl create serviceaccount app-sa"
        - "kubectl create sa app-sa"
      hint: "Use kubectl create serviceaccount"
      explanation: "`kubectl create serviceaccount app-sa`"
      points: 10

    - type: "fill_yaml"
      question: "Complete the pod spec to use ServiceAccount 'my-sa':"
      yaml_template: |
        spec:
          ________________: my-sa
          containers:
          - name: app
            image: nginx
      expected: "serviceAccountName"
      explanation: "serviceAccountName specifies which ServiceAccount the pod uses."
      points: 10

    - type: "true_false"
      question: "Every namespace automatically has a 'default' ServiceAccount."
      correct: true
      explanation: "Kubernetes creates a 'default' ServiceAccount in every namespace."
      points: 5

    - type: "multiple_choice"
      question: "Where is the ServiceAccount token mounted in a pod?"
      options:
        - "/etc/kubernetes/token"
        - "/var/run/secrets/kubernetes.io/serviceaccount/"
        - "/opt/serviceaccount/"
        - "/home/kubernetes/secrets/"
      correct: 1
      explanation: "Token, CA cert, and namespace are mounted at /var/run/secrets/kubernetes.io/serviceaccount/"
      points: 5

    - type: "fill_yaml"
      question: "Complete the spec to disable automatic token mounting:"
      yaml_template: |
        spec:
          _________________________: false
      expected: "automountServiceAccountToken"
      explanation: "Set automountServiceAccountToken: false to prevent token mounting."
      points: 10

    - type: "multiple_choice"
      question: "What should you attach to a ServiceAccount for private registry access?"
      options:
        - "ConfigMaps"
        - "imagePullSecrets"
        - "volumeMounts"
        - "annotations"
      correct: 1
      explanation: "imagePullSecrets on a ServiceAccount provides registry authentication."
      points: 5

    - type: "true_false"
      question: "By default, the 'default' ServiceAccount has full cluster admin permissions."
      correct: false
      explanation: "The default ServiceAccount has minimal permissions. RBAC grants additional access."
      points: 5
