[build-system]
requires = ["hatchling", "hatch-vcs"]
build-backend = "hatchling.build"


[tool.hatch]
version.source = "vcs"
version.raw-options = { root = "../", fallback_version="10.0.0" }
build.hooks.vcs.version-file = "arraylake/_version.py"

[tool.hatch.build.targets.wheel]
packages = ["arraylake"]

[tool.hatch.metadata]
allow-direct-references = true

[project]
name = "arraylake"
description = "Python client for ArrayLake"
readme = "README.md"
authors = [
  { name = "Joseph Hamman", email = "joe@earthmover.io" },
]
requires-python = ">=3.11, <3.14"
dynamic = ["version"]
license = "MIT"
keywords = []
classifiers = [
  "Programming Language :: Python",
  "Programming Language :: Python :: 3.11",
  "Programming Language :: Python :: 3.12",
  "Programming Language :: Python :: 3.13",
]
dependencies = [
  "click >= 8.1.3, < 9.0",
  "donfig >= 0.7, < 1.0",
  "httpx >= 0.23, < 0.28",
  "icechunk >= 1.1.0, < 2.0.0",
  "numpy >= 1.23, < 3.0",
  "packaging >= 23.0, < 26.0",
  "pydantic[email] >= 2.9, < 3.0",
  "python-dateutil >= 2.8, < 3.0",
  "rich >= 12.6, < 15.0",
  "ruamel-yaml >= 0.17, < 1.0",
  "structlog >= 24.1, < 26.0",
  "typer >= 0.12.0, < 1.0",
  "zarr >= 3.1.0, < 4.0",
]

[project.optional-dependencies]
xarray = [
  "xarray >= 2024.10.0",
  "cf_xarray >= 0.10.4",
]
maximal = [
  "xarray[complete] >= 2024.10.0",
  "cf_xarray >= 0.10.4",
  "numpy<2.3",                     # until xarray complete updates their constraints
  "pyarrow<22",                    # restrict for better resolution. comes via dask[complete]
]

[dependency-groups]
dev = [
  "cloudpickle~=3.0.0",
  "hatch>=1.14.2",
  "hypothesis>=6.88.1",
  "icechunk >= 1.1.9, < 2.0.0",  # tests require higher min version than core package - see https://github.com/earth-mover/arraylake/pull/3404#discussion_r2490979373
  "mypy~=1.11",
  "pytest-asyncio~=0.21.1",
  "pytest-click~=1.1.0",
  "pytest-cov~=4.0.0",
  "pytest-incremental~=0.6.0",
  "pytest-lazy-fixture~=0.6.3",
  "pytest-reportlog~=0.4.0",
  "pytest-retry~=1.6.2",
  "pytest-timeout~=2.1.0",
  "pytest-xdist~=3.5.0",
  "pytest~=7.3",
  "pyyaml~=6.0.1",
  "respx~=0.20.1",
  "types-cachetools~=5.3",
  "types-python-dateutil~=2.8.19",
  "types-pyyaml~=6.0.12",
  "types-urllib3~=1.26.25",
]

[project.scripts]
arraylake = "arraylake.cli.main:app"
al = "arraylake.cli.main:app"

[project.urls]
Documentation = "https://docs.earthmover.io/"
Changelog = "https://docs.earthmover.io/changelog"

[tool.coverage.run]
branch = true
source = ["arraylake/*"]
include = ["arraylake/*"]
omit = ["tests/*", "**/__init__.py", "**/__main__.py", "arraylake/token.py", "arraylake/cli/auth.py"]

[tool.coverage.report]
include = ["arraylake/*"]

[tool.pytest.ini_options]
markers = ["slow: mark test as slow", "add_object_store: add object store backend to test"]
norecursedirs = ["tests/helpers"]
filterwarnings = [
  'ignore:.*pkg_resources.*:DeprecationWarning',
  'ignore:.*make_current is deprecated; start the event loop first.*:DeprecationWarning',
  'ignore:.*no current event loop.*:DeprecationWarning',
  'error:ZARR_V3_EXPERIMENTAL_API must be set before importing the arraylake client .*:UserWarning',
  'ignore:The experimental Zarr V3 implementation .*:FutureWarning'
]
asyncio_mode = "auto"

[tool.mypy]
warn_unused_configs = true
warn_redundant_casts = true
warn_unused_ignores = true
strict_equality = true
extra_checks = true
check_untyped_defs = true
disallow_subclassing_any = true
disallow_untyped_decorators = true
#disallow_any_generics = true  #TODO
exclude = [
  '^tests/',  # TOML literal string (single-quotes, no escaping necessary)
  '^flycheck_\.',  # for emacs
]

# TODO: mypy improvements for these
[[tool.mypy.overrides]]
ignore_missing_imports = true
module=[
"aiobotocore.*",
"botocore",
"cfgrib.*",
"donfig",
"fsspec.*",
"gcsfs",
"icechunk",
"kerchunk.*",
"ipytree",
"sqlitedict",
"s3fs",
"types_aiobotocore_s3",
"uvloop",
"zarr.*",
]

[tool.ruff]
line-length = 140
target-version = "py311"


[tool.ruff.lint]
select = ["F", "I", "UP", "TRY"]
ignore = [
  "TRY003",
  "TRY002",
  "TRY301",
  "TRY300",
  "TRY004",
]
exclude = ['**/__init__.py', '**/tests/*']
