{%- if scheduler_backend != "memory" %}
"""Scheduled job API endpoints."""

from fastapi import APIRouter, Depends, HTTPException

from app.components.backend.api.models import (
    ScheduledTaskDetailResponse,
    ScheduledTaskListResponse,
    ScheduledTaskStatisticsResponse,
)
from app.core.log import logger
from app.services.scheduler import ScheduledTaskManager

router = APIRouter(prefix="/scheduler", tags=["scheduler"])


async def get_task_manager() -> ScheduledTaskManager:
    """Dependency to provide ScheduledTaskManager instance."""
    return ScheduledTaskManager()


@router.get("/jobs", response_model=ScheduledTaskListResponse)
async def list_scheduled_jobs(
    manager: ScheduledTaskManager = Depends(get_task_manager)
) -> ScheduledTaskListResponse:
    """Get list of all scheduled jobs."""
    try:
        tasks = await manager.list_tasks()

        return ScheduledTaskListResponse(
            tasks=tasks,
            total_count=len(tasks)
        )

    except RuntimeError as e:
        raise HTTPException(
            status_code=503,
            detail={
                "error": "scheduler_unavailable",
                "message": str(e)
            }
        )
    except Exception as e:
        logger.error(f"Failed to list scheduled jobs: {e}")
        raise HTTPException(
            status_code=500,
            detail={
                "error": "internal_error",
                "message": f"Failed to retrieve scheduled jobs: {str(e)}"
            }
        )


@router.get("/jobs/{job_id}", response_model=ScheduledTaskDetailResponse)
async def get_scheduled_job(
    job_id: str, manager: ScheduledTaskManager = Depends(get_task_manager)
) -> ScheduledTaskDetailResponse:
    """Get specific scheduled job details."""
    try:
        task = await manager.get_task(job_id)

        if not task:
            raise HTTPException(
                status_code=404,
                detail={
                    "error": "job_not_found",
                    "message": f"Scheduled job '{job_id}' not found"
                }
            )

        return ScheduledTaskDetailResponse(task=task)

    except HTTPException:
        raise
    except RuntimeError as e:
        raise HTTPException(
            status_code=503,
            detail={
                "error": "scheduler_unavailable",
                "message": str(e)
            }
        )
    except Exception as e:
        logger.error(f"Failed to get scheduled job {job_id}: {e}")
        raise HTTPException(
            status_code=500,
            detail={
                "error": "internal_error",
                "message": f"Failed to retrieve job details: {str(e)}"
            }
        )


@router.get("/statistics", response_model=ScheduledTaskStatisticsResponse)
async def get_scheduler_statistics(
    manager: ScheduledTaskManager = Depends(get_task_manager)
) -> ScheduledTaskStatisticsResponse:
    """Get scheduler statistics."""
    try:
        statistics = await manager.get_statistics()

        return ScheduledTaskStatisticsResponse(statistics=statistics)

    except RuntimeError as e:
        raise HTTPException(
            status_code=503,
            detail={
                "error": "scheduler_unavailable",
                "message": str(e)
            }
        )
    except Exception as e:
        logger.error(f"Failed to get scheduler statistics: {e}")
        raise HTTPException(
            status_code=500,
            detail={
                "error": "internal_error",
                "message": f"Failed to retrieve statistics: {str(e)}"
            }
        )
{%- endif %}