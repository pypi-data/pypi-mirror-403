{%- if scheduler_backend != "memory" -%}
"""
Scheduled task CLI commands.

Provides command-line interface for listing scheduled jobs.
"""

import asyncio

from rich import print as rprint
from rich.console import Console
from rich.table import Table
import typer

from app.services.scheduler import ScheduledTaskManager
from app.services.scheduler.models import ScheduledTask

app = typer.Typer(
    name="tasks",
    help="Scheduled task management commands",
    no_args_is_help=True,
)

console = Console()


@app.command("list")
def list_jobs() -> None:
    """
    List all scheduled jobs with their current status.

    Shows job details including next run time, status, and configuration.
    """

    rprint("[bold blue]Listing Scheduled Jobs[/bold blue]")

    try:
        tasks = asyncio.run(_get_scheduled_tasks())

        if not tasks:
            rprint("[yellow]No scheduled jobs found[/yellow]")
            return

        table = Table(
            title="Scheduled Jobs",
            show_header=True,
            header_style="bold magenta",
        )
        table.add_column("Job ID", style="cyan", no_wrap=True)
        table.add_column("Name", style="green")
        table.add_column("Status", style="bold")
        table.add_column("Next Run", style="yellow")
        table.add_column("Trigger", style="dim")

        for task in tasks:
            status_color = "green" if task.is_active else "red"
            next_run = (
                task.next_run_time.strftime("%Y-%m-%d %H:%M:%S")
                if task.next_run_time
                else "Not scheduled"
            )

            table.add_row(
                task.job_id,
                task.name or task.job_id,
                (
                    f"[{status_color}]{'Active' if task.is_active else 'Paused'}"
                    f"[/{status_color}]"
                ),
                next_run,
                task.trigger_type or "Unknown"
            )

        console.print(table)
        rprint(f"\n[cyan]Total jobs:[/cyan] {len(tasks)}")

    except Exception as e:
        rprint(f"[red]Failed to list jobs:[/red] {e}")
        raise typer.Exit(1)


async def _get_scheduled_tasks() -> list[ScheduledTask]:
    """Get list of scheduled tasks from the scheduler."""
    manager = ScheduledTaskManager()
    return await manager.list_tasks()


if __name__ == "__main__":
    app()
{%- endif -%}