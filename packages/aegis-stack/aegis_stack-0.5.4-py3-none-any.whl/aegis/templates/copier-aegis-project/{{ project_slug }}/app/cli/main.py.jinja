"""
Main CLI application entry point.

Command-line interface for {{ project_slug }} management tasks.
"""

import asyncio
import importlib
import inspect
import sys
from typing import TYPE_CHECKING

import click
import typer

from app.cli import docs, health

if TYPE_CHECKING:
    pass

app = typer.Typer(
    name="{{ project_slug }}",
    help="{{ project_slug }} management CLI",
    no_args_is_help=True,
)

# Register sub-commands
app.add_typer(health.app, name="health")
app.add_typer(docs.app, name="docs")

# Conditionally register load-test command if worker components are available
try:
    load_test_module = importlib.import_module("app.cli.load_test")
    app.add_typer(load_test_module.app, name="load-test")
except ImportError:
    # Worker components not available, skip load-test commands
    pass

# Conditionally register tasks command if scheduler components are available
try:
    tasks_module = importlib.import_module("app.cli.tasks")
    app.add_typer(tasks_module.app, name="tasks")
except (ImportError, AttributeError):
    # Scheduler components not available or tasks module incomplete, skip tasks commands
    pass

# Conditionally register auth command if auth service is available
try:
    auth_module = importlib.import_module("app.cli.auth")
    app.add_typer(auth_module.app, name="auth")
except ImportError:
    # Auth service not available, skip auth commands
    pass

# Conditionally register ai command if ai service is available
try:
    ai_module = importlib.import_module("app.cli.ai")
    app.add_typer(ai_module.app, name="ai")
except ImportError:
    # AI service not available, skip ai commands
    pass

# Conditionally register comms command if comms service is available
try:
    comms_module = importlib.import_module("app.cli.comms")
    app.add_typer(comms_module.app, name="comms")
except ImportError:
    # Comms service not available, skip comms commands
    pass

# Conditionally register rag command if ai_rag is enabled
try:
    rag_module = importlib.import_module("app.cli.rag")
    app.add_typer(rag_module.app, name="rag")
except ImportError:
    # RAG not available, skip rag commands
    pass

# Conditionally register llm command if ai service is available
try:
    llm_module = importlib.import_module("app.cli.llm")
    app.add_typer(llm_module.app, name="llm")
except ImportError:
    # LLM ETL service not available, skip llm commands
    pass


def main() -> None:
    """Entry point for the CLI application."""
    try:
        result = app(standalone_mode=False)
        # Handle async commands - standalone_mode=False returns coroutines unawaited
        if inspect.iscoroutine(result):
            asyncio.run(result)
    except click.exceptions.UsageError as e:
        # Show help automatically on usage errors instead of just "try --help"
        if e.ctx is not None:
            click.echo(e.ctx.get_help())
            click.echo()
        click.echo(f"Error: {e.format_message()}", err=True)
        sys.exit(2)
    except click.exceptions.Abort:
        # User cancelled (e.g., Ctrl+C)
        sys.exit(1)
    except click.exceptions.Exit as e:
        # Normal exit requested (e.g., after showing error message)
        sys.exit(e.exit_code)
    except SystemExit as e:
        # Re-raise system exits (normal exit codes)
        raise


if __name__ == "__main__":
    main()
