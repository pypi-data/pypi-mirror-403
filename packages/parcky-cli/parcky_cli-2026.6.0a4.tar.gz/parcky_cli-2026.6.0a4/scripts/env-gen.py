#!/usr/bin/env python3
"""
Environment file generator for AI CLI.

Generates a .env file with default values for provider-agnostic configuration.
"""

import sys
from pathlib import Path

SCRIPT_DIR = Path(__file__).parent
PROJECT_ROOT = SCRIPT_DIR.parent
sys.path.insert(0, str(PROJECT_ROOT / "src"))


def generate_env_content(api_key: str = "") -> str:
    """Generate the .env file content."""
    lines = [
        "# ============================================",
        "# AI CLI Configuration",
        "# Generated by scripts/env-gen.py",
        "# ============================================",
        "",
        "# --------------------------------------------",
        "# AI Service Configuration",
        "# --------------------------------------------",
    ]

    ai_entries = [
        ("AI_HOST", "google", "AI provider host (google, openai, anthropic, local)"),
        ("AI_MODEL", "gemini-2.0-flash", "AI model name (provider-specific)"),
        ("AI_API_KEY", api_key, "API key for the selected provider"),
        ("AI_BASE_URL", "", "Base URL for local or gateway providers"),
        ("AI_TEMPERATURE", "0.7", "AI temperature (0.0-2.0)"),
        ("AI_MAX_TOKENS", "", "Maximum tokens for AI response"),
        ("AI_CACHE_ENABLED", "true", "Enable AI response cache"),
        ("AI_MAX_CONTEXT_CHARS", "35000", "Maximum context size (characters)"),
    ]

    for key, default, description in ai_entries:
        lines.append(f"# {description}")
        value = default if default is not None else ""
        lines.append(f"{key}={value}")
        lines.append("")

    lines.append("# --------------------------------------------")
    lines.append("# Legacy aliases (optional)")
    lines.append("# --------------------------------------------")
    lines.append("# GEMINI_API_KEY=  # Alias for AI_API_KEY when AI_HOST=google")
    lines.append("# MODEL_NAME=      # Alias for AI_MODEL")
    lines.append("")

    lines.append("# --------------------------------------------")
    lines.append("# Git Configuration")
    lines.append("# --------------------------------------------")

    git_entries = [
        ("GIT_MAX_DIFF_SIZE", "10000", "Maximum diff size for AI analysis"),
        ("GIT_DEFAULT_BRANCH", "main", "Default git branch name"),
        ("GIT_AUTO_PUSH", "true", "Auto push commits by default"),
    ]
    for key, default, description in git_entries:
        lines.append(f"# {description}")
        lines.append(f"{key}={default}")
        lines.append("")

    lines.append("# --------------------------------------------")
    lines.append("# Application Configuration")
    lines.append("# --------------------------------------------")

    app_entries = [
        ("DEBUG", "false", "Enable debug mode"),
        ("LOG_LEVEL", "INFO", "Logging level (DEBUG, INFO, WARNING, ERROR)"),
    ]
    for key, default, description in app_entries:
        lines.append(f"# {description}")
        lines.append(f"{key}={default}")
        lines.append("")

    return "\n".join(lines)


def get_current_api_key(config_path: Path) -> str:
    """Read the current API key from an existing config file."""
    from ai_cli.config.writer import read_env_value

    if not config_path.exists():
        return ""

    return read_env_value(config_path, "AI_API_KEY") or read_env_value(
        config_path, "GEMINI_API_KEY"
    )


def set_api_key(api_key: str, global_config: bool = True) -> None:
    """Set or update the API key in the config file."""
    from ai_cli.config.paths import get_global_env_path, get_local_env_path
    from ai_cli.config.writer import set_env_value

    if global_config:
        config_path = get_global_env_path()
        config_path.parent.mkdir(parents=True, exist_ok=True)
    else:
        config_path = get_local_env_path()

    if config_path.exists():
        set_env_value(config_path, "AI_API_KEY", api_key)
        print(f"‚úÖ Updated API key in {config_path}")
        return

    content = generate_env_content(api_key)
    config_path.write_text(content)
    print(f"‚úÖ Generated {config_path} with API key")


def interactive_setup() -> None:
    """Run interactive setup to configure ai-cli."""
    print("ü§ñ AI CLI Setup")
    print("=" * 40)
    print()

    from ai_cli.config.paths import get_global_env_path

    global_path = get_global_env_path()
    current_key = get_current_api_key(global_path)

    if current_key:
        masked_key = current_key[:8] + "..." + current_key[-4:] if len(current_key) > 12 else "***"
        print(f"Current API key: {masked_key}")
        print()
        response = input("Update API key? [y/N]: ").strip().lower()
        if response != "y":
            print("No changes made.")
            return

    print()
    print("Get your API key from your provider.")
    print()

    api_key = input("Enter your AI_API_KEY: ").strip()

    if not api_key:
        print("‚ùå No API key provided. Aborted.")
        sys.exit(1)

    set_api_key(api_key, global_config=True)
    print()
    print("üéâ Setup complete! You can now use ai-cli from any project.")
    print()
    print("Quick start:")
    print("  ai-cli smart-commit      # AI-powered commit")
    print("  ai-cli create-pr         # Create PR from branch")
    print("  ai-cli --help            # See all commands")


def main():
    """Main function to generate the .env file."""
    import argparse

    parser = argparse.ArgumentParser(
        description="Generate .env file with default configuration values"
    )
    parser.add_argument(
        "-o",
        "--output",
        type=str,
        default=".env",
        help="Output file path (default: .env)",
    )
    parser.add_argument(
        "-f", "--force", action="store_true", help="Overwrite existing file without prompting"
    )
    parser.add_argument(
        "--stdout", action="store_true", help="Print to stdout instead of writing to file"
    )
    parser.add_argument(
        "--global",
        dest="global_config",
        action="store_true",
        help="Generate in global config directory (~/.config/ai-cli/)",
    )
    parser.add_argument(
        "--api-key",
        type=str,
        help="Set the AI_API_KEY directly",
    )
    parser.add_argument(
        "--setup",
        action="store_true",
        help="Run interactive setup wizard",
    )

    args = parser.parse_args()

    # Interactive setup mode
    if args.setup:
        interactive_setup()
        return

    # Direct API key setting
    if args.api_key:
        set_api_key(args.api_key, global_config=args.global_config)
        return

    # Generate content
    content = generate_env_content()

    if args.global_config:
        from ai_cli.config.paths import get_global_env_path

        output_path = get_global_env_path()
        output_path.parent.mkdir(parents=True, exist_ok=True)
    else:
        output_path = Path(args.output)

    if args.stdout:
        print(content)
        return

    if output_path.exists() and not args.force:
        response = input(f"File '{output_path}' already exists. Overwrite? [y/N]: ")
        if response.lower() != "y":
            print("Aborted.")
            sys.exit(1)

    output_path.write_text(content)
    print(f"‚úÖ Generated {output_path}")
    print("üìù Edit the file and set your AI_API_KEY")


if __name__ == "__main__":
    main()
