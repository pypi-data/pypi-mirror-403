from __future__ import annotations

import dataclasses
import datetime
import uuid

from django.core.files.base import ContentFile
from django.core.files.storage import storages

from health_check.backends import HealthCheck
from health_check.deprecation import deprecated
from health_check.exceptions import ServiceUnavailable


@dataclasses.dataclass
class StorageHealthCheck(HealthCheck):
    """
    Check file storage backends by saving, reading, and deleting a test file.

    Args:
        alias (str): The alias of the storage backend to check. Defaults to "default".

    """

    alias: str = "default"

    def get_storage(self):
        return storages[self.storage_alias if hasattr(self, "storage_alias") else self.alias]

    def get_file_name(self):
        return f"health_check_storage_test/test-{uuid.uuid4()}.txt"

    def get_file_content(self):
        return f"# generated by health_check.Storage at {datetime.datetime.now().timestamp()}".encode()

    def check_save(self, file_name, file_content):
        storage = self.get_storage()
        # save the file
        file_name = storage.save(file_name, ContentFile(content=file_content))
        # read the file and compare
        if not storage.exists(file_name):
            raise ServiceUnavailable("File does not exist")
        with storage.open(file_name) as f:
            if not f.read() == file_content:
                raise ServiceUnavailable("File content does not match")
        return file_name

    def check_delete(self, file_name):
        storage = self.get_storage()
        # delete the file and make sure it is gone
        storage.delete(file_name)
        if storage.exists(file_name):
            raise ServiceUnavailable("File was not deleted")

    def check_status(self):
        try:
            # write the file to the storage backend
            file_name = self.get_file_name()
            file_content = self.get_file_content()
            file_name = self.check_save(file_name, file_content)
            self.check_delete(file_name)
            return True
        except ServiceUnavailable as e:
            raise e
        except Exception as e:
            raise ServiceUnavailable("Unknown exception") from e


@deprecated(
    "`DefaultFileStorageHealthCheck` is deprecated: use `health_check.Storage` instead. Action: remove legacy storage sub-apps from `INSTALLED_APPS` and add `health_check.Storage` to your `HealthCheckView.checks`. See migration guide: https://codingjoe.dev/django-health-check/migrate-to-v4/ (docs/migrate-to-v4.md)."
)
class DefaultFileStorageHealthCheck(StorageHealthCheck):
    alias = "default"
