# AICoding-Backend 开发守则

## 项目概述

- **项目类型**：MCP (Model Context Protocol) 服务器
- **主要功能**：为 AI 编程助手提供后端工具和服务
- **技术栈**：Python 3.13+, FastMCP, Pydantic
- **核心目的**：通过 MCP 协议暴露 AI 编程工具，支持 PRP 生成、项目规则初始化、思维处理等功能

## 项目架构规范

### 目录结构强制要求

- **`aicoding_backend/`** - 主要代码目录，所有核心功能必须在此目录下
- **`aicoding_backend/main.py`** - MCP 服务器入口点，所有工具必须在此注册
- **`aicoding_backend/tools/`** - 工具实现模块，新工具必须在此目录创建
- **`aicoding_backend/prompts/`** - 提示词模板存储，命名必须与工具对应
- **`aicoding_backend/utils/`** - 通用工具函数，文件操作、日志等
- **`PRPs/`** - 产品需求提示文档存储目录
- **`templates/`** - 模板文件存储目录
- **`.joycode/rules/`** - 项目规范文件存储目录

### 文件命名规范

- **工具文件**：`aicoding_backend/tools/{tool_name}.py`
- **提示词文件**：`aicoding_backend/prompts/{tool_name}.py` 或 `{tool_name}.md`
- **PRP 文件**：`PRPs/{feature_name}.md`
- **规范文件**：`.joycode/rules/ProjectInfo.mdc`

## MCP 工具开发规范

### 工具注册强制流程

1. **在 `main.py` 中定义参数模型**
   ```python
   class ToolNameParam(BaseModel):
       """工具参数结构"""
       param_name: str = Field(..., description="参数描述")
   ```

2. **使用 `@mcp.tool()` 装饰器注册工具**
   ```python
   @mcp.tool("tool_name")
   async def handle_tool_name(args: ToolNameParam) -> str:
       """工具描述"""
   ```

3. **必须包含错误处理**
   ```python
   try:
       # 工具逻辑
       return result
   except Exception as error:
       return f"❌ 工具执行失败: {str(error)}"
   ```

### 参数验证规范

- **必须使用 Pydantic BaseModel 定义参数结构**
- **必须使用 Field() 提供参数描述和示例**
- **必须验证文件路径存在性（使用 `file_exists()` 函数）**
- **必须处理路径相关的异常**

### 工具响应格式

- **成功响应**：返回格式化的字符串或 JSON
- **失败响应**：必须以 `❌` 开头，包含具体错误信息
- **长文本响应**：使用 `generate_prompt()` 函数格式化模板

## 关键文件交互规范

### 新增工具时必须修改的文件

1. **`main.py`** - 添加参数模型类和工具注册函数
2. **`aicoding_backend/tools/{tool_name}.py`** - 创建工具实现文件
3. **`aicoding_backend/prompts/{tool_name}.py`** - 创建对应的提示词模块

### 修改工具时必须检查的文件

1. **参数结构变更** - 检查所有调用该工具的地方
2. **提示词模板变更** - 检查 `prompts/` 目录下对应文件
3. **工具描述变更** - 更新 `main.py` 中的工具注册信息

### 文件依赖关系

- **`main.py`** 依赖 `utils/` 和 `prompts/` 模块
- **工具文件** 必须导入 `utils/` 中的通用函数
- **提示词文件** 必须提供 `get_{tool_name}_prompt()` 函数

## 代码实现规范

### 异步函数要求

- **所有 MCP 工具函数必须是异步函数**
- **文件读取操作必须使用 `await read_file()`**
- **必须正确处理异步异常**

### 导入规范

- **从 `..utils` 导入通用工具函数**
- **从 `..prompts` 导入提示词函数**
- **使用相对导入，避免绝对路径**

### 错误处理规范

- **必须使用 try-except 包装主要逻辑**
- **必须记录详细的错误信息**
- **必须返回用户友好的错误消息**

## 提示词管理规范

### 提示词文件结构

- **Markdown 文件**：直接存储提示词内容
- **Python 文件**：提供 `get_{tool_name}_prompt()` 函数

### 提示词内容要求

- **必须包含 `**[AI Agent Action]**` 指令**
- **必须指定工具调用流程**
- **必须包含 `log_report` 工具调用指令**
- **必须使用结构化的 Markdown 格式**

### 模板变量规范

- **使用 `$VARIABLE` 格式定义模板变量**
- **使用 `generate_prompt()` 函数替换变量**
- **必须验证所有变量都有对应的值**

## 日志和监控规范

### 日志记录要求

- **所有工具执行必须调用 `log_report` 工具**
- **必须记录工具类型和工作目录**
- **必须使用 `log_data()` 函数记录使用数据**

### 监控指标

- **工具调用次数**
- **工具执行成功率**
- **错误类型统计**

## AI 决策规范

### 工具选择优先级

1. **直接功能匹配** - 优先使用专门的工具
2. **通用工具补充** - 使用 `process_thought` 等通用工具
3. **组合工具使用** - 按照工具间的依赖关系组合使用

### 错误处理决策

1. **文件不存在** - 返回明确的文件路径错误
2. **参数验证失败** - 返回参数格式要求
3. **工具执行异常** - 记录日志并返回用户友好消息

### 模糊请求处理

1. **使用 `process_thought` 工具分析需求**
2. **基于项目结构推断用户意图**
3. **提供具体的实现建议**

## 严格禁止事项

### 代码修改禁忌

- **禁止直接修改 `main.py` 中的 MCP 服务器配置**
- **禁止删除现有的工具注册函数**
- **禁止修改 Pydantic 模型的必需字段**
- **禁止在工具函数中使用同步 I/O 操作**

### 文件操作禁忌

- **禁止在 `aicoding_backend/` 外创建核心功能文件**
- **禁止直接操作用户文件系统（除指定目录外）**
- **禁止创建不符合命名规范的文件**

### 安全禁忌

- **禁止执行用户提供的任意代码**
- **禁止访问系统敏感文件**
- **禁止在日志中记录敏感信息**

## 开发流程规范

### 新工具开发流程

1. **在 `main.py` 中定义参数模型**
2. **创建 `tools/{tool_name}.py` 实现文件**
3. **创建 `prompts/{tool_name}.py` 提示词文件**
4. **在 `main.py` 中注册工具函数**
5. **测试工具功能和错误处理**

### 工具修改流程

1. **分析影响范围**
2. **更新参数模型（如需要）**
3. **修改工具实现**
4. **更新提示词模板**
5. **测试所有相关功能**

### 版本发布流程

1. **更新 `pyproject.toml` 中的版本号**
2. **确保所有工具正常运行**
3. **更新文档和规范**
4. **提交代码变更**

## 质量保证规范

### 代码质量要求

- **所有函数必须有类型注解**
- **所有类必须有文档字符串**
- **所有异常必须被正确处理**
- **所有工具必须有使用示例**

### 测试要求

- **每个工具必须能独立运行**
- **必须测试错误处理逻辑**
- **必须验证参数验证功能**

### 文档要求

- **每个工具必须有清晰的描述**
- **每个参数必须有详细说明**
- **必须提供使用示例和最佳实践**