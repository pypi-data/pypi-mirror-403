[build-system]
requires = ["setuptools>=64", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "vesuvius"
dynamic = ["version"]
readme = "README.md"
requires-python = ">=3.10,<3.13"
classifiers = [
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "License :: OSI Approved :: MIT License",
    "Operating System :: OS Independent",
    "Intended Audience :: Developers",
    "Intended Audience :: Science/Research",
    "Topic :: Software Development :: Libraries",
    "Topic :: Scientific/Engineering",
]
# Minimal core dependencies required by the Volume class.
dependencies = [
    "numpy>=2.0.2",
    "pillow>=11.3.0",
    "pynrrd>=1.1.3",
    "requests>=2.32.5",
    "pyyaml>=6.0.2",
    "fsspec>=2025.9.0",
    "numcodecs>=0.12.1",
    "zarr>=2,<3",
    "s3fs>=2025.9.0",
    "cachetools>=6.2.4",
]

[project.optional-dependencies]
# Minimal install explicitly named
volume-only = [
    "numpy>=2.0.2",
    "pillow>=11.3.0",
    "pynrrd>=1.1.3",
    "requests>=2.32.5",
    "pyyaml>=6.0.2",
    "fsspec>=2025.9.0",
    "numcodecs>=0.12.1",
    "zarr>=2,<3",
    "s3fs>=2025.9.0",
]
# Machine-learning & training stack
models = [
    "torch>=2.6,<2.9",
    "pytorch-lightning>=2.5.5",
    "pytorch-optimizer>=3.8.0",
    "monai>=1.5.1",
    "huggingface-hub>=0.35.0",
    "timm>=1.0.20",
    "dynamic-network-architectures>=0.3.1",
    "nnunetv2",
    "numba>=0.60.0",
    "batchgenerators>=0.25.1",
    "batchgeneratorsv2",
    "einops>=0.8.1",
    "fft-conv-pytorch>=1.2.0",
    "fvcore>=0.1.5.post20221221",
    "scikit-image>=0.24.0",
    "scipy>=1.13.1",
    "pandas>=2.3.2",
    "tensorstore>=0.1.69",
    "tqdm>=4.67.1",
    "typed-argument-parser>=1.11.0",
    "wandb[media]>=0.22.0",
    "psutil>=7.1.0",

    # Data pipeline / I/O and compression
    "aiohttp>=3.12.15",
    "blosc2>=2.5.1",
    "dask>=2024.8.0",
    "dask-image>=2024.5.3",
    "lxml>=6.0.2",
    "cucim-cu13>=25.12",
]
# Rendering and geometry utilities
render = [
    "open3d>=0.18,<0.19",
    "trimesh>=4.8.2",
    "opencv-python-headless>=4.11.0.86",
    "opencv-contrib-python>=4.11.0.86",
    "libigl>=2.6.1",
    "alphashape>=1.3.1",
    "connected-components-3d>=3.24.0",
    "simpleitk>=2.5.2",
    "tifffile>=2024.8.30",
]
# Graphical user interface and visualisation
gui = [
    "napari>=0.5.6",
    "magicgui>=0.10.1",
    "magic-class>=0.7.17",
    "pyqt6",
]

# Notebooks
notebooks = [
    "jupyterlab>=4",
    "ipykernel>=6",
    "matplotlib",
    "nest-asyncio>=1.6.0",
]

tests = ["pytest>=8.4.2"]

# Convenience alias to install everything
all = [
    # Machine-learning & training stack
    "torch>=2.6,<2.9",
    "pytorch-lightning>=2.5.5",
    "pytorch-optimizer>=3.8.0",
    "monai>=1.5.1",
    "huggingface-hub>=0.35.0",
    "timm>=1.0.20",
    "numba>=0.60.0",
    "dynamic-network-architectures>=0.3.1",
    "nnunetv2",
    "batchgenerators>=0.25.1",
    "batchgeneratorsv2",
    "einops>=0.8.1",
    "fft-conv-pytorch>=1.2.0",
    "fvcore>=0.1.5.post20221221",
    "scikit-image>=0.24.0",
    "scipy>=1.13.1",
    "pandas>=2.3.2",
    "tensorstore>=0.1.69",
    "tqdm>=4.67.1",
    "typed-argument-parser>=1.11.0",
    "wandb[media]>=0.22.0",
    "psutil>=7.1.0",

    # Rendering and geometry utilities
    "open3d>=0.18,<0.19",
    "trimesh>=4.8.2",
    "opencv-python-headless>=4.11.0.86",
    "opencv-contrib-python>=4.11.0.86",
    "libigl>=2.6.1",
    "alphashape>=1.3.1",
    "connected-components-3d>=3.24.0",
    "simpleitk>=2.5.2",
    "tifffile>=2024.8.30",

    # GUI and visualisation
    "napari>=0.5.6",
    "magicgui>=0.10.1",
    "magic-class>=0.7.17",
    "pyqt6",

    "nest-asyncio>=1.6.0",

    # Development / build tooling
    "build",
    "pybind11>=3.0.1",
    "setuptools>=80.9.0",
    "wheel",

    # Tests
    "pytest>=8.4.2",

    # Data pipeline / I/O and compression
    "aiohttp>=3.12.15",
    "blosc2>=2.5.1",
    "dask>=2024.8.0",
    "dask-image>=2024.5.3",
    "lxml>=6.0.2",
]

[project.urls]
Homepage = "https://github.com/ScrollPrize/villa"

[project.scripts]
"vesuvius.accept_terms" = "vesuvius.install.accept_terms:main"
"vesuvius.predict" = "vesuvius.models.run.inference:main"
"vesuvius.blend_logits" = "vesuvius.models.run.blending:main"
"vesuvius.finalize_outputs" = "vesuvius.models.run.finalize_outputs:main"
"vesuvius.inference_pipeline" = "vesuvius.models.run.vesuvius_pipeline:run_pipeline"
"vesuvius.compute_st" = "vesuvius.structure_tensor.run_create_st:main"
"vesuvius.napari_trainer" = "vesuvius.napari_trainer.main_window:main"
"vesuvius.voxelize_obj" = "vesuvius.image_proc.voxelize_objs:main"
"vesuvius.refine_labels" = "vesuvius.image_proc.edt_frangi_label:main"
"vesuvius.render_obj" = "vesuvius.rendering.mesh_to_surface:main"
"vesuvius.flatten_obj" = "vesuvius.rendering.slim_uv:main"
"vesuvius.train" = "vesuvius.models.training.train:main"

[tool.setuptools]
include-package-data = true

[tool.setuptools.package-dir]
"" = "src"

[tool.setuptools.packages.find]
where = ["src"]

[tool.setuptools.package-data]
vesuvius = ["install/configs/*.yaml"]

[tool.setuptools.cmdclass]
install = "vesuvius.install.custom_install.CustomInstallCommand"

[tool.setuptools.dynamic]
version = {attr = "vesuvius._version.VERSION"}

[tool.uv]
required-environments = [
    "sys_platform == 'linux' and platform_machine == 'aarch64'",
]

[[tool.uv.index]]
name = "nvidia"
url = "https://pypi.nvidia.com"

[tool.uv.sources]
cucim-cu13 = { index = "nvidia" }
batchgeneratorsv2 = { path = "../segmentation/models/batchgeneratorsv2" }
nnunetv2 = { path = "../segmentation/models/arch/nnunet" }
