"""Tests for diff mode functionality."""

import tempfile
from pathlib import Path
from unittest.mock import patch

from click.testing import CliRunner

from uv_workspace_codegen.main import main


def test_diff_mode_new_file():
    """Test diff mode with a new file (should show addition)."""
    runner = CliRunner()
    with tempfile.TemporaryDirectory() as temp_dir:
        workspace_dir = Path(temp_dir)

        # Create a package
        package_dir = workspace_dir / "my-package"
        package_dir.mkdir()

        pyproject_content = """
[project]
name = "my-package"

[tool.uv-workspace-codegen]
generate = true
template_type = "package"
generate_standard_pytest_step = true
"""
        with open(package_dir / "pyproject.toml", "w") as f:
            f.write(pyproject_content)

        # Run with --diff
        with patch(
            "uv_workspace_codegen.main.find_workspace_root", return_value=workspace_dir
        ):
            result = runner.invoke(main, ["--diff"])

        assert result.exit_code == 0
        assert "--- " in result.output
        assert "+++ " in result.output
        assert (
            "+# This file was automatically generated by uv-workspace-codegen"
            in result.output
        )

        # Verify file was NOT created
        workflow_path = (
            workspace_dir / ".github" / "workflows" / "package-my-package.yml"
        )
        assert not workflow_path.exists()


def test_diff_mode_modified_file():
    """Test diff mode with a modified file."""
    runner = CliRunner()
    with tempfile.TemporaryDirectory() as temp_dir:
        workspace_dir = Path(temp_dir)

        # Create a package
        package_dir = workspace_dir / "my-package"
        package_dir.mkdir()

        pyproject_content = """
[project]
name = "my-package"

[tool.uv-workspace-codegen]
generate = true
template_type = "package"
generate_standard_pytest_step = true
"""
        with open(package_dir / "pyproject.toml", "w") as f:
            f.write(pyproject_content)

        # Create existing workflow file with different content
        workflows_dir = workspace_dir / ".github" / "workflows"
        workflows_dir.mkdir(parents=True)
        workflow_path = workflows_dir / "package-my-package.yml"

        with open(workflow_path, "w") as f:
            f.write("# Old content\nname: Old Workflow\n")

        # Run with --diff
        with patch(
            "uv_workspace_codegen.main.find_workspace_root", return_value=workspace_dir
        ):
            result = runner.invoke(main, ["--diff"])

        assert result.exit_code == 0
        assert "--- " in result.output
        assert "+++ " in result.output
        assert "-# Old content" in result.output
        assert (
            "+# This file was automatically generated by uv-workspace-codegen"
            in result.output
        )

        # Verify file was NOT modified
        with open(workflow_path, "r") as f:
            content = f.read()
        assert content == "# Old content\nname: Old Workflow\n"


def test_diff_mode_no_changes():
    """Test diff mode with no changes."""
    runner = CliRunner()
    with tempfile.TemporaryDirectory() as temp_dir:
        workspace_dir = Path(temp_dir)

        # Create a package
        package_dir = workspace_dir / "my-package"
        package_dir.mkdir()

        pyproject_content = """
[project]
name = "my-package"

[tool.uv-workspace-codegen]
generate = true
template_type = "package"
generate_standard_pytest_step = true
"""
        with open(package_dir / "pyproject.toml", "w") as f:
            f.write(pyproject_content)

        # First run to generate file
        with patch(
            "uv_workspace_codegen.main.find_workspace_root", return_value=workspace_dir
        ):
            runner.invoke(main, [])

        # Run with --diff (should be empty output for diff)
        with patch(
            "uv_workspace_codegen.main.find_workspace_root", return_value=workspace_dir
        ):
            result = runner.invoke(main, ["--diff"])

        assert result.exit_code == 0
        # Should not have diff output
        assert "--- " not in result.output
        assert "+++ " not in result.output


def test_diff_mode_stale_file():
    """Test diff mode with a stale file (should not delete, but report)."""
    runner = CliRunner()
    with tempfile.TemporaryDirectory() as temp_dir:
        workspace_dir = Path(temp_dir)

        # Create a package
        package_dir = workspace_dir / "my-package"
        package_dir.mkdir()

        pyproject_content = """
[project]
name = "my-package"

[tool.uv-workspace-codegen]
generate = true
template_type = "package"
generate_standard_pytest_step = true
"""
        with open(package_dir / "pyproject.toml", "w") as f:
            f.write(pyproject_content)

        # Create a stale workflow file
        workflows_dir = workspace_dir / ".github" / "workflows"
        workflows_dir.mkdir(parents=True)
        stale_workflow_path = workflows_dir / "stale-workflow.yml"

        with open(stale_workflow_path, "w") as f:
            f.write(
                "# This file was automatically generated by uv-workspace-codegen\nname: Stale\n"
            )

        # Run with --diff
        with patch(
            "uv_workspace_codegen.main.find_workspace_root", return_value=workspace_dir
        ):
            result = runner.invoke(main, ["--diff"])

        assert result.exit_code == 0

        # Verify stale file was NOT deleted
        assert stale_workflow_path.exists()

        # Verify output says it would be removed
        assert f"Would remove stale workflow: {stale_workflow_path}" in result.output


def test_diff_mode_valid_file():
    """Test diff mode with a valid file (should not report as stale)."""
    runner = CliRunner()
    with tempfile.TemporaryDirectory() as temp_dir:
        workspace_dir = Path(temp_dir)

        # Create a package
        package_dir = workspace_dir / "my-package"
        package_dir.mkdir()

        pyproject_content = """
[project]
name = "my-package"

[tool.uv-workspace-codegen]
generate = true
template_type = "package"
generate_standard_pytest_step = true
"""
        with open(package_dir / "pyproject.toml", "w") as f:
            f.write(pyproject_content)

        # First run to generate file
        with patch(
            "uv_workspace_codegen.main.find_workspace_root", return_value=workspace_dir
        ):
            runner.invoke(main, [])

        # Run with --diff
        with patch(
            "uv_workspace_codegen.main.find_workspace_root", return_value=workspace_dir
        ):
            result = runner.invoke(main, ["--diff"])

        assert result.exit_code == 0

        # Verify output does NOT say it would be removed
        assert "Would remove stale workflow" not in result.output
