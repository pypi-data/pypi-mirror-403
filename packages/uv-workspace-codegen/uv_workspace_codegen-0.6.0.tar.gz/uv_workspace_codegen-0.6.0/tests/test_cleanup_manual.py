import shutil
from pathlib import Path
from uv_workspace_codegen.main import cleanup_stale_workflows

def test_cleanup_logic():
    # Setup test directory
    test_dir = Path("tests/tmp_cleanup_test")
    if test_dir.exists():
        shutil.rmtree(test_dir)
    test_dir.mkdir(parents=True)

    # Create a stale file (should be deleted)
    stale_file = test_dir / "stale.yml"
    with open(stale_file, "w") as f:
        f.write("# This file was automatically generated by uv-workspace-codegen\n")
        f.write("name: Stale Workflow\n")

    # Create a manual file (should be preserved)
    manual_file = test_dir / "manual.yml"
    with open(manual_file, "w") as f:
        f.write("# This is a manually created file\n")
        f.write("name: Manual Workflow\n")
        
    # Create a valid generated file (should be preserved)
    valid_file = test_dir / "valid.yml"
    with open(valid_file, "w") as f:
        f.write("# This file was automatically generated by uv-workspace-codegen\n")
        f.write("name: Valid Workflow\n")

    # Run cleanup
    generated_files = [valid_file]
    cleanup_stale_workflows(test_dir, generated_files)

    # Verify results
    assert not stale_file.exists(), "Stale file was not deleted"
    assert manual_file.exists(), "Manual file was incorrectly deleted"
    assert valid_file.exists(), "Valid generated file was incorrectly deleted"

    print("Cleanup test passed!")
    
    # Cleanup test directory
    shutil.rmtree(test_dir)

if __name__ == "__main__":
    test_cleanup_logic()
