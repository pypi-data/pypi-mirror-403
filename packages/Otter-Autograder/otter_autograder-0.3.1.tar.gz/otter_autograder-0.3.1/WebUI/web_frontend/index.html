<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Grading Interface</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="/css/style.css">

    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- MathJax for rendering mathematical equations -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>
<body>
    <!-- Overlay notification -->
    <div id="notification-overlay" class="notification-overlay" style="display: none;">
        <div class="notification-content">
            <p id="notification-message"></p>
            <button id="notification-ok" class="btn btn-primary">OK</button>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 8px; padding: 30px; max-width: 500px; width: 90%;">
            <h2 style="margin-top: 0;">Change Password</h2>

            <form id="change-password-form">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                        Current Password: *
                    </label>
                    <input type="password" id="current-password" required style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--gray-300);">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                        New Password: *
                    </label>
                    <input type="password" id="new-password" required minlength="8" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--gray-300);">
                    <small style="color: var(--gray-700);">Minimum 8 characters</small>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                        Confirm New Password: *
                    </label>
                    <input type="password" id="confirm-new-password" required minlength="8" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--gray-300);">
                </div>

                <div id="change-password-error" class="error-message" style="display: none; margin-bottom: 15px;"></div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" id="cancel-password-change" class="btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Autograding Modal -->
    <div id="autograding-modal" class="instructor-only" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 8px; padding: 30px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-top: 0;">Autograding Setup</h2>

            <div id="autograding-extract-phase" style="display: none;">
                <p style="color: var(--gray-700); margin-bottom: 20px;">
                    Extracting question text from problem image...
                </p>
                <div class="progress-bar" style="height: 8px;">
                    <div style="width: 100%; height: 100%; background: var(--primary-color); animation: pulse 1.5s infinite;"></div>
                </div>
            </div>

            <div id="autograding-verify-phase" style="display: none;">
                <p style="color: var(--gray-700); margin-bottom: 15px;">
                    Please verify the extracted question text. Make any necessary corrections before proceeding.
                </p>

                <label style="display: block; margin-bottom: 20px;">
                    <strong>Extracted Question:</strong>
                    <textarea id="autograding-question-text" rows="10" style="width: 100%; padding: 10px; font-family: inherit; border: 1px solid var(--gray-300); border-radius: 4px; margin-top: 5px;"></textarea>
                </label>

                <div style="background: #f0fdf4; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #86efac;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: var(--gray-800);">üìã Grading Rubric (Optional)</strong>
                        <button id="generate-rubric-btn" class="btn btn-small" style="font-size: 13px; padding: 5px 12px;">Generate with AI</button>
                    </div>
                    <div id="rubric-loading" style="display: none; padding: 10px; text-align: center; color: var(--gray-600);">
                        <div style="animation: pulse 1.5s infinite;">Generating rubric from your graded examples...</div>
                    </div>
                    <div id="rubric-table-container" style="margin-top: 10px; display: none;">
                        <table style="width: 100%; border-collapse: collapse; background: white;">
                            <thead>
                                <tr style="background: var(--gray-100);">
                                    <th style="padding: 8px; text-align: left; border: 1px solid var(--gray-300); width: 80px;">Points</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid var(--gray-300);">Description</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid var(--gray-300); width: 60px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rubric-table-body"></tbody>
                        </table>
                        <button id="add-rubric-row-btn" class="btn btn-small" style="margin-top: 10px; font-size: 13px; padding: 5px 12px;">+ Add Row</button>
                    </div>
                    <div id="rubric-placeholder" style="padding: 20px; text-align: center; color: var(--gray-600); border: 2px dashed var(--gray-300); border-radius: 4px; margin-top: 10px;">
                        Click "Generate with AI" to create a rubric based on your manually graded examples
                    </div>
                    <small style="color: var(--gray-600); display: block; margin-top: 5px;">
                        ‚ÑπÔ∏è The rubric will be used to grade all student answers consistently. AI can generate one based on 3-5 manually graded examples.
                    </small>
                </div>

                <div style="background: #eff6ff; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 14px; color: var(--gray-700);">
                        <strong>‚ÑπÔ∏è How Autograding Works:</strong><br>
                        1. This question and rubric will be used for all submissions of this problem<br>
                        2. Each student's handwritten answer will be extracted<br>
                        3. AI will grade each answer using the rubric and suggest a score<br>
                        4. You'll review and approve AI suggestions before finalizing
                    </p>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="autograding-cancel-btn" class="btn">Cancel</button>
                    <button id="autograding-confirm-btn" class="btn btn-primary">Start Autograding</button>
                </div>
            </div>

            <div id="autograding-progress-phase" style="display: none;">
                <p style="color: var(--gray-700); margin-bottom: 15px;">
                    Autograding in progress... This may take a few minutes depending on the number of submissions.
                </p>

                <div id="autograding-progress-message" style="margin: 10px 0; font-size: 14px; color: var(--gray-700);"></div>

                <div class="progress-bar" style="height: 20px; margin-bottom: 10px;">
                    <div id="autograding-progress-bar" class="progress-bar-fill"></div>
                </div>

                <div style="text-align: center; margin-top: 15px;">
                    <small style="color: var(--gray-600);">Processing <span id="autograding-current">0</span> of <span id="autograding-total">0</span> submissions</small>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="header-content" style="align-items: center;">
                <h1 style="margin: 0;">Web Grading Interface <span id="session-info" style="font-size: 0.6em; color: var(--gray-600); font-weight: normal;"></span></h1>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="user-display"></div>
                    <button id="home-btn" class="btn btn-secondary" style="display: none;">‚Üê Home</button>
                </div>
            </div>
        </header>

        <main>
            <!-- Session Selection/Creation -->
            <section id="session-section" class="section active">
                <h2>Start Grading Session</h2>

                <!-- AI Provider Selection -->
                <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <strong style="min-width: 180px;">ü§ñ AI Provider for Name Extraction:</strong>
                        <select id="global-ai-provider-select" style="flex: 1; max-width: 300px; padding: 8px; border-radius: 4px; border: 1px solid #d1d5db;">
                            <option value="anthropic" selected>Anthropic (Claude) - Default</option>
                            <option value="openai">OpenAI (GPT)</option>
                            <option value="ollama">Ollama (Local)</option>
                        </select>
                    </label>
                    <small style="display: block; margin-top: 8px; color: var(--gray-600);">
                        ‚ÑπÔ∏è This setting applies to all exam processing. Choose which AI model to use for extracting student names from exam headers and other AI-powered features.
                    </small>
                </div>

                <!-- Existing Sessions -->
                <div id="existing-sessions">
                    <h3>Recent Sessions</h3>
                    <div id="session-list"></div>
                </div>

                <!-- New Session Form -->
                <div id="new-session-form" class="instructor-only" style="display: none;">
                    <h3>Create New Session</h3>
                    <form id="session-form">
                        <label>
                            Canvas Environment:
                            <select id="canvas-env-new" required>
                                <option value="false">Development (Beta/Test)</option>
                                <option value="true">Production</option>
                            </select>
                        </label>

                        <label>
                            Course:
                            <select id="course-select" required>
                                <option value="">Loading courses...</option>
                            </select>
                        </label>
                        <div id="course-info" class="info-box"></div>

                        <label>
                            Assignment:
                            <select id="assignment-select" required disabled>
                                <option value="">Select a course first</option>
                            </select>
                        </label>
                        <div id="assignment-info" class="info-box"></div>

                        <label>
                            Canvas Points Override (optional):
                            <input type="number" id="canvas-points-input" step="0.5" min="0" placeholder="Leave blank to use assignment points">
                        </label>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Create Session</button>
                            <button type="button" id="cancel-session-btn" class="btn">Cancel</button>
                        </div>
                    </form>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="new-session-btn" class="btn btn-primary instructor-only">+ Create New Session</button>
                    <button id="import-session-btn" class="btn btn-secondary instructor-only">Import Session</button>
                    <button id="manage-users-btn" class="btn btn-secondary instructor-only">Manage Users</button>
                </div>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
            </section>

            <!-- User Management Section -->
            <section id="user-management-section" class="section instructor-only">
                <h2>User Management</h2>
                <p style="color: var(--gray-700); margin-bottom: 20px;">
                    Create and manage instructor and TA accounts. TAs can only access grading sessions that are explicitly assigned to them.
                </p>

                <!-- Create User Form -->
                <div id="create-user-form" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0;">Create New User</h3>
                    <p style="color: var(--gray-700); margin-bottom: 15px;">
                        A random password will be generated for the new user. Make sure to copy it and share it with them securely.
                    </p>
                    <form id="user-form">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <label>
                                Username: *
                                <input type="text" id="user-username" required placeholder="e.g., jsmith">
                            </label>

                            <label>
                                Role: *
                                <select id="user-role" required>
                                    <option value="ta">TA</option>
                                    <option value="instructor">Instructor</option>
                                </select>
                            </label>
                        </div>

                        <div id="user-form-error" class="error-message" style="display: none; margin-top: 15px;"></div>

                        <!-- Success message with password -->
                        <div id="user-created-success" style="display: none; margin-top: 15px; padding: 15px; background: #d1fae5; border: 1px solid #6ee7b7; border-radius: 6px;">
                            <p style="margin: 0 0 10px 0; color: #065f46; font-weight: 600;">User created successfully!</p>
                            <p style="margin: 0 0 10px 0; color: #065f46;">
                                Generated password: <strong id="generated-password" style="font-family: monospace; font-size: 16px;"></strong>
                            </p>
                            <button type="button" id="copy-password-btn" class="btn btn-small btn-success">Copy Password</button>
                            <p style="margin: 10px 0 0 0; color: #065f46; font-size: 13px;">
                                <strong>Important:</strong> Copy this password now. It cannot be retrieved later.
                            </p>
                        </div>

                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn btn-primary" id="create-user-submit-btn">Create User</button>
                            <button type="button" id="cancel-user-btn" class="btn">‚Üê Back to Sessions</button>
                        </div>
                    </form>
                </div>

                <!-- Users List -->
                <div id="users-list-container" style="background: white; padding: 20px; border-radius: 8px;">
                    <h3 style="margin-top: 0;">Existing Users</h3>
                    <div id="users-list"></div>
                </div>
            </section>

            <!-- Upload Section -->
            <section id="upload-section" class="section instructor-only">
                <h2>Upload Exams</h2>
                <div id="initial-upload-message" style="margin-bottom: 15px; padding: 10px; background: #eff6ff; border-radius: 6px; display: none;">
                    <strong>Note:</strong> You can upload additional exams later if students submit late.
                </div>
                <div id="upload-area" class="upload-area">
                    <p>Drag and drop exam files here, or click to select</p>
                    <input type="file" id="file-input" multiple accept=".pdf,.zip">
                </div>
                <div id="upload-progress-container" style="display: none; margin: 20px 0;">
                    <div id="upload-status" style="margin-bottom: 10px; font-weight: 500; color: var(--gray-700);"></div>
                    <div id="upload-progress" class="progress-bar" style="height: 24px;">
                        <div id="upload-progress-fill" class="progress-bar-fill" style="width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;"></div>
                    </div>
                </div>
            </section>

            <!-- Name Matching Section -->
            <section id="matching-section" class="section">
                <h2>Name Matching</h2>
                <div id="matching-progress" style="margin-bottom: 20px;">
                    <div class="progress-bar" style="height: 20px; margin-bottom: 10px;">
                        <div id="matching-progress-fill" class="progress-bar-fill" style="width: 0%"></div>
                    </div>
                    <div id="matching-progress-text" style="text-align: center; font-weight: 500; color: var(--gray-700);"></div>
                </div>
                <div id="unmatched-list"></div>
            </section>

            <!-- Grading Section -->
            <section id="grading-section" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <h2 style="margin: 0;">Grade Problems</h2>
                        <label style="display: flex; gap: 5px; align-items: center; margin: 0;">
                            Problem:
                            <select id="problem-select"></select>
                        </label>
                        <label style="display: flex; gap: 5px; align-items: center; margin: 0;">
                            Max Points:
                            <select id="max-points-input" style="width: 60px;" title="Max points for this problem">
                                <option value="">-</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                        </label>
                    </div>
                    <div class="progress-info">
                        <span id="grading-progress">0 / 0</span>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <div class="overall-progress-bar" style="margin-bottom: 5px; position: relative;">
                            <!-- Yellow background layer: shows detected blank problems -->
                            <div id="blank-problems-bar" class="blank-problems-bar" style="width: 0%"></div>
                            <!-- Red background layer: shows remaining work in current problem -->
                            <div id="current-problem-progress-bg" class="current-problem-progress-bg" style="width: 0%"></div>
                            <!-- Green outline layer: shows already-graded portions of current problem -->
                            <div id="current-problem-graded-outline" class="current-problem-graded-outline" style="width: 0%"></div>
                            <!-- Blue foreground layer: shows overall progress -->
                            <div id="overall-progress-fill" class="overall-progress-fill" style="width: 0%"></div>
                        </div>
                        <span id="overall-progress-label" style="font-size: 13px; color: var(--gray-700);">Overall: 0 / 0 (0%)</span>
                    </div>
                    <button id="view-stats-btn" class="btn btn-secondary btn-small">View Statistics</button>
                    <button id="upload-more-btn" class="btn btn-secondary btn-small instructor-only">+ Upload More Exams</button>
                </div>

                <div class="grading-layout">
                    <div class="problem-container">
                        <div class="problem-scroll-container" id="problem-scroll-container" tabindex="-1">
                            <img id="problem-image" alt="Problem to grade" tabindex="-1">
                        </div>
                        <div class="problem-resize-handle" id="problem-resize-handle"></div>
                    </div>

                    <div class="grading-form">
                        <div style="display: flex; gap: 15px; align-items: flex-start;">
                            <label style="display: flex; flex-direction: column; min-width: 100px;">
                                Score:
                                <input type="text" id="score-input" placeholder="Enter score or -" style="width: 80px; margin-top: 5px;" title="Enter a number or '-' to mark as blank">
                            </label>
                            <label style="flex: 1; display: flex; flex-direction: column;">
                                Feedback (optional):
                                <textarea id="feedback-input" rows="3" placeholder="Optional feedback for student" style="margin-top: 5px;"></textarea>
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 5px; flex-wrap: wrap;">
                            <button id="submit-grade-btn" class="btn btn-primary">Submit & Next</button>
                            <button id="back-problem-btn" class="btn">‚Üê Back</button>
                            <button id="next-problem-btn" class="btn">Skip</button>
                            <button id="show-context-btn" class="btn btn-secondary">Show in Context</button>
                            <button id="decipher-btn" class="btn btn-secondary">Decipher Handwriting</button>
                            <button id="show-answer-btn" class="btn btn-secondary" style="display: none;">Show Answer</button>
                            <button id="rescan-problem-qr-btn" class="btn btn-secondary" title="Re-scan QR code for this problem at higher DPI">üîÑ Re-scan QR</button>
                            <button id="start-autograde-btn" class="btn btn-success instructor-only">Start Autograding</button>
                            <button id="review-grades-btn" class="btn btn-secondary">Review Graded</button>
                        </div>
                        <div style="text-align: center; padding: 5px 0;">
                            <small style="color: var(--gray-600);">Shortcuts: <strong>0-9</strong> to enter score | <strong>Enter</strong> to submit</small>
                        </div>

                        <!-- Feedback Tags Section -->
                        <div id="feedback-tags-container" class="feedback-tags-container" style="display: none;">
                            <div class="tags-header">
                                <strong>Quick Feedback Tags:</strong>
                                <button id="add-tag-btn" class="btn btn-small">+ Add Tag</button>
                            </div>
                            <div id="tags-list" class="tags-list">
                                <span class="tags-placeholder">No tags yet. Click "+ Add Tag" to create reusable feedback comments.</span>
                            </div>
                            <button id="apply-tags-btn" class="btn btn-primary btn-small" style="display: none; margin-top: 10px;">Apply Selected Tags to Feedback</button>
                        </div>

                        <!-- Default Feedback Section -->
                        <div id="default-feedback-container" class="default-feedback-container" style="display: none;">
                            <div class="default-feedback-header">
                                <strong>Default Feedback:</strong>
                                <button id="edit-default-feedback-btn" class="btn btn-small">Edit</button>
                            </div>
                            <div id="default-feedback-display" class="default-feedback-display">
                                <span class="default-feedback-placeholder">No default feedback set. Click "Edit" to add feedback for low scores.</span>
                            </div>
                        </div>

                        <!-- Explanation from QR Code -->
                        <div id="explanation-container" class="explanation-container" style="display: none; background: #f0fdf4; border: 2px solid #10b981; border-radius: 8px; padding: 15px; margin-top: 15px;">
                            <div class="explanation-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: #047857;">üìù Explanation:</strong>
                                <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" id="include-explanation-checkbox" checked style="cursor: pointer;">
                                    <span>Include in student feedback</span>
                                </label>
                            </div>
                            <div id="explanation-content" class="explanation-content" style="line-height: 1.6; color: #064e3b;">
                                <span class="explanation-placeholder">Loading explanation...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Statistics Section -->
            <section id="stats-section" class="section">
                <h2>Grading Statistics</h2>
                <div id="stats-container"></div>

                <!-- TA Assignment Section (Instructor Only) -->
                <div id="ta-assignment-container" class="instructor-only" style="display: none; margin-top: 20px; padding: 20px; background: white; border-radius: 8px; border: 1px solid var(--gray-200);">
                    <h3 style="margin-top: 0;">TA Assignments</h3>
                    <p style="color: var(--gray-700); margin-bottom: 15px;">
                        Assign TAs to this grading session. Only assigned TAs will be able to access and grade this session.
                    </p>

                    <div id="assigned-tas-list" style="margin-bottom: 15px;">
                        <!-- Assigned TAs will be displayed here -->
                    </div>

                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="ta-select" style="flex: 1; padding: 8px; border-radius: 4px; border: 1px solid var(--gray-300);">
                            <option value="">Select a TA to assign...</option>
                        </select>
                        <button id="assign-ta-btn" class="btn btn-primary">Assign TA</button>
                    </div>
                </div>

                <div id="finalization-progress" style="display: none; margin-top: 20px; padding: 20px; background: #eff6ff; border-radius: 8px;">
                    <h3 style="margin-top: 0;">Finalization Progress</h3>
                    <div id="finalization-message" style="margin: 10px 0; font-size: 16px; font-weight: 500;"></div>
                    <div class="progress-bar" style="height: 20px;">
                        <div id="finalization-progress-bar" class="progress-bar-fill"></div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                    <button id="continue-grading-btn" class="btn btn-primary">‚Üê Continue Grading</button>
                    <button id="review-grades-stats-btn" class="btn btn-secondary">Review Graded Problems</button>
                    <button id="upload-more-stats-btn" class="btn btn-secondary instructor-only">+ Upload More Exams</button>
                    <button id="finalize-btn" class="btn btn-success instructor-only">Finalize & Upload to Canvas</button>
                    <button id="export-session-btn" class="btn btn-secondary instructor-only">Export Session (Checkpoint)</button>
                    <button id="change-canvas-target-btn" class="btn btn-secondary instructor-only">Change Canvas Target</button>
                    <button id="rescan-qr-btn" class="btn btn-secondary instructor-only" title="Re-scan QR codes at higher DPI">üîÑ Re-scan QR Codes</button>
                    <button id="rerun-blank-detection-btn" class="btn btn-secondary instructor-only" title="Re-run blank detection on all problems">üîç Re-run Blank Detection</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Problem Selector Modal -->
    <div id="problem-selector-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 8px; padding: 30px; max-width: 500px; width: 90%;">
            <h2 style="margin-top: 0;">Select Problem to Review</h2>
            <p style="color: var(--gray-700); margin-bottom: 20px;">
                Choose which problem number you'd like to review:
            </p>

            <label style="display: block; margin-bottom: 20px;">
                <strong>Problem Number:</strong>
                <select id="problem-selector-dropdown" style="display: block; width: 100%; padding: 10px; margin-top: 8px; border: 1px solid var(--gray-300); border-radius: 4px; font-size: 16px;">
                    <option value="">-- Select a problem --</option>
                </select>
            </label>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="problem-selector-cancel-btn" class="btn">Cancel</button>
                <button id="problem-selector-review-btn" class="btn btn-primary">Review Graded Submissions</button>
            </div>
        </div>
    </div>

    <!-- Review Grades Dialog -->
    <div id="review-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 8px; padding: 30px; max-width: 90vw; width: 1200px; max-height: 90vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Review Graded Submissions - Problem <span id="review-problem-number"></span></h2>
                <button id="close-review-btn" class="btn" style="padding: 5px 15px;">&times;</button>
            </div>

            <!-- Review Navigation and Summary -->
            <div style="background: #f9fafb; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-weight: 600; color: var(--gray-700);">
                        Viewing: <span id="review-current-index">0</span> of <span id="review-total-count">0</span> submissions
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button id="review-prev-btn" class="btn btn-small">‚Üê Previous</button>
                        <button id="review-next-btn" class="btn btn-small">Next ‚Üí</button>
                    </div>
                </div>
                <div style="font-size: 14px; color: var(--gray-600);">
                    Student: <strong id="review-student-name" class="spoiler" style="cursor: pointer; user-select: none;" title="Click to reveal student name">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</strong> |
                    Score: <strong id="review-current-score">-</strong>/<strong id="review-current-max">-</strong> |
                    Graded: <span id="review-graded-at">-</span>
                </div>
            </div>

            <!-- Review Content (image and edit form) -->
            <div style="flex: 1; overflow-y: auto; display: flex; gap: 20px;">
                <!-- Left: Problem Image -->
                <div style="flex: 1; display: flex; flex-direction: column;">
                    <h3 style="margin-top: 0; margin-bottom: 10px;">Submission</h3>
                    <div style="flex: 1; overflow-y: auto; border: 1px solid var(--gray-300); border-radius: 6px; background: var(--gray-100); display: flex; align-items: center; justify-content: center;">
                        <img id="review-problem-image" alt="Problem to review" style="max-width: 100%; max-height: 100%; display: block;">
                    </div>
                </div>

                <!-- Right: Edit Form -->
                <div style="width: 400px; display: flex; flex-direction: column;">
                    <h3 style="margin-top: 0; margin-bottom: 10px;">Edit Grade</h3>

                    <label style="margin-bottom: 15px;">
                        Score:
                        <input type="number" id="review-score-input" min="0" max="8" step="1" placeholder="Score" style="width: 80px; margin-top: 5px; padding: 8px; border: 1px solid var(--gray-300); border-radius: 4px;">
                    </label>

                    <label style="margin-bottom: 15px;">
                        Feedback:
                        <textarea id="review-feedback-input" rows="6" style="margin-top: 5px; width: 100%; padding: 8px; font-family: inherit; border: 2px solid var(--gray-300); border-radius: 4px; resize: vertical;"></textarea>
                    </label>

                    <div id="review-blank-info" style="display: none; background: #fef3c7; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 14px;">
                        <strong>‚ö†Ô∏è Marked as Blank</strong>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: auto;">
                        <button id="review-save-btn" class="btn btn-primary" style="flex: 1;">Save Changes</button>
                        <button id="review-decipher-btn" class="btn btn-secondary">Decipher</button>
                    </div>

                    <div style="margin-top: 10px; font-size: 13px; color: var(--gray-600); text-align: center;">
                        Use ‚Üê ‚Üí arrow keys to navigate
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Default Feedback Dialog -->
    <div id="edit-default-feedback-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="dialog-content" style="background: white; border-radius: 8px; padding: 30px; max-width: 600px; width: 90%;">
            <h2 class="dialog-header" style="margin-top: 0; cursor: move; user-select: none;">Edit Default Feedback</h2>
            <p style="color: var(--gray-700); margin-bottom: 20px;">
                This feedback will be automatically added to low-scoring submissions.
            </p>

            <label style="display: block; margin-bottom: 20px;">
                <strong>Default Feedback Text:</strong>
                <textarea id="default-feedback-text" rows="5" maxlength="2000" placeholder="e.g., The correct answer is..." style="display: block; width: 100%; padding: 8px; margin-top: 5px; border: 1px solid var(--gray-300); border-radius: 4px; resize: vertical;"></textarea>
                <small style="color: var(--gray-600);">This will be appended after tags and manual feedback</small>
            </label>

            <label style="display: block; margin-bottom: 20px;">
                <strong>Apply When:</strong>
                <div style="margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="checkbox" id="apply-on-zero" checked>
                        <span>Score is 0</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="checkbox" id="apply-on-blank" checked>
                        <span>Problem is blank (marked with "-")</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="apply-on-threshold">
                        <span style="display: flex; align-items: center; gap: 5px;">
                            Score is below
                            <input type="number" id="threshold-percentage" min="0" max="100" value="100" style="width: 60px; padding: 4px; border: 1px solid var(--gray-300); border-radius: 4px;">
                            % of max points
                        </span>
                    </label>
                </div>
            </label>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="cancel-default-feedback-btn" class="btn">Cancel</button>
                <button id="clear-default-feedback-btn" class="btn btn-danger">Clear</button>
                <button id="save-default-feedback-btn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Feedback Tag Dialog -->
    <div id="add-tag-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 8px; padding: 30px; max-width: 500px; width: 90%;">
            <h2 style="margin-top: 0;">Create Feedback Tag</h2>
            <p style="color: var(--gray-700); margin-bottom: 20px;">
                Create a reusable comment for common mistakes in this problem.
            </p>

            <label style="display: block; margin-bottom: 15px;">
                <strong>Short Name:</strong> <span style="color: var(--gray-600); font-size: 13px;">(max 30 chars, shown on button)</span>
                <input type="text" id="new-tag-name" maxlength="30" placeholder="e.g., % conversion" style="display: block; width: 100%; padding: 8px; margin-top: 5px; border: 1px solid var(--gray-300); border-radius: 4px;">
            </label>

            <label style="display: block; margin-bottom: 20px;">
                <strong>Comment Text:</strong> <span style="color: var(--gray-600); font-size: 13px;">(max 500 chars)</span>
                <textarea id="new-tag-comment" maxlength="500" rows="4" placeholder="e.g., don't forget to convert percentages to the range 0 to 1!" style="display: block; width: 100%; padding: 8px; margin-top: 5px; border: 1px solid var(--gray-300); border-radius: 4px; resize: vertical;"></textarea>
            </label>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="cancel-tag-btn" class="btn">Cancel</button>
                <button id="save-tag-btn" class="btn btn-primary">Create Tag</button>
            </div>
        </div>
    </div>

    <!-- Canvas Target Change Dialog -->
    <div id="canvas-target-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 8px; padding: 30px; max-width: 600px; width: 90%;">
            <h2 style="margin-top: 0;">Change Canvas Target</h2>
            <p style="color: var(--gray-700); margin-bottom: 20px;">
                Update the Canvas environment and assignment for this grading session. Useful for testing in dev before uploading to production.
            </p>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px;">
                    <strong>Environment:</strong>
                    <select id="canvas-env-select" style="display: block; width: 100%; padding: 8px; margin-top: 5px; border: 1px solid var(--gray-200); border-radius: 4px;">
                        <option value="false">Development (Beta/Test)</option>
                        <option value="true">Production</option>
                    </select>
                </label>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px;">
                    <strong>Course:</strong>
                    <select id="canvas-course-select" style="display: block; width: 100%; padding: 8px; margin-top: 5px; border: 1px solid var(--gray-200); border-radius: 4px;">
                        <option value="">Loading courses...</option>
                    </select>
                </label>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px;">
                    <strong>Assignment:</strong>
                    <select id="canvas-assignment-select" disabled style="display: block; width: 100%; padding: 8px; margin-top: 5px; border: 1px solid var(--gray-200); border-radius: 4px;">
                        <option value="">Select a course first</option>
                    </select>
                </label>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="cancel-canvas-target-btn" class="btn">Cancel</button>
                <button id="save-canvas-target-btn" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Handwriting Transcription Dialog -->
    <div id="transcription-dialog" class="transcription-dialog" style="display: none;">
        <div class="transcription-header">
            <span class="transcription-title">Handwriting Transcription</span>
            <button id="close-transcription" class="transcription-close">&times;</button>
        </div>
        <div class="transcription-content">
            <div id="transcription-text"></div>
            <div id="transcription-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--gray-200); display: none;">
                <button id="retry-sonnet-btn" class="btn btn-secondary" style="font-size: 14px; padding: 8px 16px; margin-right: 10px;">
                    Try Sonnet
                </button>
                <button id="retry-opus-btn" class="btn btn-primary" style="font-size: 14px; padding: 8px 16px;">
                    Try Opus (Premium)
                </button>
                <div id="model-used" style="margin-top: 10px; font-size: 13px; color: var(--gray-700); font-style: italic;"></div>
            </div>
        </div>
        <div class="transcription-resize-handle"></div>
    </div>

    <!-- Context View Dialog -->
    <div id="context-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 8px; padding: 20px; max-width: 90vw; max-height: 90vh; overflow: auto; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Problem in Context - Full Page View</h3>
                <button id="close-context" class="btn" style="padding: 5px 15px;">&times;</button>
            </div>
            <div style="position: relative; display: inline-block;">
                <img id="context-page-image" alt="Full page" style="max-width: 100%; display: block;">
                <div id="context-highlight" style="position: absolute; border: 3px solid red; pointer-events: none;"></div>
            </div>
        </div>
    </div>

    <!-- Answer Display Dialog -->
    <div id="answer-dialog" class="answer-dialog" style="display: none;">
        <div class="answer-header">
            <span class="answer-title">Correct Answer</span>
            <button id="close-answer-x" class="answer-close">&times;</button>
        </div>
        <div class="answer-content-wrapper">
            <div id="answer-metadata" style="background: #f3f4f6; padding: 15px; border-radius: 6px; margin-bottom: 15px; font-size: 14px;">
                <div style="margin-bottom: 8px;"><strong>Question Type:</strong> <span id="answer-question-type"></span></div>
                <div style="margin-bottom: 8px;"><strong>Seed:</strong> <span id="answer-seed"></span></div>
                <div style="margin-bottom: 8px;"><strong>Version:</strong> <span id="answer-version"></span></div>
                <div style="margin-bottom: 8px;"><strong>Max Points:</strong> <span id="answer-max-points"></span></div>
                <div id="answer-config-wrapper" style="display: none;"><strong>Config:</strong> <span id="answer-config"></span></div>
            </div>

            <div id="answer-content" style="background: #eff6ff; padding: 20px; border-radius: 6px; border: 2px solid #3b82f6;">
                <h3 style="margin-top: 0; color: #1e40af; font-size: 16px;">Answer(s):</h3>
                <div id="answer-list"></div>
            </div>

            <div id="answer-error" style="display: none; background: #fee; padding: 15px; border-radius: 6px; border: 1px solid #f88; color: #c00; margin-top: 15px;"></div>
        </div>
        <div class="answer-resize-handle"></div>
    </div>

    <script src="/js/app.js"></script>
    <script src="/js/user_management.js"></script>
    <script src="/js/session_assignments.js"></script>
    <script src="/js/matching.js"></script>
    <script src="/js/grading.js"></script>
    <script src="/js/rubric-table.js"></script>
    <script src="/js/review.js"></script>
    <script src="/js/feedback_tags.js"></script>
    <script src="/js/default_feedback.js"></script>
</body>
</html>
