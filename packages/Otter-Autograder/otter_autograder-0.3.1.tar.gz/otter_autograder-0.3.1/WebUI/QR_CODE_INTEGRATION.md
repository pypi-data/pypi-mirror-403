# QR Code Integration for Web Grading

## Overview

The web grading system now supports automatic extraction of question metadata and maximum points from QR codes embedded in exam PDFs. This integration works seamlessly with exams generated by the QuizGeneration system.

## Features

- **Automatic QR Code Detection**: Scans each problem region for QR codes during exam processing
- **Maximum Points Extraction**: Automatically populates the `max_points` field from QR code data
- **Question Metadata Storage**: Stores question type, seed, and version for potential future use
- **Fallback Support**: Falls back to OCR-based score box extraction if no QR code is found
- **Priority System**: QR code data takes precedence over other max points extraction methods

## How It Works

### During Exam Processing

1. When an exam is uploaded, the `ExamProcessor` splits it into problem regions
2. For each problem region, the `QRScanner` service attempts to detect and decode QR codes
3. If a QR code is found:
   - The encrypted metadata is decrypted using the QuizGeneration encryption key
   - Maximum points are extracted from the QR code data
   - Question metadata (type, seed, version) is stored for future use
   - The max points value is cached for all problems with the same number

4. If no QR code is found:
   - The system falls back to the existing AI-based score box extraction (if enabled)
   - Or uses previously cached max points for that problem number

### QR Code Format

The QR codes contain JSON data in this format:

```json
{
    "q": 1,                                    // Question number
    "pts": 2.0,                               // Point value
    "s": "Yx8CBgc5DjAUVDdQCTcXNUcCA0hDalFFRQp0G0o="  // Encrypted metadata
}
```

The encrypted `"s"` field decodes to:

```json
{
    "question_type": "VirtualAddressParts",   // Question class name
    "seed": 12345,                            // Random seed
    "version": "1.0"                          // Question version
}
```

## Setup Requirements

### 1. Install Dependencies

```bash
# Install pyzbar for QR code scanning
pip install pyzbar==0.1.9 Pillow==10.1.0

# Install zbar library (required by pyzbar)
# macOS:
brew install zbar

# Ubuntu/Debian:
sudo apt-get install libzbar0

# Windows:
# Download and install from http://zbar.sourceforge.net/
```

### 2. Install QuizGeneration Module

The QR scanner needs access to the QuizGeneration module to decrypt QR code metadata:

```bash
# Option 1: Install from parent directory
pip install -e /path/to/QuizGeneration

# Option 2: Place QuizGeneration in parent directory
# The system will auto-detect it at:
# /Users/ssogden/repos/QuizGeneration
```

### 3. Set Encryption Key

The encryption key used when generating the exam PDFs must be available:

```bash
# Add to your environment or .env file
export QUIZ_ENCRYPTION_KEY="your-encryption-key-here"
```

## Database Schema

QR code metadata is stored in the `problems` table with these additional fields:

- `max_points` (REAL): Maximum points for the problem (extracted from QR code)
- `qr_question_type` (TEXT): Question class name from QR code
- `qr_seed` (INTEGER): Random seed from QR code
- `qr_version` (TEXT): Question version from QR code

Note: These fields may need to be added via a database migration.

## Usage

### For Administrators

No configuration is needed! The QR code scanning is automatic when:

1. Uploading exams with per-question QR codes
2. The required dependencies are installed
3. The QuizGeneration module is available

### For Graders

The max points will be automatically populated from QR codes:

1. Upload exam PDFs through the web interface
2. The system will automatically detect and scan QR codes
3. Max points will be pre-filled for each question
4. You can still manually override the max points if needed

## Benefits

1. **Accuracy**: Eliminates OCR errors in max points extraction
2. **Consistency**: Ensures all submissions for the same problem use the same max points
3. **Speed**: Faster than AI-based score box extraction
4. **Future-Proof**: Stores question metadata for potential answer regeneration features
5. **Reliability**: Falls back gracefully if QR codes are not present

## Troubleshooting

### QR Codes Not Being Detected

Check the logs for these messages:

```
WARNING:qr_scanner:pyzbar not installed - QR code scanning will not be available
WARNING:qr_scanner:QuizGeneration module not found - QR code decryption will not be available
```

**Solutions**:

- Install pyzbar: `pip install pyzbar==0.1.9`
- Install zbar library (see setup requirements above)
- Ensure QuizGeneration module is installed or in the parent directory

### Decryption Errors

Check that:

1. The `QUIZ_ENCRYPTION_KEY` environment variable is set
2. The key matches the one used when generating the exam PDFs
3. The QuizGeneration module version is compatible

### Max Points Not Appearing

1. Check that the exam PDF actually contains QR codes (view in a PDF reader)
2. Ensure QR codes are within the problem regions (not cut off by split points)
3. Try re-uploading the exam
4. Check logs for QR scanning errors

## Architecture

### Components

1. **QRScanner Service** (`services/qr_scanner.py`):
   - Handles QR code detection and decoding
   - Interfaces with pyzbar library
   - Decrypts metadata using QuizGeneration

2. **ExamProcessor** (`services/exam_processor.py`):
   - Integrates QR scanning into exam processing pipeline
   - Caches max points across submissions
   - Falls back to other extraction methods

3. **Database** (`database.py`):
   - Stores QR metadata alongside problem data
   - Supports future features like answer regeneration

### Data Flow

```
Exam PDF Upload
    ↓
Exam Processing (ExamProcessor)
    ↓
Problem Region Extraction
    ↓
QR Code Scanning (QRScanner)
    ↓
Metadata Decryption (QuizGeneration)
    ↓
Database Storage
    ↓
Web Grading Interface
```

## Future Enhancements

### Potential Features Using QR Metadata

1. **Answer Regeneration**: Use question_type, seed, and version to regenerate correct answers
2. **Question Validation**: Verify that all students received the same question version
3. **Automated Grading**: For questions with deterministic answers, auto-grade using regenerated answers
4. **Analytics**: Track which question types are most difficult based on scores

### Implementation Notes

The QR metadata is already being captured and stored. To implement answer regeneration:

1. Call the QuizGeneration API's `regenerate_from_metadata()` function
2. Pass the stored question_type, seed, version, and max_points
3. Compare student answers against regenerated correct answers

See the QuizGeneration documentation for more details:
`/Users/ssogden/repos/QuizGeneration/documentation/WEB_UI_INTEGRATION.md`

## Related Documentation

- QuizGeneration Web UI Integration: `/Users/ssogden/repos/QuizGeneration/documentation/WEB_UI_INTEGRATION.md`
- QuizGeneration QR Code Format: Check QuizGeneration repo for QR code generation details
- Web Grading API Documentation: See `web_api/README.md`