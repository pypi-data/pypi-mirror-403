#!/bin/bash
set -euo pipefail

ROOT_DIR=$(cd "$(dirname "$0")/.." && pwd)
BUILD_DIR="$ROOT_DIR/build/helper"
LIBXC_DIR="$ROOT_DIR/libxc"
TP_DIR="$ROOT_DIR/third_party"

if [ ! -f "$LIBXC_DIR/src/helper.cc" ]; then
  echo "Error: helper.cc not found. Run: make generate-helper" >&2
  exit 1
fi

# Ensure xc_version.h exists (normally generated by libxc CMake)
if [ ! -f "$LIBXC_DIR/xc_version.h" ]; then
  cat > "$LIBXC_DIR/xc_version.h" << 'VER'
#ifndef _XC_VERSION_H
#define _XC_VERSION_H
#ifdef __cplusplus
extern "C" {
#endif
#define XC_VERSION "7.0.0"
#define XC_MAJOR_VERSION 7
#define XC_MINOR_VERSION 0
#define XC_MICRO_VERSION 0
#ifdef __cplusplus
}
#endif
#endif
VER
fi

rm -rf "$BUILD_DIR"
mkdir -p "$BUILD_DIR"

cat > "$BUILD_DIR/CMakeLists.txt" << 'CMAKE'
cmake_minimum_required(VERSION 3.15)
project(jxc_helper LANGUAGES C CXX)
set(CMAKE_CXX_STANDARD 14)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# Paths relative to this CMakeLists
get_filename_component(ROOT "${CMAKE_SOURCE_DIR}/../.." ABSOLUTE)
set(LIBXC_DIR "${ROOT}/libxc")
set(TP_DIR "${ROOT}/third_party")

add_subdirectory("${TP_DIR}/pybind11" "${CMAKE_BINARY_DIR}/pybind11_build")
include_directories("${LIBXC_DIR}")
include_directories("${LIBXC_DIR}/src")
include_directories("${TP_DIR}/visit_struct/include")

pybind11_add_module(helper "${LIBXC_DIR}/src/helper.cc")
CMAKE

cmake -S "$BUILD_DIR" -B "$BUILD_DIR"
cmake --build "$BUILD_DIR" --config Release --target helper -j

# Copy built module into package path as jxc/helper*.so
TARGET_SO=$(find "$BUILD_DIR" -maxdepth 2 -type f \( -name "helper*.so" -o -name "helper*.dylib" \) | head -1)
if [ -z "${TARGET_SO:-}" ]; then
  echo "Error: helper shared library not found in $BUILD_DIR" >&2
  exit 1
fi
mkdir -p "$ROOT_DIR/jxc"
cp -f "$TARGET_SO" "$ROOT_DIR/jxc/"
echo "âœ“ Installed $(basename "$TARGET_SO") to jxc/"
