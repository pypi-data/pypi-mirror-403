(function(A,S){typeof exports=="object"&&typeof module<"u"?S(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],S):(A=typeof globalThis<"u"?globalThis:A||self,S(A.trame_vtklocal={},A.Vue))})(this,function(A,S){"use strict";var N=typeof document<"u"?document.currentScript:null,Y=t=>{throw TypeError(t)},X=(t,e,r)=>e.has(t)||Y("Cannot "+r),k=(t,e,r)=>(X(t,e,"read from private field"),r?r.call(t):e.get(t)),_=(t,e,r)=>e.has(t)?Y("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),M=(t,e,r,n)=>(X(t,e,"write to private field"),e.set(t,r),r);function ue(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var F={exports:{}},he=F.exports,Q;function fe(){return Q||(Q=1,function(t,e){(function(r,n){t.exports=n()})(he,function(){function r(g){function s(c){for(var w=0,x=m.length;w<x;++w)m[w](c);d.push(c)}if(typeof Promise!="function")throw new Error("Promise implementation not available in this environment.");var m=[],d=[],p=new Promise(function(c,w){g(c,w,s)});p.progress=function(c){if(typeof c!="function")throw new Error("cb is not a function.");for(var w=0,x=d.length;w<x;++w)c(d[w]);return m.push(c),p};var b=p.then;return p.then=function(c,w,x){return b.call(p,c,w),x!==void 0&&p.progress(x),p},p}function n(g){if(!(g instanceof ArrayBuffer))throw new TypeError("arrayBuffer is not an instance of ArrayBuffer.");if(!o.Worker)throw new Error("Worker implementation is not available in this environment.");return new r(function(s,m,d){var p=new Worker(i),b=[];p.onerror=function(c){m(c)},p.onmessage=function(c){switch(c=c.data,c.type){case"log":console[c.data.level]("Worker: "+c.data.msg);break;case"extract":var w=a(c.data);b.push(w),d(w);break;case"complete":p.terminate(),s(b);break;case"error":p.terminate(),m(new Error(c.data.message));break;default:p.terminate(),m(new Error("Unknown message from worker: "+c.type))}},p.postMessage({type:"extract",buffer:g},[g])})}function a(g){return Object.defineProperties(g,h),g}var i,o=window||this,f=o.URL||o.webkitURL,h={blob:{get:function(){return this._blob||(this._blob=new Blob([this.buffer]))}},getBlobUrl:{value:function(){return this._blobUrl||(this._blobUrl=f.createObjectURL(this.blob))}},readAsString:{value:function(){for(var g=this.buffer,s=g.byteLength,m=1,d=new DataView(g),p=[],b=0;b<s;++b){var c=d.getUint8(b*m,!0);p.push(c)}return this._string=String.fromCharCode.apply(null,p)}},readAsJSON:{value:function(){return JSON.parse(this.readAsString())}}};return i=(window||this).URL.createObjectURL(new Blob(['"use strict";function UntarWorker(){}function decodeUTF8(e){for(var r="",t=0;t<e.length;){var a=e[t++];if(a>127){if(a>191&&a<224){if(t>=e.length)throw"UTF-8 decode: incomplete 2-byte sequence";a=(31&a)<<6|63&e[t]}else if(a>223&&a<240){if(t+1>=e.length)throw"UTF-8 decode: incomplete 3-byte sequence";a=(15&a)<<12|(63&e[t])<<6|63&e[++t]}else{if(!(a>239&&a<248))throw"UTF-8 decode: unknown multibyte start 0x"+a.toString(16)+" at index "+(t-1);if(t+2>=e.length)throw"UTF-8 decode: incomplete 4-byte sequence";a=(7&a)<<18|(63&e[t])<<12|(63&e[++t])<<6|63&e[++t]}++t}if(a<=65535)r+=String.fromCharCode(a);else{if(!(a<=1114111))throw"UTF-8 decode: code point 0x"+a.toString(16)+" exceeds UTF-16 reach";a-=65536,r+=String.fromCharCode(a>>10|55296),r+=String.fromCharCode(1023&a|56320)}}return r}function PaxHeader(e){this._fields=e}function TarFile(){}function UntarStream(e){this._bufferView=new DataView(e),this._position=0}function UntarFileStream(e){this._stream=new UntarStream(e),this._globalPaxHeader=null}if(UntarWorker.prototype={onmessage:function(e){try{if("extract"!==e.data.type)throw new Error("Unknown message type: "+e.data.type);this.untarBuffer(e.data.buffer)}catch(r){this.postError(r)}},postError:function(e){this.postMessage({type:"error",data:{message:e.message}})},postLog:function(e,r){this.postMessage({type:"log",data:{level:e,msg:r}})},untarBuffer:function(e){try{for(var r=new UntarFileStream(e);r.hasNext();){var t=r.next();this.postMessage({type:"extract",data:t},[t.buffer])}this.postMessage({type:"complete"})}catch(a){this.postError(a)}},postMessage:function(e,r){self.postMessage(e,r)}},"undefined"!=typeof self){var worker=new UntarWorker;self.onmessage=function(e){worker.onmessage(e)}}PaxHeader.parse=function(e){for(var r=new Uint8Array(e),t=[];r.length>0;){var a=parseInt(decodeUTF8(r.subarray(0,r.indexOf(32)))),n=decodeUTF8(r.subarray(0,a)),i=n.match(/^\\d+ ([^=]+)=(.*)\\n$/);if(null===i)throw new Error("Invalid PAX header data format.");var s=i[1],o=i[2];0===o.length?o=null:null!==o.match(/^\\d+$/)&&(o=parseInt(o));var f={name:s,value:o};t.push(f),r=r.subarray(a)}return new PaxHeader(t)},PaxHeader.prototype={applyHeader:function(e){this._fields.forEach(function(r){var t=r.name,a=r.value;"path"===t?(t="name",void 0!==e.prefix&&delete e.prefix):"linkpath"===t&&(t="linkname"),null===a?delete e[t]:e[t]=a})}},UntarStream.prototype={readString:function(e){for(var r=1,t=e*r,a=[],n=0;n<e;++n){var i=this._bufferView.getUint8(this.position()+n*r,!0);if(0===i)break;a.push(i)}return this.seek(t),String.fromCharCode.apply(null,a)},readBuffer:function(e){var r;if("function"==typeof ArrayBuffer.prototype.slice)r=this._bufferView.buffer.slice(this.position(),this.position()+e);else{r=new ArrayBuffer(e);var t=new Uint8Array(r),a=new Uint8Array(this._bufferView.buffer,this.position(),e);t.set(a)}return this.seek(e),r},seek:function(e){this._position+=e},peekUint32:function(){return this._bufferView.getUint32(this.position(),!0)},position:function(e){return void 0===e?this._position:void(this._position=e)},size:function(){return this._bufferView.byteLength}},UntarFileStream.prototype={hasNext:function(){return this._stream.position()+4<this._stream.size()&&0!==this._stream.peekUint32()},next:function(){return this._readNextFile()},_readNextFile:function(){var e=this._stream,r=new TarFile,t=!1,a=null,n=e.position(),i=n+512;switch(r.name=e.readString(100),r.mode=e.readString(8),r.uid=parseInt(e.readString(8)),r.gid=parseInt(e.readString(8)),r.size=parseInt(e.readString(12),8),r.mtime=parseInt(e.readString(12),8),r.checksum=parseInt(e.readString(8)),r.type=e.readString(1),r.linkname=e.readString(100),r.ustarFormat=e.readString(6),r.ustarFormat.indexOf("ustar")>-1&&(r.version=e.readString(2),r.uname=e.readString(32),r.gname=e.readString(32),r.devmajor=parseInt(e.readString(8)),r.devminor=parseInt(e.readString(8)),r.namePrefix=e.readString(155),r.namePrefix.length>0&&(r.name=r.namePrefix+"/"+r.name)),e.position(i),r.type){case"0":case"":r.buffer=e.readBuffer(r.size);break;case"1":break;case"2":break;case"3":break;case"4":break;case"5":break;case"6":break;case"7":break;case"g":t=!0,this._globalPaxHeader=PaxHeader.parse(e.readBuffer(r.size));break;case"x":t=!0,a=PaxHeader.parse(e.readBuffer(r.size))}void 0===r.buffer&&(r.buffer=new ArrayBuffer(0));var s=i+r.size;return r.size%512!==0&&(s+=512-r.size%512),e.position(s),t&&(r=this._readNextFile()),null!==this._globalPaxHeader&&this._globalPaxHeader.applyHeader(r),null!==a&&a.applyHeader(r),r}};'])),n})}(F)),F.exports}var ge=fe();const pe=ue(ge);function L(t){return typeof t!="string"?(console.warn("stripLeadingDotSlash: provided path is not a string"),""):t.replace(/^\.\//,"")}function me(t){if(typeof t!="string")return!1;const e=t.trimStart();return/^<\s*!DOCTYPE\s+html\b/i.test(e)||/^<\s*html[\s>]/i.test(e)}function I(){let t,e;return{promise:new Promise((r,n)=>{t=r,e=n}),resolve:t,reject:e}}const V=Object.freeze({WEBGL:"webgl",WEBGPU:"webgpu"}),B=Object.freeze({SYNC:"sync",ASYNC:"async"}),we=Object.freeze({rendering:V.WEBGL,exec:B.SYNC}),be=".wasm",H=".mjs",Z=Object.freeze({WASM:"application/wasm",JAVASCRIPT:"application/javascript"});function ve(t){return typeof t=="string"&&t.endsWith(".gz")}function ye(t){const{promise:e,resolve:r,reject:n}=I();return fetch(t).then(a=>{if(a.ok){const i=a.body.pipeThrough(new DecompressionStream("gzip"));new Response(i).blob().then(o=>o.arrayBuffer()).then(r).catch(n)}else n(new Error(`Could not fetch gzip bundle from ${t} - response status: ${a.status}`))}).catch(n),e}function Se(t,e,r){const{promise:n,resolve:a,reject:i}=I();return pe(t).then(o=>{const f=(e==null?void 0:e.exec)==="async"?"Async":"",h=`${r}WebAssembly${f}${H}`,g=`${r}WebAssembly${f}${be}`,s=o.find(d=>L(d.name)===h),m=o.find(d=>L(d.name)===g);s===void 0||m===void 0?i(new Error(`Could not find expected files ${h} and ${g} in the gzip bundle`)):a({js:s,wasm:m})}).catch(i),n}function ee(t,e){return URL.createObjectURL(new Blob([t],{type:e}))}function Me(t){URL.revokeObjectURL(t)}function ke(t){const e=Object.values(V),r=Object.values(B);if(t.rendering!==void 0&&!e.includes(t.rendering))throw new Error(`Invalid rendering backend: ${t.rendering}. Valid options are: ${e.join(", ")}`);if(t.exec!==void 0&&!r.includes(t.exec))throw new Error(`Invalid execution mode: ${t.exec}. Valid options are: ${r.join(", ")}`)}function Ce(t){return(t==null?void 0:t.rendering)===V.WEBGPU&&(t==null?void 0:t.exec)!==B.ASYNC?(console.warn('WebGPU rendering requires async execution mode. Switching exec to "async".'),{...t,exec:B.ASYNC}):t}function te(t,e){return t.rendering===e.rendering&&t.exec===e.exec}function $(t,e){const r={};let n=null;e!=null&&(r.locateFile=i=>{const o=L(i),f=L(e.name);return o===f?(n=ee(e.buffer,Z.WASM),n):new URL(i,typeof document>"u"&&typeof location>"u"?require("url").pathToFileURL(__filename).href:typeof document>"u"?location.href:N&&N.tagName.toUpperCase()==="SCRIPT"&&N.src||new URL("trame_vtklocal.umd.js",document.baseURI).href).href});let a=t==null?void 0:t.onRuntimeInitialized;if(r.onRuntimeInitialized=()=>{typeof a=="function"&&a(),n!==null&&URL.revokeObjectURL(n)},(t==null?void 0:t.rendering)===V.WEBGPU){const i=Array.isArray(t==null?void 0:t.preRun)?t.preRun:t!=null&&t.preRun?[t.preRun]:[];r.preRun=[o=>{o.ENV.VTK_GRAPHICS_BACKEND="WEBGPU"},...i]}return r}const re=[],D={};function xe(t){if(window.createVTKWASM)return Promise.resolve();let e=null;const r=`${t}WebAssembly`,n=document.querySelectorAll("script");for(const a of n)if(a.src.includes(r)){const{promise:i,resolve:o,reject:f}=I();a.onload=o,a.onerror=()=>{f(new Error(`Failed to load script: ${a.src}`))},e=i;break}return e||Promise.resolve()}function K(t){return D[t]||(D[t]=new Promise(function(e,r){if(re.indexOf(t)===-1){re.push(t);const n=document.createElement("script");n.type="module",n.src=t,n.onload=e,n.onerror=()=>{r(new Error(`Failed to load script: ${t}`))},document.body.appendChild(n)}else e(!1)})),D[t]}async function ne(t,e,r,n=!1){let a="";n||(a=(r==null?void 0:r.exec)==="async"?"Async":"");const i=n?`vtkWasmSceneManager${H}`:`${e}WebAssembly${a}${H}`,o=`${t}/${i}`,{promise:f,resolve:h,reject:g}=I();return fetch(o).then(s=>s.ok?s.text():null).then(s=>{s===null&&h(null),me(s)&&h(null),h(o)}).catch(g),f}async function We(t,e,r){if(r)if(r!=null&&r.isAsync&&r.isAsync()){if(!t||te(e,t))return console.debug("Reusing existing async WASM runtime for remote session"),new r.vtkRemoteSession;{console.debug("Creating new async WASM runtime for remote session");const a=await window.createVTKWASM($(t||e));return new a.vtkRemoteSession}}else{if(!t||te(e,t))return console.debug("Reusing existing sync WASM runtime for remote session"),new r.vtkRemoteSession;{console.debug("Creating new sync WASM runtime for remote session");const a=await window.createVTKWASM($(t||e));return new a.vtkRemoteSession}}const n=await window.createVTKWasmSceneManager();return n.initialize(),n}function Pe(t){return t!=null&&t.Id?t:JSON.parse(t)}function Te(t){return t!=null&&t.Id?JSON.stringify(t):t}var T,W,C,P;class Ae{constructor(){_(this,T,null),_(this,W,!1),_(this,C,null),_(this,P,null),M(this,T,{}),M(this,W,!1),M(this,C,null),M(this,P,null)}async load(e,r=we,n="vtk"){if(!k(this,W))if(ke(r),M(this,T,Ce(r)),k(this,C))await k(this,C);else{const{promise:a,resolve:i,reject:o}=I();M(this,C,a),window.createVTKWASM||await xe(n);let f=null;if(!window.createVTKWASM)if(ve(e)){let h,g=null;try{h=await ye(e)}catch(s){o(s),M(this,C,null);return}try{const s=await Se(h,k(this,T),n);f=s.wasm,g=ee(s.js.buffer,Z.JAVASCRIPT),await K(g)}catch(s){o(s),M(this,C,null);return}finally{g!==null&&Me(g)}}else try{const h=await ne(e,n,k(this,T));if(h!==null&&await K(h),!window.createVTKWASM){const g=await ne(e,null,null,!0);await K(g)}}catch(h){o(h),M(this,C,null);return}if(window.createVTKWASM){try{M(this,P,await window.createVTKWASM($(k(this,T),f)))}catch(h){o(h),M(this,C,null);return}M(this,W,!0),i(),M(this,C,null)}else if(window.createVTKWasmSceneManager)M(this,P,null),M(this,W,!0),i(),M(this,C,null);else{const h=["Could not load WebAssembly module: window.createVTKWASM is not available after loading scripts.","Possible causes include:",`  - Incorrect or unreachable 'wasmBaseURL' ("${e}")`,`  - Wrong 'wasmBaseName' ("${n}") or missing/misnamed .mjs/.wasm files in the bundle`,"  - Network or script loading failures (e.g., 404/500 responses)","  - Content Security Policy (CSP) blocking script execution","","Next steps:","  - Verify that the expected .mjs and .wasm files are present and accessible under 'wasmBaseURL'","  - Check the browser's Network/Console tabs for failed script requests or CSP errors."].join(`
`);o(new Error(h)),M(this,C,null)}}}async createRemoteSession(e){if(!k(this,W))throw new Error("WASM module is not loaded yet. Call load() first.");return await We(e,k(this,T),k(this,P))}createStandaloneSession(){if(!k(this,W))throw new Error("WASM module is not loaded yet. Call load() first.");if(k(this,P)===null)throw new Error("The currently loaded VTK.wasm version does not support standalone mode");return new(k(this,P)).vtkStandaloneSession}createStateDecorator(){if(!k(this,W))throw new Error("WASM module is not loaded yet. Call load() first.");return k(this,P)!==null?Pe:Te}}T=new WeakMap,W=new WeakMap,C=new WeakMap,P=new WeakMap;function q(t){return`${t.charAt(0).toLowerCase()}${t.slice(1)}`}function se(t){return`${t.charAt(0).toUpperCase()}${t.slice(1)}`}function Oe(t){const e={};return Object.entries(t).forEach(([r,n])=>{e[se(r)]=n}),e}function ae(t){const e={};return Object.entries(t).forEach(([r,n])=>{e[q(r)]=n}),e}function je(t,e,r){if(!t.get)return{};const n=t.get(r),a={};return Object.keys(n).forEach(i=>{a[q(i)]=()=>e.decorateResult(t.get(r)[i])}),a}function Ie(t,e,r){if(!t.get)return{};const n=t.get(r),a={};return Object.keys(n).forEach(i=>{a[q(i)]=o=>t.set(r,e.decorateKwargs({[i]:o}))}),a}function ie(t,e,r,n,a){if(r.has(a)&&r.get(a).deref())return r.get(a).deref();const i=[];function o(b){return t.set(a,n.decorateKwargs(Oe(b)))}function f(b,c){const w=t.observe(a,b,c);return i.push(w),w}function h(b){const c=i.indexOf(b);return c!==-1&&i.splice(c,1),t.unObserve(a,b)}function g(){for(;i.length;)h(i.pop())}const s=je(t,n,a),m=Ie(t,n,a),d={id:a,obj:{Id:a},set:o,observe:f,unObserve:h,unObserveAll:g},p=new Proxy(d,{get(b,c,w){if(c==="then")return w;if(c==="state")return t.get?ae(t.get(a)):(t.updateStateFromObject(a),ae(t.getState(a)));if(c==="delete"){const x=t.destroy(a);if(x){const O=r.delete(a);e.delete(O)}return x}return s[c]?s[c]():(b[c]||(b[c]=async(...x)=>n.decorateResult(await t.invoke(a,se(c),n.decorateArgs(x)))),b[c])},set(b,c,w){return m[c]&&m[c](w),w}});return r.set(a,new WeakRef(p)),e.set(p,!0),p}const E={};class oe{constructor(){this.sceneManager=null,this.loaded=!1,this.updateInProgress=0,this.currentMTime=1,this.stateMTimes={},this.hashesMTime={},this.pendingArrays={},this.networkFetchState=null,this.networkFetchHash=null,this.networkFetchStatus=null,this.cameraIds=new Set,this.stateCache={},this.progressCallbacks=new Set,this.progressState=null,this.renderWindowIds=new Set,this.renderWindowIdToInteractorId=new Map,this.renderWindowSizes={},this.vtkProxyCache=new WeakMap,this.idToRef=new Map,this.internalWrapMethods={},this.internalWrapMethods.isVtkObject=e=>this.vtkProxyCache.has(e),this.internalWrapMethods.decorateKwargs=e=>{const r={};return Object.entries(e).forEach(([n,a])=>{this.vtkProxyCache.has(a)?r[n]=a.obj:r[n]=a}),r},this.internalWrapMethods.decorateArgs=e=>e.map(r=>this.vtkProxyCache.has(r)?r.obj:r),this.internalWrapMethods.decorateResult=e=>e==null?e:e!=null&&e.Id?ie(this.sceneManager,this.vtkProxyCache,this.idToRef,this.internalWrapMethods,e.Id):e,this.offlineCanvasContainer=document.createElement("div"),this.offlineCanvasContainer.setAttribute("class","unused-canvas"),document.body.appendChild(this.offlineCanvasContainer)}async load(e,r,n){E[e]||(E[e]=new Ae),await E[e].load(e,r,n),this.sceneManager=await E[e].createRemoteSession(r),this.stateDecorator=E[e].createStateDecorator(),this.loaded=!0,this.sceneManager.skipProperty&&(this.sceneManager.skipProperty("vtkRenderWindow","Size"),["vtkWin32OpenGLRenderWindow","vtkXOpenGLRenderWindow","vtkCocoaRenderWindow","vtkWebAssemblyOpenGLRenderWindow"].forEach(a=>this.sceneManager.skipProperty(a,"Size")))}bindNetwork(e,r,n){this.networkFetchState=e,this.networkFetchHash=r,this.networkFetchStatus=n}addProgressCallback(e){return e&&this.progressCallbacks.add(e),()=>{this.progressCallbacks.delete(e)}}emitProgress(){if(!this.progressCallbacks.size||!this.progressState)return;const{active:e,state:r,hash:n}=this.progressState,a={active:e,state:{current:r.current,total:r.total},hash:{current:n.current,total:n.total}};this.progressCallbacks.forEach(i=>i(a))}incrementProgress(e){if(!this.progressState)return;const r=this.progressState[e];r&&(r.current=Math.min(r.current+1,r.total),this.emitProgress())}freeMemory(e=0){const r=this.sceneManager.getTotalBlobMemoryUsage(),n=Number(e);if(r>n){const a={};let i=this.currentMTime;for(Object.entries(this.hashesMTime).forEach(([o,f])=>{f<i&&(i=f);const h=f.toString();a[h]?a[h].push(o):a[h]=[o]});this.sceneManager.getTotalBlobMemoryUsage()>n;){const o=a[i];if(o)for(let f=0;f<o.length;f++)this.sceneManager.unRegisterBlob(o[f]),delete this.hashesMTime[o[f]];i++}}}async fetchState(e){const r=await this.networkFetchState(e),n=this.patchState(r);return this.incrementProgress("state"),n}patchState(e){var r;if(e.length>0){const n=JSON.parse(e),{Id:a,MTime:i}=n;if(this.stateMTimes[a]=i,!this.sceneManager.skipProperty||!this.sceneManager.bindRenderWindow){if(this.renderWindowIds.has(a)&&(r=n==null?void 0:n.Interactor)!=null&&r.Id)return this.renderWindowIdToInteractorId.set(n.Interactor.Id,a),n.CanvasSelector=this.getCanvasSelector(a),delete n.Size,this.renderWindowSizes[a]&&(n.Size=this.renderWindowSizes[a]),n.ClassName="vtkCocoaRenderWindow",JSON.stringify(n);if(this.renderWindowIdToInteractorId.has(a))return n.CanvasSelector=this.getCanvasSelector(this.renderWindowIdToInteractorId.get(a)),JSON.stringify(n)}return e}}async fetchHash(e){let r;return this.pendingArrays[e]?(await this.pendingArrays[e],this.hashesMTime[e]=this.currentMTime,delete this.pendingArrays[e]):(r=await this.networkFetchHash(e),this.sceneManager.registerBlob(e,r),this.hashesMTime[e]=this.currentMTime),this.incrementProgress("hash"),r}pushHash(e,r){return this.pendingArrays[e]=new Promise(n=>{r.arrayBuffer?r.arrayBuffer().then(a=>{this.sceneManager.registerBlob(e,new Uint8Array(a)),this.hashesMTime[e]=this.currentMTime,n()}):(this.sceneManager.registerBlob(e,r),this.hashesMTime[e]=this.currentMTime,n())}),this.pendingArrays[e]}async update(e,r=!1){if(this.renderWindowIds.add(e),this.updateInProgress++,this.updateInProgress===1)try{const n=await this.networkFetchStatus(e),a=[],i=[],o=n.force_push||[];for(let s=0;s<o.length;s++)delete this.stateMTimes[o[s]];n.ids.forEach(([s,m])=>{(!this.stateMTimes[s]||this.stateMTimes[s]<m)&&i.push(s)}),n.hashes.forEach(s=>{this.hashesMTime[s]||a.push(s),this.hashesMTime[s]=this.currentMTime}),this.progressState={active:!!(i.length+a.length),state:{current:0,total:i.length},hash:{current:0,total:a.length}},this.emitProgress();const f=i.map(s=>this.fetchState(s)),h=a.map(s=>this.fetchHash(s));n.cameras.forEach(s=>this.cameraIds.add(Number(s))),n.ignore_ids.forEach(s=>this.sceneManager.unRegisterState(s)),await Promise.all(h),await Promise.all(Object.values(this.pendingArrays));const g=await Promise.all(f);for(this.currentMTime++;g.length;){const s=g.pop();s&&this.sceneManager.registerState(this.stateDecorator(s))}try{this.sceneManager.updateObjectsFromStates();const[s,m]=this.renderWindowSizes[e]||[10,10];this.sceneManager.setSize(e,s,m),r&&this.sceneManager.bindRenderWindow&&this.sceneManager.bindRenderWindow(e,this.getCanvasSelector(e)),await this.sceneManager.render(e)}catch(s){console.error("WASM update failed"),console.log(s)}}catch(n){console.error("Error in update",n)}finally{this.progressState&&(this.progressState.active=!1,this.emitProgress(),this.progressState=null),this.updateInProgress--,this.updateInProgress&&(this.updateInProgress=0,await this.update(e))}}getState(e,r=!1){const n=Number(e);return r&&this.stateCache[n]?this.stateCache[n]:this.sceneManager.get?this.sceneManager.get(n):(this.sceneManager.updateStateFromObject(n),this.sceneManager.getState(n))}clearStateCache(){this.stateCache={}}getStateValue(e,r=!1){const n=Array.isArray(e)?e:[e];let a=null;for(let i=0;i<n.length;i++){const o=n[i];i===0?a=this.getState(o,r):(a=a[o],a.Id&&(a=this.getState(a.Id,r)))}return a}getCanvasSelector(e){return`.vtk-wasm-${e}`}bindCanvasToDOM(e,r){const n=this.getCanvasSelector(e);let a=this.offlineCanvasContainer.querySelector(n);return a||(a=document.createElement("canvas"),a.setAttribute("class",n.substring(1)),a.setAttribute("tabindex","0")),r.appendChild(a),n}unbindCanvasToDOM(e){const r=this.getCanvasSelector(e),n=document.querySelector(r);n&&this.offlineCanvasContainer.appendChild(n)}async setSize(e,r,n){this.renderWindowSizes[e]=[r,n];const a=this.getCanvasSelector(e),i=document.querySelector(a);i&&(i.width=r,i.height=n,this.sceneManager.setSize(e,r,n),await this.sceneManager.render(e))}getVtkObject(e){return ie(this.sceneManager,this.vtkProxyCache,this.idToRef,this.internalWrapMethods,e)}}const U={};function G(t,e,r){return function(){e.clearStateCache();for(const[n,a]of Object.entries(r)){const i={};for(const[o,f]of Object.entries(a))i[o]=e.getStateValue(f,!0);t.state.set(n,i)}e.clearStateCache()}}const ce={VtkLocal:{emits:["updated","memory-vtk","memory-arrays","camera","invoke-response","progress"],props:{progressEnabled:{type:Boolean},progressDelay:{type:Number,default:500},useHandler:{type:String},renderWindow:{type:Number},eagerSync:{type:Boolean,default:!1},cacheSize:{type:Number,default:1e8},wsClient:{type:Object},emitMemory:{type:Boolean},verbosity:{type:Object,default:()=>({objectManager:null,invoker:null,deserializer:null,serializer:null})},config:{type:Object,default:()=>({rendering:"webgl",exec:"sync"})},listeners:{type:Object}},setup(t,{emit:e}){t.useHandler&&!U[t.useHandler]&&(U[t.useHandler]=new oe);const r=S.inject("trame"),n=r.state.get("__trame_vtklocal_wasm_url"),a=r.state.get("__trame_vtklocal_wasm_base_name"),i=[],o=[],f=S.ref(null),h=t.wsClient||(r==null?void 0:r.client),g=S.toRef(t,"listeners"),s=t.useHandler?U[t.useHandler]:new oe;let m=null;const d=S.reactive({active:!1,tsStart:0,tsNow:0,state:{current:0,total:0},hash:{current:0,total:0}}),p=S.ref(!s.loaded),b=S.computed(()=>t.progressEnabled&&d.tsNow-d.tsStart>t.progressDelay&&(p.value||d.active)),c=S.computed(()=>d.state.total?Math.min(100,Math.floor(d.state.current/d.state.total*100)):0),w=S.computed(()=>d.hash.total?Math.min(100,Math.floor(d.hash.current/d.hash.total*100)):0);function x(l){var u,v,y,j;l&&(d.tsNow=Date.now(),!d.active&&l.active&&(d.tsStart=d.tsNow),d.active=!!l.active,d.state.current=((u=l.state)==null?void 0:u.current)||0,d.state.total=((v=l.state)==null?void 0:v.total)||0,d.hash.current=((y=l.hash)==null?void 0:y.current)||0,d.hash.total=((j=l.hash)==null?void 0:j.total)||0,e("progress",{active:d.active,elapsed:d.tsNow-d.tsStart,state:{current:d.state.current,total:d.state.total},hash:{current:d.hash.current,total:d.hash.total}}))}let O=null;s.addProgressCallback&&(O=s.addProgressCallback(x));async function Ue(l){return await h.getConnection().getSession().call("vtklocal.get.state",[l])}async function Re(l){const v=await h.getConnection().getSession().call("vtklocal.get.hash",[l]);return v.arrayBuffer?new Uint8Array(await v.arrayBuffer()):v}async function ze(l){return await h.getConnection().getSession().call("vtklocal.get.status",[l])}function _e([l]){l.type==="state"&&s.pushState(l.content),l.type==="blob"&&s.pushHash(l.hash,l.content)}async function Le(){const l=h.getConnection().getSession();m=l.subscribe("vtklocal.subscriptions",_e),await l.call("vtklocal.subscribe.update",[t.renderWindow,1])}async function Ve(){const l=h.getConnection().getSession();m&&(l.unsubscribe(m),m=null),await l.call("vtklocal.subscribe.update",[t.renderWindow,-1])}async function le(){const{width:l,height:u}=f.value.getBoundingClientRect(),v=Math.floor(l*window.devicePixelRatio+.5),y=Math.floor(u*window.devicePixelRatio+.5);await s.setSize(t.renderWindow,v,y)}let R=new ResizeObserver(le);function Be(){s.freeMemory(t.cacheSize),t.emitMemory&&(e("memory-vtk",s.sceneManager.getTotalVTKDataObjectMemoryUsage()),e("memory-arrays",s.sceneManager.getTotalBlobMemoryUsage()))}async function de(l=!1){s.loaded&&(await s.update(t.renderWindow,l),e("updated"),Be())}function Ne(l){s.sceneManager.resetCamera(l),s.sceneManager.render(t.renderWindow)}function Fe(){s.sceneManager.render(t.renderWindow)}async function He(l,u,v){const y=await s.sceneManager.invoke(l,u,v);return y!=null&&y.Id&&(y!=null&&y.Success)&&(y.Value=s.getState(y.Id)),e("invoke-response",y),y}function $e(){s.sceneManager.printSceneManagerInformation()}S.onMounted(async()=>{if(s.bindNetwork(Ue,Re,ze),!s.loaded){p.value=!0;try{await s.load(n,t.config,a)}finally{p.value=!1}}const l=s.bindCanvasToDOM(t.renderWindow,S.unref(f));S.unref(f).querySelector(l).setAttribute("style","position: absolute; left: 0; top: 0; width: 100%; height: 100%;"),t.eagerSync&&Le(),R&&R.observe(S.unref(f)),S.watchEffect(()=>{const u=t.verbosity;u.objectManager&&s.sceneManager.setObjectManagerLogVerbosity&&s.sceneManager.setObjectManagerLogVerbosity(u.objectManager),u.invoker&&s.sceneManager.setInvokerLogVerbosity&&s.sceneManager.setInvokerLogVerbosity(u.invoker),u.deserializer&&s.sceneManager.setDeserializerLogVerbosity&&s.sceneManager.setDeserializerLogVerbosity(u.deserializer),u.serializer&&s.sceneManager.setSerializerLogVerbosity&&s.sceneManager.setSerializerLogVerbosity(u.serializer)}),await de(!0),s.sceneManager.addObserver?s.cameraIds.forEach(u=>{i.push([u,s.sceneManager.addObserver(u,"ModifiedEvent",()=>{e("camera",s.getState(u))})])}):s.cameraIds.forEach(u=>{i.push([u,s.sceneManager.observe(u,"ModifiedEvent",()=>{e("camera",s.getState(u))})])}),S.watchEffect(()=>{if(s.sceneManager.removeObserver){for(;o.length;){const[u,v]=o.pop();s.sceneManager.removeObserver(u,v)}for(const[u,v]of Object.entries(g.value||{})){const y=Number(u);for(const[j,J]of Object.entries(v||{})){const z=G(r,s,J);o.push([y,s.sceneManager.addObserver(y,j,z)]),z()}}}else{for(;o.length;){const[u,v]=o.pop();s.sceneManager.unObserve(u,v)}for(const[u,v]of Object.entries(g.value||{})){const y=Number(u);for(const[j,J]of Object.entries(v||{})){const z=G(r,s,J);o.push([y,s.sceneManager.observe(y,j,z)]),z()}}}}),s.sceneManager.startEventLoop(t.renderWindow)||console.error("Could not startEventLoop for",t.renderWindow),s.cameraIds.forEach(u=>{e("camera",s.getState(u))})}),S.onBeforeUnmount(()=>{m&&Ve(),O&&(O(),O=null);const l=s.sceneManager.removeObserver?"removeObserver":"unObserve";for(;i.length;){const[u,v]=i.pop();s.sceneManager[l](u,v)}for(;o.length;){const[u,v]=o.pop();s.sceneManager[l](u,v)}s.sceneManager.stopEventLoop(t.renderWindow),R&&(R.disconnect(),R=null),s.unbindCanvasToDOM(t.renderWindow)});function De(l){G(r,s,l)()}function Ke(l){return s.getVtkObject(l)}function qe(){t.useHandler&&U[t.useHandler]&&delete U[t.useHandler]}return{container:f,update:de,resetCamera:Ne,render:Fe,evalStateExtract:De,invoke:He,resize:le,wasmManager:s,printSceneManagerInformation:$e,detachHandler:qe,getVtkObject:Ke,progress:d,showLoading:b,statePercent:c,hashPercent:w,wasmLoading:p}},template:`<div ref="container" style="position: relative; width: 100%; height: 100%;">
    <slot
      v-if="showLoading"
      name="loader"
      :progress="progress"
      :wasm-loading="wasmLoading"
      :state-percent="statePercent"
      :hash-percent="hashPercent"
      :show-loading="showLoading"
    >
      <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(10, 10, 10, 0.45); z-index: 2;">
        <div style="min-width: 220px; max-width: 320px; padding: 12px 14px; border-radius: 8px; background: rgba(20, 20, 20, 0.9); color: #f5f5f5;">
          <div style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 8px;">
            {{ wasmLoading ? "Loading VTK WASM" : "Syncing VTK Data" }}
          </div>
          <div v-if="wasmLoading" style="font-size: 12px; opacity: 0.85;">
            Fetching WebAssembly bundle...
          </div>
          <div v-else>
            <div style="margin-bottom: 10px;">
              <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; opacity: 0.8;">
                <span>States</span>
                <span>{{ progress.state.current }}/{{ progress.state.total }}</span>
              </div>
              <div style="height: 6px; background: rgba(255, 255, 255, 0.15); border-radius: 4px; overflow: hidden;">
                <div :style="{ width: statePercent + '%', height: '100%', background: '#4aa3ff' }"></div>
              </div>
            </div>
            <div>
              <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; opacity: 0.8;">
                <span>Blobs</span>
                <span>{{ progress.hash.current }}/{{ progress.hash.total }}</span>
              </div>
              <div style="height: 6px; background: rgba(255, 255, 255, 0.15); border-radius: 4px; overflow: hidden;">
                <div :style="{ width: hashPercent + '%', height: '100%', background: '#f5c542' }"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </slot>
  </div>`}};function Ee(t){Object.keys(ce).forEach(e=>{t.component(e,ce[e])})}A.install=Ee,Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});
