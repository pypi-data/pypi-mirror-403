service: mcp-ecs

provider:
  name: aws
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, "ap-southeast-2"}
  environment:    
    REGION_CODE: ${self:custom.resourceRegion.${self:provider.stage}}
  
custom:
  myStage: ${opt:stage}
  resourceRegion:
    dev: aus
    prod: aus
    prodeu: eu
    produs: us
  domain:
    dev: toothfairylab.link
    prod: toothfairyai.com
    prodeu: eu.toothfairyai.com
    produs: us.toothfairyai.com
  mcpDomain:
    dev: mcp.toothfairylab.link
    prod: mcp.toothfairyai.com
    prodeu: mcp.eu.toothfairyai.com
    produs: mcp.us.toothfairyai.com
  aiEFSendpoints: ${ssm:/aiEFSendpoints}
  # serverless documentation plugin configuration stored in a separate file
  provisionedConcurrency: 
    dev: 0
    prod: 1
    prodeu: 1
    produs: 1
  bedrockResourceRegion:
    dev: "apac"
    prod: "apac"
    prodeu: "eu"
    produs: "us"


resources:
  Resources:
    ECSTaskExecutionRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: ${self:service}-TaskExecutionRole-${sls:stage}
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: ecs-tasks.amazonaws.com
              Action: sts:AssumeRole
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

    ECSTaskRole:
        Type: AWS::IAM::Role
        Properties:
          RoleName: ${self:service}-TaskRole-${sls:stage}
          AssumeRolePolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Principal:
                  Service: ecs-tasks.amazonaws.com
                Action: sts:AssumeRole
          Policies:
            - PolicyName: ECSTaskPolicy
              PolicyDocument:
                Version: '2012-10-17'
                Statement:
                  - Effect: Allow
                    Action:
                      - xray:PutTraceSegments
                      - xray:PutTelemetryRecords
                      - dynamodb:GetItem
                      - dynamodb:Query
                      - dynamodb:Scan
                      - s3:*
                      - ssm:GetParameter
                      - sagemaker:InvokeEndpoint
                      - lambda:InvokeFunction
                      - lambda:InvokeAsync
                      - secretsmanager:GetSecretValue
                      - bedrock:*
                      - sqs:sendmessage
                      - logs:CreateLogGroup
                      - logs:CreateLogStream
                      - logs:PutLogEvents
                      - logs:DescribeLogStreams
                    Resource: "*"

    ECSLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /ecs/${self:service}
        RetentionInDays: 1  

    ECSCluster:
      Type: AWS::ECS::Cluster
      Properties:
        ClusterName: ${self:service}-cluster

    ECSTaskDefinition:
        Type: AWS::ECS::TaskDefinition
        Properties:
          Family: ${self:service}-task
          Cpu: '1024'
          Memory: '2048'
          NetworkMode: awsvpc
          RequiresCompatibilities:
            - FARGATE
          ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
          TaskRoleArn: !GetAtt ECSTaskRole.Arn
          ContainerDefinitions:
            - Name: ${self:service}-container
              Image: !Sub ${AWS::AccountId}.dkr.ecr.${opt:region}.amazonaws.com/tf-mcp:latest # Replace with your ECR image
              Essential: true
              PortMappings:
                - ContainerPort: 8000
                  Protocol: tcp
              HealthCheck:
                Command:
                  - CMD-SHELL
                  - curl -f http://localhost:8000/health || exit 1
                Interval: 30
                Timeout: 5
                Retries: 3
                StartPeriod: 60
              LogConfiguration:
                LogDriver: awslogs
                Options:
                  awslogs-group: !Ref ECSLogGroup
                  awslogs-region: ${self:provider.region}
                  awslogs-stream-prefix: ecs
              StopTimeout: 120

    ECSService:
      Type: AWS::ECS::Service
      DependsOn: ECSLogGroup
      Properties:
        ServiceName: ${self:service}-service
        Cluster: !Ref ECSCluster
        TaskDefinition: !Ref ECSTaskDefinition
        DesiredCount: 1
        LaunchType: FARGATE
        PlatformVersion: LATEST
        DeploymentConfiguration:
          MaximumPercent: 200
          MinimumHealthyPercent: 50
          DeploymentCircuitBreaker:
            Enable: true
            Rollback: true
        HealthCheckGracePeriodSeconds: 300
        NetworkConfiguration:
          AwsvpcConfiguration:
            AssignPublicIp: DISABLED
            SecurityGroups: 
              - ${self:custom.aiEFSendpoints.securityGroupIds}
            Subnets: 
              - ${self:custom.aiEFSendpoints.subnetIds}
        LoadBalancers:
          - ContainerName: ${self:service}-container
            ContainerPort: 8000
            TargetGroupArn: ${ssm:/mcpEcsTargetGroup}

    ECSAutoScalingTarget:
      Type: AWS::ApplicationAutoScaling::ScalableTarget
      Properties:
        MaxCapacity: 5
        MinCapacity: 1
        ResourceId: 
          Fn::Sub: service/${ECSCluster}/${ECSService.Name}
        ScalableDimension: ecs:service:DesiredCount
        ServiceNamespace: ecs
        RoleARN: !Sub arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService

    ECSAutoScalingPolicy:
      Type: AWS::ApplicationAutoScaling::ScalingPolicy
      Properties:
        PolicyName: ${self:service}-cpu-scaling-policy
        PolicyType: TargetTrackingScaling
        ScalingTargetId: !Ref ECSAutoScalingTarget
        TargetTrackingScalingPolicyConfiguration:
          PredefinedMetricSpecification:
            PredefinedMetricType: ECSServiceAverageCPUUtilization
          TargetValue: 70.0
          ScaleInCooldown: 300
          ScaleOutCooldown: 120
          
  Outputs:
    ClusterName:
      Description: The name of the ECS cluster
      Value:
        Ref: ECSCluster
    ServiceName:
      Description: The name of the ECS service
      Value:
        Ref: ECSService
    McpEndpoint:
      Description: The MCP SSE endpoint URL for Claude Code
      Value: https://${self:custom.mcpDomain.${self:provider.stage}}/sse
