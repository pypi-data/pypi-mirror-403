"""Dockerfile generation for paude."""

from __future__ import annotations

from paude.config.models import PaudeConfig


def generate_pip_install_dockerfile(config: PaudeConfig) -> str:
    """Generate a minimal Dockerfile that just adds pip_install to a paude base image.

    Use this when layering on top of the default paude image which already has
    Claude Code, entrypoints, and all system packages installed.

    Args:
        config: Parsed paude configuration.

    Returns:
        Generated Dockerfile content.
    """
    lines: list[str] = []

    lines.append("# Auto-generated by paude - DO NOT EDIT")
    lines.append("ARG BASE_IMAGE")
    lines.append("FROM ${BASE_IMAGE}")

    if config.pip_install:
        lines.append("")
        lines.append("# Build-time pip install for venv isolation")
        lines.append("USER root")
        lines.append("COPY . /opt/workspace-src")
        lines.append("RUN python3 -m venv /opt/venv")

        if isinstance(config.pip_install, str):
            pip_cmd = config.pip_install
        else:
            pip_cmd = "pip install -e /opt/workspace-src"

        # Prepend full paths for pip and uv commands
        if pip_cmd.startswith("pip "):
            lines.append(f"RUN /opt/venv/bin/{pip_cmd}")
        elif pip_cmd.startswith("uv "):
            lines.append(f"RUN /usr/local/bin/{pip_cmd}")
        else:
            lines.append(f"RUN {pip_cmd}")
        lines.append("RUN chown -R paude:0 /opt/venv && chmod -R g+rwX /opt/venv")

        lines.append("")
        lines.append("USER paude")
        lines.append("WORKDIR /home/paude")

    return "\n".join(lines)


def generate_workspace_dockerfile(config: PaudeConfig) -> str:
    """Generate a Dockerfile that wraps the user's base image with paude requirements.

    This output matches the bash generate_workspace_dockerfile() function exactly.

    Args:
        config: Parsed paude configuration.

    Returns:
        Generated Dockerfile content.
    """
    lines: list[str] = []

    # Header
    lines.append("# Auto-generated by paude - DO NOT EDIT")
    lines.append("ARG BASE_IMAGE")
    lines.append("FROM ${BASE_IMAGE}")

    # Add user-specified packages if any (from paude.json "packages" array)
    if config.packages:
        pkg_list = " ".join(config.packages)
        lines.append("")
        lines.append("# User-specified packages from paude.json")
        lines.append(f"""RUN if command -v apt-get >/dev/null 2>&1; then \\
        apt-get update && apt-get install -y {pkg_list} && rm -rf /var/lib/apt/lists/*; \\
    elif command -v apk >/dev/null 2>&1; then \\
        apk add --no-cache {pkg_list}; \\
    elif command -v dnf >/dev/null 2>&1; then \\
        dnf install -y {pkg_list} && dnf clean all; \\
    elif command -v yum >/dev/null 2>&1; then \\
        yum install -y {pkg_list} && yum clean all; \\
    fi""")

    # Standard paude requirements (including tmux for OpenShift session persistence)
    lines.append("")
    lines.append("""# Install required system packages
RUN if command -v apt-get >/dev/null 2>&1; then \\
        apt-get update && \\
        apt-get install -y --no-install-recommends git curl ca-certificates bash tmux locales && \\
        rm -rf /var/lib/apt/lists/* && \\
        localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8; \\
    elif command -v apk >/dev/null 2>&1; then \\
        apk add --no-cache git curl ca-certificates bash tmux; \\
    elif command -v dnf >/dev/null 2>&1; then \\
        dnf install -y git curl ca-certificates bash tmux glibc-langpack-en && \\
        dnf clean all; \\
    elif command -v yum >/dev/null 2>&1; then \\
        yum install -y git curl ca-certificates bash tmux glibc-langpack-en && \\
        yum clean all; \\
    else \\
        echo "Warning: Unknown package manager, git may not be available" >&2; \\
    fi""")

    lines.append("")
    lines.append("# Set UTF-8 locale for proper terminal rendering")
    lines.append("ENV LANG=en_US.UTF-8")
    lines.append("ENV LC_ALL=en_US.UTF-8")

    lines.append("")
    lines.append("# Create paude user with root group (GID 0) for OpenShift compatibility")
    lines.append("# OpenShift runs containers with arbitrary UIDs but GID 0, so home must be group-writable")
    lines.append(
        "RUN (id paude >/dev/null 2>&1 || useradd -m -s /bin/bash -g 0 paude 2>/dev/null || adduser -D -s /bin/bash -G root paude) && "
        "chmod -R g+rwX /home/paude && "
        "mkdir -p /home/paude/.claude /home/paude/.config && "
        "chmod -R g+rwX /home/paude/.claude /home/paude/.config"
    )

    lines.append("")
    lines.append("# Install Claude Code using native installer (as paude user)")
    lines.append("USER paude")
    lines.append("WORKDIR /home/paude")
    lines.append("RUN curl -fsSL https://claude.ai/install.sh | bash")

    lines.append("")
    lines.append("# Disable auto-updates (version controlled by image rebuild)")
    lines.append("ENV DISABLE_AUTOUPDATER=1")

    lines.append("")
    lines.append("# Ensure claude is in PATH")
    lines.append('ENV PATH="/home/paude/.local/bin:$PATH"')

    if config.pip_install:
        lines.append("")
        lines.append("# Build-time pip install for venv isolation")
        lines.append("USER root")
        lines.append("COPY . /opt/workspace-src")
        lines.append("RUN python3 -m venv /opt/venv")

        if isinstance(config.pip_install, str):
            pip_cmd = config.pip_install
        else:
            pip_cmd = "pip install -e /opt/workspace-src"

        # Prepend full paths for pip and uv commands
        if pip_cmd.startswith("pip "):
            lines.append(f"RUN /opt/venv/bin/{pip_cmd}")
        elif pip_cmd.startswith("uv "):
            lines.append(f"RUN /usr/local/bin/{pip_cmd}")
        else:
            lines.append(f"RUN {pip_cmd}")
        lines.append("RUN chown -R paude:0 /opt/venv && chmod -R g+rwX /opt/venv")

    lines.append("")
    lines.append("# Copy entrypoints (requires root)")
    lines.append("USER root")
    lines.append("COPY entrypoint.sh /usr/local/bin/entrypoint.sh")
    lines.append("COPY entrypoint-session.sh /usr/local/bin/entrypoint-session.sh")
    lines.append("RUN chmod +x /usr/local/bin/entrypoint.sh /usr/local/bin/entrypoint-session.sh")

    lines.append("")
    lines.append("# Fix permissions on directories created by Claude install")
    lines.append("# Must be done as root after Claude install, for OpenShift arbitrary UID")
    lines.append("RUN chmod -R g+rwX /home/paude")

    lines.append("")
    lines.append("USER paude")
    lines.append("WORKDIR /home/paude")
    lines.append("ENTRYPOINT [\"/usr/local/bin/entrypoint.sh\"]")

    return "\n".join(lines)
