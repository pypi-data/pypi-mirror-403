"""Markdown to HTML conversion with chart support."""

import re
from datetime import datetime

import markdown

from .regex import CHARTJS_CODE_BLOCK_RE, MERMAID_CODE_BLOCK_RE
from .styles import load_styles

# Counter for unique chart IDs
_chart_counter = 0


def _replace_mermaid(match: re.Match) -> str:
    """Replace Mermaid code blocks with Mermaid divs."""
    code = match.group(1)
    # Unescape HTML entities
    code = (
        code.replace("&lt;", "<")
        .replace("&gt;", ">")
        .replace("&amp;", "&")
    )
    return f'<div class="mermaid">\n{code}\n</div>'


def _replace_chartjs(match: re.Match) -> str:
    """Replace Chart.js code blocks with canvas + script."""
    global _chart_counter
    _chart_counter += 1
    chart_id = f"chart_{_chart_counter}"
    config = match.group(1)
    # Unescape HTML entities
    config = (
        config.replace("&lt;", "<")
        .replace("&gt;", ">")
        .replace("&amp;", "&")
        .replace("&quot;", '"')
    )
    return f'''<div class="chart-container">
    <canvas id="{chart_id}"></canvas>
</div>
<script>
    (function() {{
        try {{
            const ctx = document.getElementById('{chart_id}').getContext('2d');
            new Chart(ctx, {config});
        }} catch (e) {{
            console.error('Chart.js error:', e);
            document.getElementById('{chart_id}').parentElement.innerHTML = '<p style="color: red;">Chart rendering failed</p>';
        }}
    }})();
</script>'''


def markdown_to_html_with_charts(md_text: str, title: str = "Report") -> str:
    """Convert markdown to HTML with Mermaid and Chart.js support."""
    global _chart_counter

    # Convert markdown to HTML
    body = markdown.markdown(
        md_text,
        extensions=["fenced_code", "tables", "toc", "nl2br"],
    )

    # Replace mermaid code blocks with mermaid divs
    body = MERMAID_CODE_BLOCK_RE.sub(_replace_mermaid, body)

    # Replace chartjs code blocks with canvas + script
    body = CHARTJS_CODE_BLOCK_RE.sub(_replace_chartjs, body)

    # Load custom styles
    custom_styles = load_styles()

    # Build complete HTML document with Mermaid JS and Chart.js
    html = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>{title}</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Mermaid JS -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {{
            mermaid.initialize({{
                startOnLoad: true,
                theme: 'default',
                flowchart: {{
                    useMaxWidth: true,
                    htmlLabels: true,
                    curve: 'basis'
                }},
                pie: {{
                    useMaxWidth: true
                }},
                themeVariables: {{
                    fontSize: '14px'
                }}
            }});
        }});
    </script>

    <style>
{custom_styles}

        /* Mermaid diagram styling - responsive sizing */
        .mermaid {{
            margin: 1.5em 0;
            text-align: center;
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
        }}

        .mermaid svg {{
            max-width: 100%;
            height: auto;
            min-height: 200px;
        }}

        /* Chart.js container styling */
        .chart-container {{
            position: relative;
            margin: 1.5em 0;
            padding: 1em;
            background: #fafafa;
            border-radius: 8px;
            width: 100%;
            max-width: 100%;
        }}

        .chart-container canvas {{
            max-width: 100%;
            height: auto !important;
            min-height: 300px;
            max-height: 400px;
        }}
    </style>
</head>
<body>
{body}
    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ecf0f1; text-align: center; font-size: 9pt; color: #6c757d;">
        Generated by Text2Report on {datetime.now().strftime("%Y-%m-%d %H:%M")}
    </footer>
</body>
</html>"""
    return html
