"""Report Generator - Generate PDF reports from data using LLM and Playwright."""

import logging
import uuid
from datetime import datetime
from pathlib import Path
from typing import Any, Optional

from .html_renderer import markdown_to_html_with_charts
from .markdown_llm import generate_markdown
from .pdf_renderer import html_to_pdf_with_playwright
from .report_config import Preset, ReportConfig
from .utils.async_utils import run_async_safe
from .utils.paths import ensure_output_dir

logger = logging.getLogger(__name__)


def generate_report(
    data: Any,
    output_path: str | Path | None = None,
    question: str | None = None,
    charts: list | None = None,  # Kept for API compatibility, but ignored (Mermaid replaces this)
    # New behavior customization parameters
    config: Optional[ReportConfig] = None,
    audience: Optional[str] = None,
    style: Optional[str] = None,
    tone: Optional[str] = None,
    focus: Optional[list[str]] = None,
    preset: Optional[str] = None,
) -> str:
    """
    Generate a PDF report from data using LLM and Playwright.

    Uses Ollama LLM to generate a markdown report with Mermaid diagrams,
    then renders it to PDF using Playwright (Chromium).

    Args:
        data: Input data - can be text, dict, list, JSON string, etc.
        output_path: Optional path for the output PDF. If not provided,
                     generates a unique filename in the temp directory.
        question: The user's original question. Helps the LLM generate
                  a relevant report.
        charts: Ignored - kept for backward compatibility. Mermaid diagrams
                are generated by the LLM instead.

        --- Behavior Customization (NEW) ---
        config: ReportConfig object for complete control over report behavior.
                If provided, overrides individual audience/style/tone/focus params.
        audience: Target audience (executives|technical|analysts|general)
        style: Report style (concise|detailed|visual_heavy)
        tone: Report tone (formal|persuasive|casual)
        focus: List of focus areas (metrics, recommendations, trends, comparisons, insights)
        preset: Use a preset configuration (executive_summary|technical_deep_dive|
                data_analysis|sales_presentation|quick_overview)

    Returns:
        Path to the generated PDF file as a string

    Examples:
        # Basic usage (backward compatible)
        >>> path = generate_report(sales_data, question="Analyze Q4 performance")

        # Using individual behavior parameters
        >>> path = generate_report(
        ...     data,
        ...     question="Analyze sales",
        ...     audience="executives",
        ...     style="concise",
        ...     tone="formal"
        ... )

        # Using a preset
        >>> path = generate_report(
        ...     data,
        ...     question="Analyze sales",
        ...     preset="executive_summary"
        ... )

        # Using ReportConfig for full control
        >>> from thinkscribe import ReportConfig, Audience, Style, Tone
        >>> config = ReportConfig(
        ...     audience=Audience.TECHNICAL,
        ...     style=Style.DETAILED,
        ...     tone=Tone.FORMAL
        ... )
        >>> path = generate_report(data, question="...", config=config)
    """
    # Build config from parameters if not provided
    if config is None and any([preset, audience, style, tone, focus]):
        # If preset is specified, use it as base
        if preset:
            config = ReportConfig.from_preset(Preset(preset))
            # Override with individual parameters if provided
            if audience:
                from .report_config import Audience
                config.audience = Audience(audience)
            if style:
                from .report_config import Style
                config.style = Style(style)
            if tone:
                from .report_config import Tone
                config.tone = Tone(tone)
            if focus:
                from .report_config import FocusArea
                config.focus = [FocusArea(f) for f in focus]
        else:
            # Build config from individual parameters
            from .report_config import Audience, FocusArea, Style, Tone
            config = ReportConfig(
                audience=Audience(audience) if audience else None,
                style=Style(style) if style else None,
                tone=Tone(tone) if tone else None,
                focus=[FocusArea(f) for f in focus] if focus else None,
            )

    # Determine output path
    if output_path is None:
        output_dir = ensure_output_dir()
        filename = f"report_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{uuid.uuid4().hex[:6]}.pdf"
        output_path = output_dir / filename
    else:
        output_path = Path(output_path)
        output_path.parent.mkdir(parents=True, exist_ok=True)

    logger.info("Starting report generation...")
    if config:
        logger.info(f"Using config: {config.to_dict()}")

    try:
        # Step 1: Generate markdown via LLM
        logger.info("Step 1: Generating markdown via LLM...")
        md_content = generate_markdown(data, question, config=config)
        logger.info(f"Generated markdown ({len(md_content)} chars)")
        logger.debug(f"Markdown preview:\n{md_content[:500]}...")

        # Step 2: Convert markdown to HTML (with Mermaid and Chart.js support)
        logger.info("Step 2: Converting markdown to HTML...")
        html_content = markdown_to_html_with_charts(md_content, title="Report")
        logger.info(f"Generated HTML ({len(html_content)} chars)")

        # Step 3: Write HTML to temp file
        html_path = output_path.with_suffix(".html")
        html_path.write_text(html_content, encoding="utf-8")
        logger.info(f"Step 3: Wrote HTML to: {html_path}")

        # Step 4: Convert HTML to PDF using Playwright
        logger.info("Step 4: Converting HTML to PDF with Playwright...")
        run_async_safe(html_to_pdf_with_playwright(html_path, output_path))
        logger.info(f"Step 4 complete: PDF generated at {output_path}")

        # Step 5: Clean up temp HTML file
        try:
            html_path.unlink()
        except Exception:
            pass

        logger.info(f"Report generated successfully: {output_path}")
        return str(output_path)

    except Exception as e:
        logger.exception(f"Failed to generate report: {e}")
        raise
