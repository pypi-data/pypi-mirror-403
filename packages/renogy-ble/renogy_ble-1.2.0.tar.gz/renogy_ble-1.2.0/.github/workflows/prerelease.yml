name: Prerelease

on:
  pull_request:
    branches: [main]
    types: [opened]
  workflow_dispatch:
    inputs:
      release_branch:
        description: Release Please branch to build from
        required: false
        default: release-please--branches--main
      semantic_version:
        description: Optional semantic version to publish (x.x.x)
        required: false
      prerelease:
        description: Prerelease type (defaults to beta)
        required: false
        type: choice
        options:
          - beta
          - alpha
      beta_iteration:
        description: Optional beta iteration identifier (defaults to run number)
        required: false

permissions:
  contents: write
  id-token: write

jobs:
  publish-beta:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && startsWith(github.event.pull_request.head.ref, 'release-please--'))
    runs-on: ubuntu-latest
    environment: release
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && (inputs.release_branch || 'release-please--main') || github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install

      - name: Derive beta version
        id: version
        env:
          BETA_ITERATION: ${{ github.event_name == 'workflow_dispatch' && inputs.beta_iteration || '' }}
          SEMANTIC_VERSION: ${{ github.event_name == 'workflow_dispatch' && inputs.semantic_version || '' }}
          PRERELEASE_ID: ${{ github.event_name == 'workflow_dispatch' && inputs.prerelease || '' }}
        run: |
          python - <<'PY'
          from pathlib import Path
          import os
          import re
          import sys

          pyproject = Path("pyproject.toml")
          content = pyproject.read_text(encoding="utf-8")

          match = re.search(r'^version\s*=\s*"(?P<version>[^"]+)"', content, flags=re.MULTILINE)
          if not match:
            sys.exit("Version not found in pyproject.toml")

          semver_input = os.environ.get("SEMANTIC_VERSION", "").strip()
          prerelease_input = os.environ.get("PRERELEASE_ID", "").strip().lower()
          prerelease_map = {"alpha": "a", "beta": "b", "a": "a", "b": "b"}
          if prerelease_input and prerelease_input not in prerelease_map:
            sys.exit("Invalid prerelease identifier. Use 'alpha' or 'beta'.")

          if semver_input:
            if not re.fullmatch(r"\d+\.\d+\.\d+", semver_input):
              sys.exit("Invalid semantic version. Use x.x.x format.")
            base_version = semver_input
          else:
            base_version = match.group("version")

          prerelease = prerelease_map.get(prerelease_input, "b")
          iteration = os.environ.get("BETA_ITERATION") or os.environ.get("GITHUB_RUN_NUMBER")
          beta_version = f"{base_version}{prerelease}{iteration}"

          new_content = re.sub(
            r'^version\s*=\s*".*"',
            f'version = "{beta_version}"',
            content,
            count=1,
            flags=re.MULTILINE,
          )
          pyproject.write_text(new_content, encoding="utf-8")

          print(f"Publishing beta version {beta_version}")
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as output:
            output.write(f"beta_version={beta_version}\n")
          PY

      - name: Build package
        run: uv build

      - name: Publish beta to PyPI
        run: uv publish
