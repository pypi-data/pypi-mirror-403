"use strict";(self.webpackChunk_atoti_jupyterlab_extension=self.webpackChunk_atoti_jupyterlab_extension||[]).push([[2342],{82342:(e,t,l)=>{l.r(t),l.d(t,{default:()=>Q});var n=l(74389),r=l(31529),o=l(93345),i=l(96531),a=l(52112),s=l(47357),c=l(25097),u=l(47676),d=l(8622),p=l(50716),m=l(29213),f=l(40570);const h=e=>{const t=(0,o.useMemo)((()=>o.Children.toArray(e.children).reduce(((t,l,n)=>{const r=Math.floor(n/e.numberOfColumns),o=t[r]??[];return t[r]=[...o,l],t}),[])),[e.children,e.numberOfColumns]);return(0,n.Y)("div",{style:e.containerStyle,css:{paddingBottom:2,paddingRight:2,width:"100%",height:"100%"},children:(0,n.Y)("div",{css:{width:"100%",height:"100%",overflow:"auto"},children:(0,n.Y)("table",{css:f.css`
            border-spacing: 20px 10px;
            border-collapse: separate !important;
            width: 100%;
          `,children:(0,n.Y)("tbody",{children:t.map(((e,t)=>(0,n.Y)("tr",{children:e.map(((e,t)=>(0,n.Y)("td",{children:e},t)))},t)))})})})})};var y=l(86189),g=l(45795),C=l(38159),b=l(25617),v=l(94717),S=l(18664);const x=e=>{const t=(0,v.F)(),[l,r]=(0,o.useState)(e.title);return(0,o.useEffect)((()=>{r(e.title)}),[e.title]),(0,n.Y)(S.AutoSizedInput,{readOnly:t,value:l,onChange:r,onBlur:()=>{e.onTitleChange?.(l)}})},w=({differenceCell:e,referenceValue:t,measureStyle:l,isDifferenceInPercentage:n})=>{const r=Number(e?.value);return isNaN(r)||n&&isNaN(t)?"N/A":`${r>0?"+":""}${n?(0,g.m)({value:r/Math.abs(t),valueFormattedByAtotiServer:"N/A",numericFieldStyle:{numberFormat:"percentage",numberOfDecimals:2}}):(0,g.m)({value:r,valueFormattedByAtotiServer:e?.formattedValue??"N/A",numericFieldStyle:l})}`},I=({difference:e,referenceValue:t,theme:l,isDifferenceInPercentage:n})=>isNaN(e)||0===e||n&&isNaN(t)?l.textColor:e>0?l.successColor:l.errorColor,M=e=>{const t=(0,b.DP)(),{formatMessage:l}=(0,s.useIntl)(),{onTitleChange:a,title:c,isTime:u,tuple:d,onSelect:p,isSelected:m,differenceCell:f,style:h}=e,v=Number(e.referenceCell?.value),S=m?`${t.selectionOverlayColor}`:"none",M=(0,o.useMemo)((()=>{const e=d.find(y.t)?.namePath[0];return e?h?.measures?.[e]:void 0}),[d,h?.measures]),T=e.comparedCell&&(0,r.isNumber)(e.comparedCell.value)&&e.comparedCell.value<0,[[D,Y],[N,O]]=(0,o.useMemo)((()=>[e.referenceCell,e.comparedCell].map((e=>[(0,g.m)({value:Number(e?.value??0),valueFormattedByAtotiServer:e?.formattedValue??"N/A",numericFieldStyle:M}),(0,C.T)({fieldStyle:M,value:e?.value})]))),[M,e.referenceCell,e.comparedCell]);return(0,n.FD)("div",{style:{background:S,height:83,display:"flex",alignItems:"flex-end",padding:"0px 2px"},onMouseDown:e=>{(0===e.button||!m&&2===e.button)&&p({cell:f,tuple:d,isSelected:m})},children:[(0,n.Y)("span",{style:{borderLeft:`3px solid ${t.primaryColor}`,height:75}}),(0,n.FD)("div",{style:{display:"flex",paddingLeft:5,flexDirection:"column"},children:[(0,n.Y)(x,{title:c,onTitleChange:e=>{const t=(0,i.getTupleKey)(d);a?.({tupleKey:t,title:e})}}),(0,n.FD)("div",{style:{display:"flex"},children:[(0,n.FD)("div",{style:{display:"flex",flexDirection:"column",justifyContent:"space-between",whiteSpace:"nowrap",paddingLeft:2},children:[(0,n.Y)("span",{style:{fontWeight:600,fontSize:20,lineHeight:1.5,color:O.backgroundColor||(T?t.errorColor:void 0)},children:N}),u?l({id:"aui.plugins.widget.kpi.on"},{value:e.comparedMemberCaption}):e.comparedMemberCaption]}),(0,n.Y)("span",{style:{margin:"8px 10px 3px",borderLeft:`1px solid ${t.grayScale[4]}`}}),(0,n.FD)("div",{style:{paddingTop:3,display:"flex",justifyContent:"space-around",flexDirection:"column",whiteSpace:"nowrap"},children:[(0,n.Y)("span",{style:{color:I({difference:Number(e.differenceCell?.value),referenceValue:v,theme:t,isDifferenceInPercentage:h?.isDifferenceInPercentage}),fontWeight:500},children:w({differenceCell:e.differenceCell,measureStyle:M,referenceValue:v,isDifferenceInPercentage:h?.isDifferenceInPercentage})}),(0,n.Y)("span",{style:{fontSize:9,color:Y.backgroundColor},children:l({id:"aui.plugins.widget.kpi.vs"},{value:D})}),u?l({id:"aui.plugins.widget.kpi.on"},{value:e.referenceMemberCaption}):e.referenceMemberCaption]})]})]})]})},T=(e,t)=>{const l=[];return e&&t&&l.push({tuple:t,value:e.value}),{axes:[],cells:l}};var D=l(80456);function Y(e,t){const{cells:l,numberOfColumns:n,numberOfRows:r}=(0,o.useMemo)((()=>{let t,l;for(let n=0;n<e.axes.length;n++){const r=e.axes[n];if(r.id===m.axisIds.columns?l=r:r.id===m.axisIds.rows&&(t=r),void 0!==t&&void 0!==l)break}const n=l?(0,i.getAxisLength)(l):1,r=t?(0,i.getAxisLength)(t):1,o=new Array(n*r).fill(null);return e.cells.forEach((e=>{o[e.ordinal]=e})),{numberOfColumns:n,numberOfRows:r,cells:o}}),[e]),a=(0,o.useMemo)((()=>(0,i.getHierarchyIndicesInCellSet)(e)),[e]);return{cells:l,numberOfColumns:n,numberOfRows:r,cube:(0,o.useMemo)((()=>{const l=e.cube;return(0,D.W)(t,l)}),[e,t]),hierarchyIndicesInCellSet:a}}const N=["referenceCell","comparedCell","differenceCell"],O=e=>{const{formatMessage:t}=(0,s.useIntl)(),{cube:l,hierarchyIndicesInCellSet:a,numberOfColumns:f,numberOfRows:y}=Y(e.data,e.dataModel),g=e.data.axes.find((({id:e})=>e===m.axisIds.pages));if(!g)throw new Error("A comparison was defined in the KPI widget state, but no corresponding data was found (no PAGES axis in the cellset).");const C=g.positions.length,b=(0,c.D)(g.hierarchies[0].dimension,l),v=t({id:"aui.total"}),[S,x]=(0,o.useMemo)((()=>{const{dimension:t,hierarchy:n}=g.hierarchies[0],r=g.positions.map((([r])=>(0,d.t)({captionForTotals:v,cube:l,mapping:e.mapping,member:{dimensionName:t,hierarchyName:n,...r},style:e.style})));return 3===C?r:["N/A",r[0]]}),[v,l,C,g,e.mapping,e.style]),w=(0,o.useMemo)((()=>{const t={},n=f*y;return e.data.cells.forEach((r=>{const o=Math.floor(r.ordinal%n/f),s=r.ordinal%f,c=(0,i.getTuple)({columnIndex:s,rowIndex:o,hierarchyIndicesInCellSet:a,data:e.data});if(c){const o=(0,i.getTupleKey)(c),a=t[o]?.title||e.titles?.[o]||(0,p.V)({captionForTotals:v,cube:l,mapping:e.mapping,tuple:c,style:e.style}),s=Math.floor(r.ordinal/n),u=3===C?N[s]:s===C-1?"differenceCell":"comparedCell";t[o]={...t[o],[u]:r,title:a,tuple:c}}}),{}),t}),[v,l,a,f,y,C,e.data,e.titles,e.mapping,e.style]),{titles:I,onTitlesChange:D,onSelectionChange:O}=e,F=({tupleKey:e,title:t})=>{D?.({...I,[e]:t})},[k,A]=(0,o.useState)({axes:[],cells:[]}),K=k.cells?.[0]?(0,i.getTupleKey)(k.cells[0].tuple):void 0,E=({cell:e,tuple:t,isSelected:l})=>{const n=l?{axes:[],cells:[]}:T(e,t);A(n)};(0,o.useEffect)((()=>{O?.(k)}),[k,O]);const P=(0,r.map)(w,(({referenceCell:t,comparedCell:l,differenceCell:r,title:o,tuple:i},a)=>(0,n.Y)(M,{comparedCell:l,comparedMemberCaption:x,isTime:(0,u.K)(b),differenceCell:r,title:o,onTitleChange:F,referenceCell:t,referenceMemberCaption:S,tuple:i,onSelect:E,isSelected:K===a,style:e.style},a)));return(0,n.Y)(h,{numberOfColumns:f,containerStyle:e.containerStyle,children:P})};var F=l(18828),k=l(94230);const A=e=>{const t=(0,b.DP)(),{cell:l,tuple:r,tupleKey:i,onTitleChange:a,title:s,isSelected:c,onSelect:u,style:d}=e,p=(0,F.n)(l?.properties),m=c&&p.backgroundColor?(0,k.O)(p.backgroundColor,t.selectionOverlayColor,.2):c?t.selectionOverlayColor:p.backgroundColor??"none",[h,v]=(0,o.useMemo)((()=>{const e=r.find(y.t)?.namePath[0],t=e?d?.measures?.[e]:void 0;return[(0,g.m)({value:Number(l?.value),valueFormattedByAtotiServer:l?.formattedValue??"N/A",numericFieldStyle:t}),(0,C.T)({fieldStyle:t,value:l?.value})]}),[r,d?.measures,l]),S=v.color??v.backgroundColor??p.color;return(0,n.FD)("div",{css:f.css`
        padding-left: 6px;
        border-left: 3px solid ${t.primaryColor};
        white-space: nowrap;
      `,children:[(0,n.Y)(x,{title:s,onTitleChange:e=>{a({title:e,tupleKey:i})}}),(0,n.Y)("div",{onMouseDown:e=>{(0===e.button||!c&&2===e.button)&&u({cell:l,tuple:r,isSelected:c})},css:{background:m,fontSize:p.fontSize??30,height:50,display:"flex",alignItems:"center",paddingLeft:2,fontWeight:p.fontWeight,fontStyle:p.fontStyle,textDecoration:p.textDecoration},style:{...v,color:S,backgroundColor:void 0},children:h})]})},K=e=>{const{formatMessage:t}=(0,s.useIntl)(),{cells:l,numberOfColumns:r,cube:a,hierarchyIndicesInCellSet:c}=Y(e.data,e.dataModel),{titles:u,onTitlesChange:d,onSelectionChange:m}=e,f=({tupleKey:e,title:t})=>{d?.({...u,[e]:t})},[y,g]=(0,o.useState)({axes:[],cells:[]}),C=y.cells?.[0]?(0,i.getTupleKey)(y.cells[0].tuple):void 0,b=({cell:e,tuple:t,isSelected:l})=>{const n=l?{axes:[],cells:[]}:T(e,t);g(n)},v=t({id:"aui.total"}),S=(0,o.useMemo)((()=>{const t=[];return l.forEach(((l,n)=>{const o=Math.floor(n/r),s=n%r,d=(0,i.getTuple)({columnIndex:s,data:e.data,rowIndex:o,hierarchyIndicesInCellSet:c});if(d){const n=(0,i.getTupleKey)(d),r=a?(0,p.V)({captionForTotals:v,cube:a,mapping:e.mapping,tuple:d,style:e.style}):"",o=u?.[n]||r;t.push({cell:l,tuple:d,tupleKey:n,title:o})}})),t}),[l,a,e.data,c,r,u,v,e.mapping,e.style]);(0,o.useEffect)((()=>{m?.(y)}),[y,m]);const x=S.map((({cell:t,tuple:l,tupleKey:r,title:o},i)=>(0,n.Y)(A,{cell:t,cellIndex:i,tuple:l,tupleKey:r,title:o,onTitleChange:f,onSelect:b,isSelected:C===r,style:e.style},i)));return(0,n.Y)(h,{numberOfColumns:r,containerStyle:e.containerStyle,children:x})};var E=l(15184);const P=e=>{const{comparison:t,...l}=e;return(0,E.n)(e.comparison)?(0,n.Y)(O,{comparison:t,...l}):(0,n.Y)(K,{...l})};var L=l(9117),R=l(63449),V=l(45164);const B=(0,o.memo)((e=>{(0,S.useCallOnLoadedAfterFirstProperRender)(e);const{queryResult:t,widgetState:l,onChange:s,onSelectionChange:c}=e,u=t.data,{serverKey:d}=(0,R.useCube)(l),p=(0,a.H)(d),m=l.titles,f=(0,o.useCallback)((e=>s((0,r.isEmpty)(e)?(0,r.omit)(l,"titles"):{...l,titles:e})),[l,s]);if(!t.isLoading&&t.error){if((0,i.isErrorInQueryResultOfType)(t.error,"QueryTimeoutException"))throw new i.QueryTimeoutError(t.error);throw new i.QueryError(t.error)}return!p||(0,L.isMappingEmpty)(l.mapping)?(0,n.Y)(V.Q,{style:e.style}):u&&0!==u.cells.length?(0,n.Y)(P,{data:u,dataModel:p,titles:m,onTitlesChange:f,comparison:l.comparison,containerStyle:e.style,onSelectionChange:c,style:l.style,mapping:l.mapping}):(0,n.Y)(V.Q,{style:e.style,reason:"noData",widgetState:l,onStateChange:s})})),Q=(0,L.withLoadingOverlay)((0,L.withoutIrrelevantRenders)(B))}}]);