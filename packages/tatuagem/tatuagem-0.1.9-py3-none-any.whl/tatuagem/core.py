"""
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
111110000000000001111100000000001111111111100000000001111000000000001111000011111111111111110000000000000000000000111111111111111111100001111111111111111110000011111000000000011111000001111111111111111111
111111000000000011111000000000011111111111110000000001111000000000001111000011111111111111111100000000000000000000111111111111111111100001111111111111111110000011111100000000111110000001111111111111111111
011111000000000111110000000001111111111111111100000001111000000000001111000011111111111111111100000000000000000000111111111111111111100001111111111111111110000001111100000000111100000001111111111111111111
001111100000000111110000000011111111111111111100000001111000000000001111000011110000000111111110000000000000000000000000001111000000000001111000000000000000000000111110000001111100000000000000011110000000
001111100000001111100000000011111100000001111110000001111000000000001111000011110000000000111110000000000000000000000000001111000000000001111000000000000000000000011111000011111000000000000000011110000000
000111110000011111000000000111110000000000111111000001111000000000001111000011110000000000011110000000000000000000000000001111000000000001111000000000000000000000011111000111110000000000000000011110000000
000111111000011111000000000111110000000000011111000001111000000000001111000011110000000000011110000000000000000000000000001111000000000001111000000000000000000000001111101111110000000000000000011110000000
000011111000111110000000000111100000000000001111000001111000000000001111000011110000000000011110000000000000000000000000001111000000000001111000000000000000000000000111111111100000000000000000011110000000
000001111101111110000000001111100000000000001111100001111000000000001111000011110000000000111110000000000000000000000000001111000000000001111000000000000000000000000111111111000000000000000000011110000000
000001111111111100000000001111000000000000000111100001111000000000001111000011110000001111111110000000000000000000000000001111000000000001111000000000000000000000000011111110000000000000000000011110000000
000000111111111000000000001111000000000000000111100001111000000000001111000011111111111111111100000000000000000000000000001111000000000001111111111111111100000000000001111110000000000000000000011110000000
000000011111111000000000001111000000000000000111100001111000000000001111000011111111111111111000000000000000000000000000001111000000000001111111111111111100000000000001111110000000000000000000011110000000
000000011111110000000000001111000000000000000111100001111000000000001111000011111111111111110000000000000000000000000000001111000000000001111111111111111100000000000011111110000000000000000000011110000000
000000001111100000000000001111000000000000000111100001111000000000001111000011110001111111100000000000000000000000000000001111000000000001111000000000000000000000000111111111000000000000000000011110000000
000000001111100000000000001111100000000000001111100001111000000000001111000011110000001111110000000000000000000000000000001111000000000001111000000000000000000000000111111111100000000000000000011110000000
000000001111100000000000001111100000000000001111000001111000000000001111000011110000000111111000000000000000000000000000001111000000000001111000000000000000000000001111101111110000000000000000011110000000
000000001111100000000000000111110000000000011111000001111100000000001111000011110000000011111000000000000000000000000000001111000000000001111000000000000000000000011111000111110000000000000000011110000000
000000001111100000000000000111111000000000111111000001111100000000011111000011110000000001111100000000000000000000000000001111000000000001111000000000000000000000111111000011111000000000000000011110000000
000000001111100000000000000011111100000001111110000000111110000000111110000011110000000001111110000000000000000000000000001111000000000001111000000000000000000000111110000011111100000000000000011110000000
000000001111100000000000000001111111111111111100000000111111111111111110000011110000000000111110000000000000000000000000001111000000000001111000000000000000000001111100000001111100000000000000011110000000
000000001111100000000000000001111111111111111100000000011111111111111100000011110000000000011111000000000000000000000000001111000000000001111111111111111110000011111000000000111110000000000000011110000000
000000001111100000000000000000011111111111110000000000001111111111111000000011110000000000011111100000000000000000000000001111000000000001111111111111111110000111111000000000011111000000000000011110000000
000000001111100000000000000000001111111111100000000000000111111111110000000011110000000000001111100000000000000000000000001111000000000001111111111111111110000111110000000000011111100000000000011110000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

"""

"""
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00011100000000000000000000000000000011100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111100000000000000000000000000000111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111100000000000000000000000000000111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111100000000000000000000000000000111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111100000000000000000000000000000111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111100000000000000000000000000000111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111100000001111111111000000011111111100001110000000111100000001111111111000000000011111111011100000000111111110000000011101111111000111111100
11111111100000011111111111100000011111111100001110000000111100000011111111111100000000111111111111100000011111111111100000011111111111101111111110
11111111100000111111111111110000011111111100001110000000111100000111111111111110000001111111111111100000111111111111110000011111111111111111111111
00111100000001111111111111110000000111100000001110000000111100001111111111111110000001111111111111100000111111111111110000011111111111111111111111
00111100000001111000000011110000000111100000001110000000111100001111000000011110000011111000001111100001111100000011111000011111000011111100001111
00111100000000000000000011110000000111100000001110000000111100000000000000011110000011110000000111100001111000000001111000011110000011111000001111
00111100000000000001111111110000000111100000001110000000111100000000001111111110000011110000000111100001111111111111111000011110000011110000001111
00111100000000001111111111110000000111100000001110000000111100000001111111111110000011110000000111100001111111111111111000011100000011110000001111
00111100000000111111111111110000000111100000001110000000111100000111111111111110000011100000000011100001111111111111111000011100000011110000001111
00111100000001111111111111110000000111100000001110000000111100001111111111111110000011110000000011100001111000000000000000011100000011110000001111
00111100000001111110000011110000000111100000001110000000111100001111110000011110000011110000000111100001111000000000000000011100000011110000001111
00111100000001111000000011110000000111100000001111000000111100001111000000011110000011110000000111100001111000000001111000011100000011110000001111
00111100000001111000000111110000000111100000001111000001111100001111000000111110000011111000001111100001111100000011111000011100000011110000001111
00111110000001111111111111110000000111110000001111111111111100001111111111111110000001111111111111100000111111111111110000011100000011110000001111
00111111100001111111111111110000000111111100001111111111111100001111111111111110000001111111111111100000111111111111110000011100000011110000001111
00111111100000111111111111111000000111111100000111111111111100000111111111111111000000111111111111100000011111111111100000011100000011110000001111
00011111100000011111111001111000000011111100000011111111011100000011111111001111000000011111111111100000000111111111000000011100000011110000001111
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111100000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000011110000001111100000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111111111100000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111111000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111110000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111111100000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
"""

from .params import TEMPLATE_SIZE, Image, ImageDraw, ImageFont, BASE_DIR
from .initi import get_font_png_path, init_and_create_templates
import argparse, os

MARGIN = 3  # top and bottom margin of text
KWARGS_LIST = {"text", "backsplash", "font", "pattern", "margin"}
SPACE_MARGIN = 4  # This defines what a space should be in the font, because the space file is a solid sheet
FONT_DEFAULT = "unicode-arial.ttf"
DEFAULT_TEXT_CHAR = "1"
DEFAULT_BACKSPLASH_CHAR = "0"


# 3. Analyze RGB of Templates -> Produce Text Mask
def yield_char_matrix(char: str, font: str = FONT_DEFAULT, **kwargs):
    new_dir = os.path.join(BASE_DIR, "fonts", font[:-4])
    fpp = get_font_png_path(char, new_dir)
    imat = Image.open(fpp).quantize().getdata()
    o = [[] for _ in range(imat.size[1])]
    # fmt: off
    for ix, h in enumerate(range(imat.size[1])):
        for w in range(imat.size[0]):
            if char == " " and (SPACE_MARGIN < w < TEMPLATE_SIZE - SPACE_MARGIN):
                continue
            if (
                not sum([o - imat.getpixel((0,0,)) for o in [imat.getpixel((w,i,)) for i in range(imat.size[1])]])
                and char != " "
            ):
                continue
            o[ix].append(
                kwargs['text']
                if imat.getpixel((w, h,)) - imat.getpixel((0, 0,))
                else kwargs['backsplash']
            )
        # fmt: on
    return o


def tatuar(mat, pattern=None, backsplash=None, margin=None):
    # prints a `matrix`
    pure_mat = list(
        filter(lambda x: x and not all(c == backsplash for c in "".join(x)), mat)
    )
    margin = int(margin) if margin is not None else MARGIN
    if not pure_mat:
        return ""
    pure_mat = (
        (
            marg := [
                [backsplash * sum([len(x) for x in pure_mat[0]])] for _ in range(margin)
            ]
        )
        + pure_mat
        + marg
    )
    tatuagem = ""
    for text_list in pure_mat:
        out = "".join(text_list)
        if pattern:
            for i, c in enumerate(out):
                tatuagem += pattern[i % len(pattern)] if c == backsplash else c
        else:
            for i, c in enumerate(out):
                tatuagem += c
        tatuagem += "\n"
    return tatuagem


def expose(mat, pattern=None, backsplash=None, margin=None):
    # prints a `matrix`
    tatu = tatuar(mat, pattern=pattern, backsplash=backsplash, margin=margin)
    print(tatu)


def concat(cmat, amat, sep: str = ""):
    # concatenates character matrices
    if not len(cmat) == len(amat):
        raise ValueError("equal len required")

    x = [[] for _ in range(len(cmat))]
    for ix, ab in enumerate(zip(cmat, amat)):
        a, b = ab
        x[ix] = a + ([sep] if a and b else []) + b
    return x


def get_tattoo_string(frase: str, space_count: int = SPACE_MARGIN, **kwargs):
    # space_count, number of backsplash chars defining a 'space'
    j = []
    oxo = [[] for _ in range(TEMPLATE_SIZE)]
    for x in frase:
        cmat = yield_char_matrix(x, **kwargs)
        if not j:
            j = concat(oxo, cmat)
        else:
            j = concat(j, cmat, sep=(kwargs["backsplash"]) * space_count)
    return tatuar(
        j,
        pattern=kwargs["pattern"],
        backsplash=kwargs["backsplash"],
        margin=kwargs["margin"],
    )


def tatuagem(frase: str, space_count: int = SPACE_MARGIN, **kwargs):
    tatu = get_tattoo_string(frase, space_count, **kwargs)
    print(tatu)


def main():
    # Create the parser
    parser = argparse.ArgumentParser(description="Tatuagem")
    # text is the char for the printout
    parser.add_argument("--text", default=DEFAULT_TEXT_CHAR, help="Set the text")  # fmt: skip
    parser.add_argument("--backsplash", default=DEFAULT_BACKSPLASH_CHAR, help="Choose backsplash")  # fmt: skip
    parser.add_argument("--font", default=FONT_DEFAULT, metavar="FONT", help="Set the font")  # fmt: skip
    parser.add_argument("--pattern", default=None, metavar="PATTERN", help="Set the pattern for backsplash")  # fmt: skip
    parser.add_argument(
        "--margin", default=MARGIN, help="Margin top and bottom for text"
    )
    parser.add_argument("--recurse-path", help="Path to recurse and apply tattoo")
    parser.add_argument("--file", "-f", help="Read text from file")
    parser.add_argument(
        "--overwrite", action="store_true", help="Overwrite existing tattoos in files"
    )

    args, positional_args = parser.parse_known_args()
    if not os.path.exists(z := os.path.join(BASE_DIR, "fonts", args.font)):
        # Ensure fonts directory exists
        os.makedirs(os.path.join(BASE_DIR, "fonts"), exist_ok=True)
        init_and_create_templates(args.font)
    print(f"text: {args.text}")
    print(f"backsplash: {args.backsplash}")
    print(f"font: {args.font}")
    print(f"pattern: {args.pattern}")
    print(f"margin: {args.margin}")

    if args.file:
        with open(args.file, "r") as f:
            arg0_frase = f.read()
    elif positional_args:
        arg0_frase = positional_args[0]
    else:
        print("Error: No text provided. Use positional argument or --file.")
        exit(1)

    if args.recurse_path:
        from .recurse import apply_tattoo_to_directory

        if not args.file:
            tattoo = get_tattoo_string(
                arg0_frase, **{a: getattr(args, a) for a in KWARGS_LIST}
            )
        else:
            tattoo = arg0_frase
        apply_tattoo_to_directory(args.recurse_path, tattoo, overwrite=args.overwrite)
    else:
        # prints to screen
        tatuagem(arg0_frase, **{a: getattr(args, a) for a in KWARGS_LIST})


if __name__ == "__main__":
    main()
