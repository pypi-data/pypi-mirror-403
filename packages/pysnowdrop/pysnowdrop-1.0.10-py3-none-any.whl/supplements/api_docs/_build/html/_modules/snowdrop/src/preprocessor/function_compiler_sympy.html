<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>snowdrop.src.preprocessor.function_compiler_sympy &#8212; Python Platform 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css?v=12dfc556" />
    <script src="../../../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for snowdrop.src.preprocessor.function_compiler_sympy</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
    
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">symengine</span> <span class="k">as</span> <span class="nn">sy</span>
    <span class="kn">from</span> <span class="nn">symengine</span> <span class="kn">import</span> <span class="n">Abs</span>
    <span class="n">SYMENGINE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sympy</span> <span class="k">as</span> <span class="nn">sy</span>  
    <span class="kn">from</span> <span class="nn">sympy.functions.elementary.complexes</span> <span class="kn">import</span> <span class="n">Abs</span>
    <span class="n">SYMENGINE</span> <span class="o">=</span> <span class="kc">False</span>
    
<span class="kn">import</span> <span class="nn">ast</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1">#from scipy.special import lambertw as LambertW</span>
<span class="c1">#from snowdrop.src.utils.equations import check_presence</span>
<span class="kn">from</span> <span class="nn">snowdrop.src.misc.termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>

<span class="kn">from</span> <span class="nn">snowdrop.src.preprocessor.util</span> <span class="kn">import</span> <span class="n">IfThen</span><span class="p">,</span> <span class="n">IfThenElse</span><span class="p">,</span> <span class="n">Positive</span><span class="p">,</span> <span class="n">Negative</span><span class="p">,</span> <span class="n">myzif</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span>  <span class="n">Min</span><span class="p">,</span> <span class="n">Max</span><span class="p">,</span> <span class="n">LambertW</span>

<span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Add symbols that are not functions to local name space</span>
<span class="n">not_to_be_treated_as_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span><span class="s1">&#39;zeta&#39;</span><span class="p">,</span><span class="s1">&#39;Chi&#39;</span><span class="p">,</span><span class="s1">&#39;div&#39;</span><span class="p">]</span>
<span class="n">ns</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">sy</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">not_to_be_treated_as_functions</span><span class="p">}</span>

<span class="c1"># Add user defined functions to local name space</span>
<span class="n">ns</span><span class="p">[</span><span class="s2">&quot;IfThen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IfThen</span>
<span class="n">ns</span><span class="p">[</span><span class="s2">&quot;IfThenElse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IfThenElse</span>
<span class="n">ns</span><span class="p">[</span><span class="s2">&quot;Positive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Positive</span>
<span class="n">ns</span><span class="p">[</span><span class="s2">&quot;Negative&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Negative</span>
<span class="n">ns</span><span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Abs</span>
<span class="n">ns</span><span class="p">[</span><span class="s2">&quot;myzif&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">myzif</span>
<span class="n">ns</span><span class="p">[</span><span class="s2">&quot;LambertW&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LambertW</span>
<span class="n">ns</span><span class="p">[</span><span class="s2">&quot;Min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Min</span>
<span class="n">ns</span><span class="p">[</span><span class="s2">&quot;Max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Max</span>


<div class="viewcode-block" id="ast_to_sympy">
<a class="viewcode-back" href="../../../../source/snowdrop.src.preprocessor.html#snowdrop.src.preprocessor.function_compiler_sympy.ast_to_sympy">[docs]</a>
<span class="k">def</span> <span class="nf">ast_to_sympy</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an AST to a sympy expression.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param expr: AST expression.</span>
<span class="sd">        :type expr: ast.</span>
<span class="sd">        :returns:  Sympy expression.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.preprocessor.codegen</span> <span class="kn">import</span> <span class="n">to_source</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">to_source</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Cannot convert AST expression to string: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">SYMENGINE</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">sy</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">sy</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="nb">locals</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Cannot convert string to SymPy expression: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="k">raise</span></div>

        

<span class="c1">#from functools import lru_cache</span>
<span class="c1">#@lru_cache(maxsize=2048)</span>
<div class="viewcode-block" id="non_decreasing_series">
<a class="viewcode-back" href="../../../../source/snowdrop.src.preprocessor.html#snowdrop.src.preprocessor.function_compiler_sympy.non_decreasing_series">[docs]</a>
<span class="k">def</span> <span class="nf">non_decreasing_series</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all combinations of 0,...,n-1 in increasing order.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param n: Defines maximum number of integers in all combinations.</span>
<span class="sd">        :type n: int.</span>
<span class="sd">        :param size: Size of all combinations.</span>
<span class="sd">        :type size: int.</span>
<span class="sd">        :returns:  List of combination of 0,...,n-1 of size *size*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="n">non_decreasing_series</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lc</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ll</span></div>



<div class="viewcode-block" id="higher_order_diff">
<a class="viewcode-back" href="../../../../source/snowdrop.src.preprocessor.html#snowdrop.src.preprocessor.function_compiler_sympy.higher_order_diff">[docs]</a>
<span class="k">def</span> <span class="nf">higher_order_diff</span><span class="p">(</span><span class="n">eqs</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">eq_vars</span><span class="o">=</span><span class="p">[],</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take higher order derivatives of a list of equations w.r.t a list of symbols.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param eqs: List of equations.</span>
<span class="sd">        :type eqs: list.</span>
<span class="sd">        :param symbols: List of symbols.</span>
<span class="sd">        :type symbols: list.</span>
<span class="sd">        :param eq_vars: List of variables in each equation.</span>
<span class="sd">        :type eq_vars: list.</span>
<span class="sd">        :param order: Order of partial derivatives of Jacobian.</span>
<span class="sd">        :type order: int.</span>
<span class="sd">        :returns:  Matrix of partial derivatives.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#    for e in equations:</span>
<span class="c1">#        print(e)</span>
<span class="c1">#        eq = sy.sympify(e,locals=ns)</span>
<span class="c1">#        print(eq)</span>
<span class="c1">#        print(&#39;-&#39;)</span>

    <span class="c1"># Convert equations and symbols to SumPy types that can be used in Sumpy differentiation of mathematical expression with variables method.</span>
    <span class="c1"># if SYMENGINE:</span>
    <span class="c1">#     eqs = list([sy.sympify(eq) for eq in eqs]) </span>
    <span class="c1"># else:</span>
    <span class="c1">#     eqs = list([sy.sympify(eq,locals=ns) for eq in eqs])</span>
    <span class="n">syms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">sy</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">])</span>

    <span class="n">neq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eqs</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syms</span><span class="p">)</span>

    <span class="n">B</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">neq</span><span class="p">)]</span>
    <span class="n">D</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eqs</span><span class="p">)]</span>
    
    <span class="n">eq_nmbrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">skip</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">eq_vars</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">neq</span><span class="p">):</span>
            <span class="n">eq_n</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">var_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symbols</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">eq_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">eq_n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">eq_nmbrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eq_n</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">par</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">neq</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">eqs_numbers</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mat_numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">neq</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">nds</span> <span class="o">=</span> <span class="n">non_decreasing_series</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">nds</span><span class="p">:</span>

            <span class="n">ind_parent</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">syms</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">var_name</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">neq</span><span class="p">):</span>
                
                <span class="n">ii</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">line</span><span class="p">]</span> <span class="o">+</span> <span class="n">ind</span><span class="p">)</span>
                <span class="n">iid</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">line</span><span class="p">]</span> <span class="o">+</span> <span class="n">ind_parent</span><span class="p">)</span>
                <span class="n">eeq</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span>
                <span class="n">eq_number</span> <span class="o">=</span> <span class="n">eqs_numbers</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span>
                <span class="n">mat_numbers</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">eq_number</span>
                <span class="c1">#mat[ii] = eeq.diff(var)</span>
                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">eq_vars</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span> 
<span class="c1">#                    if not str(mat[ii]) == &quot;0&quot; and not str(var) in eq_vars[eq_number]:</span>
<span class="c1">#                        print(line,iid,eq_number,var)</span>
<span class="c1">#                        print(eeq)   </span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">eq_nmbrs</span><span class="p">[</span><span class="n">eq_number</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eeq</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
                            <span class="n">mat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">eeq</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">eeq</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="n">D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
        <span class="n">B</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat_numbers</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">D</span></div>

       
               
<div class="viewcode-block" id="compile_higher_order_function">
<a class="viewcode-back" href="../../../../source/snowdrop.src.preprocessor.html#snowdrop.src.preprocessor.function_compiler_sympy.compile_higher_order_function">[docs]</a>
<span class="k">def</span> <span class="nf">compile_higher_order_function</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span><span class="n">syms</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">syms_exog</span><span class="o">=</span><span class="p">[],</span><span class="n">eq_vars</span><span class="o">=</span><span class="p">[],</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">function_name</span><span class="o">=</span><span class="s1">&#39;anonymous&#39;</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="s1">&#39;f_dynamic&#39;</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bSparse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">log_variables</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From a list of equations and variables, define a multivariate functions with higher order derivatives.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param equations: List of equations.</span>
<span class="sd">        :type equations: list.</span>
<span class="sd">        :param syms: Symbols.</span>
<span class="sd">        :type syms: list.</span>
<span class="sd">        :param params: Parameters.</span>
<span class="sd">        :type params: list.</span>
<span class="sd">        :param syms_exog: Exogenous variables symbols.</span>
<span class="sd">        :type syms_exog: list</span>
<span class="sd">        :param eq_vars: List of variables in each equation.</span>
<span class="sd">        :type eq_vars: list.</span>
<span class="sd">        :param order: Order of partial derivatives of Jacobian.</span>
<span class="sd">        :type order: int.</span>
<span class="sd">        :param function_name: Function name.</span>
<span class="sd">        :type function_name: str.</span>
<span class="sd">        :param out: Name of file that contains this function source code.</span>
<span class="sd">        :type out: str.</span>
<span class="sd">        :param b: If True use cupy package, otherwise - numpy.</span>
<span class="sd">        :type b: bool.</span>
<span class="sd">        :param bSparse: True if sparse algebra is used.</span>
<span class="sd">        :type bSparse: bool.</span>
<span class="sd">        :param model_name: Model name.</span>
<span class="sd">        :type model_name; str.</span>
<span class="sd">        :returns:  Function and matrices of partial derivatives.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.preprocessor.symbolic</span> <span class="kn">import</span> <span class="n">stringify</span>
<span class="c1">#    from snowdrop.src.utils.equations import fixEquation</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">syms</span><span class="p">]</span>
    <span class="n">exogenous</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">syms_exog</span><span class="p">]</span>
<span class="c1">#    # TEMP: compatibility fix when eqs is an Odict:</span>
<span class="c1">#    eqs = [eq for eq in equations]</span>
<span class="c1">#</span>
<span class="c1">#    if isinstance(eqs[0], str):</span>
<span class="c1">#    # elif not isinstance(eqs[0], sy.Basic):</span>
<span class="c1">#    # assume we have ASTs</span>
    
<span class="c1">#       from snowdrop.src.preprocessor.symbolic import normalize</span>
<span class="c1">#        count = 0</span>
<span class="c1">#        new_eqs = []</span>
<span class="c1">#        for eq in eqs:</span>
<span class="c1">#            count += 1</span>
<span class="c1">#            try:</span>
<span class="c1">#                new_eqs.append(ast.parse(eq).body[0])</span>
<span class="c1">#            except:</span>
<span class="c1">#                print()</span>
<span class="c1">#                print(f&quot;Error parsing equation #{count}: {eq}&quot;)</span>
<span class="c1">#        #new_eqs = list([ast.parse(eq).body[0] for eq in eqs])</span>
<span class="c1">#        eqs_std = list( [normalize(eq, variables=variables) for eq in new_eqs] )</span>
<span class="c1">#        eqs_sym = list( [ast_to_sympy(eq) for eq in eqs_std] )</span>
<span class="c1">#    else:</span>
<span class="c1">#        eqs_sym = eqs</span>
        
    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">log_variables</span><span class="p">):</span>  
        <span class="n">eqs_sym</span> <span class="o">=</span> <span class="n">log_normalize_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span><span class="n">variables</span><span class="o">+</span><span class="n">exogenous</span><span class="p">,</span><span class="n">log_variables</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eqs_sym</span> <span class="o">=</span> <span class="n">normalize_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span><span class="n">variables</span><span class="o">+</span><span class="n">exogenous</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">symsd</span> <span class="o">=</span> <span class="p">[</span><span class="n">stringify</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">syms</span><span class="p">]</span>
    <span class="n">exogd</span> <span class="o">=</span> <span class="p">[</span><span class="n">stringify</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">syms_exog</span><span class="p">]</span>
    <span class="n">paramsd</span> <span class="o">=</span> <span class="p">[</span><span class="n">stringify</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">higher_order_diff</span><span class="p">(</span><span class="n">eqs_sym</span><span class="p">,</span> <span class="n">symsd</span><span class="p">,</span> <span class="n">eq_vars</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">order</span><span class="p">)</span>
    <span class="n">eqs</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

    <span class="n">txt_eq</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="n">txt_der</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="n">txt_der2</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="n">txt_der3</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    
    <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;from numba import njit</span>
<span class="s2">    </span>
<span class="s2">@njit</span>
<span class="s2">&quot;&quot;&quot;</span>    

    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;def </span><span class="si">{function_name}</span><span class="s2">(x, p, exog=[0], order=</span><span class="si">{order}</span><span class="s2">, ind=None):&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        </span>
<span class="s2">    ### This code was generated by Python.</span>
<span class="s2">    ### </span><span class="si">{model_name}</span>
<span class="s2">    </span>
<span class="s2">    # First order derivatives are employed in most of the models to compute Jacobian.</span>
<span class="s2">    # Higher order derivatives are used in nonlinear rational expectations models.</span>
<span class="s2">    </span>
<span class="s2">    from scipy.special import lambertw as LambertW</span>
<span class="s2">    from snowdrop.src.preprocessor.functions import Heaviside,Max,Min,Abs,DiracDelta</span>
<span class="s2">    from snowdrop.src.preprocessor.condition import IfThenElse,IfThen,Derivative,Subs,Positive,Negative,myzif</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    import cupy as np</span>
<span class="s2">    from cupy import exp, sin, cos, tan, sqrt, sign, log</span>
<span class="s2">    </span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    import numpy as np</span>
<span class="s2">    from numpy import exp, sin, cos, tan, sqrt, sign, log</span>
<span class="s2">        </span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">n_syms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syms</span><span class="p">)</span>
    <span class="n">n_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">n_syms_exog</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syms_exog</span><span class="p">)</span>
    <span class="n">n_equations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>
    
    <span class="n">delimiters</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span><span class="s2">&quot;[&quot;</span><span class="p">,</span><span class="s2">&quot;]&quot;</span>
    <span class="n">regexPattern</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">))</span>
    <span class="n">arr_eqs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">regexPattern</span><span class="p">,</span><span class="n">eqs</span><span class="p">)</span>
    <span class="n">arr_eqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">arr_eqs</span><span class="p">))</span>
    
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;    # Initialize variables</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;    _xi_1 = 0 </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;    _xi_2 = 0 </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;    _xi_3 = 0 </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symsd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">arr_eqs</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">symsd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> = x[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    # Set parameters</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_params</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">paramsd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> = p[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">n_syms_exog</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    # Set exogenous variables</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms_exog</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">exogd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">arr_eqs</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">exogd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> = exog[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    # Function:&quot;</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    function = np.zeros(</span><span class="si">{</span><span class="n">n_equations</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_equations</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">txt_eq</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    function[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">txt</span> <span class="o">+=</span> <span class="n">txt_eq</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    if order == 0:</span>
<span class="s2">        return function</span>
<span class="s2">    &quot;&quot;&quot;</span> 
    
    <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Jacobian</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    # Jacobian: </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">bSparse</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;    row_ind = []; col_ind = []; jacobian = []</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    jacobian = np.zeros((</span><span class="si">{</span><span class="n">n_equations</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">n_syms</span><span class="si">}</span><span class="s2">))</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_equations</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">bSparse</span><span class="p">:</span>
                        <span class="n">txt_der</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    row_ind.append(</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">); col_ind.append(</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">); jacobian.append(</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">txt_der</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    jacobian[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">] = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">txt</span> <span class="o">+=</span> <span class="n">txt_der</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    if order == 1:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">bSparse</span><span class="p">:</span>        
            <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;        return [function, jacobian, row_ind, col_ind]</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;        return [function, jacobian]</span><span class="se">\n</span><span class="s2">&quot;</span>


    <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Hessian</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    # Hessian: </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">bSparse</span><span class="p">:</span> 
            <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;    row_ind = []; col_ind = []; mat_ind = []; hessian = []</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>                
            <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    hessian = np.zeros((</span><span class="si">{</span><span class="n">n_equations</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">n_syms</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">n_syms</span><span class="si">}</span><span class="s2">))</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_equations</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">n</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">bSparse</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">txt_der2</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    row_ind.append(</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">); col_ind.append(</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">); mat_ind.append(</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">); hessian.append(</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="p">)</span>
                            <span class="k">if</span> <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">n</span><span class="p">,</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">txt_der2</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    row_ind.append(</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s2">); col_ind.append(</span><span class="si">{</span><span class="n">j1</span><span class="si">}</span><span class="s2">); mat_ind.append(</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">); hessian.append(</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">txt_der2</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    hessian[</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">] = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="p">)</span>
                            <span class="k">if</span> <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">n</span><span class="p">,</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">txt_der2</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    hessian[</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">] = hessian[</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">j1</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">txt</span> <span class="o">+=</span> <span class="n">txt_der2</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    if order == 2:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">bSparse</span><span class="p">:</span>        
            <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;        return [function, jacobian, hessian, mat_ind, row_ind, col_ind]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;        return [function, jacobian, hessian]&quot;</span>


    <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># Hessian</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">    # Third order partial derivatives: </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">bSparse</span><span class="p">:</span> 
            <span class="n">txt</span> <span class="o">+=</span>  <span class="s2">&quot;    row_ind = []; col_ind = []; sym_ind = []; mat_ind = []; derivative_of_hessian = []</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>                
            <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    derivative_of_hessian = np.zeros((</span><span class="si">{</span><span class="n">n_equations</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">n_syms</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">n_syms</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">n_syms</span><span class="si">}</span><span class="s2">))</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_equations</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms</span><span class="p">):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">n</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">bSparse</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">txt_der3</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    row_ind.append(</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">); col_ind.append(</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">); sym_ind.append(</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">); mat_ind.append(</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">); derivative_of_hessian.append(</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> 
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span>
                                <span class="k">if</span> <span class="n">D</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">n</span><span class="p">,</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="n">k1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>                                       
                                    <span class="n">txt_der3</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    row_ind.append(</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s2">); col_ind.append(</span><span class="si">{</span><span class="n">j1</span><span class="si">}</span><span class="s2">); sym_ind.append(</span><span class="si">{</span><span class="n">k1</span><span class="si">}</span><span class="s2">); mat_ind.append(</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">); derivative_of_hessian.append(</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> 
  
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">txt_der3</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    derivative_of_hessian[</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">] = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span>
                                <span class="k">if</span> <span class="n">D</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">n</span><span class="p">,</span><span class="n">i1</span><span class="p">,</span><span class="n">j1</span><span class="p">,</span><span class="n">k1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">txt_der3</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    derivative_of_hessian[</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">] = derivative_of_hessian[</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">i1</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">j1</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">k1</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">txt</span> <span class="o">+=</span> <span class="n">txt_der3</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    if order == 3:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">bSparse</span><span class="p">:</span>        
            <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;        return [function, jacobian, hessian, derivative_of_hessian, mat_ind, row_ind, col_ind, sym_ind]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;        return [function, jacobian, hessian, derivative_of_hessian]&quot;</span>

    <span class="c1">#print(&#39;Function:&#39;)</span>
    <span class="c1">#print(txt)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">out</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>


    <span class="n">m</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;division&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">division</span>

    <span class="n">exec</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">txt_eq</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>   <span class="n">txt_eq</span>   <span class="o">=</span> <span class="n">txt_eq</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">txt_der</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>  <span class="n">txt_der</span>  <span class="o">=</span> <span class="n">txt_der</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">txt_der2</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span> <span class="n">txt_der2</span> <span class="o">=</span> <span class="n">txt_der2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">txt_der3</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span> <span class="n">txt_der3</span> <span class="o">=</span> <span class="n">txt_der3</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">txt</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>      <span class="n">txt</span>      <span class="o">=</span> <span class="n">txt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">fun</span><span class="p">,</span><span class="n">txt_eq</span><span class="p">,</span><span class="n">txt_der</span><span class="p">,</span><span class="n">txt_der2</span><span class="p">,</span><span class="n">txt_der3</span><span class="p">,</span><span class="n">txt</span></div>



<div class="viewcode-block" id="compile_function">
<a class="viewcode-back" href="../../../../source/snowdrop.src.preprocessor.html#snowdrop.src.preprocessor.function_compiler_sympy.compile_function">[docs]</a>
<span class="k">def</span> <span class="nf">compile_function</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span><span class="n">syms</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">syms_exog</span><span class="o">=</span><span class="p">[],</span><span class="n">eq_vars</span><span class="o">=</span><span class="p">[],</span><span class="n">function_name</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="s1">&#39;f_func&#39;</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">log_variables</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From a list of equations and variables, define a multivariate functions with higher order derivatives.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param equations: List of equations.</span>
<span class="sd">        :type equations: list.</span>
<span class="sd">        :param syms: Symbols.</span>
<span class="sd">        :type syms: list.</span>
<span class="sd">        :param params: Parameters.</span>
<span class="sd">        :type params: list.</span>
<span class="sd">        :param syms_exog: Exogenous variables symbols.</span>
<span class="sd">        :type syms_exog: list</span>
<span class="sd">        :param eq_vars: List of variables in each equation.</span>
<span class="sd">        :type eq_vars: list.</span>
<span class="sd">        :param function_name: Function name.</span>
<span class="sd">        :type function_name: str.</span>
<span class="sd">        :param out: Name of file that contains this function source code.</span>
<span class="sd">        :type out: str.</span>
<span class="sd">        :param b: If True use JAX package, otherwise - numpy.</span>
<span class="sd">        :type b: bool.</span>
<span class="sd">        :param model_name: Model name.</span>
<span class="sd">        :type model_name: str.</span>
<span class="sd">        :returns:  Compiled function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.preprocessor.symbolic</span> <span class="kn">import</span> <span class="n">stringify</span>
    
    <span class="n">n_equations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>
    <span class="n">n_syms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syms</span><span class="p">)</span>
    <span class="n">n_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">n_syms_exog</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syms_exog</span><span class="p">)</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">syms</span><span class="p">]</span>
    <span class="n">exogenous</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">syms_exog</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">log_variables</span><span class="p">):</span>  
        <span class="n">eqs_sym</span> <span class="o">=</span> <span class="n">log_normalize_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span><span class="n">variables</span><span class="o">+</span><span class="n">exogenous</span><span class="p">,</span><span class="n">log_variables</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eqs_sym</span> <span class="o">=</span> <span class="n">normalize_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span><span class="n">variables</span><span class="o">+</span><span class="n">exogenous</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">symsd</span> <span class="o">=</span> <span class="p">[</span><span class="n">stringify</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">syms</span><span class="p">]</span>
    <span class="n">exogd</span> <span class="o">=</span> <span class="p">[</span><span class="n">stringify</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">syms_exog</span><span class="p">]</span>
    <span class="n">paramsd</span> <span class="o">=</span> <span class="p">[</span><span class="n">stringify</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">higher_order_diff</span><span class="p">(</span><span class="n">eqs_sym</span><span class="p">,</span> <span class="n">symsd</span><span class="p">,</span> <span class="n">eq_vars</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    
    <span class="n">eqs</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

    <span class="n">delimiters</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span><span class="s2">&quot;[&quot;</span><span class="p">,</span><span class="s2">&quot;]&quot;</span>
    <span class="n">regexPattern</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">))</span>
    <span class="n">arr_eqs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">regexPattern</span><span class="p">,</span><span class="n">eqs</span><span class="p">)</span>
    <span class="n">arr_eqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">arr_eqs</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;from jax import jit</span>
<span class="s2">    </span>
<span class="s2">@jit</span>
<span class="s2">&quot;&quot;&quot;</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;from numba import njit</span>
<span class="s2">    </span>
<span class="s2">@njit</span>
<span class="s2">&quot;&quot;&quot;</span>  
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;def </span><span class="si">{function_name}</span><span class="s2">(x,p,exog=[0]):&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">)</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    </span>
<span class="s2">    ### This code was generated by Python.</span>
<span class="s2">    ### </span><span class="si">{model_name}</span>
<span class="s2">    </span>
<span class="s2">    from sympy import DiracDelta</span>
<span class="s2">    from snowdrop.src.preprocessor.condition import IfThenElse,IfThen,Derivative,Subs,Positive,Negative,myzif</span>
<span class="s2">    from snowdrop.src.preprocessor.functions import Heaviside</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    import jax.numpy as np</span>
<span class="s2">    from jax.numpy import log,exp,sin,cos,tan,sqrt,sign</span>
<span class="s2">    from jax.numpy import maximum as Max, minimum as Min, abs as Abs</span>
<span class="s2">    </span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    import numpy as np</span>
<span class="s2">    from numpy import log,exp,sin,cos,tan,sqrt,sign</span>
<span class="s2">    from numpy import maximum as Max, minimum as Min, abs as Abs</span>
<span class="s2">    </span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;    # Initialize variables</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symsd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">arr_eqs</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">symsd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> = x[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    # Set parameters</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_params</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">paramsd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> = p[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
        
    <span class="k">if</span> <span class="n">n_syms_exog</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    # Set exogenous variables</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms_exog</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">exogd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">arr_eqs</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">exogd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> = exog[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    # Function:</span><span class="se">\n</span><span class="s2">&quot;</span>
    
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    function = list()</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_equations</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    function.append(</span><span class="si">{</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    return np.array(function)</span>
<span class="s2">&quot;&quot;&quot;</span> 
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">out</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
            
    <span class="n">m</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;division&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">division</span>

    <span class="n">exec</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">fun</span><span class="p">,</span><span class="n">txt</span></div>



<div class="viewcode-block" id="compile_jacobian">
<a class="viewcode-back" href="../../../../source/snowdrop.src.preprocessor.html#snowdrop.src.preprocessor.function_compiler_sympy.compile_jacobian">[docs]</a>
<span class="k">def</span> <span class="nf">compile_jacobian</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span><span class="n">syms</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">syms_exog</span><span class="o">=</span><span class="p">[],</span><span class="n">eq_vars</span><span class="o">=</span><span class="p">[],</span><span class="n">function_name</span><span class="o">=</span><span class="s1">&#39;jacob&#39;</span><span class="p">,</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;f_jacob&#39;</span><span class="p">,</span><span class="n">bSparse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">log_variables</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From a list of equations and variables, define a multivariate functions with higher order derivatives.</span>
<span class="sd">    </span>
<span class="sd">Parameters:</span>
<span class="sd">    :param equations: List of equations.</span>
<span class="sd">    :type equations: list.</span>
<span class="sd">    :param syms: Symbols.</span>
<span class="sd">    :type syms: list.</span>
<span class="sd">    :param params: Parameters.</span>
<span class="sd">    :type params: list.</span>
<span class="sd">    :param syms_exog: Exogenous variables symbols.</span>
<span class="sd">    :type syms_exog: list</span>
<span class="sd">    :param eq_vars: List of variables in each equation.</span>
<span class="sd">    :type eq_vars: list.</span>
<span class="sd">    :param order: Order of partial derivatives of Jacobian.</span>
<span class="sd">    :type order: int.</span>
<span class="sd">    :param function_name: Function name.</span>
<span class="sd">    :type function_name: str.</span>
<span class="sd">    :param out: Name of file that contains this function source code.</span>
<span class="sd">    :type out: str.</span>
<span class="sd">    :param b: If True use cupy package, otherwise - numpy.</span>
<span class="sd">    :type b: bool.</span>
<span class="sd">    :param bSparse: True if sparse algebra is used.</span>
<span class="sd">    :type bSparse: bool.</span>
<span class="sd">    :param model_name: Model name.</span>
<span class="sd">    :type model_name; str.</span>
<span class="sd">    :returns:  Compiled jacobian.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.preprocessor.symbolic</span> <span class="kn">import</span> <span class="n">stringify</span>
    
    <span class="n">n_equations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>
    <span class="n">n_syms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syms</span><span class="p">)</span>
    <span class="n">n_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">n_syms_exog</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syms_exog</span><span class="p">)</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">syms</span><span class="p">]</span>
    <span class="n">exogenous</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">syms_exog</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">log_variables</span><span class="p">):</span>  
        <span class="n">eqs_sym</span> <span class="o">=</span> <span class="n">log_normalize_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span><span class="n">variables</span><span class="o">+</span><span class="n">exogenous</span><span class="p">,</span><span class="n">log_variables</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eqs_sym</span> <span class="o">=</span> <span class="n">normalize_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span><span class="n">variables</span><span class="o">+</span><span class="n">exogenous</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">symsd</span> <span class="o">=</span> <span class="p">[</span><span class="n">stringify</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">syms</span><span class="p">]</span>
    <span class="n">exogd</span> <span class="o">=</span> <span class="p">[</span><span class="n">stringify</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">syms_exog</span><span class="p">]</span>
    <span class="n">paramsd</span> <span class="o">=</span> <span class="p">[</span><span class="n">stringify</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">higher_order_diff</span><span class="p">(</span><span class="n">eqs_sym</span><span class="p">,</span> <span class="n">symsd</span><span class="p">,</span> <span class="n">eq_vars</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    
    <span class="n">eqs</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

    <span class="n">delimiters</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span><span class="s2">&quot;[&quot;</span><span class="p">,</span><span class="s2">&quot;]&quot;</span>
    <span class="n">regexPattern</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">))</span>
    <span class="n">arr_eqs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">regexPattern</span><span class="p">,</span><span class="n">eqs</span><span class="p">)</span>
    <span class="n">arr_eqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">arr_eqs</span><span class="p">))</span>
    
    <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;from numba import njit</span>
<span class="s2">    </span>
<span class="s2">@njit</span>
<span class="s2">&quot;&quot;&quot;</span> 
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;def </span><span class="si">{function_name}</span><span class="s2">(x,p,exog=[0]):&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">)</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    </span>
<span class="s2">    ### This code was generated by Python.</span>
<span class="s2">    ### </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span>
<span class="s2">    </span>
<span class="s2">    from sympy import DiracDelta</span>
<span class="s2">    from snowdrop.src.preprocessor.condition import IfThenElse,IfThen,Derivative,Subs,Positive,Negative,myzif</span>
<span class="s2">    from snowdrop.src.preprocessor.functions import Heaviside</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>
  
    <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    import jax.numpy as np</span>
<span class="s2">    from jax.numpy import log,exp,sin,cos,tan,sqrt,sign</span>
<span class="s2">    from jax.numpy import maximum as Max, minimum as Min, abs as Abs</span>
<span class="s2">    </span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    import numpy as np</span>
<span class="s2">    from numpy import log,exp,sin,cos,tan,sqrt,sign</span>
<span class="s2">    from numpy import maximum as Max, min as Min, abs as Abs</span>
<span class="s2">     </span>
<span class="s2">&quot;&quot;&quot;</span>   
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;    # Initialize variables</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;    _xi_1 = 0 </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;    _xi_2 = 0 </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;    _xi_3 = 0 </span><span class="se">\n</span><span class="s2">&quot;</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symsd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">arr_eqs</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">symsd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> = x[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    # Set parameters</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_params</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">paramsd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> = p[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
        
    <span class="k">if</span> <span class="n">n_syms_exog</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    # Set exogenous variables</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms_exog</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">exogd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">arr_eqs</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">exogd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> = exog[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
  
    <span class="c1"># Jacobian</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    # Jacobian: </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">bSparse</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;    row_ind = []; col_ind = []; function = []</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    jacobian = np.zeros((</span><span class="si">{</span><span class="n">n_equations</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">n_syms</span><span class="si">}</span><span class="s2">))</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_equations</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bSparse</span><span class="p">:</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    row_ind.append(</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">); col_ind.append(</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">); jacobian.append(</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;    jacobian[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">] = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">bSparse</span><span class="p">:</span>        
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    return jacobian,row_ind,col_ind </span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    return jacobian </span><span class="se">\n</span><span class="s2">&quot;</span>
    
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">out</span><span class="o">+</span><span class="s1">&#39;.py&#39;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
            
    <span class="n">m</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;division&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">division</span>

    <span class="n">exec</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">fun</span><span class="p">,</span><span class="n">txt</span></div>

    

<div class="viewcode-block" id="normalize_equations">
<a class="viewcode-back" href="../../../../source/snowdrop.src.preprocessor.html#snowdrop.src.preprocessor.function_compiler_sympy.normalize_equations">[docs]</a>
<span class="k">def</span> <span class="nf">normalize_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span><span class="n">variables</span><span class="p">,</span><span class="n">bAST</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify equations by replacing lead/lag variables with the dated variables.</span>
<span class="sd">    </span>
<span class="sd">    For example, replaces variable:</span>
<span class="sd">        1. var(-1) -&gt; var__m1_</span>
<span class="sd">        2. var(1) -&gt; var__p1_</span>
<span class="sd">        3. var -&gt; var__</span>
<span class="sd">        </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param equations: List of equations.</span>
<span class="sd">        :type equations: list.</span>
<span class="sd">        :param variables: List of variables in each equation.</span>
<span class="sd">        :type variables: list.</span>
<span class="sd">        :param bAST: If True use AST tree to parse equations, stringify variables and convert to sumpy expressions.</span>
<span class="sd">                     Otherwise parse equations with the aid of regular expressions of ReGex module. </span>
<span class="sd">        :type bAST: bool.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.preprocessor.symbolic</span> <span class="kn">import</span> <span class="n">stringify</span><span class="p">,</span><span class="n">normalize</span>
    
    <span class="k">if</span> <span class="n">bAST</span><span class="p">:</span>
        
        <span class="n">eqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">eq</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">equations</span><span class="p">]</span> <span class="c1"># TEMP: compatibility fix when eqs is an Odict:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">new_eqs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">eqs</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_eqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">()</span>
                        <span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing equation #</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">eq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_eqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">eqs</span><span class="p">]</span>
            <span class="n">eqs_std</span> <span class="o">=</span> <span class="p">[</span><span class="n">normalize</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">)</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">new_eqs</span><span class="p">]</span>
            <span class="n">eqs_sym</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast_to_sympy</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">eqs_std</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># assume we have ASTs</span>
            <span class="n">eqs_sym</span> <span class="o">=</span> <span class="n">eqs</span>
        
    <span class="k">else</span><span class="p">:</span>
        
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">delimiters</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span>
        <span class="n">regexPattern</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">))</span>
        <span class="n">eqs_sym</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">eqtn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">eqtn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">regexPattern</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arr</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">arr</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;eq:&#39;</span><span class="p">,</span><span class="n">eq</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;e:&#39;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                    <span class="n">eq</span> <span class="o">+=</span> <span class="n">e</span><span class="p">[:</span><span class="n">ind</span><span class="p">]</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">ind</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
                        <span class="n">ind2</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ind2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">lead_lag</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span><span class="n">ind2</span><span class="p">]</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-+]?\d+&quot;</span><span class="p">,</span><span class="n">lead_lag</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">i_lead_lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lead_lag</span><span class="p">)</span>
                                    <span class="n">eq</span> <span class="o">+=</span> <span class="n">stringify</span><span class="p">((</span><span class="n">v</span><span class="p">,</span><span class="n">i_lead_lag</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">eq</span> <span class="o">+=</span> <span class="n">stringify</span><span class="p">((</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                            <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">ind2</span><span class="p">:]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">:  Equation </span><span class="si">{1}</span><span class="s2"> - variable </span><span class="si">{2}</span><span class="s2"> doesn&#39;t have a closing parenthesis: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">eqtn</span><span class="p">,</span><span class="n">v</span><span class="p">),</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                            <span class="n">eq</span> <span class="o">+=</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;__&#39;</span>
                            <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):]</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                        <span class="n">eq</span> <span class="o">+=</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;__&#39;</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="n">ind</span><span class="p">:</span>
                        <span class="n">eq</span> <span class="o">+=</span> <span class="n">e</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="n">ind</span><span class="p">]</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="n">ind</span><span class="p">:]</span>
            <span class="n">eq</span> <span class="o">+=</span> <span class="n">e</span>
            <span class="n">eqs_sym</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span> 
            
        <span class="k">if</span> <span class="n">SYMENGINE</span><span class="p">:</span>
            <span class="n">eqs_sym</span> <span class="o">=</span> <span class="p">[</span><span class="n">sy</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">eqs_sym</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eqs_sym</span> <span class="o">=</span> <span class="p">[</span><span class="n">sy</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span><span class="nb">locals</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">eqs_sym</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">eqs_sym</span></div>



<div class="viewcode-block" id="log_normalize_equations">
<a class="viewcode-back" href="../../../../source/snowdrop.src.preprocessor.html#snowdrop.src.preprocessor.function_compiler_sympy.log_normalize_equations">[docs]</a>
<span class="k">def</span> <span class="nf">log_normalize_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span><span class="n">variables</span><span class="p">,</span><span class="n">log_variables</span><span class="o">=</span><span class="p">[],</span><span class="n">bAST</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify equations by replacing variables with their logs with time shift.</span>
<span class="sd">    </span>
<span class="sd">    For example, replaces variable:</span>
<span class="sd">        1. var(-1) -&gt; log(var__m1_)</span>
<span class="sd">        2. var(1) -&gt; log(var__p1_)</span>
<span class="sd">        3. var -&gt; log(var__)</span>
<span class="sd">        </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param equations: List of equations.</span>
<span class="sd">        :type equations: list.</span>
<span class="sd">        :param variables: List of variables in each equation.</span>
<span class="sd">        :type variables: list.</span>
<span class="sd">        :param bAST: If True use AST tree to parse equations, stringify variables and convert to sumpy expressions.</span>
<span class="sd">                     Otherwise parse equations with the aid of regular expressions of ReGex module. </span>
<span class="sd">        :type bAST: bool.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.preprocessor.symbolic</span> <span class="kn">import</span> <span class="n">stringify_variable</span> 
    <span class="kn">from</span> <span class="nn">snowdrop.src.preprocessor.symbolic</span> <span class="kn">import</span> <span class="n">log_stringify_variable</span> 
    <span class="kn">from</span> <span class="nn">snowdrop.src.preprocessor.symbolic</span> <span class="kn">import</span> <span class="n">log_normalize</span>
    
    <span class="k">if</span> <span class="n">bAST</span><span class="p">:</span>
        
        <span class="n">eqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">eq</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">equations</span><span class="p">]</span> <span class="c1"># TEMP: compatibility fix when eqs is an Odict:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">new_eqs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">eqs</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_eqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">()</span>
                        <span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing equation #</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">eq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_eqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">eqs</span><span class="p">])</span>
            <span class="n">eqs_std</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">log_normalize</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">log_variables</span><span class="o">=</span><span class="n">log_variables</span><span class="p">)</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">new_eqs</span><span class="p">])</span>
            <span class="n">eqs_sym</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">ast_to_sympy</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">eqs_std</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># assume we have ASTs</span>
            <span class="n">eqs_sym</span> <span class="o">=</span> <span class="n">eqs</span>
        
    <span class="k">else</span><span class="p">:</span>
        
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">delimiters</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span>
        <span class="n">regexPattern</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">))</span>
        <span class="n">eqs_sym</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">eqtn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">eqtn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">regexPattern</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arr</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">arr</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;eq:&#39;</span><span class="p">,</span><span class="n">eq</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;e:&#39;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                    <span class="n">eq</span> <span class="o">+=</span> <span class="n">e</span><span class="p">[:</span><span class="n">ind</span><span class="p">]</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">ind</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
                        <span class="n">ind2</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ind2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">lead_lag</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span><span class="n">ind2</span><span class="p">]</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-+]?\d+&quot;</span><span class="p">,</span><span class="n">lead_lag</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">log_variables</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">i_lead_lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lead_lag</span><span class="p">)</span>
                                        <span class="n">eq</span> <span class="o">+=</span> <span class="n">log_stringify_variable</span><span class="p">((</span><span class="n">v</span><span class="p">,</span><span class="n">i_lead_lag</span><span class="p">))</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">eq</span> <span class="o">+=</span> <span class="n">log_stringify_variable</span><span class="p">((</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">i_lead_lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lead_lag</span><span class="p">)</span>
                                        <span class="n">eq</span> <span class="o">+=</span> <span class="n">stringify_variable</span><span class="p">((</span><span class="n">v</span><span class="p">,</span><span class="n">i_lead_lag</span><span class="p">))</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">eq</span> <span class="o">+=</span> <span class="n">stringify_variable</span><span class="p">((</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                                    
                            <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">ind2</span><span class="p">:]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">:  Equation </span><span class="si">{1}</span><span class="s2"> - variable </span><span class="si">{2}</span><span class="s2"> doesn&#39;t have a closing parenthesis: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">eqtn</span><span class="p">,</span><span class="n">v</span><span class="p">),</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                            <span class="n">eq</span> <span class="o">+=</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;__&#39;</span>
                            <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):]</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                        <span class="n">eq</span> <span class="o">+=</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;__&#39;</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="n">ind</span><span class="p">:</span>
                        <span class="n">eq</span> <span class="o">+=</span> <span class="n">e</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="n">ind</span><span class="p">]</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="n">ind</span><span class="p">:]</span>
            <span class="n">eq</span> <span class="o">+=</span> <span class="n">e</span>
            <span class="n">eqs_sym</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span> 
        
        <span class="k">if</span> <span class="n">SYMENGINE</span><span class="p">:</span>
            <span class="n">eqs_sym</span> <span class="o">=</span> <span class="p">[</span><span class="n">sy</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">eqs_sym</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eqs_sym</span> <span class="o">=</span> <span class="p">[</span><span class="n">sy</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span><span class="nb">locals</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">eqs_sym</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">eqs_sym</span></div>


    
<div class="viewcode-block" id="get_indices">
<a class="viewcode-back" href="../../../../source/snowdrop.src.preprocessor.html#snowdrop.src.preprocessor.function_compiler_sympy.get_indices">[docs]</a>
<span class="k">def</span> <span class="nf">get_indices</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span><span class="n">syms</span><span class="p">,</span><span class="n">eq_vars</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From a list of equations and variables, define a multivariate functions with higher order derivatives.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param equations: List of equations.</span>
<span class="sd">        :type equations: list.</span>
<span class="sd">        :param syms: Symbols.</span>
<span class="sd">        :type syms: list.</span>
<span class="sd">        :returns:  row and column indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.preprocessor.symbolic</span> <span class="kn">import</span> <span class="n">stringify</span>
    
    <span class="n">n_equations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>
    <span class="n">n_syms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">syms</span><span class="p">)</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">syms</span><span class="p">]</span>
    <span class="n">eqs_sym</span> <span class="o">=</span> <span class="n">normalize_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span><span class="n">variables</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">symsd</span> <span class="o">=</span> <span class="p">[</span><span class="n">stringify</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">syms</span><span class="p">]</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">higher_order_diff</span><span class="p">(</span><span class="n">eqs_sym</span><span class="p">,</span> <span class="n">symsd</span><span class="p">,</span> <span class="n">eq_vars</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
    
    <span class="n">ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">();</span> <span class="n">row_ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">();</span> <span class="n">col_ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_equations</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_syms</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                <span class="n">row_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">col_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                
    <span class="k">return</span> <span class="n">row_ind</span><span class="p">,</span> <span class="n">col_ind</span></div>

    
    
<div class="viewcode-block" id="test_deriv">
<a class="viewcode-back" href="../../../../source/snowdrop.src.preprocessor.html#snowdrop.src.preprocessor.function_compiler_sympy.test_deriv">[docs]</a>
<span class="k">def</span> <span class="nf">test_deriv</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test derivatives of equations.&quot;&quot;&quot;</span>
    <span class="c1"># list of equations</span>
    <span class="n">eqs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;(a*x + 2*b)**2&#39;</span><span class="p">,</span> <span class="s1">&#39;y + exp(a + 2*b)*c(1)&#39;</span><span class="p">]</span>

    <span class="c1"># list of variables (time symbols)</span>
    <span class="n">syms</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">eq_vars</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;a__&#39;</span><span class="p">,</span><span class="s1">&#39;b__&#39;</span><span class="p">],[</span><span class="s1">&#39;a__&#39;</span><span class="p">,</span><span class="s1">&#39;b__&#39;</span><span class="p">,</span><span class="s1">&#39;c__p1_&#39;</span><span class="p">]]</span>

    <span class="c1"># list of parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>

    <span class="c1"># compile a function and its derivatives</span>
    <span class="n">fun</span><span class="p">,</span><span class="n">eqs</span><span class="p">,</span><span class="n">der</span><span class="p">,</span><span class="n">der2</span><span class="p">,</span><span class="n">der3</span><span class="p">,</span><span class="n">txt</span> <span class="o">=</span> <span class="n">compile_higher_order_function</span><span class="p">(</span><span class="n">equations</span><span class="o">=</span><span class="n">eqs</span><span class="p">,</span><span class="n">syms</span><span class="o">=</span><span class="n">syms</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span><span class="n">syms_exog</span><span class="o">=</span><span class="p">[],</span><span class="n">eq_vars</span><span class="o">=</span><span class="n">eq_vars</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># evaluate the function</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>

    <span class="kn">from</span> <span class="nn">f_dynamic</span> <span class="kn">import</span> <span class="n">anonymous</span> <span class="k">as</span> <span class="n">func</span>
    <span class="n">f0</span><span class="p">,</span><span class="n">f1</span><span class="p">,</span><span class="n">f2</span><span class="p">,</span><span class="n">f3</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="n">py_func</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span><span class="p">(</span><span class="n">f0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">f1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">f2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">8</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">f2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">f2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span></div>


    
<div class="viewcode-block" id="test_deriv2">
<a class="viewcode-back" href="../../../../source/snowdrop.src.preprocessor.html#snowdrop.src.preprocessor.function_compiler_sympy.test_deriv2">[docs]</a>
<span class="k">def</span> <span class="nf">test_deriv2</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test derivatives of equations.&quot;&quot;&quot;</span>
    
    <span class="n">eq</span> <span class="o">=</span> <span class="s1">&#39;(a*x + 2*b)**2 + IfThenElse(1,x,exp(a + 2*b)*y(1))&#39;</span>

    <span class="c1"># list of variables (time symbols)</span>
    <span class="n">syms</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">eq_vars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">eq_vars</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;x__&#39;</span><span class="p">,</span><span class="s1">&#39;y__&#39;</span><span class="p">,</span><span class="s1">&#39;y__1_&#39;</span><span class="p">])</span>

    <span class="c1"># list of parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>

    <span class="c1"># compile a function with its derivatives</span>
    <span class="n">fun</span><span class="p">,</span><span class="n">eqs</span><span class="p">,</span><span class="n">der</span><span class="p">,</span><span class="n">der2</span><span class="p">,</span><span class="n">der3</span><span class="p">,</span><span class="n">txt</span> <span class="o">=</span> <span class="n">compile_higher_order_function</span><span class="p">(</span><span class="n">equations</span><span class="o">=</span><span class="p">[</span><span class="n">eq</span><span class="p">],</span><span class="n">syms</span><span class="o">=</span><span class="n">syms</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span><span class="n">syms_exog</span><span class="o">=</span><span class="p">[],</span><span class="n">eq_vars</span><span class="o">=</span><span class="n">eq_vars</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

    <span class="c1">#print(&quot;Function:\n&quot;,txt)</span>
    <span class="c1">#print(&quot;Derivatives:\n&quot;,der)</span>

    
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># equations = [&#39;p_pdot1*PDOT(+1) + (1-p_pdot1)*PDOT(-1) + p_pdot2*(g**2/(g-Y) - g) + p_pdot3*(g**2/(g-Y(-1)) - g)&#39;, &#39;RS - p_pdot1*PDOT(+1) - (1-p_pdot1)*PDOT(-1)&#39;, &#39;p_rs1*PDOT + Y&#39;, &#39;p_y1*Y(-1) - p_y2*RR - p_y3*RR(-1) + e&#39;]</span>
    <span class="c1"># variables = [&#39;PDOT&#39;,&#39;RR&#39;,&#39;RS&#39;,&#39;Y&#39;]</span>
    <span class="c1"># eqs = normalize_equations(equations=equations,variables=variables,bAST=True)</span>
    <span class="c1"># print(eqs)</span>
    
    <span class="c1"># from snowdrop.src.preprocessor.symbolic import normalize</span>
    <span class="c1"># variables = [&quot;E_ISR_TAXL_RAT&quot;,&quot;E_WRL_PRODOIL_R&quot;,&quot;ISR_ACT_R&quot;,&quot;ISR_BREVAL_N&quot;,&quot;ISR_B_N&quot;,&quot;ISR_B_RAT&quot;,&quot;ISR_CFOOD_R&quot;,&quot;ISR_CNCOM_R&quot;,&quot;ISR_COIL_R&quot;,&quot;ISR_COM_FE_R&quot;,&quot;ISR_COM_RK_P&quot;,&quot;ISR_CPINCOM_P&quot;,&quot;ISR_CPIX_P&quot;,&quot;ISR_CPI_P&quot;,&quot;ISR_CURBAL_N&quot;,&quot;ISR_C_LIQ_R&quot;,&quot;ISR_C_OLG_R&quot;,&quot;ISR_C_R&quot;,&quot;ISR_C_RAT&quot;,&quot;ISR_DELTA&quot;,&quot;ISR_EPS&quot;,&quot;ISR_FACTFOOD_R&quot;,&quot;ISR_FACT_R&quot;,&quot;ISR_FXPREM&quot;,&quot;ISR_GC_N&quot;,&quot;ISR_GC_R&quot;,&quot;ISR_GC_RAT&quot;,&quot;ISR_GDEF_N&quot;,&quot;ISR_GDEF_RAT&quot;,&quot;ISR_GDEF_TAR&quot;,&quot;ISR_GDPINC_N&quot;,&quot;ISR_GDPSIZE&quot;,&quot;ISR_GDP_FE_R&quot;,&quot;ISR_GDP_N&quot;,&quot;ISR_GDP_R&quot;,&quot;ISR_GE_N&quot;,&quot;ISR_GISTOCK_R&quot;,&quot;ISR_GI_N&quot;,&quot;ISR_GI_R&quot;,&quot;ISR_GI_RAT&quot;,&quot;ISR_GNP_R&quot;,&quot;ISR_GOVCHECK&quot;,&quot;ISR_GSUB_N&quot;,&quot;ISR_GTARIFF_N&quot;,&quot;ISR_G_R&quot;,&quot;ISR_IFOODA_R&quot;,&quot;ISR_IFOOD_R&quot;,&quot;ISR_IMETALA_R&quot;,&quot;ISR_IMETAL_R&quot;,&quot;ISR_IM_R&quot;,&quot;ISR_INFCPI&quot;,&quot;ISR_INFCPIX&quot;,&quot;ISR_INFEXP&quot;,&quot;ISR_INFL&quot;,&quot;ISR_INFPIM&quot;,&quot;ISR_INFWAGE&quot;,&quot;ISR_INFWAGEEFF&quot;,&quot;ISR_INFWEXP&quot;,&quot;ISR_INT&quot;,&quot;ISR_INT10&quot;,&quot;ISR_INTC&quot;,&quot;ISR_INTCORP&quot;,&quot;ISR_INTCOST_N&quot;,&quot;ISR_INTCOST_RAT&quot;,&quot;ISR_INTGB&quot;,&quot;ISR_INTMP&quot;,&quot;ISR_INTMPU&quot;,&quot;ISR_INTNFA&quot;,&quot;ISR_INTRF&quot;,&quot;ISR_INTRF10&quot;,&quot;ISR_INTXM10&quot;,&quot;ISR_INVESTP_R&quot;,&quot;ISR_INVEST_R&quot;,&quot;ISR_INVEST_RAT&quot;,&quot;ISR_IOILA_R&quot;,&quot;ISR_IOIL_R&quot;,&quot;ISR_IT_R&quot;,&quot;ISR_IT_RAT&quot;,&quot;ISR_J&quot;,&quot;ISR_KG_R&quot;,&quot;ISR_K_R&quot;,&quot;ISR_LABH_FE_R&quot;,&quot;ISR_LABH_R&quot;,&quot;ISR_LAB_FE_R&quot;,&quot;ISR_LAB_R&quot;,&quot;ISR_LF_FE_R&quot;,&quot;ISR_LF_R&quot;,&quot;ISR_LSTAX_RAT&quot;,&quot;ISR_MET_RK_P&quot;,&quot;ISR_MKTPREM&quot;,&quot;ISR_MKTPREMSM&quot;,&quot;ISR_MPC&quot;,&quot;ISR_MPCINV&quot;,&quot;ISR_NFAREVAL_N&quot;,&quot;ISR_NFA_D&quot;,&quot;ISR_NFA_RAT&quot;,&quot;ISR_NPOPB_R&quot;,&quot;ISR_NPOPH_R&quot;,&quot;ISR_NPOP_R&quot;,&quot;ISR_NTRFPSPILL_FE_R&quot;,&quot;ISR_OILRECEIPT_N&quot;,&quot;ISR_OILSUB_N&quot;,&quot;ISR_PART&quot;,&quot;ISR_PARTH&quot;,&quot;ISR_PARTH_DES&quot;,&quot;ISR_PARTH_FE&quot;,&quot;ISR_PARTH_W&quot;,&quot;ISR_PART_DES&quot;,&quot;ISR_PART_FE&quot;,&quot;ISR_PCFOOD_P&quot;,&quot;ISR_PCOIL_P&quot;,&quot;ISR_PCW_P&quot;,&quot;ISR_PC_P&quot;,&quot;ISR_PFM_P&quot;,&quot;ISR_PFOOD_P&quot;,&quot;ISR_PGDP_P&quot;,&quot;ISR_PGDP_P_AVG&quot;,&quot;ISR_PG_P&quot;,&quot;ISR_PIMADJ_P&quot;,&quot;ISR_PIMA_P&quot;,&quot;ISR_PIM_P&quot;,&quot;ISR_PIT_P&quot;,&quot;ISR_PI_P&quot;,&quot;ISR_PMETAL_P&quot;,&quot;ISR_POIL_P&quot;,&quot;ISR_POIL_P_SUB&quot;,&quot;ISR_PRIMSUR_N&quot;,&quot;ISR_PRIMSUR_TAR&quot;,&quot;ISR_PRODFOOD_R&quot;,&quot;ISR_PSAVING_N&quot;,&quot;ISR_PXMF_P&quot;,&quot;ISR_PXMUNADJ_P&quot;,&quot;ISR_PXM_P&quot;,&quot;ISR_PXT_P&quot;,&quot;ISR_Q_P&quot;,&quot;ISR_R&quot;,&quot;ISR_R10&quot;,&quot;ISR_RC&quot;,&quot;ISR_RC0_SM&quot;,&quot;ISR_RC0_WM&quot;,&quot;ISR_RCI&quot;,&quot;ISR_RCORP&quot;,&quot;ISR_REER&quot;,&quot;ISR_RK_P&quot;,&quot;ISR_RPREM&quot;,&quot;ISR_R_NEUT&quot;,&quot;ISR_SOVPREM&quot;,&quot;ISR_SOVPREMSM&quot;,&quot;ISR_SUB_OIL&quot;,&quot;ISR_TAU_C&quot;,&quot;ISR_TAU_K&quot;,&quot;ISR_TAU_L&quot;,&quot;ISR_TAU_OIL&quot;,&quot;ISR_TAXC_N&quot;,&quot;ISR_TAXC_RAT&quot;,&quot;ISR_TAXK_N&quot;,&quot;ISR_TAXK_RAT&quot;,&quot;ISR_TAXLH_N&quot;,&quot;ISR_TAXL_N&quot;,&quot;ISR_TAXL_RAT&quot;,&quot;ISR_TAXOIL_N&quot;,&quot;ISR_TAX_N&quot;,&quot;ISR_TAX_RAT&quot;,&quot;ISR_TB_N&quot;,&quot;ISR_TFPEFFECT_R&quot;,&quot;ISR_TFPKGSPILL_FE_R&quot;,&quot;ISR_TFPSPILL_FE_R&quot;,&quot;ISR_TFP_FE_R&quot;,&quot;ISR_TFP_FE_R_AVG&quot;,&quot;ISR_TFP_R&quot;,&quot;ISR_TM&quot;,&quot;ISR_TPREM&quot;,&quot;ISR_TRANSFER_LIQ_N&quot;,&quot;ISR_TRANSFER_OLG_N&quot;,&quot;ISR_TRANSFER_RAT&quot;,&quot;ISR_TRANSFER_TARG_N&quot;,&quot;ISR_TRANSFER_TARG_RAT&quot;,&quot;ISR_TRFPSPILL_FE_R&quot;,&quot;ISR_UFOOD_R&quot;,&quot;ISR_UNR&quot;,&quot;ISR_UNRH&quot;,&quot;ISR_UNRH_FE&quot;,&quot;ISR_UNR_FE&quot;,&quot;ISR_USA_SM&quot;,&quot;ISR_USA_WM&quot;,&quot;ISR_WAGEEFF_N&quot;,&quot;ISR_WAGEH_N&quot;,&quot;ISR_WAGE_N&quot;,&quot;ISR_WF_R&quot;,&quot;ISR_WH_R&quot;,&quot;ISR_WK_N&quot;,&quot;ISR_WO_R&quot;,&quot;ISR_W_R&quot;,&quot;ISR_W_R_AVG&quot;,&quot;ISR_XFOOD_R&quot;,&quot;ISR_XMA_R&quot;,&quot;ISR_XM_R&quot;,&quot;ISR_XT_R&quot;,&quot;ISR_XT_RAT&quot;,&quot;ISR_YCAP_N&quot;,&quot;ISR_YD_R&quot;,&quot;ISR_YLABH_N&quot;,&quot;ISR_YLAB_N&quot;,&quot;ISR_Z&quot;,&quot;ISR_Z_AVG&quot;,&quot;ISR_Z_NFA&quot;,&quot;PFOOD_P&quot;,&quot;PMETAL_P&quot;,&quot;POIL_P&quot;,&quot;RC0_ACT_R&quot;,&quot;RC0_BREVAL_N&quot;,&quot;RC0_B_N&quot;,&quot;RC0_B_RAT&quot;,&quot;RC0_CFOOD_R&quot;,&quot;RC0_CNCOM_R&quot;,&quot;RC0_COIL_R&quot;,&quot;RC0_COM_FE_R&quot;,&quot;RC0_COM_RK_P&quot;,&quot;RC0_CPINCOM_P&quot;,&quot;RC0_CPIX_P&quot;,&quot;RC0_CPI_P&quot;,&quot;RC0_CURBAL_N&quot;,&quot;RC0_C_LIQ_R&quot;,&quot;RC0_C_OLG_R&quot;,&quot;RC0_C_R&quot;,&quot;RC0_C_RAT&quot;,&quot;RC0_DELTA&quot;,&quot;RC0_EPS&quot;,&quot;RC0_FACTFOOD_R&quot;,&quot;RC0_FACTMETAL_R&quot;,&quot;RC0_FACTOIL_R&quot;,&quot;RC0_FACT_R&quot;,&quot;RC0_FXPREM&quot;,&quot;RC0_GC_N&quot;,&quot;RC0_GC_R&quot;,&quot;RC0_GC_RAT&quot;,&quot;RC0_GDEF_N&quot;,&quot;RC0_GDEF_RAT&quot;,&quot;RC0_GDEF_TAR&quot;,&quot;RC0_GDPINC_N&quot;,&quot;RC0_GDPSIZE&quot;,&quot;RC0_GDP_FE_R&quot;,&quot;RC0_GDP_N&quot;,&quot;RC0_GDP_R&quot;,&quot;RC0_GE_N&quot;,&quot;RC0_GISTOCK_R&quot;,&quot;RC0_GI_N&quot;,&quot;RC0_GI_R&quot;,&quot;RC0_GI_RAT&quot;,&quot;RC0_GNP_R&quot;,&quot;RC0_GOVCHECK&quot;,&quot;RC0_GSUB_N&quot;,&quot;RC0_GTARIFF_N&quot;,&quot;RC0_G_R&quot;,&quot;RC0_IFOODA_R&quot;,&quot;RC0_IFOOD_R&quot;,&quot;RC0_IMETALA_R&quot;,&quot;RC0_IMETAL_R&quot;,&quot;RC0_IM_R&quot;,&quot;RC0_INFCPI&quot;,&quot;RC0_INFCPIX&quot;,&quot;RC0_INFEXP&quot;,&quot;RC0_INFL&quot;,&quot;RC0_INFPIM&quot;,&quot;RC0_INFWAGE&quot;,&quot;RC0_INFWAGEEFF&quot;,&quot;RC0_INFWEXP&quot;,&quot;RC0_INT&quot;,&quot;RC0_INT10&quot;,&quot;RC0_INTC&quot;,&quot;RC0_INTCORP&quot;,&quot;RC0_INTCOST_N&quot;,&quot;RC0_INTCOST_RAT&quot;,&quot;RC0_INTGB&quot;,&quot;RC0_INTMP&quot;,&quot;RC0_INTMPU&quot;,&quot;RC0_INTNFA&quot;,&quot;RC0_INTRF&quot;,&quot;RC0_INTRF10&quot;,&quot;RC0_INTXM10&quot;,&quot;RC0_INVESTP_R&quot;,&quot;RC0_INVEST_R&quot;,&quot;RC0_INVEST_RAT&quot;,&quot;RC0_IOILA_R&quot;,&quot;RC0_IOIL_R&quot;,&quot;RC0_ISR_SM&quot;,&quot;RC0_ISR_WM&quot;,&quot;RC0_IT_R&quot;,&quot;RC0_IT_RAT&quot;,&quot;RC0_J&quot;,&quot;RC0_KG_R&quot;,&quot;RC0_K_R&quot;,&quot;RC0_LABH_FE_R&quot;,&quot;RC0_LABH_R&quot;,&quot;RC0_LAB_FE_R&quot;,&quot;RC0_LAB_R&quot;,&quot;RC0_LF_FE_R&quot;,&quot;RC0_LF_R&quot;,&quot;RC0_LSTAX_RAT&quot;,&quot;RC0_MET_RK_P&quot;,&quot;RC0_MKTPREM&quot;,&quot;RC0_MKTPREMSM&quot;,&quot;RC0_MPC&quot;,&quot;RC0_MPCINV&quot;,&quot;RC0_MROYALTIES_N&quot;,&quot;RC0_MROYALTY&quot;,&quot;RC0_NFAREVAL_N&quot;,&quot;RC0_NFA_D&quot;,&quot;RC0_NFA_RAT&quot;,&quot;RC0_NPOPB_R&quot;,&quot;RC0_NPOPH_R&quot;,&quot;RC0_NPOP_R&quot;,&quot;RC0_NTRFPSPILL_FE_R&quot;,&quot;RC0_OILPAY_N&quot;,&quot;RC0_OILRECEIPT_N&quot;,&quot;RC0_OILSHARF&quot;,&quot;RC0_OILSUB_N&quot;,&quot;RC0_PART&quot;,&quot;RC0_PARTH&quot;,&quot;RC0_PARTH_DES&quot;,&quot;RC0_PARTH_FE&quot;,&quot;RC0_PARTH_W&quot;,&quot;RC0_PART_DES&quot;,&quot;RC0_PART_FE&quot;,&quot;RC0_PCFOOD_P&quot;,&quot;RC0_PCOIL_P&quot;,&quot;RC0_PCW_P&quot;,&quot;RC0_PC_P&quot;,&quot;RC0_PFM_P&quot;,&quot;RC0_PFOOD_P&quot;,&quot;RC0_PGDP_P&quot;,&quot;RC0_PGDP_P_AVG&quot;,&quot;RC0_PG_P&quot;,&quot;RC0_PIMADJ_P&quot;,&quot;RC0_PIMA_P&quot;,&quot;RC0_PIM_P&quot;,&quot;RC0_PIT_P&quot;,&quot;RC0_PI_P&quot;,&quot;RC0_PMETAL_P&quot;,&quot;RC0_POIL_P&quot;,&quot;RC0_POIL_P_SUB&quot;,&quot;RC0_PRIMSUR_N&quot;,&quot;RC0_PRIMSUR_TAR&quot;,&quot;RC0_PRODFOOD_R&quot;,&quot;RC0_PRODMETAL_R&quot;,&quot;RC0_PRODOIL_R&quot;,&quot;RC0_PSAVING_N&quot;,&quot;RC0_PXMF_P&quot;,&quot;RC0_PXMUNADJ_P&quot;,&quot;RC0_PXM_P&quot;,&quot;RC0_PXT_P&quot;,&quot;RC0_Q_P&quot;,&quot;RC0_R&quot;,&quot;RC0_R10&quot;,&quot;RC0_RC&quot;,&quot;RC0_RCI&quot;,&quot;RC0_RCORP&quot;,&quot;RC0_REER&quot;,&quot;RC0_RK_P&quot;,&quot;RC0_ROYALTIES_N&quot;,&quot;RC0_ROYALTIES_RAT&quot;,&quot;RC0_ROYALTY&quot;,&quot;RC0_RPREM&quot;,&quot;RC0_R_NEUT&quot;,&quot;RC0_SOVPREM&quot;,&quot;RC0_SOVPREMSM&quot;,&quot;RC0_SUB_OIL&quot;,&quot;RC0_TAU_C&quot;,&quot;RC0_TAU_K&quot;,&quot;RC0_TAU_L&quot;,&quot;RC0_TAU_OIL&quot;,&quot;RC0_TAXC_N&quot;,&quot;RC0_TAXC_RAT&quot;,&quot;RC0_TAXK_N&quot;,&quot;RC0_TAXK_RAT&quot;,&quot;RC0_TAXLH_N&quot;,&quot;RC0_TAXL_N&quot;,&quot;RC0_TAXL_RAT&quot;,&quot;RC0_TAXOIL_N&quot;,&quot;RC0_TAX_N&quot;,&quot;RC0_TAX_RAT&quot;,&quot;RC0_TB_N&quot;,&quot;RC0_TFPEFFECT_R&quot;,&quot;RC0_TFPKGSPILL_FE_R&quot;,&quot;RC0_TFPSPILL_FE_R&quot;,&quot;RC0_TFP_FE_R&quot;,&quot;RC0_TFP_FE_R_AVG&quot;,&quot;RC0_TFP_R&quot;,&quot;RC0_TM&quot;,&quot;RC0_TPREM&quot;,&quot;RC0_TRANSFER_LIQ_N&quot;,&quot;RC0_TRANSFER_N&quot;,&quot;RC0_TRANSFER_OLG_N&quot;,&quot;RC0_TRANSFER_RAT&quot;,&quot;RC0_TRANSFER_TARG_N&quot;,&quot;RC0_TRANSFER_TARG_RAT&quot;,&quot;RC0_TRFPSPILL_FE_R&quot;,&quot;RC0_UFOOD_R&quot;,&quot;RC0_UMETAL_R&quot;,&quot;RC0_UNR&quot;,&quot;RC0_UNRH&quot;,&quot;RC0_UNRH_FE&quot;,&quot;RC0_UNR_FE&quot;,&quot;RC0_UOIL_R&quot;,&quot;RC0_USA_SM&quot;,&quot;RC0_USA_WM&quot;,&quot;RC0_WAGEEFF_N&quot;,&quot;RC0_WAGEH_N&quot;,&quot;RC0_WAGE_N&quot;,&quot;RC0_WF_R&quot;,&quot;RC0_WH_R&quot;,&quot;RC0_WK_N&quot;,&quot;RC0_WO_R&quot;,&quot;RC0_W_R&quot;,&quot;RC0_W_R_AVG&quot;,&quot;RC0_XFOOD_R&quot;,&quot;RC0_XMA_R&quot;,&quot;RC0_XMETAL_R&quot;,&quot;RC0_XM_R&quot;,&quot;RC0_XOIL_R&quot;,&quot;RC0_XT_R&quot;,&quot;RC0_XT_RAT&quot;,&quot;RC0_YCAP_N&quot;,&quot;RC0_YD_R&quot;,&quot;RC0_YLABH_N&quot;,&quot;RC0_YLAB_N&quot;,&quot;RC0_Z&quot;,&quot;RC0_Z_AVG&quot;,&quot;RC0_Z_NFA&quot;,&quot;RPFOOD&quot;,&quot;RPMETAL&quot;,&quot;RPMETAL_ADJ&quot;,&quot;RPMETAL_AVG&quot;,&quot;RPOIL&quot;,&quot;RPOIL_ADJ&quot;,&quot;RPOIL_AVG&quot;,&quot;USA_ACT_R&quot;,&quot;USA_BREVAL_N&quot;,&quot;USA_B_N&quot;,&quot;USA_B_RAT&quot;,&quot;USA_CFOOD_R&quot;,&quot;USA_CNCOM_R&quot;,&quot;USA_COIL_R&quot;,&quot;USA_COM_FE_R&quot;,&quot;USA_COM_RK_P&quot;,&quot;USA_CPINCOM_P&quot;,&quot;USA_CPIX_P&quot;,&quot;USA_CPI_P&quot;,&quot;USA_CURBAL_N&quot;,&quot;USA_C_LIQ_R&quot;,&quot;USA_C_OLG_R&quot;,&quot;USA_C_R&quot;,&quot;USA_C_RAT&quot;,&quot;USA_DELTA&quot;,&quot;USA_EPS&quot;,&quot;USA_FACTFOOD_R&quot;,&quot;USA_FACTMETAL_R&quot;,&quot;USA_FACTOIL_R&quot;,&quot;USA_FACT_R&quot;,&quot;USA_FXPREM&quot;,&quot;USA_GC_N&quot;,&quot;USA_GC_R&quot;,&quot;USA_GC_RAT&quot;,&quot;USA_GDEF_N&quot;,&quot;USA_GDEF_RAT&quot;,&quot;USA_GDEF_TAR&quot;,&quot;USA_GDPINC_N&quot;,&quot;USA_GDPSIZE&quot;,&quot;USA_GDP_FE_R&quot;,&quot;USA_GDP_N&quot;,&quot;USA_GDP_R&quot;,&quot;USA_GE_N&quot;,&quot;USA_GISTOCK_R&quot;,&quot;USA_GI_N&quot;,&quot;USA_GI_R&quot;,&quot;USA_GI_RAT&quot;,&quot;USA_GNP_R&quot;,&quot;USA_GOVCHECK&quot;,&quot;USA_GSUB_N&quot;,&quot;USA_GTARIFF_N&quot;,&quot;USA_G_R&quot;,&quot;USA_IFOODA_R&quot;,&quot;USA_IFOOD_R&quot;,&quot;USA_IMETALA_R&quot;,&quot;USA_IMETAL_R&quot;,&quot;USA_IM_R&quot;,&quot;USA_INFCPI&quot;,&quot;USA_INFCPIX&quot;,&quot;USA_INFEXP&quot;,&quot;USA_INFL&quot;,&quot;USA_INFPIM&quot;,&quot;USA_INFWAGE&quot;,&quot;USA_INFWAGEEFF&quot;,&quot;USA_INFWEXP&quot;,&quot;USA_INT&quot;,&quot;USA_INT10&quot;,&quot;USA_INTC&quot;,&quot;USA_INTCORP&quot;,&quot;USA_INTCOST_N&quot;,&quot;USA_INTCOST_RAT&quot;,&quot;USA_INTGB&quot;,&quot;USA_INTMP&quot;,&quot;USA_INTMPU&quot;,&quot;USA_INTNFA&quot;,&quot;USA_INTRF&quot;,&quot;USA_INTRF10&quot;,&quot;USA_INTXM10&quot;,&quot;USA_INVESTP_R&quot;,&quot;USA_INVEST_R&quot;,&quot;USA_INVEST_RAT&quot;,&quot;USA_IOILA_R&quot;,&quot;USA_IOIL_R&quot;,&quot;USA_ISR_SM&quot;,&quot;USA_ISR_WM&quot;,&quot;USA_IT_R&quot;,&quot;USA_IT_RAT&quot;,&quot;USA_J&quot;,&quot;USA_KG_R&quot;,&quot;USA_K_R&quot;,&quot;USA_LABH_FE_R&quot;,&quot;USA_LABH_R&quot;,&quot;USA_LAB_FE_R&quot;,&quot;USA_LAB_R&quot;,&quot;USA_LF_FE_R&quot;,&quot;USA_LF_R&quot;,&quot;USA_LSTAX_RAT&quot;,&quot;USA_MET_RK_P&quot;,&quot;USA_MKTPREM&quot;,&quot;USA_MKTPREMSM&quot;,&quot;USA_MPC&quot;,&quot;USA_MPCINV&quot;,&quot;USA_MROYALTIES_N&quot;,&quot;USA_MROYALTY&quot;,&quot;USA_NFAREVAL_N&quot;,&quot;USA_NFA_D&quot;,&quot;USA_NFA_RAT&quot;,&quot;USA_NPOPB_R&quot;,&quot;USA_NPOPH_R&quot;,&quot;USA_NPOP_R&quot;,&quot;USA_NTRFPSPILL_FE_R&quot;,&quot;USA_OILPAY_N&quot;,&quot;USA_OILRECEIPT_N&quot;,&quot;USA_OILSHARF&quot;,&quot;USA_OILSUB_N&quot;,&quot;USA_PART&quot;,&quot;USA_PARTH&quot;,&quot;USA_PARTH_DES&quot;,&quot;USA_PARTH_FE&quot;,&quot;USA_PARTH_W&quot;,&quot;USA_PART_DES&quot;,&quot;USA_PART_FE&quot;,&quot;USA_PCFOOD_P&quot;,&quot;USA_PCOIL_P&quot;,&quot;USA_PCW_P&quot;,&quot;USA_PC_P&quot;,&quot;USA_PFM_P&quot;,&quot;USA_PFOOD_P&quot;,&quot;USA_PGDP_P&quot;,&quot;USA_PGDP_P_AVG&quot;,&quot;USA_PG_P&quot;,&quot;USA_PIMADJ_P&quot;,&quot;USA_PIMA_P&quot;,&quot;USA_PIM_P&quot;,&quot;USA_PIT_P&quot;,&quot;USA_PI_P&quot;,&quot;USA_PMETAL_P&quot;,&quot;USA_POIL_P&quot;,&quot;USA_POIL_P_SUB&quot;,&quot;USA_PRIMSUR_N&quot;,&quot;USA_PRIMSUR_TAR&quot;,&quot;USA_PRODFOOD_R&quot;,&quot;USA_PRODMETAL_R&quot;,&quot;USA_PRODOIL_R&quot;,&quot;USA_PSAVING_N&quot;,&quot;USA_PXMF_P&quot;,&quot;USA_PXMUNADJ_P&quot;,&quot;USA_PXM_P&quot;,&quot;USA_PXT_P&quot;,&quot;USA_Q_P&quot;,&quot;USA_R&quot;,&quot;USA_R10&quot;,&quot;USA_RC&quot;,&quot;USA_RC0_SM&quot;,&quot;USA_RC0_WM&quot;,&quot;USA_RCI&quot;,&quot;USA_RCORP&quot;,&quot;USA_REER&quot;,&quot;USA_RK_P&quot;,&quot;USA_ROYALTIES_N&quot;,&quot;USA_ROYALTIES_RAT&quot;,&quot;USA_ROYALTY&quot;,&quot;USA_RPREM&quot;,&quot;USA_R_NEUT&quot;,&quot;USA_SOVPREM&quot;,&quot;USA_SOVPREMSM&quot;,&quot;USA_SUB_OIL&quot;,&quot;USA_TAU_C&quot;,&quot;USA_TAU_K&quot;,&quot;USA_TAU_L&quot;,&quot;USA_TAU_OIL&quot;,&quot;USA_TAXC_N&quot;,&quot;USA_TAXC_RAT&quot;,&quot;USA_TAXK_N&quot;,&quot;USA_TAXK_RAT&quot;,&quot;USA_TAXLH_N&quot;,&quot;USA_TAXL_N&quot;,&quot;USA_TAXL_RAT&quot;,&quot;USA_TAXOIL_N&quot;,&quot;USA_TAX_N&quot;,&quot;USA_TAX_RAT&quot;,&quot;USA_TB_N&quot;,&quot;USA_TFPEFFECT_R&quot;,&quot;USA_TFPKGSPILL_FE_R&quot;,&quot;USA_TFPSPILL_FE_R&quot;,&quot;USA_TFP_FE_R&quot;,&quot;USA_TFP_FE_R_AVG&quot;,&quot;USA_TFP_R&quot;,&quot;USA_TM&quot;,&quot;USA_TPREM&quot;,&quot;USA_TRANSFER_LIQ_N&quot;,&quot;USA_TRANSFER_N&quot;,&quot;USA_TRANSFER_OLG_N&quot;,&quot;USA_TRANSFER_RAT&quot;,&quot;USA_TRANSFER_TARG_N&quot;,&quot;USA_TRANSFER_TARG_RAT&quot;,&quot;USA_TRFPSPILL_FE_R&quot;,&quot;USA_UFOOD_R&quot;,&quot;USA_UMETAL_R&quot;,&quot;USA_UNR&quot;,&quot;USA_UNRH&quot;,&quot;USA_UNRH_FE&quot;,&quot;USA_UNR_FE&quot;,&quot;USA_UOIL_R&quot;,&quot;USA_WAGEEFF_N&quot;,&quot;USA_WAGEH_N&quot;,&quot;USA_WAGE_N&quot;,&quot;USA_WF_R&quot;,&quot;USA_WH_R&quot;,&quot;USA_WK_N&quot;,&quot;USA_WO_R&quot;,&quot;USA_W_R&quot;,&quot;USA_W_R_AVG&quot;,&quot;USA_XFOOD_R&quot;,&quot;USA_XMA_R&quot;,&quot;USA_XMETAL_R&quot;,&quot;USA_XM_R&quot;,&quot;USA_XOIL_R&quot;,&quot;USA_XT_R&quot;,&quot;USA_XT_RAT&quot;,&quot;USA_YCAP_N&quot;,&quot;USA_YD_R&quot;,&quot;USA_YLABH_N&quot;,&quot;USA_YLAB_N&quot;,&quot;USA_Z&quot;,&quot;USA_Z_AVG&quot;,&quot;USA_Z_NFA&quot;,&quot;WRL_GDP_FE_METAL_R&quot;,&quot;WRL_GDP_FE_OIL_R&quot;,&quot;WRL_GDP_FE_R&quot;,&quot;WRL_GDP_METAL_R&quot;,&quot;WRL_GDP_OIL_R&quot;,&quot;WRL_GDP_R&quot;,&quot;WRL_PRODFOOD_R&quot;,&quot;WRL_PRODMETAL_R&quot;,&quot;WRL_PRODOIL_R&quot;,&quot;WRL_XFOOD_R&quot;,&quot;WRL_XMETAL_R&quot;,&quot;WRL_XOIL_R&quot;,&quot;WTRADE_FOOD_N&quot;,&quot;WTRADE_FOOD_R&quot;,&quot;WTRADE_METAL_N&quot;,&quot;WTRADE_METAL_R&quot;,&quot;WTRADE_M_N&quot;,&quot;WTRADE_M_R&quot;,&quot;WTRADE_OIL_N&quot;,&quot;WTRADE_OIL_R&quot;]</span>
    <span class="c1"># eq = &quot;((-(USA_XOIL5)) * (LambertW((((-(USA_XOIL_R(-(1)))) * ((USA_XOIL5) - (1))) * (exp((((CONSTANT_USA_XOIL_R) * (USA_GDP_R_BAR) + (E_USA_XOIL_R) * (USA_XOIL_R_BAR) + (FILTER_USA_XOIL_R) * (USA_GDP_R_BAR)) - (USA_UOIL_R_BAR) + USA_UOIL_R + (USA_XOIL5) * ((((((((-(CONSTANT_USA_XOIL_R)) * (USA_GDP_R_BAR) + (CONSTANT_USA_XOIL_R) * (USA_XOIL2) + (E_USA_XOIL_R) * (USA_XOIL2)) - ((E_USA_XOIL_R) * (USA_XOIL_R_BAR))) - ((FILTER_USA_XOIL_R) * (USA_GDP_R_BAR)) + (FILTER_USA_XOIL_R) * (USA_XOIL2) + USA_UOIL_R_BAR) - (USA_UOIL_R) + (USA_XOIL1) * (log(RPOIL))) - ((USA_XOIL1) * (log(RPOIL(-(1))))) + ((USA_XOIL2) * (USA_XOIL3)) * (log(RPOIL(-(1)))) + (USA_XOIL2) * (log((USA_FACTOIL_R(-(1))) / (USA_GREAL_SS)))) - ((USA_XOIL2) * (log((USA_XOIL_R(-(1))) / (USA_GREAL_SS)))) + (USA_XOIL4) * (log(USA_FACTOIL_R))) - ((USA_XOIL4) * (log(USA_FACTOIL_R(-(1))))))) / (USA_XOIL5)))) / (USA_XOIL5)))) / ((USA_XOIL5) - (1))&quot;</span>
    <span class="c1"># eq_ast = ast.parse(eq).body[0]</span>
    <span class="c1"># eq_std = normalize(eq_ast,variables=variables)</span>
    <span class="c1"># eq_sym = ast_to_sympy(eq_std)</span>
            
    <span class="n">test_deriv</span><span class="p">()</span>
    <span class="n">test_deriv2</span><span class="p">()</span>
    
<span class="c1">#    from time import time</span>
<span class="c1">#    t0 = time()</span>
<span class="c1">#    n = 1000</span>
<span class="c1">#    size = 2</span>
<span class="c1">#    series=non_decreasing_series(n, size)  </span>
<span class="c1">#    #print(series)</span>
<span class="c1">#    elapsed = time() - t0</span>
<span class="c1">#    print(elapsed,len(series))</span>

    
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">Python Platform</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/modules.html">snowdrop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../info.html">Python Platform</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Alexei Goumilevski.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>