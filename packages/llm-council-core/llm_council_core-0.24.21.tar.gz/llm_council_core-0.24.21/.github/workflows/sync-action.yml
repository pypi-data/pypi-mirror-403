# Sync GitHub Action version on release
# Triggers when a new version is released to PyPI
# Updates the llm-council-action repo with the new version

name: Sync Action Version

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to sync (e.g., 0.24.5)'
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Syncing version: $VERSION"

      - name: Checkout action repo
        uses: actions/checkout@v4
        with:
          repository: amiable-dev/llm-council-action
          token: ${{ secrets.ACTION_REPO_PAT }}

      - name: Update action.yml version
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Update default version in action.yml
          sed -i "s/default: '[0-9]\+\.[0-9]\+\.[0-9]\+'/default: '$VERSION'/" action.yml

          echo "Updated action.yml:"
          grep -A1 "version:" action.yml | head -4

      - name: Create sync commit
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git add action.yml
          git commit -m "chore: sync with llm-council-core v$VERSION"
          git push origin main

      - name: Update v1 tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Delete and recreate v1 tag to point to latest
          git tag -d v1 2>/dev/null || true
          git push origin :refs/tags/v1 2>/dev/null || true
          git tag v1
          git push origin v1

          # Also create versioned tag
          git tag "v$VERSION" 2>/dev/null || true
          git push origin "v$VERSION" 2>/dev/null || true

          echo "Updated tags: v1 -> v$VERSION"
