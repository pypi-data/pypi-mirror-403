"""
Abstract base class for cloud providers.

This module defines the interface that all cloud providers must implement.
"""

from abc import ABC, abstractmethod
from pathlib import Path
from typing import Any, Dict, List, Optional, Union

from .models import CloudDevice, DeviceFilter, TestArtifact, TestRun


class CloudProvider(ABC):
    """
    Abstract base class for cloud testing providers.

    All cloud providers (Firebase Test Lab, AWS Device Farm, etc.) must
    implement this interface to ensure consistent behavior.
    """

    @property
    @abstractmethod
    def name(self) -> str:
        """Get the provider name."""
        pass

    @abstractmethod
    def authenticate(self) -> bool:
        """
        Authenticate with the cloud provider.

        Returns:
            True if authentication was successful.

        Raises:
            CloudAuthenticationError: If authentication fails.
        """
        pass

    @abstractmethod
    def is_authenticated(self) -> bool:
        """
        Check if currently authenticated.

        Returns:
            True if authenticated.
        """
        pass

    @abstractmethod
    def list_devices(self, filters: Optional[DeviceFilter] = None) -> List[CloudDevice]:
        """
        List available devices in the cloud platform.

        Args:
            filters: Optional filters to narrow down device selection.

        Returns:
            List of available CloudDevice objects.

        Raises:
            CloudProviderError: If listing fails.
        """
        pass

    @abstractmethod
    def acquire_device(
        self, model: str, os_version: Optional[str] = None, timeout: int = 300
    ) -> CloudDevice:
        """
        Acquire a specific device for testing.

        Args:
            model: Device model name.
            os_version: Specific OS version (optional).
            timeout: Maximum time to wait for device in seconds.

        Returns:
            CloudDevice that was acquired.

        Raises:
            CloudDeviceNotAvailableError: If device cannot be acquired.
            CloudTimeoutError: If acquisition times out.
        """
        pass

    @abstractmethod
    def release_device(self, device: CloudDevice) -> bool:
        """
        Release a previously acquired device.

        Args:
            device: Device to release.

        Returns:
            True if device was released successfully.
        """
        pass

    @abstractmethod
    def run_test(
        self,
        devices: List[CloudDevice],
        workflow_path: Union[str, Path],
        timeout: int = 3600,
        **options,
    ) -> TestRun:
        """
        Run a test on the specified devices.

        Args:
            devices: List of devices to run the test on.
            workflow_path: Path to the DittoMation workflow file.
            timeout: Maximum test duration in seconds.
            **options: Provider-specific options.

        Returns:
            TestRun object representing the test execution.

        Raises:
            CloudTestRunError: If test fails to start.
        """
        pass

    @abstractmethod
    def get_run_status(self, run_id: str) -> TestRun:
        """
        Get the current status of a test run.

        Args:
            run_id: Test run identifier.

        Returns:
            Updated TestRun object.

        Raises:
            CloudTestRunError: If run cannot be found.
        """
        pass

    @abstractmethod
    def wait_for_completion(
        self, run: TestRun, timeout: Optional[int] = None, poll_interval: int = 30
    ) -> TestRun:
        """
        Wait for a test run to complete.

        Args:
            run: TestRun to wait for.
            timeout: Maximum time to wait (None for no limit).
            poll_interval: Seconds between status checks.

        Returns:
            Completed TestRun object.

        Raises:
            CloudTimeoutError: If timeout is reached.
        """
        pass

    @abstractmethod
    def cancel_run(self, run: TestRun) -> bool:
        """
        Cancel a running test.

        Args:
            run: TestRun to cancel.

        Returns:
            True if cancellation was successful.
        """
        pass

    @abstractmethod
    def list_artifacts(self, run: TestRun) -> List[TestArtifact]:
        """
        List artifacts generated by a test run.

        Args:
            run: TestRun to get artifacts for.

        Returns:
            List of TestArtifact objects.
        """
        pass

    @abstractmethod
    def download_artifact(self, artifact: TestArtifact, output_path: Union[str, Path]) -> Path:
        """
        Download an artifact to local storage.

        Args:
            artifact: Artifact to download.
            output_path: Local path to save the artifact.

        Returns:
            Path to the downloaded file.

        Raises:
            CloudProviderError: If download fails.
        """
        pass

    def collect_artifacts(
        self, run: TestRun, output_dir: Union[str, Path], artifact_types: Optional[List[str]] = None
    ) -> List[TestArtifact]:
        """
        Download all artifacts from a test run.

        Args:
            run: TestRun to collect artifacts from.
            output_dir: Directory to save artifacts.
            artifact_types: List of artifact types to download (None for all).

        Returns:
            List of downloaded TestArtifact objects with local_path set.
        """
        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)

        artifacts = self.list_artifacts(run)
        downloaded = []

        for artifact in artifacts:
            if artifact_types:
                if artifact.artifact_type.value not in artifact_types:
                    continue

            output_path = output_dir / artifact.name
            try:
                local_path = self.download_artifact(artifact, output_path)
                artifact.local_path = str(local_path)
                downloaded.append(artifact)
            except Exception:
                pass  # Skip failed downloads

        return downloaded

    def get_configuration(self) -> Dict[str, Any]:
        """
        Get the current provider configuration.

        Returns:
            Dictionary with configuration values.
        """
        return {}

    def set_configuration(self, config: Dict[str, Any]) -> None:
        """
        Set provider configuration.

        Args:
            config: Configuration dictionary.
        """
        pass
