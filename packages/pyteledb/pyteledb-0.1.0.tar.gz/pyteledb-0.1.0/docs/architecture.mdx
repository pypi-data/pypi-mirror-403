# Architecture

This document describes the architectural decisions and data model of pyteledb.

## Core Principle

> **"This is not a database engine. This is a Telegram-native persistence abstraction."**

pyteledb treats Telegram as the source of truth. All data lives in Telegram messages, and local state is purely ephemeral (for caching and performance).

## Data Model

### Record Topology

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Telegram Channel/Group                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  ğŸ“Œ Pinned Message (Root Index)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ {                                                     â”‚   â”‚
â”‚  â”‚   "_": "PTDB",                                        â”‚   â”‚
â”‚  â”‚   "name": "my_database",                              â”‚   â”‚
â”‚  â”‚   "id": "abc123...",                                  â”‚   â”‚
â”‚  â”‚   "chain": { "head": {...}, "tail": {...} },          â”‚   â”‚
â”‚  â”‚   "count": 42                                         â”‚   â”‚
â”‚  â”‚ }                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Record  â”‚â”€â”€â”€â–¶â”‚ Record  â”‚â”€â”€â”€â–¶â”‚ Record  â”‚                  â”‚
â”‚  â”‚   #1    â”‚â—€â”€â”€â”€â”‚   #2    â”‚â—€â”€â”€â”€â”‚   #3    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Record Structure

Each record is stored as a Telegram message containing JSON:

```json
{
  "meta": {
    "rid": "abc123...",           // Record ID
    "mid": 12345,                 // Message ID
    "ver": {"v": 1, "c": ...},    // Version info
    "chk": "a1b2c3d4",            // Checksum
    "prev": "xyz789...",          // Previous record
    "next": null                  // Next record
  },
  "data": {
    "user_id": 12345,
    "name": "Alice",
    "score": 100
  }
}
```

## Performance Model

### Hard Constraints

1. **Never scan full chat history** â€” Only fetch required message IDs
2. **Cache fetched records** â€” TTL/LRU eviction
3. **Prefer `editMessage`** â€” Over `sendMessage` for updates
4. **Rate-limit aware** â€” Respect Telegram API limits

### Caching Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Application â”‚â”€â”€â”€â”€â–¶â”‚  Local Cache  â”‚â”€â”€â”€â”€â–¶â”‚   Telegram    â”‚
â”‚               â”‚â—€â”€â”€â”€â”€â”‚ (Memory/SQL)  â”‚â—€â”€â”€â”€â”€â”‚   Messages    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                      TTL/LRU Eviction
```

- **Cache Hit**: Return immediately from local cache
- **Cache Miss**: Fetch from Telegram, cache the result
- **Write-Through**: Update both cache and Telegram

## Consistency & Safety

Telegram provides **no transactions**. pyteledb implements:

### Optimistic Locking

```python
# Each record has a version number
record = await db.get(record_id)
# version = 1

# Concurrent update attempt
await db.update(record_id, new_data, expected_version=1)
# If version changed, raises VersionConflictError
```

### Soft Locks

For operations requiring exclusive access:

```python
async with LockContext(lock_manager, "resource_id"):
    # Only one writer at a time
    await db.update(...)
```

### Crash Recovery

All writes are designed to be **idempotent and retry-safe**:

1. Each record has a checksum for corruption detection
2. Orphaned records can be detected and relinked
3. RepairTool can reconstruct consistent state

## Module Boundaries

```
pyteledb/
â”œâ”€â”€ core/           # Database logic
â”‚   â”œâ”€â”€ database.py     â†’ TelegramDatabase (main interface)
â”‚   â”œâ”€â”€ record.py       â†’ Record data structure
â”‚   â”œâ”€â”€ root.py         â†’ Root index management
â”‚   â”œâ”€â”€ pointers.py     â†’ Linked list structure
â”‚   â”œâ”€â”€ locks.py        â†’ Soft locking
â”‚   â””â”€â”€ repair.py       â†’ Crash recovery
â”‚
â”œâ”€â”€ telegram/       # STRICT Bot API boundary
â”‚   â”œâ”€â”€ client.py       â†’ HTTP client for Bot API
â”‚   â”œâ”€â”€ messages.py     â†’ Message operations
â”‚   â”œâ”€â”€ files.py        â†’ File upload/download
â”‚   â””â”€â”€ pins.py         â†’ Pin management
â”‚
â”œâ”€â”€ storage/        # Data encoding
â”‚   â”œâ”€â”€ serializer.py   â†’ JSON serialization
â”‚   â”œâ”€â”€ checksum.py     â†’ Data integrity
â”‚   â””â”€â”€ versioning.py   â†’ Version tracking
â”‚
â”œâ”€â”€ cache/          # Ephemeral state
â”‚   â”œâ”€â”€ memory.py       â†’ In-memory LRU cache
â”‚   â””â”€â”€ sqlite.py       â†’ SQLite persistence
â”‚
â””â”€â”€ ops/            # Operational safety
    â”œâ”€â”€ throttling.py   â†’ Rate limiting
    â”œâ”€â”€ queue.py        â†’ Write batching
    â””â”€â”€ metrics.py      â†’ Observability
```

## Limits & Trade-offs

| Aspect | Limit | Notes |
|--------|-------|-------|
| Message size | 4096 chars | Use file attachments for larger payloads |
| Rate limits | ~30 msg/sec | Built-in throttling handles this |
| Bot access | Channel admin | Bot must be admin to pin/edit |
| Query capabilities | By ID only | No complex queries |

## Enforcement Rules

Any change that:
- Breaks Telegram-native assumptions
- Requires external state
- Obscures failure modes
- Violates module boundaries

**Will be rejected.**
