name: CI

on:
  push:
    branches:
    - main
    tags-ignore:
    - '**'  # Don't run on tag pushes (semantic-release)
  pull_request:
    paths:
    - src/**
    - tests/**
    - pyproject.toml
    - uv.lock
    - .pre-commit-config.yaml
  workflow_dispatch:
    inputs:
      release_tag:
        description: Release tag to deploy (e.g., v2.0.0). Leave empty to use the latest release.
        required: false
        type: string
        default: ''


env:
  PYTHON_VERSION: '3.11'
  UV_VERSION: 0.9.4

jobs:
  # Code quality checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7
      with:
        version: ${{ env.UV_VERSION }}
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --frozen

    - name: Run Ruff format check
      run: uv run ruff format --check .

    - name: Run Ruff linter
      run: uv run ruff check .

    - name: Run Pyright type checker
      run: uv run pyright

    - name: Check for security issues
      run: |
        uv pip install "bandit[toml]"
        uv run bandit -c pyproject.toml -r src/

  # Verify auto-generated files are up-to-date
  generated-files:
    name: Verify Generated Files
    needs: quality
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7
      with:
        version: ${{ env.UV_VERSION }}
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --frozen

    - name: Regenerate protocol files
      run: uv run python -m lifx.protocol.generator

    - name: Regenerate product registry
      run: uv run python -m lifx.products.generator

    - name: Format and lint generated files
      run: |
        uv run ruff format src/lifx/protocol/packets.py src/lifx/protocol/protocol_types.py src/lifx/products/registry.py
        uv run ruff check --fix src/lifx/protocol/packets.py src/lifx/protocol/protocol_types.py src/lifx/products/registry.py

    - name: Check for differences
      run: |
        if ! git diff --exit-code src/lifx/protocol/packets.py src/lifx/protocol/protocol_types.py src/lifx/products/registry.py; then
          echo "::error::Generated files do not match committed versions. See diff above for details."
          exit 1
        fi
        echo "All generated files are up-to-date."

  # Testing matrix across Python versions and platforms
  test:
    name: Test (Python ${{ matrix.python-version }} on ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    # Only run tests on pull requests (skip on main branch pushes since tests already passed in PR)
    if: github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install uv
      uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7
      with:
        version: ${{ env.UV_VERSION }}
        python-version: ${{ matrix.python-version }}
        enable-cache: true

    - name: Install dependencies
      run: uv sync --frozen

    - name: Run unit tests
      run: uv run --frozen pytest

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
      with:
        env_vars: OS,PYTHON
        fail_ci_if_error: false
        name: pytest-${{ matrix.os }}-${{ matrix.python-version }}-coverage
        report_type: coverage
        token: ${{ secrets.CODECOV_TOKEN }}
        verbose: true

    - name: Upload test results to Codecov
      if: matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
      with:
        env_vars: OS,PYTHON
        fail_ci_if_error: false
        name: pytest-${{ matrix.os }}-${{ matrix.python-version }}-test_results
        report_type: test_results
        token: ${{ secrets.CODECOV_TOKEN }}
        verbose: true


  # Tests are skipped when the CI triggers for the push to main
  # So this job runs pytest with a single Python version to get
  # code coverage for the main branch pushed to codecov.io
  codecov:
    needs:
    - quality
    if: github.event_name == 'push' && github.ref_name == 'main'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8   # v6

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405   # v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b   # v7
      with:
        version: ${{ env.UV_VERSION }}
        python-version: ${{ env.PYTHON_VERSION }}
        enable-cache: true

    - name: Install dependencies
      run: uv sync --frozen

    - name: Run unit tests
      run: uv run --frozen pytest

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
      with:
        fail_ci_if_error: false
        name: pytest-code-coverage-main
        report_type: coverage
        token: ${{ secrets.CODECOV_TOKEN }}
        verbose: true

    - name: Upload test results to Codecov
      uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
      with:
        fail_ci_if_error: false
        name: pytest-test-results-main
        report_type: test_results
        token: ${{ secrets.CODECOV_TOKEN }}
        verbose: true

  release:
    needs:
    - quality
    - generated-files
    - test
    # Run release if not cancelled AND (manual dispatch OR quality passed with tests passed/skipped)
    if: ${{ !cancelled() && (github.event_name == 'workflow_dispatch' || (needs.quality.result == 'success' && (needs.test.result == 'success' || needs.test.result == 'skipped'))) }}
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: write

    concurrency:
      group: ${{ github.workflow }}-release-${{ github.ref_name }}
      cancel-in-progress: false

    outputs:
      released: ${{ steps.release.outputs.released || 'false' }}


    steps:
    - name: Checkout repository on release branch
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      with:
        ref: ${{ github.head_ref || github.ref_name }}
        fetch-depth: 0
        ssh-key: ${{ secrets.DEPLOY_KEY }}

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7
      with:
        version: ${{ env.UV_VERSION }}
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Configure git
      run: |
        git config --local user.email "github-actions@github.com"
        git config --local user.name "GitHub Actions"

    - name: Run Python Semantic Release (NOOP)
      id: psr-noop
      if: github.event_name != 'workflow_dispatch' && github.ref_name != 'main'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        uv run --with python-semantic-release semantic-release --noop version

    - name: Run Python Semantic Release
      id: release
      if: github.event_name != 'workflow_dispatch' && github.ref_name == 'main'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Capture output to detect if a release was made
        output=$(uv run --with python-semantic-release semantic-release version 2>&1)
        echo "$output"

        # Check if a release was made (no "No release will be made" message)
        if echo "$output" | grep -q "No release will be made"; then
          echo "released=false" >> $GITHUB_OUTPUT
        else
          # Publish distribution artifacts to release
          uv run --with python-semantic-release semantic-release publish
          echo "released=true" >> $GITHUB_OUTPUT
        fi

    - name: Upload Distribution Artifacts
      if: github.event_name != 'workflow_dispatch'
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
      with:
        name: distribution-artifacts
        path: dist


  deploy:
    runs-on: ubuntu-latest
    needs: release
    # Run on manual trigger OR when release job created a new release
    if: ${{ github.event_name == 'workflow_dispatch' || (!cancelled() && needs.release.outputs.released == 'true') }}

    permissions:
      contents: read
      id-token: write

    environment:
      name: pypi
      url: https://pypi.org/p/lifx-async

    steps:
    - name: Determine release tag for manual deployment
      if: github.event_name == 'workflow_dispatch'
      id: get-release-tag
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ -n "${{ inputs.release_tag }}" ]; then
          echo "tag=${{ inputs.release_tag }}" >> $GITHUB_OUTPUT
        else
          # Get latest release tag
          latest_tag=$(gh release list --repo ${{ github.repository }} --limit 1 --json tagName --jq '.[0].tagName')
          echo "tag=${latest_tag}" >> $GITHUB_OUTPUT
        fi

    - name: Download artifacts from GitHub Release
      if: github.event_name == 'workflow_dispatch'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        mkdir -p dist
        gh release download ${{ steps.get-release-tag.outputs.tag }} --repo ${{ github.repository }} --pattern '*.whl' --dir dist
        gh release download ${{ steps.get-release-tag.outputs.tag }} --repo ${{ github.repository }} --pattern '*.tar.gz' --dir dist
        echo "Downloaded artifacts for ${{ steps.get-release-tag.outputs.tag }}:"
        ls -lh dist/

    - name: Download Build Artifacts from workflow
      if: github.event_name != 'workflow_dispatch'
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
      id: artifact-download
      with:
        name: distribution-artifacts
        path: dist

    - name: Publish package distributions to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: dist
        print-hash: true
        verbose: true
