"""
OMNIMIND Document Generator
Generate professional documents from text content.

Supported formats:
- .pdf (ReportLab / FPDF)
- .docx (python-docx)
- .html (Jinja2 / Built-in)
- .md (Markdown)
"""
import os
import re
from typing import Dict, Any, List, Optional
from dataclasses import dataclass

@dataclass
class DocumentConfig:
    """Style configuration for generated documents"""
    title: str = "OMNIMIND Document"
    author: str = "OMNIMIND AI"
    font_size: int = 12
    font_name: str = "Helvetica"
    margin: int = 20


class DocumentGenerator:
    """
    Universal Document Generator
    
    Usage:
        gen = DocumentGenerator()
        gen.create_pdf("Hello World", "output.pdf")
    """
    
    def __init__(self, config: Optional[DocumentConfig] = None):
        self.config = config or DocumentConfig()
    
    def generate(self, content: str, output_path: str, format: str = "auto") -> str:
        """Generate document from content"""
        if format == "auto":
            ext = os.path.splitext(output_path)[1].lower()
            format = ext.replace(".", "")
            
        if format == "pdf":
            return self.create_pdf(content, output_path)
        elif format in ["docx", "doc"]:
            return self.create_docx(content, output_path)
        elif format == "html":
            return self.create_html(content, output_path)
        elif format == "md":
            return self.create_markdown(content, output_path)
        else:
            return self.create_text(content, output_path)

    def create_pdf(self, content: str, output_path: str) -> str:
        """Create PDF document"""
        try:
            from reportlab.lib.pagesizes import letter
            from reportlab.pdfgen import canvas
            from reportlab.lib.utils import simpleSplit
            
            c = canvas.Canvas(output_path, pagesize=letter)
            width, height = letter
            
            # Title
            c.setFont("Helvetica-Bold", 16)
            c.drawString(72, height - 72, self.config.title)
            
            # Content
            c.setFont(self.config.font_name, self.config.font_size)
            y = height - 100
            
            # Simple word wrap
            lines = []
            for para in content.split('\n'):
                lines.extend(simpleSplit(para, self.config.font_name, self.config.font_size, width - 144))
            
            for line in lines:
                if y < 72:
                    c.showPage()
                    y = height - 72
                c.drawString(72, y, line)
                y -= 14
                
            c.save()
            return output_path
            
        except ImportError:
            # Fallback if reportlab missing
            print("⚠️ reportlab not installed. Saving as text.")
            return self.create_text(content, output_path + ".txt")

    def create_docx(self, content: str, output_path: str) -> str:
        """Create Word document"""
        try:
            from docx import Document
            
            doc = Document()
            doc.add_heading(self.config.title, 0)
            
            for para in content.split('\n'):
                if para.strip():
                    doc.add_paragraph(para)
            
            doc.save(output_path)
            return output_path
            
        except ImportError:
            print("⚠️ python-docx not installed. Saving as text.")
            return self.create_text(content, output_path + ".txt")

    def create_html(self, content: str, output_path: str) -> str:
        """Create HTML document"""
        # Convert markdown-style to simple HTML
        html_content = content.replace("\n", "<br>")
        
        template = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>{self.config.title}</title>
            <style>
                body {{ font-family: sans-serif; margin: 40px; line-height: 1.6; }}
                h1 {{ color: #333; }}
            </style>
        </head>
        <body>
            <h1>{self.config.title}</h1>
            <p>{html_content}</p>
            <hr>
            <small>Generated by {self.config.author}</small>
        </body>
        </html>
        """
        
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(template)
        return output_path

    def create_markdown(self, content: str, output_path: str) -> str:
        """Create Markdown file"""
        full_content = f"# {self.config.title}\n\n{content}"
        return self.create_text(full_content, output_path)

    def create_text(self, content: str, output_path: str) -> str:
        """Create plain text file"""
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(content)
        return output_path
