name: Release Prebuilt Index

on:
  workflow_dispatch:
    inputs:
      docs_version:
        description: 'Cangjie docs version (git tag, e.g., v1.0.7)'
        required: true
        default: 'v1.0.7'
      docs_lang:
        description: 'Documentation language'
        required: true
        default: 'zh'
        type: choice
        options:
          - zh
          - en

env:
  PYTHON_VERSION: "3.13"

jobs:
  build-and-release:
    name: Build and Release Prebuilt Index
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Build prebuilt archive
        run: |
          uv run cangjie-mcp prebuilt build \
            --version ${{ github.event.inputs.docs_version }} \
            --lang ${{ github.event.inputs.docs_lang }} \
            --embedding openai \
            --data-dir ./data
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_EMBEDDING_MODEL: ${{ secrets.OPENAI_EMBEDDING_MODEL_ADVANCED }}

      - name: Find archive file
        id: find-archive
        run: |
          ARCHIVE_PATH=$(find data/indexes -name "*.tar.gz" | head -1)
          echo "archive_path=$ARCHIVE_PATH" >> $GITHUB_OUTPUT
          echo "archive_name=$(basename $ARCHIVE_PATH)" >> $GITHUB_OUTPUT
          echo "Found archive: $ARCHIVE_PATH"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: prebuilt-${{ github.event.inputs.docs_version }}-${{ github.event.inputs.docs_lang }}
          name: "Prebuilt Index - ${{ github.event.inputs.docs_version }} (${{ github.event.inputs.docs_lang }})"
          body: |
            ## Prebuilt Index for Cangjie Documentation

            - **Docs Version**: ${{ github.event.inputs.docs_version }}
            - **Language**: ${{ github.event.inputs.docs_lang }}
            - **Embedding Type**: openai

            ### Usage

            Download the archive and install it using the CLI:

            ```bash
            cangjie-mcp prebuilt download --url <download-url>
            ```

            Or manually extract to your data directory.
          files: ${{ steps.find-archive.outputs.archive_path }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
