{"version":3,"file":"useKeyValueEditor-6fUhwaEz.js","sources":["../../../ui/src/builder/settings/composables/useKeyValueEditor.ts"],"sourcesContent":["import { computed, readonly, ref, shallowRef } from \"vue\";\nimport type { JSONValue } from \"../BuilderFieldsKeyValue.vue\";\nimport { TEMPLATE_REGEX } from \"@/renderer/useEvaluator\";\n\ntype AssistedEntry = { key: string; value: string };\nexport type Mode = \"assisted\" | \"freehand\";\n\nfunction isValidJSON(value: string) {\n\ttry {\n\t\tJSON.parse(value);\n\t\treturn true;\n\t} catch {\n\t\treturn false;\n\t}\n}\nfunction tryToParse(value: string) {\n\ttry {\n\t\treturn JSON.parse(value);\n\t} catch {\n\t\treturn {};\n\t}\n}\n\nfunction isFlatRecordString(obj: object): obj is Record<string, string> {\n\treturn Object.values(obj).every((v) => typeof v === \"string\");\n}\n\nexport function useKeyValueEditor(originalValue: string | JSONValue) {\n\tconst getId = useId();\n\n\tconst mode = ref<Mode>(computeInitialMode(originalValue));\n\tconst freehandValue = ref(\n\t\ttypeof originalValue === \"string\"\n\t\t\t? originalValue\n\t\t\t: JSON.stringify(originalValue),\n\t);\n\tconst assistedEntries = shallowRef<Record<string, AssistedEntry>>({});\n\n\tinitializeAssistedEntries(originalValue);\n\n\tfunction setMode(newMode: Mode) {\n\t\tif (mode.value === newMode) return;\n\t\tswitch (newMode) {\n\t\t\tcase \"assisted\":\n\t\t\t\tinitializeAssistedEntries(currentValue.value);\n\t\t\t\tbreak;\n\t\t\tcase \"freehand\":\n\t\t\t\tfreehandValue.value = JSON.stringify(\n\t\t\t\t\tcurrentValueObject.value,\n\t\t\t\t\tundefined,\n\t\t\t\t\t2,\n\t\t\t\t);\n\t\t\t\tbreak;\n\t\t}\n\t\tmode.value = newMode;\n\t}\n\n\t// assisted entries\n\n\tfunction updateAssistedEntries(value: Record<string, unknown>) {\n\t\tassistedEntries.value = Object.entries(value).reduce(\n\t\t\t(acc, [key, value]) => {\n\t\t\t\tacc[getId()] = { key, value: String(value) };\n\t\t\t\treturn acc;\n\t\t\t},\n\t\t\t{},\n\t\t);\n\t}\n\n\tfunction addAssistedEntry() {\n\t\tassistedEntries.value = {\n\t\t\t...assistedEntries.value,\n\t\t\t[getId()]: { value: \"\", key: \"\" },\n\t\t};\n\t}\n\n\tfunction updateAssistedEntryKey(id: string, key: string) {\n\t\tconst entry = assistedEntries.value[id];\n\t\tif (!entry) return;\n\n\t\tassistedEntries.value = {\n\t\t\t...assistedEntries.value,\n\t\t\t[id]: { ...entry, key },\n\t\t};\n\t}\n\tfunction updateAssistedEntryValue(id: string, value: string) {\n\t\tconst entry = assistedEntries.value[id];\n\t\tif (!entry) return;\n\n\t\tassistedEntries.value = {\n\t\t\t...assistedEntries.value,\n\t\t\t[id]: { ...entry, value },\n\t\t};\n\t}\n\tfunction removeAssistedEntry(id: string) {\n\t\tif (!assistedEntries.value[id]) return;\n\t\tconst copy = { ...assistedEntries.value };\n\t\tdelete copy[id];\n\t\tassistedEntries.value = copy;\n\t}\n\n\tfunction getAssistedEntryError(id: string): string | undefined {\n\t\tconst entry = assistedEntries.value[id];\n\t\tif (!entry) return;\n\n\t\tif (assitedEntriesDuplicatedKeys.value.has(entry.key)) {\n\t\t\treturn \"This key is already in use. Please remove duplicate keys.\";\n\t\t}\n\t}\n\n\tfunction computeInitialMode(objectOrString: string | JSONValue): Mode {\n\t\tif (typeof objectOrString !== \"string\") {\n\t\t\treturn isFlatRecordString(objectOrString) ? \"assisted\" : \"freehand\";\n\t\t}\n\n\t\tif (TEMPLATE_REGEX.exec(objectOrString)) return \"freehand\";\n\t\tif (!isValidJSON(objectOrString)) return \"freehand\";\n\n\t\treturn isFlatRecordString(tryToParse(objectOrString))\n\t\t\t? \"assisted\"\n\t\t\t: \"freehand\";\n\t}\n\n\tfunction initializeAssistedEntries(objectOrString: string | JSONValue) {\n\t\tconst object =\n\t\t\ttypeof objectOrString === \"string\"\n\t\t\t\t? tryToParse(objectOrString)\n\t\t\t\t: objectOrString;\n\n\t\tassistedEntries.value = Object.entries(object).reduce<\n\t\t\tRecord<string, AssistedEntry>\n\t\t>((acc, [key, value]) => {\n\t\t\tacc[getId()] = { key, value: String(value) };\n\t\t\treturn acc;\n\t\t}, {});\n\n\t\tif (Object.keys(assistedEntries.value).length === 0) addAssistedEntry();\n\t}\n\tconst addAssistedEntryDisabled = computed(() =>\n\t\tObject.values(assistedEntries.value).some((k) => k.key === \"\"),\n\t);\n\n\tconst assitedEntriesDuplicatedKeys = computed(() => {\n\t\tconst keys = new Set<string>();\n\t\tconst duplicatedKeys = new Set<string>();\n\n\t\tfor (const { key } of Object.values(assistedEntries.value)) {\n\t\t\tif (keys.has(key)) {\n\t\t\t\tduplicatedKeys.add(key);\n\t\t\t} else {\n\t\t\t\tkeys.add(key);\n\t\t\t}\n\t\t}\n\n\t\treturn duplicatedKeys;\n\t});\n\n\tconst isValid = computed(() => {\n\t\tswitch (mode.value) {\n\t\t\tcase \"assisted\":\n\t\t\t\treturn assitedEntriesDuplicatedKeys.value.size === 0;\n\t\t\tcase \"freehand\":\n\t\t\t\treturn true;\n\t\t\tdefault:\n\t\t\t\treturn false;\n\t\t}\n\t});\n\n\tconst currentValue = computed<string>(() => {\n\t\tswitch (mode.value) {\n\t\t\tcase \"assisted\": {\n\t\t\t\tconst obj = Object.values(assistedEntries.value)\n\t\t\t\t\t.filter((v) => !(v.key === \"\" && v.value === \"\"))\n\t\t\t\t\t.reduce((acc, v) => {\n\t\t\t\t\t\tacc[v.key] = v.value;\n\t\t\t\t\t\treturn acc;\n\t\t\t\t\t}, {});\n\t\t\t\treturn JSON.stringify(obj);\n\t\t\t}\n\t\t\tcase \"freehand\":\n\t\t\t\treturn freehandValue.value;\n\n\t\t\tdefault:\n\t\t\t\treturn \"\";\n\t\t}\n\t});\n\n\tconst currentValueObject = computed<JSONValue>(() =>\n\t\ttryToParse(currentValue.value),\n\t);\n\n\treturn {\n\t\tmode: computed<Mode>({ get: () => mode.value, set: setMode }),\n\t\tassistedEntries: readonly(assistedEntries),\n\t\taddEntryDisabled: addAssistedEntryDisabled,\n\t\taddAssistedEntry,\n\t\tupdateAssistedEntryKey,\n\t\tupdateAssistedEntryValue,\n\t\tremoveAssistedEntry,\n\t\tgetAssistedEntryError,\n\t\tupdateAssistedEntries,\n\t\tfreehandValue,\n\t\tisValid,\n\t\tcurrentValue,\n\t\tcurrentValueObject,\n\t};\n}\n\nfunction useId() {\n\tlet nextId = 0;\n\treturn () => String(++nextId);\n}\n"],"names":["isValidJSON","value","tryToParse","isFlatRecordString","obj","v","useKeyValueEditor","originalValue","getId","useId","mode","ref","computeInitialMode","freehandValue","assistedEntries","shallowRef","initializeAssistedEntries","setMode","newMode","currentValue","currentValueObject","updateAssistedEntries","acc","key","addAssistedEntry","updateAssistedEntryKey","id","entry","updateAssistedEntryValue","removeAssistedEntry","copy","getAssistedEntryError","assitedEntriesDuplicatedKeys","objectOrString","TEMPLATE_REGEX","object","addAssistedEntryDisabled","computed","k","keys","duplicatedKeys","isValid","readonly","nextId"],"mappings":"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"}