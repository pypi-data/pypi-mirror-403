{"version":3,"file":"useBlueprintRun-DWmMgV1z.js","sources":["../../../ui/src/composables/useBlueprintRun.ts"],"sourcesContent":["import { computed, readonly, Ref, ref, unref } from \"vue\";\nimport { useWriterTracking } from \"./useWriterTracking\";\nimport type { BuilderManager, Core } from \"@/writerTypes\";\nimport { inject } from \"vue\";\nimport injectionKeys from \"@/injectionKeys\";\n\ninterface RunBlueprintResponse {\n\tok: boolean;\n\tpayload: {\n\t\tmail: {\n\t\t\tpayload: {\n\t\t\t\ttype: \"info\" | \"error\";\n\t\t\t\ttitle: string;\n\t\t\t};\n\t\t}[];\n\t\tresult: {\n\t\t\tok: boolean;\n\t\t};\n\t};\n}\n\nfunction runBlueprint(\n\twf: Core,\n\tblueprintComponentId: string,\n\tbranchId?: string,\n) {\n\treturn new Promise<void>((res, rej) => {\n\t\tconst tracking = useWriterTracking(wf);\n\t\ttracking.track(\"blueprints_run_started\");\n\t\tconst startedAt = new Date().getTime();\n\n\t\tfunction callback(result: RunBlueprintResponse) {\n\t\t\tconst hasError = result.payload?.mail?.some(\n\t\t\t\t(m) => m.payload?.type === \"error\",\n\t\t\t);\n\t\t\tconst trackPayload = {\n\t\t\t\tdurationMs: new Date().getTime() - startedAt,\n\t\t\t};\n\t\t\tif (hasError) {\n\t\t\t\ttracking.track(\"blueprints_run_failed\", trackPayload);\n\t\t\t} else {\n\t\t\t\ttracking.track(\"blueprints_run_succeeded\", trackPayload);\n\t\t\t}\n\t\t\tres(undefined);\n\t\t}\n\n\t\twf.forwardEvent(\n\t\t\tbranchId\n\t\t\t\t? new CustomEvent(\"wf-run-blueprint-branch\", {\n\t\t\t\t\t\tdetail: {\n\t\t\t\t\t\t\tcallback,\n\t\t\t\t\t\t\thandler: \"run_blueprint_branch\",\n\t\t\t\t\t\t\tpayload: { branch_id: branchId },\n\t\t\t\t\t\t},\n\t\t\t\t\t})\n\t\t\t\t: new CustomEvent(\"wf-run-blueprint\", {\n\t\t\t\t\t\tdetail: {\n\t\t\t\t\t\t\tcallback,\n\t\t\t\t\t\t\thandler: \"run_blueprint_by_id\",\n\t\t\t\t\t\t\tpayload: { blueprint_id: blueprintComponentId },\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\tnull,\n\t\t\ttrue,\n\t\t).catch((err) => {\n\t\t\ttracking.track(\"blueprints_run_failed\", { error: String(err) });\n\t\t\trej(err);\n\t\t});\n\t});\n}\n\nfunction stopBlueprintRun(wf: Core, runId: string) {\n\treturn new Promise<void>((res, rej) => {\n\t\tconst tracking = useWriterTracking(wf);\n\t\ttracking.track(\"blueprints_run_stopped\");\n\n\t\twf.forwardEvent(\n\t\t\tnew CustomEvent(\"wf-stop-blueprint\", {\n\t\t\t\tdetail: {\n\t\t\t\t\thandler: \"stop_blueprint_run\",\n\t\t\t\t\tpayload: { run_id: runId },\n\t\t\t\t},\n\t\t\t}),\n\t\t\tnull,\n\t\t\ttrue,\n\t\t)\n\t\t\t.then(() => res())\n\t\t\t.catch((err) => {\n\t\t\t\ttracking.track(\"blueprints_run_stop_failed\", {\n\t\t\t\t\terror: String(err),\n\t\t\t\t});\n\t\t\t\trej(err);\n\t\t\t});\n\t});\n}\n\nexport function useBlueprintRun(\n\twf: Core,\n\twfbm: BuilderManager,\n\tblueprintComponentId: string | Ref<string>,\n) {\n\tconst isRunning = ref(false);\n\n\tasync function run(branchId?: string) {\n\t\tif (isRunning.value) return;\n\t\tisRunning.value = true;\n\t\ttry {\n\t\t\tawait runBlueprint(wf, unref(blueprintComponentId), branchId);\n\t\t} finally {\n\t\t\tisRunning.value = false;\n\t\t}\n\t}\n\n\tasync function stop() {\n\t\tconst activeRunId = wfbm.activeBlueprintRunId.value;\n\t\tif (!activeRunId) return;\n\t\tawait stopBlueprintRun(wf, activeRunId);\n\t}\n\n\treturn { isRunning: readonly(isRunning), run, stop };\n}\n\nexport type BlueprintsRunListItem = { blueprintId: string; branchId: string };\ntype MaybeRef<T> = T | Ref<T>;\n\nexport function useBlueprintsRun(\n\twf: Core,\n\tblueprintComponentIds: MaybeRef<BlueprintsRunListItem[]>,\n) {\n\tconst runningBlueprintIds = ref<string[]>([]);\n\n\tasync function handleRunBlueprint({\n\t\tblueprintId,\n\t\tbranchId,\n\t}: BlueprintsRunListItem) {\n\t\tif (runningBlueprintIds.value.includes(blueprintId)) return;\n\n\t\ttry {\n\t\t\trunningBlueprintIds.value = [\n\t\t\t\tblueprintId,\n\t\t\t\t...runningBlueprintIds.value,\n\t\t\t];\n\t\t\tawait runBlueprint(wf, blueprintId, branchId);\n\t\t} finally {\n\t\t\trunningBlueprintIds.value = runningBlueprintIds.value.filter(\n\t\t\t\t(id) => id !== blueprintId,\n\t\t\t);\n\t\t}\n\t}\n\tasync function run() {\n\t\tawait Promise.all(unref(blueprintComponentIds).map(handleRunBlueprint));\n\t}\n\n\tconst isRunning = computed(() => runningBlueprintIds.value.length > 0);\n\n\treturn {\n\t\trun,\n\t\tisRunning,\n\t\trunningBlueprintIds: readonly(runningBlueprintIds),\n\t};\n}\n"],"names":["runBlueprint","wf","blueprintComponentId","branchId","res","rej","tracking","useWriterTracking","startedAt","callback","result","hasError","_b","_a","m","trackPayload","err","stopBlueprintRun","runId","useBlueprintRun","wfbm","isRunning","ref","run","unref","stop","activeRunId","readonly","useBlueprintsRun","blueprintComponentIds","runningBlueprintIds","handleRunBlueprint","blueprintId","id","computed"],"mappings":"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"}