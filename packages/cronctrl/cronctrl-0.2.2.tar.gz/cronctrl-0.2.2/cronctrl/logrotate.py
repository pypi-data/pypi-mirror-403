"""Logrotate generation helpers (Phase 4)."""

from __future__ import annotations

import os
from typing import Any


class LogrotateError(Exception):
    pass


def render(cfg: dict[str, Any]) -> str:
    log_dir = cfg.get("log_dir")
    if not isinstance(log_dir, str) or not log_dir.strip():
        raise LogrotateError("log_dir: required")

    jobs = cfg.get("jobs")
    if not isinstance(jobs, dict):
        raise LogrotateError("jobs: missing or invalid in config")

    stanzas: list[str] = []
    retentions: list[int] = []

    for job_name in sorted(jobs.keys()):
        job = jobs[job_name]
        if not isinstance(job, dict):
            continue
        if job.get("disabled") is True:
            continue
        retention = job.get("retention_days")
        if not isinstance(retention, int) or retention <= 0:
            raise LogrotateError(f"jobs.{job_name}.retention_days: required")
        retentions.append(retention)
        stanzas.append(_render_stanza(os.path.join(log_dir, f"{job_name}.log"), retention))

    if retentions:
        stanzas.append(_render_stanza(os.path.join(log_dir, "all.log"), max(retentions)))

    header = [
        "# Generated by cronctrl. DO NOT EDIT.",
    ]
    return _join_lines(header + stanzas)


def apply(cfg: dict[str, Any]) -> str:
    content = render(cfg)
    path = "/etc/logrotate.d/cronctrl"
    tmp_path = f"{path}.tmp"
    with open(tmp_path, "w", encoding="utf-8") as handle:
        handle.write(content)
    os.chmod(tmp_path, 0o644)
    os.replace(tmp_path, path)
    return path


def remove() -> str | None:
    path = "/etc/logrotate.d/cronctrl"
    try:
        os.remove(path)
    except FileNotFoundError:
        return None
    return path


def _render_stanza(path: str, retention_days: int) -> str:
    lines = [
        f"{path} {{",
        "  daily",
        f"  rotate {retention_days}",
        "  missingok",
        "  notifempty",
        "  copytruncate",
        "  compress",
        "}",
    ]
    return _join_lines(lines)


def _join_lines(lines: list[str]) -> str:
    text = "\n".join(line.rstrip("\n") for line in lines)
    return text.rstrip() + "\n\n"
