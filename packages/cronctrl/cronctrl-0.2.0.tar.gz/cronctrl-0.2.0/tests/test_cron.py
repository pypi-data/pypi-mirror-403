from cronctrl import cron


def _base_cfg():
    return {
        "log_dir": "/var/log/cronctrl",
        "state_dir": "/var/lib/cronctrl",
        "jobs": {},
    }


def test_render_etc_crond_basic():
    cfg = _base_cfg()
    cfg["jobs"] = {
        "heartbeat": {
            "schedule": "* * * * *",
            "exec": "/bin/echo heartbeat",
            "retention_days": 1,
        }
    }

    output = cron.render_etc_crond(cfg, config_path="/etc/cronctrl/jobs.yaml", user="root")
    assert output.startswith("# Generated by cronctrl")
    assert "* * * * * root cronctrl --config /etc/cronctrl/jobs.yaml run heartbeat" in output


def test_render_etc_crond_skips_disabled():
    cfg = _base_cfg()
    cfg["jobs"] = {
        "enabled": {
            "schedule": "0 1 * * *",
            "exec": "/bin/echo ok",
            "retention_days": 1,
        },
        "disabled": {
            "schedule": "0 2 * * *",
            "exec": "/bin/echo no",
            "retention_days": 1,
            "disabled": True,
        },
    }

    output = cron.render_etc_crond(cfg, config_path="/etc/cronctrl/jobs.yaml", user="root")
    assert "run enabled" in output
    assert "run disabled" not in output


def test_merge_managed_block_replaces():
    cfg = _base_cfg()
    cfg["jobs"] = {
        "job": {
            "schedule": "* * * * *",
            "exec": "/bin/echo hi",
            "retention_days": 1,
        }
    }

    block = cron._render_managed_block(cfg, "/etc/cronctrl/jobs.yaml", "", True)
    existing = "MAILTO=admin@example.com\n" + cron.BEGIN_MARKER + "\nold\n" + cron.END_MARKER + "\n"
    merged = cron._merge_managed_block(existing, block)

    assert "MAILTO=admin@example.com" in merged
    assert "old" not in merged
    assert cron.BEGIN_MARKER in merged
    assert cron.END_MARKER in merged
    assert "run job" in merged


def test_user_crontab_remove_missing_false_preserves():
    cfg = _base_cfg()
    cfg["jobs"] = {
        "new_job": {
            "schedule": "* * * * *",
            "exec": "/bin/echo hi",
            "retention_days": 1,
        }
    }
    existing = (
        "MAILTO=admin@example.com\n"
        "# BEGIN CRONCTRL MANAGED\n"
        "* * * * * cronctrl --config /etc/cronctrl/jobs.yaml run old_job\n"
        "# END CRONCTRL MANAGED\n"
    )

    merged = cron.render_user_crontab(
        cfg,
        config_path="/etc/cronctrl/jobs.yaml",
        remove_missing=False,
        existing_crontab=existing,
    )

    assert "run new_job" in merged
    assert "run old_job" in merged
    assert "MAILTO=admin@example.com" in merged


def test_user_crontab_remove_missing_true_removes():
    cfg = _base_cfg()
    cfg["jobs"] = {
        "new_job": {
            "schedule": "* * * * *",
            "exec": "/bin/echo hi",
            "retention_days": 1,
        }
    }
    existing = (
        "# BEGIN CRONCTRL MANAGED\n"
        "* * * * * cronctrl --config /etc/cronctrl/jobs.yaml run old_job\n"
        "# END CRONCTRL MANAGED\n"
    )

    merged = cron.render_user_crontab(
        cfg,
        config_path="/etc/cronctrl/jobs.yaml",
        remove_missing=True,
        existing_crontab=existing,
    )

    assert "run new_job" in merged
    assert "run old_job" not in merged


def test_remove_managed_block_strips_block():
    existing = (
        "MAILTO=admin@example.com\n"
        "# BEGIN CRONCTRL MANAGED\n"
        "* * * * * cronctrl --config /etc/cronctrl/jobs.yaml run job\n"
        "# END CRONCTRL MANAGED\n"
        "SHELL=/bin/bash\n"
    )
    cleaned = cron._remove_managed_block(existing)
    assert "BEGIN CRONCTRL MANAGED" not in cleaned
    assert "run job" not in cleaned
    assert "MAILTO=admin@example.com" in cleaned
    assert "SHELL=/bin/bash" in cleaned
