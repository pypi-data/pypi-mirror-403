"""Tests for the Angular models generator."""

import json
from pathlib import Path

import pytest

from openapi_ts_client.generators.angular.models import generate_models


@pytest.fixture
def space_zoo_spec():
    """Load the space zoo OpenAPI spec."""
    spec_path = Path(__file__).parent / "fixtures" / "space_zoo" / "openapi.json"
    with open(spec_path) as f:
        return json.load(f)


@pytest.fixture
def space_zoo_fixture_path():
    """Path to space zoo angular fixtures."""
    return Path(__file__).parent / "fixtures" / "space_zoo" / "angular" / "model"


@pytest.fixture
def temp_output_path(tmp_path):
    """Temporary path for generated output."""
    output = tmp_path / "model"
    output.mkdir()
    return output


class TestGenerateModels:
    """Tests for the generate_models function."""

    def test_generates_simple_model_without_imports(
        self, space_zoo_spec, space_zoo_fixture_path, temp_output_path
    ):
        """Test generating a simple model without imports matches fixture exactly."""
        generate_models(space_zoo_spec, temp_output_path)

        generated = (temp_output_path / "feedingOut.ts").read_text()
        expected = (space_zoo_fixture_path / "feedingOut.ts").read_text()

        assert generated == expected

    def test_generates_model_files_for_all_schemas(self, space_zoo_spec, temp_output_path):
        """Test that model files are generated for all schemas in the spec."""
        generate_models(space_zoo_spec, temp_output_path)

        schemas = space_zoo_spec.get("components", {}).get("schemas", {})

        # Check all expected files exist
        for schema_name in schemas:
            filename = f"{schema_name[0].lower() + schema_name[1:]}.ts"
            assert (temp_output_path / filename).exists(), f"Missing file: {filename}"

    def test_generates_models_barrel_export(self, space_zoo_spec, temp_output_path):
        """Test that models.ts barrel export is generated with correct format."""
        generate_models(space_zoo_spec, temp_output_path)

        barrel_path = temp_output_path / "models.ts"
        assert barrel_path.exists()

        content = barrel_path.read_text()
        lines = [line for line in content.strip().split("\n") if line]

        # Check format of each line
        for line in lines:
            assert line.startswith("export * from './")
            assert line.endswith("';")

        # Check that all generated model files are exported
        model_files = {f.stem for f in temp_output_path.glob("*.ts") if f.name != "models.ts"}
        exported_names = {line.split("'./")[1].split("'")[0] for line in lines}
        assert exported_names == model_files

    def test_model_has_correct_interface_name(self, space_zoo_spec, temp_output_path):
        """Test that generated models use the correct interface name."""
        generate_models(space_zoo_spec, temp_output_path)

        content = (temp_output_path / "feedingOut.ts").read_text()
        assert "export interface FeedingOut" in content

    def test_model_has_correct_header(self, space_zoo_spec, temp_output_path):
        """Test that generated models have the correct header."""
        generate_models(space_zoo_spec, temp_output_path)

        content = (temp_output_path / "feedingOut.ts").read_text()
        assert "Space Zoo Management API" in content
        assert "NOTE: This file is auto generated by openapi-ts-client" in content

    def test_model_with_imports_has_import_statements(self, space_zoo_spec, temp_output_path):
        """Test that models with $ref dependencies have import statements."""
        generate_models(space_zoo_spec, temp_output_path)

        content = (temp_output_path / "habitatOut.ts").read_text()

        # Should have imports for the referenced types
        assert "import { BiomeTypeIn }" in content
        assert "import { OriginPlanetIn }" in content
        assert "import { EnclosureIn }" in content

    def test_model_properties_have_correct_types(self, space_zoo_spec, temp_output_path):
        """Test that model properties have correct TypeScript types."""
        generate_models(space_zoo_spec, temp_output_path)

        content = (temp_output_path / "habitatOut.ts").read_text()

        # Required properties should not have ?
        assert "name: string;" in content

        # Array types should use Array<T>
        assert "originPlanets: Array<OriginPlanetIn>;" in content

        # Optional nullable types should have ?
        assert "id?: number | null;" in content

    def test_model_optional_properties_marked_correctly(self, space_zoo_spec, temp_output_path):
        """Test that optional properties have ? marker."""
        generate_models(space_zoo_spec, temp_output_path)

        content = (temp_output_path / "feedingOut.ts").read_text()

        # All properties in FeedingOut are optional (not in required list)
        assert "projectName?: string;" in content
        assert "id?: number | null;" in content
