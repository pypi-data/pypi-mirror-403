## 什么是 Host Client？

Host Client 是用于上位机的客户端，负责与云服务器、电子学设备交互。它首先从云服务器上拉取最新的实验任务，并通过 QHAL 层的实现编译为电子学设备可以识别的控制脉冲信号，然后与电子学设备通信以发送信号、接收反馈测量结果，最后上传至服务器。另外 Host Client 也承担了对电子学设备的监控工作，会实时向云服务器上传设备状态。

> **提示**：Host Client 实例只需在能够与控制设备（电子学设备）直接通信的上位机上运行即可。通过 Host Client 与云服务器建立的通信连接，其他用户也可以远程访问和操作真机设备，实现资源共享和协作实验。

![](./structure.png)

### Direct Link

Direct Link 是 Host Client 提供的本地与云服务器之间的直接连接通道。通过配置 Direct Link 端口（默认 6887），Host Client 会在本地启动一个 Web 服务，允许您通过浏览器直接访问 Host Client 的 Web 界面，实现本地与云服务器的实时交互和数据传输。这个机制使得您可以在本地环境中方便地监控和管理 Host Client 的运行状态，查看实验进度和结果。

此外，Direct Link 还支持在本地直接提交实验任务，而不需要经过云服务器。这意味着您可以在本地环境中快速测试和调试实验，提高开发效率，同时减少对云服务器的依赖。

## 主要功能

- **实验任务管理**：从云服务器拉取最新的实验任务，执行实验流程
- **信号编译与发送**：通过 QHAL 层将实验任务编译为电子学设备可识别的控制脉冲信号，并发送至设备
- **数据采集与反馈**：接收电子学设备的反馈和测量结果，并上传至云服务器
- **设备监控**：实时监控电子学设备状态，并向云服务器上传设备状态信息
- **进程管理**：通过 Dashboard 管理 Host Client 进程的启动、停止和监控
- **日志查看**：实时查看 Host Client 的运行日志，便于调试和问题排查

## Host Client 脚本介绍

Host Client 脚本是用于启动和管理 Host Client 实例的 Python 脚本。每个脚本通常针对特定的硬件设备或设备组进行定制。

### 脚本结构

Host Client 脚本通常包含以下核心组件：

#### 1. Compiler Worker（编译工作器）

负责将实验任务中的波形包（WavePackage）编译为电子学设备可以识别的控制脉冲信号。主要功能包括：

- **通道解析**：解析和控制通道名称（如 X、Y、Z、M 通道）
- **信号编译**：将抽象的量子操作转换为具体的控制脉冲序列
- **时序对齐**：处理不同通道之间的时序同步问题
- **采样率配置**：根据不同的通道类型（XY、Z、M）设置相应的采样率

#### 2. QHAL Worker（QHAL 工作器）

QHAL（Quantum Hardware Abstraction Layer）工作器负责与硬件设备直接交互，是 Host Client 与电子学设备之间的桥梁。主要功能包括：

- **设备管理**：初始化和连接电子学设备（如 QCS520、DC2000、CTP1000 等）
- **参数配置**：从设备组配置中读取并设置硬件参数（采样率、触发延迟、偏置电压等）
- **波形上传**：将编译后的控制脉冲序列上传到硬件设备
- **实验执行**：控制设备执行实验并触发数据采集
- **数据下载**：从设备下载 IQ 测量数据

#### 3. PostProcess Worker（后处理工作器）

负责对原始测量结果进行后处理和分析。主要功能包括：

- **IQ 数据处理**：计算平均 IQ 幅度和相位
- **状态判别**：根据 IQ 数据和读取矩阵（readout matrix）进行量子态判别
- **布居数计算**：计算各个量子态的布居数（population）
- **数据清理**：根据配置决定是否保留完整的 IQ 数据

### 命令行参数

Host Client 脚本通常支持以下命令行参数：

- `group_name`（必填）：设备组名称，用于标识要连接的设备组
- `-p, --port`（可选）：Direct Link 端口号，默认为 6887

### 脚本执行流程

1. **参数解析**：解析命令行参数，获取设备组名称和端口配置
2. **实例创建**：创建 Main 实例，并传入自定义的 Worker 类
3. **初始化**：初始化设备管理器，连接硬件设备
4. **任务循环**：持续从云服务器拉取实验任务
5. **任务处理**：对每个任务执行编译 → QHAL 执行 → 后处理的完整流程
6. **结果上传**：将处理后的实验结果上传到云服务器

### 自定义开发

不同的硬件平台需要实现相应的 Worker 类来适配特定的设备接口和协议。开发者可以根据硬件特性自定义：

- **Compiler**：适配不同的信号格式和编译规则
- **QHAL**：适配不同的设备通信协议和接口
- **PostProcess**：实现特定的数据处理和分析算法

## 界面操作说明

### 1. 运行设置面板（左侧）

#### 脚本来源选择

- **本地脚本**：选择本地文件系统中的脚本文件（绝对路径）
- **脚本管理器**：从云服务器的脚本管理器中选择脚本（推荐）

#### 脚本路径配置

- **本地脚本**：输入脚本的绝对路径，例如 `C:/path/to/start_host_client.py`
- **脚本管理器**：输入脚本在服务器中的路径，例如 `/cloud/scripts/start_host_client.py`，或点击"选择"按钮从脚本管理器中选择

#### Direct Link 端口

设置 Host Client 监听的端口号（默认 6887），用于建立本地与云服务器的直接连接

#### 运行/停止按钮

- 点击"运行"按钮启动 Host Client 进程
- 点击"停止"按钮终止正在运行的 Host Client 进程

### 2. 内容区域（右侧）

#### 运行日志 Tab

- 实时显示 Host Client 的标准输出日志
- 支持自动滚动到最新日志
- 可以点击"清空"按钮清除当前显示的日志（不影响进程运行）
- 日志包含时间戳、日志级别和详细内容

#### Host Client 界面 Tab

- 当 Host Client 运行后，会在此 Tab 中显示 Host Client 的 Web 界面
- 界面通过 iframe 嵌入，地址为 `http://localhost:<Direct Link Port>`
- 如果 Host Client 未运行，会显示提示信息

#### 帮助说明 Tab

- 查看本说明文档，了解 Host Client 的功能和使用方法

## 使用流程

1. 选择脚本来源（本地脚本或脚本管理器）
2. 配置脚本路径（手动输入或通过脚本管理器选择）
3. 设置 Direct Link 端口（通常使用默认值 6887）
4. 点击"运行"按钮启动 Host Client
5. 在"运行日志"Tab 中查看启动过程和运行日志
6. 切换到"Host Client 界面"Tab 查看和使用 Host Client 的 Web 界面
7. 需要停止时，点击"停止"按钮

## 状态指示

- <span class="status-indicator status-idle"></span> **空闲**：Host Client 未运行
- <span class="status-indicator status-running"></span> **运行中**：Host Client 正在运行
- <span class="status-indicator status-stopped"></span> **已停止**：Host Client 已停止运行

## 注意事项

- 确保脚本路径正确，且脚本文件具有执行权限
- Direct Link 端口不能与其他服务冲突，建议使用默认值 6887
- 如果 Host Client 启动失败，请查看运行日志中的错误信息
- 停止 Host Client 时，系统会自动终止所有相关子进程
- 配置信息会自动保存，下次打开时会自动加载
- 如果使用脚本管理器，脚本会自动下载到本地缓存目录

