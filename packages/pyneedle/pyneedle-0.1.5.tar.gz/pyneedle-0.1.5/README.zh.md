# PyNeedle: è¯­ä¹‰æŒ‡é’ˆè¿è¡Œæ—¶

![License](https://img.shields.io/badge/License-Apache_2.0-blue.svg)

**ä¸€ä¸ªç°ä»£åŒ–çš„å·¥å…·åŒ…ï¼Œç”¨äºåœ¨ Python åº”ç”¨ä¸­å°†â€œè¯­ä¹‰â€ä¸â€œå®ç°â€è§£è€¦ã€‚**

[English](https://github.com/quipu-dev/Needle/blob/main/packages/pyneedle/README.md) | [ä¸­æ–‡](https://github.com/quipu-dev/Needle/blob/main/packages/pyneedle/README.zh.md)

---

## ä»€ä¹ˆæ˜¯ PyNeedle?

PyNeedle æ˜¯ä¸€ä¸ªå°å‹è€Œå¼ºå¤§çš„åº“ï¼Œæ—¨åœ¨é€šè¿‡ä¸€ä¸ªæ¸…æ™°ã€ç›´è§‚ä¸”ç±»å‹å®‰å…¨çš„ API æ¥ç®¡ç†åº”ç”¨ç¨‹åºå­—ç¬¦ä¸²ã€å›½é™…åŒ– (i18n) å’Œå…¶ä»–å¯å¯»å€èµ„æºã€‚å®ƒç”¨**è¯­ä¹‰æŒ‡é’ˆ (Semantic Pointers)** å–ä»£äº†â€œé­”æ³•å­—ç¬¦ä¸²â€â€”â€”è¿™äº›æŒ‡é’ˆå¯¹è±¡ä»£è¡¨çš„æ˜¯èµ„æºçš„*å«ä¹‰*ï¼Œè€Œéå…¶å…·ä½“çš„å€¼ã€‚

æ‚¨å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆåœ¨æ‚¨åº”ç”¨ç¨‹åºèµ„æºçš„â€œå¹²è‰å †â€ä¸­å¯»æ‰¾ä¸€æ ¹â€œé’ˆâ€(Needle)ï¼Œä½†æ‚¨ä¸æ˜¯é€šè¿‡å­—ç¬¦ä¸²é”®æ¥æœç´¢ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ªç»“æ„åŒ–çš„ã€ç±»ä¼¼ä»£ç çš„æŒ‡é’ˆã€‚

è¯¥åº“çš„æ ¸å¿ƒæ˜¯å…¨å±€çš„ `L` å¯¹è±¡ï¼ˆâ€œLocationâ€æˆ–â€œLexiconâ€çš„ç¼©å†™ï¼‰ã€‚æ‚¨ä¸å†éœ€è¦è¿™æ ·å†™ï¼š
```python
# å®¹æ˜“æ‹¼å†™é”™è¯¯ï¼Œéš¾ä»¥é‡æ„ï¼Œæ²¡æœ‰è‡ªåŠ¨è¡¥å…¨
get_message("error.login.invalid_password")
```
è€Œæ˜¯è¿™æ ·å†™ï¼š
```python
# æµç•…ï¼Œå¯è‡ªåŠ¨è¡¥å…¨ï¼Œæ˜“äºé‡æ„ï¼Œç±»å‹å®‰å…¨
nexus.get(L.error.login.invalid_password)
```

## æ ¸å¿ƒæ¦‚å¿µ

PyNeedle çš„æ¶æ„éå¸¸ç®€å•ï¼Œç”±ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ç»„æˆï¼š

1.  **è¯­ä¹‰æŒ‡é’ˆ (`L`)**: ä¸€ä¸ªä¸å¯å˜å¯¹è±¡ï¼Œä»£è¡¨é€»è¾‘â€œè¯­ä¹‰å®‡å®™â€ä¸­çš„ä¸€ä¸ªè·¯å¾„ã€‚å®ƒé€šè¿‡å±æ€§è®¿é—®ï¼ˆ`L.auth.login`ï¼‰æˆ–ç±»è·¯å¾„è¿æ¥ï¼ˆ`L.auth / "login"`ï¼‰çš„æ–¹å¼æµç•…åœ°åˆ›å»ºã€‚å®ƒå……å½“æ‰€æœ‰èµ„æºçš„é€šç”¨å¯†é’¥ã€‚

2.  **èµ„æºåŠ è½½å™¨ (Resource Loader)**: ä¸€ä¸ªè´Ÿè´£ä»æ•°æ®æºåŠ è½½æ•°æ®çš„ç»„ä»¶ã€‚PyNeedle å†…ç½®äº†ä¸€ä¸ªç”¨äºåœ¨é¡¹ç›®ä¸­å‘ç° `.json` æ–‡ä»¶çš„ `FileSystemLoader`ï¼Œä»¥åŠä¸€ä¸ªç”¨äºæµ‹è¯•æˆ–åŠ¨æ€æ•°æ®çš„ `MemoryLoader`ã€‚å…¶æ¥å£åè®®éå¸¸ç®€å•ï¼Œå› æ­¤æ‚¨å¯ä»¥è½»æ¾åœ°ä¸ºæ•°æ®åº“ã€API ç­‰ç¼–å†™è‡ªå·±çš„åŠ è½½å™¨ã€‚

3.  **Nexus**: ä¸­å¤®è¿è¡Œæ—¶æ¢çº½ã€‚Nexus æ¥æ”¶ä¸€ä¸ªåŠ è½½å™¨åˆ—è¡¨ï¼Œå¹¶å°†è¯­ä¹‰æŒ‡é’ˆè§£æä¸ºå…¶æœ€ç»ˆçš„å­—ç¬¦ä¸²å€¼ã€‚å®ƒèƒ½æ™ºèƒ½åœ°å¤„ç†è¯­è¨€å›é€€å’Œèµ„æºè¦†ç›–ï¼Œå…è®¸æ‚¨ä»¥æ¸…æ™°çš„ä¼˜å…ˆçº§é¡ºåºåˆå¹¶æ¥è‡ªå¤šä¸ªæ¥æºçš„èµ„æºã€‚

`pyneedle` åŒ…æä¾›äº†ä¸€ä¸ªâ€œå¼€ç®±å³ç”¨â€çš„å…¨å±€ `nexus` å®ä¾‹ï¼Œå®ƒå·²é¢„å…ˆé…ç½®äº†ä¸€ä¸ª `FileSystemLoader`ï¼Œä½¿å¾—ä¸Šæ‰‹å˜å¾—æå…¶ç®€å•ã€‚

## ä¸»è¦ç‰¹æ€§

-   **âœ¨ æµç•…ä¸”å¯Œæœ‰è¡¨ç°åŠ›çš„ APIï¼š** ä½¿ç”¨ `L.user.profile.title` è‡ªç„¶åœ°åˆ›å»ºæŒ‡é’ˆã€‚
-   **â• æŒ‡é’ˆä»£æ•°ï¼š** å¯¹æŒ‡é’ˆå’ŒæŒ‡é’ˆé›†æ‰§è¡Œå¼ºå¤§çš„æ“ä½œï¼Œå¦‚åˆ†å¸ƒ (`L.user * {"name", "age"}`) å’Œè¿æ¥ (`{L.a, L.b} / "end"`)ã€‚
-   **ğŸŒ å†…ç½®å›½é™…åŒ– (I18n)ï¼š** Nexus å¯¹è¯­è¨€è§£æã€ç¯å¢ƒå˜é‡æ£€æµ‹ (`NEEDLE_LANG`) å’Œä¼˜é›…å›é€€æä¾›äº†ä¸€æµçš„æ”¯æŒã€‚
-   **ğŸ“š åˆ†å±‚é…ç½®ï¼š** `OverlayNexus` ä½¿ç”¨ `ChainMap` ç­–ç•¥æ¥é€»è¾‘ä¸Šè¦†ç›–èµ„æºæ–‡ä»¶ã€‚ä¸€ä¸ª `project/.stitcher/needle/en/override.json` æ–‡ä»¶å¯ä»¥è½»æ¾è¦†ç›–æ¥è‡ª `library/needle/en/defaults.json` çš„å€¼ï¼Œè€Œæ— éœ€ç‰©ç†åˆå¹¶æ–‡ä»¶ã€‚
-   **ğŸ”Œ å¯æ‰©å±•ï¼š** è½»æ¾æ·»åŠ è‡ªå®šä¹‰çš„ `ResourceLoaderProtocol` å®ç°ï¼Œä»¥ä»ä»»ä½•æ•°æ®æºè·å–æ•°æ®ã€‚
-   **ğŸ“¦ è§£è€¦çš„æ¶æ„ï¼š** é¡¹ç›®è¢«æ‹†åˆ†ä¸ºé€»è¾‘æ¸…æ™°çš„åŒ…ï¼ˆ`pyneedle-spec`, `pyneedle-pointer`, `pyneedle-nexus`, `pyneedle-runtime`ï¼‰ï¼Œä¿ƒè¿›äº†æ•´æ´çš„è®¾è®¡å’Œå¯ç»´æŠ¤æ€§ã€‚
-   **ğŸ”’ ç±»å‹å®‰å…¨ï¼š** å½“ä¸å®ƒçš„é…å¥—å·¥å…· **Stitcher** ä¸€èµ·ä½¿ç”¨æ—¶ï¼ŒPyNeedle èƒ½ä¸ºæ‚¨æ‰€æœ‰çš„èµ„æºå¯ç”¨å®Œæ•´çš„é™æ€åˆ†æå’Œè‡ªåŠ¨è¡¥å…¨ã€‚

## å¿«é€Ÿå…¥é—¨

è¿™ä¸ªä¾‹å­æ¼”ç¤ºäº†ä½¿ç”¨å†…å­˜åŠ è½½å™¨çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

```python
from needle import L, nexus
from needle.nexus import OverlayNexus, MemoryLoader

# 1. ä¸ºä¸åŒè¯­è¨€å®šä¹‰ä¸€äº›èµ„æºæ•°æ®
resource_data = {
    "en": {
        "app.title": "My Awesome App",
        "user.greeting": "Welcome, {name}!",
    },
    "zh": {
        "app.title": "æˆ‘çš„è¶…æ£’åº”ç”¨",
    },
}

# 2. ç”¨è¿™äº›æ•°æ®åˆ›å»ºä¸€ä¸ªåŠ è½½å™¨
memory_loader = MemoryLoader(data=resource_data)

# 3. ç”¨è¯¥åŠ è½½å™¨åˆ›å»ºä¸€ä¸ª Nexus å®ä¾‹
#    (åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ‚¨å¯èƒ½ç›´æ¥ä½¿ç”¨å…¨å±€çš„ 'nexus' å®ä¾‹)
local_nexus = OverlayNexus(loaders=[memory_loader], default_lang="en")

# 4. å°†æŒ‡é’ˆè§£æä¸ºå­—ç¬¦ä¸²
# --- ä½¿ç”¨é»˜è®¤è¯­è¨€ (en) è§£æ ---
title_en = local_nexus.get(L.app.title)
print(f"è‹±æ–‡æ ‡é¢˜: {title_en}")
# è¾“å‡º: è‹±æ–‡æ ‡é¢˜: My Awesome App

# --- æ˜¾å¼è¯·æ±‚ä¸€ä¸ªå­˜åœ¨çš„è¯­è¨€ ---
title_zh = local_nexus.get(L.app.title, lang="zh")
print(f"ä¸­æ–‡æ ‡é¢˜: {title_zh}")
# è¾“å‡º: ä¸­æ–‡æ ‡é¢˜: æˆ‘çš„è¶…æ£’åº”ç”¨

# --- è¯·æ±‚ä¸€ä¸ªä¼šå›é€€åˆ°é»˜è®¤è¯­è¨€çš„é”® ---
# 'user.greeting' åœ¨ 'zh' ä¸­ä¸å­˜åœ¨ï¼Œå› æ­¤å®ƒä¼šå›é€€åˆ° 'en'
greeting_fallback = local_nexus.get(L.user.greeting, lang="zh")
print(f"å›é€€çš„é—®å€™è¯­: {greeting_fallback}")
# è¾“å‡º: å›é€€çš„é—®å€™è¯­: Welcome, {name}!

# --- è¯·æ±‚ä¸€ä¸ªåœ¨ä»»ä½•åœ°æ–¹éƒ½ä¸å­˜åœ¨çš„é”® ---
# å®ƒä¼šä¼˜é›…åœ°å›é€€åˆ°å…¶è‡ªèº«çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼ˆæ ‡è¯†å›é€€ï¼‰
non_existent = local_nexus.get(L.app.non_existent_key)
print(f"ä¸å­˜åœ¨çš„é”®: {non_existent}")
# è¾“å‡º: ä¸å­˜åœ¨çš„é”®: app.non_existent_key
```

## é«˜çº§ç”¨æ³•

### æŒ‡é’ˆä»£æ•°

åˆ›å»ºæŒ‡é’ˆé›†åˆä»¥è¿›è¡Œå¼ºå¤§ä¸”å¯Œæœ‰è¡¨ç°åŠ›çš„æ“ä½œã€‚PyNeedle æ”¯æŒæµç•…çš„å¹¿æ’­å’Œå¤šé‡ç´¢å¼•ã€‚

```python
from needle import L

# 1. å¤šé‡ç´¢å¼•å¿«æ·æ–¹å¼
# è½»æ¾åˆ›å»ºä¸€ä¸ªæŒ‡é’ˆé›†åˆ (PointerSet)
user_fields = L.user['name', 'email']
# ç»“æœ: PointerSet({L.user.name, L.user.email})

# 2. å±æ€§ä¸ç´¢å¼•å¹¿æ’­
# åœ¨æ•´ä¸ªé›†åˆä¸Šæµç•…åœ°å¹¿æ’­åç¼€æˆ–ç´¢å¼•
form_labels = user_fields.label
# ç»“æœ: PointerSet({L.user.name.label, L.user.email.label})

# 3. ç¬›å¡å°”ç§¯æ‰©å±•
# ä½¿ç”¨ä¹˜æ³•å°†å•ä¸ªæŒ‡é’ˆæ‰©å±•ä¸ºé›†åˆ
actions = {"read", "write"}
permissions = L.auth.user * actions
# ç»“æœ: PointerSet({L.auth.user.read, L.auth.user.write})

# 4. é«˜çº§é“¾å¼è°ƒç”¨
# ç»„åˆæ‰€æœ‰ç‰¹æ€§ï¼Œå®ç°å¼ºå¤§çš„èµ„æºå¯»å€
errors = L.api['v1', 'v2'][404].message
# ç»“æœ: PointerSet({L.api.v1[404].message, L.api.v2[404].message})
```

### åŸºäºæ–‡ä»¶çš„åŠ è½½

é»˜è®¤çš„å…¨å±€ `nexus` å®ä¾‹ä½¿ç”¨ `FileSystemLoader`ã€‚åªéœ€åœ¨æ‚¨çš„é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä»¥ä¸‹ç›®å½•ç»“æ„ï¼š

```
my_project/
â”œâ”€â”€ needle/
â”‚   â”œâ”€â”€ en/
â”‚   â”‚   â””â”€â”€ main.json
â”‚   â””â”€â”€ zh/
â”‚       â””â”€â”€ main.json
â”œâ”€â”€ pyproject.toml
â””â”€â”€ src/
    â””â”€â”€ ...
```

**`needle/en/main.json`:**
```json
{
    "app.title": "ä»æ–‡ä»¶åŠ è½½çš„åº”ç”¨"
}
```

ç°åœ¨ï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºä»£ç å°†å˜å¾—æå…¶ç®€å•ï¼š

```python
# src/my_project/main.py
from needle import L, nexus

def main():
    # å…¨å±€ nexus ä¼šè‡ªåŠ¨æŸ¥æ‰¾å¹¶åŠ è½½è¿™äº›æ–‡ä»¶
    print(nexus.get(L.app.title))

# è¾“å‡º: ä»æ–‡ä»¶åŠ è½½çš„åº”ç”¨
```

## å®‰è£…

é€šè¿‡ PyPI å®‰è£…ï¼š
```bash
pip install pyneedle
```
