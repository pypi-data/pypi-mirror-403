name: Release

on:
    workflow_dispatch:
        inputs:
            release-type:
                description: "What kind of release is this?"
                type: choice
                options:
                    - alpha
                    - rc
                    - final
                required: true

concurrency:
    group: ${{ github.ref_name }}
    cancel-in-progress: true

defaults:
    run:
        shell: bash --noprofile --norc -euo pipefail {0}

# wants to push commits and create a PR
permissions:
    contents: write
    pull-requests: write

jobs:
    version:
        name: Versioning
        runs-on: ubuntu-latest
        outputs:
            previous: ${{ steps.versioning.outputs.previous }}
            current: ${{ steps.versioning.outputs.current }}
            pep440_version: ${{ steps.versioning.outputs.pep440_version }}
            final: ${{ steps.versioning.outputs.final }}
            py_wheel_version: ${{ steps.versioning.outputs.py_wheel_version }}
            version_bump_commit_sha: ${{ steps.commit.outputs.commit_sha }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Python & uv
              uses: ./.github/actions/setup-python-uv

            - name: Setup Node.js & pnpm
              uses: ./.github/actions/setup-nodejs-pnpm

            - name: Get and validate version
              id: versioning
              run: |
                  # Extract the target final version from branch name (e.g., prepare-release-0.1.0-alpha.1 -> 0.1.0)
                  release_version_output=$(uv run python scripts/ci/version.py get-version --from git --finalize)
                  echo "$release_version_output"
                  release_version=$(echo "$release_version_output" | grep "Release version:" | cut -d' ' -f3)
                  echo "Target release version from branch: $release_version"

                  # Get current version from file (finalized)
                  current_finalized_output=$(uv run python scripts/ci/version.py get-version --from file --finalize)
                  current_finalized=$(echo "$current_finalized_output" | grep "Release version:" | cut -d' ' -f3)
                  echo "Current finalized version from file: $current_finalized"

                  # If current finalized version doesn't match target, update to target
                  if [ "$current_finalized" != "$release_version" ]; then
                      echo "Updating version to $release_version"
                      uv run python scripts/ci/version.py version --exact $release_version
                  fi

                  # Handle release type specific versioning
                  if [ "${{ inputs.release-type }}" = "alpha" ]; then
                      echo "Bumping alpha version"
                      uv run python scripts/ci/version.py version --bump prerelease --pre-id=alpha
                  elif [ "${{ inputs.release-type }}" = "rc" ]; then
                      echo "Bumping RC version"
                      uv run python scripts/ci/version.py version --bump prerelease --pre-id=rc
                  elif [ "${{ inputs.release-type }}" = "final" ]; then
                      echo "Setting final version"
                      uv run python scripts/ci/version.py version --exact $release_version
                  fi

                  # Get the final version after all updates
                  final_output=$(uv run python scripts/ci/version.py get-version --from file)
                  echo "$final_output"
                  version=$(echo "$final_output" | grep "Release version:" | cut -d' ' -f3)
                  pep440_version=$(echo "$final_output" | grep "PEP 440 version:" | cut -d' ' -f4)

                  # Store previous version for re-entrancy check
                  echo "previous=$current_finalized" >> $GITHUB_OUTPUT
                  echo "current=$version" >> $GITHUB_OUTPUT
                  echo "pep440_version=$pep440_version" >> $GITHUB_OUTPUT
                  echo "final=$release_version" >> $GITHUB_OUTPUT

                  # For wheel versioning
                  py_wheel_version=$(echo "$pep440_version" | tr -d '-')
                  echo "py_wheel_version=$py_wheel_version" >> $GITHUB_OUTPUT

            - name: Update Rerun versions
              uses: ./.github/actions/update-rerun-versions
              with:
                  version: ${{ steps.versioning.outputs.current }}
                  pep440_version: ${{ steps.versioning.outputs.pep440_version }}

            - name: Update package versions
              uses: ./.github/actions/update-package-versions
              with:
                  version: ${{ steps.versioning.outputs.current }}

            - name: Commit version changes
              id: commit
              uses: ./.github/actions/commit-and-push
              with:
                  commit_message: "Bump versions to ${{ steps.versioning.outputs.current }}"

    create-pr:
        name: Create Release PR
        needs: version
        permissions:
            contents: read
            pull-requests: write
        runs-on: ubuntu-latest
        outputs:
            pr_number: ${{ steps.create-pr.outputs.pr_number }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.version.outputs.version_bump_commit_sha }}

            - name: Create Pull Request
              id: create-pr
              env:
                  GH_TOKEN: ${{ secrets.RERUN_BOT_TOKEN }}
              run: |
                  version="${{ needs.version.outputs.current }}"

                  pr_output=$(gh pr create \
                      --base main \
                      --head ${{ github.ref_name }} \
                      --title "Release $version" \
                      --body "Release version $version")

                  pr_number=$(echo "$pr_output" | sed -n 's#.*/pull/\([0-9]\+\).*#\1#p' | tail -n 1)

                  if [ -z "$pr_number" ]; then
                      echo "Failed to determine PR number from output:"
                      echo "$pr_output"
                      exit 1
                  fi

                  echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"
                  echo "Created PR #$pr_number for release $version"

    py-lints:
        name: Python Lints (ruff, mypy, …)
        needs: version
        permissions:
            contents: read
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Python & uv
              uses: ./.github/actions/setup-python-uv

            - name: Lint Python
              run: uv run ruff check

            - name: Typecheck Python
              run: uv run mypy backend demo --exclude-gitignore

            - name: Format Python
              run: uv run ruff format --check

    frontend-lints:
        name: Frontend Lints (eslint, prettier, …)
        needs: version
        permissions:
            contents: read
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js & pnpm
              uses: ./.github/actions/setup-nodejs-pnpm

            - name: Lint frontend
              working-directory: "./frontend"
              run: pnpm lint

            - name: Format frontend
              working-directory: "./frontend"
              run: pnpm format-check

    build-publish:
        name: Build & Publish
        needs:
            - version
            - py-lints
            - frontend-lints
        permissions:
            id-token: write
            contents: read
        uses: ./.github/workflows/reusable_build_publish.yml
        with:
            VERSION_BUMP_COMMIT_SHA: ${{ needs.version.outputs.version_bump_commit_sha }}
            VERSION: ${{ needs.version.outputs.current }}
            PEP440_VERSION: ${{ needs.version.outputs.pep440_version }}

        secrets: inherit

    github-release:
        name: Create GitHub Release
        needs:
            - version
            - build-publish
        runs-on: ubuntu-latest
        outputs:
            release_tag: ${{ steps.create-release.outputs.release_tag }}
        # Only create GitHub releases for RC and final releases, not alpha
        if: inputs.release-type == 'rc' || inputs.release-type == 'final'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.version.outputs.version_bump_commit_sha }}

            - name: Create GitHub Release
              id: create-release
              env:
                  GH_TOKEN: ${{ secrets.RERUN_BOT_TOKEN }}
              run: |
                  version="${{ needs.version.outputs.current }}"
                  final_version="${{ needs.version.outputs.final }}"
                  release_type="${{ inputs.release-type }}"

                  # Determine release parameters
                  if [ "$release_type" = "rc" ]; then
                      # RC releases are marked as prerelease
                      prerelease_flag="--prerelease"
                      title="Release Candidate $version"
                      tag="$version"
                  else
                      # Final releases are not marked as prerelease
                      prerelease_flag=""
                      title="Release $final_version"
                      tag="$final_version"
                  fi

                  # Create draft release
                  gh release create "$tag" \
                      --title "$title" \
                      --draft \
                      $prerelease_flag \
                      --target ${{ needs.version.outputs.version_bump_commit_sha }} \
                      --notes "Release $version"

                  echo "release_tag=$tag" >> "$GITHUB_OUTPUT"
                  echo "Created draft release for $tag"

    comment-on-pr:
        name: Comment on Release PR
        needs:
            - version
            - create-pr
            - github-release
        permissions:
            contents: read
            pull-requests: write
        runs-on: ubuntu-latest
        # Only comment for RC and final releases (when GitHub release is created)
        if: inputs.release-type == 'rc' || inputs.release-type == 'final'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Post comment to PR
              env:
                  GH_TOKEN: ${{ secrets.RERUN_BOT_TOKEN }}
              run: |
                  pr_number="${{ needs.create-pr.outputs.pr_number }}"
                  version="${{ needs.version.outputs.current }}"
                  release_type="${{ inputs.release-type }}"
                  release_tag="${{ needs.github-release.outputs.release_tag }}"
                  repo="${{ github.repository }}"

                  # Format release type for display
                  if [ "$release_type" = "rc" ]; then
                      release_type_display="Release Candidate"
                  else
                      release_type_display="Final Release"
                  fi

                  # Create release URL
                  release_url="https://github.com/$repo/releases/tag/$release_tag"

                  # Post comment to PR
                  gh pr comment "$pr_number" --body "## Release Draft Created

                  **Version:** $version
                  **Type:** $release_type_display

                  [$release_tag]($release_url)
                  Review the release notes, verify the release assets, and publish the release when ready.

                  Once published, this PR can be merged."

                  echo "Posted comment to PR #$pr_number with release draft link"

    bump-next-version:
        name: Bump to Next Alpha Version
        needs:
            - version
            - comment-on-pr
        runs-on: ubuntu-latest
        # Only bump to next version for final releases
        if: inputs.release-type == 'final'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.ref_name }}
                  fetch-depth: 0

            - name: Setup Python & uv
              uses: ./.github/actions/setup-python-uv

            - name: Setup Node.js & pnpm
              uses: ./.github/actions/setup-nodejs-pnpm

            - name: Bump to next alpha version
              id: bump-version
              run: |
                  # Get latest changes
                  git pull

                  # Current version is the final version (e.g., 0.27.0)
                  current_version="${{ needs.version.outputs.final }}"

                  # Bump minor version (0.27.0 -> 0.28.0)
                  uv run python scripts/ci/version.py version --bump minor

                  # Add alpha.1 prerelease (0.28.0 -> 0.28.0-alpha.1)
                  uv run python scripts/ci/version.py version --bump prerelease --pre-id=alpha

                  # Get the new version
                  new_version_output=$(uv run python scripts/ci/version.py get-version --from file)
                  new_version=$(echo "$new_version_output" | grep "Release version:" | cut -d' ' -f3)

                  echo "Bumped from $current_version to $new_version"
                  echo "new_version=$new_version" >> $GITHUB_OUTPUT

            - name: Update package versions
              uses: ./.github/actions/update-package-versions
              with:
                  version: ${{ steps.bump-version.outputs.new_version }}

            - name: Bump version commit
              uses: ./.github/actions/commit-and-push
              with:
                  commit_message: "Bump versions to ${{ steps.bump-version.outputs.new_version }}"
