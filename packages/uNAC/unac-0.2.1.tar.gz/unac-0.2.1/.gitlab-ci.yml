stages:
  - verify
  - test
  - release

# ---------------------------
# Lint / checks (optional)
# ---------------------------
pre-commit:
  stage: verify
  image: python:3.14
  before_script:
    - pip install --root-user-action=ignore --upgrade pip
    - pip install --root-user-action=ignore pre-commit
    - pre-commit install

  script:
    - pre-commit run --all

# ---------------------------
# Unit tests (matrix)
# ---------------------------
test:
  stage: test
  image: python:${PYTHON_VERSION}
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.11", "3.12", "3.13", "3.14"]
  before_script:
    - apt-get update
    - apt-get install -y r-base perl
    - pip install --root-user-action=ignore --upgrade pip
    - pip install --root-user-action=ignore -e .[test]
  script:
    - pytest -m "not isocorrector and not ict and not isocor"

# ---------------------------
# Integration test and coverage collection
# ---------------------------
integration_test:
  stage: test
  image: python:3.14
  variables:
    R_LIBS_USER: "$CI_PROJECT_DIR/.r_libs"
  cache:
    key: r-libs
    policy: pull-push
    paths:
      - .r_libs/
  before_script:
    - apt-get update
    - apt-get install -y r-base perl
    - pip install --root-user-action=ignore --upgrade pip
    - pip install --root-user-action=ignore -e .[isocor,isocorrector,test]
    - mkdir -p "$R_LIBS_USER"
    - uNAC-setup
  script:
    - uNAC -t
    - pytest --cov=unac --cov-report=term-missing
  coverage: /TOTAL.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/

# ---------------------------
# Build artifacts (only on tag)
# ---------------------------
build_dist:
  stage: test
  image: python:3.14
  rules:
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - when: never
  before_script:
    - pip install --upgrade pip
    - pip install build
  script:
    - python -m build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week


# ---------------------------
# Publish to TestPyPI (on tag)
# ---------------------------
publish_testpypi:
  stage: release
  image: python:3.14
  needs: ["build_dist"]
  rules:
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - when: never
  before_script:
    - pip install --upgrade pip
    - pip install build twine
  script:
    - twine upload --repository testpypi dist/*
  variables:
    TWINE_USERNAME: $TEST_PYPI_USERNAME
    TWINE_PASSWORD: $TEST_PYPI_PASSWORD

# ---------------------------
# Optional: smoke test from TestPyPI
# ---------------------------
smoke_test_testpypi:
  stage: release
  image: python:3.14
  needs: ["publish_testpypi"]
  rules:
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - when: never
  script:
    - pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple unac
    - uNAC --help


# ---------------------------
# Publish to real PyPI (on tag)
# ---------------------------
publish_pypi:
  stage: release
  image: python:3.14
  needs: ["build_dist", "smoke_test_testpypi"]
  rules:
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - when: never
  before_script:
    - pip install --upgrade pip
    - pip install build twine
  script:
    - twine upload dist/*
  variables:
    TWINE_USERNAME: $PYPI_USERNAME
    TWINE_PASSWORD: $PYPI_PASSWORD
