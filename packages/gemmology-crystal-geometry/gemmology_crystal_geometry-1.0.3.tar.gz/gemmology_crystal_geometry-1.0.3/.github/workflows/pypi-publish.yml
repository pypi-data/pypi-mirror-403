# Publish to PyPI on release with native C++ wheels
# Uses cibuildwheel for cross-platform wheel building

name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual triggering for testing

jobs:
  # Build wheels for each platform
  build-wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        # macos-latest = Apple Silicon (arm64), Intel wheels via pure Python fallback

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install cibuildwheel
        run: pip install cibuildwheel==2.21.3

      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        env:
          # Build for Python 3.10, 3.11, 3.12, 3.13
          CIBW_BUILD: "cp310-* cp311-* cp312-* cp313-*"
          # Skip musllinux (Alpine) and PyPy
          CIBW_SKIP: "*-musllinux* pp*"
          # Install Eigen before building (detect package manager)
          CIBW_BEFORE_ALL_LINUX: |
            if command -v yum &> /dev/null; then
              yum install -y eigen3-devel
            elif command -v apt-get &> /dev/null; then
              apt-get update && apt-get install -y libeigen3-dev
            fi
          CIBW_BEFORE_ALL_MACOS: |
            brew install eigen
          CIBW_BEFORE_ALL_WINDOWS: |
            choco install eigen -y
          # Set CMAKE_PREFIX_PATH for Eigen on Windows
          CIBW_ENVIRONMENT_WINDOWS: >
            CMAKE_PREFIX_PATH="C:\\ProgramData\\chocolatey\\lib\\eigen\\share\\eigen3\\cmake"
          # Install cdl-parser dependency before building
          CIBW_BEFORE_BUILD: >
            pip install "gemmology-cdl-parser @ git+https://github.com/gemmology-dev/cdl-parser.git"
          # Skip wheel test - cdl-parser dependency not available in cibuildwheel test env
          # CIBW_TEST_COMMAND: python -c "from crystal_geometry import get_backend; print(f'Backend: {get_backend()}')"
          # Repair wheels (bundle libraries)
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: "auditwheel repair -w {dest_dir} {wheel}"
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: "delocate-wheel -w {dest_dir} {wheel}"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: wheelhouse/*.whl

  # Build source distribution
  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: pip install build

      - name: Build sdist
        run: python -m build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  # Publish to PyPI
  publish:
    name: Publish to PyPI
    needs: [build-wheels, build-sdist]
    if: always() && needs.build-sdist.result == 'success'
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write   # For trusted publishing
      contents: write   # For uploading release assets

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: List distribution files
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
        # Uses trusted publishing - no token needed if configured
        # Fallback to token-based auth:
        # with:
        #   password: ${{ secrets.PYPI_TOKEN }}

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} dist/* --clobber

  # Note: Pure Python fallback removed - scikit-build-core always builds native
  # Users on unsupported platforms can install from source dist
