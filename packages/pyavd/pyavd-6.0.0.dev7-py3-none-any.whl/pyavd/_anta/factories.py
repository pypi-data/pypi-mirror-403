# Copyright (c) 2023-2026 Arista Networks, Inc.
# Use of this source code is governed by the Apache License 2.0
# that can be found in the LICENSE file.
"""Factory functions used by PyAVD for ANTA."""

from __future__ import annotations

from itertools import chain
from typing import TYPE_CHECKING

from anta.catalog import AntaCatalog, AntaTestDefinition
from anta.models import AntaTest

if TYPE_CHECKING:
    from collections.abc import Iterator

    from pyavd.api._anta import AvdTestSpec

    from .models import InputFactoryDataSource


def create_catalog(data_source: InputFactoryDataSource, test_specs: list[AvdTestSpec]) -> AntaCatalog:
    """Create an ANTA catalog for a device from the provided test specs."""
    all_test_defs_iterator = chain.from_iterable(create_test_definitions(test_spec, data_source) for test_spec in test_specs)

    tests = [update_test_definition_metadata(test_def, data_source.hostname) for test_def in all_test_defs_iterator]

    # Sort by module and test name for consistent output
    tests.sort(key=lambda x: (x.test.__module__, x.test.name))

    return AntaCatalog(tests=tests)


def create_test_definitions(test_spec: AvdTestSpec, data_source: InputFactoryDataSource) -> Iterator[AntaTestDefinition]:
    """Generate the AntaTestDefinition from this AvdTestSpec instance."""
    # Generate the test definitions from the input factory if provided
    if test_spec.input_factory is not None:
        factory = test_spec.input_factory(data_source, test_spec.test_class.name)
        for inputs in factory.create():
            yield AntaTestDefinition(test=test_spec.test_class, inputs=inputs)
        return

    # Otherwise AntaTestDefinition takes `inputs=None` if the test does not require any inputs
    yield AntaTestDefinition(test=test_spec.test_class, inputs=None)


def update_test_definition_metadata(test_definition: AntaTestDefinition, hostname: str) -> AntaTestDefinition:
    """Tag the test definition with the device name for the final catalog and add metadata."""
    # Tag the test with the device name
    test_definition.inputs.filters = AntaTest.Input.Filters(tags={hostname})

    # Ensure result_overwrite is initialized or updated
    if test_definition.inputs.result_overwrite is None:
        test_definition.inputs.result_overwrite = AntaTest.Input.ResultOverwrite(custom_field="Generated by AVD")
    else:
        test_definition.inputs.result_overwrite.custom_field = "Generated by AVD"

    return test_definition
