version = 1

[env]
REPO_URL = "https://github.com/idaholab/Malcolm"
REPO_BRANCH = "main"

ARKIME_ALLOW_WISE_GUI_CONFIG = "false"
ARKIME_EXPOSE_WISE_GUI = "true"
ARKIME_WISE_SERVICE_URL = "http://arkime:8081"
AUTO_ARKIME = "true"
AUTO_FREQ = "true"
AUTO_OUI = "true"
AUTO_SURICATA = "true"
AUTO_ZEEK = "true"
DARK_MODE = "true"
DASHBOARDS_URL = "http://dashboards:5601/dashboards"
DEFAULT_PATHS = ""
DELETE_INDEX_THRESHOLD = "10T"
DELETE_OLD_PCAP = "false"
DELETE_PCAP_THRESHOLD = "1%"
EXTRA = ""
EXTRA_TAGS = ""
EXTRACTED_FILE_MAX_SIZE_THRESHOLD = "1T"
EXTRACTED_FILE_SERVER = "true"
EXTRACTED_FILE_SERVER_PASSWORD = "infected"
EXTRACTED_FILE_SERVER_ZIP = "true"
EXTRACTED_FILE_TOTAL_DISK_USAGE_PERCENT_THRESHOLD = "100"
FILE_EXTRACTION = "interesting"
FILE_PRESERVATION = "quarantined"
FILE_SCAN_RULE_UPDATE = "false"
FILEBEAT_TCP_EXPOSE = "false"
FILESCAN_PATH = ""
HTTPS = "true"
IMAGE_FILE = ""
INDEX_MANAGEMENT_ENABLE = "false"
INDEX_MANAGEMENT_HOT_WARM_ENABLE = "false"
INDEX_MANAGEMENT_OPTIMIZATION_TIME_PERIOD = ""
INDEX_MANAGEMENT_REPLICAS = "0"
INDEX_MANAGEMENT_SEGMENTS = "1"
INDEX_MANAGEMENT_SPI_DATA_RETENTION = ""
INDEX_MANAGEMENT_WEEKS_OF_HISTORY = "13"
LIVE_CAPTURE_ARKIME = "false"
LIVE_CAPTURE_ARKIME_COMPRESSION = "none"
LIVE_CAPTURE_ARKIME_COMPRESSION_LEVEL = "0"
LIVE_CAPTURE_ARKIME_NODE_HOST = ""
LIVE_CAPTURE_FILTER = ""
LIVE_CAPTURE_IFACE = "primary"
LIVE_CAPTURE_IFACE_TWEAK = "false"
LIVE_CAPTURE_NETSNIFF = "false"
LIVE_CAPTURE_SURICATA = "false"
LIVE_CAPTURE_TCPDUMP = "false"
LIVE_CAPTURE_ZEEK = "false"
LOGSTASH_EXPOSE = "false"
LOGSTASH_HOST = "logstash:5044"
LOGSTASH_MEMORY = ""
LOGSTASH_WORKERS = "2"
MALCOLM_CONTAINER_RUNTIME = "docker"
MALCOLM_PROFILE = "malcolm"
NETBOX = "local"
NETBOX_AUTO_POPULATE_SUBNETS = "10.0.0.0/8,!10.100.0.0/16"
NETBOX_AUTO_PREFIXES = "true"
NETBOX_AUTOPOPULATE = "true"
NETBOX_ENRICH = "true"
NETBOX_SITE_NAME = "Malcolm"
NETBOX_URL = ""
NETWORK_NAME = ""
NGINX_RESOLVER_IPV4 = "true"
NGINX_RESOLVER_IPV6 = "false"
NODE_NAME = "Malcolm"
OPENSEARCH = "opensearch-local"
OPENSEARCH_EXPOSE = "false"
OPENSEARCH_MEMORY = ""
OPENSEARCH_PATH = ""
OPENSEARCH_SECONDARY = "<MALCOLM_CONFIG_NONE>"
OPENSEARCH_SECONDARY_SSL_VERIFY = "false"
OPENSEARCH_SECONDARY_URL = ""
OPENSEARCH_SNAPSHOT_PATH = ""
OPENSEARCH_SSL_VERIFY = "false"
OPENSEARCH_URL = "https://opensearch:9200"
ORCH_MODE = ""
PCAP_PATH = ""
PGID = ""
PIPELINE_ENABLED = "true"
PIPELINE_WORKERS = "1"
PUID = ""
RESTART_MALCOLM = "unless-stopped"
REVERSE_DNS = "false"
REVERSE_PROXIED = "false"
RUNTIME = "docker"
SFTP_EXPOSE = "false"
SURICATA_PATH = ""
SURICATA_RULE_UPDATE = "false"
SYSLOG_PORT_TCP = "0"
SYSLOG_PORT_UDP = "0"
TRAEFIK_ENTRYPOINT = ""
TRAEFIK_HOST = ""
TRAEFIK_HOST_TRAEFIK_RESOLVER = ""
VERBOSE = "false"
ZEEK_ICS = "true"
ZEEK_ICS_BEST_GUESS = "true"
ZEEK_INTEL = ""
ZEEK_INTEL_CRON_EXPRESSION = ""
ZEEK_INTEL_FEED_SINCE = "24 hours ago"
ZEEK_INTEL_ITEM_EXPIRATION = "1min"
ZEEK_INTEL_ON_STARTUP = ""
ZEEK_PATH = ""


[[steps]]
[steps.shell]
script = '''
echo "Setting up Malcolm..."

pushd "$HOME"
touch "$HOME"/.hushlogin
mkdir -p "$HOME"/.local/bin "$HOME"/.config/procps "$HOME"/.config/systemd/user

[[ ! -d ./Malcolm ]] && git clone --depth=1 --single-branch --recurse-submodules --shallow-submodules -b "$REPO_BRANCH" "$REPO_URL" Malcolm

rm -f "$HOME"/.bashrc \
      "$HOME"/.bash_aliases \
      "$HOME"/.bash_functions \
      "$HOME"/.config/procps/toprc \
      "$HOME"/.selected_editor \
      "$HOME"/.tmux.conf \
      "$HOME"/.vimrc
ln -s -r -f "$HOME"/Malcolm/malcolm-iso/config/includes.chroot/etc/bash.bash_aliases "$HOME"/.bash_aliases
ln -s -r -f "$HOME"/Malcolm/malcolm-iso/config/includes.chroot/etc/bash.bash_functions "$HOME"/.bash_functions
ln -s -r -f "$HOME"/Malcolm/malcolm-iso/config/includes.chroot/etc/skel/.bashrc "$HOME"/.bashrc
ln -s -r -f "$HOME"/Malcolm/malcolm-iso/config/includes.chroot/etc/skel/.config/procps/toprc "$HOME"/.config/procps/toprc
ln -s -r -f "$HOME"/Malcolm/malcolm-iso/config/includes.chroot/etc/skel/.selected_editor "$HOME"/.selected_editor
ln -s -r -f "$HOME"/Malcolm/malcolm-iso/config/includes.chroot/etc/skel/.tmux.conf "$HOME"/.tmux.conf
ln -s -r -f "$HOME"/Malcolm/malcolm-iso/config/includes.chroot/etc/skel/.vimrc "$HOME"/.vimrc
ln -s -r -f "$HOME"/Malcolm/malcolm-iso/config/includes.chroot/etc/skel/.config/systemd/user/*.service "$HOME"/.config/systemd/user/

OLD_GRUB_HASH=$(sha256sum /etc/default/grub | awk '{print $1}')

EXTRA_ARRAY=()
if [[ -n "$EXTRA" ]]; then
  readarray -td '' EXTRA_ARRAY < <(awk '{ gsub(/\|/,"\0"); print; }' <<<"$EXTRA|"); unset 'EXTRA_ARRAY[-1]';
fi
EXTRA_ARRAY+=( "nginx.env:NGINX_LOG_ACCESS_AND_ERRORS=true" )

pushd Malcolm
SETTINGS_FILE="$(mktemp --suffix=.json)"
JQ_FILE="$(mktemp --suffix=.jq)"

python3 ./scripts/install.py --verbose "${DEBUG}" --configure --defaults --non-interactive --export-malcolm-config-file "${SETTINGS_FILE}"

( [[ -n "${VERBOSE}" ]] && [[ "${VERBOSE}" != "false" ]] && [[ "${VERBOSE}" != "0" ]] ) && DEBUG=true || DEBUG=false
[[ "${RUNTIME}" == "kubernetes" ]] && ORCH_MODE=KUBERNETES || ORCH_MODE=DOCKER_COMPOSE
( [[ "${ZEEK_INTEL_ON_STARTUP:-false}" == "true" ]] || [[ -n "${ZEEK_INTEL_CRON_EXPRESSION}" ]] ) && ZEEK_INTEL=true || ZEEK_INTEL=false
( [[ -z "${OPENSEARCH_PATH}" ]] || [[ -z "${OPENSEARCH_SNAPSHOT_PATH}" ]] || [[ -z "${FILESCAN_PATH}" ]] || [[ -z "${PCAP_PATH}" ]] || [[ -z "${SURICATA_PATH}" ]] || [[ -z "${ZEEK_PATH}" ]] ) && \
  DEFAULT_PATHS=true || DEFAULT_PATHS=false

( [[ "${LIVE_CAPTURE_ARKIME}" == "true" ]] || [[ "${LIVE_CAPTURE_ZEEK}" == "true" ]] || [[ "${LIVE_CAPTURE_SURICATA}" == "true" ]] || [[ "${LIVE_CAPTURE_TCPDUMP}" == "true" ]] || [[ "${LIVE_CAPTURE_NETSNIFF}" == "true" ]] ) && \
  CAPTURE_LIVE=true || CAPTURE_LIVE=false

if [[ "${CAPTURE_LIVE}" == "true" ]]; then
    if [[ "${LIVE_CAPTURE_IFACE}" == "primary" ]]; then
        command -v ip >/dev/null 2>&1 && CAPTURE_IFACE=$(ip route get 255.255.255.255 2>/dev/null | awk '/dev/ {print $4}') || CAPTURE_IFACE='lo'
    else
        CAPTURE_IFACE="${LIVE_CAPTURE_IFACE}"
    fi
    CAPTURE_FILTER="${LIVE_CAPTURE_FILTER}"
    CAPTURE_IFACE_TWEAK=${LIVE_CAPTURE_IFACE_TWEAK:-true}
    CAPTURE_STATS=${LIVE_CAPTURE_STATS:-true}
    CAPTURE_NETSNIFF=${LIVE_CAPTURE_NETSNIFF:-true}
    CAPTURE_TCPDUMP=${LIVE_CAPTURE_TCPDUMP:-false}
    CAPTURE_ARKIME=${LIVE_CAPTURE_ARKIME:-false}
    CAPTURE_ZEEK=${LIVE_CAPTURE_ZEEK:-true}
    CAPTURE_SURICATA=${LIVE_CAPTURE_SURICATA:-true}
    CAPTURE_ARKIME_NODE_HOST="${LIVE_CAPTURE_ARKIME_NODE_HOST}"
else
  CAPTURE_IFACE=lo
  CAPTURE_FILTER=""
  CAPTURE_IFACE_TWEAK=false
  CAPTURE_STATS=false
  CAPTURE_NETSNIFF=false
  CAPTURE_TCPDUMP=false
  CAPTURE_ARKIME=false
  CAPTURE_ZEEK=false
  CAPTURE_SURICATA=false
  CAPTURE_ARKIME_NODE_HOST=
fi


tee "${JQ_FILE}" >/dev/null <<EOF
    .configuration.runtimeBin = "${MALCOLM_CONTAINER_RUNTIME:-docker}"
    | .configuration.arkimeAllowWiseConfig = ${ARKIME_ALLOW_WISE_GUI_CONFIG:-false}
    | .configuration.arkimeExposeWise = ${ARKIME_EXPOSE_WISE_GUI:-false}
    | .configuration.arkimeFreeSpaceG = "${DELETE_PCAP_THRESHOLD:-1%}"
    | .configuration.arkimeManagePCAP = ${DELETE_OLD_PCAP:-false}
    | .configuration.arkimeWiseUrl = "${ARKIME_WISE_SERVICE_URL:-http://arkime:8081}"
    | .configuration.autoArkime = ${AUTO_ARKIME:-true}
    | .configuration.autoFreq = ${AUTO_FREQ:-true}
    | .configuration.autoOui = ${AUTO_OUI:-true}
    | .configuration.autoSuricata = ${AUTO_SURICATA:-true}
    | .configuration.autoZeek = ${AUTO_ZEEK:-true}
    | .configuration.captureLiveNetworkTraffic = ${CAPTURE_LIVE:-false}
    | .configuration.captureStats = ${CAPTURE_STATS}
    | .configuration.containerNetworkName = "${NETWORK_NAME:-}"
    | .configuration.dashboardsDarkMode = ${DARK_MODE:-true}
    | .configuration.dashboardsUrl = "${DASHBOARDS_URL:-http://dashboards:5601/dashboards}"
    | .configuration.dockerOrchestrationMode = "${ORCH_MODE}"
    | .configuration.exposeFilebeatTcp = ${FILEBEAT_TCP_EXPOSE:-false}
    | .configuration.exposeLogstash = ${LOGSTASH_EXPOSE:-false}
    | .configuration.exposeOpenSearch = ${OPENSEARCH_EXPOSE:-false}
    | .configuration.exposeSFTP = ${SFTP_EXPOSE:-false}
    | .configuration.extractedFileMaxPercentThreshold = ${EXTRACTED_FILE_TOTAL_DISK_USAGE_PERCENT_THRESHOLD:-100}
    | .configuration.extractedFileMaxSizeThreshold = "${EXTRACTED_FILE_MAX_SIZE_THRESHOLD:-1T}"
    | .configuration.extraTags = "${EXTRA_TAGS:-}"
    | .configuration.filebeatTcpDefaults = ${FILEBEAT_TCP_EXPOSE:-false}
    | .configuration.fileCarveHttpServeEncryptKey = "${EXTRACTED_FILE_SERVER_PASSWORD:-infected}"
    | .configuration.fileCarveHttpServer = ${EXTRACTED_FILE_SERVER:-true}
    | .configuration.fileCarveHttpServerZip = ${EXTRACTED_FILE_SERVER_ZIP:-true}
    | .configuration.fileCarveMode = "${FILE_EXTRACTION:-interesting}"
    | .configuration.filePreserveMode = "${FILE_PRESERVATION:-quarantined}"
    | .configuration.filescanLogDir = "${FILESCAN_PATH}"
    | .configuration.fileScanRuleUpdate = ${FILE_SCAN_RULE_UPDATE:-false}
    | .configuration.indexDir = "${OPENSEARCH_PATH}"
    | .configuration.indexManagementHistoryInWeeks = ${INDEX_MANAGEMENT_WEEKS_OF_HISTORY:-13}
    | .configuration.indexManagementHotWarm = ${INDEX_MANAGEMENT_HOT_WARM_ENABLE:-false}
    | .configuration.indexManagementOptimizationTimePeriod = "${INDEX_MANAGEMENT_OPTIMIZATION_TIME_PERIOD}"
    | .configuration.indexManagementOptimizeSessionSegments = ${INDEX_MANAGEMENT_SEGMENTS:-1}
    | .configuration.indexManagementPolicy = ${INDEX_MANAGEMENT_ENABLE:-false}
    | .configuration.indexManagementReplicas = ${INDEX_MANAGEMENT_REPLICAS:-0}
    | .configuration.indexManagementSpiDataRetention = "${INDEX_MANAGEMENT_SPI_DATA_RETENTION}"
    | .configuration.indexPruneThreshold = "${DELETE_INDEX_THRESHOLD:-10T}"
    | .configuration.indexSnapshotDir = "${OPENSEARCH_SNAPSHOT_PATH}"
    | .configuration.liveArkime = ${CAPTURE_ARKIME}
    | .configuration.liveArkimeCompressionLevel = ${LIVE_CAPTURE_ARKIME_COMPRESSION_LEVEL:-0}
    | .configuration.liveArkimeCompressionType = "${LIVE_CAPTURE_ARKIME_COMPRESSION:-none}"
    | .configuration.liveArkimeNodeHost = "${CAPTURE_ARKIME_NODE_HOST}"
    | .configuration.liveSuricata = ${CAPTURE_SURICATA}
    | .configuration.liveZeek = ${CAPTURE_ZEEK}
    | .configuration.logstashHost = "${LOGSTASH_HOST:-logstash:5044}"
    | .configuration.lsMemory = "${LOGSTASH_MEMORY}"
    | .configuration.lsWorkers = ${LOGSTASH_WORKERS}
    | .configuration.malcolmIcs = ${ZEEK_ICS:-true}
    | .configuration.malcolmProfile = "${MALCOLM_PROFILE:-malcolm}"
    | .configuration.malcolmRestartPolicy = "${RESTART_MALCOLM:-no}"
    | .configuration.netboxAutoPopulate = ${NETBOX_AUTOPOPULATE:-false}
    | .configuration.netboxAutoPopulateSubnetFilter = "${NETBOX_AUTO_POPULATE_SUBNETS}"
    | .configuration.netboxLogstashAutoCreatePrefix = ${NETBOX_AUTO_PREFIXES:-false}
    | .configuration.netboxLogstashEnrich = ${NETBOX_ENRICH:-true}
    | .configuration.netboxMode = "${NETBOX:-local}"
    | .configuration.netboxSiteName = "${NETBOX_SITE_NAME:-Malcolm}"
    | .configuration.netboxUrl = "${NETBOX_URL}"
    | .configuration.nginxResolverIpv4 = ${NGINX_RESOLVER_IPV4:-true}
    | .configuration.nginxResolverIpv6 = ${NGINX_RESOLVER_IPV6:-false}
    | .configuration.nginxSSL = ${HTTPS:-true}
    | .configuration.opensearchPrimaryMode = "${OPENSEARCH:-opensearch-local}"
    | .configuration.opensearchPrimarySslVerify = ${OPENSEARCH_SSL_VERIFY:-false}
    | .configuration.opensearchPrimaryUrl = "${OPENSEARCH_URL:-https://opensearch:9200}"
    | .configuration.opensearchSecondaryMode = "${OPENSEARCH_SECONDARY:-<MALCOLM_CONFIG_NONE>}"
    | .configuration.opensearchSecondarySslVerify = ${OPENSEARCH_SECONDARY_SSL_VERIFY:-false}
    | .configuration.opensearchSecondaryUrl = "${OPENSEARCH_SECONDARY_URL}"
    | .configuration.osMemory = "${OPENSEARCH_MEMORY}"
    | .configuration.pcapDir = "${PCAP_PATH}"
    | .configuration.pcapFilter = "${CAPTURE_FILTER}"
    | .configuration.pcapIface = "${CAPTURE_IFACE}"
    | .configuration.pcapNetSniff = ${CAPTURE_NETSNIFF}
    | .configuration.pcapNodeName = "${NODE_NAME:-$(hostname -s)}"
    | .configuration.pcapTcpDump = ${CAPTURE_TCPDUMP}
    | .configuration.pipelineEnabled = ${PIPELINE_ENABLED:-true}
    | .configuration.pipelineWorkers = ${PIPELINE_WORKERS:-1}
    | .configuration.processGroupId = ${PGID:-$(id -g)}
    | .configuration.processUserId = ${PUID:-$(id -u)}
    | .configuration.reverseDns = ${REVERSE_DNS:-false}
    | .configuration.suricataLogDir = "${SURICATA_PATH}"
    | .configuration.suricataRuleUpdate = ${SURICATA_RULE_UPDATE:-false}
    | .configuration.syslogTcpPort = ${SYSLOG_PORT_TCP:-0}
    | .configuration.syslogUdpPort = ${SYSLOG_PORT_UDP:-0}
    | .configuration.traefikEntrypoint = "${TRAEFIK_ENTRYPOINT}"
    | .configuration.traefikHost = "${TRAEFIK_HOST}"
    | .configuration.traefikLabels = ${REVERSE_PROXIED:-false}
    | .configuration.traefikOpenSearchHost = "${TRAEFIK_HOST_OPENSEARCH}"
    | .configuration.traefikResolver = "${TRAEFIK_RESOLVER}"
    | .configuration.tweakIface = ${CAPTURE_IFACE_TWEAK}
    | .configuration.useDefaultStorageLocations = ${DEFAULT_PATHS}
    | .configuration.zeekICSBestGuess = ${ZEEK_ICS_BEST_GUESS:-true}
    | .configuration.zeekIntelCronExpression = "${ZEEK_INTEL_CRON_EXPRESSION}"
    | .configuration.zeekIntelFeedSince = "${ZEEK_INTEL_FEED_SINCE:-24 hours ago}"
    | .configuration.zeekIntelItemExpiration = "${ZEEK_INTEL_ITEM_EXPIRATION:-1min}"
    | .configuration.zeekIntelOnStartup = ${ZEEK_INTEL_ON_STARTUP:-false}
    | .configuration.zeekLogDir = "${ZEEK_PATH}"
    | .configuration.zeekPullIntelligenceFeeds = ${ZEEK_INTEL:-false}
EOF

jq -f "${JQ_FILE}" "${SETTINGS_FILE}" | sponge "${SETTINGS_FILE}"

python3 ./scripts/install.py --configure --verbose "${DEBUG}" --configure --non-interactive --import-malcolm-config-file "${SETTINGS_FILE}" --extra "${EXTRA_ARRAY[@]}"
rm -f "${SETTINGS_FILE}" "${JQ_FILE}"

CAPA_SCANNER="ScanCapa"
sed "/#  '$CAPA_SCANNER':/,/^[^\#]/ { s/^#//; }" ./strelka/config/backend/backend.yaml | yq | sponge ./strelka/config/backend/backend.yaml

if command -v direnv &>/dev/null; then
    eval "$(direnv hook bash)"
    [[ -f "$HOME"/.bashrc ]] && ! grep -q direnv "$HOME"/.bashrc && echo 'eval "$(direnv hook bash)"' >> "$HOME"/.bashrc
    [[ ! -f ./.envrc ]] && echo "export MALCOLM_CONTAINER_RUNTIME=\"$RUNTIME\"" > ./.envrc && direnv allow
fi
popd

popd

NEW_GRUB_HASH=$(sha256sum /etc/default/grub | awk '{print $1}')
( [[ -z "$NEW_GRUB_HASH" ]] || [[ -z "$OLD_GRUB_HASH" ]] || [[ "$NEW_GRUB_HASH" != "$OLD_GRUB_HASH" ]] ) && touch /tmp/needs_reboot && sudo update-grub2

sudo usermod -a -G docker "$USER"
sudo loginctl enable-linger "$USER"
sudo ln -s -r -f /usr/libexec/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose
'''
