Metadata-Version: 2.4
Name: lsyzwmworkcore
Version: 0.0.2
Summary: lsyzwm-work-core - ç®€åŒ–workä»»åŠ¡åˆ†å‘ä¸Žæ‰§è¡Œçš„æ ¸å¿ƒåº“
Author: 9kl
License-Expression: MIT
Keywords: lsyzwm-work-core
Classifier: Development Status :: 3 - Alpha
Classifier: Intended Audience :: Developers
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Requires-Python: >=3.8
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: Twisted==24.11.0
Requires-Dist: lsyzwm-master-sdk==0.0.9
Provides-Extra: dev
Provides-Extra: test
Dynamic: license-file

# lsyzwmworkcore

ç®€åŒ– Worker ä»»åŠ¡åˆ†å‘ä¸Žæ‰§è¡Œçš„æ ¸å¿ƒåº“ï¼ŒåŸºäºŽ ZooKeeper å®žçŽ°åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ã€‚

## ç‰¹æ€§

- ðŸš€ **ç®€å•æ˜“ç”¨** - ç»§æ‰¿ `WorkerBase`ï¼Œå®žçŽ° `process_task` æ–¹æ³•å³å¯
- ðŸ”„ **ç”Ÿå‘½å‘¨æœŸé’©å­** - æä¾› `on_task_started`ã€`on_task_completed`ã€`on_task_failed` é’©å­æ–¹æ³•
- ðŸ“¡ **è‡ªåŠ¨ç›‘å¬** - åŸºäºŽ ZooKeeper Watch æœºåˆ¶è‡ªåŠ¨ç›‘å¬ä»»åŠ¡å˜åŒ–
- ðŸ”§ **å¢žé‡å¤„ç†** - å†…ç½® `NodeChangeTracker` é¿å…é‡å¤å¤„ç†
- â° **å®šæ—¶ä»»åŠ¡** - æ”¯æŒå»¶æ—¶ä»»åŠ¡ã€Cron ä»»åŠ¡ã€é—´éš”ä»»åŠ¡
- ðŸ’¾ **ç¼“å­˜æ”¯æŒ** - Worker çº§åˆ«å’Œå®žä¾‹çº§åˆ«çš„ç¼“å­˜èŠ‚ç‚¹ç®¡ç†

## å®‰è£…

```bash
pip install lsyzwmworkcore
```

## å¿«é€Ÿå¼€å§‹

### 1. å®šä¹‰ Worker

```python
from lsyzwmworkcore.base import WorkerBase
from lsyzwm_master_sdk import MasterZooClient


class MyWorker(WorkerBase):
    @property
    def worker_name(self) -> str:
        return "my_worker"

    def process_task(self, task_id: str) -> None:
        """å¤„ç†å•ä¸ªä»»åŠ¡ï¼ˆå¿…é¡»å®žçŽ°ï¼‰"""
        # èŽ·å–ä»»åŠ¡æ•°æ®
        data = self.get_task_value(task_id, as_json=True)
        
        # å¤„ç†ä¸šåŠ¡é€»è¾‘
        print(f"å¤„ç†ä»»åŠ¡: {task_id}, æ•°æ®: {data}")

    # å¯é€‰ï¼šé‡è½½é’©å­æ–¹æ³•
    def on_task_started(self, task_id: str) -> None:
        super().on_task_started(task_id)
        print(f"ä»»åŠ¡å¼€å§‹: {task_id}")

    def on_task_completed(self, task_id: str) -> None:
        super().on_task_completed(task_id)
        print(f"ä»»åŠ¡å®Œæˆ: {task_id}")

    def on_task_failed(self, task_id: str, exception: Exception = None) -> None:
        super().on_task_failed(task_id, exception)
        print(f"ä»»åŠ¡å¤±è´¥: {task_id}, é”™è¯¯: {exception}")
```

### 2. å¯åŠ¨ Worker

```python
from lsyzwm_master_sdk import MasterZooClient

# åˆå§‹åŒ– ZooKeeper å®¢æˆ·ç«¯
zk_client = MasterZooClient(hosts="localhost:2181")
zk_client.start()

# åˆ›å»ºå¹¶å¯åŠ¨ Worker
worker = MyWorker(sid=1, zk_client=zk_client)
worker.register()      # æ³¨å†Œ Worker å®žä¾‹
worker.watch_tasks()   # å¼€å§‹ç›‘å¬ä»»åŠ¡
```

### 3. ä½¿ç”¨ WorkerManagerï¼ˆå¯é€‰ï¼‰

```python
from lsyzwmworkcore.worker_manager import worker_manager

# æ³¨å†Œ Worker ç±»
worker_manager.register_worker_class(MyWorker)

# èŽ·å– Worker å®žä¾‹
worker = worker_manager.get_worker("my_worker")

# èŽ·å–æ‰€æœ‰ Worker
all_workers = worker_manager.get_all_workers()
```

## ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ

```
on_task_started(task_id)      # é’©å­ï¼šä»»åŠ¡å¼€å§‹ï¼Œé»˜è®¤æ ‡è®°ä¸ºå¤„ç†ä¸­
        â†“
process_task(task_id)         # æ ¸å¿ƒï¼šå­ç±»å®žçŽ°ä¸šåŠ¡é€»è¾‘
        â†“
on_task_completed(task_id)    # é’©å­ï¼šä»»åŠ¡æˆåŠŸï¼Œé»˜è®¤æ ‡è®°å®Œæˆå¹¶åˆ é™¤èŠ‚ç‚¹
        æˆ–
on_task_failed(task_id, ex)   # é’©å­ï¼šä»»åŠ¡å¤±è´¥ï¼Œé»˜è®¤æ ‡è®°å¤±è´¥å¹¶åˆ é™¤èŠ‚ç‚¹
```

## æ ¸å¿ƒç»„ä»¶

### WorkerBase

Worker æŠ½è±¡åŸºç±»ï¼Œæä¾›ï¼š

| æ–¹æ³• | è¯´æ˜Ž |
|------|------|
| `process_task(task_id)` | **æŠ½è±¡æ–¹æ³•**ï¼Œå­ç±»å¿…é¡»å®žçŽ° |
| `on_task_started(task_id)` | é’©å­ï¼šä»»åŠ¡å¼€å§‹ |
| `on_task_completed(task_id)` | é’©å­ï¼šä»»åŠ¡å®Œæˆ |
| `on_task_failed(task_id, exception)` | é’©å­ï¼šä»»åŠ¡å¤±è´¥ |
| `register()` | æ³¨å†Œ Worker å®žä¾‹ |
| `watch_tasks()` | ç›‘å¬ä»»åŠ¡èŠ‚ç‚¹å˜åŒ– |
| `get_task_value(task_id, as_json)` | èŽ·å–ä»»åŠ¡æ•°æ® |
| `add_task_node(worker_name, payload, ...)` | æ·»åŠ ä»»åŠ¡åˆ°å…¶ä»– Worker |
| `add_self_task_node(payload, ...)` | æ·»åŠ ä»»åŠ¡åˆ°å½“å‰å®žä¾‹ |

### NodeChangeTracker

èŠ‚ç‚¹å˜æ›´è·Ÿè¸ªå™¨ï¼Œç”¨äºŽå¢žé‡æ£€æµ‹ï¼š

```python
tracker = NodeChangeTracker(worker_name="my_worker")

# èŽ·å–æ–°å¢žèŠ‚ç‚¹
new_nodes = tracker.get_new_nodes(current_node_ids)

# æ ‡è®°çŠ¶æ€
tracker.mark_processing(node_id)
tracker.mark_completed(node_id)
tracker.mark_failed(node_id, remove_from_processing=True)
```

### WorkerManager

Worker ç®¡ç†å™¨ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰ï¼š

```python
from lsyzwmworkcore.worker_manager import worker_manager

worker_manager.register_worker_class(MyWorker)
worker = worker_manager.get_worker("my_worker")
names = worker_manager.get_worker_names()
```

## å®šæ—¶ä»»åŠ¡

```python
# å»¶æ—¶ä»»åŠ¡
worker.create_delay_job_node(
    job_id="job_001",
    worker_name="target_worker",
    payload={"action": "process"},
    delay_ts=int(time.time()) + 3600,  # 1å°æ—¶åŽæ‰§è¡Œ
    who=worker.worker_id
)

# Cron ä»»åŠ¡
worker.create_cron_job_node(
    job_id="job_002",
    worker_name="target_worker",
    payload={"action": "daily_report"},
    cron="0 9 * * *",  # æ¯å¤©9ç‚¹æ‰§è¡Œ
    who=worker.worker_id
)

# é—´éš”ä»»åŠ¡
worker.create_interval_job_node(
    job_id="job_003",
    worker_name="target_worker",
    payload={"action": "heartbeat"},
    who=worker.worker_id,
    minutes=5  # æ¯5åˆ†é’Ÿæ‰§è¡Œ
)
```

## ç¼“å­˜ç®¡ç†

```python
# Worker çº§åˆ«ç¼“å­˜ï¼ˆæ‰€æœ‰å®žä¾‹å…±äº«ï¼‰
worker.set_worker_cache_value("config", {"key": "value"})
config = worker.get_worker_cache_value("config", as_json=True)

# å®žä¾‹çº§åˆ«ç¼“å­˜ï¼ˆä»…å½“å‰å®žä¾‹ï¼‰
worker.set_worker_instance_cache_value("state", {"status": "running"})
state = worker.get_worker_instance_cache_value("state", as_json=True)
```

## ä¾èµ–

- Python >= 3.8
- Twisted == 24.11.0
- lsyzwm-master-sdk == 0.0.9

## License

MIT
