# Converted from DefectDojo parser
import typing
import datetime
# Required stubs: Finding

from norm_findings.stubs.models import Finding

class DeepfenceThreatmapperMalware():

    def get_findings(self, scan_file, test):
        if (('Rule Name' in test) and ('Class' in test)):
            return self._parse_old_format(scan_file, test, test)
        if (('Rule Name' in test) and ('Node Type' in test)):
            return self._parse_new_format(scan_file, test, test)
        return None

    def _parse_old_format(self, row, headers, test):
        Rule_Name = row[headers['Rule Name']]
        Class = row[headers['Class']]
        File_Name = row[headers['File Name']]
        Summary = row[headers['Summary']]
        Severity = row[headers['Severity']]
        Node_Name = row[headers['Node Name']]
        NodeType = row[headers['NodeType']]
        Container_Name = row[headers['Container Name']]
        Kubernetes_Cluster_Name = row[headers['Kubernetes Cluster Name']]
        description = f'''**Summary:** {Summary}
**Rule Name:** {Rule_Name}
**Class:** {Class}
**File Name:** {File_Name}
**Node Name:** {Node_Name}
**NodeType:** {NodeType}
**Container Name:** {Container_Name}
**Kubernetes Cluster Name:** {Kubernetes_Cluster_Name}
'''
        return Finding(title=Rule_Name, description=description, file_path=File_Name, severity=self.severity(Severity), static_finding=False, dynamic_finding=True, test=test)

    def _parse_new_format(self, row, headers, test):
        Rule_Name = row[headers['Rule Name']]
        File_Name = row[headers['File Name']]
        Summary = row[headers['Summary']]
        Severity = row[headers['Severity']]
        Node_Name = row[headers['Node Name']]
        Node_Type = row[headers['Node Type']]
        Kubernetes_Cluster_Name = row[headers['Kubernetes Cluster Name']]
        Masked = row[headers['Masked']]
        description = f'''**Summary:** {Summary}
**Rule Name:** {Rule_Name}
**File Name:** {File_Name}
**Node Name:** {Node_Name}
**Node Type:** {Node_Type}
**Kubernetes Cluster Name:** {Kubernetes_Cluster_Name}
**Masked:** {Masked}
'''
        return Finding(title=Rule_Name, description=description, file_path=File_Name, severity=self.severity(Severity), static_finding=False, dynamic_finding=True, test=test)

    def severity(self, severity_input):
        if (severity_input is None):
            return 'Info'
        return severity_input.capitalize()
