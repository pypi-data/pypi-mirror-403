# Converted from DefectDojo parser
import typing
import datetime
# Required stubs: Finding

from norm_findings.stubs.models import Finding

class DeepfenceThreatmapperVulnerability():

    def get_findings(self, scan_file, test):
        if (('cve_id' in test) and ('cve_attack_vector' in test)):
            return self._parse_old_format(scan_file, test, test)
        if (('CVE ID' in test) and ('Attack Vector' in test)):
            return self._parse_new_format(scan_file, test, test)
        return None

    def _parse_old_format(self, row, headers, test):
        cve_attack_vector = row[headers['cve_attack_vector']]
        cve_caused_by_package = row[headers['cve_caused_by_package']]
        cve_container_image = row[headers['cve_container_image']]
        cve_container_image_id = row[headers['cve_container_image_id']]
        cve_description = row[headers['cve_description']]
        cve_fixed_in = row[headers['cve_fixed_in']]
        cve_id = row[headers['cve_id']]
        cve_link = row[headers['cve_link']]
        cve_severity = row[headers['cve_severity']]
        cve_overall_score = row[headers['cve_overall_score']]
        cve_type = row[headers['cve_type']]
        host_name = row[headers['host_name']]
        cloud_account_id = row[headers['cloud_account_id']]
        masked = row[headers['masked']]
        description = f'''**Attack Vector:** {cve_attack_vector}
**Caused By Package:** {cve_caused_by_package}
**Container Image:** {cve_container_image}
**Container Image ID:** {cve_container_image_id}
**Description:** {cve_description}
**Severity:** {cve_severity}
**Overall Score:** {cve_overall_score}
**Type:** {cve_type}
**Host Name:** {host_name}
**Cloud Account ID:** {cloud_account_id}
**Masked:** {masked}
'''
        return Finding(title=f'Threatmapper_Vuln_Report-{cve_id}', description=description, component_name=cve_caused_by_package, severity=self.severity(cve_severity), static_finding=False, dynamic_finding=True, mitigation=cve_fixed_in, references=cve_link, cve=cve_id, test=test)

    def _parse_new_format(self, row, headers, test):
        cve_id = row[headers['CVE ID']]
        severity = row[headers['Severity']]
        attack_vector = row[headers['Attack Vector']]
        caused_by_package = row[headers['Caused By Package']]
        caused_by_package_path = row[headers['Caused By Package Path']]
        cvss_score = row[headers['CVSS Score']]
        description_text = row[headers['Description']]
        fixed_in = row[headers['Fixed In']]
        link = row[headers['Link']]
        overall_score = row[headers['Overall Score']]
        cve_type = row[headers['Type']]
        node_name = row[headers['Node Name']]
        node_type = row[headers['Node Type']]
        cluster_name = row[headers['Kubernetes Cluster Name']]
        masked = row[headers['Masked']]
        description = f'''**CVE ID:** {cve_id}
**Severity:** {severity}
**Attack Vector:** {attack_vector}
**Caused By Package:** {caused_by_package}
**Caused By Package Path:** {caused_by_package_path}
**CVSS Score:** {cvss_score}
**Description:** {description_text}
**Fixed In:** {fixed_in}
**Link:** {link}
**Overall Score:** {overall_score}
**Type:** {cve_type}
**Node Name:** {node_name}
**Node Type:** {node_type}
**Kubernetes Cluster Name:** {cluster_name}
**Masked:** {masked}
'''
        return Finding(title=f'Threatmapper_Vuln_Report-{cve_id}', description=description, component_name=caused_by_package, severity=self.severity(severity), static_finding=False, dynamic_finding=True, mitigation=fixed_in, references=link, cve=cve_id, test=test)

    def severity(self, severity_input):
        if (severity_input is None):
            return 'Info'
        return severity_input.capitalize()
