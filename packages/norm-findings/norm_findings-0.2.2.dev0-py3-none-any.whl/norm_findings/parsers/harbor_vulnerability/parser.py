# Converted from DefectDojo parser
import typing
import datetime
# Required stubs: Finding

import contextlib
import json
from norm_findings.stubs.models import Finding

class HarborVulnerabilityParser():
    'Read JSON data from Harbor compatible format and import it to DefectDojo'

    def get_scan_types(self):
        return ['Harbor Vulnerability Scan']

    def get_label_for_scan_types(self, scan_type):
        return scan_type

    def get_description_for_scan_types(self, scan_type):
        return 'Import vulnerabilities from Harbor API.'

    def get_findings(self, scan_file, test):
        tree = scan_file.read()
        try:
            data = json.loads(str(tree, 'utf-8'))
        except Exception:
            data = json.loads(tree)
        dupes = {}
        with contextlib.suppress(KeyError):
            vulnerability = data['vulnerabilities']
        with contextlib.suppress(KeyError, StopIteration, TypeError):
            vulnerability = data[next(iter(data.keys()))]['vulnerabilities']
        if (('vulnerability' not in locals()) or (vulnerability is None)):
            return []
        for item in vulnerability:
            item_id = item.get('id')
            package_name = item.get('package')
            package_version = item.get('version')
            description = item.get('description', 'No description found')
            severity = item.get('severity')
            fix_version = item.get('fix_version')
            links = item.get('links')
            cwe_ids = item.get('cwe_ids')
            fix_available = True
            if (not item.get('fix_version')):
                fix_available = False
            title = f'{item_id} - {package_name} ({package_version})'
            severity = transpose_severity(severity)
            mitigation = (f'Upgrade {package_name} to version {fix_version}' if fix_version else None)
            if links:
                references = ''
                for link in links:
                    references += f'''{link}
'''
            else:
                references = None
            cwe = (cwe_ids[0].strip('CWE-') if (cwe_ids and cwe_ids[0]) else None)
            vulnerability_id = (item_id if (item_id and item_id.startswith('CVE')) else None)
            dupe_key = title
            if (dupe_key in dupes):
                find = dupes[dupe_key]
            else:
                dupes[dupe_key] = True
                find = Finding(title=title, test=test, description=description, severity=severity, mitigation=mitigation, references=references, static_finding=True, component_name=package_name, component_version=package_version, cwe=cwe, fix_available=fix_available)
                if vulnerability_id:
                    find.unsaved_vulnerability_ids = [vulnerability_id]
                dupes[dupe_key] = find
        return list(dupes.values())

def transpose_severity(severity):
    if (severity in Finding.SEVERITIES):
        return severity
    return 'Info'
