# Converted from DefectDojo parser
import typing
import datetime
# Required stubs: Endpoint, Finding

from defusedxml import ElementTree
from html2text import html2text
from norm_findings.stubs.models import Endpoint, Finding

class ZapParser():
    'Parser for XML file generated by the OWASP Zed Attacl Proxy (ZAP) tool https://www.zaproxy.org/.'

    def get_fields(self) -> list[str]:
        "\n        Return the list of fields used in the Zap Parser.\n\n        Fields:\n        - title: Set to name from Zap Scanner.\n        - description: Custom description made from data outputted by Zap Scanner.\n        - severity: Set to severity from Zap Scanner that has been mapped to Defect Dojo's format.\n        - scanner_confidence: Set to scanner confidence values that has been mapped to Defect Dojo's format.\n        - mitigation: Set to solution from Zap Scanner.\n        - dynamic_finding: Set to true.\n        - static_finding: Set to false.\n        - vuln_id_from_tool: Set to pluginid from scanner.\n        - cwe: Set to cwe from Zap Scanner.\n        "
        return ['title', 'description', 'severity', 'scanner_confidence', 'mitigation', 'dynamic_finding', 'static_finding', 'vuln_id_from_tool', 'cwe']

    def get_dedupe_fields(self) -> list[str]:
        '\n        Return the list of fields used for deduplication in the Zap Parser.\n\n        Fields:\n        - title: Set to name from Zap Scanner.\n        - cwe: Set to cwe from Zap Scanner.\n        - severity: Set to severity from Zap Scanner.\n        '
        return ['title', 'cwe', 'severity']
    MAPPING_SEVERITY = {'0': 'Info', '1': 'Low', '2': 'Medium', '3': 'High'}
    MAPPING_CONFIDENCE = {'1': 7, '2': 4, '3': 1, '4': 1}

    def get_scan_types(self):
        return ['ZAP Scan']

    def get_label_for_scan_types(self, scan_type):
        return 'ZAP Scan'

    def get_description_for_scan_types(self, scan_type):
        return 'ZAP XML report format.'

    def get_findings(self, scan_file, test):
        if (not scan_file.name.endswith('.xml')):
            msg = 'Internal error: Wrong file format, please use xml.'
            raise ValueError(msg)
        tree = ElementTree.parse(scan_file)
        items = []
        for node in tree.findall('site'):
            for item in node.findall('alerts/alertitem'):
                finding = Finding(test=test, title=item.findtext('alert'), description=html2text(item.findtext('desc')), severity=self.MAPPING_SEVERITY.get(item.findtext('riskcode')), scanner_confidence=self.MAPPING_CONFIDENCE.get(item.findtext('riskcode')), mitigation=html2text(item.findtext('solution')), references=html2text(item.findtext('reference')), dynamic_finding=True, static_finding=False, vuln_id_from_tool=item.findtext('pluginid'))
                if ((item.findtext('cweid') is not None) and item.findtext('cweid').isdigit()):
                    finding.cwe = int(item.findtext('cweid'))
                finding.unsaved_endpoints = []
                finding.unsaved_req_resp = []
                for instance in item.findall('instances/instance'):
                    endpoint = Endpoint.from_uri(instance.findtext('uri'))
                    if (instance.findtext('requestheader') is not None):
                        request = (instance.findtext('requestheader') + instance.findtext('requestbody'))
                        response = (instance.findtext('responseheader') + instance.findtext('responsebody'))
                    else:
                        request = f'''Method:           {instance.findtext('method')} 
Param:            {instance.findtext('param')} 
Attack:           {instance.findtext('attack')} 
EndpointQuery:    {endpoint.query} 
EndpointFragment: {endpoint.fragment}'''
                        response = f"{instance.findtext('evidence')}"
                    endpoint.query = None
                    endpoint.fragment = None
                    finding.unsaved_endpoints.append(endpoint)
                    finding.unsaved_req_resp.append({'req': request, 'resp': response})
                items.append(finding)
        return items
