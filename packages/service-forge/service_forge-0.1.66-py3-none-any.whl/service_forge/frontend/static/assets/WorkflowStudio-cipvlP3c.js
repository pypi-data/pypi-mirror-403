const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./WorkflowEditor-D8-6OZ8Y.js","./index-BrGO8rHI.js","./vue-core-C3hq3bxF.js","./ui-components-DQ2lkQGO.js","./index-CjSe8i2q.css","./api-DyiqpKJK.js","./api-BDer3rj7.css","./vue-flow-BEraqp1L.js","./js-yaml-yTPt38rv.js","./code-editor-DFIoHxr7.js","./element-ui-CA4rbiJ9.js","./WorkflowEditor-DMina2Ac.css","./el-tag-DljBBxJR.css"])))=>i.map(i=>d[i]);
import{_ as ue,a as Se}from"./index-BrGO8rHI.js";import{a as Y,b as De,t as Ce,c as We,g as le}from"./api-DyiqpKJK.js";import{aB as Me,W as Q,r as h,V as Re,v as ee,aC as de,aD as pe,c as Z,i as Ae,w as $,E as W,F as p,u as v,O as f,I as Le,K as M,B as H,x as fe,L as F,a9 as Fe,M as He,y as S,aE as Ve,j as Pe,G as ie,aF as xe,aG as Be,aA as ze,a4 as ce,q as b}from"./vue-core-C3hq3bxF.js";import{u as N}from"./ui-components-DQ2lkQGO.js";import{a as y,f as Ue,h as he,e as C,i as $e,j as je,k as ve,l as me,m as Ke,v as qe,n as Je,o as Ye,p as Ze,q as Ge,r as Xe}from"./element-ui-CA4rbiJ9.js";import{j as G}from"./js-yaml-yTPt38rv.js";import{r as Qe}from"./elkjs-daFYuoNQ.js";const I={WORKFLOW_DATA:"workflowData",WORKFLOW_NEED_LAYOUT:"workflowNeedLayout",NODE_DATA_MAP:"nodeDataMap",NODE_FOR_INSPECTION:"nodeForInspection",TRACE_FOR_INSPECTION:"traceForInspection",TEST_RUNNING_RECORD:"testRunningRecord",IS_EDIT_MODE:"isEditMode",TRACE_OPEN:"traceOpen",FEEDBACK_OPEN:"feedbackOpen",RAW_JSON_OPEN:"rawJsonOpen",CREATE_NEW_NODE_OPEN:"createNewNodeOpen",EMITTER:"emitter"},Pt=N({tag:"svg",attr:{viewBox:"0 0 1024 1024"},child:[{tag:"path",attr:{d:"M864 256H736v-80c0-35.3-28.7-64-64-64H352c-35.3 0-64 28.7-64 64v80H160c-17.7 0-32 14.3-32 32v32c0 4.4 3.6 8 8 8h60.4l24.7 523c1.6 34.1 29.8 61 63.9 61h454c34.2 0 62.3-26.8 63.9-61l24.7-523H888c4.4 0 8-3.6 8-8v-32c0-17.7-14.3-32-32-32zm-200 0H360v-72h304v72z"},child:[]}]}),xt=N({tag:"svg",attr:{viewBox:"0 0 1024 1024"},child:[{tag:"path",attr:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm32 664c0 4.4-3.6 8-8 8h-48c-4.4 0-8-3.6-8-8V456c0-4.4 3.6-8 8-8h48c4.4 0 8 3.6 8 8v272zm-32-344a48.01 48.01 0 0 1 0-96 48.01 48.01 0 0 1 0 96z"},child:[]}]}),Bt=N({tag:"svg",attr:{t:"1569683368540",viewBox:"0 0 1024 1024",version:"1.1"},child:[{tag:"defs",attr:{},child:[]},{tag:"path",attr:{d:"M899.1 869.6l-53-305.6H864c14.4 0 26-11.6 26-26V346c0-14.4-11.6-26-26-26H618V138c0-14.4-11.6-26-26-26H432c-14.4 0-26 11.6-26 26v182H160c-14.4 0-26 11.6-26 26v192c0 14.4 11.6 26 26 26h17.9l-53 305.6c-0.3 1.5-0.4 3-0.4 4.4 0 14.4 11.6 26 26 26h723c1.5 0 3-0.1 4.4-0.4 14.2-2.4 23.7-15.9 21.2-30zM204 390h272V182h72v208h272v104H204V390z m468 440V674c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v156H416V674c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v156H202.8l45.1-260H776l45.1 260H672z"},child:[]}]}),zt=N({tag:"svg",attr:{viewBox:"0 0 1024 1024",fill:"currentColor","fill-rule":"evenodd"},child:[{tag:"path",attr:{d:"M799.855 166.312c.023.007.043.018.084.059l57.69 57.69c.041.041.052.06.059.084a.118.118 0 0 1 0 .069c-.007.023-.018.042-.059.083L569.926 512l287.703 287.703c.041.04.052.06.059.083a.118.118 0 0 1 0 .07c-.007.022-.018.042-.059.083l-57.69 57.69c-.041.041-.06.052-.084.059a.118.118 0 0 1-.069 0c-.023-.007-.042-.018-.083-.059L512 569.926 224.297 857.629c-.04.041-.06.052-.083.059a.118.118 0 0 1-.07 0c-.022-.007-.042-.018-.083-.059l-57.69-57.69c-.041-.041-.052-.06-.059-.084a.118.118 0 0 1 0-.069c.007-.023.018-.042.059-.083L454.073 512 166.371 224.297c-.041-.04-.052-.06-.059-.083a.118.118 0 0 1 0-.07c.007-.022.018-.042.059-.083l57.69-57.69c.041-.041.06-.052.084-.059a.118.118 0 0 1 .069 0c.023.007.042.018.083.059L512 454.073l287.703-287.702c.04-.041.06-.052.083-.059a.118.118 0 0 1 .07 0Z"},child:[]}]}),et=N({tag:"svg",attr:{viewBox:"0 0 1024 1024"},child:[{tag:"path",attr:{d:"M518.3 459a8 8 0 0 0-12.6 0l-112 141.7a7.98 7.98 0 0 0 6.3 12.9h73.9V856c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V613.7H624c6.7 0 10.4-7.7 6.3-12.9L518.3 459z"},child:[]},{tag:"path",attr:{d:"M811.4 366.7C765.6 245.9 648.9 160 512.2 160S258.8 245.8 213 366.6C127.3 389.1 64 467.2 64 560c0 110.5 89.5 200 199.9 200H304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8h-40.1c-33.7 0-65.4-13.4-89-37.7-23.5-24.2-36-56.8-34.9-90.6.9-26.4 9.9-51.2 26.2-72.1 16.7-21.3 40.1-36.8 66.1-43.7l37.9-9.9 13.9-36.6c8.6-22.8 20.6-44.1 35.7-63.4a245.6 245.6 0 0 1 52.4-49.9c41.1-28.9 89.5-44.2 140-44.2s98.9 15.3 140 44.2c19.9 14 37.5 30.8 52.4 49.9 15.1 19.3 27.1 40.7 35.7 63.4l13.8 36.5 37.8 10C846.1 454.5 884 503.8 884 560c0 33.1-12.9 64.3-36.3 87.7a123.07 123.07 0 0 1-87.6 36.3H720c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h40.1C870.5 760 960 670.5 960 560c0-92.7-63.1-170.7-148.6-193.3z"},child:[]}]}),tt=N({tag:"svg",attr:{viewBox:"0 0 1024 1024"},child:[{tag:"path",attr:{d:"M257.7 752c2 0 4-.2 6-.5L431.9 722c2-.4 3.9-1.3 5.3-2.8l423.9-423.9a9.96 9.96 0 0 0 0-14.1L694.9 114.9c-1.9-1.9-4.4-2.9-7.1-2.9s-5.2 1-7.1 2.9L256.8 538.8c-1.5 1.5-2.4 3.3-2.8 5.3l-29.5 168.2a33.5 33.5 0 0 0 9.4 29.8c6.6 6.4 14.9 9.9 23.8 9.9zm67.4-174.4L687.8 215l73.3 73.3-362.7 362.6-88.9 15.7 15.6-89zM880 836H144c-17.7 0-32 14.3-32 32v36c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-36c0-17.7-14.3-32-32-32z"},child:[]}]}),ot=N({tag:"svg",attr:{viewBox:"0 0 1024 1024"},child:[{tag:"path",attr:{d:"M942.2 486.2C847.4 286.5 704.1 186 512 186c-192.2 0-335.4 100.5-430.2 300.3a60.3 60.3 0 0 0 0 51.5C176.6 737.5 319.9 838 512 838c192.2 0 335.4-100.5 430.2-300.3 7.7-16.2 7.7-35 0-51.5zM512 766c-161.3 0-279.4-81.8-362.7-254C232.6 339.8 350.7 258 512 258c161.3 0 279.4 81.8 362.7 254C791.5 684.2 673.4 766 512 766zm-4-430c-97.2 0-176 78.8-176 176s78.8 176 176 176 176-78.8 176-176-78.8-176-176-176zm0 288c-61.9 0-112-50.1-112-112s50.1-112 112-112 112 50.1 112 112-50.1 112-112 112z"},child:[]}]}),Ut=N({tag:"svg",attr:{viewBox:"0 0 1024 1024"},child:[{tag:"path",attr:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"},child:[]},{tag:"path",attr:{d:"M464 336a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm72 112h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V456c0-4.4-3.6-8-8-8z"},child:[]}]}),$t=N({tag:"svg",attr:{viewBox:"0 0 1024 1024"},child:[{tag:"path",attr:{d:"M696 480H328c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h368c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8z"},child:[]},{tag:"path",attr:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"},child:[]}]}),at=N({tag:"svg",attr:{viewBox:"0 0 1024 1024"},child:[{tag:"path",attr:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"},child:[]},{tag:"path",attr:{d:"M719.4 499.1l-296.1-215A15.9 15.9 0 0 0 398 297v430c0 13.1 14.8 20.5 25.3 12.9l296.1-215a15.9 15.9 0 0 0 0-25.8zm-257.6 134V390.9L628.5 512 461.8 633.1z"},child:[]}]}),jt=N({tag:"svg",attr:{viewBox:"0 0 1024 1024"},child:[{tag:"path",attr:{d:"M482 152h60q8 0 8 8v704q0 8-8 8h-60q-8 0-8-8V160q0-8 8-8Z"},child:[]},{tag:"path",attr:{d:"M192 474h672q8 0 8 8v60q0 8-8 8H160q-8 0-8-8v-60q0-8 8-8Z"},child:[]}]}),X=Me("schema",()=>{const r=Q(new Map),e=h(!1),t=async s=>{if(!(s&&r.size>0))try{e.value=!0;const o=await Y.get("/schema/nodes",{base:De()});r.clear(),o.forEach(n=>r.set(n.name,n))}catch(o){throw y.error("获取节点定义失败"),o}finally{e.value=!1}};return t(!0).finally(),{nodeSchemaMap:r,synchronizing:e,fetchNodeSchemas:t}});class u{static WORKFLOW_INPUT_NODE_ID="$INPUT";static WORKFLOW_OUTPUT_NODE_ID="$OUTPUT";static portTypeToNodeId(e){return e==="in"?u.WORKFLOW_INPUT_NODE_ID:u.WORKFLOW_OUTPUT_NODE_ID}static configNameToNodeId(e){return`_${e}`}static nodeIdToName(e){return e===u.WORKFLOW_INPUT_NODE_ID?"输入":e===u.WORKFLOW_OUTPUT_NODE_ID?"输出":e.slice(1)}static getHandleId(e){return e.nodeId===u.WORKFLOW_INPUT_NODE_ID?`$入口-${e.type}-${e.handleName}`:e.nodeId===u.WORKFLOW_OUTPUT_NODE_ID?`$出口-${e.type}-${e.handleName}`:`_${e.nodeId}-${e.type}-${e.handleName}`}static extractHandleName(e,t,s){return u.isInputNode(t)||u.isOutputNode(t)?e.slice(5+s.length):e.slice(3+t.length+s.length)}static getHandleType(e,t){if(u.isInputNode(t)||u.isOutputNode(t)){const s=e.slice(4);if(s.startsWith("in"))return"in";if(s.startsWith("out"))return"out"}else{const s=e.slice(2+t.length);if(s.startsWith("in"))return"in";if(s.startsWith("out"))return"out"}return"unknown"}static isInputNode(e){return e===u.WORKFLOW_INPUT_NODE_ID}static isOutputNode(e){return e===u.WORKFLOW_OUTPUT_NODE_ID}static isModuleNode(e){return e.startsWith("_")}}var nt=Qe();const st=Ue(nt);function V(r){const[e,t]=r.split("|");return{nodeId:u.configNameToNodeId(e||""),handleName:t||""}}function rt(r,e){const t=new Map;return r.nodes.forEach(s=>{t.set(u.configNameToNodeId(s.name),lt(s,e))}),t.set(u.portTypeToNodeId("in"),ut(r.inputs)),t.set(u.portTypeToNodeId("out"),dt(t,r.outputs)),t.forEach((s,o)=>{pt(o,t)}),t}function lt(r,e){const t=e.get(r.type);return{name:r.name,type:r.type||"",args:r.args||{},inputs:ct(r,t),outputs:it(r,t)}}function it(r,e){const t={};return Object.keys(e?.outputs||{}).forEach(s=>{t[s]={nodeId:u.configNameToNodeId(r.name),handleName:s,type:"out",to:[]}}),Object.entries(r.outputs||{}).forEach(([s,o])=>{let n;s in t?n=t[s]:(n={nodeId:u.configNameToNodeId(r.name),handleName:s,type:"out",to:[]},t[s]=n),typeof o=="string"?n.to.push(V(o)):Array.isArray(o)&&n.to.push(...o.map(V)),t[s]=n}),t}function ct(r,e){const t={};return[...Object.keys(e?.inputs||{}),...Object.keys(r?.args||{})].forEach(o=>{const n={nodeId:u.configNameToNodeId(r.name),handleName:o,type:"in",hasSource:!1};o in(r?.args||{})&&(n.value=r?.args?.[o]),t[o]=n}),t}function ut(r){const e={name:"输入",type:"WORKFLOW_INPUT",outputs:{}};return r?.forEach(t=>{const s={nodeId:u.portTypeToNodeId("in"),handleName:t.name,type:"out",to:[]};t.value!==void 0&&t.value!==null&&(s.value=t.value),t.port&&typeof t.port=="string"?s.to.push(V(t.port)):Array.isArray(t.port)&&s.to.push(...t.port.map(V)),e.outputs&&(e.outputs[t.name]=s)}),e}function dt(r,e){const t={name:"输出",type:"WORKFLOW_OUTPUT",inputs:{}},s=u.portTypeToNodeId("out");return e?.forEach(o=>{const n={nodeId:s,handleName:o.name,type:"in",hasSource:!0};o.port&&(n.from=V(o.port)),t.inputs&&(t.inputs[o.name]=n)}),Object.values(t.inputs||{}).forEach(o=>{const n=r.get(o.from?.nodeId||"");if(n&&o.from?.handleName){let a=n.outputs?.[o.from.handleName];a?a.to.push({nodeId:s,handleName:o.handleName}):(a={nodeId:o.from.nodeId,handleName:o.from.handleName,type:"out",to:[{nodeId:s,handleName:o.handleName}]},n.outputs=n.outputs||{},n.outputs[o.from.handleName]=a)}}),t}function pt(r,e){const t=e.get(r);t&&Object.values(t.outputs||{}).forEach(s=>{s.to.forEach(o=>{const n=e.get(o.nodeId);if(n&&o.handleName){let a=n.inputs?.[o.handleName];a?a.hasSource=!0:(a={nodeId:o.nodeId,handleName:o.handleName,type:"in",hasSource:!0},n.inputs=n.inputs||{},n.inputs[o.handleName]=a)}})})}function Kt(r,e){const t=ft(r,e),s=ht(r);return{nodes:t,edges:s}}function ft(r,e){const t=[],s=new Set([...r.keys()].filter(a=>!u.isInputNode(a)&&!u.isOutputNode(a)));let o,n;return e?.forEach(a=>{u.isInputNode(a.id)?o=a:u.isOutputNode(a.id)?n=a:r.has(a.id)&&(t.push(a),s.delete(a.id))}),t.push(o??{id:u.portTypeToNodeId("in"),type:"port",position:{x:0,y:0}}),t.push(n??{id:u.portTypeToNodeId("out"),type:"port",position:{x:0,y:0}}),s.forEach(a=>{r.get(a)&&t.push({id:a,type:"module",position:{x:0,y:0}})}),t}function ht(r){const e=[];return r.forEach((t,s)=>{Object.values(t.outputs||{}).forEach(o=>{o.to.forEach(n=>{const a=r.get(n.nodeId);if(a&&n.handleName){const i=a.inputs?.[n.handleName];if(!i)return;const m={id:`E-${o.nodeId}|${o.handleName}-${n.nodeId}|${n.handleName}`,source:s,sourceHandle:u.getHandleId(o),target:i.nodeId,targetHandle:u.getHandleId(i),markerEnd:"arrow"};(u.isInputNode(m.source)||u.isOutputNode(m.target))&&(m.style={strokeDasharray:"5px 2px"}),e.push(m)}})})}),e}async function qt(r,e,t){const s=new st,n={id:"root",layoutOptions:{"elk.algorithm":"layered","elk.direction":"RIGHT","elk.layered.nodePlacement.strategy":"SIMPLE"},children:r.map(i=>{const m=t.get(i.id),k=Object.values(m?.inputs||{}).map(c=>({id:u.getHandleId(c),properties:{side:"WEST"}}))||[],d=Object.values(m?.outputs||{}).map(c=>({id:u.getHandleId(c),properties:{side:"EAST"}}))||[];return{id:i.id,width:400,height:300,properties:{"org.eclipse.elk.portConstraints":"FIXED_ORDER"},ports:[{id:i.id},...k,...d]}}),edges:e.map(i=>({id:i.id,sources:[i.sourceHandle||i.source],targets:[i.targetHandle||i.target]}))},a=await s.layout(n);return r.map(i=>{const m=a.children?.find(k=>k.id===i.id);return{...i,position:{x:m?.x??0,y:m?.y??0}}})}const vt="";class mt{ws=null;url;protocols;handlers={};isConnected=!1;constructor(e,{params:t,protocols:s,base:o,handlers:n}){const a=new URL((o||vt)+e||e,window.location.origin);t&&Object.entries(t).forEach(([i,m])=>a.searchParams.append(i,m)),this.url=Ce(a.toString()),this.protocols=s,this.handlers=n||{}}connect(){return this.ws&&(this.ws.readyState===WebSocket.CONNECTING||this.ws.readyState===WebSocket.OPEN)?this:(this.ws=new WebSocket(this.url,this.protocols),this.ws.onopen=e=>{this.isConnected=!0,this.handlers.onOpen?.(e)},this.ws.onmessage=e=>{let t;try{t=JSON.parse(e.data)}catch{t=e.data}this.handlers.onMessage?.(t,e)},this.ws.onerror=e=>{this.handlers.onError?.(e)},this.ws.onclose=e=>{this.isConnected=!1,this.handlers.onClose?.(e)},this)}send(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return!1;const t=typeof e=="string"?e:JSON.stringify(e);return this.ws.send(t),!0}close(e,t){this.ws&&(this.ws.close(e,t),this.ws=null,this.isConnected=!1)}get connected(){return this.isConnected}get readyState(){return this.ws?.readyState||WebSocket.CLOSED}}function gt(){const r=h(),e=h({}),t=h(),s=h(),o=h(),n=h("unknown"),a=Q({started:!1,ended:!1,runningNodes:new Set,finishedNodes:new Set,errorNodes:new Set,nodeOutput:{}}),i=w=>{if(o.value?.connected&&!a.started){const l=w;if(l.type==="subscribe_response"&&l.success&&l.task_id&&l.workflow_id){t.value=l.task_id,s.value=l.workflow_id;return}else if(l.type==="trigger_response"&&l.success){a.started=!0,y.info("测试运行开始");return}y.error(l.error||"未知原因导致创建测试任务失败"),n.value="failed",d();return}else if(o.value?.connected&&a.started){const l=w;l.type==="workflow_start"&&!a.started?(a.started=!0,y.info("测试运行开始")):l.type==="node_start"&&l.node?a.finishedNodes.has(l.node)||a.runningNodes.add(l.node):l.type==="node_end"&&l.node?(a.runningNodes.delete(l.node),a.finishedNodes.add(l.node)):l.type==="node_stream_output"&&l.node&&((!(l.node in a.nodeOutput)||typeof a.nodeOutput[l.node]!="string")&&(a.nodeOutput[l.node]=""),a.nodeOutput[l.node]+=l.output||""),(l.type==="workflow_end"||l.is_end||l.is_error)&&(l.is_error?(y.error(`测试未通过：${l.output||"未知错误"}`),n.value="failed",l.node&&a.errorNodes.add(l.node)):(y.success("测试通过"),n.value="success"),d())}},m=()=>{o.value?.connected&&o.value.send({type:"subscribe_debug",workflow_config:G.dump(r.value),trigger_args:e.value})},k=()=>{o.value?.connected&&o.value.send({type:"unsubscribe",task_id:t.value??"all"})},d=()=>{k(),t.value=void 0,s.value=void 0,a.ended=!0,n.value==="running"&&(y.info("测试运行已停止"),n.value="unknown"),o.value&&o.value.close()},c=()=>{a.started=!1,a.ended=!1,a.runningNodes.clear(),a.finishedNodes.clear(),a.errorNodes.clear(),a.nodeOutput={}},_=async(w,l)=>{if(n.value==="running"){y.error("当前有测试正在进行中，请等待或手动将其停止");return}n.value="running",c();const L=`debug_${Date.now()}_${Math.random().toString(36).substring(2)}`;r.value={...w,version:L},e.value=l||{},o.value&&o.value.close();try{o.value=new mt(`${We()}`,{handlers:{onOpen:m,onMessage:i,onClose:d,onError:()=>{y.error("测试运行-连接出错"),d(),n.value="failed"}}}),o.value.connect()}catch{y.error("WebSocket连接出错"),d()}};return Re(d),{testStatus:n,record:a,resetRecord:c,startRunning:_,stopRunning:d}}const _t=N({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{d:"m7.375 16.781 1.25-1.562L4.601 12l4.024-3.219-1.25-1.562-5 4a1 1 0 0 0 0 1.562l5 4zm9.25-9.562-1.25 1.562L19.399 12l-4.024 3.219 1.25 1.562 5-4a1 1 0 0 0 0-1.562l-5-4zm-1.649-4.003-4 18-1.953-.434 4-18z"},child:[]}]}),wt=N({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{d:"M12 8v5h5v-2h-3V8z"},child:[]},{tag:"path",attr:{d:"M21.292 8.497a8.957 8.957 0 0 0-1.928-2.862 9.004 9.004 0 0 0-4.55-2.452 9.09 9.09 0 0 0-3.626 0 8.965 8.965 0 0 0-4.552 2.453 9.048 9.048 0 0 0-1.928 2.86A8.963 8.963 0 0 0 4 12l.001.025H2L5 16l3-3.975H6.001L6 12a6.957 6.957 0 0 1 1.195-3.913 7.066 7.066 0 0 1 1.891-1.892 7.034 7.034 0 0 1 2.503-1.054 7.003 7.003 0 0 1 8.269 5.445 7.117 7.117 0 0 1 0 2.824 6.936 6.936 0 0 1-1.054 2.503c-.25.371-.537.72-.854 1.036a7.058 7.058 0 0 1-2.225 1.501 6.98 6.98 0 0 1-1.313.408 7.117 7.117 0 0 1-2.823 0 6.957 6.957 0 0 1-2.501-1.053 7.066 7.066 0 0 1-1.037-.855l-1.414 1.414A8.985 8.985 0 0 0 13 21a9.05 9.05 0 0 0 3.503-.707 9.009 9.009 0 0 0 3.959-3.26A8.968 8.968 0 0 0 22 12a8.928 8.928 0 0 0-.708-3.503z"},child:[]}]}),yt=N({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{d:"M12 2C6.486 2 2 5.589 2 10c0 2.908 1.898 5.515 5 6.934V22l5.34-4.005C17.697 17.852 22 14.32 22 10c0-4.411-4.486-8-10-8zm0 14h-.333L9 18v-2.417l-.641-.247C5.67 14.301 4 12.256 4 10c0-3.309 3.589-6 8-6s8 2.691 8 6-3.589 6-8 6z"},child:[]},{tag:"path",attr:{d:"M7 7h10v2H7zm0 4h7v2H7z"},child:[]}]}),Ot={class:"input-hint"},Nt=ee({__name:"TestRunningDialog",props:de({startRunning:{type:Function}},{show:{type:Boolean},showModifiers:{}}),emits:["update:show"],setup(r){const e=pe(r,"show"),t=Ae(I.WORKFLOW_DATA),s=X().nodeSchemaMap,o=r,n=Z(()=>{for(const d of t?.value.nodes||[]){const c=s.get(d.type);if(c&&c.is_trigger)return c}}),a=Q({}),i=d=>{const c=n.value?.outputs?.[d]?.type;return!(c==="str"||c==="bool"||c==="float"||c==="int")};$(()=>n.value?.outputs,d=>{for(const c of Object.keys(a))delete a[c];if(d)for(const c of Object.keys(d))a[c]=""},{immediate:!0,deep:!0});const m=()=>{e&&(e.value=!1)},k=()=>{if(!t?.value||!n.value)return;const d={};for(const[c,_]of Object.entries(a)){if(!_.trim())continue;const w=n.value?.outputs?.[c];if(w)try{switch(w.type){case"str":d[c]=_;break;case"int":d[c]=parseInt(_);break;case"float":d[c]=parseFloat(_);break;case"bool":const l=_.toLowerCase();if(l==="true"||l==="1")d[c]=!0;else if(l==="false"||l==="0")d[c]=!1;else throw new Error(`布尔值格式错误: ${_}`);break;default:d[c]=JSON.parse(_)}}catch(l){y.error(`解析${c}字段时出错: ${l.message}`);return}}o.startRunning(t.value,d),m()};return(d,c)=>{const _=ve,w=je,l=$e,L=me,E=C;return S(),W(v(he),{modelValue:e.value,"onUpdate:modelValue":c[0]||(c[0]=T=>e.value=T),title:"测试运行 · 模拟触发","align-center":""},{default:p(()=>[n.value?(S(),W(l,{key:0,model:a,"label-position":"right","label-width":"auto"},{default:p(()=>[H("p",Ot," 请提供"+F(n.value.name)+"的模拟输出（复杂数据格式需以JSON格式书写） ",1),(S(!0),fe(He,null,Fe(Object.keys(a),T=>(S(),W(w,{label:T},{default:p(()=>[f(_,{placeholder:"请输入："+(n.value?.outputs?.[T]?.type??"未知类型"),type:i(T)?"textarea":"text",modelValue:a[T],"onUpdate:modelValue":j=>a[T]=j},null,8,["placeholder","type","modelValue","onUpdate:modelValue"])]),_:2},1032,["label"]))),256))]),_:1},8,["model"])):(S(),W(L,{key:1,icon:"warning",title:"不可测试","sub-title":"当前工作流没有Trigger类型节点，暂不支持测试运行"}))]),footer:p(()=>[f(E,{onClick:m},{default:p(()=>[...c[1]||(c[1]=[M("取消",-1)])]),_:1}),n.value?(S(),W(E,{key:0,onClick:k,type:"primary"},{default:p(()=>[...c[2]||(c[2]=[M("运行",-1)])]),_:1})):Le("",!0)]),_:1},8,["modelValue"])}}}),Et=ue(Nt,[["__scopeId","data-v-22429d66"]]),kt=ee({__name:"SaveVersionDialog",props:de({save:{type:Function}},{show:{type:Boolean},showModifiers:{}}),emits:["update:show"],setup(r){const e=pe(r,"show"),t=r,s=h(""),o=()=>{e.value=!1},n=async()=>{if(!s.value){y.error("请输入版本名称");return}await t.save(s.value)&&o()};return(a,i)=>{const m=ve,k=C,d=he;return S(),W(d,{modelValue:e.value,"onUpdate:modelValue":i[1]||(i[1]=c=>e.value=c),title:"设置保存版本名","align-center":""},{default:p(()=>[f(m,{modelValue:s.value,"onUpdate:modelValue":i[0]||(i[0]=c=>s.value=c),placeholder:"新版本名称需要未使用过"},null,8,["modelValue"])]),footer:p(()=>[f(k,{type:"primary",onClick:n},{default:p(()=>[...i[2]||(i[2]=[M("保存",-1)])]),_:1}),f(k,{onClick:o},{default:p(()=>[...i[3]||(i[3]=[M("取消",-1)])]),_:1})]),_:1},8,["modelValue"])}}}),Tt={class:"workflow-detail-container"},It={class:"workflow-title"},bt={class:"workflow-name"},St={class:"workflow-version"},Dt={class:"action-buttons"},Ct=ee({__name:"WorkflowStudio",setup(r){const e=xe(()=>Se(()=>import("./WorkflowEditor-D8-6OZ8Y.js").then(g=>g.W),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12]),import.meta.url)),t=Ve(),s=ze(),o=X().synchronizing,{startRunning:n,stopRunning:a,testStatus:i,record:m,resetRecord:k}=gt(),d=h(!0),c=h(""),_=h(!1),w=h(!1),l=h(!1),L=Z(()=>i.value==="unknown"?{tooltip:"当前版本尚未测试",badgeType:"warning"}:i.value==="success"?{tooltip:"上次测试通过",badgeType:"success"}:i.value==="running"?{tooltip:"测试运行中",badgeType:"warning"}:{tooltip:"上次测试失败",badgeType:"danger"}),E=h({name:"",version:"0",nodes:[]}),T=h(""),j=h(""),te=h(!0),oe=h(new Map),R=h(!1),P=h(!1),x=h(!1),B=h(!1),ge=h(!1),K=h(!1),q=h(!1),ae=X().nodeSchemaMap,_e=Z(()=>t.params.id),ne=Be();b(I.WORKFLOW_DATA,E),b(I.WORKFLOW_NEED_LAYOUT,te),b(I.NODE_DATA_MAP,oe),b(I.IS_EDIT_MODE,R),b(I.EMITTER,ne),b(I.TRACE_OPEN,P),b(I.FEEDBACK_OPEN,x),b(I.RAW_JSON_OPEN,B),b(I.CREATE_NEW_NODE_OPEN,ge),b(I.TEST_RUNNING_RECORD,m),$(E,()=>{l.value?w.value=!0:l.value=!0,k(),i.value="unknown"},{deep:!0}),$([()=>E?.value,ae],()=>{E?.value&&(oe.value=rt(E.value,ae))},{immediate:!0,deep:!0}),$(i,g=>{g==="running"&&(R.value=!1)});const se=async()=>{l.value=!1,d.value=!0,c.value="";try{const g=await Y.get(`/workflow/${_e.value}/status`,{base:le()});g.config&&(E.value=g.config),T.value=g.version??"",j.value=g.description??""}catch(g){c.value=g?.message||"加载工作流数据失败",console.error("Failed to load workflow data:",g)}finally{d.value=!1,setTimeout(()=>{te.value=!0},5)}},we=()=>{ne.on("previewJson",g=>{try{E.value=G.load(g)}catch(O){console.error("Failed to parse preview YAML:",O)}})},ye=async()=>{let g=!0;w.value&&await Ge.confirm("你有未保存的更改，是否继续退出？","提醒",{confirmButtonText:"继续退出",cancelButtonText:"取消",type:"warning"})==="cancel"&&(g=!1),g&&await s.push({name:"workflow-list"})},Oe=()=>{P.value=!P.value},Ne=()=>{x.value=!x.value},Ee=()=>{B.value=!B.value},ke=()=>{R.value=!R.value},Te=async g=>{if(_.value)return!1;if(w.value&&i.value!=="success")return y.warning("更新之后尚未试运行通过，不可保存"),!1;_.value=!0;try{const O=G.dump({...E.value,version:g||T.value},{indent:2}),D=new FormData;D.append("config_content",O);const A=await Y.post("/workflow/upload",D,{base:le()});if(A.success)if(w.value=!1,A.workflow_id){const z=s.resolve({name:"workflow-studio",params:{id:A.workflow_id}}),J=window.location.origin+window.location.pathname+z.href;y.success({message:ce("div",{style:"display: flex; align-items: center; gap: 4px;"},["工作流保存成功，前往查看",ce(Xe,{href:J,type:"primary",target:"_blank"},()=>"新版本")])})}else y.success("工作流保存成功");else y.error(A.message||"保存工作流失败")}catch(O){return y.error(O?.message||"保存工作流失败"),console.error("Failed to save workflow:",O),!1}finally{_.value=!1}return!0},Ie=async()=>{i.value==="running"?a():K.value=!0};return Pe(()=>{we(),se()}),(g,O)=>{const D=Ye,A=Je,z=Ze,J=Ke,be=me,re=qe;return S(),fe("div",Tt,[f(J,{onBack:ye,title:"返回列表",class:"navbar"},{content:p(()=>[H("div",It,[H("span",bt,F(E.value.name),1),H("span",St,"版本: "+F(T.value),1)])]),extra:p(()=>[H("div",Dt,[f(A,null,{default:p(()=>[f(D,{content:"运行记录"},{default:p(()=>[f(v(C),{icon:v(wt),onClick:Oe,type:P.value?"primary":"default"},null,8,["icon","type"])]),_:1}),f(D,{content:"反馈列表"},{default:p(()=>[f(v(C),{icon:v(yt),onClick:Ne,type:x.value?"primary":"default"},null,8,["icon","type"])]),_:1}),f(D,{content:"配置文本"},{default:p(()=>[f(v(C),{icon:v(_t),onClick:Ee,type:B.value?"primary":"default"},null,8,["icon","type"])]),_:1})]),_:1}),f(A,null,{default:p(()=>[f(D,{content:"保存"},{default:p(()=>[f(v(C),{icon:v(et),onClick:O[0]||(O[0]=U=>q.value=!0),loading:_.value},{default:p(()=>[f(z,{"is-dot":"",hidden:!w.value},{default:p(()=>[M(F(_.value?"保存中":w.value?"未保存":"已保存"),1)]),_:1},8,["hidden"])]),_:1},8,["icon","loading"])]),_:1}),f(D,{content:L.value.tooltip},{default:p(()=>[f(v(C),{icon:v(at),type:v(i)==="running"?"primary":"default",onClick:Ie},{default:p(()=>[f(z,{"is-dot":"",hidden:v(i)==="unknown"&&!w.value,type:L.value.badgeType},{default:p(()=>[M(F(v(i)==="running"?"停止":"试运行"),1)]),_:1},8,["hidden","type"])]),_:1},8,["icon","type"])]),_:1},8,["content"]),f(D,{content:"切换模式"},{default:p(()=>[f(v(C),{icon:R.value?v(tt):v(ot),onClick:ke,type:R.value?"primary":"default",disabled:v(i)==="running"},{default:p(()=>[M(F(R.value?"编辑模式":"查看模式"),1)]),_:1},8,["icon","type","disabled"])]),_:1})]),_:1})])]),_:1}),c.value?ie((S(),W(be,{key:0,icon:"error","sub-title":"加载工作流失败",class:"error-overlay"},{extra:p(()=>[f(v(C),{type:"primary",onClick:se},{default:p(()=>[...O[3]||(O[3]=[M("重新加载",-1)])]),_:1})]),_:1})),[[re,d.value||v(o)]]):ie((S(),W(v(e),{key:1},null,512)),[[re,d.value]]),f(Et,{show:K.value,"onUpdate:show":O[1]||(O[1]=U=>K.value=U),"start-running":v(n)},null,8,["show","start-running"]),f(kt,{show:q.value,"onUpdate:show":O[2]||(O[2]=U=>q.value=U),save:Te},null,8,["show"])])}}}),Wt=ue(Ct,[["__scopeId","data-v-c6667d1d"]]),Jt=Object.freeze(Object.defineProperty({__proto__:null,default:Wt},Symbol.toStringTag,{value:"Module"}));export{xt as A,wt as B,u as G,I as W,Pt as a,jt as b,yt as c,_t as d,zt as e,Ut as f,Bt as g,$t as h,Kt as i,Jt as j,qt as l,X as u};
