PROTO_DIR = proto
GO_OUT_DIR = .
PY_OUT_DIR = .
PROTO_FILES = $(shell find $(PROTO_DIR) -name "*.proto")
TOPIC_TOOL = python parse_topics.py

# === check ===
check:
	@echo "ğŸ” Checking topics.yaml..."
	@$(TOPIC_TOOL) check

# === proto ç”Ÿæˆï¼ˆä¾èµ– checkï¼‰ ===
gen-proto-go: clean check
	@echo "ğŸ“¦ Generating Go protobuf files..."
	@mkdir -p $(GO_OUT_DIR)
	@for file in $(shell find $(PROTO_DIR) -name "*.proto"); do \
		protoc \
			--proto_path=$(PROTO_DIR) \
			--go_out=$(GO_OUT_DIR) \
			--go_opt=paths=source_relative \
			$$file; \
	done

gen-proto-python: clean check
	@echo "ğŸ Generating Python protobuf files..."
	@mkdir -p $(PY_OUT_DIR)
	@for file in $(shell find $(PROTO_DIR) -name "*.proto"); do \
		protoc \
			--proto_path=$(PROTO_DIR) \
			--pyi_out=$(PY_OUT_DIR) \
			--python_out=$(PY_OUT_DIR) \
			$$file; \
	done

# === å¸¸é‡ç”Ÿæˆï¼ˆä¾èµ– checkï¼‰ ===
gen-const-go: clean check
	@echo "ğŸ”§ Generating Go topic constants..."
	@$(TOPIC_TOOL) gen-const --lang=go

gen-const-python: clean check
	@echo "ğŸ”§ Generating Python topic constants..."
	@$(TOPIC_TOOL) gen-const --lang=python

# === æ–‡æ¡£ç”Ÿæˆï¼ˆä¾èµ– checkï¼‰ ===
gen-doc: check
	@echo "ğŸ”§ Generating Docs..."
	@$(TOPIC_TOOL) gen-doc > README.md

# === åˆ é™¤ç”Ÿæˆçš„ä»£ç ï¼Œç”¨äºé‡æ–°ç”Ÿæˆ ===
clean:
	@echo "ğŸ§¹ Cleaning generated files..."
	@find . -mindepth 1 -maxdepth 1 -type d ! -name proto ! -name '.*' -exec rm -rf {} +
	@rm -f topics.go topics.py
# === ä¸€é”®ç”Ÿæˆ ===
all: check gen-proto-go gen-proto-python gen-const-go gen-const-python gen-doc