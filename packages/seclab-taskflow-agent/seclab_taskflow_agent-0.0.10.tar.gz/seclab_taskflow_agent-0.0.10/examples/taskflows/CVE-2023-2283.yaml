# SPDX-FileCopyrightText: 2025 GitHub
# SPDX-License-Identifier: MIT

seclab-taskflow-agent:
  version: 1
  filetype: taskflow

model_config: examples.model_configs.model_config

taskflow:
  - task:
      must_complete: true
      headless: true
      agents:
        - seclab_taskflow_agent.personalities.assistant
      user_prompt: |
        Clear the memory cache.
      toolboxes:
        - seclab_taskflow_agent.toolboxes.memcache
  - task:
      model: gpt_latest
      must_complete: false
      agents:
        - seclab_taskflow_agent.personalities.c_auditer
      user_prompt: |
        You are auditing code using the `libssh-mirror/libssh-codeql`
        CodeQL database.

        This database is built for a C project named `libssh`. This project
        provides an implementation of the Secure Shell protocol (SSH).

        ## IMPORTANT: Vulnerability Pattern Details
        
        Review the file `pki_crypto.c` for the security vulnerabilities
        described as follows:

        We are looking for a specific kind of authentication
        bypass. Specifically we want to know if, in the reviewed C source
        code, the function `pki_verify_data_signature` can return `SSH_OK` via
        a code path that SHOULD actually return `SSH_ERROR`. The return value
        of `pki_verify_data_signature` is set in the `rc` variable.

        Enumerate every function called inside `pki_verify_data_signature`
        that assigns a result to `rc`. Explicitly list these functions for
        the user as part of your analysis.

        Consider the following for each of these function calls:

          - `rc` is initialized to `SSH_ERROR`
          - `rc` becomes `SSH_OK` when a function call assigning to it succeeds
          - reaching a `goto out` statement due to a subsequent error without explictly
            setting `rc` to `SSH_ERROR` is a potential vulnerability.

        ## IMPORTANT: Vulnerability Pattern Analysis
        
        Provide examples of the code describing the error conditions that may
        result in reaching a `goto out` statement without updating `rc` to
        `SSH_ERROR`.

        Explore all error conditions that may result in this vulnerability
        pattern.

        ## IMPORTANT: General Guidance that ALWAYS applies

        1. Do NOT use the `list_functions` tool.

        2. Do NOT ask the user for permission to perform next steps, continue your
        analysis autonomously until it is complete.
        
        3. Reflect on your analysis for accuracy before returning it to the user.
        We are only interested in results that you can clearly explain and
        motivate as potentially vulnerable based on code examples.

        4. Do NOT speculate. All answers should be motivated by code examples and
        match the conditions of our described vulnerability pattern. Call out
        any situation where you are unsure about your results.

        5. Keep a log of your auditing notes in the `notes` key of the memory
          cache. Update it with additional information as needed.

        6. Make small and concise single line notes while you work. Update the
        existing value for `notes` in memory as you work.
      toolboxes:
        - seclab_taskflow_agent.toolboxes.codeql
        - seclab_taskflow_agent.toolboxes.memcache
  - task:
      must_complete: true
      agents:
        - seclab_taskflow_agent.personalities.c_auditer
      user_prompt: |
        Fetch your audit notes from memory using the `notes`
        key. Do not perform any additional security review, only show me your
        notes.
      toolboxes:
        - seclab_taskflow_agent.toolboxes.memcache
