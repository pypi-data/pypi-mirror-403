#!/usr/bin/env python
"""Test parsing as generic message vs typed message"""
import binascii
from diameter.message import Message
from diameter.message.avp import Avp

hex_str = "010004704000011001000016a02cd02ccce2aeb4000001074000002a737472696e673b3439303b3032323b494d53493939393939313233343536373831300000000001024000000c01000016000001084000001b74766d2d76706372662e6d61676d612e636f6d0000000128400000116d61676d612e636f6d0000000000010c4000000c000007d1000001a04000000c000000010000019f4000000c00000000000001160000000c608fad23000003ffc0000010000028af00000002000003eec0000010000028af00000001000003e9c0000294000028af000003ebc0000228000028af000003edc0000019000028af44454641554c54312d51434939000000000001b74000000c0000003b000001b04000000c0000000900000422c0000074000028af000001fbc0000046000028af7065726d697420696e2031372066726f6d203137322e31372e3234312e32353520746f203137322e31362e32302e3131312f33322031393030300000000003f6c000000e000028af68fc000000000438c0000010000028af0000000200000422c0000074000028af000001fbc0000047000028af7065726d6974206f75742031372066726f6d203137322e31362e32302e3131312f333220746f203137322e31372e3234312e32353520313730303000000003f6c000000e000028af68fc000000000438c0000010000028af00000001000001ffc0000010000028af00000002000003f8c0000098000028af00000404c0000010000028af0000000900000204c0000010000028af00003e8000000203c0000010000028af00002fa80000040ac000003c000028af00000416c0000010000028af0000000900000417c0000010000028af0000000000000418c0000010000028af000000000000041180000010000028af02cd29c00000041080000010000028af05c81a40000003efc0000010000028af00000001000003f2c0000010000028af00000001000003f1c0000010000028af00000001000003f0c0000010000028af00000000000001b2400000180000043e80000010000028af00000000000003edc000001e000028af5043433130302d514349312d5354415449430000000003edc000001e000028af5043433130312d514349322d5354415449430000000003edc000001e000028af5043433130322d514349332d5354415449430000000003f1c0000010000028af00000001000003f0c0000010000028af00000000000003f8c0000098000028af00000404c0000010000028af0000000900000204c0000010000028af00003e8000000203c0000010000028af00002fa80000040ac000003c000028af00000416c0000010000028af0000000900000417c0000010000028af0000000000000418c0000010000028af000000000000041180000010000028af02cd29c00000041080000010000028af05c81a4000000419c0000058000028af00000404c0000010000028af000000090000040ac000003c000028af00000416c0000010000028af0000000900000417c0000010000028af0000000000000418c0000010000028af00000000"

data = binascii.unhexlify(hex_str)

print("=== Parsing with Message.from_bytes ===")
msg = Message.from_bytes(data)
print(f"Type: {type(msg)}")
print(f"_avps count: {len(msg._avps) if hasattr(msg, '_avps') else 'N/A'}")

# Try to manually parse AVPs
print("\n=== Manual AVP parsing ===")
# Skip header (20 bytes)
avp_data = data[20:]
offset = 0
avp_count = 0

while offset < len(avp_data) - 8:  # At least 8 bytes for AVP header
    # AVP Header: code(4), flags(1), length(3)
    code = int.from_bytes(avp_data[offset:offset+4], 'big')
    flags = avp_data[offset+4]
    length = int.from_bytes(avp_data[offset+5:offset+8], 'big')
    
    vendor_id = None
    if flags & 0x80:  # Vendor bit
        vendor_id = int.from_bytes(avp_data[offset+8:offset+12], 'big')
        
    print(f"AVP #{avp_count}: code={code}, flags=0x{flags:02x}, length={length}, vendor={vendor_id}")
    
    # Move to next AVP (with padding)
    padded_length = (length + 3) & ~3  # Round up to multiple of 4
    offset += padded_length
    avp_count += 1
    
    if avp_count > 5:  # Limit output
        print("...")
        break
