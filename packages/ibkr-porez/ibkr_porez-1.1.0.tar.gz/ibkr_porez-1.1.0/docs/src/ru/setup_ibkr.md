# Настройка Interactive Brokers (IBKR)

Чтобы использовать `ibkr-porez`, необходимо настроить **Flex Query** в вашем аккаунте Interactive Brokers. Это позволит инструменту автоматически загружать историю ваших транзакций.

## 1. Включите Flex Web Service

1.  Войдите в **Interactive Brokers** (Управление счетом).
2.  Перейдите в **Performance & Reports** > **Flex Queries** (Эффективность и отчеты -> Flex-запросы).
3.  Нажмите на значок **Настроек** (шестеренка) (или найдите "Flex Web Service").
4.  Включите **Flex Web Service**.
5.  Сгенерируйте **Токен** (Generate Token).
    *   **Важно**: Скопируйте этот токен сразу. Вы не сможете увидеть его полностью снова.
    *   Установите срок действия (например, 1 год).

## 2. Создайте Flex Query (Flex-запрос)

1.  В **Performance & Reports** > **Flex Queries**, нажмите **+**, чтобы создать новый **Trade Confirmation Flex Query** (или "Activity Flex Query", но нам нужны конкретные разделы, см. ниже).
    *   *Примечание*: Обычно "Activity Flex Query" предпочтительнее для более полных данных, но проверьте разделы ниже.
2.  **Name** (Имя): например, `ibkr-porez-data`.
3.  **Delivery Configuration** (внизу страницы):
    *   **Period**: Выберите **Last 365 Calendar Days**.
    *   *Совет*: `ibkr-porez` загружает то, что доступно. Установка "Last 365 Calendar Days" стандартна для автоматизации.
4.  **Format** (Формат): **XML**.

### Разделы для включения (Sections):

Включите следующие разделы и отметьте **Select All** (Выбрать все) для колонок, чтобы обеспечить совместимость (или как минимум выберите обязательные поля, перечисленные ниже).

#### A. Trades (Executions) - Сделки
*   **Выберите**: `Trades` (находится в разделе Trade Confirmations или Activity).
*   **Обязательные колонки**:
    *   `Symbol`
    *   `Description`
    *   `Currency`
    *   `Quantity`
    *   `TradePrice` (или Price)
    *   `TradeDate` (Date)
    *   `TradeID`
    *   `OrigTradeDate` (Необходимо для расчета P/L)
    *   `OrigTradePrice` (Необходимо для расчета P/L)
    *   `AssetClass` (рекомендуется)
    *   `Buy/Sell` (рекомендуется)

#### B. Cash Transactions - Денежные транзакции
*   **Выберите**: `Cash Transactions`.
*   **Обязательные колонки**:
    *   `Type` (например, Dividend, Withholding Tax)
    *   `Amount`
    *   `Currency`
    *   `DateTime` / `Date`
    *   `Symbol`
    *   `Description`
    *   `TransactionID`

## 3. Сохраните и получите Query ID

1.  Сохраните запрос.
2.  Запишите **Query ID** (число, которое обычно отображается рядом с именем запроса в списке).

Вам понадобятся **Token** и **Query ID** для настройки `ibkr-porez`.

## 4. Документ подтверждения (для налоговой)

Для **Пункта 8 (Докази уз пријаву)** налоговой декларации вам потребуется PDF-отчет от брокера. `ibkr-porez` создает XML-файл с плейсхолдером (ссылкой на место для файла), но сам файл доказательства вы должны скачать и прикрепить вручную на портале ePorezi.

Как скачать подходящий отчет:

1.  В IBKR перейдите в **Performance & Reports** > **Statements** > **Activity**.
2.  **Period**: Выберите **Custom Date Range**.
3.  Укажите даты, соответствующие вашему налоговому периоду (например, `01-01-2024` по `30-06-2024` для первого полугодия).
4.  **Format**: **PDF**.
5.  Нажмите **Run**.
6.  Скачайте полученный PDF.
7.  На портале ePorezi, в разделе **8. Докази уз пријаву**, удалите плейсхолдер (если есть) и загрузите этот файл.

## 5. Экспорт всей истории (для команды import)

Если вам нужно загрузить историю транзакций за период более 1 года (что недоступно через обычный Flex Web Service), используйте экспорт CSV:

1.  В IBKR перейдите в **Performance & Reports** > **Statements** > **Activity**.
2.  **Period**: Выберите **Complete Date Range** или **Custom Date Range** (укажите весь период с момента открытия счета).
3.  **Format**: **CSV**.
4.  Нажмите **Run**.
5.  Скачайте файл. Этот файл можно использовать с командой `ibkr-porez import`.
