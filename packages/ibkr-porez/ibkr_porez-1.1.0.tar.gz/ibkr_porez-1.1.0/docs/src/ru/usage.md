# Руководство пользователя

## Установка

Предварительные требования:
*   Python 3.10+
*   `uv` или `pip`

```bash
# Клонирование репозитория
git clone https://github.com/andgineer/ibkr-porez.git
cd ibkr-porez

# Установка
uv sync
# ИЛИ
pip install .
```

## Настройка

Перед первым использованием запустите команду конфигурации, чтобы сохранить учетные данные IBKR и личные данные.

```bash
ibkr-porez config
```

Вам будет предложено ввести:
*   **IBKR Flex Token**: (Из настроек IBKR)
*   **IBKR Query ID**: (Из вашего Flex-запроса)
*   **Personal ID**: (JMBG для налоговых форм)
*   **Full Name**: (Полное имя для налоговых форм)
*   **Address**: (Адрес для налоговых форм)
*   **City Code**: 3-значный код муниципалитета. Пример: `223` (Нови Сад). Код можно найти в [справочнике](https://www.apml.gov.rs/uploads/useruploads/Documents/1533_1_pravilnik-javni_prihodi_prilog-3.pdf) (смотрите колонку "Шифра"). Также код доступен в выпадающем списке на портале ePorezi.
*   **Phone**: (Телефон для контакта)
*   **Email**: (Email для контакта)

## 1. Получение данных (`get`)

Загружает последние данные из IBKR и синхронизирует курсы валют с НБС (Национальный банк Сербии).

```bash
ibkr-porez get

# Принудительное полное обновление (игнорировать локальную историю и загрузить последние 365 дней)
ibkr-porez get --force
```

*   Загружает XML-отчет, используя ваши Token и Query ID.
*   Парсит новые транзакции (Сделки, Дивиденды).
*   Сохраняет их в локальное хранилище.
*   Получает исторические курсы валют для всех дат транзакций.
*   **По умолчанию**: Загружает данные инкрементально (только новые транзакции с момента последней загрузки).
*   **--force**: используйте это, если хотите обновить старые данные.

## 2. Просмотр статистики (`show`)

Отображает сводку активности портфеля с группировкой по месяцам.

```bash
ibkr-porez show
```

Показывает:
*   Полученные дивиденды (в RSD).
*   Количество продаж (налогооблагаемых событий).
*   Оценку реализованного P/L (Капитальный доход) (в RSD).

## 4. Генерация налогового отчета (`report`)

Генерирует XML-файл PPDG-3R для Налоговой администрации Сербии.

```bash
# Отчет за первое полугодие 2024 (1 янв - 30 июн)
ibkr-porez report --year 2024 --half 1

# Отчет за второе полугодие 2024 (1 июл - 31 дек)
ibkr-porez report --year 2024 --half 2
```

*   **Результат**: `ppdg3r_2024_H1.xml`
*   Импортируйте этот файл на портал Налоговой администрации Сербии (ePorezi).

## Устранение неполадок

*   **Отсутствуют данные**: Убедитесь, что ваш Flex Query в IBKR настроен на охват соответствующих дат (например, "Last 365 Days").
*   **Курсы валют**: Если сайт НБС недоступен, инструмент может не конвертировать валюты. Попробуйте снова позже.
