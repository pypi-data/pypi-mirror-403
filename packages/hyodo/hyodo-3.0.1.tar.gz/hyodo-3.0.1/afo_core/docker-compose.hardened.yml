# AFO Kingdom Docker Compose - Security Hardened
# 眞善美孝永 - CIS Benchmark Level 2 Compliant

# ═══════════════════════════════════════════════════════════════════════════════
# Security Anchor (YAML Reference for DRY)
# ═══════════════════════════════════════════════════════════════════════════════
x-common-security: &common-security
  read_only: true                  # 善: filesystem read-only
  security_opt:
    - no-new-privileges:true       # 善: 새 권한 획득 금지
  # cap_drop:
  #   - ALL                          # 善: 모든 capability 제거 - DISABLED for init
  restart: unless-stopped          # 永: 자동 복구

x-healthcheck-default: &healthcheck-default
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 10s

services:
  # ═══════════════════════════════════════════════════════════════════════════════
  # Infrastructure Services (Databases, Caches)
  # ═══════════════════════════════════════════════════════════════════════════════
  postgres:
    image: postgres:15-alpine
    container_name: afo-postgres
    # user: "999:999"                  # 善: non-root (postgres UID) - DISABLED for macOS permission fix
    environment:
      POSTGRES_DB: afo_memory
      POSTGRES_USER: afo
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-your-secure-password-here}
    ports:
      - "15432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
      - /var/run/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U afo -d afo_memory -q"]
      <<: *healthcheck-default
    networks:
      - backend
    <<: *common-security

  redis:
    image: redis:7.2-alpine
    container_name: afo-redis
    user: "999:999"                  # 善: non-root
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    tmpfs:
      - /tmp:noexec,nosuid,size=50m
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      <<: *healthcheck-default
    networks:
      - backend
    <<: *common-security

  qdrant:
    image: qdrant/qdrant:v1.13.0
    container_name: afo-qdrant
    # user: "1000:1000"                # 善: non-root (Temporarily disabled for macOS permissions)
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    networks:
      - backend
    # <<: *common-security             # Disabled for stability

  neo4j:
    image: neo4j:5-community
    container_name: afo-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data
    environment:
      - NEO4J_AUTH=neo4j/password
    networks:
      - backend
    # <<: *common-security             # Disabled for stability

  # ═══════════════════════════════════════════════════════════════════════════════
  # Monitoring Stack (Profile-Based Activation)
  # ═══════════════════════════════════════════════════════════════════════════════
  prometheus:
    image: prom/prometheus:latest
    container_name: afo-prometheus
    profiles: ["monitoring", "production"]
    user: "65534:65534"              # 善: nobody user
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - monitoring
    <<: *common-security

  grafana:
    image: grafana/grafana:latest
    container_name: afo-grafana
    profiles: ["monitoring", "production"]
    user: "472:472"                  # 善: grafana user
    ports:
      - "3001:3000"                  # 善: 3000 양보 → Next.js Dashboard
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - monitoring
      - frontend
    <<: *common-security

  alertmanager:
    image: prom/alertmanager:latest
    container_name: afo-alertmanager
    profiles: ["monitoring", "production"]
    user: "65534:65534"              # 善: nobody user
    ports:
      - "9093:9093"
    volumes:
      - ./monitoring/alertmanager.yml:/etc/alertmanager/config.yml:ro
    command:
      - '--config.file=/etc/alertmanager/config.yml'
      - '--storage.path=/alertmanager'
    networks:
      - monitoring
    <<: *common-security

  # ═══════════════════════════════════════════════════════════════════════════════
  # Core AFO Microservices
  # ═══════════════════════════════════════════════════════════════════════════════
  soul-engine:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: afo-soul-engine
    user: "1000:1000"                # 善: non-root
    ports:
      - "8010:8010"
    environment:
      - SERVICE_NAME=soul-engine
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - OLLAMA_MODEL=qwen3-vl:8b
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://afo:${POSTGRES_PASSWORD}@postgres:5432/afo_memory
      - PYTHONPATH=/AFO
    working_dir: /AFO
    volumes:
      - .:/AFO:ro                    # 善: read-only mount
      - ../../AGENTS.md:/AGENTS.md:ro # 眞: SSOT (Kingdom Constitution)
      - afo_data:/data               # 永: Persistence for Family Hub
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    depends_on:
      - redis
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      <<: *healthcheck-default
    networks:
      - backend
      - frontend
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
    <<: *common-security

  rag-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: afo-rag-service
    user: "1000:1000"                # 善: non-root
    ports:
      - "8001:8001"
    environment:
      - SERVICE_NAME=rag-service
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - PYTHONPATH=/AFO
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://afo:${POSTGRES_PASSWORD}@postgres:5432/afo_memory
    command: ["python", "-m", "uvicorn", "api_server:app", "--host", "0.0.0.0", "--port", "8001"]
    depends_on:
      - redis
      - qdrant
    working_dir: /AFO
    volumes:
      - .:/AFO:ro                    # 善: read-only mount
      - afo_data:/data               # 永: Persistence for RAG (mirrors soul-engine)
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      <<: *healthcheck-default
    networks:
      - backend
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
    <<: *common-security

  # ═══════════════════════════════════════════════════════════════════════════════
  # External Tools Integration
  # ═══════════════════════════════════════════════════════════════════════════════
  # 善: Unused in Soul Engine (Uses Host Ollama). Disabled to save 4GB RAM.
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: afo-ollama
  #   ports:
  #     - "11435:11434"
  #   volumes:
  #     - ollama_data:/root/.ollama
  #   environment:
  #     - OLLAMA_HOST=0.0.0.0
  #     - OLLAMA_NUM_PARALLEL=1
  #     - OLLAMA_MAX_LOADED_MODELS=1
  #     - OLLAMA_KEEP_ALIVE=5m
  #     - OLLAMA_NUM_CTX=2048
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 4G
  #         cpus: "4.0"
  #   healthcheck:
  #     test: ["CMD", "ollama", "list"]
  #     <<: *healthcheck-default
  #   networks:
  #     - backend
  #   restart: unless-stopped

# ═══════════════════════════════════════════════════════════════════════════════
# Networks - 善: Isolated by Design
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    # internal: true                   # 善: DB 외부 접근 완전 차단 (Disabled for Verify Skill)
  monitoring:
    driver: bridge
    # internal: true                   # 善: 모니터링 격리 (Disabled for Verify Skill)

# ═══════════════════════════════════════════════════════════════════════════════
# Volumes - 永: Persistent Storage
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  postgres_data:
  redis_data:
  qdrant_data:
  neo4j_data:
  grafana_data:
  ollama_data:
  afo_data:
