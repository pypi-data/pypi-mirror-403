# AFO Kingdom Alerting Rules
# Prometheus Alertmanager Rules

groups:
  - name: afo-kingdom-critical
    interval: 30s
    rules:
      # ============================================================
      # Circuit Breaker Alerts
      # ============================================================
      - alert: CircuitBreakerOpen
        expr: afo_circuit_breaker_state{service="ollama"} == 1
        for: 1m
        labels:
          severity: critical
          service: ollama
        annotations:
          summary: "ğŸš¨ Ollama Circuit Breaker OPEN"
          description: "ì—°ì† ì‹¤íŒ¨ë¡œ Ollama ì„œë¹„ìŠ¤ê°€ ì°¨ë‹¨ëìŠµë‹ˆë‹¤. ìë™ ë³µêµ¬ ëŒ€ê¸° ì¤‘..."
          runbook_url: "https://docs.afo-kingdom.local/runbooks/circuit-breaker"

      - alert: CircuitBreakerHalfOpen
        expr: afo_circuit_breaker_state{service="ollama"} == 2
        for: 30s
        labels:
          severity: warning
          service: ollama
        annotations:
          summary: "ğŸ”„ Ollama ë³µêµ¬ ì‹œë„ ì¤‘"
          description: "Circuit Breakerê°€ HALF_OPEN ìƒíƒœì…ë‹ˆë‹¤. ë³µêµ¬ í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘..."

      # ============================================================
      # Ollama Service Alerts
      # ============================================================
      - alert: OllamaHighFailureRate
        expr: |
          rate(afo_ollama_calls_total{status="failure"}[5m]) / 
          rate(afo_ollama_calls_total[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
          service: ollama
        annotations:
          summary: "ğŸ¤– Ollama ì‹¤íŒ¨ìœ¨ ê¸‰ì¦!"
          description: "ìµœê·¼ 5ë¶„ê°„ Ollama í˜¸ì¶œ ì‹¤íŒ¨ìœ¨ì´ {{ $value | humanizePercentage }}ì…ë‹ˆë‹¤."

      - alert: OllamaHighLatency
        expr: |
          histogram_quantile(0.95, 
            sum(rate(afo_ollama_request_duration_seconds_bucket[5m])) by (le, model)
          ) > 10
        for: 2m
        labels:
          severity: warning
          service: ollama
        annotations:
          summary: "âš¡ Ollama ì‘ë‹µ ì§€ì—°"
          description: "p95 ë ˆì´í„´ì‹œê°€ {{ $value }}ì´ˆì…ë‹ˆë‹¤. ëª¨ë¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."

      - alert: OllamaNoRequests
        expr: |
          rate(afo_ollama_calls_total[5m]) == 0
        for: 10m
        labels:
          severity: warning
          service: ollama
        annotations:
          summary: "âš ï¸ Ollama ìš”ì²­ ì—†ìŒ"
          description: "ìµœê·¼ 10ë¶„ê°„ Ollama í˜¸ì¶œì´ ì—†ìŠµë‹ˆë‹¤. ì„œë¹„ìŠ¤ê°€ ì •ìƒì¸ì§€ í™•ì¸í•˜ì„¸ìš”."

      # ============================================================
      # API Health Alerts
      # ============================================================
      - alert: APIHighErrorRate
        expr: |
          sum(rate(afo_http_requests_total{status_code=~"5.."}[5m])) / 
          sum(rate(afo_http_requests_total[5m])) > 0.05
        for: 2m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "ğŸ”¥ API 5xx ì—ëŸ¬ìœ¨ ê¸‰ì¦"
          description: "API 5xx ì—ëŸ¬ìœ¨ì´ {{ $value | humanizePercentage }}ì…ë‹ˆë‹¤."

      - alert: APIHighLatency
        expr: |
          histogram_quantile(0.95, 
            sum(rate(afo_http_request_duration_seconds_bucket[5m])) by (le, endpoint)
          ) > 2
        for: 5m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "âš¡ API ì‘ë‹µ ì§€ì—°"
          description: "{{ $labels.endpoint }} ì—”ë“œí¬ì¸íŠ¸ p95 ë ˆì´í„´ì‹œê°€ {{ $value }}ì´ˆì…ë‹ˆë‹¤."

      # ============================================================
      # Organ Health Alerts
      # ============================================================
      - alert: RedisDown
        expr: afo_organ_health{organ="redis"} == 0
        for: 1m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "ğŸ’” Redis ì—°ê²° ì‹¤íŒ¨"
          description: "Redis(å¿ƒ)ê°€ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."

      - alert: PostgresDown
        expr: afo_organ_health{organ="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          service: postgres
        annotations:
          summary: "ğŸ’” PostgreSQL ì—°ê²° ì‹¤íŒ¨"
          description: "PostgreSQL(è‚)ì´ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."

      - alert: OllamaDown
        expr: afo_organ_health{organ="ollama"} == 0
        for: 2m
        labels:
          severity: critical
          service: ollama
        annotations:
          summary: "ğŸ’” Ollama ì—°ê²° ì‹¤íŒ¨"
          description: "Ollama(è„¾)ê°€ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."

      # ============================================================
      # Trinity Score Alerts
      # ============================================================
      - alert: TrinityScoreLow
        expr: afo_trinity_score_total < 0.7
        for: 5m
        labels:
          severity: warning
          service: trinity
        annotations:
          summary: "âš–ï¸ Trinity Score ì €í•˜"
          description: "Trinity Scoreê°€ {{ $value }}ë¡œ ë–¨ì–´ì¡ŒìŠµë‹ˆë‹¤. ê· í˜•ì„ í™•ì¸í•˜ì„¸ìš”."

      - alert: TrinityPillarImbalance
        expr: |
          (max(afo_trinity_score) by (pillar) - min(afo_trinity_score) by (pillar)) > 0.3
        for: 5m
        labels:
          severity: warning
          service: trinity
        annotations:
          summary: "âš–ï¸ Trinity ê¸°ë‘¥ ë¶ˆê· í˜•"
          description: "çœå–„ç¾å­æ°¸ ê¸°ë‘¥ ê°„ ë¶ˆê· í˜•ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."

      # [Phase 6 Hardening] Critical Trinity Score Alert
      - alert: TrinityScoreCritical
        expr: afo_trinity_score_total < 0.9
        for: 2m
        labels:
          severity: critical
          service: trinity
        annotations:
          summary: "ğŸš¨ Trinity Score Critical - AUTO_RUN ë¶ˆê°€"
          description: "Trinity Score {{ $value }}ì´(ê°€) 90ì  ë¯¸ë§Œì…ë‹ˆë‹¤. ìˆ˜ë™ ìŠ¹ì¸ í•„ìš”."
          runbook_url: "https://docs.afo-kingdom.local/runbooks/trinity-critical"

      # [Phase 6 Hardening] Edge Revalidation Failure
      - alert: EdgeRevalidationFailure
        expr: |
          rate(afo_edge_revalidate_failures_total[5m]) > 0.1
        for: 3m
        labels:
          severity: warning
          service: edge
        annotations:
          summary: "âš¡ Edge Revalidation ì‹¤íŒ¨ìœ¨ ì¦ê°€"
          description: "ISR ì¬ê²€ì¦ ì‹¤íŒ¨ìœ¨ì´ {{ $value | humanizePercentage }}ì…ë‹ˆë‹¤."

      # [Phase 6 Hardening] SLA Violation (99.5% availability)
      - alert: SLAViolationRisk
        expr: |
          (1 - (sum(rate(afo_http_requests_total{status_code=~"2.."}[1h])) / 
           sum(rate(afo_http_requests_total[1h])))) > 0.005
        for: 10m
        labels:
          severity: critical
          service: sla
        annotations:
          summary: "ğŸ“Š SLA ìœ„ë°˜ ìœ„í—˜"
          description: "ì§€ë‚œ 1ì‹œê°„ ê°€ìš©ë¥ ì´ {{ $value | humanizePercentage }} ë¯¸ë§Œì…ë‹ˆë‹¤. SLA(99.5%) ìœ„ë°˜ ìœ„í—˜."

  # ============================================================
  # Lower Priority Alerts
  # ============================================================
  - name: afo-kingdom-warning
    interval: 1m
    rules:
      - alert: LLMRouterFallback
        expr: |
          rate(afo_llm_router_calls_total{provider!="ollama",status="success"}[5m]) > 0
        for: 5m
        labels:
          severity: info
          service: llm
        annotations:
          summary: "â„¹ï¸ LLM í´ë°± í™œì„±í™”"
          description: "Ollama ì™¸ ë‹¤ë¥¸ LLM ì œê³µì({{ $labels.provider }})ê°€ ì‚¬ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤."

      - alert: CRAGWebFallback
        expr: |
          rate(afo_crag_queries_total{status="web_fallback"}[5m]) > 0.5
        for: 5m
        labels:
          severity: info
          service: crag
        annotations:
          summary: "â„¹ï¸ CRAG ì›¹ ê²€ìƒ‰ í´ë°± ì¦ê°€"
          description: "ì§€ì‹ ë² ì´ìŠ¤ì—ì„œ ë‹µì„ ì°¾ì§€ ëª»í•´ ì›¹ ê²€ìƒ‰ì´ ìì£¼ ì‚¬ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤."

      - alert: MemorySystemHighUsage
        expr: |
          afo_memory_entries{store="short_term"} > 80
        for: 5m
        labels:
          severity: warning
          service: memory
        annotations:
          summary: "ğŸ§  ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œ ì‚¬ìš©ëŸ‰ ë†’ìŒ"
          description: "ë‹¨ê¸° ë©”ëª¨ë¦¬ì— {{ $value }}ê°œ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤. ì •ë¦¬ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."

  # ============================================================
  # SSE Health Alerts (PH-FH3)
  # ============================================================
  - name: sse-health-alerts
    interval: 30s
    rules:
      - alert: SSEConnectionDown
        expr: afo_sse_connection_status{status="down"} == 1
        for: 2m
        labels:
          severity: critical
          service: sse
        annotations:
          summary: "ğŸš¨ SSE ì—°ê²° ëŠê¹€ - ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨"
          description: "SSE ìŠ¤íŠ¸ë¦¼ì´ 60ì´ˆ ì´ìƒ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”."
          runbook_url: "https://docs.afo-kingdom.local/runbooks/sse-connection"

      - alert: SSEConnectionStale
        expr: afo_sse_connection_status{status="stale"} == 1
        for: 1m
        labels:
          severity: warning
          service: sse
        annotations:
          summary: "âš ï¸ SSE ì—°ê²° ì§€ì—° - ëª¨ë‹ˆí„°ë§ ì„±ëŠ¥ ì €í•˜"
          description: "SSE ìŠ¤íŠ¸ë¦¼ì´ 30ì´ˆ ì´ìƒ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë‚˜ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."

      - alert: SSEHighReconnectRate
        expr: |
          rate(afo_sse_reconnect_count_total[5m]) > 0.5
        for: 3m
        labels:
          severity: warning
          service: sse
        annotations:
          summary: "ğŸ”„ SSE ì¬ì—°ê²° ë¹ˆë„ ë†’ìŒ"
          description: "ìµœê·¼ 5ë¶„ê°„ SSE ì¬ì—°ê²° íšŸìˆ˜ê°€ {{ $value }}íšŒì…ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ë¶ˆì•ˆì • ê°€ëŠ¥ì„±."

      - alert: SSEZeroConnections
        expr: afo_sse_open_connections == 0
        for: 5m
        labels:
          severity: critical
          service: sse
        annotations:
          summary: "ğŸš¨ SSE ì—°ê²° ì—†ìŒ - ëª¨ë‹ˆí„°ë§ ì™„ì „ ì¤‘ë‹¨"
          description: "í™œì„±í™”ëœ SSE ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œê°€ ì œëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
          runbook_url: "https://docs.afo-kingdom.local/runbooks/sse-zero-connections"
