#!/bin/bash
set -e

# AFO Kingdom Pre-push Hook v2.0
# "ì„ í™•ì¸, í›„ë³´ê³ " - Optimized for speed with parallel execution
# çœå–„ç¾å­æ°¸ - TruthÂ·GoodnessÂ·BeautyÂ·SerenityÂ·Eternity

echo "ğŸ›¡ï¸  [Pre-push] Verifying Kingdom Integrity..."
START_TIME=$(date +%s)

# ============================================================================
# Configuration
# ============================================================================
TIMEOUT_LINT=60      # Lint timeout (seconds)
TIMEOUT_TEST=30      # Test timeout (seconds)
PARALLEL_JOBS=4      # Number of parallel jobs

# ============================================================================
# 1. Block direct push to main (Safety - å­ Serenity)
# ============================================================================
branch="$(git symbolic-ref --quiet --short HEAD || true)"
if [ "${ALLOW_MAIN_PUSH:-}" != "1" ] && [ "$branch" = "main" ]; then
    echo "âŒ [Error] Pushing to 'main' is restricted. Use a PR."
    # exit 1  # Temporarily disabled for solo dev velocity
fi

# ============================================================================
# 2. Parallel Lint Checks (çœ Truth + ç¾ Beauty)
# ============================================================================
echo "ğŸ” [Phase 1] Running parallel lint checks..."

# Create temp files for parallel results
LINT_RESULTS=$(mktemp)
trap "rm -f $LINT_RESULTS" EXIT

# Run lints in parallel with timeout
(
    # Ruff check (no fix)
    if command -v ruff >/dev/null 2>&1; then
        timeout $TIMEOUT_LINT ruff check --quiet 2>/dev/null && echo "ruff:pass" >> "$LINT_RESULTS" || echo "ruff:fail" >> "$LINT_RESULTS"
    fi
) &
PID_RUFF=$!

(
    # Ruff format check
    if command -v ruff >/dev/null 2>&1; then
        timeout $TIMEOUT_LINT ruff format --check --quiet 2>/dev/null && echo "format:pass" >> "$LINT_RESULTS" || echo "format:fail" >> "$LINT_RESULTS"
    fi
) &
PID_FORMAT=$!

(
    # Pyright (type check) - only changed files for speed
    if command -v pyright >/dev/null 2>&1; then
        timeout $TIMEOUT_LINT pyright --outputjson packages/afo-core/api/ 2>/dev/null | head -1 >/dev/null && echo "pyright:pass" >> "$LINT_RESULTS" || echo "pyright:warn" >> "$LINT_RESULTS"
    fi
) &
PID_PYRIGHT=$!

# Wait for all lint jobs
wait $PID_RUFF $PID_FORMAT $PID_PYRIGHT 2>/dev/null || true

# Check lint results
if grep -q "ruff:fail" "$LINT_RESULTS" 2>/dev/null; then
    echo "âš ï¸  [Warning] Ruff check found issues"
fi
if grep -q "format:fail" "$LINT_RESULTS" 2>/dev/null; then
    echo "âš ï¸  [Warning] Format check found issues"
fi
echo "âœ… [Phase 1] Lint checks completed"

# ============================================================================
# 3. Fast Smoke Tests (å–„ Goodness) - Critical path only
# ============================================================================
echo "ğŸ§ª [Phase 2] Running smoke tests (${TIMEOUT_TEST}s timeout)..."

if command -v pytest >/dev/null 2>&1; then
    # Run only smoke/critical tests with strict timeout
    # -x: stop on first failure, --tb=no: no traceback for speed
    timeout $TIMEOUT_TEST pytest \
        packages/afo-core/tests/test_trinity_unified.py \
        packages/afo-core/tests/test_health.py \
        -x --tb=no -q \
        2>/dev/null || echo "âš ï¸  [Warning] Smoke tests failed. Review before merging."
    echo "âœ… [Phase 2] Smoke tests completed"
else
    echo "âš ï¸  pytest not found. Skipping tests."
fi

# ============================================================================
# 4. Summary
# ============================================================================
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… [Pre-push] Kingdom integrity verified in ${DURATION}s"
echo "   Full test suite will run in CI/CD pipeline"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

exit 0
