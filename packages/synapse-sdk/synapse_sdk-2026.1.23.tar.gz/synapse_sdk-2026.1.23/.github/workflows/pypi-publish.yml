name: Publish to PyPI

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 2025.12.1b1 for beta)'
        required: true
        type: string
      publish_target:
        description: 'Publish target'
        required: true
        type: choice
        options:
          - testpypi
          - pypi
        default: testpypi

jobs:
  build-and-publish:
    name: Build and Publish to ${{ inputs.publish_target }}
    environment: release
    runs-on: runner-set
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Build package
        env:
          SETUPTOOLS_SCM_PRETEND_VERSION: ${{ inputs.version }}
        run: uv build

      - name: Publish to TestPyPI
        if: inputs.publish_target == 'testpypi'
        env:
          UV_PUBLISH_URL: https://test.pypi.org/legacy/
          UV_PUBLISH_TOKEN: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: uv publish

      - name: Publish to PyPI
        if: inputs.publish_target == 'pypi'
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: uv publish
