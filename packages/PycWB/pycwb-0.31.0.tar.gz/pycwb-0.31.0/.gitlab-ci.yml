image: buildpack-deps:jammy

stages:          # List of stages for jobs, and their order of execution
  - build
  - test
  - deploy


include:
  - component: git.ligo.org/computing/gitlab/components/docker/build@2.3.1
    inputs:
      dockerfile: envs/Dockerfile.ci
      job_name: build
      image_tag: ${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}

  - component: git.ligo.org/computing/gitlab/components/docker/build@2.3.1
    inputs:
      dockerfile: envs/Dockerfile.ci
      job_name: build-latest
      image_tag: latest

  - component: git.ligo.org/computing/gitlab/components/docker/test@2.3.1
    inputs:
      test_script:
        - cd /opt && pycwb --version # change dir to prevent use the source code

build-latest:
  rules:
    - if: $CI_COMMIT_TAG

container_scanning:
  needs:
    - job: build-latest
      optional: true

build-sdist:
  image: python:3.11
  stage: build
  script:
    - python3 -m pip install build
    - python3 -m build --sdist
  only:
    - tags
  artifacts:
    paths:
      - dist/*

publish:
  image: python:3.10
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  environment: production
  only:
    - tags
  script:
    - echo "Deploying to PyPI..."
    - pip install twine
    - TWINE_PASSWORD=${PYPI_TOKEN} TWINE_USERNAME=__token__ python -m twine upload dist/*.tar.gz