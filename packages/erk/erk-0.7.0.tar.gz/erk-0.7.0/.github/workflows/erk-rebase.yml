name: erk-rebase
run-name: "rebase:${{ inputs.branch_name }}:${{ inputs.distinct_id }}"

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: "Branch to rebase"
        required: true
        type: string
      base_branch:
        description: "Base branch to rebase onto"
        required: true
        type: string
      pr_number:
        description: "PR number for status updates"
        required: true
        type: string
      distinct_id:
        description: "Unique identifier for run discovery (base36)"
        required: true
        type: string
      squash:
        description: "Whether to squash commits before rebase"
        required: false
        type: boolean
        default: true
      model_name:
        description: "Claude model to use for conflict resolution"
        required: false
        type: string
        default: "claude-sonnet-4-5"

concurrency:
  group: rebase-${{ github.event.inputs.branch_name }}
  cancel-in-progress: true

jobs:
  rebase:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Validate required secrets
        env:
          ERK_PAT: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          if [ -z "$ERK_PAT" ]; then
            echo "::error title=Missing Secret::ERK_QUEUE_GH_PAT secret is not configured or has expired. Add a PAT with 'repo' scope at: Settings → Secrets and variables → Actions"
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          python-version: "3.13"

      - name: Install Claude Code
        uses: ./.github/actions/setup-claude-code

      - name: Setup remaining tools
        run: |
          npm install -g prettier
          cd $GITHUB_WORKSPACE
          if [ -d "./packages/erk-shared" ]; then
            # In erk repo: install local erk with local erk-shared
            uv tool install -e . --with-editable ./packages/erk-shared
          else
            # In other repos: install via dev dependencies in lockfile
            uv sync --group dev
            echo "$GITHUB_WORKSPACE/.venv/bin" >> $GITHUB_PATH
          fi

      - name: Validate Claude credentials
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: erk exec validate-claude-credentials

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout target branch
        env:
          BRANCH_NAME: ${{ inputs.branch_name }}
        run: |
          git fetch origin "$BRANCH_NAME"
          git checkout "$BRANCH_NAME"
          echo "Checked out branch: $BRANCH_NAME"

      - name: Squash commits
        if: ${{ inputs.squash }}
        env:
          BASE_BRANCH: ${{ inputs.base_branch }}
          PR_NUMBER: ${{ inputs.pr_number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Fetch the base branch to use as reference
          git fetch origin "$BASE_BRANCH"

          # Get the merge base (where this branch diverged from base)
          MERGE_BASE=$(git merge-base HEAD "origin/$BASE_BRANCH")

          # Count commits to squash
          COMMIT_COUNT=$(git rev-list --count "$MERGE_BASE..HEAD")
          echo "Commits to squash: $COMMIT_COUNT"

          if [ "$COMMIT_COUNT" -gt 1 ]; then
            # Get PR title for commit message
            PR_TITLE=$(gh pr view "$PR_NUMBER" --json title -q '.title')

            # Soft reset to merge base (keeps changes staged)
            git reset --soft "$MERGE_BASE"

            # Create new squashed commit with PR title
            git commit -m "$PR_TITLE"

            echo "Squashed $COMMIT_COUNT commits into 1"
          else
            echo "Only 1 commit, no squash needed"
          fi

      - name: Rebase with conflict resolution
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          TARGET_BRANCH: ${{ inputs.base_branch }}
          BRANCH_NAME: ${{ inputs.branch_name }}
          MODEL_NAME: ${{ inputs.model_name }}
        run: |
          erk exec rebase-with-conflict-resolution \
            --target-branch "$TARGET_BRANCH" \
            --branch-name "$BRANCH_NAME" \
            --model "$MODEL_NAME"

      - name: Post status comment to PR
        if: always()
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          GH_TOKEN: ${{ github.token }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          JOB_STATUS: ${{ job.status }}
        run: |
          if [ "$JOB_STATUS" = "success" ]; then
            BODY="✅ Remote rebase completed successfully.\n\n[View workflow run]($RUN_URL)"
          else
            BODY="❌ Remote rebase failed.\n\n[View workflow run]($RUN_URL)"
          fi
          gh pr comment "$PR_NUMBER" --body "$(echo -e "$BODY")"
