# Learn Dispatch Workflow
#
# Runs /erk:learn on a completed plan issue to extract insights and patterns
# from the implementation session. This workflow is triggered asynchronously
# after a PR lands via `erk exec trigger-async-learn`.
#
# Output: Creates a new learn plan issue containing extracted lessons learned,
# architectural decisions, and reusable patterns from the implementation.

name: learn-dispatch
run-name: "${{ inputs.issue_number }}:${{ inputs.distinct_id }}"

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "GitHub issue number to learn from"
        required: true
        type: string
      distinct_id:
        description: "Unique identifier for run discovery (base36)"
        required: true
        type: string

concurrency:
  group: learn-issue-${{ github.event.inputs.issue_number }}
  cancel-in-progress: true

jobs:
  learn:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      issues: write
    steps:
      - name: Validate required secrets
        env:
          ERK_PAT: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          if [ -z "$ERK_PAT" ]; then
            echo "::error title=Missing Secret::ERK_QUEUE_GH_PAT secret is not configured or has expired. Add a PAT with 'repo' scope at: Settings -> Secrets and variables -> Actions"
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          python-version: "3.13"

      - name: Install Claude Code
        uses: ./.github/actions/setup-claude-code

      - name: Setup erk
        run: |
          cd $GITHUB_WORKSPACE
          if [ -d "./packages/erk-shared" ]; then
            # In erk repo: install local erk with local erk-shared
            uv tool install -e . --with-editable ./packages/erk-shared
          else
            # In other repos: install via dev dependencies in lockfile
            uv sync --group dev
            echo "$GITHUB_WORKSPACE/.venv/bin" >> $GITHUB_PATH
          fi

      - name: Validate Claude credentials
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: erk exec validate-claude-credentials

      - name: Run learn workflow
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          WORKFLOW_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          claude --print \
            --verbose \
            --model claude-haiku-4-5 \
            --output-format stream-json \
            --dangerously-skip-permissions \
            "/erk:learn $ISSUE_NUMBER"
