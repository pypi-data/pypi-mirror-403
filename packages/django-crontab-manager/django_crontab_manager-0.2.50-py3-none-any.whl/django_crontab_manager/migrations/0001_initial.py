# Generated by Django 3.2.13 on 2022-04-30 03:55

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion
import django_crontab_manager.models
import django_safe_fields.fields


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Project',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=64, verbose_name='项目名称')),
                ('variables_data', django_safe_fields.fields.SafeTextField(blank=True, help_text='请使用yml格式来设置服务器变量。', null=True, verbose_name='自定义变量')),
            ],
            options={
                'verbose_name': '项目',
                'verbose_name_plural': '项目',
            },
        ),
        migrations.CreateModel(
            name='ServerGroup',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=64, verbose_name='名称')),
                ('uid', models.CharField(max_length=128, unique=True, verbose_name='唯一识别码')),
                ('aclkey', django_safe_fields.fields.SafeCharField(max_length=128, verbose_name='访问授权码')),
                ('description', models.TextField(blank=True, null=True, verbose_name='描述')),
                ('add_time', models.DateTimeField(auto_now_add=True, verbose_name='添加时间')),
                ('modify_time', models.DateTimeField(auto_now=True, verbose_name='修改时间')),
                ('last_updated_time', models.DateTimeField(blank=True, help_text='客户端最近一次下载定时任务设置的时间。', null=True, verbose_name='最近同步时间')),
                ('enable', models.BooleanField(default=True, verbose_name='启用')),
                ('variables_data', django_safe_fields.fields.SafeTextField(blank=True, help_text='请使用yml格式来设置服务器变量。', null=True, verbose_name='自定义变量')),
                ('owner', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL, verbose_name='所有者')),
                ('project', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='django_crontab_manager.project', verbose_name='项目')),
            ],
            options={
                'verbose_name': '服务器组',
                'verbose_name_plural': '服务器组',
            },
        ),
        migrations.CreateModel(
            name='Server',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('node', models.CharField(max_length=64, verbose_name='节点名称')),
                ('first_report_time', models.DateTimeField(blank=True, null=True, verbose_name='首次报告时间')),
                ('last_report_time', models.DateTimeField(blank=True, null=True, verbose_name='最近报告时间')),
                ('servergroup', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='servers', to='django_crontab_manager.servergroup', verbose_name='服务器组')),
            ],
            options={
                'verbose_name': '服务器',
                'verbose_name_plural': '服务器',
            },
        ),
        migrations.CreateModel(
            name='Schedule',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('uid', models.CharField(blank=True, default=django_crontab_manager.models.randuid, max_length=64, null=True, verbose_name='唯一识别码')),
                ('title', models.CharField(help_text='为方便任务的后续维护，请输入任务的简要描述。', max_length=128, verbose_name='名称')),
                ('description', models.TextField(blank=True, null=True, verbose_name='描述')),
                ('schedule', models.CharField(default='* * * * *', help_text='Linux Crontab格式的任务安排。格式为：分，时，日，月，周，使用空格分隔。例如：* * * * *，表示每分钟执行。', max_length=256, verbose_name='定时设置')),
                ('user', models.CharField(default='root', max_length=64, verbose_name='运行用户')),
                ('script', django_safe_fields.fields.SafeTextField(blank=True, null=True, verbose_name='脚本')),
                ('enable', models.BooleanField(default=True, verbose_name='启用')),
                ('code', models.CharField(blank=True, help_text='任务设置的MD5值。该字段将会自动计算。', max_length=32, null=True, verbose_name='设置摘要')),
                ('add_time', models.DateTimeField(auto_now_add=True, verbose_name='添加时间')),
                ('modify_time', models.DateTimeField(auto_now=True, verbose_name='修改时间')),
                ('success_determination_rule', models.IntegerField(choices=[(0, '退出码为0则为成功'), (10, '输出结果中含指定关键字（keyword）则为成功'), (20, '输出结果中不含指定关键字（keyword）则为成功'), (30, '输出结果匹配正式表达式（pattern）则为成功')], default=0, verbose_name='成功状态判定规则')),
                ('success_determination_config_data', django_safe_fields.fields.SafeTextField(blank=True, null=True, verbose_name='成功状态判定规则设置')),
                ('server_assign_time', models.DateTimeField(blank=True, null=True, verbose_name='分发至服务器的时间')),
                ('owner', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL, verbose_name='所有者')),
                ('project', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='django_crontab_manager.project', verbose_name='项目')),
                ('server', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='django_crontab_manager.server', verbose_name='服务器')),
                ('servergroup', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='schedules', to='django_crontab_manager.servergroup', verbose_name='服务器组')),
            ],
            options={
                'verbose_name': '定时任务',
                'verbose_name_plural': '定时任务',
                'permissions': [('export_filtered_schedules', '导出定时任务')],
            },
        ),
        migrations.CreateModel(
            name='Result',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('run_time', models.DateTimeField(verbose_name='执行时间')),
                ('success', models.BooleanField(null=True, verbose_name='成功')),
                ('code', models.IntegerField(blank=True, null=True, verbose_name='退出码')),
                ('stdout_file', models.FileField(blank=True, null=True, upload_to=django_crontab_manager.models.get_result_file_upload_to, verbose_name='脚本输出信息')),
                ('stderr_file', models.FileField(blank=True, null=True, upload_to=django_crontab_manager.models.get_result_file_upload_to, verbose_name='脚本错误信息')),
                ('project', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='django_crontab_manager.project', verbose_name='项目')),
                ('schedule', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='results', to='django_crontab_manager.schedule', verbose_name='定时任务')),
            ],
            options={
                'verbose_name': '处理结果',
                'verbose_name_plural': '运行结果',
            },
        ),
        migrations.CreateModel(
            name='ProjectMember',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('role', models.IntegerField(choices=[(10, '项目管理员'), (20, '项目配置人员'), (30, '项目审阅人员')], verbose_name='成员角色')),
                ('join_time', models.DateTimeField(auto_now_add=True, verbose_name='加入时间')),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='project_members', to='django_crontab_manager.project', verbose_name='项目')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='+', to=settings.AUTH_USER_MODEL, verbose_name='用户')),
            ],
            options={
                'verbose_name': '项目成员',
                'verbose_name_plural': '项目成员',
            },
        ),
        migrations.AddField(
            model_name='project',
            name='members',
            field=models.ManyToManyField(through='django_crontab_manager.ProjectMember', to=settings.AUTH_USER_MODEL, verbose_name='项目成员'),
        ),
        migrations.AddField(
            model_name='project',
            name='owner',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL, verbose_name='所有者'),
        ),
    ]
