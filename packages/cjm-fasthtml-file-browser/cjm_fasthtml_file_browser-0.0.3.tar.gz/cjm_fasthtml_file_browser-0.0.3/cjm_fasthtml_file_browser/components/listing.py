"""Directory listing components for list and grid views."""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../../nbs/components/listing.ipynb.

# %% auto #0
__all__ = ['sort_files', 'filter_files', 'render_empty_state', 'render_error_state', 'render_list_view', 'render_grid_view',
           'render_listing']

# %% ../../nbs/components/listing.ipynb #c3d4e5f6
from typing import Any, List, Optional, Set

from fasthtml.common import Div, Span, Table, Thead, Tbody, Tr, Th, P

# DaisyUI components
from cjm_fasthtml_daisyui.components.data_display.table import table, table_sizes
from cjm_fasthtml_daisyui.utilities.semantic_colors import bg_dui, text_dui, border_dui

# Tailwind utilities
from cjm_fasthtml_tailwind.utilities.spacing import p, m
from cjm_fasthtml_tailwind.utilities.sizing import w, h, min_h
from cjm_fasthtml_tailwind.utilities.typography import font_size, font_weight, text_align
from cjm_fasthtml_tailwind.utilities.layout import overflow
from cjm_fasthtml_tailwind.utilities.borders import border, rounded
from cjm_fasthtml_tailwind.utilities.flexbox_and_grid import (
    flex_display, flex_direction, justify, items, gap, grow, grid_display, grid_cols
)
from cjm_fasthtml_tailwind.core.base import combine_classes

# Lucide icons
from cjm_fasthtml_lucide_icons.factory import lucide_icon

# Local imports
from cjm_file_discovery.core.models import FileInfo
from ..core.models import DirectoryListing, BrowserState
from cjm_fasthtml_file_browser.core.config import (
    FileBrowserConfig, ViewMode, FileColumn, FilterConfig
)
from cjm_fasthtml_file_browser.components.item import (
    render_item, render_parent_item, BROWSER_ICONS
)

# %% ../../nbs/components/listing.ipynb #e5f6a7b8
def sort_files(
    files: List[FileInfo],           # Files to sort
    sort_by: str = "name",           # Sort field
    descending: bool = False,        # Sort direction
    folders_first: bool = True       # Sort folders before files
) -> List[FileInfo]:  # Sorted file list
    """Sort files by the specified field."""
    def sort_key(f: FileInfo):
        # Primary: folders first (if enabled)
        folder_order = 0 if f.is_directory else 1 if folders_first else 0
        
        # Secondary: sort field
        if sort_by == "name":
            value = f.name.lower()
        elif sort_by == "size":
            value = f.size or 0
        elif sort_by == "modified":
            value = f.modified or 0
        elif sort_by == "type":
            value = f.extension.lower() if f.extension else ""
        else:
            value = f.name.lower()
        
        return (folder_order, value)
    
    return sorted(files, key=sort_key, reverse=descending)


def filter_files(
    files: List[FileInfo],           # Files to filter
    filter_config: FilterConfig      # Filter configuration
) -> List[FileInfo]:  # Filtered file list
    """Filter files based on configuration."""
    return [f for f in files if filter_config.matches(f)]

# %% ../../nbs/components/listing.ipynb #h8c9d0e1
def render_empty_state(
    message: str = "No files found",  # Message to display
    icon_name: str = "folder-open"    # Icon to show
) -> Any:  # Empty state component
    """Render empty state for when directory has no items."""
    return Div(
        Div(
            lucide_icon(icon_name, size=12, cls=str(text_dui.base_content.opacity(30))),
            cls=str(m.b(4))
        ),
        P(
            message,
            cls=combine_classes(text_dui.base_content.opacity(50), font_size.lg)
        ),
        cls=combine_classes(
            flex_display, flex_direction.col, items.center, justify.center,
            p(8), min_h(48)
        )
    )

# %% ../../nbs/components/listing.ipynb #k1f2g3h4
def render_error_state(
    error_message: str  # Error message to display
) -> Any:  # Error state component
    """Render error state for when directory access fails."""
    return Div(
        Div(
            lucide_icon("circle-alert", size=12, cls=str(text_dui.error)),
            cls=str(m.b(4))
        ),
        P(
            error_message,
            cls=combine_classes(text_dui.error, font_size.lg)
        ),
        cls=combine_classes(
            flex_display, flex_direction.col, items.center, justify.center,
            p(8), min_h(48)
        )
    )

# %% ../../nbs/components/listing.ipynb #n4i5j6k7
def _render_list_header(
    config: FileBrowserConfig,             # Browser configuration
    has_selectable_files: bool = False     # Whether any files can be selected
) -> Any:  # Table header component
    """Render the header row for list view."""
    headers = []
    
    # Checkbox column (if selection enabled)
    if config.selection_mode.value != "none" and has_selectable_files:
        headers.append(Th("", cls=str(w(8))))
    
    # Column headers based on config
    column_labels = {
        FileColumn.NAME: "Name",
        FileColumn.SIZE: "Size",
        FileColumn.MODIFIED: "Modified",
        FileColumn.TYPE: "Type",
        FileColumn.EXTENSION: "Extension",
        FileColumn.PATH: "Path",
    }
    
    # Name is always first
    headers.append(Th("Name"))
    
    # Other columns
    for col in config.view.columns:
        if col != FileColumn.NAME:  # Name already added
            headers.append(Th(
                column_labels.get(col, col.value.title()),
                cls=combine_classes(text_nowrap) if col in [FileColumn.SIZE, FileColumn.MODIFIED] else None
            ))
    
    return Thead(Tr(*headers))

# Import for the header
from cjm_fasthtml_tailwind.utilities.typography import text_nowrap

# %% ../../nbs/components/listing.ipynb #q7l8m9n0
def render_list_view(
    listing: DirectoryListing,              # Directory listing to render
    config: FileBrowserConfig,              # Browser configuration
    state: BrowserState,                    # Current browser state
    navigate_url: Optional[str] = None,     # URL for directory navigation
    select_url: Optional[str] = None,       # URL for file selection
    hx_target: Optional[str] = None,        # HTMX target for swaps
    listing_id: Optional[str] = None,       # HTML ID for the listing container
) -> Any:  # List view component
    """Render directory contents as a table/list view."""
    # Handle error state
    if listing.error:
        return render_error_state(listing.error)
    
    # Filter and sort files
    files = filter_files(listing.items, config.filter)
    files = sort_files(
        files,
        sort_by=state.sort_by,
        descending=state.sort_descending,
        folders_first=config.view.sort_folders_first
    )
    
    # Check if any files can be selected
    has_selectable = any(config.can_select(f) for f in files)
    
    # Build rows
    rows = []
    
    # Parent navigation row
    if listing.parent_path and config.show_parent_navigation:
        rows.append(render_parent_item(
            listing.parent_path,
            ViewMode.LIST,
            navigate_url or "",
            hx_target
        ))
    
    # File/folder rows
    from cjm_fasthtml_file_browser.core.html_ids import FileBrowserHtmlIds
    for idx, file_info in enumerate(files):
        is_selected = state.selection.is_selected(file_info.path)
        rows.append(render_item(
            file_info,
            config,
            ViewMode.LIST,
            is_selected=is_selected,
            item_id=FileBrowserHtmlIds.item_id(idx),
            navigate_url=navigate_url,
            select_url=select_url,
            hx_target=hx_target
        ))
    
    # Empty state
    if not rows:
        return render_empty_state()
    
    # Build table
    table_attrs = {
        "cls": combine_classes(table, table_sizes.sm, w.full)
    }
    if listing_id:
        table_attrs["id"] = listing_id
    
    return Table(
        _render_list_header(config, has_selectable),
        Tbody(*rows),
        **table_attrs
    )

# %% ../../nbs/components/listing.ipynb #t0o1p2q3
def render_grid_view(
    listing: DirectoryListing,              # Directory listing to render
    config: FileBrowserConfig,              # Browser configuration
    state: BrowserState,                    # Current browser state
    navigate_url: Optional[str] = None,     # URL for directory navigation
    select_url: Optional[str] = None,       # URL for file selection
    hx_target: Optional[str] = None,        # HTMX target for swaps
    listing_id: Optional[str] = None,       # HTML ID for the listing container
) -> Any:  # Grid view component
    """Render directory contents as a grid of cards."""
    # Handle error state
    if listing.error:
        return render_error_state(listing.error)
    
    # Filter and sort files
    files = filter_files(listing.items, config.filter)
    files = sort_files(
        files,
        sort_by=state.sort_by,
        descending=state.sort_descending,
        folders_first=config.view.sort_folders_first
    )
    
    # Build cards
    cards = []
    
    # Parent navigation card
    if listing.parent_path and config.show_parent_navigation:
        cards.append(render_parent_item(
            listing.parent_path,
            ViewMode.GRID,
            navigate_url or "",
            hx_target
        ))
    
    # File/folder cards
    from cjm_fasthtml_file_browser.core.html_ids import FileBrowserHtmlIds
    for idx, file_info in enumerate(files):
        is_selected = state.selection.is_selected(file_info.path)
        cards.append(render_item(
            file_info,
            config,
            ViewMode.GRID,
            is_selected=is_selected,
            item_id=FileBrowserHtmlIds.item_id(idx),
            navigate_url=navigate_url,
            select_url=select_url,
            hx_target=hx_target
        ))
    
    # Empty state
    if not cards:
        return render_empty_state()
    
    # Build grid
    num_cols = config.view.grid_columns
    grid_cls = combine_classes(
        grid_display,
        f"grid-cols-{num_cols}",  # Dynamic grid columns
        gap(4),
        p(4)
    )
    
    grid_attrs = {"cls": grid_cls}
    if listing_id:
        grid_attrs["id"] = listing_id
    
    return Div(*cards, **grid_attrs)

# %% ../../nbs/components/listing.ipynb #w3r4s5t6
def render_listing(
    listing: DirectoryListing,              # Directory listing to render
    config: FileBrowserConfig,              # Browser configuration
    state: BrowserState,                    # Current browser state
    navigate_url: Optional[str] = None,     # URL for directory navigation
    select_url: Optional[str] = None,       # URL for file selection
    hx_target: Optional[str] = None,        # HTMX target for swaps
    listing_id: Optional[str] = None,       # HTML ID for the listing container
) -> Any:  # Listing component (table or grid)
    """Render directory listing based on current view mode."""
    view_mode = ViewMode(state.view_mode)
    
    if view_mode == ViewMode.LIST:
        return render_list_view(
            listing, config, state,
            navigate_url, select_url, hx_target, listing_id
        )
    else:
        return render_grid_view(
            listing, config, state,
            navigate_url, select_url, hx_target, listing_id
        )
