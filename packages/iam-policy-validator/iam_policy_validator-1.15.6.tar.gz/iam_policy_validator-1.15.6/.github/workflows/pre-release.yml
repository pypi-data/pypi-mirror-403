name: Pre-Release (RC/Alpha/Beta)

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to create pre-release from"
        required: true
        type: number
      release_type:
        description: "Type of pre-release"
        required: true
        type: choice
        options:
          - alpha
          - beta
          - rc
      version_increment:
        description: "Which version part to increment"
        required: true
        type: choice
        default: "minor"
        options:
          - major
          - minor
          - patch
      pre_release_number:
        description: "Pre-release number (e.g., 1 for alpha.1)"
        required: false
        type: number
        default: 1
      python_version:
        description: "Python version to use for building"
        required: false
        type: string
        default: "3.13"

permissions: read-all

jobs:
  build-pre-release:
    name: Build and Create Pre-Release
    runs-on: ubuntu-latest
    environment: prerelease # Requires approval from environment reviewers
    permissions:
      contents: write # Required for creating releases and tags
      pull-requests: write # Required for reading PR info and commenting
      id-token: write # Required for PyPI trusted publishing (test.pypi.org)

    steps:
      - name: Get PR information
        id: pr_info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DATA=$(gh pr view ${{ inputs.pr_number }} --repo ${{ github.repository }} --json headRefName,title,state)

          STATE=$(echo "$PR_DATA" | jq -r '.state')
          if [ "$STATE" != "OPEN" ]; then
            echo "âŒ PR #${{ inputs.pr_number }} is not open (state: $STATE)"
            exit 1
          fi

          BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')
          TITLE=$(echo "$PR_DATA" | jq -r '.title')

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "âœ… PR #${{ inputs.pr_number }}: $TITLE (branch: $BRANCH)"

      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ steps.pr_info.outputs.branch }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install uv
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
        with:
          enable-cache: true

      - name: Calculate pre-release version
        id: version
        run: |
          # Get current version from __version__.py
          CURRENT_VERSION=$(grep -E "^__version__" iam_validator/__version__.py | cut -d'"' -f2)
          echo "Current version: $CURRENT_VERSION"

          # Parse version parts
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Increment based on input
          case "${{ inputs.version_increment }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          # Build pre-release version
          PRE_VERSION="${MAJOR}.${MINOR}.${PATCH}-${{ inputs.release_type }}.${{ inputs.pre_release_number }}"
          TAG="v${PRE_VERSION}"

          echo "version=$PRE_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "base_version=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Pre-release version: $PRE_VERSION"
          echo "ðŸ·ï¸  Tag: $TAG"

      - name: Update version in __version__.py
        run: |
          # Create backup and update version (portable across macOS/Linux)
          cp iam_validator/__version__.py iam_validator/__version__.py.bak
          sed 's/__version__ = ".*"/__version__ = "${{ steps.version.outputs.version }}"/' iam_validator/__version__.py.bak > iam_validator/__version__.py
          rm iam_validator/__version__.py.bak

          echo "âœ… Updated __version__.py to ${{ steps.version.outputs.version }}"
          cat iam_validator/__version__.py

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run tests
        run: uv run pytest --verbose
        continue-on-error: false

      - name: Build package
        run: uv build

      - name: Generate pre-release notes
        id: release_notes
        run: |
          cat > PRERELEASE_NOTES.md << EOF
          # Pre-Release: ${{ steps.version.outputs.tag }}

          ## ðŸ§ª Testing Release

          This is a **${{ inputs.release_type }}** pre-release built from PR #${{ inputs.pr_number }}.

          **âš ï¸ Not recommended for production use.**

          ### PR Information
          - **PR**: #${{ inputs.pr_number }} - ${{ steps.pr_info.outputs.title }}
          - **Branch**: \`${{ steps.pr_info.outputs.branch }}\`
          - **Base Version**: \`${{ steps.version.outputs.base_version }}\`
          - **Pre-release**: \`${{ inputs.release_type }}.${{ inputs.pre_release_number }}\`

          ### Installation
          \`\`\`bash
          # Install from GitHub release
          pip install https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/iam_policy_validator-${{ steps.version.outputs.version }}-py3-none-any.whl
          \`\`\`

          ### Recent Changes
          EOF

          # Add commits from the PR branch
          git log --pretty=format:"- %s (%h by %an)" --no-merges -10 >> PRERELEASE_NOTES.md

          cat PRERELEASE_NOTES.md

      - name: Get current commit SHA
        id: commit
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Create GitHub Pre-Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          name: "${{ steps.version.outputs.tag }}"
          tag_name: ${{ steps.version.outputs.tag }}
          body_path: PRERELEASE_NOTES.md
          files: |
            dist/*.whl
            dist/*.tar.gz
          draft: false
          prerelease: true
          generate_release_notes: false
          target_commitish: ${{ steps.commit.outputs.sha }}
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ inputs.pr_number }} --repo ${{ github.repository }} --body \
          "## ðŸš€ Pre-Release Created

          A **${{ inputs.release_type }}** pre-release has been created from this PR.

          - **Version**: \`${{ steps.version.outputs.version }}\`
          - **Tag**: [\`${{ steps.version.outputs.tag }}\`](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})
          - **Release**: [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})

          ### Install & Test
          \`\`\`bash
          pip install https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/iam_policy_validator-${{ steps.version.outputs.version }}-py3-none-any.whl
          \`\`\`

          âš ï¸ This is a pre-release and should not be used in production."

      - name: Create Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ§ª Pre-Release Summary

          ## ðŸ“¦ Pre-Release Information
          - **Type**: ${{ inputs.release_type }}
          - **Version**: \`${{ steps.version.outputs.version }}\`
          - **Tag**: \`${{ steps.version.outputs.tag }}\`
          - **PR**: [#${{ inputs.pr_number }}](https://github.com/${{ github.repository }}/pull/${{ inputs.pr_number }}) - ${{ steps.pr_info.outputs.title }}
          - **Branch**: \`${{ steps.pr_info.outputs.branch }}\`

          ## ðŸ”— Links
          - [ðŸ“¦ GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})
          - [ðŸ”€ Pull Request](https://github.com/${{ github.repository }}/pull/${{ inputs.pr_number }})

          ## ðŸ“¥ Installation
          \`\`\`bash
          pip install https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/iam_policy_validator-${{ steps.version.outputs.version }}-py3-none-any.whl
          \`\`\`

          ## âš ï¸ Important Notes
          - This is a **pre-release** for testing purposes only
          - Not published to PyPI
          - Will be automatically cleaned up after 30 days
          - Do not use in production
          EOF
