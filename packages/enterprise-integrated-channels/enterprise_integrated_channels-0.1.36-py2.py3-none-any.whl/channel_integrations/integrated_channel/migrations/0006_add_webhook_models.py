# Generated by Django 4.2.16 on 2026-01-01 14:32

from django.conf import settings
import django.core.validators
from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone
import jsonfield.fields
import model_utils.fields


class Migration(migrations.Migration):

    dependencies = [
        ('enterprise', '__first__'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('channel_integration', '0005_mariadb_uuid_conversion'),
    ]

    operations = [
        migrations.CreateModel(
            name='EnterpriseWebhookConfiguration',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created', model_utils.fields.AutoCreatedField(default=django.utils.timezone.now, editable=False, verbose_name='created')),
                ('modified', model_utils.fields.AutoLastModifiedField(default=django.utils.timezone.now, editable=False, verbose_name='modified')),
                ('region', models.CharField(choices=[('US', 'United States'), ('EU', 'European Union'), ('UK', 'United Kingdom'), ('OTHER', 'Other')], db_index=True, help_text='Geographic region this webhook URL is for', max_length=10)),
                ('webhook_url', models.URLField(help_text='HTTPS endpoint to receive webhooks', max_length=500)),
                ('webhook_auth_token', models.CharField(blank=True, help_text='Bearer token for webhook authentication', max_length=255, null=True)),
                ('webhook_timeout_seconds', models.IntegerField(default=30, help_text='HTTP request timeout in seconds (5-300)', validators=[django.core.validators.MinValueValidator(5), django.core.validators.MaxValueValidator(300)])),
                ('webhook_retry_attempts', models.IntegerField(default=3, help_text='Number of retry attempts on failure (0-10)', validators=[django.core.validators.MinValueValidator(0), django.core.validators.MaxValueValidator(10)])),
                ('max_requests_per_minute', models.IntegerField(default=100, help_text='Maximum webhook requests per minute (1-1000)', validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(1000)])),
                ('active', models.BooleanField(default=True, help_text='Whether this webhook configuration is active')),
                ('enterprise_customer', models.ForeignKey(help_text='Enterprise customer this webhook belongs to', on_delete=django.db.models.deletion.CASCADE, related_name='webhook_configurations', to='enterprise.enterprisecustomer')),
            ],
            options={
                'verbose_name': 'Enterprise Webhook Configuration',
                'verbose_name_plural': 'Enterprise Webhook Configurations',
            },
        ),
        migrations.CreateModel(
            name='WebhookTransmissionQueue',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created', model_utils.fields.AutoCreatedField(default=django.utils.timezone.now, editable=False, verbose_name='created')),
                ('modified', model_utils.fields.AutoLastModifiedField(default=django.utils.timezone.now, editable=False, verbose_name='modified')),
                ('course_id', models.CharField(help_text='Course ID', max_length=255)),
                ('event_type', models.CharField(choices=[('course_completion', 'Course Completion'), ('course_enrollment', 'Course Enrollment')], help_text='Type of event being transmitted', max_length=50)),
                ('user_region', models.CharField(help_text='User region at time of event', max_length=10)),
                ('webhook_url', models.URLField(help_text='Webhook URL that was/will be called', max_length=500)),
                ('payload', jsonfield.fields.JSONField(help_text='JSON payload to be transmitted')),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('processing', 'Processing'), ('success', 'Success'), ('failed', 'Failed'), ('cancelled', 'Cancelled')], db_index=True, default='pending', help_text='Transmission status', max_length=20)),
                ('deduplication_key', models.CharField(db_index=True, help_text='Unique key to prevent duplicate transmissions: {user_id}:{course_id}:{event_type}:{date}', max_length=255)),
                ('attempt_count', models.IntegerField(default=0, help_text='Number of transmission attempts')),
                ('last_attempt_at', models.DateTimeField(blank=True, help_text='Timestamp of last transmission attempt', null=True)),
                ('next_retry_at', models.DateTimeField(blank=True, db_index=True, help_text='Timestamp for next retry attempt', null=True)),
                ('completed_at', models.DateTimeField(blank=True, help_text='Timestamp when transmission completed', null=True)),
                ('error_message', models.TextField(blank=True, help_text='Error message from last failed attempt', null=True)),
                ('http_status_code', models.IntegerField(blank=True, help_text='HTTP status code from last attempt', null=True)),
                ('response_body', models.TextField(blank=True, help_text='Response body from last attempt (truncated to 10KB)', null=True)),
                ('enterprise_customer', models.ForeignKey(help_text='Enterprise customer', on_delete=django.db.models.deletion.CASCADE, to='enterprise.enterprisecustomer')),
                ('user', models.ForeignKey(help_text='User whose event is being transmitted', on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'indexes': [models.Index(fields=['status', 'next_retry_at'], name='channel_int_status_baa4ef_idx'), models.Index(fields=['enterprise_customer', 'created'], name='channel_int_enterpr_cdc09e_idx'), models.Index(fields=['user', 'course_id'], name='channel_int_user_id_e4242b_idx'), models.Index(fields=['event_type'], name='channel_int_event_t_9370e8_idx'), models.Index(fields=['deduplication_key'], name='channel_int_dedupli_376a5e_idx')],
            },
        ),
        migrations.AddConstraint(
            model_name='webhooktransmissionqueue',
            constraint=models.UniqueConstraint(condition=models.Q(('status__in', ['pending', 'processing', 'success'])), fields=('deduplication_key',), name='unique_webhook_deduplication'),
        ),
        migrations.AddIndex(
            model_name='enterprisewebhookconfiguration',
            index=models.Index(fields=['enterprise_customer', 'region', 'active'], name='webhook_config_lookup_idx'),
        ),
        migrations.AddConstraint(
            model_name='enterprisewebhookconfiguration',
            constraint=models.UniqueConstraint(fields=('enterprise_customer', 'region'), name='unique_enterprise_region_webhook'),
        ),
    ]
