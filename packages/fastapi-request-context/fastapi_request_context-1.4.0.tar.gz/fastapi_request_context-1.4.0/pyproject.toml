[project]
name = "fastapi-request-context"
version = "1.4.0"
description = "FastAPI middleware for request ID tracking, correlation IDs, and extensible request context with logging integration"
authors = [
    {name = "Adrian Dankiv", email = "adr-007@ukr.net"}
]
license = {text = "MIT"}
readme = "README.md"
keywords = ["fastapi", "request-id", "correlation-id", "request-context", "middleware", "logging", "tracing"]
classifiers = [
    "Development Status :: 4 - Beta",
    "Framework :: FastAPI",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: MIT License",
    "Operating System :: OS Independent",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Programming Language :: Python :: 3.14",
    "Topic :: Internet :: WWW/HTTP :: WSGI :: Middleware",
    "Topic :: Software Development :: Libraries :: Python Modules",
    "Typing :: Typed",
]
requires-python = ">=3.12"
dependencies = [
    "fastapi>=0.100.0",
]

[project.optional-dependencies]
context-logging = ["context-logging>=0.7.0"]
json-formatter = ["python-json-logger>=2.0.0"]
taskiq = ["taskiq>=0.11.0"]
build = ["uv>=0.9.0"]
all = [
    "context-logging>=0.7.0",
    "python-json-logger>=2.0.0",
    "taskiq>=0.11.0",
]

[project.urls]
Homepage = "https://github.com/ADR-007/fastapi-request-context"
Repository = "https://github.com/ADR-007/fastapi-request-context"
Issues = "https://github.com/ADR-007/fastapi-request-context/issues"

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.hatch.build.targets.sdist]
exclude = [
    ".githooks",
    ".github",
    "tests",
    "examples",
    "reports",
]

[tool.hatch.build.targets.wheel]
packages = ["fastapi_request_context"]

[dependency-groups]
dev = [
    "ruff>=0.3.5",
    "mypy>=1.9.0",
    "pytest>=8.1.1",
    "pytest-asyncio>=0.23.0",
    "coverage>=7.4.4",
    "tox>=4.14.2",
    "tox-uv>=1.0.0",
    "context-logging>=0.7.0",
    "python-json-logger>=2.0.0",
    "httpx>=0.27.0",
    "taskiq>=0.11.0",
]

[tool.tox]
legacy_tox_ini = """
[tox]
min_version = 4.0
env_list =
    lint
    py{312,313}
    coverage

[gh-actions]
python =
    3.13: lint, py313, coverage
    3.12: py312

[testenv]
runner = uv-venv-lock-runner
extras = all
commands =
    coverage run -m pytest tests/
    coverage html -d ./reports/htmlcov --omit="tests/*"
    coverage xml -o ./reports/coverage.xml --omit="tests/*"
    coverage report --skip-empty --fail-under 90

[testenv:lint]
runner = uv-venv-lock-runner
commands =
    ruff check fastapi_request_context tests/ examples/
    ruff format --check fastapi_request_context tests/ examples/
    mypy fastapi_request_context tests/

[testenv:coverage]
runner = uv-venv-lock-runner
extras = all
commands =
    coverage run -m pytest tests/
    coverage html -d ./reports/htmlcov --omit="tests/*"
    coverage xml -o ./reports/coverage.xml --omit="tests/*"
    coverage report --skip-empty --fail-under 100
"""

[tool.semantic_release]
version_toml = [
    "pyproject.toml:project.version",
]
assets = []
build_command = """
    python -m pip install -e '.[build]'
    uv lock --upgrade-package "$PACKAGE_NAME"
    git add uv.lock
    uv build
"""
commit_message = "{version}\n\nAutomatically generated by python-semantic-release"
commit_parser = "conventional"
logging_use_named_masks = false
major_on_zero = true
tag_format = "v{version}"

[tool.semantic_release.branches.main]
match = "(main|master)"
prerelease_token = "rc"
prerelease = false

[tool.semantic_release.changelog]
exclude_commit_patterns = []

[tool.semantic_release.changelog.default_templates]
changelog_file = "CHANGELOG.md"

[tool.semantic_release.changelog.environment]
block_start_string = "{%"
block_end_string = "%}"
variable_start_string = "{{"
variable_end_string = "}}"
comment_start_string = "{#"
comment_end_string = "#}"
trim_blocks = false
lstrip_blocks = false
newline_sequence = "\n"
keep_trailing_newline = false
extensions = []
autoescape = true

[tool.semantic_release.commit_author]
env = "GIT_COMMIT_AUTHOR"
default = "semantic-release <semantic-release>"

[tool.semantic_release.commit_parser_options]
allowed_tags = ["build", "chore", "ci", "docs", "feat", "fix", "perf", "style", "refactor", "test"]
minor_tags = ["feat"]
patch_tags = ["fix", "perf", "build", "docs"]

[tool.semantic_release.remote]
name = "origin"
type = "github"
ignore_token_for_push = false

[tool.semantic_release.publish]
dist_glob_patterns = ["dist/*"]
upload_to_vcs_release = true

[tool.mypy]
python_version = "3.12"
strict = true
warn_return_any = true
warn_unused_configs = true

[[tool.mypy.overrides]]
module = "tests.*"
disable_error_code = [
    "call-arg",
    "unused-ignore",
    "misc",
]

[[tool.mypy.overrides]]
module = "context_logging.*"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "pythonjsonlogger.*"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "taskiq.*"
ignore_missing_imports = true

[tool.ruff]
target-version = "py312"
line-length = 100

[tool.ruff.lint]
select = [
    "F",      # Pyflakes
    "E", "W", # pycodestyle
    "C90",    # mccabe
    "I",      # isort
    "N",      # pep8-naming
    "D",      # pydocstyle
    "UP",     # pyupgrade
    "YTT",    # flake8-2020
    "ANN",    # flake8-annotations
    "ASYNC",  # flake8-async
    "S",      # flake8-bandit
    "BLE",    # flake8-blind-except
    "B",      # flake8-bugbear
    "A",      # flake8-builtins
    "COM",    # flake8-commas
    "C4",     # flake8-comprehensions
    "DTZ",    # flake8-datetimez
    "T10",    # flake8-debugger
    "ISC",    # flake8-implicit-str-concat
    "ICN",    # flake8-import-conventions
    "INP",    # flake8-no-pep420
    "PIE",    # flake8-pie
    "T20",    # flake8-print
    "PYI",    # flake8-pyi
    "PT",     # flake8-pytest-style
    "RSE",    # flake8-raise
    "RET",    # flake8-return
    "SLF",    # flake8-self
    "SLOT",   # flake8-slots
    "SIM",    # flake8-simplify
    "TID",    # flake8-tidy-imports
    "TCH",    # flake8-type-checking
    "INT",    # flake8-gettext
    "ARG",    # flake8-unused-arguments
    "PTH",    # flake8-use-pathlib
    "ERA",    # eradicate
    "PGH",    # pygrep-hooks
    "PL",     # Pylint
    "TRY",    # tryceratops
    "FLY",    # flynt
    "PERF",   # Perflint
    "RUF",    # Ruff-specific rules
]

[tool.ruff.lint.pydocstyle]
convention = "google"

[tool.ruff.lint.per-file-ignores]
"tests/**/*.py" = [
    "S101",   # Allow assert in tests
    "S103",   # Allow os.chmod
    "D100", "D101", "D102", "D103", # Allow missing docstrings in tests
    "ANN102", # Missing type annotation for cls
    "ANN401", # Allow Any type in fixtures
    "TRY003", # Allow long exception messages
    "TRY301", # Allow raise in try blocks (needed for exception tests)
    "PLR2004", # Allow magic values
    "PLC0415", # Allow imports not at top level (for test isolation)
    "ARG001", "ARG002",  # Allow unused function arguments (fixtures)
    "SLF001",  # Allow private member access
]
"examples/**/*.py" = [
    "T201",   # Allow print in examples
    "D100", "D103", # Allow missing docstrings in examples
    "INP001", # Allow missing __init__.py in examples
    "ARG001",  # Allow unused function arguments
    "PLC0415", # Allow imports not at top level
    "ANN401",  # Allow Any type
]

[tool.pytest.ini_options]
asyncio_mode = "auto"
asyncio_default_fixture_loop_scope = "function"
testpaths = ["tests"]

[tool.coverage.run]
source = ["fastapi_request_context"]
branch = true

[tool.coverage.report]
fail_under = 100
exclude_lines = [
    "pragma: no cover",
    "if TYPE_CHECKING:",
    "@abstractmethod",
    "raise NotImplementedError",
    "\\.\\.\\.",  # Protocol method stubs
    "class.*\\(Protocol\\):",
]
exclude_also = [
    "def __repr__",
    "@(abc\\.)?abstractmethod",
]
